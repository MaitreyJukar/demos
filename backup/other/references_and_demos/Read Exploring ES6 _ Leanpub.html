<!DOCTYPE html>
<!-- saved from url=(0075)https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle -->
<html class=" js no-touch multiplebgs svg inlinesvg svgclippaths no-ie8compat" lang="en"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" name="X-UA-Compatible">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="en" name="Content-Language">
<link href="https://leanpub.com/assets/favicon-bf34502f5d69a198fcb930a4365fe9bf.ico" rel="shortcut icon" type="image/vnd.microsoft.icon">
<title>Read Exploring ES6 | Leanpub</title>
<link href="https://cloud.typography.com/6909132/731026/css/fonts.css" rel="stylesheet" type="text/css">
<link href="./Read Exploring ES6 _ Leanpub_files/application-1ad39c95315a0fbfbcb3d046cc711937.css" media="all" rel="stylesheet" type="text/css">
<meta content="authenticity_token" name="csrf-param">
<meta content="C4Yqj1lEhEnWgTXbL9xEjezvW5KY2aQS2s0jAsnR4UA=" name="csrf-token">
<script type="text/javascript" async="" src="./Read Exploring ES6 _ Leanpub_files/inpage_linkid.js" id="undefined"></script><script type="text/javascript" async="" src="./Read Exploring ES6 _ Leanpub_files/ga.js"></script><script src="./Read Exploring ES6 _ Leanpub_files/modernizr-17840c319e638a474d86fe054f7f4404.js" type="text/javascript"></script>

<script>
  var _gaq = _gaq || [];
  var pluginUrl =  '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-911230-9']);
  
  _gaq.push(['_trackPageview']);
  
  
  
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<style></style></head>
<body id="reads-show" cz-shortcut-listen="true">
<div class="large-container flash-message-container">
<div class="alert alert-block" id="flash-prototype">
<p class="flash-message"></p>
<a class="flash-close" href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#"></a>
</div>
</div>



<header class=" navigation">
<div class="navigation-wrapper large-container">
<div id="mobile-menu-wrapper">
<a class="navigation-menu-button" href="" id="js-mobile-menu">Menu</a>
<h1 class="nav-logo-mobile"><a href="https://leanpub.com/"></a></h1>
<a class="navigation-show-search" href="" id="js-mobile-search"></a>
</div>
<div class="nav">
<ul id="navigation-menu"><li class="nav-link"><a href="https://leanpub.com/bookstore">Bookstore</a></li><li class="nav-link"><a href="https://leanpub.com/authors">Authors</a></li><li class="nav-link mobile"><a href="https://leanpub.com/shopping_cart">Shopping Cart</a></li><div class="show_if_logged_out" style="display: block;"><li class="nav-link mobile"><a href="https://leanpub.com/login">Login</a></li></div>
<div class="show_if_logged_in" style="display: none;"><li class="nav-link mobile"><a href="https://leanpub.com/dashboard/purchases">Purchases</a></li><li class="nav-link mobile"><a href="https://leanpub.com/dashboard">Dashboard</a></li><li class="nav-link mobile"><a href="https://leanpub.com/sign_out">Sign Out</a></li></div>
</ul>
</div>
<h1 class="nav-logo centred-text">
<a href="https://leanpub.com/">Leanpub</a>
</h1>
<div class="navigation-tools" id="js-navigation-tools">
<div class="header-account-wrapper">
<div class="show_if_logged_out" style="display: block;">
<a href="https://leanpub.com/login" class="sign-in">Sign In</a>
<a href="https://leanpub.com/sign_up" class="sign-up" id="sign-up-link">Sign Up</a>
</div>
<div class="show_if_logged_in" style="display: none;">
<div class="current-user">
<div class="dropdown">
<div class="dropdown-container">
<p class="dropdown-button">Account</p>
<ul class="menu flush-right" id="user_menu">
<li><a href="https://leanpub.com/dashboard">Account Dashboard</a></li>
<li><a href="https://leanpub.com/dashboard/books" class="author_dashboard_link" style="display: none">Author Dashboard</a></li>
<li><a href="https://leanpub.com/dashboard/publishers" class="publisher_dashboard_link" style="display: none">Publisher Dashboard</a></li>
<hr>
<li><a href="https://leanpub.com/dashboard/purchases">Purchases</a></li>
<li><a href="" class="wishlist_link">Wish List</a></li>
<li><a href="" class="profile_link" style="display: none">View Profile</a></li>
<hr>
<li><a href="https://leanpub.com/help">Help</a></li>
<li><a href="https://leanpub.com/sign_out">Sign Out</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<span class="shopping-cart-button">
<a href="https://leanpub.com/shopping_cart" title="Shopping Cart">
<div id="shopping-cart">
<i class="fa fa-shopping-cart"></i>
<span id="cart-total"></span>
</div>
</a>

</span>
<div class="search-bar">
<div class="search-and-submit">
<form action="https://leanpub.com/book_search" method="get">
<input name="search" placeholder="Search" type="search">
<button class="search-submit" type="submit">
<div class="search-icon"></div>
</button>
</form>
</div>
</div>
</div>
</div>
</header>

<div id="quick-buy" class="" style="display: none;">
<div class="large-container">
<div class="quick-buy-info">
<div class="cover-image tiny">
<img alt="Exploring ES6 cover page" itemprop="image" src="./Read Exploring ES6 _ Leanpub_files/tiny">
</div>
<h5 class="book-title ltr">
Exploring ES6
</h5>
</div>
<ul class="book-details-list pricing">
<li class="detail">
<span class="taxamo-price" itemprop="lowPrice">$28.00</span>
<p>Minimum</p>
</li>
<li class="detail">
<span class="suggested-price taxamo-price" itemprop="highPrice">$35.00</span>
<p>Suggested</p>
</li>
<li class="detail">
<button class="add-to-cart-modal submit" data-book-slug="exploring-es6" data-package-slug="book" data-type="quick-buy">
Add Ebook to cart
</button>
</li>
</ul>
</div>
</div>


<div id="main">


<div id="read-online">
<div class="large-container">
<div class="read">
<div class="sidebar" id="quick-buy-trigger">
<div id="book-box">
<section itemscope="" itemtype="http://schema.org/Book">
<h4 class="book-title" itemprop="name">
<a href="https://leanpub.com/exploring-es6">Exploring ES6</a>
</h4>
<h4>Upgrade to the next version of JavaScript</h4>
<div class="book-author">
<div class="avatar-and-name tiny">
<a href="https://leanpub.com/u/rauschma"><img alt="Axel Rauschmayer’s avatar" itemprop="image" src="./Read Exploring ES6 _ Leanpub_files/iFzELOBn.jpeg">Axel Rauschmayer</a>
</div>
</div>
<div class="cover-image small">
<a href="https://leanpub.com/exploring-es6"><img alt="Small?1435848766" itemprop="image" src="./Read Exploring ES6 _ Leanpub_files/small"></a>
</div>
<div>
<ul class="book-details-list pricing">
<li class="detail">
<span class="minimum-price taxamo-price" itemprop="lowPrice">$28.00</span>
<p>Minimum Price</p>
</li>
<li class="detail">
<span class="price-suggested taxamo-price" itemprop="highPrice">$35.00</span>
<p>Suggested Price</p>
</li>
</ul>
<button class="add-to-cart-modal" data-type="featured">Add Ebook to cart</button>
<div class="modal">
<label for="cart-modal-switch"></label>
<input class="modal-state" id="cart-modal-switch" type="checkbox">
<div class="modal-window">
<div class="modal-inner">
<label class="modal-close" for="cart-modal-switch"></label>
<div class="modal-title-wrapper">
<h1 class="modal-title">Set Your Price <small>(USD)</small></h1>
</div>
<div class="cartable-meta">
<div class="cover-image">
<img alt="Exploring ES6" src="./Read Exploring ES6 _ Leanpub_files/small">
</div>
<div class="cartable-info">
<h6 class="cartable-title">Exploring ES6</h6>
<p>The Book</p>
</div>
</div>
<div class="spinner"></div>
<div class="purchase-info">
<div class="pricing-wrapper">
<div class="price-detail">
<div class="price-minimum taxamo-price" itemprop="lowPrice">$28.00</div>
<div class="price-text">Minimum</div>
</div>
<div class="price-detail">
<div class="price-highlight taxamo-price" itemprop="highPrice">$35.00</div>
<div class="price-text">Suggested</div>
</div>
</div>
<div id="price-hint">Drag the slider, or click the price to type in your own (up to $500)</div>
</div>
<section class="add-to-cart-form" data-flat-fee="0.5" data-max="70" data-min="28.0" data-ratio-of-revenue-to-authors="1.0" data-ratio-of-revenue-to-causes="0.0" data-royalties-to-revenue-ratio="0.9" data-show-what-author-gets="" data-suggested-price="35.0">
<div class="sliders-wrapper">
<label class="slider-label">
You pay
<i class="fa fa-question-circle tooltip-item more-info">
<div class="tooltip">
<p>The author is letting you set the price you'll pay for this book! The suggested price is <strong class="taxamo-price">$35.00</strong>, and the minimum price is <span class="taxamo-price">$28.00</span>.</p>
</div>
</i>

</label>
<input class="you_pay" max="70" min="28.0" step="0.01" type="number">
<input class="hidden" id="cart_item_taxamo_subtotal" name="cart_item[taxamo_subtotal]" type="number">
<label class="slider-label">Author earns</label>
<input class="author_earns" max="70" min="28.0" step="0.01" type="number">
</div>

<div class="right-contents">
<div class="add-to-cart-wrapper">
<button class="add-to-cart small" data-cartable-id="31590" data-cartable-type="Package">
Add Ebook to cart
</button>
</div>
</div>
</section>

</div>
</div>

</div>
</div>
</section>
</div>

</div>
<h1>
Exploring ES6
</h1>
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class="toc has-parts">
  <li>
    <span>&nbsp;</span>
    <ul>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-what-you-need-to-know-about-this-book">What you need to know about this book</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-audience-javascript-programmers">Audience: JavaScript programmers</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-why-should-i-read-this-book">Why should I read this book?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-how-to-read-this-book">How to read this book</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-glossary-and-conventions">Glossary and conventions</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-demo-code-on-github">Demo code on GitHub</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-sidebars">Sidebars</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-footnotes">Footnotes</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-preface">Preface</a>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-acknowledgements">Acknowledgements</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-background"><span class="section-number">I </span>Background</a>
    <ul>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-about-ecmascript-6-es6"><span class="section-number">1. </span>About ECMAScript 6 (ES6)</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-tc39-ecma-technical-committee-39"><span class="section-number">1.1 </span>TC39 (Ecma Technical Committee 39)</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-how-ecmascript-6-was-designed"><span class="section-number">1.2 </span>How ECMAScript 6 was designed</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-javascript-versus-ecmascript"><span class="section-number">1.3 </span>JavaScript versus ECMAScript</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-upgrading-to-es6"><span class="section-number">1.4 </span>Upgrading to ES6</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-goals-for-es6"><span class="section-number">1.5 </span>Goals for ES6</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-an-overview-of-es6-features"><span class="section-number">1.6 </span>An overview of ES6 features</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ecmascript-history"><span class="section-number">1.7 </span>A brief history of ECMAScript</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-faq-ecmascript-6"><span class="section-number">2. </span>FAQ: ECMAScript 6</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-how-much-of-es6-is-supported-natively-by-current-engines"><span class="section-number">2.1 </span>How much of ES6 is supported natively by current engines?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-how-do-i-migrate-my-ecmascript-5-code-to-ecmascript-6"><span class="section-number">2.2 </span>How do I migrate my ECMAScript 5 code to ECMAScript 6?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-does-it-still-make-sense-to-learn-ecmascript-5"><span class="section-number">2.3 </span>Does it still make sense to learn ECMAScript 5?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-is-es6-bloated"><span class="section-number">2.4 </span>Is ES6 bloated?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-isnt-the-es6-specification-very-big"><span class="section-number">2.5 </span>Isn’t the ES6 specification very big?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-does-es6-have-array-comprehensions"><span class="section-number">2.6 </span>Does ES6 have array comprehensions?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-is-es6-statically-typed"><span class="section-number">2.7 </span>Is ES6 statically typed?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-should-i-avoid-classes"><span class="section-number">2.8 </span>Should I avoid classes?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-does-es6-have-traits-or-mixins"><span class="section-number">2.9 </span>Does ES6 have traits or mixins?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-why-are-there-fat-arrow-functions--in-es6-but-no-thin-arrow-functions--"><span class="section-number">2.10 </span>Why are there “fat” arrow functions (<code>=&gt;</code>) in ES6, but no “thin” arrow functions (<code>-&gt;</code>)?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-where-can-i-find-more-es6-resources"><span class="section-number">2.11 </span>Where can I find more ES6 resources?</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_one-javascript"><span class="section-number">3. </span>One JavaScript: avoiding versioning in ECMAScript 6</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-versioning"><span class="section-number">3.1 </span>Versioning</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-strict-mode-and-ecmascript-6"><span class="section-number">3.2 </span>Strict mode and ECMAScript 6</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-conclusion"><span class="section-number">3.3 </span>Conclusion</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-further-reading"><span class="section-number">3.4 </span>Further reading</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_deploying-es6"><span class="section-number">4. </span>Deploying ECMAScript 6</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-using-ecmascript-6-today"><span class="section-number">4.1 </span>Using ECMAScript 6 today</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-transpilation-tools"><span class="section-number">4.2 </span>Transpilation tools</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_es6-tools-libraries"><span class="section-number">4.3 </span>Other useful ES6 tools and libraries</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-es6-repls"><span class="section-number">4.4 </span>ES6 REPLs</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-are-there-es6-features-that-cant-be-transpiled-to-es5"><span class="section-number">4.5 </span>Are there ES6 features that can’t be transpiled to ES5?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-example-transpilation-setups"><span class="section-number">4.6 </span>Example transpilation setups</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_transpilation-webpack-babel"><span class="section-number">4.7 </span>Example setup: Client-side ES6 via webpack and Babel</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_dynamic-transpilation-nodejs-babel"><span class="section-number">4.8 </span>Example setup: Dynamically transpiled ES6 on Node.js via Babel</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_static-transpilation-nodejs-babel"><span class="section-number">4.9 </span>Example setup: Statically transpiled ES6 on Node.js via Babel and gulp</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-data"><span class="section-number">II </span>Data</a>
    <ul>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_numbers"><span class="section-number">5. </span>New number and <code>Math</code> features</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview"><span class="section-number">5.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-new-integer-literals"><span class="section-number">5.2 </span>New integer literals</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-new-static-number-properties"><span class="section-number">5.3 </span>New static <code>Number</code> properties</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-math"><span class="section-number">5.4 </span>Math</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-faq-numbers"><span class="section-number">5.5 </span>FAQ: numbers</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_strings"><span class="section-number">6. </span>New string features</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-1"><span class="section-number">6.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-unicode-code-point-escapes"><span class="section-number">6.2 </span>Unicode code point escapes</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-string-interpolation-multi-line-string-literals-and-raw-string-literals"><span class="section-number">6.3 </span>String interpolation, multi-line string literals and raw string literals</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-iterating-over-strings"><span class="section-number">6.4 </span>Iterating over strings</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-numeric-values-of-code-points"><span class="section-number">6.5 </span>Numeric values of code points</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-checking-for-containment-and-repeating-strings"><span class="section-number">6.6 </span>Checking for containment and repeating strings</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-all-new-string-methods"><span class="section-number">6.7 </span>All new string methods</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_symbols"><span class="section-number">7. </span>Symbols</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-2"><span class="section-number">7.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-a-new-primitive-type"><span class="section-number">7.2 </span>A new primitive type</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-using-symbols-to-represent-concepts"><span class="section-number">7.3 </span>Using symbols to represent concepts</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-symbols-as-keys-of-properties"><span class="section-number">7.4 </span>Symbols as keys of properties</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-crossing-realms-with-symbols"><span class="section-number">7.5 </span>Crossing realms with symbols</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-wrapper-objects-for-symbols"><span class="section-number">7.6 </span>Wrapper objects for symbols</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-converting-symbols-to-other-primitive-types"><span class="section-number">7.7 </span>Converting symbols to other primitive types</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-json-and-symbols"><span class="section-number">7.8 </span>JSON and symbols</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-faq-symbols"><span class="section-number">7.9 </span>FAQ: symbols</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-symbol-api"><span class="section-number">7.10 </span>The symbol API</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_template-literals"><span class="section-number">8. </span>Template literals and tagged templates</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-3"><span class="section-number">8.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-introduction"><span class="section-number">8.2 </span>Introduction</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-examples-of-using-tagged-templates"><span class="section-number">8.3 </span>Examples of using tagged templates</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-implementing-tag-functions"><span class="section-number">8.4 </span>Implementing tag functions</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-faq-template-literals-and-tagged-templates"><span class="section-number">8.5 </span>FAQ: template literals and tagged templates</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-variables-and-scoping"><span class="section-number">9. </span>Variables and scoping</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-4"><span class="section-number">9.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_let-const"><span class="section-number">9.2 </span>Block scoping via <code>let</code> and <code>const</code></a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-const-creates-immutable-variables"><span class="section-number">9.3 </span><code>const</code> creates immutable variables</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-temporal-dead-zone"><span class="section-number">9.4 </span>The temporal dead zone</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_let-const-loop-heads"><span class="section-number">9.5 </span><code>let</code> and <code>const</code> in loop heads</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-parameters"><span class="section-number">9.6 </span>Parameters</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-global-object"><span class="section-number">9.7 </span>The global object</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-function-declarations-and-class-declarations"><span class="section-number">9.8 </span>Function declarations and class declarations</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#var-vs-let-vs-const"><span class="section-number">9.9 </span>Coding style: <code>var</code> vs. <code>let</code> vs. <code>const</code></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_destructuring"><span class="section-number">10. </span>Destructuring</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-5"><span class="section-number">10.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-background-constructing-data-object-and-array-literals-vs-extracting-data-destructuring"><span class="section-number">10.2 </span>Background: Constructing data (object and Array literals) vs. extracting data (destructuring)</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-patterns"><span class="section-number">10.3 </span>Patterns</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-how-do-patterns-access-the-innards-of-values"><span class="section-number">10.4 </span>How do patterns access the innards of values?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-if-a-part-has-no-match"><span class="section-number">10.5 </span>If a part has no match</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-more-object-destructuring-features"><span class="section-number">10.6 </span>More object destructuring features</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-more-array-destructuring-features"><span class="section-number">10.7 </span>More Array destructuring features</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-you-can-assign-to-more-than-just-variables"><span class="section-number">10.8 </span>You can assign to more than just variables</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-pitfalls-of-destructuring"><span class="section-number">10.9 </span>Pitfalls of destructuring</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-examples-of-destructuring"><span class="section-number">10.10 </span>Examples of destructuring</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_destructuring-algorithm"><span class="section-number">10.11 </span>The destructuring algorithm</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_parameter-handling"><span class="section-number">11. </span>Parameter handling</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-6"><span class="section-number">11.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-parameter-handling-as-destructuring"><span class="section-number">11.2 </span>Parameter handling as destructuring</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_parameter-default-values"><span class="section-number">11.3 </span>Parameter default values</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_rest-parameters"><span class="section-number">11.4 </span>Rest parameters</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_named-parameters"><span class="section-number">11.5 </span>Simulating named parameters</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-examples-of-destructuring-in-parameter-handling"><span class="section-number">11.6 </span>Examples of destructuring in parameter handling</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_parameter-handling-style-tips"><span class="section-number">11.7 </span>Coding style tips</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_spread-operator"><span class="section-number">11.8 </span>The spread operator (<code>...</code>)</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-modularity"><span class="section-number">III </span>Modularity</a>
    <ul>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_callables"><span class="section-number">12. </span>Callable entities in ECMAScript 6</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_callable-entities"><span class="section-number">12.1 </span>Callable entities in ES6</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_callables-style"><span class="section-number">12.2 </span>Thoughts on style</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_dispatched-and-direct-method-calls"><span class="section-number">12.3 </span>Dispatched and direct method calls in ECMAScript 5 and 6</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_arrow-functions"><span class="section-number">13. </span>Arrow functions</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-7"><span class="section-number">13.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-traditional-functions-are-bad-non-method-functions-due-to-this"><span class="section-number">13.2 </span>Traditional functions are bad non-method functions, due to <code>this</code></a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-arrow-function-syntax"><span class="section-number">13.3 </span>Arrow function syntax</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-lexical-variables"><span class="section-number">13.4 </span>Lexical variables</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-syntax-pitfalls"><span class="section-number">13.5 </span>Syntax pitfalls</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-arrow-functions-versus-normal-functions"><span class="section-number">13.6 </span>Arrow functions versus normal functions</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-new-oop-features-besides-classes"><span class="section-number">14. </span>New OOP features besides classes</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-8"><span class="section-number">14.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-new-features-of-object-literals"><span class="section-number">14.2 </span>New features of object literals</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-new-methods-of-object"><span class="section-number">14.3 </span>New methods of <code>Object</code></a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_iterating-property-keys"><span class="section-number">14.4 </span>Iterating over property keys in ES6</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-faq-object-literals"><span class="section-number">14.5 </span>FAQ: object literals</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_classes"><span class="section-number">15. </span>Classes</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-9"><span class="section-number">15.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-essentials"><span class="section-number">15.2 </span>The essentials</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-details-of-classes"><span class="section-number">15.3 </span>The details of classes</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-details-of-subclassing"><span class="section-number">15.4 </span>The details of subclassing</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_species-pattern"><span class="section-number">15.5 </span>The species pattern</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-faq-classes"><span class="section-number">15.6 </span>FAQ: classes</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_class-benefits"><span class="section-number">15.7 </span>The pros and cons of classes</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-further-reading-1"><span class="section-number">15.8 </span>Further reading</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_modules"><span class="section-number">16. </span>Modules</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-10"><span class="section-number">16.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-modules-in-javascript"><span class="section-number">16.2 </span>Modules in JavaScript</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-a-first-look-at-es6-modules"><span class="section-number">16.3 </span>A first look at ES6 modules</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-design-goals"><span class="section-number">16.4 </span>Design goals</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-more-on-importing-and-exporting"><span class="section-number">16.5 </span>More on importing and exporting</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_module-loader-api"><span class="section-number">16.6 </span>The ECMAScript 6 module loader API</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_modules-in-browsers"><span class="section-number">16.7 </span>Using ES6 modules in browsers</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-faq-modules"><span class="section-number">16.8 </span>FAQ: modules</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-benefits-of-ecmascript-6-modules"><span class="section-number">16.9 </span>Benefits of ECMAScript 6 modules</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-further-reading-2"><span class="section-number">16.10 </span>Further reading</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-collections"><span class="section-number">IV </span>Collections</a>
    <ul>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_arrays"><span class="section-number">17. </span>New Array features</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-new-static-array-methods"><span class="section-number">17.1 </span>New static <code>Array</code> methods</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-new-arrayprototype-methods"><span class="section-number">17.2 </span>New <code>Array.prototype</code> methods</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_maps-sets"><span class="section-number">18. </span>Maps and Sets</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-11"><span class="section-number">18.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-map"><span class="section-number">18.2 </span>Map</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_weakmap"><span class="section-number">18.3 </span>WeakMap</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-set"><span class="section-number">18.4 </span>Set</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-weakset"><span class="section-number">18.5 </span>WeakSet</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-faq-maps-and-sets"><span class="section-number">18.6 </span>FAQ: Maps and Sets</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-typed-arrays"><span class="section-number">19. </span>Typed Arrays</a>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_iteration"><span class="section-number">20. </span>Iterables and iterators</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-12"><span class="section-number">20.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-iterability"><span class="section-number">20.2 </span>Iterability</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-iterable-data-sources"><span class="section-number">20.3 </span>Iterable data sources</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-iterating-language-constructs"><span class="section-number">20.4 </span>Iterating language constructs</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-implementing-iterables"><span class="section-number">20.5 </span>Implementing iterables</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-more-examples-of-iterables"><span class="section-number">20.6 </span>More examples of iterables</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-faq-iterables-and-iterators"><span class="section-number">20.7 </span>FAQ: iterables and iterators</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-ecmascript-6-iteration-protocol-in-depth"><span class="section-number">20.8 </span>The ECMAScript 6 iteration protocol in depth</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators"><span class="section-number">21. </span>Generators</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-13"><span class="section-number">21.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-what-are-generators"><span class="section-number">21.2 </span>What are generators?</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-generators-as-iterators-data-production"><span class="section-number">21.3 </span>Generators as iterators (data production)</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-generators-as-observers-data-consumption"><span class="section-number">21.4 </span>Generators as observers (data consumption)</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-generators-as-coroutines-cooperative-multitasking"><span class="section-number">21.5 </span>Generators as coroutines (cooperative multitasking)</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-examples-of-generators"><span class="section-number">21.6 </span>Examples of generators</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-inheritance-within-the-iteration-api-including-generators"><span class="section-number">21.7 </span>Inheritance within the iteration API (including generators)</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_formating-generators"><span class="section-number">21.8 </span>Style consideration: whitespace before and after the asterisk</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-conclusion-2"><span class="section-number">21.9 </span>Conclusion</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-further-reading-4"><span class="section-number">21.10 </span>Further reading</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-standard-library"><span class="section-number">V </span>Standard library</a>
    <ul>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-regular-expressions"><span class="section-number">22. </span>Regular expressions</a>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_async"><span class="section-number">23. </span>Asynchronous programming (background)</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-javascript-call-stack"><span class="section-number">23.1 </span>The JavaScript call stack</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-browser-event-loop"><span class="section-number">23.2 </span>The browser event loop</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-receiving-results-asynchronously"><span class="section-number">23.3 </span>Receiving results asynchronously</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-looking-ahead"><span class="section-number">23.4 </span>Looking ahead</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-further-reading-5"><span class="section-number">23.5 </span>Further reading</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_promises"><span class="section-number">24. </span>Promises for asynchronous programming</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-14"><span class="section-number">24.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-promises-1"><span class="section-number">24.2 </span>Promises</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-a-first-example"><span class="section-number">24.3 </span>A first example</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-creating-and-using-promises"><span class="section-number">24.4 </span>Creating and using Promises</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-examples"><span class="section-number">24.5 </span>Examples</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-chaining-promises"><span class="section-number">24.6 </span>Chaining Promises</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-composition"><span class="section-number">24.7 </span>Composition</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-promises-are-always-async"><span class="section-number">24.8 </span>Promises are always async</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-cheat-sheet-the-ecmascript-6-promise-api"><span class="section-number">24.9 </span>Cheat sheet: the ECMAScript 6 Promise API</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-pros-and-cons-of-promises"><span class="section-number">24.10 </span>Pros and cons of Promises</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-promises-and-generators"><span class="section-number">24.11 </span>Promises and generators</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_debugging-promises"><span class="section-number">24.12 </span>Debugging Promises</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-internals-of-promises"><span class="section-number">24.13 </span>The internals of Promises</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-two-useful-additional-promise-methods"><span class="section-number">24.14 </span>Two useful additional Promise methods</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-es6-compatible-promise-libraries"><span class="section-number">24.15 </span>ES6-compatible Promise libraries</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-interfacing-with-legacy-asynchronous-code"><span class="section-number">24.16 </span>Interfacing with legacy asynchronous code</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-further-reading-6"><span class="section-number">24.17 </span>Further reading</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-miscellaneous"><span class="section-number">VI </span>Miscellaneous</a>
    <ul>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_unicode"><span class="section-number">25. </span>Unicode</a>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_tail-calls"><span class="section-number">26. </span>Tail call optimization</a>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_proxies"><span class="section-number">27. </span>Meta programming with proxies</a>
        <ul>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-overview-15"><span class="section-number">27.1 </span>Overview</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-programming-versus-meta-programming"><span class="section-number">27.2 </span>Programming versus meta programming</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-a-first-look-at-proxies"><span class="section-number">27.3 </span>A first look at proxies</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-use-cases-for-proxies"><span class="section-number">27.4 </span>Use cases for proxies</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-the-design-of-the-proxy-api"><span class="section-number">27.5 </span>The design of the proxy API</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_reference-proxy-api"><span class="section-number">27.6 </span>Reference: the proxy API</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-conclusion-3"><span class="section-number">27.7 </span>Conclusion</a>
          </li>
          <li>
            <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-further-reading-7"><span class="section-number">27.8 </span>Further reading</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#leanpub-auto-coding-style-tips-for-ecmascript-6"><span class="section-number">28. </span>Coding style tips for ECMAScript 6</a>
      </li>
    </ul>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main">
<h2 id="leanpub-auto-what-you-need-to-know-about-this-book">What you need to know about this book</h2>

<p>This book is about ECMAScript 6 (whose official name is ECMAScript 2015), a new version of JavaScript.</p>

<h3 id="leanpub-auto-audience-javascript-programmers">Audience: JavaScript programmers</h3>

<p>In order to understand this book, you should already know JavaScript. If you don’t: my other book “<a href="http://speakingjs.com/">Speaking JavaScript</a>” is free online and teaches programmers all of JavaScript (up to and including ECMAScript 5).</p>

<h3 id="leanpub-auto-why-should-i-read-this-book">Why should I read this book?</h3>

<p>This book covers ECMAScript 6 in great detail, but is structured so that you can also quickly get an overview if you want to. It not only tells you how ES6 works, it also tells you why it works the way it does.</p>

<h3 id="leanpub-auto-how-to-read-this-book">How to read this book</h3>

<p>This book has a lot of content, but its structure makes it easy to adjust the level of detail that you are confronted with. There are three levels of detail:</p>

<ul>
<li>
<strong>Quick start:</strong> Almost every chapter starts with a section that gives a brief overview of the feature described in the chapter.</li>
  <li>
<strong>Solid foundation:</strong> Each chapter always starts with the essentials and then increasingly goes into details. The headings should give you a good idea of when to stop reading, but I also occasionally give tips in sidebars w.r.t. how important it is to know something.</li>
  <li>
<strong>In-depth knowledge:</strong> Read all of a chapter, including the in-depth parts.</li>
</ul>
<p>Other things to know:</p>

<ul>
<li>
<strong>Recommendations:</strong> I occasionally recommend simple rules. Those are meant as guidelines, to keep you safe without you having to know (or remember) all of the details. I tend to favor mainstream over elegance, because most code doesn’t exist in a vacuum. However, I’ll always give you enough information so that you can make up your own mind.</li>
  <li>
<strong>Forum:</strong> The “Exploring ES6” homepage <a href="http://exploringjs.com/#forum">links to a forum</a> where you can discuss questions and ideas related to this book.</li>
  <li>
<strong>Errata (typos, errors, etc.):</strong> On <a href="http://exploringjs.com/#errata">the “Exploring ES6” homepage</a>, there are links to a form for submitting errata and to a list with submitted errata.</li>
</ul>
<h3 id="leanpub-auto-glossary-and-conventions">Glossary and conventions</h3>

<ul>
<li>Receiver (of a method call): Given a method call <code>obj.m(···)</code>, <code>obj</code> is the <em>receiver</em> of the method call and accessible via <code>this</code> inside the method.</li>
  <li>Signature of a function (or a method): The (type) signature of a function describes how the function is to be called, what its inputs and its output are. I’m using the syntax established by Microsoft TypeScript and Facebook Flow in this book. An example of a signature:
    <div class="code-block">
<div class="highlight"><pre>  <code class="nb">parseInt</code><code class="p">(</code><code class="nx">string</code> <code class="o">:</code> <code class="nx">string</code><code class="p">,</code> <code class="nx">radix</code><code class="o">?</code> <code class="o">:</code> <code class="nx">number</code><code class="p">)</code> <code class="o">:</code> <code class="nx">number</code>
</pre></div>
    
</div>

    <p>You can see that <code>parseInt()</code> expects a string and a number and returns a number. If the type of a parameter is clear, I often omit the type annotation.</p>
  </li>
</ul>
<h4 id="leanpub-auto-documenting-classes">Documenting classes</h4>

<p>The API of a class <code>C</code> is usually documented as follows:</p>

<ul>
<li>
<code>C</code> constructor</li>
  <li>Static <code>C</code> methods</li>
  <li>
<code>C.prototype</code> methods</li>
</ul>
<h4 id="leanpub-auto-capitalization">Capitalization</h4>

<p>In English, I capitalize JavaScript terms as follows:</p>

<ul>
<li>The names of primitive entities are not capitalized: a boolean value, a number value, a symbol, a string. One reason why I’m doing this is because TypeScript and Flow distinguish:
    <ul>
<li>The type <code>String</code>: its members are objects, instances of <code>String</code>.</li>
      <li>The type <code>string</code>: its members are primitive values, strings.</li>
    </ul>
</li>
  <li>The data structure Map is capitalized. Rationale: distinguish from the Array method <code>map()</code>.</li>
  <li>The data structure Set is capitalized. Rationale: distinguish from the verb <em>set</em>.</li>
  <li>Array and Promise are capitalized. Rationale: easy to confuse with English words.</li>
  <li>Not capitalized (for now): object, generator, proxy.</li>
</ul>
<h3 id="leanpub-auto-demo-code-on-github">Demo code on GitHub</h3>

<p>Several repositories on GitHub contain code shown in this book:</p>

<ul>
<li><a href="https://github.com/rauschma/async-examples"><code>async-examples</code></a></li>
  <li><a href="https://github.com/rauschma/babel-on-node"><code>babel-on-node</code></a></li>
  <li><a href="https://github.com/rauschma/demo_promise"><code>demo_promise</code></a></li>
  <li><a href="https://github.com/rauschma/generator-examples"><code>generator-examples</code></a></li>
  <li><a href="https://github.com/rauschma/node-es6-demo"><code>node-es6-demo</code></a></li>
  <li><a href="https://github.com/rauschma/promise-examples"><code>promise-examples</code></a></li>
  <li><a href="https://github.com/rauschma/webpack-es6-demo"><code>webpack-es6-demo</code></a></li>
</ul>
<h3 id="leanpub-auto-sidebars">Sidebars</h3>

<p>Sidebars are boxes of text marked with icons. They complement the normal content.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_eye.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-tips-for-reading">Tips for reading</h3>

  <p>Gives you tips for reading (what content to skip etc.).</p>

    </td>
  </tr></tbody></table>
<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-code-on-github">Code on GitHub</h3>

  <p>Tells you where you can download demo code shown in this book.</p>

    </td>
  </tr></tbody></table>
<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-information">Information</h3>

  <p>General information.</p>

    </td>
  </tr></tbody></table>
<table class="question sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_question-circle.png" alt="question" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-question">Question</h3>

  <p>Asks and answers a question, in FAQ style.</p>

    </td>
  </tr></tbody></table>
<table class="warning sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_warning.png" alt="warning" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-warning">Warning</h3>

  <p>Things you need to be careful about.</p>

    </td>
  </tr></tbody></table>
<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_external-link.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-external-material">External material</h3>

  <p>Points to related material hosted somewhere on the web.</p>

    </td>
  </tr></tbody></table>
<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-related-parts-of-the-spec">Related parts of the spec</h3>

  <p>Explains where in the ES6 spec you can find the feature that is currently being explained.</p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-footnotes">Footnotes</h3>

<p>Occasionally, I refer to (publicly available) external material via footnotes. Two sources are marked with a prefix in square brackets:</p>

<ul>
<li>[Spec] refers to content in the HTML version of the ES6 spec.</li>
  <li>[Speaking JS] refers to content in the HTML version of “Speaking JavaScript”.</li>
</ul>
<h2 id="leanpub-auto-preface">Preface</h2>

<p>You are reading a book about ECMAScript 6 (ES6), a new version of JavaScript. It’s great that we can finally use that version, which had a long and eventful past: It was first conceived as ECMAScript 4, a successor to ECMAScript 3 (whose release was in December 1999). In July 2008, plans changed and the next versions of JavaScript were to be first a small incremental release (which became ES5) and then a larger, more powerful release. The latter had the code name Harmony and part of it became ES6.</p>

<p>ECMAScript 5 was standardized in December 2009. I first heard and <a href="http://www.2ality.com/2011/01/brendan-eichs-dream-for-next-version-of.html">blogged</a> about ECMAScript 6 in January 2011, when it was still called <em>Harmony</em>. The original plan was to finish ES6 in 2013, but things took longer and it was standardized in June 2015. (A more detailed account of ES6’s history is given in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ecmascript-history">the next chapter</a>.)</p>

<p>With a few minor exceptions, I am happy how ECMAScript 6 turned out. This book describes my experiences with, and my research of, its features. Similarly to ES6, it took a long time to finish – in a way, I started writing it in early 2011. Like my previous book “<a href="http://speakingjs.com/">Speaking JavaScript</a>”, I wrote most of it as a series of blog posts. I like the discussion and feedback that this open process enables, which is why this book is available for free online.</p>

<p>The offline version (PDF, EPUB, MOBI) of <em>Exploring ES6</em> is sold as a <em>living book</em>: You buy an early version and get free upgrades until it is completely done. It will take a while until that happens, but despite that, it is already a very complete book.</p>

<p>I hope that reading the book conveys some of the fun I had investigating and playing with ES6.</p>

<p><em>Axel</em></p>

<h2 id="leanpub-auto-acknowledgements">Acknowledgements</h2>

<p>Many people have – directly or indirectly – contributed to this book, by answering questions, pointing out bugs in blog posts, etc.:</p>

<p>Jake Archibald, André Bargull, Guy Bedford, James Burke, Mathias Bynens, Raymond Camden, Domenic Denicola, Brendan Eich, Eric Elliott, Michael Ficarra, Aaron Frost, Andrea Giammarchi, Jaydson Gomes, Jordan Harband, David Herman, James Kyle, Russell Leggett, Dmitri Lomov, Sebastian McKenzie, Calvin Metcalf, Mark S. Miller, Alan Norbauer, Mariusz Novak, Addy Osmani, Claude Pache, John K. Paul, Philip Roberts, Mike Samuel, Tom Schuster, Kyle Simpson (getify), Kevin Smith, Dmitry Soshnikov, Ingvar Stepanyan, Tom Van Cutsem, Šime Vidas, Rick Waldron, Allen Wirfs-Brock, Nicholas C. Zakas, Ondřej Žára, Juriy Zaytsev (kangax). And many more!</p>

<!-- begin mainmatter -->
<h1 id="leanpub-auto-background">
<span class="section-number">I </span>Background</h1>

<h2 id="leanpub-auto-about-ecmascript-6-es6">
<span class="section-number">1. </span>About ECMAScript 6 (ES6)</h2>

<p>It took a long time to finish it, but ECMAScript 6, the next version of JavaScript, is finally a reality:</p>

<ul>
<li>It became a standard in June 2015.</li>
  <li>Its features are slowly appearing in JavaScript engines (as documented in kangax’ <a href="http://kangax.github.io/compat-table/es6/">ES6 compatibility table</a>).</li>
  <li>Transpilers (such as <a href="https://babeljs.io/">Babel</a> and <a href="https://github.com/google/traceur-compiler">Traceur</a>) let you compile ES6 to ES5.</li>
</ul>
<p>The next sections explain concepts that are important in the world of ES6.</p>

<h3 id="leanpub-auto-tc39-ecma-technical-committee-39">
<span class="section-number">1.1 </span>TC39 (Ecma Technical Committee 39)</h3>

<p><a href="http://www.ecma-international.org/memento/TC39.htm">TC39 (Ecma Technical Committee 39)</a> is the committe that evolves JavaScript. Its members are companies (among others, all major browser vendors). <a href="http://www.ecma-international.org/memento/TC39-M.htm">TC39 meets regularly</a>, its meetings are attended by delegates that members send and by invited experts. Minutes of the meetings are <a href="https://github.com/tc39/tc39-notes">available online</a> and give you a good idea of how TC39 works.</p>

<h3 id="leanpub-auto-how-ecmascript-6-was-designed">
<span class="section-number">1.2 </span>How ECMAScript 6 was designed</h3>

<p>The ECMAScript 6 design process centers on <em>proposals</em> for features. Proposals are often triggered by suggestions from the developer community. To avoid design by committee, proposals are maintained by <em>champions</em> (1–2 committee delegates).</p>

<p>A proposal goes through the following steps before it becomes a standard:</p>

<ul>
<li>Sketch (informally: “strawman proposal”): A first description of the proposed feature.</li>
  <li>Proposal: If TC39 agrees that a feature is important, it gets promoted to official proposal status. That does not guarantee it will become a standard, but it considerably increases its chances. The deadline for ES6 proposals was May 2011, no major new proposals were considered after that.</li>
  <li>Implementations: Proposed features must be implemented, ideally in two JavaScript engines. Implementations and feedback from the community shape the proposal as it evolves.</li>
  <li>Standard: If the proposal continues to prove itself and is accepted by TC39, it will eventually be included in an edition of the ECMAScript standard. At this point, it is a standard feature.</li>
</ul>
<p>[Source of this section: “<a href="http://tc39wiki.calculist.org/about/harmony/">The Harmony Process</a>” by David Herman.]</p>

<h4 id="leanpub-auto-the-design-process-after-es6">
<span class="section-number">1.2.1 </span>The design process after ES6</h4>

<p>Starting with ECMAScript 7 (whose official name is ECMAScript 2016), TC39 will time-box releases. The plan is to release a new version of ECMAScript every year, with whatever features are ready at that time. That means that from now on, ECMAScript versions will be relatively small upgrades.</p>

<p>Work on ECMAScript 2016 (and later) has already begun, <a href="https://github.com/tc39/ecma262">current proposals</a> are listed on GitHub. The process has changed, too and is described in a <a href="https://docs.google.com/document/d/1QbEE0BsO4lvl7NFTn5WXWeiEIBfaVUF7Dk0hpPpPDzU/edit">TC39 process document</a>.</p>

<h3 id="leanpub-auto-javascript-versus-ecmascript">
<span class="section-number">1.3 </span>JavaScript versus ECMAScript</h3>

<p>JavaScript is what everyone calls the language, but that name is trademarked (by Oracle, which inherited the trademark from Sun). Therefore, the official name of JavaScript is <em>ECMAScript</em>. That name is comes from the standard organization Ecma, which manages the language standard. Since ECMAScript’s inception, the name of the organization changed from the acronym “ECMA” to the proper name “Ecma”.</p>

<p>Versions of JavaScript are defined by specifications that carry the official name of the language. Hence, the first standard version of JavaScript is ECMAScript 1 which is short for “ECMAScript Language Specification, Edition 1”. ECMAScript x is often abbreviated ESx.</p>

<h3 id="leanpub-auto-upgrading-to-es6">
<span class="section-number">1.4 </span>Upgrading to ES6</h3>

<p>The stake holders on the web are:</p>

<ul>
<li>Implementors of JavaScript engines</li>
  <li>Developers of web applications</li>
  <li>Users</li>
</ul>
<p>These groups have remarkably little control over each other. That’s why upgrading a web language is so challenging.</p>

<p>On one hand, upgrading engines is challenging, because they are confronted with all kinds of code on the web, sometimes very old one. You also want engine upgrades to be automatic and unnoticeable for users. Therefore, ES6 is a superset of ES5, nothing is removed<sup id="fnref-introduction_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-introduction_1" rel="footnote">1</a></sup>. ES6 upgrades the language without introducing versions or modes. It even manages to make strict mode the de-facto default (via modules), without increasing the rift between it and sloppy mode. The approach that was taken is called “One JavaScript” and explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_one-javascript">a separate chapter</a>.</p>

<p>On the other hand, upgrading code is challenging, because your code must run on all JavaScript engines that are used by your target audience. Therefore, if you want to use ES6 in your code, you only have two choices: You can either wait until no one in your target audience uses a non-ES6 engine, anymore. That will take years; mainstream audiences were at that point w.r.t. ES5 when ES6 became a standard in June 2015. And ES5 was standardized in December 2009! Or you can compile ES6 to ES5 and use it now (how that is done is explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_deploying-es6">a separate chapter</a>).</p>

<p>Goals and requirements clash in the design of ES6:</p>

<ul>
<li>Goals are fixing JavaScript’s pitfalls and adding new features.</li>
  <li>Requirements are that both need to be done without breaking existing code and without changing the lightweight nature of the language.</li>
</ul>
<h3 id="leanpub-auto-goals-for-es6">
<span class="section-number">1.5 </span>Goals for ES6</h3>

<p><a href="http://wiki.ecmascript.org/doku.php?id=harmony:harmony">The original project page for Harmony/ES6</a> includes several goals. In the following subsections, I’m taking a look at some of them.</p>

<h4 id="leanpub-auto-goal-be-a-better-language">
<span class="section-number">1.5.1 </span>Goal: Be a better language</h4>

<p>The goal is: Be a better language for writing:</p>

<ol class="lower-roman lower-roman">
<li>complex applications;</li>
  <li>libraries (possibly including the DOM) shared by those applications;</li>
  <li>code generators targeting the new edition.</li>
</ol>
<p>Sub-goal (i) acknowledges that applications written in JavaScript have grown huge. A key ES6 feature fulfilling this goal is built-in modules.</p>

<p>Modules are also an answer to goal (ii). As an aside, the DOM is notoriously difficult to implement in JavaScript. ES6 Proxies should help here (as described in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_proxies">a separate chapter</a>).</p>

<p>Several features were specifically added not to improve JavaScript, but to make it easier to compile to JavaScript. Two examples are:</p>

<ul>
<li>
<code>Math.fround()</code> – rounding Numbers to 32 bit floats</li>
  <li>
<code>Math.imul()</code> – multiplying two 32 bit ints</li>
</ul>
<p>They are both useful for, e.g., compiling C/C++ to JavaScript via <a href="https://github.com/kripken/emscripten">Emscripten</a>.</p>

<h4 id="leanpub-auto-goal-improve-interoperation">
<span class="section-number">1.5.2 </span>Goal: Improve interoperation</h4>

<p>The goal is: Improve interoperation, adopting de facto standards where possible.</p>

<p>Three examples are:</p>

<ul>
<li>Classes: are based on how constructor functions are currently used.</li>
  <li>Modules: picked up design ideas from the CommonJS module format.</li>
  <li>Arrow functions: have syntax that is borrowed from CoffeeScript.</li>
  <li>Named function parameters: There is no built-in support for named parameters. Instead, the existing practice of naming parameters via object literals is supported via <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_named-parameters">destructuring in parameter definitions</a>.</li>
</ul>
<h4 id="leanpub-auto-goal-versioning">
<span class="section-number">1.5.3 </span>Goal: Versioning</h4>

<p>The goal is: Keep versioning as simple and linear as possible.</p>

<p>As mentioned previously, ES6 avoids versioning via “<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_one-javascript">One JavaScript</a>”: In an ES6 code base, everything is ES6, there are no parts that are ES5-specific.</p>

<h3 id="leanpub-auto-an-overview-of-es6-features">
<span class="section-number">1.6 </span>An overview of ES6 features</h3>

<p>Quoting the introduction of the ECMAScript 6 specification:</p>

<blockquote>
  <p>Some of [ECMAScript 6’s] major enhancements include modules, class declarations, lexical block scoping, iterators and generators, promises for asynchronous programming, destructuring patterns, and proper tail calls. The ECMAScript library of built-ins has been expanded to support additional data abstractions including maps, sets, and arrays of binary numeric values as well as additional support for Unicode supplemental characters in strings and regular expressions. The built-ins are now extensible via subclassing.</p>
</blockquote>

<p>There are three major groups of features:</p>

<ul>
<li>Better syntax for features that already exist (e.g. via libraries). For example:
    <ul>
<li><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_classes">Classes</a></li>
      <li><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_modules">Modules</a></li>
    </ul>
</li>
  <li>New functionality in the standard library. For example:
    <ul>
<li>New methods for <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_strings">strings</a> and <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_arrays">Arrays</a>
</li>
      <li><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_promises">Promises</a></li>
      <li><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_maps-sets">Maps, Sets</a></li>
    </ul>
</li>
  <li>Completely new features. For example:
    <ul>
<li><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators">Generators</a></li>
      <li><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_proxies">Proxies</a></li>
      <li><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_weakmap">WeakMaps</a></li>
    </ul>
</li>
</ul>
<h3 id="ecmascript-history">
<span class="section-number">1.7 </span>A brief history of ECMAScript</h3>

<p>This section describes what happened on the road to ECMAScript 6.</p>

<h4 id="leanpub-auto-the-early-years-ecmascript-13">
<span class="section-number">1.7.1 </span>The early years: ECMAScript 1–3</h4>

<ul>
<li>
<strong>ECMAScript 1 (June 1997)</strong> was the first version of the JavaScript language standard.</li>
  <li>
<strong>ECMAScript 2 (June 1998)</strong> contained minor changes, to keep the spec in sync with a separate ISO standard for JavaScript.</li>
  <li>
<strong>ECMAScript 3 (December 1999)</strong> introduced many features that have become popular parts of the language<sup id="fnref-introduction_2"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-introduction_2" rel="footnote">2</a></sup>:</li>
</ul>
<h4 id="leanpub-auto-ecmascript-4-abandoned-in-july-2008">
<span class="section-number">1.7.2 </span>ECMAScript 4 (abandoned in July 2008)</h4>

<p>Work on ES4 started after the release of ES3 in 1999. In 2003, an interim report was released after which work on ES4 paused. Subsets of the language described in the interim report were implemented by Adobe (in ActionScript) and by Microsoft (in JScript.NET).</p>

<p>In February 2005, Jesse James Garrett observed that new techniques had become popular for implementing dynamic frontend apps in JavaScript. <a href="http://www.adaptivepath.com/ideas/ajax-new-approach-web-applications/">He called those techniques Ajax</a>. Ajax enabled a completely new class of web apps and led to a surge of interest in JavaScript.</p>

<p>That may have contributed to TC39 resuming work on ES4 in fall 2005. They based ES4 on ES3, the interim ES4 report and experiences with ActionScript and JScript.NET.</p>

<p>There were now two groups working on future ECMAScript versions:</p>

<ul>
<li>ECMAScript 4 was designed by Adobe, Mozilla, Opera, and Google and was a massive upgrade. Its planned feature sets included:
    <ul>
<li>Programming in the large (classes, interfaces, namespaces, packages, program units, optional type annotations, and optional static type checking and verification)</li>
      <li>Evolutionary programming and scripting (structural types, duck typing, type definitions, and multimethods)</li>
      <li>Data structure construction (parameterized types, getters and setters, and meta-level methods)</li>
      <li>Control abstractions (proper tail calls, iterators, and generators)</li>
      <li>Introspection (type meta-objects and stack marks)</li>
    </ul>
</li>
  <li>ECMAScript 3.1 was designed by Microsoft and Yahoo. It was planned as a subset of ES4 and an incremental upgrade of ECMAScript 3, with bug fixes and minor new features. ECMAScript 3.1 eventually became ECMAScript 5.</li>
</ul>
<p>The two groups disagreed on the future of JavaScript and tensions between them continued to increase.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_external-link.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-sources-of-this-section">Sources of this section:</h3>

  <ul>
<li>“<a href="http://www.ecmascript.org/es4/spec/overview.pdf">Proposed ECMAScript 4th Edition – Language Overview</a>”. 2007-10-23</li>
    <li>“<a href="http://ejohn.org/blog/ecmascript-harmony/">ECMAScript Harmony</a>” by John Resig. 2008-08-13</li>
  </ul>
</td>
  </tr></tbody></table>
<h4 id="leanpub-auto-ecmascript-harmony">
<span class="section-number">1.7.3 </span>ECMAScript Harmony</h4>

<p>At the end of July 2008, there was a TC39 meeting in Oslo, whose outcome was <a href="https://mail.mozilla.org/pipermail/es-discuss/2008-August/006837.html">described</a> as follows by Brendan Eich:</p>

<blockquote>
  <p>It’s no secret that the JavaScript standards body, Ecma’s Technical Committee 39, has been split for over a year, with some members favoring ES4 […] and others advocating ES3.1 […]. Now, I’m happy to report, the split is over.</p>
</blockquote>

<p>The agreement that was worked out at the meeting consisted of four points:</p>

<ol class="numeric numeric">
<li>Develop an incremental update of ECMAScript (which became ECMAScript 5).</li>
  <li>Develop a major new release, which was to be more modest than ECMAScript 4, but much larger in scope than the version after ECMAScript 3. This version was code-named <em>Harmony</em>, due to the nature of the meeting in which it was conceived.</li>
  <li>Features from ECMAScript 4 that would be dropped: packages, namespaces, early binding.</li>
  <li>Other ideas were to be developed in consensus with all of TC39.</li>
</ol>
<p>Thus: The ES4 group agreed to make Harmony less radical than ES4, the rest of TC39 agreed to keep moving things forward.</p>

<p>The next versions of ECMAScript are:</p>

<ul>
<li>
<strong>ECMAScript 5 (December 2009).</strong> This is the version of ECMAScript that most browsers support today. It brings several enhancements to the standard library and updated language semantics via a <em>strict mode</em>.</li>
  <li>
<strong>ECMAScript 6 (June 2015).</strong> This version went through several name changes:
    <ul>
<li>ECMAScript Harmony: was the initial code name for JavaScript improvements after ECMAScript 5.</li>
      <li>ECMAScript.next: It became apparent that the plans for Harmony were too ambitious for a single version, so its features were split into two groups: The first group of features had highest priority and was to become the next version after ES5. The code name of that version was ECMAScript.next, to avoid prematurely comitting to a version number, which proved problematic with ES4. The second group of features had time until after ECMAScript.next.</li>
      <li>ECMAScript 6: As ECMAScript.next matured, its code name was dropped and everybody started to call it ECMAScript 6.</li>
      <li>ECMAScript 2015: In late 2014, TC39 decided to change the official name of ECMAScript 6 to ECMAScript 2015, in light of upcoming yearly spec releases. However, given how established the the name “ECMAScript 6” already is and how late TC39 changed their minds, I expect that that’s how everybody will continue to refer to that version.</li>
    </ul>
</li>
  <li>
<strong>ECMAScript 2016</strong> was previously called ECMAScript 7. Starting with ES2016, the language standard will see smaller yearly releases.</li>
</ul>
<div class="footnotes">
  <ol>
<li id="fn-introduction_1">This is not completely true: there are a few minor breaking changes that don’t affect code on the web. These are detailed in <a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-corrections-and-clarifications-with-possible-compatibility-impact">section D.1</a> and <a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-additions-and-changes-that-introduce-incompatibilities-with-prior-editions">section E.1</a> of the ES6 specification.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-introduction_1" rel="rev-footnote">↩</a>
</li>
    <li id="fn-introduction_2">Source: Introduction of ES6 spec.
      <blockquote>
        <p>[…] regular expressions, better string handling, new control statements, try/catch exception handling, tighter definition of errors, formatting for numeric output and other enhancements. [1]</p>
      </blockquote>
      <p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-introduction_2" rel="rev-footnote">↩</a></p>
    </li>
  </ol>
</div>


<h2 id="leanpub-auto-faq-ecmascript-6">
<span class="section-number">2. </span>FAQ: ECMAScript 6</h2>

<p>This chapter answers a few frequently asked questions about ECMAScript 6.</p>


<h3 id="leanpub-auto-how-much-of-es6-is-supported-natively-by-current-engines">
<span class="section-number">2.1 </span>How much of ES6 is supported natively by current engines?</h3>

<p>The best way to check how much of ES6 various engines support is <a href="http://kangax.github.io/compat-table/es6/">Kangax’ ES6 compatibility table</a>.</p>


<h3 id="leanpub-auto-how-do-i-migrate-my-ecmascript-5-code-to-ecmascript-6">
<span class="section-number">2.2 </span>How do I migrate my ECMAScript 5 code to ECMAScript 6?</h3>

<p>There is nothing to do: ECMAScript 6 is a superset of ECMAScript 5. Therefore, all of your ES5 code is automatically ES6 code. How exactly ES6 stays completely backwards compatible is explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_one-javascript">the chapter on “One JavaScript”</a>.</p>

<p>Consult the chapter “<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_deploying-es6">Deploying ECMAScript 6</a>” if you are wondering how you can use new ES6 features today (which is a different question).</p>


<h3 id="leanpub-auto-does-it-still-make-sense-to-learn-ecmascript-5">
<span class="section-number">2.3 </span>Does it still make sense to learn ECMAScript 5?</h3>

<p>As the chapter “<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_deploying-es6">Deploying ECMAScript 6</a>” demonstrates, you can already exclusively program in ES6 today, without ever having to write code in an older JavaScript version. Does that mean that you shouldn’t learn ECMAScript 5, anymore? It doesn’t, for several reasons:</p>

<ul>
<li>ECMAScript 6 is a superset of ECMAScript 5 – new JavaScript versions must never break existing code. Thus, nothing you learn about ECMAScript 5 is learned in vain.</li>
  <li>There are several ECMAScript 6 features that kind of replace ECMAScript 5 features, but still use them as their foundations. It is important to understand those foundations. Two examples: classes are internally translated to constructors and methods are still functions (as they have always been).</li>
  <li>As long as ECMAScript 6 is compiled to ECMAScript 5, it is useful to understand the output of the compilation process. And you’ll have to compile to ES5 for a while (probably years), until you can rely on ES6 being available in all relevant browsers.</li>
  <li>It’s important to be able to understand legacy code.</li>
</ul>
<h3 id="leanpub-auto-is-es6-bloated">
<span class="section-number">2.4 </span>Is ES6 bloated?</h3>

<p>I’ve seen people complain about ES6 making JavaScript bloated and introducing too much useless “syntactic sugar” (more convenient syntax for something that already exists).</p>

<p>If someone feels that way, I suggest that they use ES6 for a while. Nobody forces you to use any of the new features. You can start small (e.g. with <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_template-literals">template literals</a> and <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_arrow-functions">arrow functions</a>) and then use more new features, as you grow more comfortable with ES6. So far, the feedback I get from people who have actually used ES6 (as opposed to read about it) is overwhelmingly positive.</p>

<p>Furthermore, things that superficially look like syntactic sugar (such as classes and modules) bring much-needed standardization to the language and serve as foundations for future features.</p>

<p>Lastly, several features were not created for normal programmers, but for library authors (e.g. generators, iterators, proxies). “Normal programmers” only need to know them superficially if at all.</p>


<h3 id="leanpub-auto-isnt-the-es6-specification-very-big">
<span class="section-number">2.5 </span>Isn’t the ES6 specification very big?</h3>

<p>The ECMAScript specification has indeed grown tremendously: The ECMAScript 5.1 PDF had 245 pages, the ES6 PDF has 593 pages. But, for comparison, the Java 8 language specification has 724 pages (excluding an index). Furthermore, the ES6 specification contains details that many other language specifications omit as implementation-defined. It also specifies how its standard library works<sup id="fnref-faq_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-faq_1" rel="footnote">1</a></sup>.</p>


<h3 id="leanpub-auto-does-es6-have-array-comprehensions">
<span class="section-number">2.6 </span>Does ES6 have array comprehensions?</h3>

<p>Originally, ES6 was to have Array and Generator comprehensions (similarly to Haskell and Python). But they were postponed until after ES6, because TC39 wanted to explore two avenues:</p>

<ul>
<li>It may be possible to create comprehensions that work for arbitrary datatypes (think Microsoft’s LINQ).</li>
  <li>It may also be possible that methods for iterators are a better way to achieve what comprehensions do.</li>
</ul>
<h3 id="leanpub-auto-is-es6-statically-typed">
<span class="section-number">2.7 </span>Is ES6 statically typed?</h3>

<p>Static typing is not part of ES6. However, the following two technologies add static typing to JavaScript. Similar features may eventually be standardized.</p>

<ul>
<li>
<strong>Microsoft TypeScript:</strong> is basically ES6 plus optional type annotations. At the moment, it is compiled to ES5 and throws away the type information while doing so. Optionally, it can also make that information available at runtime, for type introspection and for runtime type checks.</li>
  <li>
<strong>Facebook Flow:</strong> is a type checker for ECMAScript 6 that is based on flow analysis. As such, it only adds optional type annotations to the language and infers and checks types. It does not help with compiling ES6 to ES5.</li>
</ul>
<p>Three benefits of static typing are:</p>

<ul>
<li>It allows you to detect a certain category of errors earlier, because the code is analyzed statically (during development, without running code). As such, static typing is complementary to testing and catches different errors.</li>
  <li>It helps IDEs with auto-completion.</li>
</ul>
<p>Both TypeScript and Flow are using the same notation. Type annotations are optional, which makes this approach relatively lightweight. Even without annotations, types can often be inferred. Therefore, this kind of type checking is even useful for completely unannotated code, as a consistency check.</p>


<h3 id="leanpub-auto-should-i-avoid-classes">
<span class="section-number">2.8 </span>Should I avoid classes?</h3>

<p>I recommend to use them. I explain their pros and cons in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_class-benefits">the chapter on classes</a>.</p>


<h3 id="leanpub-auto-does-es6-have-traits-or-mixins">
<span class="section-number">2.9 </span>Does ES6 have traits or mixins?</h3>

<p>No, but one of the goals for classes was for them to be a foundation on which traits (or a similar way of doing multiple inheritance) can be built.</p>

<p>The library <a href="http://soft.vub.ac.be/~tvcutsem/traitsjs/">traits.js</a> gives you a preview of what traits may look like. This being a library limits it syntactically; should traits ever become a language feature, they will have nicer syntax.</p>


<h3 id="leanpub-auto-why-are-there-fat-arrow-functions--in-es6-but-no-thin-arrow-functions--">
<span class="section-number">2.10 </span>Why are there “fat” arrow functions (<code>=&gt;</code>) in ES6, but no “thin” arrow functions (<code>-&gt;</code>)?</h3>

<p>ECMAScript 6 has syntax for functions with a lexical <code>this</code>, so-called <em>arrow functions</em>. However, it does not have arrow syntax for functions with dynamic <code>this</code>. That omission was deliberate; method definitions cover most of the use cases for thin arrows. If you really need dynamic <code>this</code>, you can still use a traditional function expression.</p>


<h3 id="leanpub-auto-where-can-i-find-more-es6-resources">
<span class="section-number">2.11 </span>Where can I find more ES6 resources?</h3>

<p>These are two lists with ES6 resources:</p>

<ul>
<li>“<a href="https://github.com/addyosmani/es6-tools">ECMAScript 6 Tools</a>” by Addy Osmani.</li>
  <li>“<a href="https://github.com/ericdouglas/ES6-Learning">ECMAScript 6 Learning!</a>” by Eric Douglas.</li>
</ul>
<div class="footnotes">
  <ol>
<li id="fn-faq_1">Source: Tweet by Allen Wirfs-Brock. https://twitter.com/awbjs/status/574649464687734785<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-faq_1" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h2 id="ch_one-javascript">
<span class="section-number">3. </span>One JavaScript: avoiding versioning in ECMAScript 6</h2>

<p>What is the best way to add new features to a language? This chapter describes the approach taken by ECMAScript 6. It is called <em>One JavaScript</em>, because it avoids versioning.</p>

<h3 id="leanpub-auto-versioning">
<span class="section-number">3.1 </span>Versioning</h3>

<p>In principle, a new version of a language is a chance to clean it up, by removing outdated features or by changing how features work. That means that new code doesn’t work in older implementations of the language and that old code doesn’t work in a new implementation. Each piece of code is linked to a specific version of the language. Two approaches are common for dealing with versions being different.</p>

<p>First, you can take an “all or nothing” approach and demand that, if a code base wants to use the new version, it must be upgraded completely. Python took that approach when upgrading from Python 2 to Python 3. A problem with it is that it may not be feasible to migrate all of an existing code base at once, especially if it is large. Furthermore, the approach is not an option for the web, where you’ll always have old code and where JavaScript engines are updated automatically.</p>

<p>Second, you can permit a code base to contain code in multiple versions, by tagging code with versions. On the web, you could tag ECMAScript 6 code via a dedicated <a href="http://en.wikipedia.org/wiki/Internet_media_type">Internet media type</a>. Such a media type can be associated with a file via an HTTP header:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Content</code><code class="o">-</code><code class="nx">Type</code><code class="o">:</code> <code class="nx">application</code><code class="o">/</code><code class="nx">ecmascript</code><code class="p">;</code><code class="nx">version</code><code class="o">=</code><code class="mi">6</code>
</pre></div>

</div>

<p>It can also be associated via the <code>type</code> attribute of the <code>&lt;script&gt;</code> element (whose <a href="http://www.w3.org/TR/html5/scripting-1.html#attr-script-type">default value</a> is <code>text/javascript</code>):</p>

<div class="code-block">
<div class="highlight"><pre><code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"application/ecmascript;version=6"</code><code class="nt">&gt;</code>
    <code class="err">···</code>
<code class="nt">&lt;/script&gt;</code>
</pre></div>

</div>

<p>This specifies the version <em>out of band</em>, externally to the actual content. Another option is to specify the version inside the content (<em>in-band</em>). For example, by starting a file with the following line:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">use</code> <code class="nx">version</code> <code class="mi">6</code><code class="p">;</code>
</pre></div>

</div>

<p>Both ways of tagging are problematic: out-of-band versions are brittle and can get lost, in-band versions add clutter to code.</p>

<p>A more fundamental issue is that allowing multiple versions per code base effectively forks a language into sub-languages that have to be maintained in parallel. This causes problems:</p>

<ul>
<li>Engines become bloated, because they need to implement the semantics of all versions. The same applies to tools analyzing the language (e.g. style checkers such es JSLint).</li>
  <li>Programmers need to remember how the versions differ.</li>
  <li>Code becomes harder to refactor, because you need to take versions into consideration when you move pieces of code.</li>
</ul>
<p>Therefore, versioning is something to avoid, especially for JavaScript and the web.</p>

<h4 id="leanpub-auto-evolution-without-versioning">
<span class="section-number">3.1.1 </span>Evolution without versioning</h4>

<p>But how can we get rid of versioning? By always being backwards-compatible. That means we must give up some of our ambitions w.r.t. cleaning up JavaScript: We can’t introduce breaking changes. Being backwards-compatible means not removing features and not changing features. The slogan for this principle is: “don’t break the web”.</p>

<p>We can, however, add new features and make existing features more powerful.</p>

<p>As a consequence, no versions are needed for new engines, because they can still run all old code. David Herman calls this approach to avoiding versioning <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#one-js_1"><em>One JavaScript</em> (1JS) [1]</a>, because it avoids splitting up JavaScript into different versions or modes. As we shall see later, 1JS even undoes some of a split that already exists, due to strict mode.</p>

<p>One JavaScript does not mean that you have to completely give up on cleaning up the language. Instead of cleaning up existing features, you introduce new, clean, features. One example for that is <code>let</code>, which declares block-scoped variables and is an improved version of <code>var</code>. It does not, however, replace <code>var</code>, it exists alongside it, as the superior option.</p>

<p>One day, it may even be possible to eliminate features that nobody uses, anymore. Some of the ES6 features were designed by surveying JavaScript code on the web. Two examples are:</p>

<ul>
<li>
<code>let</code>-declarations are difficult to add to non-strict mode, because <code>let</code> is not a reserved word in that mode. The only variant of <code>let</code> that looks like valid ES5 code is:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code><code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="nx">arr</code><code class="p">;</code>
</pre></div>
    
</div>

    <p>Research yielded that no code on the web uses a variable <code>let</code> in non-strict mode in this manner. That enabled TC39 to add <code>let</code> to non-strict mode. Details of how this was done are described <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_sloppy-let-declarations">later in this chapter</a>.</p>
  </li>
  <li>Function declarations do occasionally appear in non-strict blocks, which is why the ES6 specification describes measures that web browsers can take to ensure that such code doesn’t break. <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_sloppy-function-declarations">Details are explained later</a>.</li>
</ul>
<p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_using-es6-natively">The next chapter</a> describes the opposite of what we have just looked at: deploying ES6 code so that it runs both on engines that support ES6 and on engines that don’t.</p>

<h3 id="leanpub-auto-strict-mode-and-ecmascript-6">
<span class="section-number">3.2 </span>Strict mode and ECMAScript 6</h3>

<p><a href="http://speakingjs.com/es5/ch07.html#strict_mode">Strict mode</a> was introduced in ECMAScript 5 to clean up the language. It is switched on by putting the following line first in a file or in a function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="s1">'use strict'</code><code class="p">;</code>
</pre></div>

</div>

<p>Strict mode introduces three kinds of breaking changes:</p>

<ul>
<li>Syntactic changes: some previously legal syntax is forbidden in strict mode. For example:
    <ul>
<li>The <code>with</code> statement is forbidden. It lets users add arbitrary objects to the chain of variable scopes, which slows down execution and makes it tricky to figure out what a variable refers to.</li>
      <li>Deleting an unqualified identifier (a variable, not a property) is forbidden.</li>
      <li>Functions can only be declared at the top level of a scope.</li>
      <li>More identifiers are <a href="http://ecma-international.org/ecma-262/5.1/#sec-7.6.1.2">reserved</a>: <code>implements interface let package private protected public static yield</code>
</li>
    </ul>
</li>
  <li>More errors. For example:
    <ul>
<li>Assigning to an undeclared variable causes a <code>ReferenceError</code>. In non-strict mode, a global variable is created in this case.</li>
      <li>Changing read-only properties (such as the length of a string) causes a <code>TypeError</code>. In non-strict mode, it simply has no effect.</li>
    </ul>
</li>
  <li>Different semantics: Some constructs behave differently in strict mode. For example:
    <ul>
<li>
<code>arguments</code> doesn’t track the current values of parameters, anymore.</li>
      <li>
<code>this</code> is <code>undefined</code> in non-method functions. In non-strict mode, it refers to the global object (<code>window</code>), which meant that global variables were created if you called a constructor without <code>new</code>.</li>
    </ul>
</li>
</ul>
<p>Strict mode is a good example of why versioning is tricky: Even though it enables a cleaner version of JavaScript, its adoption is still relatively low. The main reasons are that it breaks some existing code, can slow down execution and is a hassle to add to files (let alone interactive command lines). I love <em>the idea</em> of strict mode and don’t nearly use it often enough.</p>

<h4 id="leanpub-auto-supporting-sloppy-non-strict-mode">
<span class="section-number">3.2.1 </span>Supporting sloppy (non-strict) mode</h4>

<p>One JavaScript means that we can’t give up on sloppy mode: it will continue to be around (e.g. in HTML attributes). Therefore, we can’t build ECMAScript 6 on top of strict mode, we must add its features to both strict mode and non-strict mode (a.k.a. sloppy mode). Otherwise, strict mode would be a different version of the language and we’d be back to versioning. Unfortunately, two ECMAScript 6 features are difficult to add to sloppy mode: <code>let</code> declarations and block-level function declarations. Let’s examine why that is and how to add them, anyway.</p>

<h4 id="sec_sloppy-let-declarations">
<span class="section-number">3.2.2 </span><code>let</code> declarations in sloppy mode</h4>

<p><code>let</code> enables you to declare block-scoped variables. It is difficult to add to sloppy mode, because <code>let</code> is only a reserved word in strict mode. That is, the following two statements are legal ES5 sloppy code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="kd">let</code> <code class="o">=</code> <code class="p">[];</code>
<code class="kd">let</code><code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">;</code>
</pre></div>

</div>

<p>In strict ECMAScript 6, you get an exception in line 1, because you are using the reserved word <code>let</code> as a variable name. And the statement in line 2 is interpreted as a <code>let</code> variable declaration (that uses destructuring).</p>

<p>In sloppy ECMAScript 6, the first line does not cause an exception, but the second line is still interpreted as a <code>let</code> declaration. This way of using the identifier <code>let</code> is so rare on the web that ES6 can afford to make this interpretation. Other ways of writing <code>let</code> declarations can’t be mistaken for sloppy ES5 syntax:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">foo</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
<code class="kd">let</code> <code class="p">{</code><code class="nx">x</code><code class="p">,</code><code class="nx">y</code><code class="p">}</code> <code class="o">=</code> <code class="nx">computeCoordinates</code><code class="p">();</code>
</pre></div>

</div>

<h4 id="sec_sloppy-function-declarations">
<span class="section-number">3.2.3 </span>Block-level function declarations in sloppy mode</h4>

<p>ECMAScript 5 strict mode forbids function declarations in blocks. The specification allowed them in sloppy mode, but didn’t specify how they should behave. Hence, various implementations of JavaScript support them, but handle them differently.</p>

<p>ECMAScript 6 wants a function declaration in a block to be local to that block. That is OK as an extension of ES5 strict mode, but breaks some sloppy code. Therefore, ES6 provides “<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-block-level-function-declarations-web-legacy-compatibility-semantics">web legacy compatibility semantics</a>” for browsers that lets function declarations in blocks exist at function scope.</p>

<h4 id="leanpub-auto-other-keywords">
<span class="section-number">3.2.4 </span>Other keywords</h4>

<p>The identifiers <code>yield</code> and <code>static</code> are only reserved in ES5 strict mode. ECMAScript 6 uses context-specific syntax rules to make them work in sloppy mode:</p>

<ul>
<li>In sloppy mode, <code>yield</code> is only a reserved word inside a generator function.</li>
  <li>
<code>static</code> is currently only used inside class literals, which are implicitly strict (see below).</li>
</ul>
<h4 id="leanpub-auto-implicit-strict-mode">
<span class="section-number">3.2.5 </span>Implicit strict mode</h4>

<p>The bodies of modules and classes are implicitly in strict mode in ECMAScript 6 – there is no need for the <code>'use strict'</code> marker. Given that virtually all of our code will live in modules in the future, ECMAScript 6 effectively upgrades the whole language to strict mode.</p>

<p>The bodies of other constructs (such as arrow functions and generator functions) could have been made implicitly strict, too. But given how small these constructs usually are, using them in sloppy mode would have resulted in code that is fragmented between the two modes. Classes and especially modules are large enough to make fragmentation less of an issue.</p>

<h4 id="leanpub-auto-things-that-cant-be-fixed">
<span class="section-number">3.2.6 </span>Things that can’t be fixed</h4>

<p>The downside of One JavaScript is that you can’t fix existing quirks, especially the following two.</p>

<p>First, <code>typeof null</code> should return the string <code>'null'</code> and not <code>'object'</code>. But fixing that would break existing code. On the other hand, adding new results for new kinds of operands is OK, because current JavaScript engines already occasionally return custom values for host objects. One example are ECMAScript 6’s symbols:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">typeof</code> <code class="n">Symbol</code><code class="p">.</code><code class="n">iterator</code>
<code class="err">'</code><code class="n">symbol</code><code class="err">'</code>
</pre></div>

</div>

<p>Second, the global object (<code>window</code> in browsers) shouldn’t be in the scope chain of variables. But it is also much too late to change that now. At least, one won’t be in global scope in modules and <code>let</code> never creates properties of the global object, not even when used in global scope.</p>

<h3 id="leanpub-auto-conclusion">
<span class="section-number">3.3 </span>Conclusion</h3>

<p>One JavaScript means making ECMAScript 6 completely backwards compatible. It is great that that succeeded. Especially appreciated is that modules (and thus most of our code) are implicitly in strict mode.</p>

<p>In the short term, adding ES6 constructs to both strict mode and sloppy mode is more work when it comes to writing the language specification and to implementing it in engines. In the long term, both the spec and engines profit from the language not being forked (less bloat etc.). Programmers profit immediately from One JavaScript, because it makes it easier to get started with ECMAScript 6.</p>

<h3 id="leanpub-auto-further-reading">
<span class="section-number">3.4 </span>Further reading</h3>

<p id="one-js_1">[1] The original 1JS proposal (warning: out of date): “<a href="http://esdiscuss.org/topic/es6-doesn-t-need-opt-in">ES6 doesn’t need opt-in</a>” by David Herman.</p>

<h2 id="ch_deploying-es6">
<span class="section-number">4. </span>Deploying ECMAScript 6</h2>

<p>This chapter describes the options you have for deploying ECMAScript 6 in current JavaScript environments. It is selective w.r.t. the amount of tools it covers. If you want a comprehensive list of tools, I suggest you look at Addy Osmani’s “<a href="https://github.com/addyosmani/es6-tools">ECMAScript 6 Tools</a>”.</p>


<h3 id="leanpub-auto-using-ecmascript-6-today">
<span class="section-number">4.1 </span>Using ECMAScript 6 today</h3>

<p>What options do you have for using ECMAScript 6 today?</p>

<p>ECMAScript 6 features are continually appearing in engines. You can look up which ones are already supported where in Kangax’ “<a href="http://kangax.github.io/compat-table/es6/">ECMAScript 6 compatibility table</a>”. I’d expect first JavaScript engines to fully support ES6 in late 2015 or early 2016. It will take longer until all current engines do so.</p>

<p>Especially if you take support for legacy engines into consideration, compiling ES6 to ES5 will be the only viable option for using ES6 for quite a while. Compiling from source code to source code is also called <em>transpiling</em>. You can transpile ES6 either before deployment (statically) or at runtime (dynamically). The next section explains how that works, later sections describe other ES6 tools and libraries.</p>

<p>The nice thing about ES6 is that it is a superset of ES5, which means that all of your ES5 code bases are already valid ES6. This helps tremendously with adopting ES6-specific features, because you can do so incrementally.</p>

<h4 id="sec_using-es6-natively">
<span class="section-number">4.1.1 </span>Using ECMAScript 6 natively</h4>

<p>As soon as the first engine fully supports ES6 and until all non-ES6 engines go away, a hybrid approach could be used for client-side apps:</p>

<ul>
<li>The server has two versions of each file: the native ES6 version and its transpilation, an ES5 version.</li>
  <li>When the web app starts, feature detection is used to check whether ES6 is fully supported. If it is, the ES6 version of the app is used. Otherwise, the ES5 version is used.</li>
</ul>
<p>Detecting ECMAScript versions is difficult, because many engines support parts of versions before they support them completely. For example, this is how you’d check whether an engine supports ECMAScript 6’s <code>for-of</code> loop – but that may well be the only ES6 feature it supports:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">isForOfSupported</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="nb">eval</code><code class="p">(</code><code class="s2">"for (var e of ['a']) {}"</code><code class="p">);</code>
        <code class="k">return</code> <code class="kc">true</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// Possibly: check if e instanceof SyntaxError</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Kyle Simpson’s library <a href="https://github.com/getify/es-feature-tests">ES Feature Tests</a> lets you detect whether an engine supports ES6:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">ReflectSupports</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s2">"es-feature-tests"</code><code class="p">);</code>

<code class="nx">ReflectSupports</code><code class="p">(</code><code class="s2">"all"</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">results</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">results</code><code class="p">.</code><code class="nx">letConst</code> <code class="o">&amp;&amp;</code> <code class="nx">results</code><code class="p">.</code><code class="nx">arrow</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// Use ES6 natively</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
        <code class="c1">// Use transpiled ES6</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>npm may eventually support two versions of the same module, which would enable you to deliver libraries as both ES5 and ES6 for Node.js, io.js and client-side module systems that are based on npm.</p>


<h3 id="leanpub-auto-transpilation-tools">
<span class="section-number">4.2 </span>Transpilation tools</h3>

<p>There are three essential choices that you have to make for transpilation:</p>

<ul>
<li>A transpiler (for your code)</li>
  <li>A package manager (to install existing libraries)</li>
  <li>A module system (for the complete app)</li>
</ul>
<p>Note that the choices are not completely independent, not every module system works with every package manager etc. The next sections explain each of these choices in more detail.</p>

<h4 id="leanpub-auto-choosing-a-transpiler">
<span class="section-number">4.2.1 </span>Choosing a transpiler</h4>

<p>A transpiler compiles your ES6 code to ES5. Popular choices are:</p>

<ul>
<li>
<a href="http://www.typescriptlang.org/">TypeScript</a>: Is basically ECMAScript 6 plus optional type annotations.</li>
  <li>
<a href="https://github.com/google/traceur-compiler">Traceur</a>: is an ES6 transpiler by Google, the first popular one. Pronounced French, /tʁa.sœʁ/; an English approximation is “truh-SIR” (<a href="https://github.com/google/traceur-compiler/issues/1875">source</a>, <a href="http://www.forvo.com/word/traceur/">listen to native French speakers pronounce this word</a>).</li>
  <li>
<a href="https://babeljs.io/">Babel</a>: is a newer ES6 transpiler that whose popularity has grown tremendously recently. Babel supports React’s JSX syntax in addition to ES6. Pronounced “babble”.</li>
</ul>
<p>You can transpile the code either:</p>

<ul>
<li>Statically (before deployment)</li>
  <li>Dynamically (at runtime)</li>
</ul>
<h5 id="leanpub-auto-static-transpilation">
<span class="section-number">4.2.1.1 </span>Static transpilation</h5>

<p>As a build step, TypeScript, Traceur and Babel let you produce ES5 code in the following module formats. You can either invoke them directly or use a build tool (grunt, gulp, broccoli, etc.).</p>

<ul>
<li>AMD</li>
  <li>CommonJS</li>
  <li>ES6 module loader API: The ES6 code is transpiled to ES5 code that uses this API via <a href="https://github.com/ModuleLoader/es6-module-loader">a polyfill</a>. This format is not supported by TypeScript.</li>
</ul>
<p>In browsers, such ES5 modules are loaded via one of the module systems described later.
On Node.js, you can use the built-in module system (other options exist, e.g. webpack and the ES6 Module Loader Polyfill).</p>

<h5 id="leanpub-auto-dynamic-transpilation">
<span class="section-number">4.2.1.2 </span>Dynamic transpilation</h5>

<p>In browsers, you transpile dynamically via a library plus a custom <code>&lt;script type="..."&gt;</code>. This option exists for <a href="https://github.com/google/traceur-compiler/wiki/Getting-Started">Traceur</a> and <a href="https://babeljs.io/docs/usage/browser/">Babel</a>.</p>

<p>For Node.js, Babel has tools for on-the-fly compilation. These are described in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_dynamic-transpilation-nodejs-babel">another section</a>.</p>

<h4 id="leanpub-auto-choosing-a-package-manager">
<span class="section-number">4.2.2 </span>Choosing a package manager</h4>

<p>You need a package manager for installing third-party libraries. These are three popular ones:</p>

<ul>
<li>
<a href="https://www.npmjs.com/">npm</a> (CommonJS modules): is a package manager that was originally created for Node.js, but has grown in popularity for client-side development thanks to module packaging and loading tools such as browserify and webpack.</li>
  <li>
<a href="http://bower.io/">Bower</a> (CommonJS or AMD modules): is a package manager for client-side code.</li>
  <li>
<a href="http://jspm.io/">jspm</a>: is a package manager for SystemJS (see next bullet list). It can install modules from a variety of sources, including GitHub and npm. One key feature of jspm is that external modules can also be written in ES6 (and will be transpiled), not just your own modules.</li>
</ul>
<h4 id="leanpub-auto-choosing-a-module-system">
<span class="section-number">4.2.3 </span>Choosing a module system</h4>

<p>Module systems bring support for modules to ES5 browsers (Node.js has a built-in module system). That way, you can build your app out of modules – your own and library modules. Popular module systems are:</p>

<ul>
<li>
<a href="http://requirejs.org/">RequireJS</a>: is a loader for AMD modules, which can be statically created via TypeScript, Traceur or Babel. <em>Loader plugins</em> (based on Traceur and Babel) enable it to load ES6 modules.</li>
  <li>
<a href="http://browserify.org/">Browserify</a>: packages CommonJS modules (including ones installed via npm) so that they can be loaded in browsers. Supports ES6 modules via <em>transforms</em> (plugins) based on Traceur and Babel.</li>
  <li>
<a href="http://webpack.github.io/">webpack</a>: a packager and loader for either CommonJS modules (including ones installed via npm) or AMD modules (including ones installed via Bower). Supports ES6 modules via <em>custom loaders</em> (plugins) based on Traceur and Babel.</li>
  <li>
<a href="https://github.com/systemjs/systemjs">SystemJS</a>: A module system based on the ES6 Module Loader Polyfill that supports ES6 modules and the ES5 module formats CommonJS, AMD and “ES6 module loader API”.</li>
</ul>
<h3 id="sec_es6-tools-libraries">
<span class="section-number">4.3 </span>Other useful ES6 tools and libraries</h3>

<ul>
<li>Test tools (such as Jasmine and mocha) can mostly be used as is, because they work with the transpiled code and don’t have to understand the original ES6 code. <a href="https://babeljs.io/docs/using-babel/#misc">Babel’s documention</a> has information on how to use it with various test tools.</li>
  <li>The following linters all support ES6, but to varying degrees:
    <ul>
<li>
<a href="http://www.jslint.com/">JSLint</a> (focus: enforcing coding practices)</li>
      <li>
<a href="http://jshint.com/">JSHint</a> (focus: enforcing coding practices)</li>
      <li>
<a href="http://eslint.org/">ESLint</a> (focus: letting people implement their own style rules)</li>
      <li>
<a href="http://jscs.info/">JSCS</a> (focus: enforcing code style)</li>
    </ul>
</li>
  <li>Shims/polyfills enable you to use much of the ECMAScript 6 standard library in ES5 code:
    <ul>
<li><a href="https://github.com/paulmillr/es6-shim/">es6-shim</a></li>
      <li>
<a href="https://github.com/zloirock/core-js">Core.js</a> (used by Babel)</li>
    </ul>
</li>
  <li>ES6 parsers:
    <ul>
<li><a href="http://esprima.org/">Esprima</a></li>
      <li><a href="https://github.com/marijnh/acorn">Acorn</a></li>
    </ul>
</li>
</ul>
<h3 id="leanpub-auto-es6-repls">
<span class="section-number">4.4 </span>ES6 REPLs</h3>

<p>There are many REPLs (command lines) out there for interactively playing with ES6. The obvious choices are the interactive online playgrounds of the following projects:</p>

<ul>
<li><a href="http://www.typescriptlang.org/Playground">TypeScript Playground</a></li>
  <li><a href="https://babeljs.io/repl/">Babel REPL</a></li>
  <li><a href="http://google.github.io/traceur-compiler/demo/repl.html">Traceur Transcoding Demo</a></li>
</ul>
<p>Additionally, Babel brings ES6 support to the Node.js REPL via its <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_babel-node"><code>babel-node</code> tool</a>.</p>


<h3 id="leanpub-auto-are-there-es6-features-that-cant-be-transpiled-to-es5">
<span class="section-number">4.5 </span>Are there ES6 features that can’t be transpiled to ES5?</h3>

<p>Some ECMAScript 6 features cannot be transpiled (compiled) to ES5. ES6 has three kinds of features:</p>

<ul>
<li>Better syntax for existing features</li>
  <li>New functionality in the standard library</li>
  <li>Completely new features</li>
</ul>
<p>The next sections explain for each kind of feature how difficult it is to transpile to ES5.</p>

<h4 id="leanpub-auto-better-syntax-for-existing-features">
<span class="section-number">4.5.1 </span>Better syntax for existing features</h4>

<p>ES6 provides better syntax for features that are already available via libraries. Two examples:</p>

<ul>
<li>Classes</li>
  <li>Modules</li>
</ul>
<p>Both can be relatively easily compiled to ES5. For example, this is an ES6 class:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="err">`</code><code class="p">(</code><code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">x</code><code class="p">},</code> <code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">y</code><code class="p">})</code><code class="err">`</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In <em>loose mode</em>, Babel produces nicer ES5 code, at the cost of not being completely faithful to ES6 semantics. This is the previous code, transpiled in loose mode:</p>

<div class="code-block">
<div class="highlight"><pre><code class="s2">"use strict"</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">_classCallCheck</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">instance</code><code class="p">,</code> <code class="nx">Constructor</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="p">(</code><code class="nx">instance</code> <code class="k">instanceof</code> <code class="nx">Constructor</code><code class="p">))</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">(</code><code class="s2">"Cannot call a class as a function"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">};</code>

<code class="kd">var</code> <code class="nx">Point</code> <code class="o">=</code> <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">function</code> <code class="nx">Point</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">_classCallCheck</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">Point</code><code class="p">);</code>

        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">Point</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">toString</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s2">"("</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">+</code> <code class="s2">", "</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">+</code> <code class="s2">")"</code><code class="p">;</code>
    <code class="p">};</code>

    <code class="k">return</code> <code class="nx">Point</code><code class="p">;</code>
<code class="p">})();</code>
</pre></div>

</div>

<h4 id="leanpub-auto-new-functionality-in-the-standard-library">
<span class="section-number">4.5.2 </span>New functionality in the standard library</h4>

<p>ES6 has a more comprehensive standard library than ES5. Additions include:</p>

<ul>
<li>New methods for strings, arrays</li>
  <li>Promises</li>
  <li>Maps, Sets</li>
</ul>
<p>These can be provided via a library. Much of that functionality (such as <code>String.prototype.repeat()</code>) is even useful for ES5. <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_es6-tools-libraries">A later section</a> lists a few such libraries.</p>

<h4 id="leanpub-auto-completely-new-features">
<span class="section-number">4.5.3 </span>Completely new features</h4>

<p>Some ES6 features are completely new and unrelated to existing features. Such features can never be transpiled completely faithfully. But some of them have reasonable simulations, for example:</p>

<ul>
<li>
<code>let</code> and <code>const</code>: are transpiled to <code>var</code> plus renaming of identifiers to avoid name clashes where necessary. That produces fast code and should work well in practice, but you don’t get the immutable bindings that <code>const</code> creates in native ES6.</li>
  <li>Symbols: transpiled to objects with unique IDs. They can be used as property keys, because the bracket operator coerces them to strings. Additionally, some property-enumerating functions (such as <code>Object.keys()</code>) have to be patched to ignore property keys coming from symbols.</li>
  <li>Generators: are compiled to state machines, which is a complex transformation, but works remarkably well. For example, this generator function:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">function</code><code class="o">*</code> <code class="nx">gen</code><code class="p">()</code> <code class="p">{</code>
      <code class="k">for</code><code class="p">(</code><code class="kd">let</code> <code class="nx">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">3</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">yield</code> <code class="nx">i</code><code class="p">;</code>
      <code class="p">}</code>
  <code class="p">}</code>
</pre></div>
    
</div>

    <p>is translated to the following ES5 code:</p>

    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">var</code> <code class="nx">marked0$0</code> <code class="o">=</code> <code class="p">[</code><code class="nx">gen</code><code class="p">].</code><code class="nx">map</code><code class="p">(</code><code class="nx">regeneratorRuntime</code><code class="p">.</code><code class="nx">mark</code><code class="p">);</code>
  <code class="kd">function</code> <code class="nx">gen</code><code class="p">()</code> <code class="p">{</code>
      <code class="kd">var</code> <code class="nx">i</code><code class="p">;</code>
      <code class="k">return</code> <code class="nx">regeneratorRuntime</code><code class="p">.</code><code class="nx">wrap</code><code class="p">(</code><code class="kd">function</code> <code class="nx">gen$</code><code class="p">(</code><code class="nx">context$1$0</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">while</code> <code class="p">(</code><code class="mi">1</code><code class="p">)</code> <code class="k">switch</code> <code class="p">(</code><code class="nx">context$1$0</code><code class="p">.</code><code class="nx">prev</code> <code class="o">=</code> <code class="nx">context$1$0</code><code class="p">.</code><code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
              <code class="k">case</code> <code class="mi">0</code><code class="o">:</code>
                  <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

              <code class="k">case</code> <code class="mi">1</code><code class="o">:</code>
                  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="p">(</code><code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">3</code><code class="p">))</code> <code class="p">{</code>
                      <code class="nx">context$1$0</code><code class="p">.</code><code class="nx">next</code> <code class="o">=</code> <code class="mi">7</code><code class="p">;</code>
                      <code class="k">break</code><code class="p">;</code>
                  <code class="p">}</code>

                  <code class="nx">context$1$0</code><code class="p">.</code><code class="nx">next</code> <code class="o">=</code> <code class="mi">4</code><code class="p">;</code>
                  <code class="k">return</code> <code class="nx">i</code><code class="p">;</code>

              <code class="k">case</code> <code class="mi">4</code><code class="o">:</code>
                  <code class="nx">i</code><code class="o">++</code><code class="p">;</code>
                  <code class="nx">context$1$0</code><code class="p">.</code><code class="nx">next</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
                  <code class="k">break</code><code class="p">;</code>

              <code class="k">case</code> <code class="mi">7</code><code class="o">:</code>
              <code class="k">case</code> <code class="s2">"end"</code><code class="o">:</code>
                  <code class="k">return</code> <code class="nx">context$1$0</code><code class="p">.</code><code class="nx">stop</code><code class="p">();</code>
          <code class="p">}</code>
      <code class="p">},</code> <code class="nx">marked0$0</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code> <code class="k">this</code><code class="p">);</code>
  <code class="p">}</code>
</pre></div>
    
</div>

    <p>You can see the state machine in the code, the next state is stored in <code>context$1$0.next</code>.</p>

    <p>Check out <a href="https://github.com/facebook/regenerator">Facebook’s regenerator library</a> for more information.</p>
  </li>
  <li>WeakMaps: map keys to values without pointing to the keys in a manner that prevents them from being garbage-collected. An ES5 simulation of a WeakMap is an object that contains a unique ID (a string such as <code>'weakmap_072c-4328-af75'</code>), but is otherwise empty. Each of its key-value entries is managed by storing the value in the key, via a property whose name is the WeakMap ID. That is quite a hack: memory is wasted and keys must be mutable. But one important feature of native WeakMaps is preserved: keys can be garbage-collected. The simulation works because all of the WeakMap operations (<code>get</code>, <code>set</code>, <code>has</code>, <code>delete</code>) require a key. There is no way to clear them or to enumerate their entries, keys or values.</li>
</ul>
<p>Other features are impossible to transpile (in a straightforward and general manner):</p>

<ul>
<li>Proxies: intercepting proxy operations is only possible if you make all operations on objects interceptible. And that would cause a tremendous performance penality.</li>
  <li>Subclassable built-in constructors (e.g. <code>Error</code> and <code>Array</code>)</li>
  <li>Tail call optimization (see <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_tail-calls">dedicated chapter</a>): implementing tail call optimization universally in ES5 would require a radical transformation of the ES6 code (e.g. <a href="http://raganwald.com/2013/03/28/trampolines-in-javascript.html">tramplining</a>). The resulting code would be quite slow.</li>
</ul>
<h3 id="leanpub-auto-example-transpilation-setups">
<span class="section-number">4.6 </span>Example transpilation setups</h3>

<p>The following sections describe three example setups:</p>

<ul>
<li>
<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_transpilation-webpack-babel">Client-side ES6 via webpack and Babel</a> (browsers, webpack, static transpilation)</li>
  <li>
<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_dynamic-transpilation-nodejs-babel">Dynamically transpiled ES6 on Node.js via Babel</a> (Node.js, Babel, dynamic transpilation)</li>
  <li>
<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_static-transpilation-nodejs-babel">Statically transpiled ES6 on Node.js via Babel and gulp</a> (Node.js, Babel, gulp, static transpilation)</li>
</ul>
<h3 id="sec_transpilation-webpack-babel">
<span class="section-number">4.7 </span>Example setup: Client-side ES6 via webpack and Babel</h3>

<p><a href="http://webpack.github.io/">webpack</a> is a client-side module builder and module loader. This section shows you how to write ECMAScript 6 code with it.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>The code shown here is on GitHub, in the project <a href="https://github.com/rauschma/webpack-es6-demo"><code>webpack-es6-demo</code></a>.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-webpack-features">
<span class="section-number">4.7.1 </span>webpack features</h4>

<p>Notable webpack features include:</p>

<ul>
<li>Supported module formats: AMD, CommonJS
    <ul>
<li>Via <em>loader</em> (plug-in): ES6</li>
    </ul>
</li>
  <li>Supported package managers: Bower, npm</li>
  <li>Loaders for non-code: CSS, templates, …</li>
  <li>On-demand loading (chunked transfer)</li>
  <li>Built-in development server</li>
</ul>
<h4 id="leanpub-auto-installing-webpack">
<span class="section-number">4.7.2 </span>Installing webpack</h4>

<p>Install webpack:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">npm</code> <code class="nx">install</code> <code class="o">-</code><code class="nx">g</code> <code class="nx">webpack</code>
</pre></div>

</div>

<p>Enable support for ECMAScript 6 (via <a href="https://babeljs.io/">Babel</a>): Pick one of the following three options.</p>

<ul>
<li>Per project: <code>npm install babel-loader --save-dev</code>
</li>
  <li>In your home directory: <code>cd $HOME ; npm install babel-loader</code>
</li>
  <li>Globally: <code>npm install -g babel-loader</code>
</li>
</ul>
<h4 id="leanpub-auto-using-webpack-and-es6-in-a-project">
<span class="section-number">4.7.3 </span>Using webpack and ES6 in a project</h4>

<p>The demo project has the following structure:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">webpack</code><code class="o">-</code><code class="nx">es6</code><code class="o">-</code><code class="nx">demo</code><code class="o">/</code>
    <code class="nx">es6</code><code class="o">/</code>
        <code class="nx">Point</code><code class="p">.</code><code class="nx">js</code>
        <code class="nx">main</code><code class="p">.</code><code class="nx">js</code>
    <code class="nx">index</code><code class="p">.</code><code class="nx">html</code>
    <code class="nx">webpack</code><code class="p">.</code><code class="nx">config</code><code class="p">.</code><code class="nx">js</code>
</pre></div>

</div>

<p>The directory <code>es6/</code> contains the ES6 code that webpack will transpile to ES5, <code>index.html</code> is the entry page of the web app and <code>webpack.config.js</code> is the configuration file for webpack. The content of the files is shown later.</p>

<p>The following command continuously watches the JavaScript files in the directory <code>es6/</code>. Whenever one of them changes (or when the command is first executed), they are compiled to a single file <code>bundle.js</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">webpack</code> <code class="o">--</code><code class="nx">watch</code>
</pre></div>

</div>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <p>In real-world projects, you probably won’t use webpack directly, but via build tools such as grunt and gulp.</p>

    </td>
  </tr></tbody></table>
<p>After executing the previous command, you can open <code>index.html</code> in a web browser (directly from the file system if you’d like). <code>index.html</code> loads <code>bundle.js</code>, which means that you get to see what <code>main.js</code> is doing:</p>

<div class="code-block">
<div class="highlight"><pre><code class="cp">&lt;!doctype html&gt;</code>
<code class="nt">&lt;html&gt;</code>
<code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"UTF-8"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;title&gt;</code>webpack ES6 demo<code class="nt">&lt;/title&gt;</code>
<code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;body&gt;</code>
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"bundle.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code>
</pre></div>

</div>

<h5 id="leanpub-auto-webpackconfigjs">
<span class="section-number">4.7.3.1 </span>webpack.config.js</h5>

<p>This is the configuration file for webpack:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// This module helps us with the configuration data</code>
<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'path'</code><code class="p">);</code>

<code class="c1">// Configuration data</code>
<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">entry</code><code class="o">:</code> <code class="s1">'./es6/main.js'</code><code class="p">,</code>
    <code class="nx">output</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">path</code><code class="o">:</code> <code class="nx">__dirname</code><code class="p">,</code>
        <code class="nx">filename</code><code class="o">:</code> <code class="s1">'bundle.js'</code>
    <code class="p">},</code>
    <code class="nx">module</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">loaders</code><code class="o">:</code> <code class="p">[</code>
            <code class="p">{</code> <code class="nx">test</code><code class="o">:</code> <code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'es6'</code><code class="p">),</code>
              <code class="nx">loader</code><code class="o">:</code> <code class="s1">'babel-loader'</code> <code class="p">}</code>
        <code class="p">]</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>The file is a module that exports an object with the configuration data. It uses the Node.js variable <code>__dirname</code> that contains the path of the parent directory of the currently executed module. The configuration data has the following properties:</p>

<ul>
<li>
<code>entry</code>: This is where the execution of JavaScript code starts. webpack starts compiling here and continues by compiling its dependencies (imported modules), then the dependencies of the dependencies, etc.</li>
  <li>
<code>output</code>: webpack bundles the entry file and everything it depends on into the output file <code>bundle.js</code>. I am using the Node.js variable <code>__dirname</code> to specify where <code>bundle.js</code> should be put (in the same directory as <code>webpack.config.js</code>).</li>
  <li>
<code>module.loaders</code>: Support for ES6 is enabled via a the module loader <code>babel-loader</code>.
    <ul>
<li>Property <code>test</code> specifies what files the loader should transpile. You can specify a single test or multiple tests:
        <ul>
<li>Single test: match an absolute path via a regular expression or a string</li>
          <li>Multiple tests: array of single tests (logical “and”)</li>
        </ul>
</li>
    </ul>
</li>
</ul>
<h5 id="leanpub-auto-ecmascript-6-code">
<span class="section-number">4.7.3.2 </span>ECMAScript 6 code</h5>

<p>The following two ECMAScript 6 files were packaged into <code>bundle.js</code>.</p>

<p><code>main.js</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="nx">Point</code> <code class="nx">from</code> <code class="s1">'./Point.js'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">body</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'body'</code><code class="p">);</code>
<code class="nx">body</code><code class="p">.</code><code class="nx">textContent</code> <code class="o">=</code> <code class="s1">'Good point: '</code> <code class="o">+</code> <code class="k">new</code> <code class="nx">Point</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">23</code><code class="p">);</code>
</pre></div>

</div>

<p><code>Point.js</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'('</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">x</code><code class="o">+</code><code class="s1">','</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">y</code><code class="o">+</code><code class="s1">')'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="kr">export</code> <code class="k">default</code> <code class="nx">Point</code><code class="p">;</code>
</pre></div>

</div>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <p>The paths used to import modules follow Node.js conventions.</p>

    </td>
  </tr></tbody></table>
<h5 id="leanpub-auto-using-npm-packages">
<span class="section-number">4.7.3.3 </span>Using npm packages</h5>

<p>You can install packages via npm and use them from your ES6 code, seamlessly. For example: First install <a href="https://lodash.com/">lodash</a>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">$</code> <code class="nx">mkdir</code> <code class="nx">node_modules</code>
<code class="nx">$</code> <code class="nx">npm</code> <code class="nx">install</code> <code class="nx">lodash</code>
</pre></div>

</div>

<p>Then use it anywhere in your ES6 code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="p">{</code> <code class="nx">zip</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'lodash'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">zip</code><code class="p">([</code><code class="s1">'1'</code><code class="p">,</code> <code class="s1">'2'</code><code class="p">],</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">]));</code>
</pre></div>

</div>


<h3 id="sec_dynamic-transpilation-nodejs-babel">
<span class="section-number">4.8 </span>Example setup: Dynamically transpiled ES6 on Node.js via Babel</h3>

<p>This section explains how to use <a href="https://babeljs.io/">the ES6 transpiler Babel</a> with Node.js.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>You can <a href="https://github.com/rauschma/babel-on-node">download the code shown in this section</a> on GitHub.</p>

    </td>
  </tr></tbody></table>
<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-alternative-static-transpilation">Alternative: static transpilation</h3>

  <p>The approach explained in this section is convenient for experiments and development. But it uses on-the-fly transpilation, which means that startup is slower and that Babel needs to be installed on the production system. If you want to avoid those costs, you can transpile statically, as described in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_static-transpilation-nodejs-babel">the next section</a>. For libraries, you often don’t have a choice and have to statically transpile them to ES5, because you should not force your clients to transpile dynamically.</p>

    </td>
  </tr></tbody></table>
<h4 id="sec_babel-node">
<span class="section-number">4.8.1 </span>Running normal Node.js code via Babel</h4>

<p>The npm package <code>babel</code> brings Babel support to Node.js:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">$</code> <code class="nx">npm</code> <code class="nx">install</code> <code class="o">--</code><code class="nx">global</code> <code class="nx">babel</code>
</pre></div>

</div>

<p>This package contains the shell script <code>babel-node</code>, which is a Babel-ified version of <code>node</code>. It compiles everything from ES6 to ES5 that is run or required.</p>

<h5 id="leanpub-auto-getting-an-es6-repl-via-babel-node">
<span class="section-number">4.8.1.1 </span>Getting an ES6 REPL via <code>babel-node</code>
</h5>

<p>For example, you can start a REPL via the following shell command:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">$</code> <code class="nx">babel</code><code class="o">-</code><code class="nx">node</code>
</pre></div>

</div>

<p>In the REPL, you can use ES6:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">].</code><code class="n">map</code><code class="p">(</code><code class="n">x</code> <code class="o">=&gt;</code> <code class="n">x</code> <code class="o">*</code> <code class="n">x</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">9</code> <code class="p">]</code>
</pre></div>

</div>

<h5 id="leanpub-auto-running-es6-scripts-via-babel-node">
<span class="section-number">4.8.1.2 </span>Running ES6 scripts via <code>babel-node</code>
</h5>

<p><code>babel-node</code> also lets you run Node.js scripts such as the following one.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// point.js</code>
<code class="kr">export</code> <code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">require</code><code class="p">.</code><code class="nx">main</code> <code class="o">===</code> <code class="nx">module</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">pt</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Point</code><code class="p">(</code><code class="mi">7</code><code class="p">,</code><code class="mi">4</code><code class="p">);</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">My</code> <code class="nx">point</code><code class="o">:</code> <code class="nx">$</code><code class="p">{</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">pt</code><code class="p">)}</code><code class="err">`</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The following shell command runs <code>point.js</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">$</code> <code class="nx">babel</code><code class="o">-</code><code class="nx">node</code> <code class="nx">point</code><code class="p">.</code><code class="nx">js</code>
<code class="nx">My</code> <code class="nx">point</code><code class="o">:</code> <code class="p">{</code><code class="s2">"x"</code><code class="o">:</code><code class="mi">7</code><code class="p">,</code><code class="s2">"y"</code><code class="o">:</code><code class="mi">4</code><code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-more-babel-features">
<span class="section-number">4.8.1.3 </span>More <code>babel</code> features</h5>

<p>The package <code>babel</code> has many more features, which are all <a href="https://babeljs.io/docs/using-babel/#node-js">documented</a> on the Babel website. For example, from within a normal Node module, you can install a “require hook”, which compiles all required modules via Babel (except, by default, modules in <code>node_modules</code>).</p>

<h4 id="leanpub-auto-running-jasmine-unit-tests-via-babel">
<span class="section-number">4.8.2 </span>Running Jasmine unit tests via Babel</h4>

<p>Another npm package, <a href="https://github.com/babel/babel-jest">babel-jest</a>, is a preprocessor for <a href="http://facebook.github.io/jest/">the Jasmine-based unit testing tool Jest</a>.</p>

<p>One way to install babel-jest is by mentioning it in the <code>devDependencies</code> of your <code>package.json</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code>
  <code class="s2">"devDependencies"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"babel-jest"</code><code class="o">:</code> <code class="s2">"*"</code><code class="p">,</code>
    <code class="s2">"jest-cli"</code><code class="o">:</code> <code class="s2">"*"</code>
  <code class="p">},</code>
  <code class="s2">"scripts"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"test"</code><code class="o">:</code> <code class="s2">"jest"</code>
  <code class="p">},</code>
  <code class="s2">"jest"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"scriptPreprocessor"</code><code class="o">:</code> <code class="s2">"&lt;rootDir&gt;/node_modules/babel-jest"</code><code class="p">,</code>
    <code class="s2">"testFileExtensions"</code><code class="o">:</code> <code class="p">[</code><code class="s2">"js"</code><code class="p">],</code>
    <code class="s2">"moduleFileExtensions"</code><code class="o">:</code> <code class="p">[</code><code class="s2">"js"</code><code class="p">,</code> <code class="s2">"json"</code><code class="p">],</code>
    <code class="s2">"testDirectoryName"</code><code class="o">:</code> <code class="s2">"spec"</code>
  <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Afterwards, you only need to execute the following command inside the directory of <code>package.json</code> and both babel-jest and a command line interface (CLI) for Jest will be installed.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">npm</code> <code class="nx">install</code>
</pre></div>

</div>

<p>The configuration options for Jest are <a href="http://facebook.github.io/jest/docs/api.html">documented</a> on its website. I have used <code>testDirectoryName</code> to specify that the tests are inside the directory <code>spec</code> (the default is <code>__tests__</code>). Let’s add the following test file to that directory:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// spec/point.spec.js</code>
<code class="kr">import</code> <code class="s1">'../auto_mock_off'</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">Point</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'../point'</code><code class="p">;</code>

<code class="nx">describe</code><code class="p">(</code><code class="s1">'Point'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">it</code><code class="p">(</code><code class="s1">'sets up instance properties correctly'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">p</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Point</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">p</code><code class="p">));</code>
        <code class="nx">expect</code><code class="p">(</code><code class="nx">p</code><code class="p">.</code><code class="nx">x</code><code class="p">).</code><code class="nx">toBe</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
        <code class="nx">expect</code><code class="p">(</code><code class="nx">p</code><code class="p">.</code><code class="nx">y</code><code class="p">).</code><code class="nx">toBe</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>
    <code class="p">});</code>
<code class="p">});</code>
</pre></div>

</div>

<p>(Importing <code>'../auto_mock_off'</code> is a trick so that Jest doesn’t auto-mock.)</p>

<p>Because we have specified <code>scripts.test</code> in <code>package.json</code>, we can run all tests inside <code>spec/</code> via the following command:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">npm</code> <code class="nx">test</code>
</pre></div>

</div>


<h3 id="sec_static-transpilation-nodejs-babel">
<span class="section-number">4.9 </span>Example setup: Statically transpiled ES6 on Node.js via Babel and gulp</h3>

<p>This section explains how to use ES6 on Node.js by statically transpiling it to ES5 via Babel and gulp.</p>

<p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_dynamic-transpilation-nodejs-babel">The previous section</a> showed how to dynamically transpile ES6 at runtime (also via Babel). That is more convenient and should work for many projects, but occasionally you may want a simpler and faster setup for your runtime environment.</p>

<h4 id="leanpub-auto-installation">
<span class="section-number">4.9.1 </span>Installation</h4>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>The demo project <a href="https://github.com/rauschma/node-es6-demo">node-es6-demo</a> used in this section is available on GitHub.</p>

    </td>
  </tr></tbody></table>
<p>Installation consists of downloading the project and executing the following commands, which install all npm packages that the project depends on:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">$</code> <code class="nx">cd</code> <code class="nx">node</code><code class="o">-</code><code class="nx">es6</code><code class="o">-</code><code class="nx">demo</code><code class="o">/</code>
<code class="nx">$</code> <code class="nx">npm</code> <code class="nx">install</code>
</pre></div>

</div>

<p>The repo has the following structure:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">node</code><code class="o">-</code><code class="nx">es6</code><code class="o">-</code><code class="nx">demo</code><code class="o">/</code>
    <code class="nx">es5</code><code class="o">/</code>
    <code class="nx">es6</code><code class="o">/</code>
        <code class="nx">myapp</code><code class="p">.</code><code class="nx">js</code>
    <code class="nx">gulpfile</code><code class="p">.</code><code class="nx">js</code>
</pre></div>

</div>

<h4 id="leanpub-auto-source-maps">
<span class="section-number">4.9.2 </span>Source maps</h4>

<p>Source maps help whenever a programming language is compiled to JavaScript. Compiling source code to source code is also called <em>transpiling</em>. Examples of transpilation are:</p>

<ul>
<li>Minification (normal JavaScript to minified JavaScript)</li>
  <li>CoffeeScript</li>
  <li>ECMAScript 6 (ES6 to ES5)</li>
</ul>
<p>A source map is a file that accompanies the transpilation output and maps the lines of the output to lines in the input files. This information can be used by error messages and debuggers to refer to lines in the original instead of the transpilation result. There are two ways to let tools know about a source map: Either the transpilation output refers to the source map file in the last line or it embeds that file’s contents in the last line.</p>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-more-information-on-source-maps">More information on source maps</h3>

  <p>For more information on source maps consult the article “<a href="http://www.html5rocks.com/en/tutorials/developertools/sourcemaps/">Introduction to JavaScript Source Maps</a>” by Ryan Seddon on HTML5 Rocks.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-the-gulp-file">
<span class="section-number">4.9.3 </span>The gulp file</h4>

<p>I am handling transpilation via the build tool <a href="http://gulpjs.com/"><em>gulp</em></a>. It is configured via a file <code>gulpfile.js</code> in a project’s directory. That file is a normal Node.js module that requires a module <code>gulp</code> and uses it to define <em>build tasks</em> (various operations performed on the project’s files).</p>

<p>Our <code>gulpfile.js</code> looks as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Various helper modules</code>
<code class="kd">var</code> <code class="nx">gulp</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'gulp'</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">sourcemaps</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'gulp-sourcemaps'</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">babel</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'gulp-babel'</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'path'</code><code class="p">);</code>

<code class="c1">// I manage the paths of this project via an object</code>
<code class="kd">var</code> <code class="nx">paths</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">es6</code><code class="o">:</code> <code class="p">[</code><code class="s1">'es6/**/*.js'</code><code class="p">],</code>
    <code class="nx">es5</code><code class="o">:</code> <code class="s1">'es5'</code><code class="p">,</code>
    <code class="c1">// Must be absolute or relative to source map</code>
    <code class="nx">sourceRoot</code><code class="o">:</code> <code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'es6'</code><code class="p">),</code>
<code class="p">};</code>

<code class="c1">// First task: transpile the ES6 code</code>
<code class="nx">gulp</code><code class="p">.</code><code class="nx">task</code><code class="p">(</code><code class="s1">'babel'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="c1">// (A)</code>
    <code class="k">return</code> <code class="nx">gulp</code><code class="p">.</code><code class="nx">src</code><code class="p">(</code><code class="nx">paths</code><code class="p">.</code><code class="nx">es6</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">pipe</code><code class="p">(</code><code class="nx">sourcemaps</code><code class="p">.</code><code class="nx">init</code><code class="p">())</code> <code class="c1">// (B)</code>
        <code class="p">.</code><code class="nx">pipe</code><code class="p">(</code><code class="nx">babel</code><code class="p">())</code>
        <code class="p">.</code><code class="nx">pipe</code><code class="p">(</code><code class="nx">sourcemaps</code><code class="p">.</code><code class="nx">write</code><code class="p">(</code><code class="s1">'.'</code><code class="p">,</code> <code class="c1">// (C)</code>
                  <code class="p">{</code> <code class="nx">sourceRoot</code><code class="o">:</code> <code class="nx">paths</code><code class="p">.</code><code class="nx">sourceRoot</code> <code class="p">}))</code>
        <code class="p">.</code><code class="nx">pipe</code><code class="p">(</code><code class="nx">gulp</code><code class="p">.</code><code class="nx">dest</code><code class="p">(</code><code class="nx">paths</code><code class="p">.</code><code class="nx">es5</code><code class="p">));</code>
<code class="p">});</code>

<code class="c1">// Second task: watch files, transpile if one of them changes</code>
<code class="nx">gulp</code><code class="p">.</code><code class="nx">task</code><code class="p">(</code><code class="s1">'watch'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code> <code class="c1">// (D)</code>
    <code class="nx">gulp</code><code class="p">.</code><code class="nx">watch</code><code class="p">(</code><code class="nx">paths</code><code class="p">.</code><code class="nx">es6</code><code class="p">,</code> <code class="p">[</code><code class="s1">'babel'</code><code class="p">]);</code>
<code class="p">});</code>

<code class="c1">// The default task is 'watch'</code>
<code class="nx">gulp</code><code class="p">.</code><code class="nx">task</code><code class="p">(</code><code class="s1">'default'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'watch'</code><code class="p">]);</code> <code class="c1">// (E)</code>
</pre></div>

</div>

<p>In order to make gulp do something you invoke it like this:</p>

<div class="code-block">
<div class="highlight"><pre>$ gulp «name_of_task»
</pre></div>

</div>

<p>Our gulpfile defines two tasks, <code>babel</code> (line A) and <code>watch</code> (line D). If you call <code>gulp</code> without any arguments, the default task is triggered. In this file, the default task is <code>watch</code> (line E).</p>

<p>Source maps are created due to the code in line B and line C. If you omit the path in line C, the source map is inlined in the output file (vs. stored in a separate file).</p>

<p>Hopefully you now have a rough understanding of how the gulp file works. For open questions, consult <a href="https://github.com/gulpjs/gulp/blob/master/docs/README.md">the gulp documentation</a>.</p>

<h4 id="leanpub-auto-transpilation">
<span class="section-number">4.9.4 </span>Transpilation</h4>

<p>The file <code>es6/myapp.js</code> contains the ES6 code of the Node.js application:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="p">{</code> <code class="nx">install</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'source-map-support'</code><code class="p">;</code>
<code class="nx">install</code><code class="p">();</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">].</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code><code class="p">));</code>

<code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Test!'</code><code class="p">);</code>
</pre></div>

</div>

<p>Alas, Node.js does not come with built-in support for source maps. But it can be enabled via a library, e.g. the npm package <a href="https://github.com/evanw/node-source-map-support"><code>source-map-support</code></a>. That library needs to be called at least once in an app. The first two lines in the previous code take care of that. They also demonstrate that you can use any npm-installed package via ES6 syntax.</p>

<p>The following gulp invocation transpiles <code>myapp.js</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">$</code> <code class="nx">gulp</code> <code class="nx">babel</code>
</pre></div>

</div>

<p>Alternatively, you can use <code>gulp</code> or <code>gulp watch</code> to continuously watch the ES6 files and transpile them whenever they are changed.</p>

<p>The results of the transpilation are in the directory <code>es5/</code>:</p>

<div class="code-block">
<div class="highlight"><pre>es5/
    myapp.js
    myapp.js.map
</pre></div>

</div>

<p>You can see the ES5 version of <code>es6/myapp.js</code> and the source map file <code>myapp.js.map</code>. The contents of the former file are:</p>

<div class="code-block">
<div class="highlight"><pre><code class="s1">'use strict'</code><code class="p">;</code>

<code class="kd">var</code> <code class="nx">_install</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'source-map-support'</code><code class="p">);</code>

<code class="nx">_install</code><code class="p">.</code><code class="nx">install</code><code class="p">();</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">].</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">return</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code><code class="p">;</code>
<code class="p">}));</code>

<code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Test!'</code><code class="p">);</code>
<code class="c1">//# sourceMappingURL=myapp.js.map</code>
</pre></div>

</div>

<h4 id="leanpub-auto-running-the-transpiled-code">
<span class="section-number">4.9.5 </span>Running the transpiled code</h4>

<p>The transpiled code is a normal ES5 Node.js app and is run as usual:</p>

<div class="code-block">
<div class="highlight"><pre>$ node es5/myapp.js
</pre></div>

</div>

<p>It produces the following output. Note that, thanks to the source map, the stack trace reports that the exception is thrown in line 6. That is the correct line in the ES6 file.</p>

<div class="code-block">
<div class="highlight"><pre>[ 1, 4, 9 ]

/tmp/node-es6-demo/es6/myapp.js:6
throw new Error('Test!');
      ^
Error: Test!
    at Object.&lt;anonymous&gt; (/tmp/node-es6-demo/es6/myapp.js:6:7)
    at Module._compile (module.js:456:26)
    at Object.Module._extensions..js (module.js:474:10)
    at Module.load (module.js:356:32)
    at Function.Module._load (module.js:312:12)
    at Function.Module.runMain (module.js:497:10)
    at startup (node.js:119:16)
    at node.js:906:3
</pre></div>

</div>

<h1 id="leanpub-auto-data">
<span class="section-number">II </span>Data</h1>

<h2 id="ch_numbers">
<span class="section-number">5. </span>New number and <code>Math</code> features</h2>

<p>This chapter describes the new number and <code>Math</code> features of ECMAScript 6.</p>


<h3 id="leanpub-auto-overview">
<span class="section-number">5.1 </span>Overview</h3>

<p>You can now specify integers in binary and octal notation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="mh">0xFF</code> <code class="c1">// ES5: hexadecimal</code>
<code class="mi">255</code>
<code class="o">&gt;</code> <code class="mi">0</code><code class="n">b11</code> <code class="c1">// ES6: binary</code>
<code class="mi">3</code>
<code class="o">&gt;</code> <code class="mi">0</code><code class="n">o10</code> <code class="c1">// ES6: octal</code>
<code class="mi">8</code>
</pre></div>

</div>

<p>The global object <code>Number</code> gained a few new properties. Among others:</p>

<ul>
<li>
<code>Number.EPSILON</code> for comparing floating point numbers with a tolerance for rounding errors.</li>
  <li>A method and constants for determining whether a JavaScript integer is <em>safe</em> (within the signed 53 bit range in which there is no loss of precision).</li>
</ul>
<h3 id="leanpub-auto-new-integer-literals">
<span class="section-number">5.2 </span>New integer literals</h3>

<p>ECMAScript 5 already has literals for hexadecimal integers:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="mh">0x9</code>
<code class="mi">9</code>
<code class="o">&gt;</code> <code class="mh">0xA</code>
<code class="mi">10</code>
<code class="o">&gt;</code> <code class="mh">0x10</code>
<code class="mi">16</code>
<code class="o">&gt;</code> <code class="mh">0xFF</code>
<code class="mi">255</code>
</pre></div>

</div>

<p>ECMAScript 6 brings two new kinds of integer literals:</p>

<ul>
<li>Binary literals have the prefix <code>0b</code> or <code>0B</code>:
    <div class="code-block">
<div class="highlight"><pre>  <code class="o">&gt;</code> <code class="mi">0</code><code class="n">b11</code>
  <code class="mi">3</code>
  <code class="o">&gt;</code> <code class="mi">0</code><code class="n">b100</code>
  <code class="mi">4</code>
</pre></div>
    
</div>
  </li>
  <li>Octal literals have the prefix <code>0o</code> or <code>0O</code> (yes, that’s a zero followed by the capital letter O; you’ll be fine if you use the first variant):
    <div class="code-block">
<div class="highlight"><pre>  <code class="o">&gt;</code> <code class="mi">0</code><code class="n">o7</code>
  <code class="mi">7</code>
  <code class="o">&gt;</code> <code class="mi">0</code><code class="n">o10</code>
  <code class="mi">8</code>
</pre></div>
    
</div>
  </li>
</ul>
<p>Remember that the method <code>Number.prototype.toString(radix)</code> can be used to convert Numbers back:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">(</code><code class="mi">255</code><code class="p">).</code><code class="n">toString</code><code class="p">(</code><code class="mi">16</code><code class="p">)</code>
<code class="err">'</code><code class="n">ff</code><code class="err">'</code>
<code class="o">&gt;</code> <code class="p">(</code><code class="mi">4</code><code class="p">).</code><code class="n">toString</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>
<code class="err">'</code><code class="mi">100</code><code class="err">'</code>
<code class="o">&gt;</code> <code class="p">(</code><code class="mi">8</code><code class="p">).</code><code class="n">toString</code><code class="p">(</code><code class="mi">8</code><code class="p">)</code>
<code class="err">'</code><code class="mi">10</code><code class="err">'</code>
</pre></div>

</div>


<h4 id="leanpub-auto-use-case-for-octal-literals-unix-style-file-permissions">
<span class="section-number">5.2.1 </span>Use case for octal literals: Unix-style file permissions</h4>

<p>In the Node.js <a href="https://nodejs.org/api/fs.html">file system module</a>, several functions have the parameter <code>mode</code>. Its value is used to specify file permissions, via an encoding that is a holdover from Unix:</p>

<ul>
<li>Permissions are specified for three categories of users:
    <ul>
<li>User: the owner of the file</li>
      <li>Group: the members of the group associated with the file</li>
      <li>All: everyone</li>
    </ul>
</li>
  <li>Per category, the following permissions can be granted:
    <ul>
<li>r (read): the users in the category are allowed to read the file</li>
      <li>w (write): the users in the category are allowed to change the file</li>
      <li>x (execute): the users in the category are allowed to run the file</li>
    </ul>
</li>
</ul>
<p>That means that permissions can be represented by 9 bits (3 categories with 3 permissions each):</p>

<table>
<thead><tr>
<th>&nbsp;</th>
      <th>User</th>
      <th>Group</th>
      <th>All</th>
    </tr></thead>
<tbody>
<tr>
<td>Permissions</td>
      <td>r, w, x</td>
      <td>r, w, x</td>
      <td>r, w, x</td>
    </tr>
<tr>
<td>Bit</td>
      <td>8, 7, 6</td>
      <td>5, 4, 3</td>
      <td>2, 1, 0</td>
    </tr>
</tbody>
</table>
<p>The permissions of a single category of users are stored in 3 bits:</p>

<table>
<thead><tr>
<th>Bits</th>
      <th>Permissions</th>
      <th>Octal digit</th>
    </tr></thead>
<tbody>
<tr>
<td>000</td>
      <td>–––</td>
      <td>0</td>
    </tr>
<tr>
<td>001</td>
      <td>––x</td>
      <td>1</td>
    </tr>
<tr>
<td>010</td>
      <td>–w–</td>
      <td>2</td>
    </tr>
<tr>
<td>011</td>
      <td>–wx</td>
      <td>3</td>
    </tr>
<tr>
<td>100</td>
      <td>r––</td>
      <td>4</td>
    </tr>
<tr>
<td>101</td>
      <td>r–x</td>
      <td>5</td>
    </tr>
<tr>
<td>110</td>
      <td>rw–</td>
      <td>6</td>
    </tr>
<tr>
<td>111</td>
      <td>rwx</td>
      <td>7</td>
    </tr>
</tbody>
</table>
<p>That means that octal numbers are a compact representation of all permissions, you only need 3 digits, one digit per category of users. Two examples:</p>

<ul>
<li>755 = 111,101,101: I can change, read and execute; everyone else can only read and execute.</li>
  <li>640 = 110,100,000: I can read and write; group members can read; everyone can’t access at all.</li>
</ul>
<h4 id="leanpub-auto-parseint-and-the-new-integer-literals">
<span class="section-number">5.2.2 </span><code>parseInt()</code> and the new integer literals</h4>

<p><code>parseInt()</code> has the following signature:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nb">parseInt</code><code class="p">(</code><code class="nx">string</code><code class="p">,</code> <code class="nx">radix</code><code class="o">?</code><code class="p">)</code>
</pre></div>

</div>

<p>It provides special support for the hexadecimal literal notation – the prefix <code>0x</code> (or <code>0X</code>) of <code>string</code> is removed if:</p>

<ul>
<li>
<code>radix</code> is missing or 0. Then <code>radix</code> is set to 16.</li>
  <li>
<code>radix</code> is already 16.</li>
</ul>
<p>For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mh">0xFF</code><code class="err">'</code><code class="p">)</code>
<code class="mi">255</code>
<code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mh">0xFF</code><code class="err">'</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>
<code class="mi">255</code>
<code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mh">0xFF</code><code class="err">'</code><code class="p">,</code> <code class="mi">16</code><code class="p">)</code>
<code class="mi">255</code>
</pre></div>

</div>

<p>In all other cases, digits are only parsed until the first non-digit:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mh">0xFF</code><code class="err">'</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mh">0xFF</code><code class="err">'</code><code class="p">,</code> <code class="mi">17</code><code class="p">)</code>
<code class="mi">0</code>
</pre></div>

</div>

<p>However, <code>parseInt()</code> does not have special support for binary or octal literals!</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mi">0</code><code class="n">b111</code><code class="err">'</code><code class="p">)</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mi">0</code><code class="n">b111</code><code class="err">'</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mi">111</code><code class="err">'</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
<code class="mi">7</code>

<code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mi">0</code><code class="n">o10</code><code class="err">'</code><code class="p">)</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mi">0</code><code class="n">o10</code><code class="err">'</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mi">10</code><code class="err">'</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code>
<code class="mi">8</code>
</pre></div>

</div>

<p>If you want to parse these kinds of literals, you need to use <code>Number()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Number</code><code class="p">(</code><code class="err">'</code><code class="mi">0</code><code class="n">b111</code><code class="err">'</code><code class="p">)</code>
<code class="mi">7</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">(</code><code class="err">'</code><code class="mi">0</code><code class="n">o10</code><code class="err">'</code><code class="p">)</code>
<code class="mi">8</code>
</pre></div>

</div>

<p>Alternatively, you can also remove the prefix and use <code>parseInt()</code> with the appropriate radix:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mi">111</code><code class="err">'</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
<code class="mi">7</code>
<code class="o">&gt;</code> <code class="n">parseInt</code><code class="p">(</code><code class="err">'</code><code class="mi">10</code><code class="err">'</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code>
<code class="mi">8</code>
</pre></div>

</div>


<h3 id="leanpub-auto-new-static-number-properties">
<span class="section-number">5.3 </span>New static <code>Number</code> properties</h3>

<p>This section describes new properties that the constructor <code>Number</code> has picked up in ECMAScript 6.</p>


<h4 id="leanpub-auto-previously-global-functions">
<span class="section-number">5.3.1 </span>Previously global functions</h4>

<p>Four number-related functions are already available as global functions and have been added to <code>Number</code>, as methods: <code>isFinite</code> and <code>isNaN</code>, <code>parseFloat</code> and <code>parseInt</code>. All of them work almost the same as their global counterparts, but <code>isFinite</code> and <code>isNaN</code> don’t coerce their arguments to numbers, anymore, which is especially important for <code>isNaN</code>. The following subsections explain all the details.</p>

<h5 id="leanpub-auto-numberisfinitenumber">
<span class="section-number">5.3.1.1 </span><code>Number.isFinite(number)</code>
</h5>

<p>Is <code>number</code> an actual number (neither <code>Infinity</code> nor <code>-Infinity</code> nor <code>NaN</code>)?</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isFinite</code><code class="p">(</code><code class="n">Infinity</code><code class="p">)</code>
<code class="nb">false</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isFinite</code><code class="p">(</code><code class="o">-</code><code class="n">Infinity</code><code class="p">)</code>
<code class="nb">false</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isFinite</code><code class="p">(</code><code class="n">NaN</code><code class="p">)</code>
<code class="nb">false</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isFinite</code><code class="p">(</code><code class="mi">123</code><code class="p">)</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>The advantage of this method is that it does not coerce its parameter to number (whereas the global function does):</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isFinite</code><code class="p">(</code><code class="err">'</code><code class="mi">123</code><code class="err">'</code><code class="p">)</code>
<code class="nb">false</code>
<code class="o">&gt;</code> <code class="n">isFinite</code><code class="p">(</code><code class="err">'</code><code class="mi">123</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
</pre></div>

</div>

<h5 id="leanpub-auto-numberisnannumber">
<span class="section-number">5.3.1.2 </span><code>Number.isNaN(number)</code>
</h5>

<p>Is <code>number</code> the value <code>NaN</code>? Making this check via <code>===</code> is hacky. <code>NaN</code> is the only value that is not equal to itself:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">x</code> <code class="o">=</code> <code class="n">NaN</code><code class="p">;</code>
<code class="o">&gt;</code> <code class="n">x</code> <code class="o">===</code> <code class="n">NaN</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>Therefore, this expression is used to check for it</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">x</code> <code class="o">!==</code> <code class="n">x</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>Using <code>Number.isNaN()</code> is more self-descriptive:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isNaN</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
<code class="nb">true</code>
</pre></div>

</div>

<p><code>Number.isNaN()</code> also has the advantage of not coercing its parameter to number (whereas the global function does):</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isNaN</code><code class="p">(</code><code class="err">'</code><code class="o">???</code><code class="err">'</code><code class="p">)</code>
<code class="nb">false</code>
<code class="o">&gt;</code> <code class="n">isNaN</code><code class="p">(</code><code class="err">'</code><code class="o">???</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
</pre></div>

</div>

<h5 id="leanpub-auto-numberparsefloat-and-numberparseint">
<span class="section-number">5.3.1.3 </span><code>Number.parseFloat</code> and <code>Number.parseInt</code>
</h5>

<p>The following two methods work exactly like the global functions with the same names. They were added to <code>Number</code> for completeness sake; now all number-related functions are available there.</p>

<ul>
<li>
<code>Number.parseFloat(string)</code><sup id="fnref-numbers_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-numbers_1" rel="footnote">1</a></sup>
</li>
  <li>
<code>Number.parseInt(string, radix)</code><sup id="fnref-numbers_2"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-numbers_2" rel="footnote">2</a></sup>
</li>
</ul>
<h4 id="leanpub-auto-numberepsilon">
<span class="section-number">5.3.2 </span>Number.EPSILON</h4>

<p>Especially with decimal fractions, rounding errors can become a problem in JavaScript<sup id="fnref-numbers_3"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-numbers_3" rel="footnote">3</a></sup>. For example, 0.1 and 0.2 can be represented precisely, which you notice if you add them and compare them to 0.3 (which can’t be represented precisely, either).</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="mf">0.1</code> <code class="o">+</code> <code class="mf">0.2</code> <code class="o">===</code> <code class="mf">0.3</code>
<code class="nb">false</code>
</pre></div>

</div>

<p><code>Number.EPSILON</code> specifies a reasonable margin of error when comparing floating point numbers. It provides a better way to compare floating point values, as demonstrated by the following function.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">epsEqu</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">abs</code><code class="p">(</code><code class="nx">x</code> <code class="o">-</code> <code class="nx">y</code><code class="p">)</code> <code class="o">&lt;</code> <code class="nb">Number</code><code class="p">.</code><code class="nx">EPSILON</code><code class="p">;</code>
<code class="p">}</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">epsEqu</code><code class="p">(</code><code class="mf">0.1</code><code class="o">+</code><code class="mf">0.2</code><code class="p">,</code> <code class="mf">0.3</code><code class="p">));</code> <code class="c1">// true</code>
</pre></div>

</div>


<h4 id="leanpub-auto-numberisintegernumber">
<span class="section-number">5.3.3 </span><code>Number.isInteger(number)</code>
</h4>

<p>JavaScript has only floating point numbers (doubles). Accordingly, integers are simply floating point numbers without a decimal fraction.</p>

<p><code>Number.isInteger(number)</code> returns <code>true</code> if <code>number</code> is a number and does not have a decimal fraction.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isInteger</code><code class="p">(</code><code class="o">-</code><code class="mi">17</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isInteger</code><code class="p">(</code><code class="mi">33</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isInteger</code><code class="p">(</code><code class="mf">33.1</code><code class="p">)</code>
<code class="nb">false</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isInteger</code><code class="p">(</code><code class="err">'</code><code class="mi">33</code><code class="err">'</code><code class="p">)</code>
<code class="nb">false</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isInteger</code><code class="p">(</code><code class="n">NaN</code><code class="p">)</code>
<code class="nb">false</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isInteger</code><code class="p">(</code><code class="n">Infinity</code><code class="p">)</code>
<code class="nb">false</code>
</pre></div>

</div>


<h4 id="leanpub-auto-safe-integers">
<span class="section-number">5.3.4 </span>Safe Integers</h4>

<p>JavaScript numbers have only enough storage space to represent 53 bit signed integers. That is, integers <em>i</em> in the range −2<sup>53</sup> &lt; <em>i</em> &lt; 2<sup>53</sup> are <em>safe</em>. What exactly that means is explained momentarily. The following properties help determine whether a JavaScript integer is safe:</p>

<ul>
<li><code>Number.isSafeInteger(number)</code></li>
  <li><code>Number.MIN_SAFE_INTEGER</code></li>
  <li><code>Number.MAX_SAFE_INTEGER</code></li>
</ul>
<p>The notion of <em>safe integers</em> centers on how mathematical integers are represented in JavaScript. In the range (−2<sup>53</sup>, 2<sup>53</sup>) (excluding the lower and upper bounds), JavaScript integers are <em>safe</em>: there is a one-to-one mapping between them and the mathematical integers they represent.</p>

<p>Beyond this range, JavaScript integers are <em>unsafe</em>: two or more mathematical integers are represented as the same JavaScript integer. For example, starting at 2<sup>53</sup>, JavaScript can represent only every second mathematical integer:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">pow</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">53</code><code class="p">)</code>
<code class="mi">9007199254740992</code>

<code class="o">&gt;</code> <code class="mi">9007199254740992</code>
<code class="mi">9007199254740992</code>
<code class="o">&gt;</code> <code class="mi">9007199254740993</code>
<code class="mi">9007199254740992</code>
<code class="o">&gt;</code> <code class="mi">9007199254740994</code>
<code class="mi">9007199254740994</code>
<code class="o">&gt;</code> <code class="mi">9007199254740995</code>
<code class="mi">9007199254740996</code>
<code class="o">&gt;</code> <code class="mi">9007199254740996</code>
<code class="mi">9007199254740996</code>
<code class="o">&gt;</code> <code class="mi">9007199254740997</code>
<code class="mi">9007199254740996</code>
</pre></div>

</div>

<p>Therefore, a safe JavaScript integer is one that unambiguously represents a single mathematical integer.</p>

<h5 id="leanpub-auto-static-number-properties-related-to-safe-integers">
<span class="section-number">5.3.4.1 </span>Static <code>Number</code> properties related to safe integers</h5>

<p>The two static <code>Number</code> properties specifying the lower and upper bound of safe integers could be defined as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nb">Number</code><code class="p">.</code><code class="nx">MAX_SAFE_INTEGER</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">pow</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">53</code><code class="p">)</code><code class="o">-</code><code class="mi">1</code><code class="p">;</code>
<code class="nb">Number</code><code class="p">.</code><code class="nx">MIN_SAFE_INTEGER</code> <code class="o">=</code> <code class="o">-</code><code class="nb">Number</code><code class="p">.</code><code class="nx">MAX_SAFE_INTEGER</code><code class="p">;</code>
</pre></div>

</div>

<p><code>Number.isSafeInteger()</code> determines whether a JavaScript number is a safe integer and could be defined as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nb">Number</code><code class="p">.</code><code class="nx">isSafeInteger</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">n</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">n</code> <code class="o">===</code> <code class="s1">'number'</code> <code class="o">&amp;&amp;</code>
        <code class="nb">Math</code><code class="p">.</code><code class="nx">round</code><code class="p">(</code><code class="nx">n</code><code class="p">)</code> <code class="o">===</code> <code class="nx">n</code> <code class="o">&amp;&amp;</code>
        <code class="nb">Number</code><code class="p">.</code><code class="nx">MIN_SAFE_INTEGER</code> <code class="o">&lt;=</code> <code class="nx">n</code> <code class="o">&amp;&amp;</code>
        <code class="nx">n</code> <code class="o">&lt;=</code> <code class="nb">Number</code><code class="p">.</code><code class="nx">MAX_SAFE_INTEGER</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>For a given value <code>n</code>, this function first checks whether <code>n</code> is a number and an integer. If both checks succeed, <code>n</code> is safe if it is greater than or equal to <code>MIN_SAFE_INTEGER</code> and less than or equal to <code>MAX_SAFE_INTEGER</code>.</p>

<h5 id="leanpub-auto-when-are-computations-with-integers-correct">
<span class="section-number">5.3.4.2 </span>When are computations with integers correct?</h5>

<p>How can we make sure that results of computations with integers are correct? For example, the following result is clearly not correct:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="mi">9007199254740990</code> <code class="o">+</code> <code class="mi">3</code>
<code class="mi">9007199254740992</code>
</pre></div>

</div>

<p>We have two safe operands, but an unsafe result:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isSafeInteger</code><code class="p">(</code><code class="mi">9007199254740990</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isSafeInteger</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isSafeInteger</code><code class="p">(</code><code class="mi">9007199254740992</code><code class="p">)</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>The following result is also incorrect:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="mi">9007199254740995</code> <code class="o">-</code> <code class="mi">10</code>
<code class="mi">9007199254740986</code>
</pre></div>

</div>

<p>This time, the result is safe, but one of the operands isn’t:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isSafeInteger</code><code class="p">(</code><code class="mi">9007199254740995</code><code class="p">)</code>
<code class="nb">false</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isSafeInteger</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">isSafeInteger</code><code class="p">(</code><code class="mi">9007199254740986</code><code class="p">)</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>Therefore, the result of applying an integer operator <code>op</code> is guaranteed to be correct only if all operands and the result are safe. More formally:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">isSafeInteger</code><code class="p">(</code><code class="nx">a</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="nx">isSafeInteger</code><code class="p">(</code><code class="nx">b</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="nx">isSafeInteger</code><code class="p">(</code><code class="nx">a</code> <code class="nx">op</code> <code class="nx">b</code><code class="p">)</code>
</pre></div>

</div>

<p>implies that <code>a op b</code> is a correct result.</p>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-source-of-this-section">Source of this section</h3>

  <p>“<a href="https://mail.mozilla.org/pipermail/es-discuss/2013-August/032991.html">Clarify integer and safe integer resolution</a>”, email by Mark S. Miller to the es-discuss mailing list.</p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-math">
<span class="section-number">5.4 </span>Math</h3>

<p>The global object <code>Math</code> has several new methods in ECMAScript 6.</p>

<h4 id="leanpub-auto-various-numerical-functionality">
<span class="section-number">5.4.1 </span>Various numerical functionality</h4>

<h5 id="leanpub-auto-mathsignx">
<span class="section-number">5.4.1.1 </span><code>Math.sign(x)</code>
</h5>

<p>Returns the sign of <code>x</code> as <code>-1</code> or <code>+1</code>. Unless <code>x</code> is either <code>NaN</code> or zero; then <code>x</code> is returned<sup id="fnref-numbers_4"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-numbers_4" rel="footnote">4</a></sup>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">sign</code><code class="p">(</code><code class="o">-</code><code class="mi">8</code><code class="p">)</code>
<code class="o">-</code><code class="mi">1</code>
<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">sign</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>
<code class="mi">1</code>

<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">sign</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">sign</code><code class="p">(</code><code class="n">NaN</code><code class="p">)</code>
<code class="n">NaN</code>

<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">sign</code><code class="p">(</code><code class="o">-</code><code class="n">Infinity</code><code class="p">)</code>
<code class="o">-</code><code class="mi">1</code>
<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">sign</code><code class="p">(</code><code class="n">Infinity</code><code class="p">)</code>
<code class="mi">1</code>
</pre></div>

</div>

<h5 id="leanpub-auto-mathtruncx">
<span class="section-number">5.4.1.2 </span><code>Math.trunc(x)</code>
</h5>

<p>Removes the decimal fraction of <code>x</code>. Complements the other rounding methods <code>Math.floor()</code>, <code>Math.ceil()</code> and <code>Math.round()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">trunc</code><code class="p">(</code><code class="mf">3.1</code><code class="p">)</code>
<code class="mi">3</code>
<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">trunc</code><code class="p">(</code><code class="mf">3.9</code><code class="p">)</code>
<code class="mi">3</code>
<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">trunc</code><code class="p">(</code><code class="o">-</code><code class="mf">3.1</code><code class="p">)</code>
<code class="o">-</code><code class="mi">3</code>
<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">trunc</code><code class="p">(</code><code class="o">-</code><code class="mf">3.9</code><code class="p">)</code>
<code class="o">-</code><code class="mi">3</code>
</pre></div>

</div>

<p>You could implement <code>Math.trunc()</code> like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">trunc</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sign</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="o">*</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">abs</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-mathcbrtx">
<span class="section-number">5.4.1.3 </span><code>Math.cbrt(x)</code>
</h5>

<p>Returns the cube root of <code>x</code> (∛x).</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">cbrt</code><code class="p">(</code><code class="mi">8</code><code class="p">)</code>
<code class="mi">2</code>
</pre></div>

</div>

<h4 id="leanpub-auto-using-0-instead-of-1-with-exponentiation-and-logarithm">
<span class="section-number">5.4.2 </span>Using 0 instead of 1 with exponentiation and logarithm</h4>

<p>A small fraction can be represented more precisely if it comes after zero. I’ll demonstrate this with decimal fractions (JavaScript’s numbers are internally stored with base 2, but the same reasoning applies).</p>


<p>Floating point numbers with base 10 are internally represented as <em>mantissa</em> × 10<sup>exponent</sup>. The <em>mantissa</em> has a single digit before the decimal dot and the <em>exponent</em> “moves” the dot as necessary. That means if you convert a small fraction to the internal representation, a zero before the dot leads to a smaller mantissa than a one before the dot. For example:</p>

<ul>
<li>(A) 0.000000234 = 2.34 × 10<sup>−7</sup>. Significant digits: 234</li>
  <li>(B) 1.000000234 = 1.000000234 × 10<sup>0</sup>. Significant digits: 1000000234</li>
</ul>
<p>Precision-wise, the important quantity here is the capacity of the mantissa, as measured in significant digits. That’s why (A) gives you higher precision than (B).</p>

<p>You can see this in the following interaction: The first number (1 × 10<sup>−16</sup>) registers as different from zero, while the same number added to 1 registers as 1.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="mf">1e-16</code> <code class="o">===</code> <code class="mi">0</code>
<code class="nb">false</code>
<code class="o">&gt;</code> <code class="mi">1</code> <code class="o">+</code> <code class="mf">1e-16</code> <code class="o">===</code> <code class="mi">1</code>
<code class="nb">true</code>
</pre></div>

</div>

<h5 id="leanpub-auto-mathexpm1x">
<span class="section-number">5.4.2.1 </span><code>Math.expm1(x)</code>
</h5>

<p>Returns <code>Math.exp(x)-1</code>. The inverse of <code>Math.log1p()</code>.</p>

<p>Therefore, this method provides higher precision whenever <code>Math.exp()</code> has results close to 1. You can see the difference between the two in the following interaction:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">expm1</code><code class="p">(</code><code class="mf">1e-10</code><code class="p">)</code>
<code class="mf">1.00000000005e-10</code>
<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">exp</code><code class="p">(</code><code class="mf">1e-10</code><code class="p">)</code><code class="o">-</code><code class="mi">1</code>
<code class="mf">1.000000082740371e-10</code>
</pre></div>

</div>

<p>The former is the better result, which you can verify by using a library (such as <a href="https://github.com/MikeMcl/decimal.js/">decimal.js</a>) for floating point numbers with arbitrary precision (“bigfloats”):</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">Decimal</code> <code class="o">=</code> <code class="n">require</code><code class="p">(</code><code class="err">'</code><code class="n">decimal</code><code class="p">.</code><code class="n">js</code><code class="err">'</code><code class="p">).</code><code class="n">config</code><code class="p">({</code><code class="n">precision</code><code class="o">:</code><code class="mi">50</code><code class="p">});</code>
<code class="o">&gt;</code> <code class="n">new</code> <code class="n">Decimal</code><code class="p">(</code><code class="mf">1e-10</code><code class="p">).</code><code class="n">exp</code><code class="p">().</code><code class="n">minus</code><code class="p">(</code><code class="mi">1</code><code class="p">).</code><code class="n">toString</code><code class="p">()</code>
<code class="err">'</code><code class="mf">1.000000000050000000001666666666708333333e-10</code><code class="err">'</code>
</pre></div>

</div>

<h5 id="leanpub-auto-mathlog1px">
<span class="section-number">5.4.2.2 </span><code>Math.log1p(x)</code>
</h5>

<p>Returns <code>Math.log(1 + x)</code>. The inverse of <code>Math.expm1()</code>.</p>

<p>Therefore, this method lets you specify parameters that are close to 1 with a higher precision.</p>

<p>We have already established that <code>1 + 1e-16 === 1</code>. Therefore, it is no surprise that the following two calls of <code>log()</code> produce the same result:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">log</code><code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="mf">1e-16</code><code class="p">)</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">log</code><code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="mi">0</code><code class="p">)</code>
<code class="mi">0</code>
</pre></div>

</div>

<p>In contrast, <code>log1p()</code> produces different results:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">log1p</code><code class="p">(</code><code class="mf">1e-16</code><code class="p">)</code>
<code class="mf">1e-16</code>
<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">log1p</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="mi">0</code>
</pre></div>

</div>

<h4 id="leanpub-auto-logarithms-to-base-2-and-10">
<span class="section-number">5.4.3 </span>Logarithms to base 2 and 10</h4>

<h5 id="leanpub-auto-mathlog2x">
<span class="section-number">5.4.3.1 </span><code>Math.log2(x)</code>
</h5>

<p>Computes the logarithm to base 2.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">log2</code><code class="p">(</code><code class="mi">8</code><code class="p">)</code>
<code class="mi">3</code>
</pre></div>

</div>

<h5 id="leanpub-auto-mathlog10x">
<span class="section-number">5.4.3.2 </span><code>Math.log10(x)</code>
</h5>

<p>Computes the logarithm to base 10.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">log10</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>
<code class="mi">2</code>
</pre></div>

</div>

<h4 id="leanpub-auto-support-for-compiling-to-javascript">
<span class="section-number">5.4.4 </span>Support for compiling to JavaScript</h4>

<p><a href="https://github.com/kripken/emscripten">Emscripten</a> pioneered a coding style that was later picked up by <a href="http://asmjs.org/">asm.js</a>: The operations of a virtual machine (think bytecode) are expressed in static subset of JavaScript. That subset can be executed efficiently by JavaScript engines: If it is the result of a compilation from C++, it runs at about 70% of native speed.</p>

<p>The following <code>Math</code> methods were mainly added to support asm.js and similar compilation strategies, they are not that useful for other applications.</p>

<h5 id="leanpub-auto-mathfroundx">
<span class="section-number">5.4.4.1 </span><code>Math.fround(x)</code>
</h5>

<p>Rounds <code>x</code> to a 32 bit floating point value (<code>float</code>). Used by asm.js to tell an engine to internally use a <code>float</code> value.</p>

<h5 id="leanpub-auto-mathimulx-y">
<span class="section-number">5.4.4.2 </span><code>Math.imul(x, y)</code>
</h5>

<p>Multiplies the two 32 bit integers <code>x</code> and <code>y</code> and returns the lower 32 bits of the result. This is the only 32 bit basic math operation that can’t be simulated by using a JavaScript operator and coercing the result back to 32 bits. For example, <code>idiv</code> could be implemented as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">idiv</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">(</code><code class="nx">x</code> <code class="o">/</code> <code class="nx">y</code><code class="p">)</code> <code class="o">|</code> <code class="mi">0</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In contrast, multiplying two large 32 bit integers may produce a double that is so large that lower bits are lost.</p>

<h4 id="leanpub-auto-bitwise-operations">
<span class="section-number">5.4.5 </span>Bitwise operations</h4>

<ul>
<li>
<code>Math.clz32(x)</code><br>
Counts the leading zero bits in the 32 bit integer <code>x</code>.
    <div class="code-block">
<div class="highlight"><pre>  <code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">clz32</code><code class="p">(</code><code class="mi">0</code><code class="n">b01000000000000000000000000000000</code><code class="p">)</code>
  <code class="mi">1</code>
  <code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">clz32</code><code class="p">(</code><code class="mi">0</code><code class="n">b00100000000000000000000000000000</code><code class="p">)</code>
  <code class="mi">2</code>
  <code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">clz32</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>
  <code class="mi">30</code>
  <code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">clz32</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
  <code class="mi">31</code>
</pre></div>
    
</div>
  </li>
</ul>
<p>Why is this interesting? Quoting “<a href="http://embeddedgurus.com/state-space/2014/09/fast-deterministic-and-portable-counting-leading-zeros/">Fast, Deterministic, and Portable Counting Leading Zeros</a>” by Miro Samek:</p>

<blockquote>
  <p>Counting leading zeros in an integer number is a critical operation in many DSP algorithms, such as normalization of samples in sound or video processing, as well as in real-time schedulers to quickly find the highest-priority task ready-to-run.</p>
</blockquote>

<h4 id="leanpub-auto-trigonometric-methods">
<span class="section-number">5.4.6 </span>Trigonometric methods</h4>

<ul>
<li>
<code>Math.sinh(x)</code><br>
Computes the hyperbolic sine of <code>x</code>.</li>
  <li>
<code>Math.cosh(x)</code><br>
Computes the hyperbolic cosine of <code>x</code>.</li>
  <li>
<code>Math.tanh(x)</code><br>
Computes the hyperbolic tangent of <code>x</code>.</li>
  <li>
<code>Math.asinh(x)</code><br>
Computes the inverse hyperbolic sine of <code>x</code>.</li>
  <li>
<code>Math.acosh(x)</code><br>
Computes the inverse hyperbolic cosine of <code>x</code>.</li>
  <li>
<code>Math.atanh(x)</code><br>
Computes the inverse hyperbolic tangent of <code>x</code>.</li>
  <li>
<code>Math.hypot(...values)</code><br>
Computes the square root of the sum of the squares of its arguments.</li>
</ul>
<h3 id="leanpub-auto-faq-numbers">
<span class="section-number">5.5 </span>FAQ: numbers</h3>

<h4 id="leanpub-auto-how-can-i-use-integers-beyond-javascripts-53-bit-range">
<span class="section-number">5.5.1 </span>How can I use integers beyond JavaScript’s 53 bit range?</h4>

<p>JavaScript’s integers have a range of 53 bits. That is a problem whenever 64 bit integers are needed. For example: In its JSON API, Twitter had to switch from integers to strings when tweet IDs became too large.</p>

<p>At the moment, the only way around that limitation is to use a library for higher-precision numbers (bigints or bigfloats). One such library is <a href="https://github.com/MikeMcl/decimal.js/">decimal.js</a>.</p>

<p>Plans to support larger integers in JavaScript exist, but may take a while to come to fruition.</p>

<div class="footnotes">
  <ol>
<li id="fn-numbers_1">[Speaking JS] <code>parseFloat()</code> in (<a href="http://speakingjs.com/es5/ch11.html#parseFloat">“Speaking JavaScript”</a>).<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-numbers_1" rel="rev-footnote">↩</a>
</li>
    <li id="fn-numbers_2">[Speaking JS] <code>parseInt()</code> in (<a href="http://speakingjs.com/es5/ch11.html#parseInt">“Speaking JavaScript”</a>).<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-numbers_2" rel="rev-footnote">↩</a>
</li>
    <li id="fn-numbers_3">[Speaking JS] The details of rounding errors are explained in <a href="http://speakingjs.com/es5/ch11.html#rounding_errors">“Speaking JavaScript”</a>.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-numbers_3" rel="rev-footnote">↩</a>
</li>
    <li id="fn-numbers_4">Internally, JavaScript has <a href="http://speakingjs.com/es5/ch11.html#two_zeros">two zeros</a>. <code>Math.sign(-0)</code> produces the result <code>-0</code> and <code>Math.sign(+0)</code> produces the result <code>+0</code>.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-numbers_4" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h2 id="ch_strings">
<span class="section-number">6. </span>New string features</h2>

<p>This chapter covers new features of strings in ECMAScript 6.</p>

<h3 id="leanpub-auto-overview-1">
<span class="section-number">6.1 </span>Overview</h3>

<p>New string methods:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">.</code><code class="n">startsWith</code><code class="p">(</code><code class="err">'</code><code class="n">hell</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">.</code><code class="n">endsWith</code><code class="p">(</code><code class="err">'</code><code class="n">ello</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">.</code><code class="n">includes</code><code class="p">(</code><code class="err">'</code><code class="n">ell</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="err">'</code><code class="n">doo</code> <code class="err">'</code><code class="p">.</code><code class="n">repeat</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>
<code class="err">'</code><code class="n">doo</code> <code class="n">doo</code> <code class="n">doo</code> <code class="err">'</code>
</pre></div>

</div>

<p>ES6 has a new kind of string literal, the <em>template literal</em>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// String interpolation via template literals (in backticks)</code>
<code class="kd">let</code> <code class="nx">first</code> <code class="o">=</code> <code class="s1">'Jane'</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">last</code> <code class="o">=</code> <code class="s1">'Doe'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">Hello</code> <code class="nx">$</code><code class="p">{</code><code class="nx">first</code><code class="p">}</code> <code class="nx">$</code><code class="p">{</code><code class="nx">last</code><code class="p">}</code><code class="o">!</code><code class="err">`</code><code class="p">);</code>
    <code class="c1">// Hello Jane Doe!</code>

<code class="c1">// Template literals also let you create strings with multiple lines</code>
<code class="kd">let</code> <code class="nx">multiLine</code> <code class="o">=</code> <code class="err">`</code>
<code class="nx">This</code> <code class="nx">is</code>
<code class="nx">a</code> <code class="nx">string</code>
<code class="kd">with</code> <code class="nx">multiple</code>
<code class="nx">lines</code><code class="err">`</code><code class="p">;</code>
</pre></div>

</div>

<h3 id="leanpub-auto-unicode-code-point-escapes">
<span class="section-number">6.2 </span>Unicode code point escapes</h3>

<p>Unicode “characters” (code points) are 21 bit long (as explained in <a href="http://speakingjs.com/es5/ch24.html">the chapter on Unicode in “Speaking JavaScript”</a>). JavaScript strings are (roughly) sequences of 16 bit characters, encoded as UTF-16. Therefore, code points beyond the first 16 bits of the code point range (the <em>Basic Multilingual Pane</em>, BMP) are represented by two JavaScript characters. Until now, if you wanted to specify such code points via numbers, you needed two so-called <em>Unicode escapes</em>. As an example, the following statement prints a rocket (code point 0x1F680) to most consoles:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'\uD83D\uDE80'</code><code class="p">);</code>
</pre></div>

</div>

<p>In ECMAScript 6, there is a new kind of Unicode escape that lets you specify any code point:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'\u{1F680}'</code><code class="p">);</code>
</pre></div>

</div>

<h3 id="leanpub-auto-string-interpolation-multi-line-string-literals-and-raw-string-literals">
<span class="section-number">6.3 </span>String interpolation, multi-line string literals and raw string literals</h3>

<p>Template literals are described in depth in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_template-literals">their own chapter</a>. They provide three interesting features.</p>

<p>First, template literals support string interpolation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">first</code> <code class="o">=</code> <code class="s1">'Jane'</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">last</code> <code class="o">=</code> <code class="s1">'Doe'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">Hello</code> <code class="nx">$</code><code class="p">{</code><code class="nx">first</code><code class="p">}</code> <code class="nx">$</code><code class="p">{</code><code class="nx">last</code><code class="p">}</code><code class="o">!</code><code class="err">`</code><code class="p">);</code>
    <code class="c1">// Hello Jane Doe!</code>
</pre></div>

</div>

<p>Second, template literals can contain multiple lines:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">multiLine</code> <code class="o">=</code> <code class="err">`</code>
<code class="nx">This</code> <code class="nx">is</code>
<code class="nx">a</code> <code class="nx">string</code>
<code class="kd">with</code> <code class="nx">multiple</code>
<code class="nx">lines</code><code class="err">`</code><code class="p">;</code>
</pre></div>

</div>

<p>Third, template literals are “raw” if you prefix them with the <em>tag</em> <code>String.raw</code> – the backslash is not a special character and escapes such as <code>\n</code> are not interpreted:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">raw</code> <code class="o">=</code> <code class="nb">String</code><code class="p">.</code><code class="nx">raw</code><code class="err">`</code><code class="nx">Not</code> <code class="nx">a</code> <code class="nx">newline</code><code class="o">:</code> <code class="err">\</code><code class="nx">n</code><code class="err">`</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">raw</code> <code class="o">===</code> <code class="s1">'Not a newline: \\n'</code><code class="p">);</code> <code class="c1">// true</code>
</pre></div>

</div>

<h3 id="leanpub-auto-iterating-over-strings">
<span class="section-number">6.4 </span>Iterating over strings</h3>

<p>Strings are <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_iteration"><em>iterable</em></a>, which means that you can use <code>for-of</code> to iterate over their characters:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">ch</code> <code class="nx">of</code> <code class="s1">'abc'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">ch</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
<code class="c1">// c</code>
</pre></div>

</div>

<p>And you can use the spread operator (<code>...</code>) to turn strings into Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">chars</code> <code class="o">=</code> <code class="p">[...</code><code class="s1">'abc'</code><code class="p">];</code>
    <code class="c1">// ['a', 'b', 'c']</code>
</pre></div>

</div>

<h4 id="leanpub-auto-iteration-honors-unicode-code-points">
<span class="section-number">6.4.1 </span>Iteration honors Unicode code points</h4>

<p>The string iterator splits strings along code point boundaries, which means that the strings it returns comprise one or two JavaScript characters:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">ch</code> <code class="nx">of</code> <code class="s1">'x\uD83D\uDE80y'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">ch</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// 1</code>
<code class="c1">// 2</code>
<code class="c1">// 1</code>
</pre></div>

</div>

<h4 id="leanpub-auto-counting-code-points">
<span class="section-number">6.4.2 </span>Counting code points</h4>

<p>Iteration gives you a quick way to count the Unicode code points in a string:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[...</code><code class="err">'</code><code class="n">x</code><code class="err">\</code><code class="n">uD83D</code><code class="err">\</code><code class="n">uDE80y</code><code class="err">'</code><code class="p">].</code><code class="n">length</code>
<code class="mi">3</code>
</pre></div>

</div>

<h4 id="leanpub-auto-reversing-strings-with-non-bmp-code-points">
<span class="section-number">6.4.3 </span>Reversing strings with non-BMP code points</h4>

<p>Iteration also helps with reversing strings that contain non-BMP code points (which are larger than 16 bit and encoded as two JavaScript characters):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">str</code> <code class="o">=</code> <code class="s1">'x\uD83D\uDE80y'</code><code class="p">;</code>

<code class="c1">// ES5: \uD83D\uDE80 are (incorrectly) reversed</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">str</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s1">''</code><code class="p">).</code><code class="nx">reverse</code><code class="p">().</code><code class="nx">join</code><code class="p">(</code><code class="s1">''</code><code class="p">));</code>
    <code class="c1">// 'y\uDE80\uD83Dx'</code>

<code class="c1">// ES6: order of \uD83D\uDE80 is preserved</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">([...</code><code class="nx">str</code><code class="p">].</code><code class="nx">reverse</code><code class="p">().</code><code class="nx">join</code><code class="p">(</code><code class="s1">''</code><code class="p">));</code>
    <code class="c1">// 'y\uD83D\uDE80x'</code>
</pre></div>

</div>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/strings----firefox_unicode_strings.png" alt="The two reversed strings in the Firefox console."><p class="caption">The two reversed strings in the Firefox console.</p>
</div>

<table class="warning sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_warning.png" alt="warning" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-remaining-problem-combining-marks">Remaining problem: combining marks</h3>

  <p>A <em>combining mark</em> is a sequence of two Unicode code points that is displayed as single symbol. The ES6 approach to reversing a string that I have presented here works for non-BMP code points, but not for combining marks. For those, you need a library, e.g. Mathias Bynens’ <a href="https://github.com/mathiasbynens/esrever">Esrever</a>.</p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-numeric-values-of-code-points">
<span class="section-number">6.5 </span>Numeric values of code points</h3>

<p>The new method <code>codePointAt()</code> returns the numeric value of a code point at a given index in a string:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">str</code> <code class="o">=</code> <code class="s1">'x\uD83D\uDE80y'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">str</code><code class="p">.</code><code class="nx">codePointAt</code><code class="p">(</code><code class="mi">0</code><code class="p">).</code><code class="nx">toString</code><code class="p">(</code><code class="mi">16</code><code class="p">));</code> <code class="c1">// 78</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">str</code><code class="p">.</code><code class="nx">codePointAt</code><code class="p">(</code><code class="mi">1</code><code class="p">).</code><code class="nx">toString</code><code class="p">(</code><code class="mi">16</code><code class="p">));</code> <code class="c1">// 1f680</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">str</code><code class="p">.</code><code class="nx">codePointAt</code><code class="p">(</code><code class="mi">3</code><code class="p">).</code><code class="nx">toString</code><code class="p">(</code><code class="mi">16</code><code class="p">));</code> <code class="c1">// 79</code>
</pre></div>

</div>

<p>This method works well when combined with iteration over strings:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">ch</code> <code class="nx">of</code> <code class="s1">'x\uD83D\uDE80y'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">ch</code><code class="p">.</code><code class="nx">codePointAt</code><code class="p">(</code><code class="mi">0</code><code class="p">).</code><code class="nx">toString</code><code class="p">(</code><code class="mi">16</code><code class="p">));</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// 78</code>
<code class="c1">// 1f680</code>
<code class="c1">// 79</code>
</pre></div>

</div>

<p>The opposite of <code>codePointAt()</code> is <code>String.fromCodePoint()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">String</code><code class="p">.</code><code class="n">fromCodePoint</code><code class="p">(</code><code class="mh">0x78</code><code class="p">,</code> <code class="mh">0x1f680</code><code class="p">,</code> <code class="mh">0x79</code><code class="p">)</code> <code class="o">===</code> <code class="err">'</code><code class="n">x</code><code class="err">\</code><code class="n">uD83D</code><code class="err">\</code><code class="n">uDE80y</code><code class="err">'</code>
<code class="nb">true</code>
</pre></div>

</div>

<h3 id="leanpub-auto-checking-for-containment-and-repeating-strings">
<span class="section-number">6.6 </span>Checking for containment and repeating strings</h3>

<p>Three new methods check whether a string exists within another string:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">.</code><code class="n">startsWith</code><code class="p">(</code><code class="err">'</code><code class="n">hell</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">.</code><code class="n">endsWith</code><code class="p">(</code><code class="err">'</code><code class="n">ello</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">.</code><code class="n">includes</code><code class="p">(</code><code class="err">'</code><code class="n">ell</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>Each of these methods has a position as an optional second parameter, which specifies where the string to be searched starts or ends:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">.</code><code class="n">startsWith</code><code class="p">(</code><code class="err">'</code><code class="n">ello</code><code class="err">'</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">.</code><code class="n">endsWith</code><code class="p">(</code><code class="err">'</code><code class="n">hell</code><code class="err">'</code><code class="p">,</code> <code class="mi">4</code><code class="p">)</code>
<code class="nb">true</code>

<code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">.</code><code class="n">includes</code><code class="p">(</code><code class="err">'</code><code class="n">ell</code><code class="err">'</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">.</code><code class="n">includes</code><code class="p">(</code><code class="err">'</code><code class="n">ell</code><code class="err">'</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>The <code>repeat()</code> method repeats strings:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="err">'</code><code class="n">doo</code> <code class="err">'</code><code class="p">.</code><code class="n">repeat</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>
<code class="err">'</code><code class="n">doo</code> <code class="n">doo</code> <code class="n">doo</code> <code class="err">'</code>
</pre></div>

</div>

<h3 id="leanpub-auto-all-new-string-methods">
<span class="section-number">6.7 </span>All new string methods</h3>

<p>Tagged templates:</p>

<ul>
<li>
<code>String.raw(callSite, ...substitutions) : string</code><br>
Template tag for “raw” content (backslashes are not interpreted).</li>
</ul>
<p>Unicode and code points:</p>

<ul>
<li>
<code>String.fromCodePoint(...codePoints : number[]) : string</code><br>
Turns numbers denoting Unicode code points into a string.</li>
  <li>
<code>String.prototype.codePointAt(pos) : number</code><br>
Returns the number of the code point starting at position <code>pos</code> (comprising one or two JavaScript characters).</li>
  <li>
<code>String.prototype.normalize(form? : string) : string</code><br>
Different combinations of code points may look the same. <a href="http://unicode.org/faq/normalization.html">Unicode normalization</a> changes them all to the same value(s), their so-called <em>canonical representation</em>. That helps with comparing and searching for strings. The <code>'NFC'</code> form is recommended for general text.</li>
</ul>
<p>Finding strings:</p>

<ul>
<li>
<code>String.prototype.startsWith(searchString, position=0) : boolean</code><br>
Does the receiver start with <code>searchString</code>? <code>position</code> lets you specify where the string to be checked starts.</li>
  <li>
<code>String.prototype.endsWith(searchString, endPosition=searchString.length) : boolean</code><br>
Does the receiver end with <code>searchString</code>? <code>endPosition</code> lets you specify where the string to be checked ends.</li>
  <li>
<code>String.prototype.includes(searchString, position=0) : boolean</code><br>
Does the receiver contain <code>searchString</code>? <code>position</code> lets you specify where the string to be searched starts.</li>
</ul>
<p>Repeating strings:</p>

<ul>
<li>
<code>String.prototype.repeat(count) : string</code><br>
Returns the receiver, concatenated <code>count</code> times.</li>
</ul>
<h2 id="ch_symbols">
<span class="section-number">7. </span>Symbols</h2>

<p>Symbols are a new primitive type in ECMAScript 6. This chapter explains how they work.</p>


<h3 id="leanpub-auto-overview-2">
<span class="section-number">7.1 </span>Overview</h3>

<h4 id="leanpub-auto-use-case-1-unique-property-keys">
<span class="section-number">7.1.1 </span>Use case 1: unique property keys</h4>

<p>Symbols are mainly used as unique property keys – a symbol never clashes with any other property key (symbol or string). For example, you can make an object <em>iterable</em> (usable via the <code>for-of</code> loop and other language mechanisms), by using the symbol stored in <code>Symbol.iterator</code> as the key of a method (more information on iterables is given in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_iteration">the chapter on iteration</a>):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">iterableObject</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code> <code class="c1">// (A)</code>
        <code class="kd">let</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'hello'</code><code class="p">,</code> <code class="s1">'world'</code><code class="p">];</code>
        <code class="kd">let</code> <code class="nx">index</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="k">return</code> <code class="p">{</code>
            <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="nx">index</code> <code class="o">&lt;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
                    <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">data</code><code class="p">[</code><code class="nx">index</code><code class="o">++</code><code class="p">]</code> <code class="p">};</code>
                <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                    <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">};</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterableObject</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// hello</code>
<code class="c1">// world</code>
</pre></div>

</div>

<p>In line A, a symbol is used as the key of the method. This unique marker makes the object iterable and enables us to use the <code>for-of</code> loop.</p>

<h4 id="leanpub-auto-use-case-2-constants-representing-concepts">
<span class="section-number">7.1.2 </span>Use case 2: constants representing concepts</h4>

<p>In ECMAScript 5, you may have used strings to represent concepts such as colors. In ES6, you can use symbols and be sure that they are always unique:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">COLOR_RED</code>    <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">COLOR_ORANGE</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">COLOR_YELLOW</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">COLOR_GREEN</code>  <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">COLOR_BLUE</code>   <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">COLOR_VIOLET</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>

<code class="kd">function</code> <code class="nx">getComplement</code><code class="p">(</code><code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">switch</code> <code class="p">(</code><code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">case</code> <code class="nx">COLOR_RED</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_GREEN</code><code class="p">;</code>
        <code class="k">case</code> <code class="nx">COLOR_ORANGE</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_BLUE</code><code class="p">;</code>
        <code class="k">case</code> <code class="nx">COLOR_YELLOW</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_VIOLET</code><code class="p">;</code>
        <code class="k">case</code> <code class="nx">COLOR_GREEN</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_RED</code><code class="p">;</code>
        <code class="k">case</code> <code class="nx">COLOR_BLUE</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_ORANGE</code><code class="p">;</code>
        <code class="k">case</code> <code class="nx">COLOR_VIOLET</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_YELLOW</code><code class="p">;</code>
        <code class="k">default</code><code class="o">:</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nx">Exception</code><code class="p">(</code><code class="s1">'Unknown color: '</code><code class="o">+</code><code class="nx">color</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>


<h3 id="leanpub-auto-a-new-primitive-type">
<span class="section-number">7.2 </span>A new primitive type</h3>

<p>ECMAScript 6 introduces a new primitive type: symbols. They are tokens that serve as unique IDs. You create symbols via the factory function <code>Symbol()</code> (which is loosely similar to <code>String</code> returning strings if called as a function):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">symbol1</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
</pre></div>

</div>

<p><code>Symbol()</code> has an optional string-valued parameter that lets you give the newly created Symbol a description:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">symbol2</code> <code class="o">=</code> <code class="n">Symbol</code><code class="p">(</code><code class="err">'</code><code class="n">symbol2</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">String</code><code class="p">(</code><code class="n">symbol2</code><code class="p">)</code>
<code class="err">'</code><code class="n">Symbol</code><code class="p">(</code><code class="n">symbol2</code><code class="p">)</code><code class="err">'</code>
</pre></div>

</div>

<p>Every symbol returned by <code>Symbol()</code> is unique, every symbol has its own identity:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Symbol</code><code class="p">()</code> <code class="o">===</code> <code class="n">Symbol</code><code class="p">()</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>You can see that symbols are primitive if you apply the <code>typeof</code> operator to one of them – it will return a new symbol-specific result:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">typeof</code> <code class="n">Symbol</code><code class="p">()</code>
<code class="err">'</code><code class="n">symbol</code><code class="err">'</code>
</pre></div>

</div>

<h4 id="leanpub-auto-symbols-as-property-keys">
<span class="section-number">7.2.1 </span>Symbols as property keys</h4>

<p>Symbols can be used as property keys:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">MY_KEY</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{};</code>

<code class="nx">obj</code><code class="p">[</code><code class="nx">MY_KEY</code><code class="p">]</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">obj</code><code class="p">[</code><code class="nx">MY_KEY</code><code class="p">]);</code> <code class="c1">// 123</code>
</pre></div>

</div>

<p>Classes and object literals have a feature called <em>computed property keys</em>: You can specify the key of a property via an expression, by putting it in square brackets. In the following object literal, we use a computed property key to make the value of <code>MY_KEY</code> the key of a property.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">MY_KEY</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">MY_KEY</code><code class="p">]</code><code class="o">:</code> <code class="mi">123</code>
<code class="p">};</code>
</pre></div>

</div>

<p>A method definition can also have a computed key:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">FOO</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">FOO</code><code class="p">]()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'bar'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">obj</code><code class="p">[</code><code class="nx">FOO</code><code class="p">]());</code> <code class="c1">// bar</code>
</pre></div>

</div>

<h4 id="leanpub-auto-enumerating-own-property-keys">
<span class="section-number">7.2.2 </span>Enumerating own property keys</h4>

<p>Given that there is now a new kind of value that can become the key of a property, the following terminology is used for ECMAScript 6:</p>

<ul>
<li>
<em>Property keys</em> are either strings or symbols.</li>
  <li>String-valued property keys are called <em>property names</em>.</li>
  <li>Symbol-valued property keys are called <em>property symbols</em>.</li>
</ul>
<p>Let’s examine the API for enumerating own property keys by first creating an object.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">Symbol</code><code class="p">(</code><code class="s1">'my_key'</code><code class="p">)]</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="kr">enum</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
    <code class="nx">nonEnum</code><code class="o">:</code> <code class="mi">3</code>
<code class="p">};</code>
<code class="nb">Object</code><code class="p">.</code><code class="nx">defineProperty</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code>
    <code class="s1">'nonEnum'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">enumerable</code><code class="o">:</code> <code class="kc">false</code> <code class="p">});</code>
</pre></div>

</div>

<p><code>Object.getOwnPropertyNames()</code> ignores symbol-valued property keys:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">getOwnPropertyNames</code><code class="p">(</code><code class="n">obj</code><code class="p">)</code>
<code class="p">[</code><code class="err">'</code><code class="k">enum</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">nonEnum</code><code class="err">'</code><code class="p">]</code>
</pre></div>

</div>

<p><code>Object.getOwnPropertySymbols()</code> ignores string-valued property keys:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">getOwnPropertySymbols</code><code class="p">(</code><code class="n">obj</code><code class="p">)</code>
<code class="p">[</code><code class="n">Symbol</code><code class="p">(</code><code class="n">my_key</code><code class="p">)]</code>
</pre></div>

</div>

<p><code>Reflect.ownKeys()</code> considers all kinds of keys:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Reflect</code><code class="p">.</code><code class="n">ownKeys</code><code class="p">(</code><code class="n">obj</code><code class="p">)</code>
<code class="p">[</code><code class="n">Symbol</code><code class="p">(</code><code class="n">my_key</code><code class="p">),</code> <code class="err">'</code><code class="k">enum</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">nonEnum</code><code class="err">'</code><code class="p">]</code>
</pre></div>

</div>

<p><code>Object.keys()</code> only considers enumerable property keys that are strings:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">keys</code><code class="p">(</code><code class="n">obj</code><code class="p">)</code>
<code class="p">[</code><code class="err">'</code><code class="k">enum</code><code class="err">'</code><code class="p">]</code>
</pre></div>

</div>

<p>The name <code>Object.keys</code> clashes with the new terminology (only string-valued keys are listed). <code>Object.names</code> or <code>Object.getEnumerableOwnPropertyNames</code> would be a better choice now.</p>


<h3 id="leanpub-auto-using-symbols-to-represent-concepts">
<span class="section-number">7.3 </span>Using symbols to represent concepts</h3>

<p>In ECMAScript 5, one often represents concepts (think enum constants) via strings. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">COLOR_RED</code>    <code class="o">=</code> <code class="s1">'RED'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">COLOR_ORANGE</code> <code class="o">=</code> <code class="s1">'ORANGE'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">COLOR_YELLOW</code> <code class="o">=</code> <code class="s1">'YELLOW'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">COLOR_GREEN</code>  <code class="o">=</code> <code class="s1">'GREEN'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">COLOR_BLUE</code>   <code class="o">=</code> <code class="s1">'BLUE'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">COLOR_VIOLET</code> <code class="o">=</code> <code class="s1">'VIOLET'</code><code class="p">;</code>
</pre></div>

</div>

<p>However, strings are not as unique as we’d like them to be. To see why, let’s look at the following function.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">getComplement</code><code class="p">(</code><code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">switch</code> <code class="p">(</code><code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">case</code> <code class="nx">COLOR_RED</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_GREEN</code><code class="p">;</code>
        <code class="k">case</code> <code class="nx">COLOR_ORANGE</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_BLUE</code><code class="p">;</code>
        <code class="k">case</code> <code class="nx">COLOR_YELLOW</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_VIOLET</code><code class="p">;</code>
        <code class="k">case</code> <code class="nx">COLOR_GREEN</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_RED</code><code class="p">;</code>
        <code class="k">case</code> <code class="nx">COLOR_BLUE</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_ORANGE</code><code class="p">;</code>
        <code class="k">case</code> <code class="nx">COLOR_VIOLET</code><code class="o">:</code>
            <code class="k">return</code> <code class="nx">COLOR_YELLOW</code><code class="p">;</code>
        <code class="k">default</code><code class="o">:</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nx">Exception</code><code class="p">(</code><code class="s1">'Unknown color: '</code><code class="o">+</code><code class="nx">color</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>It is noteworthy that you can use arbitrary expressions as <code>switch</code> cases, you are not limited in any way. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">isThree</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">switch</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">case</code> <code class="mi">1</code> <code class="o">+</code> <code class="mi">1</code> <code class="o">+</code> <code class="mi">1</code><code class="o">:</code>
            <code class="k">return</code> <code class="kc">true</code><code class="p">;</code>
        <code class="k">default</code><code class="o">:</code>
            <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>We use the flexibility that <code>switch</code> offers us and refer to the colors via our constants (<code>COLOR_RED</code> etc.) instead of hard-coding them (<code>'RED'</code> etc.).</p>

<p>Interestingly, even though we do so, there can still be mix-ups. For example, someone may define a constant for a mood:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">MOOD_BLUE</code> <code class="o">=</code> <code class="s1">'BLUE'</code><code class="p">;</code>
</pre></div>

</div>

<p>Now the value of <code>BLUE</code> is not unique anymore and <code>MOOD_BLUE</code> can be mistaken for it. If you use it as a parameter for <code>getComplement()</code>, it returns <code>'ORANGE'</code> where it should throw an exception.</p>

<p>Let’s use symbols to fix this example. Now we can also use <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_let-const">the ES6 feature <code>const</code></a>, which lets us declare actual constants (you can’t change what value is bound to a constant, but the value itself may be mutable).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">COLOR_RED</code>    <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">COLOR_ORANGE</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">COLOR_YELLOW</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">COLOR_GREEN</code>  <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">COLOR_BLUE</code>   <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">COLOR_VIOLET</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
</pre></div>

</div>

<p>Each value returned by <code>Symbol</code> is unique, which is why no other value can be mistaken for <code>BLUE</code> now. Intriguingly, the code of <code>getComplement()</code> doesn’t change at all if we use symbols instead of strings, which shows how similar they are.</p>


<h3 id="leanpub-auto-symbols-as-keys-of-properties">
<span class="section-number">7.4 </span>Symbols as keys of properties</h3>

<p>Being able to create properties whose keys never clash with other keys is useful in two situations:</p>

<ul>
<li>If several parties contribute internal properties to the same object, via mixins.</li>
  <li>To keep meta-level properties from clashing with base-level properties.</li>
</ul>
<h4 id="leanpub-auto-symbols-as-keys-of-internal-properties">
<span class="section-number">7.4.1 </span>Symbols as keys of internal properties</h4>

<p>Mixins are object fragments (sets of methods) that you can use to augment the functionality of an object or a prototype. If their methods have symbols as keys, they can’t clash with other methods (of other mixins or of the object that they are added to), anymore.</p>

<p>Public methods are seen by clients of the object a mixin is added to. For usability’s sake, you probably want those methods to have string keys. Internal methods are only known to the mixin or only needed to communicate with it. They profit from having symbols as keys.</p>

<p>Symbols do not offer real privacy, because it is easy to find out the symbol-valued property keys of an object. But the guarantee that a property key can’t ever clash with any other property key is often enough. If you truly want to prevent the outside from accessing private data, you need to use WeakMaps or closures. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// One WeakMap per private property</code>
<code class="kd">let</code> <code class="nx">_counter</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kd">let</code> <code class="nx">_action</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kr">class</code> <code class="nx">Countdown</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">counter</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">counter</code><code class="p">);</code>
        <code class="nx">_action</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">action</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="nx">dec</code><code class="p">()</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">counter</code> <code class="o">=</code> <code class="nx">_counter</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">counter</code> <code class="o">&lt;</code> <code class="mi">1</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>
        <code class="nx">counter</code><code class="o">--</code><code class="p">;</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">counter</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">counter</code> <code class="o">===</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">_action</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">)();</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The instances of <code>Countdown</code> are keys in the WeakMaps <code>_counter</code> and <code>_action</code>. The WeakMap does not prevent the instances from being garbage-collected. Entries whose keys are objects that don’t exist anymore, are removed from WeakMaps.</p>

<p>The same code looks as follows if you use a symbol key for the internal property.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">_counter</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">_action</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">class</code> <code class="nx">Countdown</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">counter</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">[</code><code class="nx">_counter</code><code class="p">]</code> <code class="o">=</code> <code class="nx">counter</code><code class="p">;</code>
        <code class="k">this</code><code class="p">[</code><code class="nx">_action</code><code class="p">]</code> <code class="o">=</code> <code class="nx">action</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">dec</code><code class="p">()</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">counter</code> <code class="o">=</code> <code class="k">this</code><code class="p">[</code><code class="nx">_counter</code><code class="p">];</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">counter</code> <code class="o">&lt;</code> <code class="mi">1</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>
        <code class="nx">counter</code><code class="o">--</code><code class="p">;</code>
        <code class="k">this</code><code class="p">[</code><code class="nx">_counter</code><code class="p">]</code> <code class="o">=</code> <code class="nx">counter</code><code class="p">;</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">counter</code> <code class="o">===</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">this</code><code class="p">[</code><code class="nx">_action</code><code class="p">]();</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-symbols-as-keys-of-meta-level-properties">
<span class="section-number">7.4.2 </span>Symbols as keys of meta-level properties</h4>

<p>Symbols having unique identities makes them ideal as keys of public properties that exist on a different level than “normal” property keys, because meta-level keys and normal keys must not clash. One example of meta-level properties are methods that objects can implement to customize how they are treated by a library. Using symbol keys protects the library from mistaking normal methods as customization methods.</p>

<p><em>Iterability</em> in ECMAScript 6 is one such customization. An object is <em>iterable</em> if it has a method whose key is the symbol (stored in) <code>Symbol.iterator</code>. In the following code, <code>obj</code> is iterable.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">data</code><code class="o">:</code> <code class="p">[</code> <code class="s1">'hello'</code><code class="p">,</code> <code class="s1">'world'</code> <code class="p">],</code>
    <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
        <code class="kr">const</code> <code class="nx">self</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code>
        <code class="kd">let</code> <code class="nx">index</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="k">return</code> <code class="p">{</code>
            <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="nx">index</code> <code class="o">&lt;</code> <code class="nx">self</code><code class="p">.</code><code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
                    <code class="k">return</code> <code class="p">{</code>
                        <code class="nx">value</code><code class="o">:</code> <code class="nx">self</code><code class="p">.</code><code class="nx">data</code><code class="p">[</code><code class="nx">index</code><code class="o">++</code><code class="p">]</code>
                    <code class="p">};</code>
                <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                    <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">};</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>The iterability of <code>obj</code> enables you to use the <code>for-of</code> loop and similar JavaScript features:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>

<code class="c1">// Output:</code>
<code class="c1">// hello</code>
<code class="c1">// world</code>
</pre></div>

</div>


<h3 id="leanpub-auto-crossing-realms-with-symbols">
<span class="section-number">7.5 </span>Crossing realms with symbols</h3>

<p>A <em>code realm</em> (short: realm) is a context in which pieces of code exist. It includes global variables, loaded modules and more. Even though code exists “inside” exactly one realm, it may have access to code in other realms. For example, each frame in a browser has its own realm. And execution can jump from one frame to another, as the following HTML demonstrates.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;script&gt;</code>
        <code class="kd">function</code> <code class="nx">test</code><code class="p">(</code><code class="nx">arr</code><code class="p">)</code> <code class="p">{</code>
            <code class="kd">var</code> <code class="nx">iframe</code> <code class="o">=</code> <code class="nx">frames</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
            <code class="c1">// This code and the iframe’s code exist in</code>
            <code class="c1">// different realms. Therefore, global variables</code>
            <code class="c1">// such as Array are different:</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">Array</code> <code class="o">===</code> <code class="nx">iframe</code><code class="p">.</code><code class="nb">Array</code><code class="p">);</code> <code class="c1">// false</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">arr</code> <code class="k">instanceof</code> <code class="nb">Array</code><code class="p">);</code> <code class="c1">// false</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">arr</code> <code class="k">instanceof</code> <code class="nx">iframe</code><code class="p">.</code><code class="nb">Array</code><code class="p">);</code> <code class="c1">// true</code>

            <code class="c1">// But: symbols are the same</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code> <code class="o">===</code>
                        <code class="nx">iframe</code><code class="p">.</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">);</code> <code class="c1">// true</code>
        <code class="p">}</code>
    <code class="nt">&lt;/script&gt;</code>
<code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;body&gt;</code>
    <code class="nt">&lt;iframe</code> <code class="na">srcdoc=</code><code class="s">"&lt;script&gt;window.parent.test([])&lt;/script&gt;"</code><code class="nt">&gt;</code>
<code class="nt">&lt;/iframe&gt;</code>
<code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>The problem is that each realm has its own local copy of <code>Array</code> and, because objects have individual identities, those local copies are considered different, even though they are essentially the same object. Similarly, libraries and user code are loaded once per realm and each realm has a different version of the same object.</p>

<p>In contrast, members of the primitive types boolean, number and string don’t have individual identities and multiple copies of the same value are not a problem: The copies are compared “by value” (by looking at the content, not at the identity) and are considered equal.</p>

<p>Symbols have individual identities and thus don’t travel across realms as smoothly as other primitive values. That is a problem for symbols such as <code>Symbol.iterator</code> that should work across realms: If an object is iterable in one realm, it should be iterable in others, too. If a cross-realm symbol is managed by the JavaScript engine, the engine can make sure that the same value is used in each realm. For libraries, however, we need extra support, which comes in the form of the <em>global symbol registry</em>: This registry is global to all realms and maps strings to symbols. For each symbol, libraries need to come up with a string that is as unique as possible. To create the symbol, they don’t use <code>Symbol()</code>, they ask the registry for the symbol that the string is mapped to. If the registry already has an entry for the string, the associated symbol is returned. Otherwise, entry and symbol are created first.</p>

<p>You ask the registry for a symbol via <code>Symbol.for()</code> and retrieve the string associated with a symbol (its <em>key</em>) via <code>Symbol.keyFor()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">sym</code> <code class="o">=</code> <code class="n">Symbol</code><code class="p">.</code><code class="k">for</code><code class="p">(</code><code class="err">'</code><code class="n">Hello</code> <code class="n">everybody</code><code class="o">!</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">Symbol</code><code class="p">.</code><code class="n">keyFor</code><code class="p">(</code><code class="n">sym</code><code class="p">)</code>
<code class="err">'</code><code class="n">Hello</code> <code class="n">everybody</code><code class="o">!</code><code class="err">'</code>
</pre></div>

</div>

<p>As expected, cross-realm symbols, such as <code>Symbol.iterator</code>, that are provided by the JavaScript engine are not in the registry:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Symbol</code><code class="p">.</code><code class="n">keyFor</code><code class="p">(</code><code class="n">Symbol</code><code class="p">.</code><code class="n">iterator</code><code class="p">)</code>
<code class="n">undefined</code>
</pre></div>

</div>


<h3 id="leanpub-auto-wrapper-objects-for-symbols">
<span class="section-number">7.6 </span>Wrapper objects for symbols</h3>

<p>While all other primitive values have literals, you need to create symbols by function-calling <code>Symbol</code>. Thus, it is relatively easy to accidentally invoke <code>Symbol</code> as a constructor. That produces instances of <code>Symbol</code> and is not very useful. Therefore, an exception is thrown when you try to do that:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">new</code> <code class="n">Symbol</code><code class="p">()</code>
<code class="nl">TypeError:</code> <code class="n">Symbol</code> <code class="n">is</code> <code class="n">not</code> <code class="n">a</code> <code class="n">constructor</code>
</pre></div>

</div>

<p>There is still a way to create wrapper objects, instances of <code>Symbol</code>: <code>Object</code>, called as a function, converts all values to objects, including symbols.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">sym</code> <code class="o">=</code> <code class="n">Symbol</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">typeof</code> <code class="n">sym</code>
<code class="err">'</code><code class="n">symbol</code><code class="err">'</code>

<code class="o">&gt;</code> <code class="n">let</code> <code class="n">wrapper</code> <code class="o">=</code> <code class="n">Object</code><code class="p">(</code><code class="n">sym</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">typeof</code> <code class="n">wrapper</code>
<code class="err">'</code><code class="n">object</code><code class="err">'</code>
<code class="o">&gt;</code> <code class="n">wrapper</code> <code class="n">instanceof</code> <code class="n">Symbol</code>
<code class="nb">true</code>
</pre></div>

</div>

<h4 id="leanpub-auto-property-access-via--">
<span class="section-number">7.6.1 </span>Property access via <code>[ ]</code>
</h4>

<p>The square bracket operator <code>[ ]</code> for accessing properties unwraps string wrapper objects and symbol wrapper objects. Let’s use the following object to examine this phenomenon.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">sym</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">(</code><code class="s1">'yes'</code><code class="p">);</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">sym</code><code class="p">]</code><code class="o">:</code> <code class="s1">'a'</code><code class="p">,</code>
    <code class="nx">str</code><code class="o">:</code> <code class="s1">'b'</code><code class="p">,</code>
<code class="p">};</code>
</pre></div>

</div>

<p>Interaction:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">wrappedSymbol</code> <code class="o">=</code> <code class="n">Object</code><code class="p">(</code><code class="n">sym</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">typeof</code> <code class="n">wrappedSymbol</code>
<code class="err">'</code><code class="n">object</code><code class="err">'</code>
<code class="o">&gt;</code> <code class="n">obj</code><code class="p">[</code><code class="n">wrappedSymbol</code><code class="p">]</code>
<code class="sc">'a'</code>

<code class="o">&gt;</code> <code class="n">let</code> <code class="n">wrappedString</code> <code class="o">=</code> <code class="n">new</code> <code class="n">String</code><code class="p">(</code><code class="err">'</code><code class="n">str</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">typeof</code> <code class="n">wrappedString</code>
<code class="err">'</code><code class="n">object</code><code class="err">'</code>
<code class="o">&gt;</code> <code class="n">obj</code><code class="p">[</code><code class="n">wrappedString</code><code class="p">]</code>
<code class="sc">'b'</code>
</pre></div>

</div>

<h5 id="leanpub-auto-property-access-in-the-spec">
<span class="section-number">7.6.1.1 </span>Property access in the spec</h5>

<p>The operator for getting and setting properties uses the internal operation <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-topropertykey"><code>ToPropertyKey()</code></a>, which works as follows:</p>

<ul>
<li>Convert the operand to a primitive via <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-toprimitive"><code>ToPrimitive()</code></a> with the preferred type <code>string</code>:
    <ul>
<li>Primitive values are returned as is.</li>
      <li>Most objects are converted via the method <code>toString()</code> – if it returns a primitive value. Otherwise, <code>valueOf()</code> is used – if it returns a primitive value. Otherwise, a <code>TypeError</code> is thrown.</li>
      <li>Symbol objects are one exception: they are converted to the symbols that they wrap.</li>
    </ul>
</li>
  <li>If the result is a symbol, return it.</li>
  <li>Otherwise, coerce the result to string via <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-tostring"><code>ToString()</code></a>.</li>
</ul>
<h3 id="leanpub-auto-converting-symbols-to-other-primitive-types">
<span class="section-number">7.7 </span>Converting symbols to other primitive types</h3>

<p>The following table shows what happens if you explicitly or implicitly convert symbols to other primitive types:</p>

<table>
<thead><tr>
<th>Conversion to</th>
      <th>Explicit conversion</th>
      <th>Coercion (implicit conversion)</th>
    </tr></thead>
<tbody>
<tr>
<td>boolean</td>
      <td>
<code>Boolean(sym)</code> → OK</td>
      <td>
<code>!sym</code> → OK</td>
    </tr>
<tr>
<td>number</td>
      <td>
<code>Number(sym)</code> → <code>TypeError</code>
</td>
      <td>
<code>sym*2</code> → <code>TypeError</code>
</td>
    </tr>
<tr>
<td>string</td>
      <td>
<code>String(sym)</code> → OK</td>
      <td>
<code>''+sym</code> → <code>TypeError</code>
</td>
    </tr>
</tbody>
</table>
<h4 id="leanpub-auto-pitfall-coercion-to-string">
<span class="section-number">7.7.1 </span>Pitfall: coercion to string</h4>

<p>Coercion to string being forbidden can easily trip you up:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">sym</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'A symbol: '</code><code class="o">+</code><code class="nx">sym</code><code class="p">);</code> <code class="c1">// TypeError</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">A</code> <code class="nx">symbol</code><code class="o">:</code> <code class="nx">$</code><code class="p">{</code><code class="nx">sym</code><code class="p">}</code><code class="err">`</code><code class="p">);</code> <code class="c1">// TypeError</code>
</pre></div>

</div>

<p>To fix these problems, you need an explicit conversion to string:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'A symbol: '</code><code class="o">+</code><code class="nb">String</code><code class="p">(</code><code class="nx">sym</code><code class="p">));</code> <code class="c1">// OK</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">A</code> <code class="nx">symbol</code><code class="o">:</code> <code class="nx">$</code><code class="p">{</code><code class="nb">String</code><code class="p">(</code><code class="nx">sym</code><code class="p">)}</code><code class="err">`</code><code class="p">);</code> <code class="c1">// OK</code>
</pre></div>

</div>

<h4 id="leanpub-auto-making-sense-of-the-coercion-rules">
<span class="section-number">7.7.2 </span>Making sense of the coercion rules</h4>

<p>Coercion (implicit conversion) is often forbidden for symbols. This section explains why.</p>

<h5 id="leanpub-auto-truthiness-checks-are-allowed">
<span class="section-number">7.7.2.1 </span>Truthiness checks are allowed</h5>

<p>Coercion to boolean is always allowed, mainly to enable truthiness checks in <code>if</code> statements and other locations:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>

<code class="nx">param</code> <code class="o">=</code> <code class="nx">param</code> <code class="o">||</code> <code class="mi">0</code><code class="p">;</code>
</pre></div>

</div>

<h5 id="leanpub-auto-accidentally-turning-symbols-into-property-keys">
<span class="section-number">7.7.2.2 </span>Accidentally turning symbols into property keys</h5>

<p>Symbols are special property keys, which is why you want to avoid accidentally converting them to strings, which are a different kind of property keys. This could happen if you use the addition operator to compute the name of a property:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">myObject</code><code class="p">[</code><code class="s1">'__'</code> <code class="o">+</code> <code class="nx">value</code><code class="p">]</code>
</pre></div>

</div>

<p>That’s why a <code>TypeError</code> is thrown if <code>value</code> is a symbol.</p>

<h5 id="leanpub-auto-accidentally-turning-symbols-into-array-indices">
<span class="section-number">7.7.2.3 </span>Accidentally turning symbols into Array indices</h5>

<p>You also don’t want to accidentally turn symbols into Array indices. The following is code where that could happen if <code>value</code> is a symbol:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">myArray</code><code class="p">[</code><code class="mi">1</code> <code class="o">+</code> <code class="nx">value</code><code class="p">]</code>
</pre></div>

</div>

<p>That’s why the addition operator throws an error in this case.</p>

<h4 id="leanpub-auto-explicit-and-implicit-conversion-in-the-spec">
<span class="section-number">7.7.3 </span>Explicit and implicit conversion in the spec</h4>

<h5 id="leanpub-auto-converting-to-boolean">
<span class="section-number">7.7.3.1 </span>Converting to boolean</h5>

<p>To explicitly convert a symbol to boolean, you call <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-boolean-constructor-boolean-value"><code>Boolean()</code></a>, which returns <code>true</code> for symbols:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="k">const</code> <code class="n">sym</code> <code class="o">=</code> <code class="n">Symbol</code><code class="p">(</code><code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">Boolean</code><code class="p">(</code><code class="n">sym</code><code class="p">)</code>
<code class="nb">true</code>
</pre></div>

</div>

<p><code>Boolean()</code> computes its result via the internal operation <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-toboolean"><code>ToBoolean()</code></a>, which returns <code>true</code> for symbols and other truthy values.</p>

<p>Coercion also uses <code>ToBoolean()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="o">!</code><code class="n">sym</code>
<code class="nb">false</code>
</pre></div>

</div>

<h5 id="leanpub-auto-converting-to-number">
<span class="section-number">7.7.3.2 </span>Converting to number</h5>

<p>To explicitly convert a symbol to number, you call <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-number-constructor-number-value"><code>Number()</code></a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="k">const</code> <code class="n">sym</code> <code class="o">=</code> <code class="n">Symbol</code><code class="p">(</code><code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">Number</code><code class="p">(</code><code class="n">sym</code><code class="p">)</code>
<code class="nl">TypeError:</code> <code class="n">can</code><code class="err">'</code><code class="n">t</code> <code class="n">convert</code> <code class="n">symbol</code> <code class="n">to</code> <code class="n">number</code>
</pre></div>

</div>

<p><code>Number()</code> computes its result via the internal operation <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-tonumber"><code>ToNumber()</code></a>, which throws a <code>TypeError</code> for symbols.</p>

<p>Coercion also uses <code>ToNumber()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="o">+</code><code class="n">sym</code>
<code class="nl">TypeError:</code> <code class="n">can</code><code class="err">'</code><code class="n">t</code> <code class="n">convert</code> <code class="n">symbol</code> <code class="n">to</code> <code class="n">number</code>
</pre></div>

</div>

<h5 id="leanpub-auto-converting-to-string">
<span class="section-number">7.7.3.3 </span>Converting to string</h5>

<p>To explicitly convert a symbol to string, you call <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-string-constructor-string-value"><code>String()</code></a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="k">const</code> <code class="n">sym</code> <code class="o">=</code> <code class="n">Symbol</code><code class="p">(</code><code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">String</code><code class="p">(</code><code class="n">sym</code><code class="p">)</code>
<code class="err">'</code><code class="n">Symbol</code><code class="p">(</code><code class="n">hello</code><code class="p">)</code><code class="err">'</code>
</pre></div>

</div>

<p>If the parameter of <code>String()</code> is a symbol then it handles the conversion to string itself and returns the string <code>Symbol()</code> wrapped around the description that was provided when creating the symbol. If no description was given, the empty string is used:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">String</code><code class="p">(</code><code class="n">Symbol</code><code class="p">())</code>
<code class="err">'</code><code class="n">Symbol</code><code class="p">()</code><code class="err">'</code>
</pre></div>

</div>

<p>The <code>toString()</code> method returns the same string as <code>String()</code>, but neither of these two operations calls the other one, they both call the same internal operation <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-symboldescriptivestring"><code>SymbolDescriptiveString()</code></a>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Symbol</code><code class="p">(</code><code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">).</code><code class="n">toString</code><code class="p">()</code>
<code class="err">'</code><code class="n">Symbol</code><code class="p">(</code><code class="n">hello</code><code class="p">)</code><code class="err">'</code>
</pre></div>

</div>

<p>Coercion is handled via via the internal operation <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-tostring"><code>ToString()</code></a>, which throws a <code>TypeError</code> for symbols. One method that coerces its parameter to string is <code>Number.parseInt()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Number</code><code class="p">.</code><code class="n">parseInt</code><code class="p">(</code><code class="n">Symbol</code><code class="p">())</code>
<code class="nl">TypeError:</code> <code class="n">can</code><code class="err">'</code><code class="n">t</code> <code class="n">convert</code> <code class="n">symbol</code> <code class="n">to</code> <code class="n">string</code>
</pre></div>

</div>

<h5 id="leanpub-auto-not-allowed-converting-via-the-binary-addition-operator-">
<span class="section-number">7.7.3.4 </span>Not allowed: converting via the binary addition operator (<code>+</code>)</h5>

<p>The <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-addition-operator-plus">addition operator</a> works as follows:</p>

<ul>
<li>Convert both operands to primitives.</li>
  <li>If one of the operands is a string, coerce both operands to strings (via <code>ToString()</code>), concatenate them and return the result.</li>
  <li>Otherwise, coerce both operands to numbers, add them and return the result.</li>
</ul>
<p>Coercion to either string or number throws an exception, which means that you can’t (directly) use the addition operator for symbols:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="err">''</code> <code class="o">+</code> <code class="n">Symbol</code><code class="p">()</code>
<code class="nl">TypeError:</code> <code class="n">can</code><code class="err">'</code><code class="n">t</code> <code class="n">convert</code> <code class="n">symbol</code> <code class="n">to</code> <code class="n">string</code>
<code class="o">&gt;</code> <code class="mi">1</code> <code class="o">+</code> <code class="n">Symbol</code><code class="p">()</code>
<code class="nl">TypeError:</code> <code class="n">can</code><code class="err">'</code><code class="n">t</code> <code class="n">convert</code> <code class="n">symbol</code> <code class="n">to</code> <code class="n">number</code>
</pre></div>

</div>


<h3 id="leanpub-auto-json-and-symbols">
<span class="section-number">7.8 </span>JSON and symbols</h3>

<h4 id="leanpub-auto-generating-json-via-jsonstringify">
<span class="section-number">7.8.1 </span>Generating JSON via <code>JSON.stringify()</code>
</h4>

<p><code>JSON.stringify()</code> converts JavaScript data to JSON strings. A preprocessing step lets you customize that conversion: a callback, a so-called <em>replacer</em>, can replace any value inside the JavaScript data with another one. That means that it can encode JSON-incompatible values (such as symbols and dates) as JSON-compatible values (such as strings). <code>JSON.parse()</code> lets you reverse this process via a similar mechanism<sup id="fnref-symbols_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-symbols_1" rel="footnote">1</a></sup>.</p>

<p>However, <code>stringify</code> ignores non-string property keys, so this approach works only if symbols are property values. For example, like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">symbolReplacer</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">value</code> <code class="o">===</code> <code class="s1">'symbol'</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'@@'</code> <code class="o">+</code> <code class="nx">Symbol</code><code class="p">.</code><code class="nx">keyFor</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'@@'</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">value</code><code class="p">;</code>
<code class="p">}</code>
<code class="kr">const</code> <code class="nx">MY_SYMBOL</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">.</code><code class="k">for</code><code class="p">(</code><code class="s1">'http://example.com/my_symbol'</code><code class="p">);</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="p">[</code><code class="nx">MY_SYMBOL</code><code class="p">]</code><code class="o">:</code> <code class="mi">123</code> <code class="p">};</code>

<code class="kd">let</code> <code class="nx">str</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">symbolReplacer</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">str</code><code class="p">);</code>
</pre></div>

</div>

<p>A symbol is encoded as a string by putting <code>'@@'</code> before and after the symbol’s key. Note that only symbols that were created via <code>Symbol.for()</code> have such a key.</p>

<h4 id="leanpub-auto-parsing-json-via-jsonparse">
<span class="section-number">7.8.2 </span>Parsing JSON via <code>JSON.parse()</code>
</h4>

<p><code>JSON.parse()</code> converts JSON strings to JavaScript data. A postprocessing step lets you customize that conversion: a callback, a so-called <em>reviver</em>, can replace any value inside the initial output with another one. That means that it can decode non-JSON data (such as symbols and dates) stored in JSON data (such as strings)<sup id="fnref-symbols_2"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-symbols_2" rel="footnote">2</a></sup>. This looks as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">REGEX_SYMOBL_STRING</code> <code class="o">=</code> <code class="sr">/^@@(.*)@@$/</code><code class="p">;</code>
<code class="kd">function</code> <code class="nx">symbolReviver</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">value</code> <code class="o">===</code> <code class="s1">'string'</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">match</code> <code class="o">=</code> <code class="nx">REGEX_SYMOBL_STRING</code><code class="p">.</code><code class="nx">test</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">match</code><code class="p">)</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">symbolKey</code> <code class="o">=</code> <code class="nx">match</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>
            <code class="k">return</code> <code class="nx">Symbol</code><code class="p">.</code><code class="k">for</code><code class="p">(</code><code class="nx">symbolKey</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">value</code><code class="p">;</code>
<code class="p">}</code>

<code class="kd">let</code> <code class="nx">parsed</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">str</code><code class="p">,</code> <code class="nx">symbolReviver</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">parse</code><code class="p">);</code>
</pre></div>

</div>

<p>Strings that start and end with <code>'@@'</code> are converted to symbols by extracting the symbol key in the middle.</p>


<h3 id="leanpub-auto-faq-symbols">
<span class="section-number">7.9 </span>FAQ: symbols</h3>

<h4 id="leanpub-auto-can-i-use-symbols-to-define-private-properties">
<span class="section-number">7.9.1 </span>Can I use symbols to define private properties?</h4>

<p>The original plan was for symbols to support private properties, but that feature was dropped, because it would have interacted badly with proxies. The chapter on classes explains <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_private-data-for-classes">your options for keeping data private in instances of classes</a>: store it in constructor environments, in properties with marked keys or in WeakMaps.</p>

<h4 id="leanpub-auto-are-symbols-primitives-or-objects">
<span class="section-number">7.9.2 </span>Are symbols primitives or objects?</h4>

<p>In some ways, symbols are like primitive values, in other ways, they are like objects:</p>

<ul>
<li>Symbols are like strings (primitive values) w.r.t. what they are used for: as representations of concepts and as property keys.</li>
  <li>Symbols are like objects in that each symbol has its own identity.</li>
</ul>
<p>What are symbols then – primitive values or objects? In the end, they were turned into primitives, for two reasons.</p>

<p>First, symbols are more like strings than like objects: They are a fundamental value of the language, they are immutable and they can be used as property keys. Symbols having unique identities doesn’t necessarily contradict them being like strings: UUID algorithms produce strings that are quasi-unique.</p>

<p>Second, symbols are most often used as property keys, so it makes sense to optimize the JavaScript specification and the implementations for that use case. Then many abilities of objects are unnecessary:</p>

<ul>
<li>Objects can become prototypes of other objects.</li>
  <li>Wrapping an object with a proxy doesn’t change what it can be used for.</li>
  <li>Objects can be introspected: via <code>instanceof</code>, <code>Object.keys()</code>, etc.</li>
</ul>
<p>Them not having these abilities makes life easier for the specification and the implementations. There are also reports from the V8 team that when handling property keys, it is simpler to treat primitives differently than objects.</p>

<h4 id="leanpub-auto-do-we-really-need-symbols-arent-strings-enough">
<span class="section-number">7.9.3 </span>Do we really need symbols? Aren’t strings enough?</h4>

<p>In contrast to strings, symbols are unique and prevent name clashes. That is nice to have for tokens such as colors, but it is essential for supporting meta-level methods such as the one whose key is <code>Symbol.iterator</code>. Python uses the special name <code>__iter__</code> to avoid clashes. You can reserve double underscore names for programming language mechanisms, but what is a library to do? With symbols, we have an extensibility mechanism that works for everyone. As you can see later, in the section on public symbols, JavaScript itself already makes ample use of this mechanism.</p>

<p>There is one hypothetical alternative to symbols when it comes to clash-free property keys: use a naming convention. For example, strings with URLs (e.g. <code>'http://example.com/iterator'</code>). But that would introduce a second category of property keys (versus “normal” property names that are usually valid identifiers and don’t contain colons, slashes, dots, etc.), which is basically what symbols are, anyway. Thus it is more elegant to explicitly turn those keys into a different kind of value.</p>

<h4 id="leanpub-auto-are-javascripts-symbols-like-rubys-symbols">
<span class="section-number">7.9.4 </span>Are JavaScript’s symbols like Ruby’s symbols?</h4>

<p>No, they are not. Ruby’s symbols are more like JavaScript’s string literals – which are immutable and often <em>interned</em>: If the same string literal appears in several locations, storage space is reused. JavaScript engines manage this via a table mapping string values to storage locations.</p>


<h3 id="leanpub-auto-the-symbol-api">
<span class="section-number">7.10 </span>The symbol API</h3>

<p>This section gives an overview of the ECMAScript 6 API for symbols.</p>

<h4 id="leanpub-auto-the-function-symbol">
<span class="section-number">7.10.1 </span>The function <code>Symbol</code>
</h4>

<ul>
<li>
<code>Symbol(description?) : symbol</code><br>
Creates a new symbol. The optional parameter <code>description</code> allows you to give the symbol a description, which is useful for debugging.</li>
</ul>
<p><code>Symbol</code> is not intended to be used as a constructor – an exception is thrown if you invoke it via <code>new</code>.</p>

<h4 id="leanpub-auto-public-symbols">
<span class="section-number">7.10.2 </span>Public symbols</h4>

<p><a href="http://www.ecma-international.org/ecma-262/6.0/#sec-well-known-symbols">Several public symbols</a> can be accessed via properties of <code>Symbol</code>. They are all used as property keys and enable you to customize how JavaScript handles an object.</p>

<p>Customizing basic language operations:</p>

<ul>
<li>
<code>Symbol.hasInstance</code> (method)<br>
Lets an object <code>C</code> customize the behavior of <code>x instanceof C</code>.</li>
  <li>
<code>Symbol.toPrimitive</code> (method)<br>
Lets an object customize how it is converted to a primitive value. This is the first step whenever something is coerced to a primitive type (via operators etc.).</li>
  <li>
<code>Symbol.toStringTag</code> (string)<br>
Called by <code>Object.prototype.toString</code> to compute the default string description of an object <code>obj</code>: ‘[object ‘+obj[Symbol.toStringTag]+’]’.</li>
</ul>
<p><strong>Iteration</strong> (explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_iteration">the chapter on iteration</a>):</p>

<ul>
<li>
<code>Symbol.iterator</code> (method)<br>
Makes an object iterable. Returns an iterator.</li>
</ul>
<p><strong>Regular expressions:</strong> Four string methods that have regular expression parameters are simply forwarded to those parameters. The methods that they are forwarded to have the following keys:</p>

<ul>
<li>
<code>Symbol.match</code> is used by <code>String.prototype.match</code>.</li>
  <li>
<code>Symbol.replace</code> is used by <code>String.prototype.replace</code>.</li>
  <li>
<code>Symbol.search</code> is used by <code>String.prototype.search</code>.</li>
  <li>
<code>Symbol.split</code> is used by <code>String.prototype.split</code>.</li>
</ul>
<p><strong>Miscellaneous:</strong></p>

<ul>
<li>
<code>Symbol.unscopables</code> (Object)<br>
Lets an object hide some properties from the <code>with</code> statement.</li>
  <li>
<code>Symbol.species</code> (method)<br>
Helps with cloning Typed Arrays and instances of <code>RegExp</code>, <code>ArrayBuffer</code> and <code>Promise</code>. Details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_species-pattern">the chapter on classes</a>.</li>
  <li>
<code>Symbol.isConcatSpreadable</code> (boolean)<br>
Indicates whether <code>Array.prototype.concat</code> should concatenate the indexed elements of an object or the object as an element.</li>
</ul>
<h4 id="leanpub-auto-global-symbol-registry">
<span class="section-number">7.10.3 </span>Global symbol registry</h4>

<p>If you want a symbol to be the same in all realms, you need to create it via the global symbol registry. The following method lets you do that:</p>

<ul>
<li>
<code>Symbol.for(str) : symbol</code><br>
Returns the symbol whose key is the string <code>str</code> in the registry. If <code>str</code> isn’t in the registry yet, a new symbol is created and filed in the registry under the key <code>str</code>.</li>
</ul>
<p>Another method lets you make the reverse look up and found out under which key a string is stored in the registry. This is may be useful for serializing symbols.</p>

<ul>
<li>
<code>Symbol.keyFor(sym) : string</code><br>
returns the string that is associated with the symbol <code>sym</code> in the registry. If <code>sym</code> isn’t in the registry, this method returns <code>undefined</code>.</li>
</ul>
<div class="footnotes">
  <ol>
<li id="fn-symbols_1">[Speaking JS] Details are explained in <a href="http://speakingjs.com/es5/ch22.html#JSON.stringify">the chapter on JSON</a>.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-symbols_1" rel="rev-footnote">↩</a>
</li>
    <li id="fn-symbols_2">[Speaking JS] The details are explained in <a href="http://speakingjs.com/es5/ch22.html#JSON.parse">the chapter on JSON</a>.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-symbols_2" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h2 id="ch_template-literals">
<span class="section-number">8. </span>Template literals and tagged templates</h2>

<p>This chapter covers two new kinds of literals: template literals and tagged templates.</p>


<h3 id="leanpub-auto-overview-3">
<span class="section-number">8.1 </span>Overview</h3>

<p>The following three things are different – despite names and appearances being similar:</p>

<ul>
<li>Web templates (data): HTML with blanks to be filled in</li>
  <li>Template literals (code): multi-line string literals plus interpolation</li>
  <li>Tagged templates (code): function calls</li>
</ul>
<p>Template literals are string literals that can stretch across multiple lines and include interpolated expressions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">firstName</code> <code class="o">=</code> <code class="s1">'Jane'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">Hello</code> <code class="nx">$</code><code class="p">{</code><code class="nx">firstName</code><code class="p">}</code><code class="o">!</code>
<code class="nx">How</code> <code class="nx">are</code> <code class="nx">you</code>
<code class="nx">today</code><code class="o">?</code><code class="err">`</code><code class="p">);</code>

<code class="c1">// Output:</code>
<code class="c1">// Hello Jane!</code>
<code class="c1">// How are you</code>
<code class="c1">// today?</code>
</pre></div>

</div>

<p>Tagged templates are created by mentioning a function before a template literal. They lead to a function call where the prefix is called and the template literal supplies the parameters:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">String</code><code class="p">.</code><code class="n">raw</code><code class="err">`</code><code class="n">A</code> <code class="err">\</code><code class="n">tagged</code><code class="err">\</code> <code class="n">template</code><code class="err">`</code>
<code class="err">'</code><code class="n">A</code> <code class="err">\\</code><code class="n">tagged</code><code class="err">\\</code> <code class="n">template</code><code class="err">'</code>
</pre></div>

</div>


<h3 id="leanpub-auto-introduction">
<span class="section-number">8.2 </span>Introduction</h3>

<p>Literals are syntactic constructs that produce values. Examples include string literals (which produce strings) and regular expression literals (which produce regular expression objects). ECMAScript 6 has two new literals:</p>

<ul>
<li>Template literals: are string literals with support for interpolation and multiple lines.</li>
  <li>Tagged templates: are function calls whose parameters are provided via template literals.</li>
</ul>
<p>It is important to keep in mind that the names of template literals and tagged templates are slightly misleading. They have nothing to do with <em>templates</em>, as they are often used in web development: text files with blanks that can be filled in via (e.g.) JSON data.</p>

<h4 id="leanpub-auto-template-literals">
<span class="section-number">8.2.1 </span>Template literals</h4>

<p>A template literal is a new kind of string literal that can span multiple lines and <em>interpolate</em> expressions (include their results). For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">firstName</code> <code class="o">=</code> <code class="s1">'Jane'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">Hello</code> <code class="nx">$</code><code class="p">{</code><code class="nx">firstName</code><code class="p">}</code><code class="o">!</code>
<code class="nx">How</code> <code class="nx">are</code> <code class="nx">you</code>
<code class="nx">today</code><code class="o">?</code><code class="err">`</code><code class="p">);</code>

<code class="c1">// Output:</code>
<code class="c1">// Hello Jane!</code>
<code class="c1">// How are you</code>
<code class="c1">// today?</code>
</pre></div>

</div>

<p>The literal itself is delimited by backticks (<code>`</code>), the interpolated expressions inside the literal are delimited by <code>${</code> and <code>}</code>. Template literals always produce strings.</p>

<h4 id="leanpub-auto-tagged-templates">
<span class="section-number">8.2.2 </span>Tagged templates</h4>

<p>The following is a tagged template:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">tagFunction</code><code class="err">`</code><code class="nx">Hello</code> <code class="nx">$</code><code class="p">{</code><code class="nx">firstName</code><code class="p">}</code> <code class="nx">$</code><code class="p">{</code><code class="nx">lastName</code><code class="p">}</code><code class="o">!</code><code class="err">`</code>
</pre></div>

</div>

<p>Putting a template literal after an expression calls the expression. That is similar to the effect of parameter lists (comma-separated values in parentheses). The previous code executes the following function call (in reality, the function receives more information, but that is explained later):</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">tagFunction</code><code class="p">([</code><code class="s1">'Hello '</code><code class="p">,</code> <code class="s1">' '</code><code class="p">,</code> <code class="s1">'!'</code><code class="p">],</code> <code class="nx">firstName</code><code class="p">,</code> <code class="nx">lastName</code><code class="p">)</code>
</pre></div>

</div>

<p>Thus, the name before the content in backquotes is the name of a function to call, the <em>tag function</em>. The tag function receives two different kinds of data:</p>

<ul>
<li>
<em>Template strings</em> such as <code>'Hello '</code>.</li>
  <li>
<em>Substitutions</em> such as <code>firstName</code> (delimited by a dollar sign and braces). A substitution can be any expression.</li>
</ul>
<p>Template strings are known statically (at compile time), substitutions are only known at runtime. The tag function can do with its parameters as it pleases: It can completely ignore the template strings, return values of any type, etc.</p>


<h3 id="leanpub-auto-examples-of-using-tagged-templates">
<span class="section-number">8.3 </span>Examples of using tagged templates</h3>

<p>To understand what tagged templates are good for, let’s look at examples. You’ll find that tagged templates allow you to implement custom embedded sub-languages (which are sometimes called <em>domain-specific languages</em>) with little effort, because JavaScript does much of the parsing for you. You only have to write a function that receives the results.</p>

<p>Some of the following examples are borrowed from <a href="http://wiki.ecmascript.org/doku.php?id=harmony:quasis">the original proposal</a> for template literals and tagged templates, which refers to them via their old name, <em>quasi-literals</em>.</p>


<h4 id="leanpub-auto-raw-strings">
<span class="section-number">8.3.1 </span>Raw strings</h4>

<p>ES6 includes the tag function <code>String.raw</code> for <em>raw strings</em>, where backslashes have no special meaning:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">str</code> <code class="o">=</code> <code class="nb">String</code><code class="p">.</code><code class="nx">raw</code><code class="err">`</code><code class="nx">This</code> <code class="nx">is</code> <code class="nx">a</code> <code class="nx">text</code>
<code class="kd">with</code> <code class="nx">multiple</code> <code class="nx">lines</code><code class="p">.</code>
<code class="nx">Escapes</code> <code class="nx">are</code> <code class="nx">not</code> <code class="nx">interpreted</code><code class="p">,</code>
<code class="err">\</code><code class="nx">n</code> <code class="nx">is</code> <code class="nx">not</code> <code class="nx">a</code> <code class="nx">newline</code><code class="p">.</code><code class="err">`</code><code class="p">;</code>
</pre></div>

</div>


<h4 id="leanpub-auto-escaping-parts-of-a-regular-expression">
<span class="section-number">8.3.2 </span>Escaping parts of a regular expression</h4>

<p>There are two ways of creating regular expression instances.</p>

<ul>
<li>Statically, via a regular expression literal: <code>/^abc$/i</code>
</li>
  <li>Dynamically, via the <code>RegExp</code> constructor:  <code>new RegExp('^abc$', i)</code>
</li>
</ul>
<p>If you use the latter, it is because you have to wait until runtime so that all necessary ingredients are available: You are usually concatenating regular expression fragments and text that is to be matched verbatim. The latter has to be escaped properly (dots, square brackets, etc.). A regular expression tag function <code>escRegExp</code> can help with this task:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">NUMBER</code> <code class="o">=</code> <code class="nx">escRegExp</code><code class="err">`\</code><code class="nx">d</code><code class="o">+</code><code class="p">(</code><code class="nx">$</code><code class="p">{</code><code class="nx">localeSpecificDecimalPoint</code><code class="p">}</code><code class="err">\</code><code class="nx">d</code><code class="o">+</code><code class="p">)</code><code class="o">?</code><code class="err">`</code><code class="p">;</code>
</pre></div>

</div>

<p>A simple implementation of <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_escRegExp"><code>escRegExp</code></a> is shown later.</p>


<h4 id="leanpub-auto-tagged-templates-for-more-powerful-regular-expressions">
<span class="section-number">8.3.3 </span>Tagged templates for more powerful regular expressions</h4>

<p>Steven Levithan has given <a href="https://gist.github.com/4222600">an example</a> of how tagged templates could be used for his regular expression library <a href="http://xregexp.com/">XRegExp</a>.</p>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <p>XRegExp is highly recommended if you are working with regular expressions. You get many advanced features, but there is only a small performance penalty – once at creation time – because XRegExp compiles its input to native regular expressions.</p>

    </td>
  </tr></tbody></table>
<p>Without tagged templates, you write code such as the following:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">parts</code> <code class="o">=</code> <code class="s1">'/2012/10/Page.html'</code><code class="p">.</code><code class="nx">match</code><code class="p">(</code><code class="nx">XRegExp</code><code class="p">(</code>
  <code class="s1">'^ # match at start of string only \n'</code> <code class="o">+</code>
  <code class="s1">'/ (?&lt;year&gt; [^/]+ ) # capture top dir name as year \n'</code> <code class="o">+</code>
  <code class="s1">'/ (?&lt;month&gt; [^/]+ ) # capture subdir name as month \n'</code> <code class="o">+</code>
  <code class="s1">'/ (?&lt;title&gt; [^/]+ ) # capture base name as title \n'</code> <code class="o">+</code>
  <code class="s1">'\\.html? $ # .htm or .html file ext at end of path '</code><code class="p">,</code> <code class="s1">'x'</code>
<code class="p">));</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">parts</code><code class="p">.</code><code class="nx">year</code><code class="p">);</code> <code class="c1">// 2012</code>
</pre></div>

</div>

<p>We can see that XRegExp gives us named groups (<code>year</code>, <code>month</code>, <code>title</code>) and the <code>x</code> flag. With that flag, most whitespace is ignored and comments can be inserted.</p>

<p>There are two reasons that string literals don’t work well here. First, we have to type every regular expression backslash twice, to escape it for the string literal. Second, it is cumbersome to enter multiple lines: Instead of adding strings, you could also end the line with a backslash. But that is brittle and you still have to explicitly add newlines via <code>\n</code>. These two problems go away with tagged templates:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">parts</code> <code class="o">=</code> <code class="s1">'/2012/10/Page.html'</code><code class="p">.</code><code class="nx">match</code><code class="p">(</code><code class="nx">XRegExp</code><code class="p">.</code><code class="nx">rx</code><code class="err">`</code>
    <code class="o">^</code> <code class="err">#</code> <code class="nx">match</code> <code class="nx">at</code> <code class="nx">start</code> <code class="nx">of</code> <code class="nx">string</code> <code class="nx">only</code>
    <code class="o">/</code> <code class="p">(</code><code class="o">?&lt;</code><code class="nx">year</code><code class="o">&gt;</code> <code class="p">[</code><code class="o">^</code><code class="err">/]+ ) # capture top dir name as year</code>
    <code class="o">/</code> <code class="p">(</code><code class="o">?&lt;</code><code class="nx">month</code><code class="o">&gt;</code> <code class="p">[</code><code class="o">^</code><code class="err">/]+ ) # capture subdir name as month</code>
    <code class="o">/</code> <code class="p">(</code><code class="o">?&lt;</code><code class="nx">title</code><code class="o">&gt;</code> <code class="p">[</code><code class="o">^</code><code class="err">/]+ ) # capture base name as title</code>
    <code class="err">\</code><code class="p">.</code><code class="nx">html</code><code class="o">?</code> <code class="nx">$</code> <code class="err">#</code> <code class="p">.</code><code class="nx">htm</code> <code class="nx">or</code> <code class="p">.</code><code class="nx">html</code> <code class="nx">file</code> <code class="nx">ext</code> <code class="nx">at</code> <code class="nx">end</code> <code class="nx">of</code> <code class="nx">path</code>
<code class="err">`</code><code class="p">);</code>
</pre></div>

</div>

<p>Tagged templates also let you insert values <code>v</code> via <code>${v}</code>. I’d expect a regular expression library to escape strings and to insert regular expressions verbatim. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">str</code>   <code class="o">=</code> <code class="s1">'really?'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">regex</code> <code class="o">=</code> <code class="nx">XRegExp</code><code class="p">.</code><code class="nx">rx</code><code class="err">`</code><code class="p">(</code><code class="nx">$</code><code class="p">{</code><code class="nx">str</code><code class="p">})</code><code class="o">*</code><code class="err">`</code><code class="p">;</code>
</pre></div>

</div>

<p>This would be equivalent to</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">regex</code> <code class="o">=</code> <code class="nx">XRegExp</code><code class="p">.</code><code class="nx">rx</code><code class="err">`</code><code class="p">(</code><code class="nx">really</code><code class="err">\</code><code class="o">?</code><code class="p">)</code><code class="o">*</code><code class="err">`</code><code class="p">;</code>
</pre></div>

</div>


<h4 id="leanpub-auto-query-languages">
<span class="section-number">8.3.4 </span>Query languages</h4>

<p>Example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">$</code><code class="err">`</code><code class="nx">a</code><code class="p">.</code><code class="nx">$</code><code class="p">{</code><code class="nx">className</code><code class="p">}[</code><code class="nx">href</code><code class="o">=~</code><code class="s1">'//${domain}/'</code><code class="p">]</code><code class="err">`</code>
</pre></div>

</div>

<p>This is a DOM query that looks for all <code>&lt;a&gt;</code> tags whose CSS class is <code>className</code> and whose target is a URL with the given domain. The tag function <code>$</code> ensures that the arguments are correctly escaped, making this approach safer than manual string concatenation.</p>


<h4 id="leanpub-auto-react-jsx-via-tagged-templates">
<span class="section-number">8.3.5 </span>React JSX via tagged templates</h4>

<p><a href="https://facebook.github.io/react/">Facebook’s React user interface library</a> has the optional language extension RSX that enables you to embed HTML inside JavaScript. This extension can make your code more concise, but it also breaks compatibility with the rest of the JavaScript ecosystem. Jonathan Raphaelson has used tagged templates to implement an approximation of JSX. That looks as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">EchoComponent</code> <code class="p">{</code>
    <code class="err">···</code>
    <code class="nx">render</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">jsx</code><code class="err">`</code>
            <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
                <code class="o">&lt;</code><code class="nx">input</code>
                    <code class="nx">ref</code><code class="o">=</code><code class="s1">'input'</code>
                    <code class="nx">onChange</code><code class="o">=</code><code class="s1">'${this.handleChange}'</code>
                    <code class="nx">defaultValue</code><code class="o">=</code><code class="s1">'${this.state.value}'</code> <code class="o">/&gt;</code>
                <code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">state</code><code class="p">.</code><code class="nx">value</code><code class="p">}</code>
            <code class="o">&lt;</code><code class="err">/div&gt;</code>
        <code class="err">`</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="kd">let</code> <code class="nx">comp</code> <code class="o">=</code> <code class="nx">jsx</code><code class="err">`</code><code class="o">&lt;</code><code class="nx">$</code><code class="p">{</code><code class="nx">EchoComponent</code><code class="p">}</code> <code class="o">/&gt;</code><code class="err">`</code><code class="p">;</code>
<code class="nx">React</code><code class="p">.</code><code class="nx">renderComponent</code><code class="p">(</code><code class="nx">comp</code><code class="p">,</code> <code class="nb">document</code><code class="p">.</code><code class="nx">body</code><code class="p">);</code>
</pre></div>

</div>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>You can check out the full example and the implementation of the tag function <code>jsx</code> <a href="https://gist.github.com/lygaret/a68220defa69174bdec5">on GitHub</a>.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-text-localization-l10n">
<span class="section-number">8.3.6 </span>Text localization (L10N)</h4>

<p>This section describes a simple approach to text localization that supports different languages and different locales (how to format numbers, time, etc.). Given the following message.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">alert</code><code class="p">(</code><code class="nx">msg</code><code class="err">`</code><code class="nx">Welcome</code> <code class="nx">to</code> <code class="nx">$</code><code class="p">{</code><code class="nx">siteName</code><code class="p">},</code> <code class="nx">you</code> <code class="nx">are</code> <code class="nx">visitor</code>
          <code class="nx">number</code> <code class="nx">$</code><code class="p">{</code><code class="nx">visitorNumber</code><code class="p">}</code><code class="o">:</code><code class="nx">d</code><code class="o">!</code><code class="err">`</code><code class="p">);</code>
</pre></div>

</div>

<p>The tag function <code>msg</code> would work as follows.</p>

<p>First, The literal parts are concatenated to form a string that can be used to look up a translation in a table. An example for a lookup string is:</p>

<div class="code-block">
<div class="highlight"><pre><code class="s1">'Welcome to {0}, you are visitor number {1}!'</code>
</pre></div>

</div>

<p>An example for a translation to German is:</p>

<div class="code-block">
<div class="highlight"><pre><code class="s1">'Besucher Nr. {1}, willkommen bei {0}!'</code>
</pre></div>

</div>

<p>The English “translation” would be the same as the lookup string.</p>

<p>Second, the result from the lookup is used to display the substitutions. Because a lookup result includes indices, it can rearrange the order of the substitutions. That has been done in German, where the visitor number comes before the site name. How the substitutions are formatted can be influenced via annotations such as <code>:d</code>. This annotation means that a locale-specific decimal separator should be used for <code>visitorNumber</code>. Thus, a possible English result is:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Welcome</code> <code class="nx">to</code> <code class="nx">ACME</code> <code class="nx">Corp</code><code class="p">.,</code> <code class="nx">you</code> <code class="nx">are</code> <code class="nx">visitor</code> <code class="nx">number</code> <code class="mi">1</code><code class="p">,</code><code class="mi">300</code><code class="o">!</code>
</pre></div>

</div>

<p>In German, we have results such as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Besucher</code> <code class="nx">Nr</code><code class="p">.</code> <code class="mf">1.300</code><code class="p">,</code> <code class="nx">willkommen</code> <code class="nx">bei</code> <code class="nx">ACME</code> <code class="nx">Corp</code><code class="p">.</code><code class="o">!</code>
</pre></div>

</div>


<h3 id="leanpub-auto-implementing-tag-functions">
<span class="section-number">8.4 </span>Implementing tag functions</h3>

<p>The following is a tagged template:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">tagFunction</code><code class="err">`</code><code class="nx">lit1</code><code class="err">\</code><code class="nx">n$</code><code class="p">{</code><code class="nx">subst1</code><code class="p">}</code> <code class="nx">lit2</code> <code class="nx">$</code><code class="p">{</code><code class="nx">subst2</code><code class="p">}</code><code class="err">`</code>
</pre></div>

</div>

<p>This is transformed internally to a function call:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code>
    <code class="c1">// Globally: add template object to per-realm template map</code>

    <code class="c1">// “Cooked” template strings: backslash is interpreted</code>
    <code class="kr">const</code> <code class="nx">templateObject</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'lit1\n'</code><code class="p">,</code>  <code class="s1">' lit2 '</code><code class="p">,</code> <code class="s1">''</code><code class="p">];</code>
    <code class="c1">// “Raw” template strings: backslash is verbatim</code>
    <code class="nx">templateObject</code><code class="p">.</code><code class="nx">raw</code>   <code class="o">=</code> <code class="p">[</code><code class="s1">'lit1\\n'</code><code class="p">,</code> <code class="s1">' lit2 '</code><code class="p">,</code> <code class="s1">''</code><code class="p">];</code>

    <code class="c1">// The Arrays with template strings are frozen</code>
    <code class="nb">Object</code><code class="p">.</code><code class="nx">freeze</code><code class="p">(</code><code class="nx">templateObject</code><code class="p">.</code><code class="nx">raw</code><code class="p">);</code>
    <code class="nb">Object</code><code class="p">.</code><code class="nx">freeze</code><code class="p">(</code><code class="nx">templateObject</code><code class="p">);</code>

    <code class="nx">__templateMap__</code><code class="p">[</code><code class="mi">716</code><code class="p">]</code> <code class="o">=</code> <code class="nx">templateObject</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">// In-place: invocation of tag function</code>
<code class="nx">tagFunction</code><code class="p">(</code><code class="nx">__templateMap__</code><code class="p">[</code><code class="mi">716</code><code class="p">],</code> <code class="nx">subst1</code><code class="p">,</code> <code class="nx">subst2</code><code class="p">)</code>
</pre></div>

</div>

<p>The parameters of the tag function are split into two categories:</p>

<ol class="numeric numeric">
<li>The template object: where you get the template strings both with escapes such as <code>\n</code> interpreted (“cooked”) and uninterpreted (“raw”). The number of template strings is always one plus the number of substitutions. If a substitution is first in a literal, it is prefixed by an empty template string. If a substitution is last, it is suffixed by an empty template string (as in the previous example).</li>
  <li>The substitutions: whose values become trailing parameters.</li>
</ol>
<p>The idea is that the same literal might be executed multiple times (e.g. in a loop or a function). With the template object, the tag function can cache data from previous invocations: (1) is potentially cacheable data, (2) changes with each invocation. Caching happens per <em>realm</em> (think frame in a browser). That is, there is one template object per call site and realm.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-tagged-templates-in-the-spec">Tagged templates in the spec</h3>

  <p><a href="http://www.ecma-international.org/ecma-262/6.0/#sec-tagged-templates">A section on tagged templates</a> explains how they are interpreted as function calls. <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-template-literals-runtime-semantics-argumentlistevaluation">A separate section</a> explains how a template literal is turned into a list of arguments: the template object and the substitutions.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-escaping-in-tagged-templates-cooked-vs-raw">
<span class="section-number">8.4.1 </span>Escaping in tagged templates: cooked vs. raw</h4>

<p>In tagged templates, there are more rules for escaping, because <em>template strings</em> (the text fragments inside the backticks, excluding substitutions) are available in two interpretations: cooked and raw. The rules are:</p>

<ul>
<li>In both cooked and raw interpretation, a backslash (<code>\</code>) in front of a dollar sign (<code>$</code>) prevents <code>${</code> from being interpreted as starting a substitution.</li>
  <li>However, every single backslash is mentioned in the raw interpretation, even the ones that escape substitutions.</li>
</ul>
<p>The tag function <code>describe</code> allows us to explore what that means.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">describe</code><code class="p">(</code><code class="nx">tmplObj</code><code class="p">,</code> <code class="p">...</code><code class="nx">substs</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Cooked:'</code><code class="p">,</code> <code class="nx">intersperse</code><code class="p">(</code><code class="nx">tmplObj</code><code class="p">,</code> <code class="nx">substs</code><code class="p">));</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Raw:   '</code><code class="p">,</code> <code class="nx">intersperse</code><code class="p">(</code><code class="nx">tmplObj</code><code class="p">.</code><code class="nx">raw</code><code class="p">,</code> <code class="nx">substs</code><code class="p">));</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">intersperse</code><code class="p">(</code><code class="nx">tmplStrs</code><code class="p">,</code> <code class="nx">substs</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// There is always at least one element in tmplStrs</code>
    <code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">tmplStrs</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
    <code class="nx">substs</code><code class="p">.</code><code class="nx">forEach</code><code class="p">((</code><code class="nx">subst</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="nx">result</code> <code class="o">+=</code> <code class="nb">String</code><code class="p">(</code><code class="nx">subst</code><code class="p">);</code>
        <code class="nx">result</code> <code class="o">+=</code> <code class="nx">tmplStrs</code><code class="p">[</code><code class="nx">i</code><code class="o">+</code><code class="mi">1</code><code class="p">];</code>
    <code class="p">});</code>
    <code class="k">return</code> <code class="nx">result</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Let’s use this tag function (I am not showing the result <code>undefined</code> of these function calls):</p>

<div class="code-block">
<div class="highlight"><pre>&gt; describe`<code class="cp">${</code><code class="mi">3</code><code class="o">+</code><code class="mi">3</code><code class="cp">}</code>`
Cooked: 6
Raw:    6

&gt; describe`\<code class="cp">${</code><code class="mi">3</code><code class="o">+</code><code class="mi">3</code><code class="cp">}</code>`
Cooked: <code class="cp">${</code><code class="mi">3</code><code class="o">+</code><code class="mi">3</code><code class="cp">}</code>
Raw:    \<code class="cp">${</code><code class="mi">3</code><code class="o">+</code><code class="mi">3</code><code class="cp">}</code>

&gt; describe`\\<code class="cp">${</code><code class="mi">3</code><code class="o">+</code><code class="mi">3</code><code class="cp">}</code>`
Cooked: \6
Raw:    \\6

&gt; describe`\\\<code class="cp">${</code><code class="mi">3</code><code class="o">+</code><code class="mi">3</code><code class="cp">}</code>`
Cooked: \<code class="cp">${</code><code class="mi">3</code><code class="o">+</code><code class="mi">3</code><code class="cp">}</code>
Raw:    \\\<code class="cp">${</code><code class="mi">3</code><code class="o">+</code><code class="mi">3</code><code class="cp">}</code>
</pre></div>

</div>

<p>As you can see, whenever the cooked interpretation has a substitution then so does the raw interpretation. However, all backslashes from the literal appear in the raw interpretation; if a backslash precedes the characters <code>${</code> then it prevented a substitution.</p>

<p>Other occurrences of the backslash are interpreted similarly:</p>

<ul>
<li>In cooked mode, the backslash is handled like in string literals.</li>
  <li>In raw mode, the backslash is used verbatim.</li>
</ul>
<p>For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="err">`\</code><code class="n">n</code><code class="err">`</code>
<code class="sc">'\n'</code>
<code class="o">&gt;</code> <code class="n">String</code><code class="p">.</code><code class="n">raw</code><code class="err">`\</code><code class="n">n</code><code class="err">`</code>
<code class="err">'\\</code><code class="n">n</code><code class="err">'</code>
</pre></div>

</div>

<p>The only time the backslash ever has an effect in raw mode is when it appears in front of a substitution (which it escapes).</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-escaping-in-tagged-templates-in-the-spec">Escaping in tagged templates in the spec</h3>

  <p>In <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-template-literal-lexical-components">the grammar for template literals</a>, you can see that, within a template literal, there must be no open curly brace (<code>{</code>) after a dollar sign (<code>$</code>). However, an escaped dollar sign (<code>\$</code>) can be followed by an open curly brace. The rules for interpreting the characters of a template literal are explained in <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-static-semantics-tv-and-trv">a separate section</a>.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-example-implementing-a-tag-function-for-html-templating">
<span class="section-number">8.4.2 </span>Example: implementing a tag function for HTML templating</h4>

<p>In this section, I explain how you can use tagged templates for HTML templating. The approach is based on <a href="https://mail.mozilla.org/pipermail/es-discuss/2012-August/024328.html">an idea</a> by Claus Reinke.</p>

<h5 id="leanpub-auto-defining-and-using-an-html-template">
<span class="section-number">8.4.2.1 </span>Defining and using an HTML template</h5>

<p>You define an HTML template as follows. It relies on the tag function <code>html</code> (which is shown later).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">tmpl</code> <code class="o">=</code> <code class="nx">addrs</code> <code class="o">=&gt;</code> <code class="nx">html</code><code class="err">`</code>
    <code class="o">&lt;</code><code class="nx">table</code><code class="o">&gt;</code>
    <code class="nx">$</code><code class="p">{</code><code class="nx">addrs</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">addr</code> <code class="o">=&gt;</code> <code class="nx">html</code><code class="err">`</code>
        <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code><code class="nx">$$</code><code class="p">{</code><code class="nx">addr</code><code class="p">.</code><code class="nx">first</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/tr&gt;</code>
        <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code><code class="nx">$$</code><code class="p">{</code><code class="nx">addr</code><code class="p">.</code><code class="nx">last</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/tr&gt;</code>
    <code class="err">`</code><code class="p">)}</code>
    <code class="o">&lt;</code><code class="err">/table&gt;</code>
<code class="err">`</code><code class="p">;</code>
</pre></div>

</div>

<p>The trick is that the the inside of each substitution <code>${}</code> can be an arbitrary expression. We use <code>map()</code> to create an Array of strings inside the first substitution (which <code>html()</code> turns into the appropriate string). Thanks to arrow functions, the callback of <code>map()</code> is nicely concise.</p>

<p>Inside the callback, we are “invoking” <code>html</code> again. Therefore, calling the function <code>tmpl</code> leads to several calls of the function <code>html</code>.</p>

<p>The double dollar sign in <code>$${addr.last}</code> is not ES6 syntax, it is simply the normal text “<code>$</code>” in front of the substitution <code>${addr.last}</code>. But the tag function treats a substitution differently if it is preceded by a dollar sign – it HTML-escapes the string returned by it.</p>

<p>The template is used like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">tmpl</code><code class="p">([</code>
    <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="s1">'&lt;Jane&gt;'</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="s1">'Bond'</code> <code class="p">},</code>
    <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="s1">'Lars'</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="s1">'&lt;Croft&gt;'</code> <code class="p">},</code>
<code class="p">]));</code>
</pre></div>

</div>

<p>This code produces the following output:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nt">&lt;table&gt;</code>

    <code class="nt">&lt;tr&gt;</code>Jane<code class="nt">&lt;/tr&gt;</code>
    <code class="nt">&lt;tr&gt;</code><code class="ni">&amp;lt;</code>Bond<code class="ni">&amp;gt;</code><code class="nt">&lt;/tr&gt;</code>

    <code class="nt">&lt;tr&gt;</code><code class="ni">&amp;lt;</code>Lars<code class="ni">&amp;gt;</code><code class="nt">&lt;/tr&gt;</code>
    <code class="nt">&lt;tr&gt;</code>Croft<code class="nt">&lt;/tr&gt;</code>

<code class="nt">&lt;/table&gt;</code>
</pre></div>

</div>

<p>Note that the angle brackets around <code>Jane</code> and <code>Croft</code> are escaped, whereas <code>&lt;tr&gt;</code> isn’t.</p>

<h5 id="leanpub-auto-the-tag-function">
<span class="section-number">8.4.2.2 </span>The tag function</h5>

<p>The tag function is surprisingly simple:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">html</code><code class="p">(</code><code class="nx">templateObject</code><code class="p">,</code> <code class="p">...</code><code class="nx">substs</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Use raw template strings: we don’t want</code>
    <code class="c1">// backslashes (\n etc.) to be interpreted</code>
    <code class="kd">let</code> <code class="nx">raw</code> <code class="o">=</code> <code class="nx">templateObject</code><code class="p">.</code><code class="nx">raw</code><code class="p">;</code>

    <code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>

    <code class="nx">substs</code><code class="p">.</code><code class="nx">forEach</code><code class="p">((</code><code class="nx">subst</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="c1">// Retrieve the template string preceding</code>
        <code class="c1">// the current substitution</code>
        <code class="kd">let</code> <code class="nx">lit</code> <code class="o">=</code> <code class="nx">raw</code><code class="p">[</code><code class="nx">i</code><code class="p">];</code>

        <code class="c1">// In the example, map() returns an Array:</code>
        <code class="c1">// If substitution is an Array (and not a string),</code>
        <code class="c1">// we turn it into a string</code>
        <code class="k">if</code> <code class="p">(</code><code class="nb">Array</code><code class="p">.</code><code class="nx">isArray</code><code class="p">(</code><code class="nx">subst</code><code class="p">))</code> <code class="p">{</code>
            <code class="nx">subst</code> <code class="o">=</code> <code class="nx">subst</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s1">''</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="c1">// If the substitution is preceded by a dollar sign,</code>
        <code class="c1">// we escape special characters in it</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">lit</code><code class="p">.</code><code class="nx">endsWith</code><code class="p">(</code><code class="s1">'$'</code><code class="p">))</code> <code class="p">{</code>
            <code class="nx">subst</code> <code class="o">=</code> <code class="nx">htmlEscape</code><code class="p">(</code><code class="nx">subst</code><code class="p">);</code>
            <code class="nx">lit</code> <code class="o">=</code> <code class="nx">lit</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">);</code>
        <code class="p">}</code>
        <code class="nx">result</code> <code class="o">+=</code> <code class="nx">lit</code><code class="p">;</code>
        <code class="nx">result</code> <code class="o">+=</code> <code class="nx">subst</code><code class="p">;</code>
    <code class="p">});</code>
    <code class="c1">// Take care of last template string</code>
    <code class="c1">// (Never fails, because an empty tagged template</code>
    <code class="c1">// produces one template string, an empty string)</code>
    <code class="nx">result</code> <code class="o">+=</code> <code class="nx">raw</code><code class="p">[</code><code class="nx">raw</code><code class="p">.</code><code class="nx">length</code><code class="o">-</code><code class="mi">1</code><code class="p">];</code> <code class="c1">// (A)</code>

    <code class="k">return</code> <code class="nx">result</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Each substitution is always surrounded by template strings. If the tagged template ends with a substitution, the last template string is an empty string. Accordingly, the following expression is always true:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">templateObject</code><code class="p">.</code><code class="nx">length</code> <code class="o">===</code> <code class="nx">substs</code><code class="p">.</code><code class="nx">length</code> <code class="o">+</code> <code class="mi">1</code>
</pre></div>

</div>

<p>That’s why we need to append the last template string in line A.</p>

<p>The following is a simple implementation of <code>htmlEscape()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">htmlEscape</code><code class="p">(</code><code class="nx">str</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">str</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/&amp;/g</code><code class="p">,</code> <code class="s1">'&amp;amp;'</code><code class="p">)</code> <code class="c1">// first!</code>
              <code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/&gt;/g</code><code class="p">,</code> <code class="s1">'&amp;gt;'</code><code class="p">)</code>
              <code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/&lt;/g</code><code class="p">,</code> <code class="s1">'&amp;lt;'</code><code class="p">)</code>
              <code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/"/g</code><code class="p">,</code> <code class="s1">'&amp;quot;'</code><code class="p">)</code>
              <code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/'/g</code><code class="p">,</code> <code class="s1">'&amp;#39;'</code><code class="p">)</code>
              <code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/`/g</code><code class="p">,</code> <code class="s1">'&amp;#96;'</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-more-ideas">
<span class="section-number">8.4.2.3 </span>More ideas</h5>

<p>There are more things you can do with this approach to templating:</p>

<ul>
<li>This approach isn’t limited to HTML, it would work just as well for other kinds of text. Obviously, escaping would have to be adapted.</li>
  <li>if-then-else inside the template can be done via the ternary operator (<code>cond?then:else</code>) or via the logical Or operator (<code>||</code>):
    <div class="code-block">
<div class="highlight"><pre>  <code class="nx">$$</code><code class="p">{</code><code class="nx">addr</code><code class="p">.</code><code class="nx">first</code> <code class="o">?</code> <code class="nx">addr</code><code class="p">.</code><code class="nx">first</code> <code class="o">:</code> <code class="s1">'(No first name)'</code><code class="p">}</code>
  <code class="nx">$$</code><code class="p">{</code><code class="nx">addr</code><code class="p">.</code><code class="nx">first</code> <code class="o">||</code> <code class="s1">'(No first name)'</code><code class="p">}</code>
</pre></div>
    
</div>
  </li>
  <li>Some of the leading whitespace in each line can be trimmed if the first non-whitespace character in the first line defines where the first column is.</li>
  <li>Destructuring can be used:
    <div class="code-block">
<div class="highlight"><pre>  <code class="nx">$</code><code class="p">{</code><code class="nx">addrs</code><code class="p">.</code><code class="nx">map</code><code class="p">(({</code><code class="nx">first</code><code class="p">,</code><code class="nx">last</code><code class="p">})</code> <code class="o">=&gt;</code> <code class="nx">html</code><code class="err">`</code>
      <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code><code class="nx">$$</code><code class="p">{</code><code class="nx">first</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/tr&gt;</code>
      <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code><code class="nx">$$</code><code class="p">{</code><code class="nx">last</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/tr&gt;</code>
  <code class="err">`</code><code class="p">)}</code>
</pre></div>
    
</div>
  </li>
</ul>
<h5 id="leanpub-auto-should-i-use-this-in-production-code">
<span class="section-number">8.4.2.4 </span>Should I use this in production code?</h5>

<p>Use this approach if you need something quick and dirty. It is not as readable as the template syntax supported by <a href="http://handlebarsjs.com/">Handlebars.js</a> and similar templating engines. On the other hand, it is lightweight and control flow mechanisms (loops and if-then-else) are easy to understand, because they are just JavaScript.</p>


<h4 id="sec_escRegExp">
<span class="section-number">8.4.3 </span>Example: quoting parts of regular expressions</h4>

<p>Let’s implement the previously mentioned tag function <code>escRegExp</code> that assembles a regular expression while escaping substitutions.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">escRegExp</code><code class="p">(</code><code class="nx">tmplObj</code><code class="p">,</code> <code class="p">...</code><code class="nx">substs</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Template strings are used verbatim</code>
    <code class="kd">let</code> <code class="nx">regexText</code> <code class="o">=</code> <code class="nx">tmplObj</code><code class="p">.</code><code class="nx">raw</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
    <code class="k">for</code> <code class="p">([</code><code class="nx">i</code><code class="p">,</code> <code class="nx">subst</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">substs</code><code class="p">.</code><code class="nx">entries</code><code class="p">())</code> <code class="p">{</code>
        <code class="nx">regexText</code> <code class="o">+=</code> <code class="nx">quoteText</code><code class="p">(</code><code class="nb">String</code><code class="p">(</code><code class="nx">subst</code><code class="p">));</code>
        <code class="nx">regexText</code> <code class="o">+=</code> <code class="nx">tmplObj</code><code class="p">.</code><code class="nx">raw</code><code class="p">[</code><code class="nx">i</code><code class="o">+</code><code class="mi">1</code><code class="p">];</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nb">RegExp</code><code class="p">(</code><code class="nx">regexText</code><code class="p">);</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">quoteText</code><code class="p">(</code><code class="nx">text</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">text</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/[\\^$.*+?()[\]{}|=!&lt;&gt;:-]/g</code><code class="p">,</code> <code class="s1">'\\$&amp;'</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This is <code>escRegExp</code> in use:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Note the single backslashes</code>
<code class="kd">let</code> <code class="nx">re</code> <code class="o">=</code> <code class="nx">escRegExp</code><code class="err">`\</code><code class="nx">$$</code><code class="p">{</code><code class="nx">dot</code><code class="p">}</code><code class="err">\</code><code class="nx">$</code><code class="err">`</code><code class="p">;</code>
    <code class="c1">// re = /\$\.\$/</code>
<code class="nx">re</code><code class="p">.</code><code class="nx">test</code><code class="p">(</code><code class="s1">'$.$'</code><code class="p">);</code> <code class="c1">// true</code>
<code class="nx">re</code><code class="p">.</code><code class="nx">test</code><code class="p">(</code><code class="s1">'$_$'</code><code class="p">);</code> <code class="c1">// false</code>
</pre></div>

</div>


<h3 id="leanpub-auto-faq-template-literals-and-tagged-templates">
<span class="section-number">8.5 </span>FAQ: template literals and tagged templates</h3>

<h4 id="leanpub-auto-where-do-template-literals-and-tagged-literals-come-from">
<span class="section-number">8.5.1 </span>Where do template literals and tagged literals come from?</h4>

<p>Template literals and tagged templates were borrowed from the language E, which calls this feature <a href="http://www.erights.org/elang/grammar/quasi-overview.html"><em>quasi literals</em></a>.</p>

<h4 id="leanpub-auto-what-is-the-difference-between-macros-and-tagged-templates">
<span class="section-number">8.5.2 </span>What is the difference between macros and tagged templates?</h4>

<p>Macros allow you to implement constructs that have custom syntax. Providing macros for a language whose syntax is as complex as JavaScript’s is difficult and ongoing research (see Mozilla’s <a href="http://sweetjs.org/">sweet.js</a>).</p>

<p>While macros are much more powerful for implementing sub-languages than tagged templates, they depend on the tokenization of the language. Therefore, tagged templates are complementary, because they specialize on text content.</p>

<h4 id="leanpub-auto-can-i-load-a-template-literal-from-an-external-source">
<span class="section-number">8.5.3 </span>Can I load a template literal from an external source?</h4>

<p>What if I want to load a template literal such as <code>`Hello ${name}!`</code> from an external source (e.g., a file)?</p>

<p>Note that you are abusing this mechanism if you do so. Given that a template literal can contain arbitrary expressions and is a literal, loading it from somehwere else is similar to loading an expression or a string literal – you have to use <code>eval()</code> or something similar.</p>

<p>Coming back to the example, this is how you’d do it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">str</code> <code class="o">=</code> <code class="s1">'`Hello ${name}!`'</code><code class="p">;</code> <code class="c1">// external source</code>

<code class="kd">let</code> <code class="nx">func</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Function</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="nx">str</code><code class="p">);</code>

<code class="kd">let</code> <code class="nx">name</code> <code class="o">=</code> <code class="s1">'Jane'</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">func</code><code class="p">(</code><code class="nx">name</code><code class="p">);</code>
</pre></div>

</div>

<p>Every variable that isn’t declared inside the template literal has to become a parameter of the function <code>func</code> that we are creating. Alternatively, you could load a whole function and eval it<sup id="fnref-template-literals_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-template-literals_1" rel="footnote">1</a></sup>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">str</code> <code class="o">=</code> <code class="s1">'(name) =&gt; `Hello ${name}!`'</code><code class="p">;</code> <code class="c1">// external source</code>

<code class="kd">let</code> <code class="nx">func</code> <code class="o">=</code> <code class="nb">eval</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code> <code class="nx">str</code><code class="p">);</code> <code class="c1">// indirect eval</code>

<code class="kd">let</code> <code class="nx">name</code> <code class="o">=</code> <code class="s1">'Jane'</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">func</code><code class="p">(</code><code class="nx">name</code><code class="p">);</code>
</pre></div>

</div>

<h4 id="leanpub-auto-why-are-backticks-the-delimiters-for-template-literals-and-tagged-templates">
<span class="section-number">8.5.4 </span>Why are backticks the delimiters for template literals and tagged templates?</h4>

<p>The backtick was one of the few ASCII characters that were still unused. The syntax <code>${}</code> for interpolation is the de-facto standard (Unix shells, etc.).</p>

<h4 id="leanpub-auto-werent-tagged-templates-once-called-template-strings">
<span class="section-number">8.5.5 </span>Weren’t tagged templates once called template strings?</h4>

<p>The template literal terminology changed relatively late during the creation of the ES6 spec. The following are the old terms:</p>

<ul>
<li>Template string (literal): the previous name for <em>template literal</em>.</li>
  <li>Tagged template string (literal): the previous name for <em>tagged template</em>.</li>
  <li>Template handler: the previous name for <em>tag function</em>.</li>
  <li>Literal section: the previous name for <em>template string</em> (the term <em>substitution</em> remains the same).</li>
</ul>
<div class="footnotes">
  <ol>
<li id="fn-template-literals_1">[Speaking JS] http://speakingjs.com/es5/ch23.html#_dynamically_evaluating_javascript_code_via_eval_and_new_function<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-template-literals_1" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h2 id="leanpub-auto-variables-and-scoping">
<span class="section-number">9. </span>Variables and scoping</h2>

<p>This chapter examines how variables and scoping are handled in ECMAScript 6.</p>

<h3 id="leanpub-auto-overview-4">
<span class="section-number">9.1 </span>Overview</h3>

<p>ES6 provides two new ways to declare variables: <code>let</code> and <code>const</code>, which mostly replace the ES5 way of declaring variables, <code>var</code>.</p>

<h4 id="leanpub-auto-let">
<span class="section-number">9.1.1 </span><code>let</code>
</h4>

<p><code>let</code> works similarly to <code>var</code>, but the variable it declares is <em>block-scoped</em>,  it only exists within the current block. <code>var</code> is <em>function-scoped</em>.</p>

<p>In the following code, you can see that the <code>let</code>-declared variable <code>tmp</code> only exists with the block that starts in line A:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">order</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">x</code> <code class="o">&gt;</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// (A)</code>
        <code class="kd">let</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="nx">x</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
        <code class="nx">y</code> <code class="o">=</code> <code class="nx">tmp</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">tmp</code><code class="o">===</code><code class="nx">x</code><code class="p">);</code> <code class="c1">// ReferenceError: tmp is not defined</code>
    <code class="k">return</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">];</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-const">
<span class="section-number">9.1.2 </span><code>const</code>
</h4>

<p><code>const</code> works like <code>let</code>, but the variable you declare must be immediately initialized, with a value that can’t be changed afterwards.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">foo</code><code class="p">;</code>
    <code class="c1">// SyntaxError: missing = in const declaration</code>

<code class="kr">const</code> <code class="nx">bar</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
<code class="nx">bar</code> <code class="o">=</code> <code class="mi">456</code><code class="p">;</code>
    <code class="c1">// TypeError: `bar` is read-only</code>
</pre></div>

</div>

<h4 id="leanpub-auto-ways-of-declaring-variables">
<span class="section-number">9.1.3 </span>Ways of declaring variables</h4>

<p>The following table gives an overview of six ways in which variables can be declared in ES6:</p>

<table>
<thead><tr>
<th>&nbsp;</th>
      <th>Hoisting</th>
      <th>Scope</th>
      <th>Creates global properties</th>
    </tr></thead>
<tbody>
<tr>
<td><code>var</code></td>
      <td>Declaration</td>
      <td>Function</td>
      <td>Yes</td>
    </tr>
<tr>
<td><code>let</code></td>
      <td>Temporal dead zone</td>
      <td>Block</td>
      <td>No</td>
    </tr>
<tr>
<td><code>const</code></td>
      <td>Temporal dead zone</td>
      <td>Block</td>
      <td>No</td>
    </tr>
<tr>
<td><code>function</code></td>
      <td>Complete</td>
      <td>Block</td>
      <td>Yes</td>
    </tr>
<tr>
<td><code>class</code></td>
      <td>No</td>
      <td>Block</td>
      <td>No</td>
    </tr>
<tr>
<td><code>import</code></td>
      <td>Complete</td>
      <td>Module-global</td>
      <td>No</td>
    </tr>
</tbody>
</table>
<h3 id="sec_let-const">
<span class="section-number">9.2 </span>Block scoping via <code>let</code> and <code>const</code>
</h3>

<p>Both <code>let</code> and <code>const</code> create variables that are <em>block-scoped</em> – they only exist within the innermost block that surrounds them. The following code demonstrates that the <code>let</code>-declared variable <code>tmp</code> only exists inside the then-block of the <code>if</code> statement:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">func</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">tmp</code><code class="p">);</code> <code class="c1">// ReferenceError: tmp is not defined</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In contrast, <code>var</code>-declared variables are function-scoped:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">func</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">tmp</code><code class="p">);</code> <code class="c1">// 123</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Block scoping means that you can shadow variables within a function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">func</code><code class="p">()</code> <code class="p">{</code>
  <code class="kd">let</code> <code class="nx">foo</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code>
  <code class="k">if</code> <code class="p">(</code><code class="err">···</code><code class="p">)</code> <code class="p">{</code>
     <code class="kd">let</code> <code class="nx">foo</code> <code class="o">=</code> <code class="mi">10</code><code class="p">;</code> <code class="c1">// shadows outer `foo`</code>
     <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">foo</code><code class="p">);</code> <code class="c1">// 10</code>
  <code class="p">}</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">foo</code><code class="p">);</code> <code class="c1">// 5</code>
<code class="p">}</code>
</pre></div>

</div>

<h3 id="leanpub-auto-const-creates-immutable-variables">
<span class="section-number">9.3 </span><code>const</code> creates immutable variables</h3>

<p>Variables created by <code>let</code> are mutable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">foo</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">;</code>
<code class="nx">foo</code> <code class="o">=</code> <code class="s1">'def'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">foo</code><code class="p">);</code> <code class="c1">// def</code>
</pre></div>

</div>

<p>Constants, variables created by <code>const</code>, are immutable – you can’t assign them a different value:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">foo</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">;</code>
<code class="nx">foo</code> <code class="o">=</code> <code class="s1">'def'</code><code class="p">;</code> <code class="c1">// TypeError</code>
</pre></div>

</div>

<h4 id="leanpub-auto-pitfall-const-does-not-make-the-value-immutable">
<span class="section-number">9.3.1 </span>Pitfall: <code>const</code> does not make the value immutable</h4>

<p><code>const</code> only means that a variable always has the same value, but it does not make a mutable value immutable. For example, <code>obj</code> is a constant, but the value it points to is mutable – we can add a property to it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{};</code>
<code class="nx">obj</code><code class="p">.</code><code class="nx">prop</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">prop</code><code class="p">);</code> <code class="c1">// 123</code>
</pre></div>

</div>

<p>We cannot, however assign a different value to <code>obj</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">obj</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// TypeError</code>
</pre></div>

</div>

<p>If you want the value of <code>obj</code> to be immutable, you have to take care of it, yourself, e.g. by <a href="http://speakingjs.com/es5/ch17.html#freezing_objects">freezing it</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">obj</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">freeze</code><code class="p">({});</code>
<code class="nx">obj</code><code class="p">.</code><code class="nx">prop</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code> <code class="c1">// TypeError</code>
</pre></div>

</div>

<h4 id="leanpub-auto-const-in-loop-bodies">
<span class="section-number">9.3.2 </span><code>const</code> in loop bodies</h4>

<p>Once a <code>const</code> variable has been created, it can’t be changed. But that doesn’t mean that you can’t re-enter its scope and start fresh, with a new value. For example, via a loop:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">logArgs</code><code class="p">(...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">index</code><code class="p">,</code> <code class="nx">elem</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">args</code><code class="p">.</code><code class="nx">entries</code><code class="p">())</code> <code class="p">{</code>
        <code class="kr">const</code> <code class="nx">message</code> <code class="o">=</code> <code class="nx">index</code> <code class="o">+</code> <code class="s1">'. '</code> <code class="o">+</code> <code class="nx">elem</code><code class="p">;</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">message</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="nx">logArgs</code><code class="p">(</code><code class="s1">'Hello'</code><code class="p">,</code> <code class="s1">'everyone'</code><code class="p">);</code>

<code class="c1">// Output:</code>
<code class="c1">// 0. Hello</code>
<code class="c1">// 1. everyone</code>
</pre></div>

</div>

<h3 id="leanpub-auto-the-temporal-dead-zone">
<span class="section-number">9.4 </span>The temporal dead zone</h3>

<p>A variable declared by <code>let</code> or <code>const</code> has a so-called <em>temporal dead zone</em> (TDZ): When entering its scope, it can’t be accessed (got or set) until execution reaches the declaration.</p>

<p>Let’s first examine the life cycle of <code>var</code> variables, which don’t have temporal dead zones:</p>

<ul>
<li>When the scope (its surrounding function) of a <code>var</code> variable is entered, storage space (a so-called <em>binding</em>) is created for it. The variable is immediately initialized, by setting it to <code>undefined</code>.</li>
  <li>When the execution within the scope reaches the declaration, the variable is set to the value specified by the <em>initializer</em> (an assignment) – if there is one. If there isn’t, the value value of the variable remains <code>undefined</code>.</li>
</ul>
<p>Variables declared via <code>let</code> have temporal dead zones, which means that their life cycles look like this:</p>

<ul>
<li>When the scope (its surrounding block) of a <code>let</code> variable is entered, storage space (a so-called <em>binding</em>) is created for it. The variable remains uninitialized.</li>
  <li>Getting or setting an uninitialized variable causes a <code>ReferenceError</code>.</li>
  <li>When the execution within the scope reaches the declaration, the variable is set to the value specified by the <em>initializer</em> (an assignment) – if there is one. If there isn’t, the value of the variable is set to <code>undefined</code>.</li>
</ul>
<p><code>const</code> variables work similarly to <code>let</code> variables, but they must have an initializer (i.e., be set to a value immediately) and can’t be changed.</p>

<p>Within a TDZ, an exception is thrown if a variable is got or set:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// enter new scope, TDZ starts</code>
    <code class="c1">// Uninitialized binding for `tmp` is created</code>

    <code class="nx">tmp</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">;</code> <code class="c1">// ReferenceError</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">tmp</code><code class="p">);</code> <code class="c1">// ReferenceError</code>

    <code class="kd">let</code> <code class="nx">tmp</code><code class="p">;</code> <code class="c1">// TDZ ends, `tmp` is initialized with `undefined`</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">tmp</code><code class="p">);</code> <code class="c1">// undefined</code>

    <code class="nx">tmp</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">tmp</code><code class="p">);</code> <code class="c1">// 123</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The following example demonstrates that the dead zone is really <em>temporal</em> (based on time) and not spatial (based on location):</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// enter new scope, TDZ starts</code>
    <code class="kr">const</code> <code class="nx">func</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">myVar</code><code class="p">);</code> <code class="c1">// OK!</code>
    <code class="p">};</code>

    <code class="c1">// Here we are within the TDZ and</code>
    <code class="c1">// accessing `myVar` would cause a `ReferenceError`</code>

    <code class="kd">let</code> <code class="nx">myVar</code> <code class="o">=</code> <code class="mi">3</code><code class="p">;</code> <code class="c1">// TDZ ends</code>
    <code class="nx">func</code><code class="p">();</code> <code class="c1">// called outside TDZ</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-typeof-and-the-temporal-dead-zone">
<span class="section-number">9.4.1 </span><code>typeof</code> and the temporal dead zone</h4>

<p>A variable being unaccessible in the temporal dead zone means that you can’t even apply <code>typeof</code> to it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="k">typeof</code> <code class="nx">tmp</code><code class="p">);</code> <code class="c1">// ReferenceError</code>
    <code class="kd">let</code> <code class="nx">tmp</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>I don’t expect this to be a problem for most programmers: Checking whether a variable exists in this manner is mainly done in libraries (especially polyfills). If a temporal dead zone becomes a problem, you can work around it (e.g. via <code>window</code>). Lastly, modules will reduce the need for this kind of trickery in the long run.</p>

<h3 id="sec_let-const-loop-heads">
<span class="section-number">9.5 </span><code>let</code> and <code>const</code> in loop heads</h3>


<p>The following loops allow you to declare variables in their heads:</p>

<ul>
<li><code>for</code></li>
  <li><code>for-in</code></li>
  <li><code>for-of</code></li>
</ul>
<p>To make a declaration, you can use either <code>var</code>, <code>let</code> or <code>const</code>. Each of them has a different effect, as I’ll explain next.</p>

<h4 id="leanpub-auto-for-loop">
<span class="section-number">9.5.1 </span><code>for</code> loop</h4>

<p><code>var</code>-declaring a variable in the head of a <code>for</code> loop creates a single binding for that variable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[];</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">3</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">arr</code><code class="p">.</code><code class="nx">push</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">i</code><code class="p">);</code>
<code class="p">}</code>
<code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code><code class="p">());</code> <code class="c1">// [3,3,3]</code>
</pre></div>

</div>

<p>Every <code>i</code> in the bodies of the three arrow functions refers to the same binding, which is why they all return the same value.</p>

<p>If you <code>let</code>-declare a variable, a new binding is created for each loop iteration:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[];</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">3</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">arr</code><code class="p">.</code><code class="nx">push</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">i</code><code class="p">);</code>
<code class="p">}</code>
<code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code><code class="p">());</code> <code class="c1">// [0,1,2]</code>
</pre></div>

</div>

<p>This time, each <code>i</code> refers to the binding of one specific iteration and preserves the value that was current at that time. Therefore, each arrow function returns a different value.</p>

<p><code>const</code> works like <code>var</code>, but you can’t change the initial value of a <code>const</code>-declared variable.</p>

<p>Getting a fresh binding for each iteration may seem strange at first, but it is very useful whenever you use loops to create functions (e.g. callbacks for event handling) that refer to loop variables.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-for-loop-per-iteration-bindings-in-the-spec">
<code>for</code> loop: per-iteration bindings in the spec</h3>

  <p><a href="http://www.ecma-international.org/ecma-262/6.0/#sec-for-statement-runtime-semantics-labelledevaluation">The evaluation of the <code>for</code> loop</a> handles <code>var</code> as the second case and <code>let</code>/<code>const</code> as the third case. Only <code>let</code>-declared variables are added to the list <code>perIterationLets</code> (step 9), which is passed to <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-forbodyevaluation"><code>ForBodyEvaluation()</code></a> as the second-to-last parameter, <code>perIterationBindings</code>.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-for-of-loop-and-for-in-loop">
<span class="section-number">9.5.2 </span><code>for-of</code> loop and <code>for-in</code> loop</h4>

<p>In a <code>for-of</code> loop, <code>var</code> creates a single binding:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[];</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="nx">of</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">])</code> <code class="p">{</code>
    <code class="nx">arr</code><code class="p">.</code><code class="nx">push</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">i</code><code class="p">);</code>
<code class="p">}</code>
<code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code><code class="p">());</code> <code class="c1">// [2,2,2]</code>
</pre></div>

</div>

<p><code>let</code> creates one binding per iteration:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[];</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">i</code> <code class="nx">of</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">])</code> <code class="p">{</code>
    <code class="nx">arr</code><code class="p">.</code><code class="nx">push</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">i</code><code class="p">);</code>
<code class="p">}</code>
<code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code><code class="p">());</code> <code class="c1">// [0,1,2]</code>
</pre></div>

</div>

<p><code>const</code> also creates one binding per iteration, but the bindings it creates are immutable.</p>

<p>The <code>for-in</code> loop works similarly to the <code>for-of</code> loop.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-for-of-loop-per-iteration-bindings-in-the-spec">
<code>for-of</code> loop: per-iteration bindings in the spec</h3>

  <p>Per-iteration bindings in <code>for-of</code> are handled by <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-runtime-semantics-forin-div-ofbodyevaluation-lhs-stmt-iterator-lhskind-labelset"><code>ForIn/OfBodyEvaluation</code></a>. In step 5.b, a new environment is created and bindings are added to it via <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-runtime-semantics-bindinginstantiation"><code>BindingInstantiation</code></a> (mutable for <code>let</code>, immutable for <code>const</code>). The current iteration value is stored in the variable <code>nextValue</code> and used to initialize the bindings in either one of two ways:</p>

  <ul>
<li>Declaration of single variable (step 5.h.i): is handled via <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-initializereferencedbinding"><code>InitializeReferencedBinding</code></a>
</li>
    <li>Destructuring (step 5.i.iii): is handled via <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-for-in-and-for-of-statements-runtime-semantics-bindinginitialization">one case of <code>BindingInitialization</code></a> (<code>ForDeclaration</code>), which invokes <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-destructuring-binding-patterns-runtime-semantics-bindinginitialization">another case of <code>BindingInitialization</code></a> (<code>BindingPattern</code>).</li>
  </ul>
</td>
  </tr></tbody></table>
<h3 id="leanpub-auto-parameters">
<span class="section-number">9.6 </span>Parameters</h3>

<h4 id="leanpub-auto-parameters-versus-local-variables">
<span class="section-number">9.6.1 </span>Parameters versus local variables</h4>

<p>If you <code>let</code>-declare a variable that has the same name as a parameter, you get a static (load-time) error:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">func</code><code class="p">(</code><code class="nx">arg</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">arg</code><code class="p">;</code> <code class="c1">// static error: duplicate declaration of `arg`</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Doing the same inside a block shadows the parameter:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">func</code><code class="p">(</code><code class="nx">arg</code><code class="p">)</code> <code class="p">{</code>
    <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">arg</code><code class="p">;</code> <code class="c1">// shadows parameter `arg`</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In contrast, <code>var</code>-declaring a variable that has the same name as a parameter does nothing, just like re-declaring a <code>var</code> variable within the same scope does nothing.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">func</code><code class="p">(</code><code class="nx">arg</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">arg</code><code class="p">;</code> <code class="c1">// does nothing</code>
<code class="p">}</code>
</pre></div>

</div>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">func</code><code class="p">(</code><code class="nx">arg</code><code class="p">)</code> <code class="p">{</code>
    <code class="p">{</code>
        <code class="c1">// We are still in same `var` scope as `arg`</code>
        <code class="kd">var</code> <code class="nx">arg</code><code class="p">;</code> <code class="c1">// does nothing</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-parameter-default-values-and-the-temporal-dead-zone">
<span class="section-number">9.6.2 </span>Parameter default values and the temporal dead zone</h4>

<p>If parameters have default values, they are treated like a sequence of <code>let</code> statements and are subject to temporal dead zones:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// OK: `y` accesses `x` after it has been declared</code>
<code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">x</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">];</code>
<code class="p">}</code>
<code class="nx">foo</code><code class="p">();</code> <code class="c1">// [1,1]</code>

<code class="c1">// Exception: `x` tries to access `y` within TDZ</code>
<code class="kd">function</code> <code class="nx">bar</code><code class="p">(</code><code class="nx">x</code><code class="o">=</code><code class="nx">y</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">];</code>
<code class="p">}</code>
<code class="nx">bar</code><code class="p">();</code> <code class="c1">// ReferenceError</code>
</pre></div>

</div>

<h4 id="leanpub-auto-parameter-default-values-dont-see-the-scope-of-the-body">
<span class="section-number">9.6.3 </span>Parameter default values don’t see the scope of the body</h4>

<p>The scope of parameter default values is separate from the scope of the body (the former surrounds the latter). That means that methods or functions defined “inside” parameter default values don’t see the local variables of the body:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">foo</code> <code class="o">=</code> <code class="s1">'outer'</code><code class="p">;</code>
<code class="kd">function</code> <code class="nx">bar</code><code class="p">(</code><code class="nx">func</code> <code class="o">=</code> <code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">foo</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">foo</code> <code class="o">=</code> <code class="s1">'inner'</code><code class="p">;</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">func</code><code class="p">());</code> <code class="c1">// outer</code>
<code class="p">}</code>
<code class="nx">bar</code><code class="p">();</code>
</pre></div>

</div>

<h3 id="leanpub-auto-the-global-object">
<span class="section-number">9.7 </span>The global object</h3>

<p>JavaScript’s <a href="http://speakingjs.com/es5/ch16.html#global_object">global object</a> (<code>window</code> in web browsers, <code>global</code> in Node.js) is more a bug than a feature, especially with regard to performance. That’s why it’s not surprising that ES6 introduces a distinction:</p>

<ul>
<li>All properties of the global object are global variables. In global scope, the following declarations create such properties:
    <ul>
<li>
<code>var</code> declarations</li>
      <li>Function declarations</li>
    </ul>
</li>
  <li>But there are now also global variables that are not properties of the global object. In global scope, the following declarations create such variables:
    <ul>
<li>
<code>let</code> declarations</li>
      <li>
<code>const</code> declarations</li>
      <li>Class declarations</li>
    </ul>
</li>
</ul>
<h3 id="leanpub-auto-function-declarations-and-class-declarations">
<span class="section-number">9.8 </span>Function declarations and class declarations</h3>

<p>Function declarations…</p>

<ul>
<li>are block-scoped, like <code>let</code>.</li>
  <li>create properties on the global object (while in global scope), like <code>var</code>.</li>
  <li>are <em>hoisted</em>: independently of where a function declaration is mentioned in its scope, it is always created at the beginning of the scope.</li>
</ul>
<p>The following code demonstrates the hoisting of function declarations:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code> <code class="c1">// Enter a new scope</code>

    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">foo</code><code class="p">());</code> <code class="c1">// OK, due to hoisting</code>
    <code class="kd">function</code> <code class="nx">foo</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'hello'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Class declarations…</p>

<ul>
<li>are block-scoped.</li>
  <li>don’t create properties on the global object.</li>
  <li>are <em>not</em> hoisted.</li>
</ul>
<p>Classes not being hoisted may be surprising, because, under the hood, they create functions. The rationale for this behavior is that the values of their <code>extends</code> clauses are defined via expressions and those expressions have to be executed at the appropriate times.</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code> <code class="c1">// Enter a new scope</code>

    <code class="kr">const</code> <code class="nx">identity</code> <code class="o">=</code> <code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code><code class="p">;</code>

    <code class="c1">// Here we are in the temporal dead zone of `MyClass`</code>
    <code class="kd">let</code> <code class="nx">inst</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyClass</code><code class="p">();</code> <code class="c1">// ReferenceError</code>

    <code class="c1">// Note the expression in the `extends` clause</code>
    <code class="kr">class</code> <code class="nx">MyClass</code> <code class="kr">extends</code> <code class="nx">identity</code><code class="p">(</code><code class="nb">Object</code><code class="p">)</code> <code class="p">{</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<h3 id="var-vs-let-vs-const">
<span class="section-number">9.9 </span>Coding style: <code>var</code> vs. <code>let</code> vs. <code>const</code>
</h3>

<p><code>var</code> can do one thing that <code>let</code> and <code>const</code> can’t: variables declared via it become properties of the global object. But the same effect can be achieved by assigning to <code>window</code> (in browsers) or <code>global</code> (in Node.js). Therefore, I recommend to always use <code>let</code> and <code>const</code>.</p>

<p>Use <code>const</code> for things that are completely immutable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Primitive values are immutable</code>
<code class="kr">const</code> <code class="nx">PUBLIC_SYMBOL</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">MAX_ENTRIES</code> <code class="o">=</code> <code class="mi">1000</code><code class="p">;</code>

<code class="c1">// Some objects are immutable</code>
<code class="kr">const</code> <code class="nx">EMPTY_ARRAY</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">freeze</code><code class="p">([]);</code>
</pre></div>

</div>

<p>Use <code>let</code> for mutable things:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// A primitive whose value changes</code>
<code class="kd">let</code> <code class="nx">counter</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="nx">counter</code><code class="o">++</code><code class="p">;</code>

<code class="c1">// A mutable object</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{};</code>
<code class="nx">obj</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
</pre></div>

</div>

<p>This is not a hard and fast rule. I don’t see a problem with using <code>const</code> for a mutable object.</p>

<h2 id="ch_destructuring">
<span class="section-number">10. </span>Destructuring</h2>

<p>ECMAScript 6 (ES6) supports <em>destructuring</em>, a convenient way to extract values from data stored in (possibly nested) objects and Arrays. This chapter describes how it works and gives examples of its usefulness.</p>


<h3 id="leanpub-auto-overview-5">
<span class="section-number">10.1 </span>Overview</h3>

<p>In locations that receive data (such as the left-hand side of an assignment), destructuring lets you use patterns to extract parts of that data.</p>

<p>The following code is an example of destructuring:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="s1">'Jane'</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="s1">'Doe'</code> <code class="p">};</code>
<code class="kd">let</code> <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="nx">f</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="nx">l</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">;</code> <code class="c1">// (A)</code>
    <code class="c1">// f = 'Jane'; l = 'Doe'</code>
</pre></div>

</div>

<p>In line A we destructure <code>obj</code>: we extract data from it via a pattern on the left-hand side of the assignment operator (<code>=</code>) and assign that data to the variables <code>f</code> and <code>l</code>. These variables are automatically declared beforehand, because the line starts with a <code>let</code>.</p>

<p>You can destructure Arrays, too:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">];</code> <code class="c1">// x = 'a'; y = 'b'</code>
</pre></div>

</div>

<p>Destructuring can be used in the following locations:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Variable declarations:</code>
<code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">];</code>
<code class="kr">const</code> <code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">];</code>
<code class="kd">var</code> <code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">];</code>

<code class="c1">// Assignments:</code>
<code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">];</code>

<code class="c1">// Parameter definitions:</code>
<code class="kd">function</code> <code class="nx">f</code><code class="p">([</code><code class="nx">x</code><code class="p">])</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
<code class="nx">f</code><code class="p">([</code><code class="s1">'a'</code><code class="p">]);</code>
</pre></div>

</div>

<p>You can also destructure in a <code>for-of</code> loop:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Handled like a variable declaration:</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">k</code><code class="p">,</code><code class="nx">v</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">entries</code><code class="p">())</code> <code class="err">···</code>

<code class="c1">// Handled like an assignment</code>
<code class="k">for</code> <code class="p">({</code><code class="nx">name</code><code class="o">:</code> <code class="nx">n</code><code class="p">,</code> <code class="nx">age</code><code class="o">:</code> <code class="nx">a</code><code class="p">}</code> <code class="nx">of</code> <code class="nx">arr</code><code class="p">)</code> <code class="err">···</code>
</pre></div>

</div>


<h3 id="leanpub-auto-background-constructing-data-object-and-array-literals-vs-extracting-data-destructuring">
<span class="section-number">10.2 </span>Background: Constructing data (object and Array literals) vs. extracting data (destructuring)</h3>

<p>To fully understand what destructuring is, let’s first examine its broader context. JavaScript has operations for constructing data:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{};</code>
<code class="nx">obj</code><code class="p">.</code><code class="nx">first</code> <code class="o">=</code> <code class="s1">'Jane'</code><code class="p">;</code>
<code class="nx">obj</code><code class="p">.</code><code class="nx">last</code> <code class="o">=</code> <code class="s1">'Doe'</code><code class="p">;</code>
</pre></div>

</div>

<p>And it has operations for extracting data:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">f</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">first</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">l</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">last</code><code class="p">;</code>
</pre></div>

</div>

<p>Note that we are using the same syntax that we have used for constructing.</p>

<p>There is nicer syntax for constructing – an <em>object literal</em>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="s1">'Jane'</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="s1">'Doe'</code> <code class="p">};</code>
</pre></div>

</div>

<p><em>Destructuring</em> in ECMAScript 6 enables the same syntax for extracting data, where it is called an <em>object pattern</em>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="nx">f</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="nx">l</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">;</code>
</pre></div>

</div>

<p>Just as the object literal lets us create multiple properties at the same time, the object pattern lets us extract multiple properties at the same time.</p>

<p>You can also destructure Arrays via patterns:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">];</code> <code class="c1">// x = 'a'; y = 'b'</code>
</pre></div>

</div>


<h3 id="leanpub-auto-patterns">
<span class="section-number">10.3 </span>Patterns</h3>

<p>The following two parties are involved in destructuring:</p>

<ul>
<li>
<strong>Destructuring source:</strong> the data to be destructured. For example, the right-hand side of a destructuring assignment.</li>
  <li>
<strong>Destructuring target:</strong> the pattern used for destructuring. For example, the left-hand side of a destructuring assignment.</li>
</ul>
<p>The destructuring target is either one of three patterns:</p>

<ul>
<li>
<strong>Assignment target.</strong> For example: <code>x</code>
    <ul>
<li>In variable declarations and parameter definitions, only references to variables are allowed. In destructuring assignment, you have more options, as I’ll explain later.</li>
    </ul>
</li>
  <li>
<strong>Object pattern.</strong> For example: <code>{ first: «pattern», last: «pattern» }</code>
    <ul>
<li>The parts of an object pattern are properties, the property values are again patterns (recursively).</li>
    </ul>
</li>
  <li>
<strong>Array pattern.</strong> For example: <code>[ «pattern», «pattern» ]</code>
    <ul>
<li>The parts of an Array pattern are elements, the elements are again patterns (recursively).</li>
    </ul>
</li>
</ul>
<p>That means that you can nest patterns, arbitrarily deeply:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">a</code><code class="o">:</code> <code class="p">[{</code> <code class="nx">foo</code><code class="o">:</code> <code class="mi">123</code><code class="p">,</code> <code class="nx">bar</code><code class="o">:</code> <code class="s1">'abc'</code> <code class="p">},</code> <code class="p">{}],</code> <code class="nx">b</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
<code class="kd">let</code> <code class="p">{</code> <code class="nx">a</code><code class="o">:</code> <code class="p">[{</code><code class="nx">foo</code><code class="o">:</code> <code class="nx">f</code><code class="p">}]</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">;</code> <code class="c1">// f = 123</code>
</pre></div>

</div>

<h4 id="leanpub-auto-pick-what-you-need">
<span class="section-number">10.3.1 </span>Pick what you need</h4>

<p>If you destructure an object, you mention only those properties that you are interested in:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="nx">x</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">7</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">3</code> <code class="p">};</code> <code class="c1">// x = 7</code>
</pre></div>

</div>

<p>If you destructure an Array, you can choose to only extract a prefix:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code><code class="nx">y</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">];</code> <code class="c1">// x='a'; y='b';</code>
</pre></div>

</div>


<h3 id="leanpub-auto-how-do-patterns-access-the-innards-of-values">
<span class="section-number">10.4 </span>How do patterns access the innards of values?</h3>

<p>In an assignment <code>pattern = someValue</code>, how does the <code>pattern</code> access what’s inside <code>someValue</code>?</p>

<h4 id="leanpub-auto-object-patterns-coerce-values-to-objects">
<span class="section-number">10.4.1 </span>Object patterns coerce values to objects</h4>

<p>The object pattern coerces destructuring sources to objects before accessing properties. That means that it works with primitive values:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code><code class="nx">length</code> <code class="o">:</code> <code class="nx">len</code><code class="p">}</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">;</code> <code class="c1">// len = 3</code>
<code class="kd">let</code> <code class="p">{</code><code class="nx">toString</code><code class="o">:</code> <code class="nx">s</code><code class="p">}</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code> <code class="c1">// s = Number.prototype.toString</code>
</pre></div>

</div>

<h5 id="leanpub-auto-failing-to-object-destructure-a-value">
<span class="section-number">10.4.1.1 </span>Failing to object-destructure a value</h5>

<p>The coercion to object is not performed via <code>Object()</code>, but via the internal operation <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-toobject"><code>ToObject()</code></a>. <code>Object()</code> never fails:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">typeof</code> <code class="n">Object</code><code class="p">(</code><code class="err">'</code><code class="n">abc</code><code class="err">'</code><code class="p">)</code>
<code class="err">'</code><code class="n">object</code><code class="err">'</code>
<code class="o">&gt;</code> <code class="n">var</code> <code class="n">obj</code> <code class="o">=</code> <code class="p">{};</code>
<code class="o">&gt;</code> <code class="n">Object</code><code class="p">(</code><code class="n">obj</code><code class="p">)</code> <code class="o">===</code> <code class="n">obj</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">Object</code><code class="p">(</code><code class="n">undefined</code><code class="p">)</code>
<code class="p">{}</code>
<code class="o">&gt;</code> <code class="n">Object</code><code class="p">(</code><code class="n">null</code><code class="p">)</code>
<code class="p">{}</code>
</pre></div>

</div>

<p><code>ToObject()</code> throws a <code>TypeError</code> if it encounters <code>undefined</code> or <code>null</code>. Therefore, the following destructurings fail, even before destructuring accesses any properties:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="nx">x</code> <code class="p">}</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">;</code> <code class="c1">// TypeError</code>
<code class="kd">let</code> <code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="nx">y</code> <code class="p">}</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code> <code class="c1">// TypeError</code>
</pre></div>

</div>

<p>As a consequence, you can use the empty object pattern <code>{}</code> to check whether a value is coercible to an object. As we have seen, only <code>undefined</code> and <code>null</code> aren’t:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">({}</code> <code class="o">=</code> <code class="p">[</code><code class="kc">true</code><code class="p">,</code> <code class="kc">false</code><code class="p">]);</code> <code class="c1">// OK, Arrays are coercible to objects</code>
<code class="p">({}</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">);</code> <code class="c1">// OK, strings are coercible to objects</code>

<code class="p">({}</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">);</code> <code class="c1">// TypeError</code>
<code class="p">({}</code> <code class="o">=</code> <code class="kc">null</code><code class="p">);</code> <code class="c1">// TypeError</code>
</pre></div>

</div>

<p>The parentheses around the expressions are necessary because statements must not begin with curly braces in JavaScript.</p>

<h4 id="leanpub-auto-array-patterns-work-with-iterables">
<span class="section-number">10.4.2 </span>Array patterns work with iterables</h4>

<p>Array destructuring uses an iterator to get to the elements of a source. Therefore, you can Array-destructure any value that is iterable. Let’s look at examples of iterable values.</p>

<p>Strings are iterable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,...</code><code class="nx">y</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">;</code> <code class="c1">// x='a'; y=['b', 'c']</code>
</pre></div>

</div>

<p>Don’t forget that the iterator over strings returns code points (“Unicode characters”, 21 bits), not code units (“JavaScript characters”, 16 bits). (For more information on Unicode, consult the chapter “<a href="http://speakingjs.com/es5/ch24.html">Chapter 24. Unicode and JavaScript</a>” in “Speaking JavaScript”.) For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code><code class="nx">y</code><code class="p">,</code><code class="nx">z</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'a\uD83D\uDCA9c'</code><code class="p">;</code> <code class="c1">// x='a'; y='\uD83D\uDCA9'; z='c'</code>
</pre></div>

</div>

<p>You can’t access the elements of a Set via indices, but you can do so via an iterator. Therefore, Array destructuring works for Sets:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code><code class="nx">y</code><code class="p">]</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">]);</code> <code class="c1">// x='a'; y='b’;</code>
</pre></div>

</div>

<p>The <code>Set</code> iterator always returns elements in the order in which they were inserted, which is why the result of the previous destructuring is always the same.</p>

<p><strong>Infinite sequences.</strong> Destructuring also works for iterators over infinite sequences. The generator function <code>allNaturalNumbers()</code> returns an iterator that yields 0, 1, 2, etc.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">allNaturalNumbers</code><code class="p">()</code> <code class="p">{</code>
  <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">n</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="p">;</code> <code class="nx">n</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="nx">n</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The following destructuring extracts the first three elements of that infinite sequence.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="nx">z</code><code class="p">]</code> <code class="o">=</code> <code class="nx">allNaturalNumbers</code><code class="p">();</code> <code class="c1">// x=0; y=1; z=2</code>
</pre></div>

</div>

<h5 id="leanpub-auto-failing-to-array-destructure-a-value">
<span class="section-number">10.4.2.1 </span>Failing to Array-destructure a value</h5>

<p>A value is iterable if it has a method whose key is <code>Symbol.iterator</code> that returns an object. Array-destructuring throws a <code>TypeError</code> if the value to be destructured isn’t iterable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">x</code><code class="p">;</code>
<code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="kc">true</code><code class="p">,</code> <code class="kc">false</code><code class="p">];</code> <code class="c1">// OK, Arrays are iterable</code>
<code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">;</code> <code class="c1">// OK, strings are iterable</code>
<code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code> <code class="o">*</code> <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code> <code class="k">yield</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">};</code> <code class="c1">// OK, iterable</code>

<code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// TypeError, empty objects are not iterable</code>
<code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">;</code> <code class="c1">// TypeError, not iterable</code>
<code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code> <code class="c1">// TypeError, not iterable</code>
</pre></div>

</div>

<p>The <code>TypeError</code> is thrown even before accessing elements of the iterable, which means that you can use the empty Array pattern <code>[]</code> to check whether a value is iterable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[]</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// TypeError, empty objects are not iterable</code>
<code class="p">[]</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">;</code> <code class="c1">// TypeError, not iterable</code>
<code class="p">[]</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code> <code class="c1">// TypeError, not iterable</code>
</pre></div>

</div>


<h3 id="leanpub-auto-if-a-part-has-no-match">
<span class="section-number">10.5 </span>If a part has no match</h3>

<p>Similarly to how JavaScript handles non-existent properties and Array elements, destructuring fails silently if the target mentions a part that doesn’t exist in the source: the interior of the part is matched against <code>undefined</code>. If the interior is a variable that means that the variable is set to <code>undefined</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">[];</code> <code class="c1">// x = undefined</code>
<code class="kd">let</code> <code class="p">{</code><code class="nx">prop</code><code class="o">:</code><code class="nx">y</code><code class="p">}</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// y = undefined</code>
</pre></div>

</div>

<p>Remember that object patterns and Array patterns throw a <code>TypeError</code> if they are matched against <code>undefined</code>.</p>


<h4 id="leanpub-auto-default-values">
<span class="section-number">10.5.1 </span>Default values</h4>

<p><em>Default values</em> are a feature of patterns: If a part (an object property or an Array element) has no match in the source, it is matched against:</p>

<ul>
<li>its <em>default value</em> (if specified)</li>
  <li>
<code>undefined</code> (otherwise)</li>
</ul>
<p>That is, providing a default value is optional.</p>

<p>Let’s look at an example. In the following destructuring, the element at index 0 has no match on the right-hand side. Therefore, destructuring continues by matching <code>x</code> against 3, which leads to <code>x</code> being set to 3.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="p">]</code> <code class="o">=</code> <code class="p">[];</code> <code class="c1">// x = 3; y = undefined</code>
</pre></div>

</div>

<p>You can also use default values in object patterns:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code><code class="nx">foo</code><code class="o">:</code> <code class="nx">x</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code> <code class="nx">bar</code><code class="o">:</code> <code class="nx">y</code><code class="p">}</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// x = 3; y = undefined</code>
</pre></div>

</div>

<h5 id="leanpub-auto-undefined-triggers-default-values">
<span class="section-number">10.5.1.1 </span><code>undefined</code> triggers default values</h5>

<p>Default values are also used if a part does have a match and that match is <code>undefined</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="o">=</code><code class="mi">1</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="kc">undefined</code><code class="p">];</code> <code class="c1">// x = 1</code>
<code class="kd">let</code> <code class="p">{</code><code class="nx">prop</code><code class="o">:</code> <code class="nx">y</code><code class="o">=</code><code class="mi">2</code><code class="p">}</code> <code class="o">=</code> <code class="p">{</code><code class="nx">prop</code><code class="o">:</code> <code class="kc">undefined</code><code class="p">};</code> <code class="c1">// y = 2</code>
</pre></div>

</div>

<p>The rationale for this behavior is explained in the next chapter, in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_parameter-default-values">the section on parameter default values</a>.</p>

<h5 id="leanpub-auto-default-values-are-computed-on-demand">
<span class="section-number">10.5.1.2 </span>Default values are computed on demand</h5>

<p>The default values themselves are only computed when they are needed. In other words, this destructuring:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code><code class="nx">prop</code><code class="o">:</code> <code class="nx">y</code><code class="o">=</code><code class="nx">someFunc</code><code class="p">()}</code> <code class="o">=</code> <code class="nx">someValue</code><code class="p">;</code>
</pre></div>

</div>

<p>is equivalent to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">y</code><code class="p">;</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">someValue</code><code class="p">.</code><code class="nx">prop</code> <code class="o">===</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">y</code> <code class="o">=</code> <code class="nx">someFunc</code><code class="p">();</code>
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="nx">y</code> <code class="o">=</code> <code class="nx">someValue</code><code class="p">.</code><code class="nx">prop</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>You can observe that if you use <code>console.log()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">function</code> <code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code> <code class="k">return</code> <code class="s1">'YES'</code> <code class="p">}</code>

<code class="o">&gt;</code> <code class="kd">let</code> <code class="cp">[</code><code class="n">a</code><code class="o">=</code><code class="k">log</code><code class="p">(</code><code class="s1">'hello'</code><code class="p">)</code><code class="cp">]</code> <code class="o">=</code> <code class="cp">[]</code><code class="p">;</code>
<code class="nx">hello</code>
<code class="o">&gt;</code> <code class="nx">a</code>
<code class="s1">'YES'</code>

<code class="o">&gt;</code> <code class="kd">let</code> <code class="cp">[</code><code class="n">b</code><code class="o">=</code><code class="k">log</code><code class="p">(</code><code class="s1">'hello'</code><code class="p">)</code><code class="cp">]</code> <code class="o">=</code> <code class="cp">[</code><code class="mi">123</code><code class="cp">]</code><code class="p">;</code>
<code class="o">&gt;</code> <code class="nx">b</code>
<code class="mi">123</code>
</pre></div>

</div>

<p>In the second destructuring, the default value is not triggered and <code>log()</code> is not called.</p>

<h5 id="leanpub-auto-default-values-can-refer-to-other-variables-in-the-pattern">
<span class="section-number">10.5.1.3 </span>Default values can refer to other variables in the pattern</h5>

<p>A default value can refer to any variable, including another variable in the same pattern:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">[];</code>     <code class="c1">// x=3; y=3</code>
<code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="mi">7</code><code class="p">];</code>    <code class="c1">// x=7; y=7</code>
<code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="mi">7</code><code class="p">,</code> <code class="mi">2</code><code class="p">];</code> <code class="c1">// x=7; y=2</code>
</pre></div>

</div>

<p>However, order matters: the variables <code>x</code> and <code>y</code> are declared from left to right and produce a <code>ReferenceError</code> if they are accessed before their declaration:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="o">=</code><code class="nx">y</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">3</code><code class="p">]</code> <code class="o">=</code> <code class="p">[];</code> <code class="c1">// ReferenceError</code>
</pre></div>

</div>

<h5 id="leanpub-auto-default-values-for-patterns">
<span class="section-number">10.5.1.4 </span>Default values for patterns</h5>

<p>So far we have only seen default values for variables, but you can also associate them with patterns:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[{</code> <code class="nx">prop</code><code class="o">:</code> <code class="nx">x</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{}]</code> <code class="o">=</code> <code class="p">[];</code>
</pre></div>

</div>

<p>What does this mean? Recall the rule for default values:</p>

<blockquote>
  <p>If the part has no match in the source, destructuring continues with the default value […].</p>
</blockquote>

<p>The element at index 0 has no match, which is why destructuring continues with:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="nx">x</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// x = undefined</code>
</pre></div>

</div>

<p>You can more easily see why things work this way if you replace the pattern <code>{ prop: x }</code> with the variable <code>pattern</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">pattern</code> <code class="o">=</code> <code class="p">{}]</code> <code class="o">=</code> <code class="p">[];</code>
</pre></div>

</div>

<p><strong>More complex default values.</strong> Let’s further explore default values for patterns. In the following example, we assign a value to <code>x</code> via the default value <code>{ prop: 123 }</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[{</code> <code class="nx">prop</code><code class="o">:</code> <code class="nx">x</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="mi">123</code> <code class="p">}]</code> <code class="o">=</code> <code class="p">[];</code>
</pre></div>

</div>

<p>Because the Array element at index 0 has no match on the right-hand side, destructuring continues as follows and <code>x</code> is set to 123.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="nx">x</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="mi">123</code> <code class="p">};</code>  <code class="c1">// x = 123</code>
</pre></div>

</div>

<p>However, <code>x</code> is not assigned a value in this manner if the right-hand side has an element at index 0, because then the default value isn’t triggered.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[{</code> <code class="nx">prop</code><code class="o">:</code> <code class="nx">x</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="mi">123</code> <code class="p">}]</code> <code class="o">=</code> <code class="p">[{}];</code>
</pre></div>

</div>

<p>In this case, destructuring continues with:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="nx">x</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// x = undefined</code>
</pre></div>

</div>

<p>Thus, if you want <code>x</code> to be 123 if either the object or the property is missing, you need to specify a default value for <code>x</code> itself:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[{</code> <code class="nx">prop</code><code class="o">:</code> <code class="nx">x</code><code class="o">=</code><code class="mi">123</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{}]</code> <code class="o">=</code> <code class="p">[{}];</code>
</pre></div>

</div>

<p>Here, destructuring continues as follows, independently of whether the right-hand side is <code>[{}]</code> or <code>[]</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="nx">x</code><code class="o">=</code><code class="mi">123</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// x = 123</code>
</pre></div>

</div>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_eye.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-still-confused">Still confused?</h3>

  <p>A <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_destructuring-algorithm">later section</a> explains destructuring from a different angle, as an algorithm. That may give you additional insight.</p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-more-object-destructuring-features">
<span class="section-number">10.6 </span>More object destructuring features</h3>

<h4 id="leanpub-auto-property-value-shorthands">
<span class="section-number">10.6.1 </span>Property value shorthands</h4>

<p>Property value shorthands are a feature of object literals: If the value of a property is provided via a variable whose name is the same as the key, you can omit the key. This works for destructuring, too:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code> <code class="nx">x</code><code class="p">,</code> <code class="nx">y</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">11</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">8</code> <code class="p">};</code> <code class="c1">// x = 11; y = 8</code>
</pre></div>

</div>

<p>This declaration is equivalent to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="nx">y</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">11</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">8</code> <code class="p">};</code>
</pre></div>

</div>

<p>You can also combine property value shorthands with default values:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code> <code class="nx">x</code><code class="p">,</code> <code class="nx">y</code> <code class="o">=</code> <code class="mi">1</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// x = undefined; y = 1</code>
</pre></div>

</div>

<h4 id="leanpub-auto-computed-property-keys">
<span class="section-number">10.6.2 </span>Computed property keys</h4>

<p>Computed property keys are another object literal feature that also works for destructuring: You can specify the key of a property via an expression, if you put it in square brackets:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">FOO</code> <code class="o">=</code> <code class="s1">'foo'</code><code class="p">;</code>
<code class="kd">let</code> <code class="p">{</code> <code class="p">[</code><code class="nx">FOO</code><code class="p">]</code><code class="o">:</code> <code class="nx">f</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">foo</code><code class="o">:</code> <code class="mi">123</code> <code class="p">};</code> <code class="c1">// f = 123</code>
</pre></div>

</div>

<p>Computed property keys allow you to destructure properties whose keys are symbols:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Create and destructure a property whose key is a symbol</code>
<code class="kr">const</code> <code class="nx">KEY</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="p">[</code><code class="nx">KEY</code><code class="p">]</code><code class="o">:</code> <code class="s1">'abc'</code> <code class="p">};</code>
<code class="kd">let</code> <code class="p">{</code> <code class="p">[</code><code class="nx">KEY</code><code class="p">]</code><code class="o">:</code> <code class="nx">x</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">;</code> <code class="c1">// x = 'abc'</code>

<code class="c1">// Extract Array.prototype[Symbol.iterator]</code>
<code class="kd">let</code> <code class="p">{</code> <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]</code><code class="o">:</code> <code class="nx">func</code> <code class="p">}</code> <code class="o">=</code> <code class="p">[];</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="k">typeof</code> <code class="nx">func</code><code class="p">);</code> <code class="c1">// function</code>
</pre></div>

</div>


<h3 id="leanpub-auto-more-array-destructuring-features">
<span class="section-number">10.7 </span>More Array destructuring features</h3>

<h4 id="leanpub-auto-elision">
<span class="section-number">10.7.1 </span>Elision</h4>

<p>Elision lets you use the syntax of Array “holes” to skip elements during destructuring:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[,,</code><code class="nx">x</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">,</code> <code class="s1">'d'</code><code class="p">];</code> <code class="c1">// x = 'c'</code>
</pre></div>

</div>

<h4 id="sec_rest-operator">
<span class="section-number">10.7.2 </span>Rest operator (<code>...</code>)</h4>

<p>The <em>rest operator</em> lets you extract the remaining elements of an Array into an Array. You can only use the operator as the last part inside an Array pattern:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="p">...</code><code class="nx">y</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">];</code> <code class="c1">// x='a'; y=['b', 'c']</code>
</pre></div>

</div>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <p>The rest operator operator extracts data. The same syntax (<code>...</code>) is used by the <em>spread operator</em>, which contributes data to Array literals and function calls and is explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_spread-operator">the next chapter</a>.</p>

    </td>
  </tr></tbody></table>
<p>If the operator can’t find any elements, it matches its operand against the empty Array. That is, it never produces <code>undefined</code> or <code>null</code>. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="p">...</code><code class="nx">z</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">];</code> <code class="c1">// x='a'; y=undefined; z=[]</code>
</pre></div>

</div>

<p>The operand of the rest operator doesn’t have to be a variable, you can use patterns, too:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="p">...[</code><code class="nx">y</code><code class="p">,</code> <code class="nx">z</code><code class="p">]]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">];</code>
    <code class="c1">// x = 'a'; y = 'b'; z = 'c'</code>
</pre></div>

</div>

<p>The rest operator triggers the following destructuring:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code><code class="nx">y</code><code class="p">,</code> <code class="nx">z</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">]</code>
</pre></div>

</div>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_spread-operator">The spread operator (<code>...</code>)</a> looks exactly like the rest operator, but it is used inside function calls and Array literals (not inside destructuring patterns).</p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-you-can-assign-to-more-than-just-variables">
<span class="section-number">10.8 </span>You can assign to more than just variables</h3>

<p>If you assign via destructuring, each assignment target can be everything that is allowed on the left-hand side of a normal assignment, including a reference to a property (<code>obj.prop</code>) and a reference to an Array element (<code>arr[0]</code>).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{};</code>
<code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[];</code>

<code class="p">({</code> <code class="nx">foo</code><code class="o">:</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">prop</code><code class="p">,</code> <code class="nx">bar</code><code class="o">:</code> <code class="nx">arr</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="p">})</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">foo</code><code class="o">:</code> <code class="mi">123</code><code class="p">,</code> <code class="nx">bar</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code> <code class="c1">// {prop:123}</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">arr</code><code class="p">);</code> <code class="c1">// [true]</code>
</pre></div>

</div>

<p>You can also assign to object properties and Array elements via the rest operator (<code>...</code>):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{};</code>
<code class="p">[</code><code class="nx">first</code><code class="p">,</code> <code class="p">...</code><code class="nx">obj</code><code class="p">.</code><code class="nx">rest</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">];</code>
    <code class="c1">// first = 'a'; obj.rest = ['b', 'c']</code>
</pre></div>

</div>

<p>If you <em>declare</em> variables or define parameters via destructuring then you must use simple identifiers, you can’t refer to object properties and Array elements.</p>


<h3 id="leanpub-auto-pitfalls-of-destructuring">
<span class="section-number">10.9 </span>Pitfalls of destructuring</h3>

<p>There are two things to be mindful of when using destructuring:</p>

<ul>
<li>You can’t start a statement with a curly brace.</li>
  <li>During destructuring, you can either declare variables or assign to them, but not both.</li>
</ul>
<p>The next two sections have the details.</p>

<h4 id="leanpub-auto-dont-start-a-statement-with-a-curly-brace">
<span class="section-number">10.9.1 </span>Don’t start a statement with a curly brace</h4>

<p>Because code blocks begin with a curly brace, statements must not begin with one. This is unfortunate when using object destructuring in an assignment:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code> <code class="nx">a</code><code class="p">,</code> <code class="nx">b</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">someObject</code><code class="p">;</code> <code class="c1">// SyntaxError</code>
</pre></div>

</div>

<p>The work-around is to put the complete expression in parentheses:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">({</code> <code class="nx">a</code><code class="p">,</code> <code class="nx">b</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">someObject</code><code class="p">);</code> <code class="c1">// ok</code>
</pre></div>

</div>

<h4 id="leanpub-auto-you-cant-mix-declaring-and-assigning-to-existing-variables">
<span class="section-number">10.9.2 </span>You can’t mix declaring and assigning to existing variables</h4>

<p>Within a destructuring variable declaration, every variable in the source is declared. In the following example, we are trying to declare the variable <code>b</code> and refer to the existing variable <code>f</code>, which doesn’t work.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">f</code><code class="p">;</code>
<code class="err">···</code>
<code class="kd">let</code> <code class="p">{</code> <code class="nx">foo</code><code class="o">:</code> <code class="nx">f</code><code class="p">,</code> <code class="nx">bar</code><code class="o">:</code> <code class="nx">b</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">someObject</code><code class="p">;</code>
    <code class="c1">// During parsing (before running the code):</code>
    <code class="c1">// SyntaxError: Duplicate declaration, f</code>
</pre></div>

</div>

<p>The fix is to use a destructuring assignment and to declare <code>b</code> beforehand:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">f</code><code class="p">;</code>
<code class="err">···</code>
<code class="kd">let</code> <code class="nx">b</code><code class="p">;</code>
<code class="p">({</code> <code class="nx">foo</code><code class="o">:</code> <code class="nx">f</code><code class="p">,</code> <code class="nx">bar</code><code class="o">:</code> <code class="nx">b</code> <code class="p">})</code> <code class="o">=</code> <code class="nx">someObject</code><code class="p">;</code>
</pre></div>

</div>


<h3 id="leanpub-auto-examples-of-destructuring">
<span class="section-number">10.10 </span>Examples of destructuring</h3>

<p>Let’s start with a few smaller examples.</p>

<p>The <code>for-of</code> loop supports destructuring:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">().</code><code class="nx">set</code><code class="p">(</code><code class="kc">false</code><code class="p">,</code> <code class="s1">'no'</code><code class="p">).</code><code class="nx">set</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code> <code class="s1">'yes'</code><code class="p">);</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">map</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">key</code> <code class="o">+</code> <code class="s1">' is '</code> <code class="o">+</code> <code class="nx">value</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>You can use destructuring to swap values. That is something that engines could optimize, so that no Array would be created.</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="nx">b</code><code class="p">,</code> <code class="nx">a</code><code class="p">];</code>
</pre></div>

</div>

<p>You can use destructuring to split an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">first</code><code class="p">,</code> <code class="p">...</code><code class="nx">rest</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">];</code>
    <code class="c1">// first = 'a'; rest = ['b', 'c']</code>
</pre></div>

</div>

<h4 id="leanpub-auto-destructuring-return-values">
<span class="section-number">10.10.1 </span>Destructuring return values</h4>

<p>Some built-in JavaScript operations return Arrays. Destructuring helps with processing them:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">all</code><code class="p">,</code> <code class="nx">year</code><code class="p">,</code> <code class="nx">month</code><code class="p">,</code> <code class="nx">day</code><code class="p">]</code> <code class="o">=</code>
    <code class="sr">/^(\d\d\d\d)-(\d\d)-(\d\d)$/</code>
    <code class="p">.</code><code class="nx">exec</code><code class="p">(</code><code class="s1">'2999-12-31'</code><code class="p">);</code>
</pre></div>

</div>

<p><code>exec()</code> returns <code>null</code> if the regular expression doesn’t match. Unfortunately, you can’t handle <code>null</code> via default values, which is why you must use the Or operator (<code>||</code>) in this case:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">all</code><code class="p">,</code> <code class="nx">year</code><code class="p">,</code> <code class="nx">month</code><code class="p">,</code> <code class="nx">day</code><code class="p">]</code> <code class="o">=</code>
    <code class="sr">/^(\d\d\d\d)-(\d\d)-(\d\d)$/</code>
    <code class="p">.</code><code class="nx">exec</code><code class="p">(</code><code class="s1">'2999-12-31'</code><code class="p">)</code> <code class="o">||</code> <code class="p">[];</code>
</pre></div>

</div>

<h4 id="sec_multiple-return-values">
<span class="section-number">10.10.2 </span>Multiple return values</h4>

<p>To see the usefulness of multiple return values, let’s implement a function <code>findElement(a, p)</code> that searches for the first element in the Array <code>a</code> for which the function <code>p</code> returns <code>true</code>. The question is: what should that function return? Sometimes one is interested in the element itself, sometimes in its index, sometimes in both. The following implementation returns both.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">findElement</code><code class="p">(</code><code class="nx">array</code><code class="p">,</code> <code class="nx">predicate</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">index</code><code class="p">,</code> <code class="nx">element</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">array</code><code class="p">.</code><code class="nx">entries</code><code class="p">())</code> <code class="p">{</code> <code class="c1">// (A)</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">predicate</code><code class="p">(</code><code class="nx">element</code><code class="p">))</code> <code class="p">{</code>
            <code class="k">return</code> <code class="p">{</code> <code class="nx">element</code><code class="p">,</code> <code class="nx">index</code> <code class="p">};</code> <code class="c1">// (B)</code>
        <code class="p">}</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="p">{</code> <code class="nx">element</code><code class="o">:</code> <code class="kc">undefined</code><code class="p">,</code> <code class="nx">index</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code> <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In line A, the Array method <code>entries()</code> returns an iterable over <code>[index,element]</code> pairs. We destructure one pair per iteration. In line B, we use property value shorthands to return the object <code>{ element: element, index: index }</code>.</p>

<p>Let’s use <code>findElement()</code>. In the following example, several ECMAScript 6 features allow us to write more concise code: The callback is an arrow function, the return value is destructured via an object pattern with property value shorthands.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[</code><code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">6</code><code class="p">];</code>
<code class="kd">let</code> <code class="p">{</code><code class="nx">element</code><code class="p">,</code> <code class="nx">index</code><code class="p">}</code> <code class="o">=</code> <code class="nx">findElement</code><code class="p">(</code><code class="nx">arr</code><code class="p">,</code> <code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">%</code> <code class="mi">2</code> <code class="o">===</code> <code class="mi">0</code><code class="p">);</code>
    <code class="c1">// element = 8, index = 1</code>
</pre></div>

</div>

<p>Due to <code>index</code> and <code>element</code> also referring to property keys, the order in which we mention them doesn’t matter:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code><code class="nx">index</code><code class="p">,</code> <code class="nx">element</code><code class="p">}</code> <code class="o">=</code> <code class="nx">findElement</code><code class="p">(</code><code class="err">···</code><code class="p">);</code>
</pre></div>

</div>

<p>We have successfully handled the case of needing both index and element. What if we are only interested in one of them? It turns out that, thanks to ECMAScript 6, our implementation can take care of that, too. And the syntactic overhead compared to functions with single return values is minimal.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">a</code> <code class="o">=</code> <code class="p">[</code><code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">6</code><code class="p">];</code>

<code class="kd">let</code> <code class="p">{</code><code class="nx">element</code><code class="p">}</code> <code class="o">=</code> <code class="nx">findElement</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">%</code> <code class="mi">2</code> <code class="o">===</code> <code class="mi">0</code><code class="p">);</code>
    <code class="c1">// element = 8</code>

<code class="kd">let</code> <code class="p">{</code><code class="nx">index</code><code class="p">}</code> <code class="o">=</code> <code class="nx">findElement</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">%</code> <code class="mi">2</code> <code class="o">===</code> <code class="mi">0</code><code class="p">);</code>
    <code class="c1">// index = 1</code>
</pre></div>

</div>

<p>Each time, we only extract the value of the one property that we need.</p>


<h3 id="sec_destructuring-algorithm">
<span class="section-number">10.11 </span>The destructuring algorithm</h3>

<p>This section looks at destructuring from a different angle: as a recursive pattern matching algorithm.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_eye.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>This different angle should especially help with understanding default values. If you feel you don’t fully understand them yet, read on.</p>

    </td>
  </tr></tbody></table>
<p>At the end, I’ll use the algorithm to explain the difference between the following two function declarations.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">move</code><code class="p">({</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">}</code> <code class="o">=</code> <code class="p">{})</code>         <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
<code class="kd">function</code> <code class="nx">move</code><code class="p">({</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">0</code> <code class="p">})</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-the-algorithm">
<span class="section-number">10.11.1 </span>The algorithm</h4>

<p>A destructuring assignment looks like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="err">«</code><code class="nx">pattern</code><code class="err">»</code> <code class="o">=</code> <code class="err">«</code><code class="nx">value</code><code class="err">»</code>
</pre></div>

</div>

<p>We want to use <code>pattern</code> to extract data from <code>value</code>. I’ll now describe an algorithm for doing so, which is known in functional programming as <em>pattern matching</em> (short: <em>matching</em>). The algorithm specifies the operator <code>←</code> (“match against”) for destructuring assignment that matches a <code>pattern</code> against a <code>value</code> and assigns to variables while doing so:</p>

<div class="code-block">
<div class="highlight"><pre><code class="err">«</code><code class="nx">pattern</code><code class="err">»</code> <code class="err">←</code> <code class="err">«</code><code class="nx">value</code><code class="err">»</code>
</pre></div>

</div>

<p>The algorithm is specified via recursive rules that take apart both operands of the <code>←</code> operator. The declarative notation may take some getting used to, but it makes the specification of the algorithm more concise. Each rule has two parts:</p>

<ul>
<li>The head specifies which operands are handled by the rule.</li>
  <li>The body specifies what to do next.</li>
</ul>
<p>I only show the algorithm for destructuring assignment. Destructuring variable declarations and destructuring parameter definitions work similarly.</p>

<p>I don’t cover advanced features (computed property keys; property value shorthands; object properties and array elements as assignment targets), either. Only the basics.</p>

<h5 id="leanpub-auto-patterns-1">
<span class="section-number">10.11.1.1 </span>Patterns</h5>

<p>A pattern is either:</p>

<ul>
<li>A variable: <code>x</code>
</li>
  <li>An object pattern: <code>{«properties»}</code>
</li>
  <li>An Array pattern: <code>[«elements»]</code>
</li>
</ul>
<p>Each of the following sections describes one of these three cases.</p>

<h5 id="leanpub-auto-variable">
<span class="section-number">10.11.1.2 </span>Variable</h5>

<ul>
<li>(1) <code>x ← value</code> (including <code>undefined</code> and <code>null</code>)
    <div class="code-block">
<div class="highlight"><pre>  <code class="nx">x</code> <code class="o">=</code> <code class="nx">value</code>
</pre></div>
    
</div>
  </li>
</ul>
<h5 id="leanpub-auto-object-pattern">
<span class="section-number">10.11.1.3 </span>Object pattern</h5>

<ul>
<li>(2a) <code>{«properties»} ← undefined</code>
    <div class="code-block">
<div class="highlight"><pre>  <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">();</code>
</pre></div>
    
</div>
  </li>
  <li>(2b) <code>{«properties»} ← null</code>
    <div class="code-block">
<div class="highlight"><pre>  <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">();</code>
</pre></div>
    
</div>
  </li>
  <li>(2c) <code>{key: «pattern», «properties»} ← obj</code>
    <div class="code-block">
<div class="highlight"><pre>  <code class="err">«</code><code class="nx">pattern</code><code class="err">»</code> <code class="err">←</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">key</code>
  <code class="p">{</code><code class="err">«</code><code class="nx">properties</code><code class="err">»</code><code class="p">}</code> <code class="err">←</code> <code class="nx">obj</code>
</pre></div>
    
</div>
  </li>
  <li>(2d) <code>{key: «pattern» = default_value, «properties»} ← obj</code>
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">key</code><code class="p">;</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">tmp</code> <code class="o">!==</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
      <code class="err">«</code><code class="nx">pattern</code><code class="err">»</code> <code class="err">←</code> <code class="nx">tmp</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
      <code class="err">«</code><code class="nx">pattern</code><code class="err">»</code> <code class="err">←</code> <code class="nx">default_value</code>
  <code class="p">}</code>
  <code class="p">{</code><code class="err">«</code><code class="nx">properties</code><code class="err">»</code><code class="p">}</code> <code class="err">←</code> <code class="nx">obj</code>
</pre></div>
    
</div>
  </li>
  <li>(2e) <code>{} ← obj</code>
    <div class="code-block">
<div class="highlight"><pre>  <code class="c1">// No properties left, nothing to do</code>
</pre></div>
    
</div>
  </li>
</ul>
<h5 id="leanpub-auto-array-pattern">
<span class="section-number">10.11.1.4 </span>Array pattern</h5>

<p><strong>Array pattern and iterable.</strong> The algorithm for Array destructuring starts with an Array pattern and an iterable:</p>

<ul>
<li>(3a) <code>[«elements»] ← non_iterable</code><br><code>assert(!isIterable(non_iterable))</code>
    <div class="code-block">
<div class="highlight"><pre>  <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">();</code>
</pre></div>
    
</div>
  </li>
  <li>(3b) <code>[«elements»] ← iterable</code><br><code>assert(isIterable(iterable))</code>
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code> <code class="nx">iterator</code> <code class="o">=</code> <code class="nx">iterable</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]();</code>
  <code class="err">«</code><code class="nx">elements</code><code class="err">»</code> <code class="err">←</code> <code class="nx">iterator</code>
</pre></div>
    
</div>
  </li>
</ul>
<p>Helper function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">isIterable</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">(</code><code class="nx">value</code> <code class="o">!==</code> <code class="kc">null</code>
        <code class="o">&amp;&amp;</code> <code class="k">typeof</code> <code class="nx">value</code> <code class="o">===</code> <code class="s1">'object'</code>
        <code class="o">&amp;&amp;</code> <code class="k">typeof</code> <code class="nx">value</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]</code> <code class="o">===</code> <code class="s1">'function'</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p><strong>Array elements and iterator.</strong> The algorithm continues with the elements of the pattern and an iterator (obtained from the iterable).</p>

<ul>
<li>(3c) <code>«pattern», «elements» ← iterator</code>
    <div class="code-block">
<div class="highlight"><pre>  <code class="err">«</code><code class="nx">pattern</code><code class="err">»</code> <code class="err">←</code> <code class="nx">getNext</code><code class="p">(</code><code class="nx">iterator</code><code class="p">)</code> <code class="c1">// undefined after last item</code>
  <code class="err">«</code><code class="nx">elements</code><code class="err">»</code> <code class="err">←</code> <code class="nx">iterator</code>
</pre></div>
    
</div>
  </li>
  <li>(3d) <code>«pattern» = default_value, «elements» ← iterator</code>
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="nx">getNext</code><code class="p">(</code><code class="nx">iterator</code><code class="p">);</code>  <code class="c1">// undefined after last item</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">tmp</code> <code class="o">!==</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
      <code class="err">«</code><code class="nx">pattern</code><code class="err">»</code> <code class="err">←</code> <code class="nx">tmp</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
      <code class="err">«</code><code class="nx">pattern</code><code class="err">»</code> <code class="err">←</code> <code class="nx">default_value</code>
  <code class="p">}</code>
  <code class="err">«</code><code class="nx">elements</code><code class="err">»</code> <code class="err">←</code> <code class="nx">iterator</code>
</pre></div>
    
</div>
  </li>
  <li>(3e) <code>, «elements» ← iterator</code> (hole, elision)
    <div class="code-block">
<div class="highlight"><pre>  <code class="nx">getNext</code><code class="p">(</code><code class="nx">iterator</code><code class="p">);</code> <code class="c1">// skip</code>
  <code class="err">«</code><code class="nx">elements</code><code class="err">»</code> <code class="err">←</code> <code class="nx">iterator</code>
</pre></div>
    
</div>
  </li>
  <li>(3f) <code>...«pattern» ← iterator</code> (always last part!)
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="p">[];</code>
  <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">elem</code> <code class="nx">of</code> <code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">tmp</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">elem</code><code class="p">);</code>
  <code class="p">}</code>
  <code class="err">«</code><code class="nx">pattern</code><code class="err">»</code> <code class="err">←</code> <code class="nx">tmp</code>
</pre></div>
    
</div>
  </li>
  <li>(3g) <code>← iterator</code>
    <div class="code-block">
<div class="highlight"><pre>  <code class="c1">// No elements left, nothing to do</code>
</pre></div>
    
</div>
  </li>
</ul>
<p>Helper function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">getNext</code><code class="p">(</code><code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="p">{</code><code class="nx">done</code><code class="p">,</code><code class="nx">value</code><code class="p">}</code> <code class="o">=</code> <code class="nx">iterator</code><code class="p">.</code><code class="nx">next</code><code class="p">();</code>
    <code class="k">return</code> <code class="p">(</code><code class="nx">done</code> <code class="o">?</code> <code class="kc">undefined</code> <code class="o">:</code> <code class="nx">value</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-applying-the-algorithm">
<span class="section-number">10.11.2 </span>Applying the algorithm</h4>

<p>The following function definition has <em>named parameters</em>, a technique that is sometimes called <em>options object</em> and explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_named-parameters">the chapter on parameter handling</a>. The parameters use destructuring and default values in such a way that <code>x</code> and <code>y</code> can be omitted. But the object with the parameter can be omitted, too, as you can see in the last line of the code below. This feature is enabled via the <code>= {}</code> in the head of the function definition.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">move1</code><code class="p">({</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">}</code> <code class="o">=</code> <code class="p">{})</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">];</code>
<code class="p">}</code>
<code class="nx">move1</code><code class="p">({</code><code class="nx">x</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">8</code><code class="p">});</code> <code class="c1">// [3, 8]</code>
<code class="nx">move1</code><code class="p">({</code><code class="nx">x</code><code class="o">:</code> <code class="mi">3</code><code class="p">});</code> <code class="c1">// [3, 0]</code>
<code class="nx">move1</code><code class="p">({});</code> <code class="c1">// [0, 0]</code>
<code class="nx">move1</code><code class="p">();</code> <code class="c1">// [0, 0]</code>
</pre></div>

</div>

<p>But why would you define the parameters as in the previous code snippet? Why not as follows – which is also completely legal ES6 code?</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">move2</code><code class="p">({</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">0</code> <code class="p">})</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">];</code>
<code class="p">}</code>
</pre></div>

</div>

<p>To see why <code>move1()</code> is correct, let’s use both functions for two examples. Before we do that, let’s see how the passing of parameters can be explained via matching.</p>

<h5 id="leanpub-auto-background-passing-parameters-via-matching">
<span class="section-number">10.11.2.1 </span>Background: passing parameters via matching</h5>

<p>For function calls, formal parameters (inside function definitions) are matched against actual parameters (inside function calls). As an example, take the following function definition and the following function call.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">func</code><code class="p">(</code><code class="nx">a</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">b</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
<code class="nx">func</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>
</pre></div>

</div>

<p>The parameters <code>a</code> and <code>b</code> are set up similarly to the following destructuring.</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code><code class="nx">a</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">b</code><code class="o">=</code><code class="mi">0</code><code class="p">]</code> <code class="err">←</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">]</code>
</pre></div>

</div>

<h5 id="leanpub-auto-using-move2">
<span class="section-number">10.11.2.2 </span>Using <code>move2()</code>
</h5>

<p>Let’s examine how destructuring works for <code>move2()</code>.</p>

<p><strong>Example 1.</strong>  <code>move2()</code> leads to this destructuring:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[{</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">0</code> <code class="p">}]</code> <code class="err">←</code> <code class="p">[]</code>
</pre></div>

</div>

<p>The only Array element on the left-hand side does not have a match on the right-hand side, which is why <code>{x,y}</code> is matched against the default value and not against data from the right-hand side (rules 3b, 3d):</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">}</code> <code class="err">←</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">0</code> <code class="p">}</code>
</pre></div>

</div>

<p>The left-hand side contains <em>property value shorthands</em>, it is an abbreviation for:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code><code class="nx">x</code><code class="o">:</code> <code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="nx">y</code><code class="p">}</code> <code class="err">←</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">0</code> <code class="p">}</code>
</pre></div>

</div>

<p>This destructuring leads to the following two assignments (rule 2c, 1):</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">x</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="nx">y</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
</pre></div>

</div>

<p>However, this is the only case in which the default value is used.</p>

<p><strong>Example 2.</strong> Let’s examine the function call <code>move2({z:3})</code> which leads to the following destructuring:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[{</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">}</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">0</code> <code class="p">}]</code> <code class="err">←</code> <code class="p">[{</code><code class="nx">z</code><code class="o">:</code><code class="mi">3</code><code class="p">}]</code>
</pre></div>

</div>

<p>There is an Array element at index 0 on the right-hand side. Therefore, the default value is ignored and the next step is (rule 3d):</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">}</code> <code class="err">←</code> <code class="p">{</code> <code class="nx">z</code><code class="o">:</code> <code class="mi">3</code> <code class="p">}</code>
</pre></div>

</div>

<p>That leads to both <code>x</code> and <code>y</code> being set to <code>undefined</code>, which is not what we want.</p>

<h5 id="leanpub-auto-using-move1">
<span class="section-number">10.11.2.3 </span>Using <code>move1()</code>
</h5>

<p>Let’s try <code>move1()</code>.</p>

<p><strong>Example 1:</strong> <code>move1()</code></p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[{</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">}</code> <code class="o">=</code> <code class="p">{}]</code> <code class="err">←</code> <code class="p">[]</code>
</pre></div>

</div>

<p>We don’t have an Array element at index 0 on the right-hand side and use the default value (rule 3d):</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">}</code> <code class="err">←</code> <code class="p">{}</code>
</pre></div>

</div>

<p>The left-hand side contains property value shorthands, which means that this destructuring is equivalent to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code><code class="nx">x</code><code class="o">:</code> <code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">}</code> <code class="err">←</code> <code class="p">{}</code>
</pre></div>

</div>

<p>Neither property <code>x</code> nor property <code>y</code> have a match on the right-hand side. Therefore, the default values are used and the following destructurings are performed next (rule 2d):</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">x</code> <code class="err">←</code> <code class="mi">0</code>
<code class="nx">y</code> <code class="err">←</code> <code class="mi">0</code>
</pre></div>

</div>

<p>That leads to the following assignments (rule 1):</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">x</code> <code class="o">=</code> <code class="mi">0</code>
<code class="nx">y</code> <code class="o">=</code> <code class="mi">0</code>
</pre></div>

</div>

<p><strong>Example 2:</strong> <code>move1({z:3})</code></p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[{</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">}</code> <code class="o">=</code> <code class="p">{}]</code> <code class="err">←</code> <code class="p">[{</code><code class="nx">z</code><code class="o">:</code><code class="mi">3</code><code class="p">}]</code>
</pre></div>

</div>

<p>The first element of the Array pattern has a match on the right-hand side and that match is used to continue destructuring (rule 3d):</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">}</code> <code class="err">←</code> <code class="p">{</code><code class="nx">z</code><code class="o">:</code><code class="mi">3</code><code class="p">}</code>
</pre></div>

</div>

<p>Like in example 1, there are no properties <code>x</code> and <code>y</code> on the right-hand side and the default values are used:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">x</code> <code class="o">=</code> <code class="mi">0</code>
<code class="nx">y</code> <code class="o">=</code> <code class="mi">0</code>
</pre></div>

</div>

<h4 id="leanpub-auto-conclusion-1">
<span class="section-number">10.11.3 </span>Conclusion</h4>

<p>The examples demonstrate that default values are a feature of pattern parts (object properties or Array elements). If a part has no match or is matched against <code>undefined</code> then the default value is used. That is, the pattern is matched against the default value, instead.</p>

<h2 id="ch_parameter-handling">
<span class="section-number">11. </span>Parameter handling</h2>

<p>Parameter handling has been significantly upgraded in ECMAScript 6. It now supports parameter default values, rest parameters (varargs) and destructuring.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_eye.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>For this chapter, it is useful to be familiar with destructuring (which is explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_destructuring">the previous chapter</a>).</p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-overview-6">
<span class="section-number">11.1 </span>Overview</h3>

<p>Default parameter values:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">findClosestShape</code><code class="p">(</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// ...</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Rest parameters:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">format</code><code class="p">(</code><code class="nx">pattern</code><code class="p">,</code> <code class="p">...</code><code class="nx">params</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">params</code><code class="p">;</code>
<code class="p">}</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">format</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">));</code> <code class="c1">// ['b', 'c']</code>
</pre></div>

</div>

<p>Named parameters via destructuring:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">selectEntries</code><code class="p">({</code> <code class="nx">start</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">end</code><code class="o">=-</code><code class="mi">1</code><code class="p">,</code> <code class="nx">step</code><code class="o">=</code><code class="mi">1</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{})</code> <code class="p">{</code>
    <code class="c1">// The object pattern is an abbreviation of:</code>
    <code class="c1">// { start: start=0, end: end=-1, step: step=1 }</code>

    <code class="c1">// Use the variables `start`, `end` and `step` here</code>
    <code class="err">···</code>
<code class="p">}</code>

<code class="nx">selectEntries</code><code class="p">({</code> <code class="nx">start</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code> <code class="nx">end</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">step</code><code class="o">:</code> <code class="mi">2</code> <code class="p">});</code>
<code class="nx">selectEntries</code><code class="p">({</code> <code class="nx">step</code><code class="o">:</code> <code class="mi">3</code> <code class="p">});</code>
<code class="nx">selectEntries</code><code class="p">({});</code>
<code class="nx">selectEntries</code><code class="p">();</code>
</pre></div>

</div>

<h4 id="leanpub-auto-spread-operator-">
<span class="section-number">11.1.1 </span>Spread operator (<code>...</code>)</h4>

<p>In function and constructor calls, the spread operator turns iterable values into arguments:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">3</code><code class="p">)</code>
<code class="mi">11</code>
<code class="o">&gt;</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(...[</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">3</code><code class="p">])</code>
<code class="mi">11</code>
<code class="o">&gt;</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="p">...[</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">11</code><code class="p">],</code> <code class="mi">3</code><code class="p">)</code>
<code class="mi">11</code>
</pre></div>

</div>

<p>In Array literals, the spread operator turns iterable values into Array elements:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="p">...[</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">],</code> <code class="mi">4</code><code class="p">]</code>
<code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">]</code>
</pre></div>

</div>

<h3 id="leanpub-auto-parameter-handling-as-destructuring">
<span class="section-number">11.2 </span>Parameter handling as destructuring</h3>

<p>The ES6 way of handling parameters is equivalent to destructuring the actual parameters via the formal parameters. That is, the following function call:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">func</code><code class="p">(</code><code class="err">«</code><code class="nx">FORMAL_PARAMETERS</code><code class="err">»</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">«</code><code class="nx">CODE</code><code class="err">»</code>
<code class="p">}</code>
<code class="nx">func</code><code class="p">(</code><code class="err">«</code><code class="nx">ACTUAL_PARAMETERS</code><code class="err">»</code><code class="p">);</code>
</pre></div>

</div>

<p>is roughly equivalent to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code>
    <code class="kd">let</code> <code class="p">[</code><code class="err">«</code><code class="nx">FORMAL_PARAMETERS</code><code class="err">»</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="err">«</code><code class="nx">ACTUAL_PARAMETERS</code><code class="err">»</code><code class="p">];</code>
    <code class="p">{</code>
        <code class="err">«</code><code class="nx">CODE</code><code class="err">»</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Example – the following function call:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">logSum</code><code class="p">(</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code> <code class="o">+</code> <code class="nx">y</code><code class="p">);</code>
<code class="p">}</code>
<code class="nx">logSum</code><code class="p">(</code><code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">);</code>
</pre></div>

</div>

<p>becomes:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code>
    <code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">]</code> <code class="o">=</code> <code class="p">[</code><code class="mi">7</code><code class="p">,</code> <code class="mi">8</code><code class="p">];</code>
    <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code> <code class="o">+</code> <code class="nx">y</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Let’s look at specific features next.</p>


<h3 id="sec_parameter-default-values">
<span class="section-number">11.3 </span>Parameter default values</h3>

<p>ECMAScript 6 lets you specify default values for parameters:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">f</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">return</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">];</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Omitting the second parameter triggers the default value:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">f</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">]</code>
<code class="o">&gt;</code> <code class="n">f</code><code class="p">()</code>
<code class="p">[</code><code class="n">undefined</code><code class="p">,</code> <code class="mi">0</code><code class="p">]</code>
</pre></div>

</div>

<p>Watch out – <code>undefined</code> triggers the default value, too:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">f</code><code class="p">(</code><code class="n">undefined</code><code class="p">,</code> <code class="n">undefined</code><code class="p">)</code>
<code class="p">[</code><code class="n">undefined</code><code class="p">,</code> <code class="mi">0</code><code class="p">]</code>
</pre></div>

</div>

<p>The default value is computed on demand, only when it is actually needed:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kr">const</code> <code class="nx">log</code> <code class="o">=</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nx">console</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="kd">function</code> <code class="nx">g</code><code class="p">(</code><code class="nx">x</code><code class="o">=</code><code class="nx">log</code><code class="p">(</code><code class="s1">'x'</code><code class="p">),</code> <code class="nx">y</code><code class="o">=</code><code class="nx">log</code><code class="p">(</code><code class="s1">'y'</code><code class="p">))</code> <code class="p">{</code><code class="k">return</code> <code class="s1">'DONE'</code><code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">g</code><code class="p">()</code>
<code class="nx">x</code>
<code class="nx">y</code>
<code class="s1">'DONE'</code>
<code class="o">&gt;</code> <code class="nx">g</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="nx">y</code>
<code class="s1">'DONE'</code>
<code class="o">&gt;</code> <code class="nx">g</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
<code class="s1">'DONE'</code>
</pre></div>

</div>

<h4 id="leanpub-auto-why-does-undefined-trigger-default-values">
<span class="section-number">11.3.1 </span>Why does <code>undefined</code> trigger default values?</h4>

<p>It isn’t immediately obvious why <code>undefined</code> should be interpreted as a missing parameter or a missing part of an object or Array. The rationale for doing so is that it enables you to delegate the definition of default values. Let’s look at two examples.</p>

<p>In the first example (source: <a href="https://github.com/rwaldron/tc39-notes/blob/master/es6/2012-07/july-24.md#413-destructuring-issues">Rick Waldron’s TC39 meeting notes from 2012-07-24</a>), we don’t have to define a default value in <code>setOptions()</code>, we can delegate that task to <code>setLevel()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">setLevel</code><code class="p">(</code><code class="nx">newLevel</code> <code class="o">=</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">light</code><code class="p">.</code><code class="nx">intensity</code> <code class="o">=</code> <code class="nx">newLevel</code><code class="p">;</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">setOptions</code><code class="p">(</code><code class="nx">options</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Missing prop returns undefined =&gt; use default</code>
    <code class="nx">setLevel</code><code class="p">(</code><code class="nx">options</code><code class="p">.</code><code class="nx">dimmerLevel</code><code class="p">);</code>
    <code class="nx">setMotorSpeed</code><code class="p">(</code><code class="nx">options</code><code class="p">.</code><code class="nx">speed</code><code class="p">);</code>
    <code class="err">···</code>
<code class="p">}</code>
<code class="nx">setOptions</code><code class="p">({</code><code class="nx">speed</code><code class="o">:</code><code class="mi">5</code><code class="p">});</code>
</pre></div>

</div>

<p>In the second example, <code>square()</code> doesn’t have to define a default for <code>x</code>, it can delegate that task to <code>multiply()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">multiply</code><code class="p">(</code><code class="nx">x</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">y</code><code class="p">;</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">square</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">multiply</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Default values further entrench the role of <code>undefined</code> as indicating that something doesn’t exist, versus <code>null</code> indicating emptiness.</p>

<h4 id="leanpub-auto-referring-to-other-variables-in-default-values">
<span class="section-number">11.3.2 </span>Referring to other variables in default values</h4>

<p>Within a parameter default value, you can refer to any variable, including other parameters:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">x</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
<code class="nx">foo</code><code class="p">();</code>     <code class="c1">// x=3; y=3</code>
<code class="nx">foo</code><code class="p">(</code><code class="mi">7</code><code class="p">);</code>    <code class="c1">// x=7; y=7</code>
<code class="nx">foo</code><code class="p">(</code><code class="mi">7</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code> <code class="c1">// x=7; y=2</code>
</pre></div>

</div>

<p>However, order matters: parameters are declared from left to right and within a default value, you get a <code>ReferenceError</code> if you access a parameter that hasn’t been declared, yet.</p>

<p>Default values exist in their own scope, which is between the “outer” scope surrounding the function and the “inner” scope of the function body. Therefore, you can’t access inner variables from the default values:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">x</code> <code class="o">=</code> <code class="s1">'outer'</code><code class="p">;</code>
<code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">a</code> <code class="o">=</code> <code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">x</code> <code class="o">=</code> <code class="s1">'inner'</code><code class="p">;</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">a</code><code class="p">);</code> <code class="c1">// outer</code>
<code class="p">}</code>
</pre></div>

</div>

<p>If there were no outer <code>x</code> in the previous example, the default value <code>x</code> would produce a <code>ReferenceError</code>.</p>

<p>This restriction is probably most surprising if default values are closures:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">callback</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">BAR</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">BAR</code> <code class="o">=</code> <code class="mi">3</code><code class="p">;</code> <code class="c1">// can’t be accessed from default value</code>
    <code class="nx">callback</code><code class="p">();</code>
<code class="p">}</code>
<code class="nx">foo</code><code class="p">();</code> <code class="c1">// ReferenceError</code>
</pre></div>

</div>


<h3 id="sec_rest-parameters">
<span class="section-number">11.4 </span>Rest parameters</h3>

<p>Putting the rest operator (<code>...</code>) in front of the last formal parameter means that it will receive all remaining actual parameters in an Array.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">f</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="p">...</code><code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
<code class="nx">f</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">);</code> <code class="c1">// x = 'a'; y = ['b', 'c']</code>
</pre></div>

</div>

<p>If there are no remaining parameters, the rest parameter will be set to the empty Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">f</code><code class="p">();</code> <code class="c1">// x = undefined; y = []</code>
</pre></div>

</div>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_spread-operator">The spread operator (<code>...</code>)</a> looks exactly like the rest operator, but it is used inside function calls and Array literals (not inside destructuring patterns).</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-no-more-arguments">
<span class="section-number">11.4.1 </span>No more <code>arguments</code>!</h4>

<p>Rest parameters can completely replace JavaScript’s infamous special variable <code>arguments</code>. They have the advantage of always being Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// ECMAScript 5: arguments</code>
<code class="kd">function</code> <code class="nx">logAllArguments</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">arguments</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">arguments</code><code class="p">[</code><code class="nx">i</code><code class="p">]);</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// ECMAScript 6: rest parameter</code>
<code class="kd">function</code> <code class="nx">logAllArguments</code><code class="p">(...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">arg</code> <code class="nx">of</code> <code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">arg</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-combining-destructuring-and-access-to-the-destructured-value">
<span class="section-number">11.4.1.1 </span>Combining destructuring and access to the destructured value</h5>

<p>One interesting feature of <code>arguments</code> is that you can have normal parameters and an Array of all parameters at the same time:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Arity: '</code><code class="o">+</code><code class="nx">arguments</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>You can avoid <code>arguments</code> in such cases if you combine a rest parameter with Array destructuring. The resulting code is longer, but more explicit:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">foo</code><code class="p">(...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">y</code><code class="o">=</code><code class="mi">0</code><code class="p">]</code> <code class="o">=</code> <code class="nx">args</code><code class="p">;</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Arity: '</code><code class="o">+</code><code class="nx">args</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The same technique works for named parameters (options objects):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">bar</code><code class="p">(</code><code class="nx">options</code> <code class="o">=</code> <code class="p">{})</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="p">{</code> <code class="nx">namedParam1</code><code class="p">,</code> <code class="nx">namedParam2</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">options</code><code class="p">;</code>
    <code class="err">···</code>
    <code class="k">if</code> <code class="p">(</code><code class="s1">'extra'</code> <code class="k">in</code> <code class="nx">options</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-arguments-is-iterable">
<span class="section-number">11.4.1.2 </span><code>arguments</code> is iterable</h5>

<p><code>arguments</code> is <em>iterable</em><sup id="fnref-parameter-handling_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-parameter-handling_1" rel="footnote">1</a></sup> in ECMAScript 6, which means that you can use <code>for-of</code> and the spread operator:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="k">return</code> <code class="k">typeof</code> <code class="nx">arguments</code><code class="cp">[</code><code class="nx">Symbol.iterator</code><code class="cp">]</code> <code class="p">}())</code>
<code class="s1">'function'</code>
<code class="o">&gt;</code> <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="k">return</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">isArray</code><code class="p">(</code><code class="cp">[</code><code class="nx">...arguments</code><code class="cp">]</code><code class="p">)</code> <code class="p">}())</code>
<code class="kc">true</code>
</pre></div>

</div>


<h3 id="sec_named-parameters">
<span class="section-number">11.5 </span>Simulating named parameters</h3>

<p>When calling a function (or method) in a programming language, you must map the actual parameters (specified by the caller) to the formal parameters (of a function definition). There are two common ways to do so:</p>

<ul>
<li>
<em>Positional parameters</em> are mapped by position. The first actual parameter is mapped to the first formal parameter, the second actual to the second formal, and so on.</li>
  <li>
<em>Named parameters</em> use <em>names</em> (labels) to perform the mapping. Names are associated with formal parameters in a function definition and label actual parameters in a function call. It does not matter in which order named parameters appear, as long as they are correctly labeled.</li>
</ul>
<p>Named parameters have two main benefits: they provide descriptions for arguments in function calls and they work well for optional parameters. I’ll first explain the benefits and then show you how to simulate named parameters in JavaScript via object literals.</p>

<h4 id="leanpub-auto-named-parameters-as-descriptions">
<span class="section-number">11.5.1 </span>Named Parameters as Descriptions</h4>

<p>As soon as a function has more than one parameter, you might get confused about what each parameter is used for. For example, let’s say you have a function, <code>selectEntries()</code>, that returns entries from a database. Given the function call:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">selectEntries</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>
</pre></div>

</div>

<p>what do these two numbers mean? Python supports named parameters, and they make it easy to figure out what is going on:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c"># Python syntax</code>
<code class="n">selectEntries</code><code class="p">(</code><code class="n">start</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code> <code class="n">end</code><code class="o">=</code><code class="mi">20</code><code class="p">,</code> <code class="n">step</code><code class="o">=</code><code class="mi">2</code><code class="p">)</code>
</pre></div>

</div>

<h4 id="leanpub-auto-optional-named-parameters">
<span class="section-number">11.5.2 </span>Optional Named Parameters</h4>

<p>Optional positional parameters work well only if they are omitted at the end. Anywhere else, you have to insert placeholders such as <code>null</code> so that the remaining parameters have correct positions.</p>

<p>With optional named parameters, that is not an issue. You can easily omit any of them. Here are some examples:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c"># Python syntax</code>
<code class="n">selectEntries</code><code class="p">(</code><code class="n">step</code><code class="o">=</code><code class="mi">2</code><code class="p">)</code>
<code class="n">selectEntries</code><code class="p">(</code><code class="n">end</code><code class="o">=</code><code class="mi">20</code><code class="p">,</code> <code class="n">start</code><code class="o">=</code><code class="mi">3</code><code class="p">)</code>
<code class="n">selectEntries</code><code class="p">()</code>
</pre></div>

</div>

<h4 id="leanpub-auto-simulating-named-parameters-in-javascript">
<span class="section-number">11.5.3 </span>Simulating Named Parameters in JavaScript</h4>

<p>JavaScript does not have native support for named parameters like Python and many other languages. But there is a reasonably elegant simulation: name parameters via an object literal, passed as a single actual parameter. When you use this technique, an invocation of <code>selectEntries()</code> looks as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">selectEntries</code><code class="p">({</code> <code class="nx">start</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="nx">end</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">step</code><code class="o">:</code> <code class="mi">2</code> <code class="p">});</code>
</pre></div>

</div>

<p>The function receives an object with the properties <code>start</code>, <code>end</code>, and <code>step</code>. You can omit any of them:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">selectEntries</code><code class="p">({</code> <code class="nx">step</code><code class="o">:</code> <code class="mi">2</code> <code class="p">});</code>
<code class="nx">selectEntries</code><code class="p">({</code> <code class="nx">end</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code> <code class="nx">start</code><code class="o">:</code> <code class="mi">3</code> <code class="p">});</code>
<code class="nx">selectEntries</code><code class="p">();</code>
</pre></div>

</div>

<p>In ECMAScript 5, you’d implement <code>selectEntries()</code> as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">selectEntries</code><code class="p">(</code><code class="nx">options</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">options</code> <code class="o">=</code> <code class="nx">options</code> <code class="o">||</code> <code class="p">{};</code>
    <code class="kd">var</code> <code class="nx">start</code> <code class="o">=</code> <code class="nx">options</code><code class="p">.</code><code class="nx">start</code> <code class="o">||</code> <code class="mi">0</code><code class="p">;</code>
    <code class="kd">var</code> <code class="nx">end</code> <code class="o">=</code> <code class="nx">options</code><code class="p">.</code><code class="nx">end</code> <code class="o">||</code> <code class="nx">getDbLength</code><code class="p">();</code>
    <code class="kd">var</code> <code class="nx">step</code> <code class="o">=</code> <code class="nx">options</code><code class="p">.</code><code class="nx">step</code> <code class="o">||</code> <code class="mi">1</code><code class="p">;</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In ECMAScript 6, you can use destructuring, which looks like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">selectEntries</code><code class="p">({</code> <code class="nx">start</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">end</code><code class="o">=-</code><code class="mi">1</code><code class="p">,</code> <code class="nx">step</code><code class="o">=</code><code class="mi">1</code> <code class="p">})</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>If you call <code>selectEntries()</code> with zero arguments, the destructuring fails, because you can’t match an object pattern against <code>undefined</code>. That can be fixed via a default value. In the following code, the object pattern is matched against <code>{}</code> if there isn’t at least one argument.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">selectEntries</code><code class="p">({</code> <code class="nx">start</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="nx">end</code><code class="o">=-</code><code class="mi">1</code><code class="p">,</code> <code class="nx">step</code><code class="o">=</code><code class="mi">1</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{})</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>You can also combine positional parameters with named parameters. It is customary for the latter to come last:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">someFunc</code><code class="p">(</code><code class="nx">posArg1</code><code class="p">,</code> <code class="p">{</code> <code class="nx">namedArg1</code><code class="o">:</code> <code class="mi">7</code><code class="p">,</code> <code class="nx">namedArg2</code><code class="o">:</code> <code class="kc">true</code> <code class="p">});</code>
</pre></div>

</div>

<p>In principle, JavaScript engines could optimize this pattern so that no intermediate object is created, because both the object literals at the call sites and the object patterns in the function definitions are static.</p>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <p>In JavaScript, the pattern for named parameters shown here is sometimes called <em>options</em> or <em>option object</em> (e.g., by the jQuery documentation).</p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-examples-of-destructuring-in-parameter-handling">
<span class="section-number">11.6 </span>Examples of destructuring in parameter handling</h3>

<h4 id="leanpub-auto-reminder-parentheses-around-single-parameters-of-arrow-functions">
<span class="section-number">11.6.1 </span>Reminder: parentheses around single parameters of arrow functions</h4>

<p>In the following sections, I’ll occasionally use arrow functions. Hence, a quick reminder: If an arrow function has a single parameter and that parameter is an identifier, you can omit the parentheses around it. For example, there are no parentheses around <code>x</code> in the following REPL interaction:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">].</code><code class="n">map</code><code class="p">(</code><code class="n">x</code> <code class="o">=&gt;</code> <code class="mi">2</code> <code class="o">*</code> <code class="n">x</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">6</code> <code class="p">]</code>
</pre></div>

</div>

<p>However, you do need parentheses whenever a single parameter is not just an identifier:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">],</code> <code class="p">[</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]].</code><code class="n">map</code><code class="p">(([</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">])</code> <code class="o">=&gt;</code> <code class="n">a</code> <code class="o">+</code> <code class="n">b</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">7</code> <code class="p">]</code>

<code class="o">&gt;</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="n">undefined</code><code class="p">,</code> <code class="mi">3</code><code class="p">].</code><code class="n">map</code><code class="p">((</code><code class="n">x</code><code class="o">=</code><code class="err">'</code><code class="n">yes</code><code class="err">'</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="n">x</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="err">'</code><code class="n">yes</code><code class="err">'</code><code class="p">,</code> <code class="mi">3</code> <code class="p">]</code>
</pre></div>

</div>

<p>More details are given in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_single-param-arrow-funcs">the chapter on arrow functions</a>.</p>

<h4 id="leanpub-auto-foreach-and-destructuring">
<span class="section-number">11.6.2 </span>forEach() and destructuring</h4>

<p>You will probably mostly use the <code>for-of</code> loop in ECMAScript 6, but the Array method <code>forEach()</code> also profits from destructuring. Or rather, its callback does.</p>

<p>First example: destructuring the Arrays in an Array.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">items</code> <code class="o">=</code> <code class="p">[</code> <code class="p">[</code><code class="s1">'foo'</code><code class="p">,</code> <code class="mi">3</code><code class="p">],</code> <code class="p">[</code><code class="s1">'bar'</code><code class="p">,</code> <code class="mi">9</code><code class="p">]</code> <code class="p">];</code>
<code class="nx">items</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(([</code><code class="nx">word</code><code class="p">,</code> <code class="nx">count</code><code class="p">])</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">word</code><code class="o">+</code><code class="s1">' '</code><code class="o">+</code><code class="nx">count</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<p>Second example: destructuring the objects in an Array.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">items</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code> <code class="nx">word</code><code class="o">:</code><code class="s1">'foo'</code><code class="p">,</code> <code class="nx">count</code><code class="o">:</code><code class="mi">3</code> <code class="p">},</code>
    <code class="p">{</code> <code class="nx">word</code><code class="o">:</code><code class="s1">'bar'</code><code class="p">,</code> <code class="nx">count</code><code class="o">:</code><code class="mi">9</code> <code class="p">},</code>
<code class="p">];</code>
<code class="nx">items</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(({</code><code class="nx">word</code><code class="p">,</code> <code class="nx">count</code><code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">word</code><code class="o">+</code><code class="s1">' '</code><code class="o">+</code><code class="nx">count</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-transforming-maps">
<span class="section-number">11.6.3 </span>Transforming Maps</h4>

<p>An ECMAScript 6 Map doesn’t have a method <code>map()</code> (like Arrays). Therefore, one has to:</p>

<ol class="numeric numeric">
<li>Convert it to an Array of <code>[key,value]</code> pairs.</li>
  <li>
<code>map()</code> the Array.</li>
  <li>Convert the result back to a Map.</li>
</ol>
<p>This looks as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map0</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">([</code>
    <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="s1">'a'</code><code class="p">],</code>
    <code class="p">[</code><code class="mi">2</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">],</code>
    <code class="p">[</code><code class="mi">3</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">],</code>
<code class="p">]);</code>

<code class="kd">let</code> <code class="nx">map1</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">(</code> <code class="c1">// step 3</code>
    <code class="p">[...</code><code class="nx">map0</code><code class="p">]</code> <code class="c1">// step 1</code>
    <code class="p">.</code><code class="nx">map</code><code class="p">(([</code><code class="nx">k</code><code class="p">,</code> <code class="nx">v</code><code class="p">])</code> <code class="o">=&gt;</code> <code class="p">[</code><code class="nx">k</code><code class="o">*</code><code class="mi">2</code><code class="p">,</code> <code class="s1">'_'</code><code class="o">+</code><code class="nx">v</code><code class="p">])</code> <code class="c1">// step 2</code>
<code class="p">);</code>
<code class="c1">// Resulting Map: {2 -&gt; '_a', 4 -&gt; '_b', 6 -&gt; '_c'}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-handling-an-array-returned-via-a-promise">
<span class="section-number">11.6.4 </span>Handling an Array returned via a Promise</h4>

<p>The tool method <code>Promise.all()</code> works as follows:</p>

<ul>
<li>Input: an Array of Promises.</li>
  <li>Output: a Promise that resolves to an Array as soon as the last input Promise is resolved. The Array contains the resolutions of the input Promises.</li>
</ul>
<p>Destructuring helps with handling the Array that the result of <code>Promise.all()</code> resolves to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">urls</code> <code class="o">=</code> <code class="p">[</code>
    <code class="s1">'http://example.com/foo.html'</code><code class="p">,</code>
    <code class="s1">'http://example.com/bar.html'</code><code class="p">,</code>
    <code class="s1">'http://example.com/baz.html'</code><code class="p">,</code>
<code class="p">];</code>

<code class="nx">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="nx">urls</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">downloadUrl</code><code class="p">))</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(([</code><code class="nx">fooStr</code><code class="p">,</code> <code class="nx">barStr</code><code class="p">,</code> <code class="nx">bazStr</code><code class="p">])</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">});</code>

<code class="c1">// This function returns a Promise that resolves to</code>
<code class="c1">// a string (the text)</code>
<code class="kd">function</code> <code class="nx">downloadUrl</code><code class="p">(</code><code class="nx">url</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">fetch</code><code class="p">(</code><code class="nx">url</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="nx">request</code> <code class="o">=&gt;</code> <code class="nx">request</code><code class="p">.</code><code class="nx">text</code><code class="p">());</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>fetch()</code> is a Promise-based version of <code>XMLHttpRequest</code>. It is <a href="https://fetch.spec.whatwg.org/#fetch-api">part of the Fetch standard</a>.</p>


<h3 id="sec_parameter-handling-style-tips">
<span class="section-number">11.7 </span>Coding style tips</h3>

<p>This section mentions a few tricks for descriptive parameter definitions. They are clever, but they also have downsides: they add visual clutter and can make your code harder to understand.</p>

<h4 id="leanpub-auto-optional-parameters">
<span class="section-number">11.7.1 </span>Optional parameters</h4>

<p>I occasionally use the parameter default value <code>undefined</code> to mark a parameter as optional (unless it already has a default value):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">requiredParam</code><code class="p">,</code> <code class="nx">optionalParam</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-required-parameters">
<span class="section-number">11.7.2 </span>Required parameters</h4>

<p>In ECMAScript 5, you have a few options for ensuring that a required parameter has been provided, which are all quite clumsy:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">mustBeProvided</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">arguments</code><code class="p">.</code><code class="nx">length</code> <code class="o">&lt;</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code> <code class="p">(</code><code class="mi">0</code> <code class="k">in</code> <code class="nx">arguments</code><code class="p">))</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">mustBeProvided</code> <code class="o">===</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
    <code class="p">}</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In ECMAScript 6, you can (ab)use default parameter values to achieve more concise code (credit: idea by Allen Wirfs-Brock):</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Called if a parameter is missing and</code>
<code class="cm"> * the default value is evaluated.</code>
<code class="cm"> */</code>
<code class="kd">function</code> <code class="nx">mandatory</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Missing parameter'</code><code class="p">);</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">mustBeProvided</code> <code class="o">=</code> <code class="nx">mandatory</code><code class="p">())</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">mustBeProvided</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Interaction:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">foo</code><code class="p">()</code>
<code class="nl">Error:</code> <code class="n">Missing</code> <code class="n">parameter</code>
<code class="o">&gt;</code> <code class="n">foo</code><code class="p">(</code><code class="mi">123</code><code class="p">)</code>
<code class="mi">123</code>
</pre></div>

</div>

<h4 id="leanpub-auto-enforcing-a-maximum-arity">
<span class="section-number">11.7.3 </span>Enforcing a maximum arity</h4>

<p>This section presents three approaches to enforcing a maximum arity. The running example is a function <code>f</code> whose maximum arity is 2 – if a caller provides more than 2 parameters, an error should be thrown.</p>

<p>The first approach collects all actual parameters in the formal rest parameter <code>args</code> and checks its length.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">f</code><code class="p">(...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">args</code><code class="p">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
    <code class="p">}</code>
    <code class="c1">// Extract the real parameters</code>
    <code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">]</code> <code class="o">=</code> <code class="nx">args</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The second approach relies on unwanted actual parameters appearing in the formal rest parameter <code>empty</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">f</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="p">...</code><code class="nx">empty</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">empty</code><code class="p">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The third approach uses a sentinel value that is gone if there is a third parameter. One caveat is that the default value <code>OK</code> is also triggered if there is a third parameter whose value is <code>undefined</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">OK</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kd">function</code> <code class="nx">f</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="nx">arity</code><code class="o">=</code><code class="nx">OK</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">arity</code> <code class="o">!==</code> <code class="nx">OK</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Sadly, each one of these approaches introduces significant visual and conceptual clutter. I’m tempted to recommend checking <code>arguments.length</code>, but I also want <code>arguments</code> to go away.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">f</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">arguments</code><code class="p">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>


<h3 id="sec_spread-operator">
<span class="section-number">11.8 </span>The spread operator (<code>...</code>)</h3>

<p>The spread operator (<code>...</code>) looks exactly like the rest operator, but is its opposite:</p>

<ul>
<li>The rest operator extracts Arrays and is used for <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_rest-parameters">rest parameters</a> and <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_rest-operator">destructuring</a>.</li>
  <li>The spread operator turns the elements of an Array into arguments of a function call or into elements of an Array literal.</li>
</ul>
<h4 id="leanpub-auto-spreading-into-function-and-method-calls">
<span class="section-number">11.8.1 </span>Spreading into function and method calls</h4>

<p><code>Math.max()</code> is a good example for demonstrating how the spread operator works in method calls. <code>Math.max(x1, x2, ···)</code> returns the argument whose value is greatest. It accepts an arbitrary number of arguments, but can’t be applied to Arrays. The spread operator fixes that:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">max</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">3</code><code class="p">)</code>
<code class="mi">11</code>
<code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">max</code><code class="p">(...[</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">3</code><code class="p">])</code>
<code class="mi">11</code>
</pre></div>

</div>

<p>In contrast to the rest operator, you can use the spread operator anywhere in a sequence of parts:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">max</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="p">...[</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">11</code><code class="p">],</code> <code class="mi">3</code><code class="p">)</code>
<code class="mi">11</code>
</pre></div>

</div>

<p>Another example is JavaScript not having a way to destructively append the elements of one Array to another one. However, Arrays do have the method <code>push(x1, x2, ···)</code>, which appends all of its arguments to its receiver. The following code shows how you can use <code>push()</code> to append the elements of <code>arr2</code> to <code>arr1</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr1</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">];</code>
<code class="kd">let</code> <code class="nx">arr2</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'c'</code><code class="p">,</code> <code class="s1">'d'</code><code class="p">];</code>

<code class="nx">arr1</code><code class="p">.</code><code class="nx">push</code><code class="p">(...</code><code class="nx">arr2</code><code class="p">);</code>
<code class="c1">// arr1 is now ['a', 'b', 'c', 'd']</code>
</pre></div>

</div>

<h4 id="leanpub-auto-spreading-into-constructors">
<span class="section-number">11.8.2 </span>Spreading into constructors</h4>

<p>In addition to function and method calls, the spread operator also works for constructor calls:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">new</code> <code class="nb">Date</code><code class="p">(...[</code><code class="mi">1912</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">24</code><code class="p">])</code> <code class="c1">// Christmas Eve 1912</code>
</pre></div>

</div>

<p>That is something that is <a href="http://speakingjs.com/es5/ch17.html#apply_constructors">difficult to achieve in ECMAScript 5</a>.</p>

<h4 id="leanpub-auto-spreading-into-arrays">
<span class="section-number">11.8.3 </span>Spreading into Arrays</h4>

<p>The spread operator can also be used inside Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="p">...[</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">],</code> <code class="mi">4</code><code class="p">]</code>
<code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">]</code>
</pre></div>

</div>

<p>That gives you a convenient way to concatenate Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">x</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">];</code>
<code class="kd">let</code> <code class="nx">y</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'c'</code><code class="p">];</code>
<code class="kd">let</code> <code class="nx">z</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'d'</code><code class="p">,</code> <code class="s1">'e'</code><code class="p">];</code>

<code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">x</code><code class="p">,</code> <code class="p">...</code><code class="nx">y</code><code class="p">,</code> <code class="p">...</code><code class="nx">z</code><code class="p">];</code> <code class="c1">// ['a', 'b', 'c', 'd', 'e']</code>
</pre></div>

</div>

<h5 id="leanpub-auto-converting-iterable-or-array-like-objects-to-arrays">
<span class="section-number">11.8.3.1 </span>Converting iterable or Array-like objects to Arrays</h5>

<p>The spread operator lets you convert any iterable object to an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">someIterableObject</code><code class="p">];</code>
</pre></div>

</div>

<p>Let’s convert a Set to an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="mi">11</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">6</code><code class="p">]);</code>
<code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">set</code><code class="p">];</code> <code class="c1">// [11, -1, 6]</code>
</pre></div>

</div>

<p>Your own iterable objects can be converted to Arrays in the same manner:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="o">*</code> <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
        <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>
        <code class="k">yield</code> <code class="s1">'c'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
<code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">obj</code><code class="p">];</code> <code class="c1">// ['a', 'b', 'c']</code>
</pre></div>

</div>

<p>Note that, just like the <code>for-of</code> loop, the spread operator only works for iterable objects. Most important objects are iterable: Arrays, Maps, Sets and <code>arguments</code>. Most DOM data structures will also eventually be iterable.</p>

<p>Should you ever encounter something that is not iterable, but Array-like (indexed elements plus a property <code>length</code>), you can use <code>Array.from()</code><sup id="fnref-parameter-handling_2"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-parameter-handling_2" rel="footnote">2</a></sup> to convert it to an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arrayLike</code> <code class="o">=</code> <code class="p">{</code>
    <code class="s1">'0'</code><code class="o">:</code> <code class="s1">'a'</code><code class="p">,</code>
    <code class="s1">'1'</code><code class="o">:</code> <code class="s1">'b'</code><code class="p">,</code>
    <code class="s1">'2'</code><code class="o">:</code> <code class="s1">'c'</code><code class="p">,</code>
    <code class="nx">length</code><code class="o">:</code> <code class="mi">3</code>
<code class="p">};</code>

<code class="c1">// ECMAScript 5:</code>
<code class="kd">var</code> <code class="nx">arr1</code> <code class="o">=</code> <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arrayLike</code><code class="p">);</code> <code class="c1">// ['a', 'b', 'c']</code>

<code class="c1">// ECMAScript 6:</code>
<code class="kd">let</code> <code class="nx">arr2</code> <code class="o">=</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">arrayLike</code><code class="p">);</code> <code class="c1">// ['a', 'b', 'c']</code>

<code class="c1">// TypeError: Cannot spread non-iterable object.</code>
<code class="kd">let</code> <code class="nx">arr3</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">arrayLike</code><code class="p">];</code>
</pre></div>

</div>

<div class="footnotes">
  <ol>
<li id="fn-parameter-handling_1">Iterables are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_iteration">another chapter</a>.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-parameter-handling_1" rel="rev-footnote">↩</a>
</li>
    <li id="fn-parameter-handling_2">Explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_arrays">the chapter on Arrays</a>.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-parameter-handling_2" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h1 id="leanpub-auto-modularity">
<span class="section-number">III </span>Modularity</h1>

<h2 id="ch_callables">
<span class="section-number">12. </span>Callable entities in ECMAScript 6</h2>

<p>This chapter gives advice on how to properly use entities you can call (via function calls, method calls, etc.) in ES6. It contains three sections:</p>

<ul>
<li>
<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_callable-entities">An overview of callable entities</a>.</li>
  <li>
<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_callables-style">Recommendations for what callable entity to use when</a>.</li>
  <li>
<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_dispatched-and-direct-method-calls">An examination of two ways of calling methods</a> and how they change with ES6:
    <ul>
<li>
<em>Dispatched method calls</em>, e.g. <code>obj.m(x, y)</code>
</li>
      <li>
<em>Direct method calls</em>, e.g. <code>obj.m.call(obj, x, y)</code>
</li>
    </ul>
</li>
</ul>
<h3 id="sec_callable-entities">
<span class="section-number">12.1 </span>Callable entities in ES6</h3>

<p>In ES6, there are the following callable entities:</p>

<ul>
<li>Traditional functions (created via function expressions and function declarations)</li>
  <li>Generator functions (created via generator function expressions and generator function declarations)</li>
  <li>Arrow functions (only have an expression form)</li>
  <li>Methods (created by method definitions in object literals and class definitions)</li>
  <li>Generator methods (created by generator method definitions in object literals and class definitions)</li>
  <li>Classes (created via class expressions and class declarations)</li>
</ul>
<p>Note that I distinguish:</p>

<ul>
<li>The entity: e.g. traditional function</li>
  <li>The syntax that creates the entity: e.g. function expression and function declaration</li>
</ul>
<p>Even though their behaviors differ considerably (as explained later), all of these entities are functions. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="k">typeof</code> <code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{})</code> <code class="c1">// arrow function</code>
<code class="s1">'function'</code>
<code class="o">&gt;</code> <code class="k">typeof</code> <code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{}</code> <code class="c1">// generator function</code>
<code class="s1">'function'</code>
<code class="o">&gt;</code> <code class="k">typeof</code> <code class="kr">class</code> <code class="p">{}</code> <code class="c1">// class</code>
<code class="s1">'function'</code>
</pre></div>

</div>

<p>Next, we look at each callable entity in more detail.</p>

<h4 id="leanpub-auto-ways-of-calling-in-es6">
<span class="section-number">12.1.1 </span>Ways of calling in ES6</h4>

<p>Some calls can be made anywhere, others are restricted to specific locations.</p>

<h5 id="leanpub-auto-calls-that-can-be-made-anywhere">
<span class="section-number">12.1.1.1 </span>Calls that can be made anywhere</h5>

<p>Three kinds of calls can be made anywhere in ES6:</p>

<ul>
<li>Function calls: <code>func(3, 1)</code>
</li>
  <li>Method calls: <code>obj.method('abc')</code>
</li>
  <li>Constructor calls: <code>new Constr(8)</code>
</li>
</ul>
<p>For function calls, it is important to remember that most ES6 code will be contained in modules and that module bodies are implicitly in strict mode.</p>

<h5 id="leanpub-auto-calls-via-super-are-restricted-to-specific-locations">
<span class="section-number">12.1.1.2 </span>Calls via <code>super</code> are restricted to specific locations</h5>

<p>Two kinds of calls can be made via the <code>super</code> keyword; their use is restricted to specific locations:</p>

<ul>
<li>Super-method calls: <code>super.method('abc')</code><br>
Only available within method definitions inside either object literals or derived class definitions.</li>
  <li>Super-constructor calls: <code>super(8)</code><br>
Only available inside the special method <code>constructor()</code> inside a derived class definition.</li>
</ul>
<h5 id="leanpub-auto-non-method-functions-versus-methods">
<span class="section-number">12.1.1.3 </span>Non-method functions versus methods</h5>

<p>The difference between non-method functions and methods is becoming more pronounced in ECMAScript 6. There are now special entities for both and things that only they can do:</p>

<ul>
<li>Arrow functions are made for non-method functions. They pick up <code>this</code> (and other variables) from their surrounding scopes (“lexical <code>this</code>”).</li>
  <li>Method definitions are made for methods. They provide support for <code>super</code>, to refer to super-properties and to make super-method calls.</li>
</ul>
<h4 id="leanpub-auto-traditional-functions">
<span class="section-number">12.1.2 </span>Traditional functions</h4>

<p>These are the functions that you know from ES5. There are two ways to create them:</p>

<ul>
<li>Function expression:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">const</code> <code class="nx">foo</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">};</code>
</pre></div>
    
</div>
  </li>
  <li>Function declaration:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
</pre></div>
    
</div>
  </li>
</ul>
<p>Rules for <code>this</code>:</p>

<ul>
<li>Function calls: <code>this</code> is <code>undefined</code> in strict mode and the global object in sloppy mode.</li>
  <li>Method calls: <code>this</code> is the receiver of the method call (or the first argument of <code>call</code>/<code>apply</code>).</li>
  <li>Constructor calls: <code>this</code> is the newly created instance.</li>
</ul>
<h4 id="leanpub-auto-generator-functions">
<span class="section-number">12.1.3 </span>Generator functions</h4>

<p>Generator functions are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators">the chapter on generators</a>. Their syntax is similar to traditional functions, but they have an extra asterisk:</p>

<ul>
<li>Generator function expression:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">const</code> <code class="nx">foo</code> <code class="o">=</code> <code class="kd">function</code><code class="o">*</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">};</code>
</pre></div>
    
</div>
  </li>
  <li>Function declaration:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">function</code><code class="o">*</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
</pre></div>
    
</div>
  </li>
</ul>
<p>The rules for <code>this</code> are as follows. Note that it never refers to the generator object.</p>

<ul>
<li>Function/method calls: <code>this</code> is handled like it is with traditional functions. The results of such calls are generator objects.</li>
  <li>Constructor calls: Accessing <code>this</code> inside a generator function causes a <code>ReferenceError</code>. The result of a constructor call is a generator object.</li>
</ul>
<h4 id="leanpub-auto-method-definitions">
<span class="section-number">12.1.4 </span>Method definitions</h4>

<p>Method definitions appear <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#object-literal-method-definitions">inside object literals</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">add</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">x</code> <code class="o">+</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">},</code> <code class="c1">// comma is required</code>
    <code class="nx">sub</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">x</code> <code class="o">-</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">},</code> <code class="c1">// comma is optional</code>
<code class="p">};</code>
</pre></div>

</div>

<p>And <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_classes">inside class definitions</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">AddSub</code> <code class="p">{</code>
    <code class="nx">add</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">x</code> <code class="o">+</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code> <code class="c1">// no comma</code>
    <code class="nx">sub</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">x</code> <code class="o">-</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code> <code class="c1">// no comma</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Method definitions are the only place where you can use <code>super</code> to refer to super-properties. Only method definitions that use <code>super</code> produce functions that have the property <code>[[HomeObject]]</code>, which is required for that feature (details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#super-properties">the chapter on classes</a>).</p>

<p>Rules:</p>

<ul>
<li>Function calls: If you extract a method and call it as a function, it behaves like a traditional function.</li>
  <li>Method calls: work as with traditional functions, but additionally allow you to use <code>super</code>.</li>
  <li>Constructor calls: produce a <code>TypeError</code>.</li>
</ul>
<p>Inside class definitions, methods whose name is <code>constructor</code> are special, as explained later.</p>

<h4 id="leanpub-auto-generator-method-definitions">
<span class="section-number">12.1.5 </span>Generator method definitions</h4>

<p>Generator methods are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators">the chapter on generators</a>. Their syntax is similar to method definitions, but they have an extra asterisk:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="o">*</code> <code class="nx">generatorMethod</code><code class="p">(</code><code class="err">···</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">},</code>
<code class="p">};</code>
<code class="kr">class</code> <code class="nx">MyClass</code> <code class="p">{</code>
    <code class="o">*</code> <code class="nx">generatorMethod</code><code class="p">(</code><code class="err">···</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Rules:</p>

<ul>
<li>Calling a generator method returns a generator object.</li>
  <li>You can use <code>this</code> and <code>super</code> as you would in normal method definitions.</li>
</ul>
<h4 id="leanpub-auto-arrow-functions">
<span class="section-number">12.1.6 </span>Arrow functions</h4>

<p>Arrow functions are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_arrow-functions">their own chapter</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">squares</code> <code class="o">=</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">].</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code><code class="p">);</code>
</pre></div>

</div>

<p>The following variables are <em>lexical</em> inside an arrow function (picked up from the surrounding scope):</p>

<ul>
<li><code>arguments</code></li>
  <li><code>super</code></li>
  <li><code>this</code></li>
  <li><code>new.target</code></li>
</ul>
<p>Rules:</p>

<ul>
<li>Function calls: lexical <code>this</code> etc.</li>
  <li>Method calls: You can use arrow functions as methods, but their <code>this</code> continues to be lexical and does not refer to the receiver of a method call.</li>
  <li>Constructor calls: produce a <code>TypeError</code>.</li>
</ul>
<h4 id="leanpub-auto-classes">
<span class="section-number">12.1.7 </span>Classes</h4>

<p>Classes are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_classes">their own chapter</a>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Base class: no `extends`</code>
<code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="err">`</code><code class="p">(</code><code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">x</code><code class="p">},</code> <code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">y</code><code class="p">})</code><code class="err">`</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// This class is derived from `Point`</code>
<code class="kr">class</code> <code class="nx">ColorPoint</code> <code class="kr">extends</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">);</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="kr">super</code><code class="p">.</code><code class="nx">toString</code><code class="p">()</code> <code class="o">+</code> <code class="s1">' in '</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="nx">color</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The Method <code>constructor</code> is special, because it “becomes” the class. That is, classes are very similar to constructor functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Point</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">constructor</code> <code class="o">===</code> <code class="n">Point</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>Rules:</p>

<ul>
<li>Function/method calls: Classes can’t be called as functions or methods (why is explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#cannot-function-call-classes">the chapter on classes</a>).</li>
  <li>Constructor calls: follow a protocol that supports subclassing. In a base class, an instance is created and <code>this</code> refers to it. A derived class receives its instance from its super-class, which is why it needs to call <code>super</code> before it can access <code>this</code>.</li>
</ul>
<h3 id="sec_callables-style">
<span class="section-number">12.2 </span>Thoughts on style</h3>

<p>Here are a few recommendations for which callable entity to use when.</p>


<h4 id="leanpub-auto-prefer-arrow-functions-as-callbacks">
<span class="section-number">12.2.1 </span>Prefer arrow functions as callbacks</h4>

<p>Whenever you can, you should use arrow functions as callbacks and not traditional factions. Arrow functions are more convenient, because you get lexical <code>this</code> and more compact syntax.</p>

<h5 id="leanpub-auto-problem-this-as-an-implicit-parameter">
<span class="section-number">12.2.1.1 </span>Problem: <code>this</code> as an implicit parameter</h5>

<p>Alas, some JavaScript APIs use <code>this</code> as an implicit argument for their callbacks, which prevents you from using arrow functions. For example: The <code>this</code> in line B is an implicit argument of the function in line A.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">beforeEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="c1">// (A)</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">addMatchers</code><code class="p">({</code> <code class="c1">// (B)</code>
        <code class="nx">toBeInRange</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">start</code><code class="p">,</code> <code class="nx">end</code><code class="p">)</code> <code class="p">{</code>  
            <code class="err">···</code>
        <code class="p">}</code>  
    <code class="p">});</code>  
<code class="p">});</code>  
</pre></div>

</div>

<p>This pattern is less explicit and prevents you from using arrow functions.</p>

<h5 id="leanpub-auto-solution-1-change-the-api">
<span class="section-number">12.2.1.2 </span>Solution 1: change the API</h5>

<p>This is easy to fix, but requires the API to change:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">beforeEach</code><code class="p">(</code><code class="nx">api</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">api</code><code class="p">.</code><code class="nx">addMatchers</code><code class="p">({</code>
        <code class="nx">toBeInRange</code><code class="p">(</code><code class="nx">start</code><code class="p">,</code> <code class="nx">end</code><code class="p">)</code> <code class="p">{</code>
            <code class="err">···</code>
        <code class="p">}</code>
    <code class="p">});</code>
<code class="p">});</code>
</pre></div>

</div>

<p>We have turned the API from an implicit parameter <code>this</code> into an explicit parameter <code>api</code>. I like this kind of explicitness.</p>

<h5 id="leanpub-auto-solution-2-access-the-value-of-this-in-some-other-way">
<span class="section-number">12.2.1.3 </span>Solution 2: access the value of <code>this</code> in some other way</h5>

<p>In some APIs, there are alternate ways to get to the value of <code>this</code>. For example, the following code uses <code>this</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">$button</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="s1">'#myButton'</code><code class="p">);</code>
<code class="nx">$button</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">classList</code><code class="p">.</code><code class="nx">toggle</code><code class="p">(</code><code class="s1">'clicked'</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<p>But the target of the event can also be accessed via <code>event.target</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">$button</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="s1">'#myButton'</code><code class="p">);</code>
<code class="nx">$button</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">classList</code><code class="p">.</code><code class="nx">toggle</code><code class="p">(</code><code class="s1">'clicked'</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>


<h4 id="leanpub-auto-be-careful-with-function-declarations">
<span class="section-number">12.2.2 </span>Be careful with function declarations</h4>

<p>Function declarations are safe as non-method functions as long as you don’t access <code>this</code> from them. (Should this be enforced by linters?)</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">arg1</code><code class="p">,</code> <code class="nx">arg2</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>You also have the option of using <code>const</code> with an arrow function, which gives you lexical <code>this</code>, but – arguably – doesn’t look as nice:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">foo</code> <code class="o">=</code> <code class="p">(</code><code class="nx">arg1</code><code class="p">,</code> <code class="nx">arg2</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">};</code>
</pre></div>

</div>


<h4 id="leanpub-auto-prefer-method-definitions-for-methods">
<span class="section-number">12.2.3 </span>Prefer method definitions for methods</h4>

<p>Method definitions are the only way to create methods that use <code>super</code>. They are the obvious choice in object literals and classes (where they are the only way to define methods), but what about adding a method to an existing object? For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">MyClass</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">arg1</code><code class="p">,</code> <code class="nx">arg2</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">};</code>
</pre></div>

</div>

<p>The following is a quick (and somewhat dirty) way to do the same thing in ES6.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">(</code><code class="nx">MyClass</code><code class="p">.</code><code class="nx">prototype</code><code class="p">,</code> <code class="p">{</code>
    <code class="nx">foo</code><code class="p">(</code><code class="nx">arg1</code><code class="p">,</code> <code class="nx">arg2</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>For more information and caveats, consult <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#Object_assign">the section on <code>Object.assign()</code></a>.</p>


<h4 id="leanpub-auto-distinguish-methods-versus-properties-with-callbacks">
<span class="section-number">12.2.4 </span>Distinguish: methods versus properties with callbacks</h4>

<p>There is a subtle difference between an object with methods and an object as a collection of callbacks.</p>

<p>For example, you can use <a href="https://streams.spec.whatwg.org/">the WHATWG streams API</a> as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">stream</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ReadableStream</code><code class="p">({</code>
    <code class="nx">start</code><code class="p">(</code><code class="nx">controller</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">},</code>

    <code class="nx">pull</code><code class="p">()</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">},</code>

    <code class="nx">cancel</code><code class="p">()</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>That is, the parameter of <code>ReadableStream()</code> is an object with methods. That enables <code>start</code>, <code>pull</code> and <code>cancel</code> to use <code>this</code> to call each other and to access object-local state.</p>

<p>On the other hand, you may simply view the three properties as referring to callbacks that interact with the surrounding scope (e.g. a method). Then <code>this</code> should be lexical and your code looks as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">stream</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ReadableStream</code><code class="p">({</code>
    <code class="nx">start</code><code class="o">:</code> <code class="nx">controller</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">},</code>

    <code class="nx">pull</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">},</code>

    <code class="nx">cancel</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>


<h4 id="sec_iifes-in-es6">
<span class="section-number">12.2.5 </span>Avoid IIFEs in ES6</h4>

<p>This section gives tips for avoiding IIFEs in ES6.</p>

<h5 id="leanpub-auto-replace-an-iife-with-a-block">
<span class="section-number">12.2.5.1 </span>Replace an IIFE with a block</h5>

<p>In ES5, you had to use an IIFE if you wanted to keep a variable local:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>  <code class="c1">// open IIFE</code>
    <code class="kd">var</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="err">···</code><code class="p">;</code>
    <code class="err">···</code>
<code class="p">}());</code>  <code class="c1">// close IIFE</code>
</pre></div>

</div>

<p>In ECMAScript 6, you can simply use a block and a <code>let</code> declaration:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">{</code>  <code class="c1">// open block</code>
    <code class="kd">let</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="err">···</code><code class="p">;</code>
    <code class="err">···</code>
<code class="p">}</code>  <code class="c1">// close block</code>
</pre></div>

</div>

<h5 id="leanpub-auto-replace-an-iife-with-a-module">
<span class="section-number">12.2.5.2 </span>Replace an IIFE with a module</h5>

<p>In ECMAScript 5 code that doesn’t use modules via libraries (such as RequireJS, browserify or webpack), the <em>revealing module pattern</em> is popular, and based on an IIFE. Its advantage is that it clearly separates between what is public and what is private:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">my_module</code> <code class="o">=</code> <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="c1">// Module-private variable:</code>
    <code class="kd">var</code> <code class="nx">countInvocations</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

    <code class="kd">function</code> <code class="nx">myFunc</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">countInvocations</code><code class="o">++</code><code class="p">;</code>
        <code class="err">···</code>
    <code class="p">}</code>

    <code class="c1">// Exported by module:</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="nx">myFunc</code><code class="o">:</code> <code class="nx">myFunc</code>
    <code class="p">};</code>
<code class="p">}());</code>
</pre></div>

</div>

<p>This module pattern produces a global variable and is used as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">my_module</code><code class="p">.</code><code class="nx">myFunc</code><code class="p">(</code><code class="mi">33</code><code class="p">);</code>
</pre></div>

</div>

<p>In ECMAScript 6, <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_modules">modules</a> are built in, which is why the barrier to adopting them is low:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// my_module.js</code>

<code class="c1">// Module-private variable:</code>
<code class="kd">let</code> <code class="nx">countInvocations</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

<code class="kr">export</code> <code class="kd">function</code> <code class="nx">myFunc</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">countInvocations</code><code class="o">++</code><code class="p">;</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This module does not produce a global variable and is used as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="p">{</code> <code class="nx">myFunc</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'my_module.js'</code><code class="p">;</code>

<code class="nx">myFunc</code><code class="p">(</code><code class="mi">33</code><code class="p">);</code>
</pre></div>

</div>

<h5 id="leanpub-auto-immediately-invoked-arrow-functions">
<span class="section-number">12.2.5.3 </span>Immediately-invoked arrow functions</h5>

<p>There is one use case where you still need an immediately-invoked function in ES6: Sometimes you only can produce a result via a sequence of statements, not via a single expression. If you want to inline those statements, you have to immediately invoke a function. In ES6, you can use immediately-invoked arrow functions if you want to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">SENTENCE</code> <code class="o">=</code> <code class="s1">'How are you?'</code><code class="p">;</code>
<code class="kr">const</code> <code class="nx">REVERSED_SENTENCE</code> <code class="o">=</code> <code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// Iteration over the string gives us code points</code>
    <code class="c1">// (better for reversal than characters)</code>
    <code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">SENTENCE</code><code class="p">];</code>
    <code class="nx">arr</code><code class="p">.</code><code class="nx">reverse</code><code class="p">();</code>
    <code class="k">return</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s1">''</code><code class="p">);</code>
<code class="p">})();</code>
</pre></div>

</div>

<p>Note that you must parenthesize as shown (the parens are around the arrow function, not around the complete function call). Details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#iiaf">the chapter on arrow functions</a>.</p>


<h4 id="leanpub-auto-use-classes">
<span class="section-number">12.2.6 </span>Use classes</h4>

<p>ES6 classes are not perfect and have their detractors. But I still recommend to use them, because there are also several objective arguments in their favor, as I explain <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_class-benefits">in the chapter on classes</a>.</p>


<h3 id="sec_dispatched-and-direct-method-calls">
<span class="section-number">12.3 </span>Dispatched and direct method calls in ECMAScript 5 and 6</h3>

<p>There are two ways to call methods in JavaScript:</p>

<ul>
<li>Via dispatch, e.g. <code>obj.someMethod(arg0, arg1)</code>
</li>
  <li>Directly, e.g. <code>someFunc.call(thisValue, arg0, arg1)</code>
</li>
</ul>
<p>This section explains how these two work and why you will rarely call methods directly in ECMAScript 6. Before we get started, I’ll refresh your knowledge w.r.t. to prototype chains.</p>


<h4 id="leanpub-auto-background-prototype-chains">
<span class="section-number">12.3.1 </span>Background: prototype chains</h4>

<p>Remember that each object in JavaScript is actually a chain of one or more objects. The first object inherits properties from the later objects. For example, the prototype chain of an Array <code>['a', 'b']</code> looks as follows:</p>

<ol class="numeric numeric">
<li>The instance, holding the elements <code>'a'</code> and <code>'b'</code>
</li>
  <li>
<code>Array.prototype</code>, the properties provided by the <code>Array</code> constructor</li>
  <li>
<code>Object.prototype</code>, the properties provided by the <code>Object</code> constructor</li>
  <li>
<code>null</code> (the end of the chain, so not really a member of it)</li>
</ol>
<p>You can examine the chain via <code>Object.getPrototypeOf()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">arr</code> <code class="o">=</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">];</code>
<code class="o">&gt;</code> <code class="n">var</code> <code class="n">p</code> <code class="o">=</code> <code class="n">Object</code><code class="p">.</code><code class="n">getPrototypeOf</code><code class="p">;</code>

<code class="o">&gt;</code> <code class="n">p</code><code class="p">(</code><code class="n">arr</code><code class="p">)</code> <code class="o">===</code> <code class="n">Array</code><code class="p">.</code><code class="n">prototype</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">p</code><code class="p">(</code><code class="n">p</code><code class="p">(</code><code class="n">arr</code><code class="p">))</code> <code class="o">===</code> <code class="n">Object</code><code class="p">.</code><code class="n">prototype</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">p</code><code class="p">(</code><code class="n">p</code><code class="p">(</code><code class="n">p</code><code class="p">(</code><code class="n">arr</code><code class="p">)))</code>
<code class="n">null</code>
</pre></div>

</div>

<p>Properties in “earlier” objects override properties in “later” objects. For example, <code>Array.prototype</code> provides an Array-specific version of the <code>toString()</code> method, overriding <code>Object.prototype.toString()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">arr</code> <code class="o">=</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">];</code>
<code class="o">&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">getOwnPropertyNames</code><code class="p">(</code><code class="n">Array</code><code class="p">.</code><code class="n">prototype</code><code class="p">)</code>
<code class="p">[</code> <code class="err">'</code><code class="n">toString</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">join</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">pop</code><code class="err">'</code><code class="p">,</code> <code class="err">···</code> <code class="p">]</code>
<code class="o">&gt;</code> <code class="n">arr</code><code class="p">.</code><code class="n">toString</code><code class="p">()</code>
<code class="err">'</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="err">'</code>
</pre></div>

</div>


<h4 id="leanpub-auto-dispatched-method-calls">
<span class="section-number">12.3.2 </span>Dispatched method calls</h4>

<p>If you look at the method call <code>arr.toString()</code> you can see that it actually performs two steps:</p>

<ol class="numeric numeric">
<li>Dispatch: In the prototype chain of <code>arr</code>, retrieve the value of the first property whose name is <code>toString</code>.</li>
  <li>Call: Call the value and set the implicit parameter <code>this</code> to the <em>receiver</em> <code>arr</code> of the method invocation.</li>
</ol>
<p>You can make the two steps explicit by using the <code>call()</code> method of functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">func</code> <code class="o">=</code> <code class="n">arr</code><code class="p">.</code><code class="n">toString</code><code class="p">;</code> <code class="c1">// dispatch</code>
<code class="o">&gt;</code> <code class="n">func</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">arr</code><code class="p">)</code> <code class="c1">// direct call, providing a value for `this`</code>
<code class="err">'</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="err">'</code>
</pre></div>

</div>


<h4 id="leanpub-auto-direct-method-calls">
<span class="section-number">12.3.3 </span>Direct method calls</h4>

<p>There are two ways to make direct method calls in JavaScript:</p>

<ul>
<li><code>Function.prototype.call(thisValue, arg0?, arg1?, ···)</code></li>
  <li><code>Function.prototype.apply(thisValue, argArray)</code></li>
</ul>
<p>Both method <code>call</code> and method <code>apply</code> are invoked on functions. They are different from normal function calls in that you specify a value for <code>this</code>. <code>call</code> provides the arguments of the method call via individual parameters, <code>apply</code> provides them via an Array.</p>

<p>One problem of invoking a method via dynamic dispatch is that the method needs to be in the prototype chain of an object. <code>call()</code> enables you to call a method directly while specifying the receiver. That means that you can borrow a method from an object that is not in the current prototype chain. For example, you can borrow <code>Object.prototype.toString</code> and thus apply the original, un-overridden implementation of <code>toString</code> to <code>arr</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">toString</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">arr</code><code class="p">)</code>
<code class="err">'</code><code class="p">[</code><code class="n">object</code> <code class="n">Array</code><code class="p">]</code><code class="err">'</code>
</pre></div>

</div>

<p>Methods that work with a variety of objects (not just with instances of “their” constructor) are called <em>generic</em>. <em>Speaking JavaScript</em> has <a href="http://speakingjs.com/es5/ch17.html#list_of_generic_methods">a list</a> of all methods that are generic. The list includes most Array methods and all methods of <code>Object.prototype</code> (which have to work with all objects and are thus implicitly generic).</p>


<h4 id="leanpub-auto-use-cases-for-direct-method-calls">
<span class="section-number">12.3.4 </span>Use cases for direct method calls</h4>

<p>This section covers use cases for direct method calls. Each time, I’ll first describe the use case in ES5 and then how it changes with ES6 (where you’ll rarely need direct method calls).</p>

<h5 id="leanpub-auto-es5-provide-parameters-to-a-method-via-an-array">
<span class="section-number">12.3.4.1 </span>ES5: Provide parameters to a method via an Array</h5>

<p>Some functions accept multiple values, but only one value per parameter. What if you want to pass the values via an Array?</p>

<p>For example, <code>push()</code> lets you destructively append several values to an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">arr</code> <code class="o">=</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">];</code>
<code class="o">&gt;</code> <code class="n">arr</code><code class="p">.</code><code class="n">push</code><code class="p">(</code><code class="sc">'c'</code><code class="p">,</code> <code class="sc">'d'</code><code class="p">)</code>
<code class="mi">4</code>
<code class="o">&gt;</code> <code class="n">arr</code>
<code class="p">[</code> <code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">,</code> <code class="sc">'c'</code><code class="p">,</code> <code class="sc">'d'</code> <code class="p">]</code>
</pre></div>

</div>

<p>But you can’t destructively append a whole Array. You can work around that limitation by using <code>apply()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">arr</code> <code class="o">=</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">];</code>
<code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">push</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">arr</code><code class="p">,</code> <code class="p">[</code><code class="sc">'c'</code><code class="p">,</code> <code class="sc">'d'</code><code class="p">])</code>
<code class="mi">4</code>
<code class="o">&gt;</code> <code class="n">arr</code>
<code class="p">[</code> <code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">,</code> <code class="sc">'c'</code><code class="p">,</code> <code class="sc">'d'</code> <code class="p">]</code>
</pre></div>

</div>

<p>Similarly, <code>Math.max()</code> and <code>Math.min()</code> only work for single values:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">max</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
<code class="mi">7</code>
</pre></div>

</div>

<p>With <code>apply()</code>, you can use them for Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">max</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">null</code><code class="p">,</code> <code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">2</code><code class="p">])</code>
<code class="mi">7</code>
</pre></div>

</div>

<h5 id="leanpub-auto-es6-the-spread-operator--mostly-replaces-apply">
<span class="section-number">12.3.4.2 </span>ES6: The spread operator (<code>...</code>) mostly replaces <code>apply()</code>
</h5>

<p>Making a direct method call via <code>apply()</code> only because you want to turn an Array into arguments is clumsy, which is why ECMAScript 6 has the spread operator (<code>...</code>) for this. It provides this functionality even in dipatched method calls.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">max</code><code class="p">(...[</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">2</code><code class="p">])</code>
<code class="mi">7</code>
</pre></div>

</div>

<p>Another example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">arr</code> <code class="o">=</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">];</code>
<code class="o">&gt;</code> <code class="n">arr</code><code class="p">.</code><code class="n">push</code><code class="p">(...[</code><code class="sc">'c'</code><code class="p">,</code> <code class="sc">'d'</code><code class="p">])</code>
<code class="mi">4</code>
<code class="o">&gt;</code> <code class="n">arr</code>
<code class="p">[</code> <code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">,</code> <code class="sc">'c'</code><code class="p">,</code> <code class="sc">'d'</code> <code class="p">]</code>
</pre></div>

</div>

<p>As a bonus, spread also works with the <code>new</code> operator:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">new</code> <code class="n">Date</code><code class="p">(...[</code><code class="mi">2011</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">24</code><code class="p">])</code>
<code class="n">Sat</code> <code class="n">Dec</code> <code class="mi">24</code> <code class="mi">2011</code> <code class="mo">00</code><code class="o">:</code><code class="mo">00</code><code class="o">:</code><code class="mo">00</code> <code class="n">GMT</code><code class="o">+</code><code class="mo">0100</code> <code class="p">(</code><code class="n">CET</code><code class="p">)</code>
</pre></div>

</div>

<p>Note that <code>apply()</code> can’t be used with <code>new</code> – the above feat can only be achieved via <a href="http://speakingjs.com/es5/ch17.html#apply_constructors">a complicated work-around</a> in ECMAScript 5.</p>

<h5 id="leanpub-auto-es5-convert-an-array-like-object-to-an-array">
<span class="section-number">12.3.4.3 </span>ES5: Convert an Array-like object to an Array</h5>

<p>Some objects in JavaScript are <em>Array-like</em>, they are almost Arrays, but don’t have any of the Array methods. Let’s look at two examples.</p>

<p>First, the special variable <code>arguments</code> of functions is Array-like. It has a <code>length</code> and indexed access to elements.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">var</code> <code class="nx">args</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">arguments</code> <code class="p">}(</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="nx">args</code><code class="p">.</code><code class="nx">length</code>
<code class="mi">2</code>
<code class="o">&gt;</code> <code class="nx">args</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>
<code class="s1">'a'</code>
</pre></div>

</div>

<p>But <code>arguments</code> isn’t an instance of <code>Array</code> and does not have the method <code>forEach()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="nx">args</code> <code class="k">instanceof</code> <code class="nb">Array</code>
<code class="kc">false</code>
<code class="o">&gt;</code> <code class="nx">args</code><code class="p">.</code><code class="nx">forEach</code>
<code class="kc">undefined</code>
</pre></div>

</div>

<p>Second, the DOM method <code>document.querySelectorAll()</code> returns an instance of <code>NodeList</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">document</code><code class="p">.</code><code class="n">querySelectorAll</code><code class="p">(</code><code class="err">'</code><code class="n">a</code><code class="p">[</code><code class="n">href</code><code class="p">]</code><code class="err">'</code><code class="p">)</code> <code class="n">instanceof</code> <code class="n">NodeList</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">document</code><code class="p">.</code><code class="n">querySelectorAll</code><code class="p">(</code><code class="err">'</code><code class="n">a</code><code class="p">[</code><code class="n">href</code><code class="p">]</code><code class="err">'</code><code class="p">).</code><code class="n">forEach</code> <code class="c1">// no Array methods!</code>
<code class="n">undefined</code>
</pre></div>

</div>

<p>Thus, for many complex operations, you need to convert Array-like objects to Arrays first. That is achieved via <code>Array.prototype.slice()</code>. This method copies the elements of its receiver into a new Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">arr</code> <code class="o">=</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">];</code>
<code class="o">&gt;</code> <code class="n">arr</code><code class="p">.</code><code class="n">slice</code><code class="p">()</code>
<code class="p">[</code> <code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code> <code class="p">]</code>
<code class="o">&gt;</code> <code class="n">arr</code><code class="p">.</code><code class="n">slice</code><code class="p">()</code> <code class="o">===</code> <code class="n">arr</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>If you call <code>slice()</code> directly, you can convert a <code>NodeList</code> to an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">domLinks</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelectorAll</code><code class="p">(</code><code class="s1">'a[href]'</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">links</code> <code class="o">=</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">domLinks</code><code class="p">);</code>
<code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">link</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">link</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<p>And you can convert <code>arguments</code> to an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">format</code><code class="p">(</code><code class="nx">pattern</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// params start at arguments[1], skipping `pattern`</code>
    <code class="kd">var</code> <code class="nx">params</code> <code class="o">=</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>
    <code class="k">return</code> <code class="nx">params</code><code class="p">;</code>
<code class="p">}</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">format</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">));</code> <code class="c1">// ['b', 'c']</code>
</pre></div>

</div>

<h5 id="leanpub-auto-es6-array-like-objects-are-less-burdensome">
<span class="section-number">12.3.4.4 </span>ES6: Array-like objects are less burdensome</h5>

<p>On one hand, ECMAScript 6 has <code>Array.from()</code>, a simpler way of converting Array-like objects to Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">domLinks</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelectorAll</code><code class="p">(</code><code class="s1">'a[href]'</code><code class="p">);</code>
<code class="kd">let</code> <code class="nx">links</code> <code class="o">=</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">domLinks</code><code class="p">);</code>
<code class="nx">links</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">link</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">link</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<p>On the other hand, you won’t need the Array-like <code>arguments</code>, because ECMAScript 6 has <em>rest parameters</em> (declared via a triple dot):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">format</code><code class="p">(</code><code class="nx">pattern</code><code class="p">,</code> <code class="p">...</code><code class="nx">params</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">params</code><code class="p">;</code>
<code class="p">}</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">format</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">));</code> <code class="c1">// ['b', 'c']</code>
</pre></div>

</div>

<h5 id="leanpub-auto-es5-using-hasownproperty-safely">
<span class="section-number">12.3.4.5 </span>ES5: Using <code>hasOwnProperty()</code> safely</h5>

<p><code>obj.hasOwnProperty('prop')</code> tells you whether <code>obj</code> has the <em>own</em> (non-inherited) property <code>prop</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="n">prop</code><code class="o">:</code> <code class="mi">123</code> <code class="p">};</code>

<code class="o">&gt;</code> <code class="n">obj</code><code class="p">.</code><code class="n">hasOwnProperty</code><code class="p">(</code><code class="err">'</code><code class="n">prop</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>

<code class="o">&gt;</code> <code class="err">'</code><code class="n">toString</code><code class="err">'</code> <code class="n">in</code> <code class="n">obj</code> <code class="c1">// inherited</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">obj</code><code class="p">.</code><code class="n">hasOwnProperty</code><code class="p">(</code><code class="err">'</code><code class="n">toString</code><code class="err">'</code><code class="p">)</code> <code class="c1">// own</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>However, calling <code>hasOwnProperty</code> via dispatch can cease to work properly if <code>Object.prototype.hasOwnProperty</code> is overridden.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">var</code> <code class="nx">obj1</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">hasOwnProperty</code><code class="o">:</code> <code class="mi">123</code> <code class="p">};</code>
<code class="o">&gt;</code> <code class="nx">obj1</code><code class="p">.</code><code class="nx">hasOwnProperty</code><code class="p">(</code><code class="s1">'toString'</code><code class="p">)</code>
<code class="nx">TypeError</code><code class="o">:</code> <code class="nx">Property</code> <code class="s1">'hasOwnProperty'</code> <code class="nx">is</code> <code class="nx">not</code> <code class="nx">a</code> <code class="kd">function</code>
</pre></div>

</div>

<p><code>hasOwnProperty</code> may also be unavailable via dispatch if <code>Object.prototype</code> is not in the prototype chain of an object.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">obj2</code> <code class="o">=</code> <code class="n">Object</code><code class="p">.</code><code class="n">create</code><code class="p">(</code><code class="n">null</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">obj2</code><code class="p">.</code><code class="n">hasOwnProperty</code><code class="p">(</code><code class="err">'</code><code class="n">toString</code><code class="err">'</code><code class="p">)</code>
<code class="nl">TypeError:</code> <code class="n">Object</code> <code class="n">has</code> <code class="n">no</code> <code class="n">method</code> <code class="err">'</code><code class="n">hasOwnProperty</code><code class="err">'</code>
</pre></div>

</div>

<p>In both cases, the solution is to make a direct call to <code>hasOwnProperty</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">obj1</code> <code class="o">=</code> <code class="p">{</code> <code class="n">hasOwnProperty</code><code class="o">:</code> <code class="mi">123</code> <code class="p">};</code>
<code class="o">&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">hasOwnProperty</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">obj1</code><code class="p">,</code> <code class="err">'</code><code class="n">hasOwnProperty</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>

<code class="o">&gt;</code> <code class="n">var</code> <code class="n">obj2</code> <code class="o">=</code> <code class="n">Object</code><code class="p">.</code><code class="n">create</code><code class="p">(</code><code class="n">null</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">prototype</code><code class="p">.</code><code class="n">hasOwnProperty</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">obj2</code><code class="p">,</code> <code class="err">'</code><code class="n">toString</code><code class="err">'</code><code class="p">)</code>
<code class="nb">false</code>
</pre></div>

</div>

<h5 id="leanpub-auto-es6-less-need-for-hasownproperty">
<span class="section-number">12.3.4.6 </span>ES6: Less need for <code>hasOwnProperty()</code>
</h5>

<p><code>hasOwnProperty()</code> is mostly used to implement Maps via objects. Thankfully, ECMAScript 6 has a built-in <code>Map</code> data structure, which means that you’ll need <code>hasOwnProperty()</code> less.</p>

<h5 id="leanpub-auto-es5-avoiding-intermediate-objects">
<span class="section-number">12.3.4.7 </span>ES5: Avoiding intermediate objects</h5>

<p>Applying an Array method such as <code>join()</code> to a string normally involves two steps:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">str</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">arr</code> <code class="o">=</code> <code class="nx">str</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s1">''</code><code class="p">);</code> <code class="c1">// step 1</code>
<code class="kd">var</code> <code class="nx">joined</code> <code class="o">=</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s1">'-'</code><code class="p">);</code> <code class="c1">// step 2</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">joined</code><code class="p">);</code> <code class="c1">// a-b-c</code>
</pre></div>

</div>

<p>Strings are Array-like and can become the <code>this</code> value of generic Array methods. Therefore, a direct call lets you avoid step 1:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">str</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">joined</code> <code class="o">=</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">join</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">str</code><code class="p">,</code> <code class="s1">'-'</code><code class="p">);</code>
</pre></div>

</div>

<p>Similarly, you can apply <code>map()</code> to a string either after you split it or via a direct method call:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">function</code> <code class="nx">toUpper</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">.</code><code class="nx">toUpperCase</code><code class="p">()</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="s1">'abc'</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s1">''</code><code class="p">).</code><code class="nx">map</code><code class="p">(</code><code class="nx">toUpper</code><code class="p">)</code>
<code class="cp">[</code> <code class="s1">'A'</code><code class="p">,</code> <code class="s1">'B'</code><code class="p">,</code> <code class="s1">'C'</code> <code class="cp">]</code>

<code class="o">&gt;</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">map</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="s1">'abc'</code><code class="p">,</code> <code class="nx">toUpper</code><code class="p">)</code>
<code class="cp">[</code> <code class="s1">'A'</code><code class="p">,</code> <code class="s1">'B'</code><code class="p">,</code> <code class="s1">'C'</code> <code class="cp">]</code>
</pre></div>

</div>

<p>Note that the direct calls may be more efficient, but they are also much less elegant. Be sure that they are really worth it!</p>

<h5 id="leanpub-auto-es6-avoiding-intermediate-objects">
<span class="section-number">12.3.4.8 </span>ES6: Avoiding intermediate objects</h5>

<p><code>Array.from()</code> can convert and map in a single step, if you provide it with a callback as the second argument.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">(</code><code class="err">'</code><code class="n">abc</code><code class="err">'</code><code class="p">,</code> <code class="n">ch</code> <code class="o">=&gt;</code> <code class="n">ch</code><code class="p">.</code><code class="n">toUpperCase</code><code class="p">())</code>
<code class="p">[</code> <code class="sc">'A'</code><code class="p">,</code> <code class="sc">'B'</code><code class="p">,</code> <code class="sc">'C'</code> <code class="p">]</code>
</pre></div>

</div>

<p>As a reminder, the two step solution is:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="s1">'abc'</code><code class="p">.</code><code class="nx">split</code><code class="p">(</code><code class="s1">''</code><code class="p">).</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code><code class="p">.</code><code class="nx">toUpperCase</code><code class="p">()</code> <code class="p">})</code>
<code class="cp">[</code> <code class="s1">'A'</code><code class="p">,</code> <code class="s1">'B'</code><code class="p">,</code> <code class="s1">'C'</code> <code class="cp">]</code>
</pre></div>

</div>


<h4 id="leanpub-auto-abbreviations-for-objectprototype-and-arrayprototype">
<span class="section-number">12.3.5 </span>Abbreviations for <code>Object.prototype</code> and <code>Array.prototype</code>
</h4>

<p>You can access the methods of <code>Object.prototype</code> via an empty object literal (whose prototype is <code>Object.prototype</code>). For example, the following two direct method calls are equivalent:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nb">Object</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">hasOwnProperty</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="s1">'propKey'</code><code class="p">)</code>
<code class="p">{}.</code><code class="nx">hasOwnProperty</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="s1">'propKey'</code><code class="p">)</code>
</pre></div>

</div>

<p>The same trick works for <code>Array.prototype</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nb">Array</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">)</code>
<code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">)</code>
</pre></div>

</div>

<p>This pattern has become quite popular. It does not reflect the intention of the author as clearly as the longer version, but it’s much less verbose. <a href="http://jsperf.com/array-prototype-slice-call-vs-slice-call/17">Speed-wise</a>, there isn’t much of a difference between the two versions.</p>

<h2 id="ch_arrow-functions">
<span class="section-number">13. </span>Arrow functions</h2>


<h3 id="leanpub-auto-overview-7">
<span class="section-number">13.1 </span>Overview</h3>

<p>There are two benefits to arrow functions.</p>

<p>First, they are less verbose than traditional function expressions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">];</code>
<code class="kd">let</code> <code class="nx">squares</code> <code class="o">=</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code><code class="p">);</code>

<code class="c1">// Traditional function expression:</code>
<code class="kd">let</code> <code class="nx">squares</code> <code class="o">=</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code> <code class="p">});</code>
</pre></div>

</div>

<p>Second, their <code>this</code> is picked up from surroundings (<em>lexical</em>). Therefore, you don’t need <code>bind()</code> or <code>that = this</code>, anymore.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">UiComponent</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">button</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'myButton'</code><code class="p">);</code>
    <code class="nx">button</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'CLICK'</code><code class="p">);</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">handleClick</code><code class="p">();</code> <code class="c1">// lexical `this`</code>
    <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The following variables are all lexical:</p>

<ul>
<li><code>arguments</code></li>
  <li><code>super</code></li>
  <li><code>this</code></li>
  <li><code>new.target</code></li>
</ul>
<h3 id="leanpub-auto-traditional-functions-are-bad-non-method-functions-due-to-this">
<span class="section-number">13.2 </span>Traditional functions are bad non-method functions, due to <code>this</code>
</h3>

<p>In JavaScript, traditional functions can be used as:</p>

<ol class="numeric numeric">
<li>Non-method functions</li>
  <li>Methods</li>
  <li>Constructors</li>
</ol>
<p>These roles clash: Due to roles 2 and 3, functions always have their own <code>this</code>. But that prevents you from accessing the <code>this</code> of, e.g., a surrounding method from inside a callback (role 1).</p>

<p>You can see that in the following ES5 code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">Prefixer</code><code class="p">(</code><code class="nx">prefix</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">=</code> <code class="nx">prefix</code><code class="p">;</code>
<code class="p">}</code>
<code class="nx">Prefixer</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">prefixArray</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">arr</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// (A)</code>
    <code class="s1">'use strict'</code><code class="p">;</code>
    <code class="k">return</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// (B)</code>
        <code class="c1">// Doesn’t work:</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">+</code> <code class="nx">x</code><code class="p">;</code> <code class="c1">// (C)</code>
    <code class="p">});</code>
<code class="p">};</code>
</pre></div>

</div>

<p>In line C, we’d like to access <code>this.name</code>, but can’t do that because the <code>this</code> of the function from line B shadows the <code>this</code> of the method from line A. In strict mode, <code>this</code> is <code>undefined</code> in non-method functions, which is why we get an error if we use <code>Prefixer</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">pre</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Prefixer</code><code class="p">(</code><code class="err">'</code><code class="n">Hi</code> <code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">pre</code><code class="p">.</code><code class="n">prefixArray</code><code class="p">([</code><code class="err">'</code><code class="n">Joe</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">Alex</code><code class="err">'</code><code class="p">])</code>
<code class="nl">TypeError:</code> <code class="n">Cannot</code> <code class="n">read</code> <code class="n">property</code> <code class="err">'</code><code class="n">prefix</code><code class="err">'</code> <code class="n">of</code> <code class="n">undefined</code>
</pre></div>

</div>

<p>There are three ways to work around this problem in ECMAScript 5.</p>

<h4 id="leanpub-auto-solution-1-that--this">
<span class="section-number">13.2.1 </span>Solution 1: <code>that = this</code>
</h4>

<p>You can assign <code>this</code> to a variable that isn’t shadowed. That’s what’s done in line A, below:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">Prefixer</code><code class="p">(</code><code class="nx">prefix</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">=</code> <code class="nx">prefix</code><code class="p">;</code>
<code class="p">}</code>
<code class="nx">Prefixer</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">prefixArray</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">arr</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">that</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code> <code class="c1">// (A)</code>
    <code class="k">return</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">that</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">+</code> <code class="nx">x</code><code class="p">;</code>
    <code class="p">});</code>
<code class="p">};</code>
</pre></div>

</div>

<p>Now <code>Prefixer</code> works as expected:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">pre</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Prefixer</code><code class="p">(</code><code class="err">'</code><code class="n">Hi</code> <code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">pre</code><code class="p">.</code><code class="n">prefixArray</code><code class="p">([</code><code class="err">'</code><code class="n">Joe</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">Alex</code><code class="err">'</code><code class="p">])</code>
<code class="p">[</code> <code class="err">'</code><code class="n">Hi</code> <code class="n">Joe</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">Hi</code> <code class="n">Alex</code><code class="err">'</code> <code class="p">]</code>
</pre></div>

</div>

<h4 id="leanpub-auto-solution-2-specifying-a-value-for-this">
<span class="section-number">13.2.2 </span>Solution 2: specifying a value for <code>this</code>
</h4>

<p>A few Array methods have an extra parameter for specifying the value that <code>this</code> should have when invoking the callback. That’s the last parameter in line A, below.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">Prefixer</code><code class="p">(</code><code class="nx">prefix</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">=</code> <code class="nx">prefix</code><code class="p">;</code>
<code class="p">}</code>
<code class="nx">Prefixer</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">prefixArray</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">arr</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">+</code> <code class="nx">x</code><code class="p">;</code>
    <code class="p">},</code> <code class="k">this</code><code class="p">);</code> <code class="c1">// (A)</code>
<code class="p">};</code>
</pre></div>

</div>

<h4 id="leanpub-auto-solution-3-bindthis">
<span class="section-number">13.2.3 </span>Solution 3: <code>bind(this)</code>
</h4>

<p>You can use the method <code>bind()</code> to convert a function whose <code>this</code> is determined by how it is called (via <code>call()</code>, a function call, a method call, etc.) to a function whose <code>this</code> is always the same fixed value. That’s what we are doing in line A, below.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">Prefixer</code><code class="p">(</code><code class="nx">prefix</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">=</code> <code class="nx">prefix</code><code class="p">;</code>
<code class="p">}</code>
<code class="nx">Prefixer</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">prefixArray</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">arr</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">+</code> <code class="nx">x</code><code class="p">;</code>
    <code class="p">}.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">));</code> <code class="c1">// (A)</code>
<code class="p">};</code>
</pre></div>

</div>

<h4 id="leanpub-auto-ecmascript-6-solution-arrow-functions">
<span class="section-number">13.2.4 </span>ECMAScript 6 solution: arrow functions</h4>

<p>Arrow functions are basically solution 3, with a more convenient syntax. With an arrow function, the code looks as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">Prefixer</code><code class="p">(</code><code class="nx">prefix</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">=</code> <code class="nx">prefix</code><code class="p">;</code>
<code class="p">}</code>
<code class="nx">Prefixer</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">prefixArray</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">arr</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">x</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">+</code> <code class="nx">x</code><code class="p">;</code>
    <code class="p">});</code>
<code class="p">};</code>
</pre></div>

</div>

<p>To fully ES6-ify the code, you’d use a class and a more compact variant of arrow functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Prefixer</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">prefix</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">=</code> <code class="nx">prefix</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">prefixArray</code><code class="p">(</code><code class="nx">arr</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="k">this</code><code class="p">.</code><code class="nx">prefix</code> <code class="o">+</code> <code class="nx">x</code><code class="p">);</code> <code class="c1">// (A)</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In line A we save a few characters by tweaking two parts of the arrow function:</p>

<ul>
<li>If there is only one parameter and that parameter is an identifier then the parentheses can be omitted.</li>
  <li>An expression following the arrow leads to that expression being returned.</li>
</ul>
<p>In the code, you can also see that the methods <code>constructor</code> and <code>prefixArray</code> are defined using new, more compact ES6 syntax that also works in object literals.</p>


<h3 id="leanpub-auto-arrow-function-syntax">
<span class="section-number">13.3 </span>Arrow function syntax</h3>

<p>The “fat” arrow <code>=&gt;</code> (as opposed to the thin arrow <code>-&gt;</code>) was chosen to be compatible with CoffeeScript, whose fat arrow functions are very similar.</p>

<p>Specifying parameters:</p>

<div class="code-block">
<div class="highlight"><pre>    <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="p">...</code> <code class="p">}</code> <code class="c1">// no parameter</code>
     <code class="nx">x</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="p">...</code> <code class="p">}</code> <code class="c1">// one parameter, an identifier</code>
<code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="p">...</code> <code class="p">}</code> <code class="c1">// several parameters</code>
</pre></div>

</div>

<p>Specifying a body:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">x</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code> <code class="p">}</code>  <code class="c1">// block</code>
<code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code>  <code class="c1">// expression, equivalent to previous line</code>
</pre></div>

</div>

<p>The statement block behaves like a normal function body. For example, you need <code>return</code> to give back a value. With an expression body, the expression is always implicitly returned.</p>

<p>Note how much an arrow function with an expression body can reduce verbosity. Compare:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">squares</code> <code class="o">=</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">].</code><code class="nx">map</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code> <code class="p">});</code>
<code class="kd">let</code> <code class="nx">squares</code> <code class="o">=</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">].</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code><code class="p">);</code>
</pre></div>

</div>


<h3 id="leanpub-auto-lexical-variables">
<span class="section-number">13.4 </span>Lexical variables</h3>

<h4 id="leanpub-auto-sources-of-variable-values-static-versus-dynamic">
<span class="section-number">13.4.1 </span>Sources of variable values: static versus dynamic</h4>

<p>The following are two ways in which a variable can receive its value.</p>

<p>First, statically (lexically): Its value is determined by the structure of the program, it receives its value from a surrounding scope. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">x</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>

<code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">x</code><code class="p">;</code> <code class="c1">// value received statically</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Second, dynamically: It receives its value via a function call. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">bar</code><code class="p">(</code><code class="nx">arg</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">arg</code><code class="p">;</code> <code class="c1">// value received dynamically</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-variables-that-are-lexical-in-arrow-functions">
<span class="section-number">13.4.2 </span>Variables that are lexical in arrow functions</h4>

<p>The source of <code>this</code> is an important distinguishing aspect of arrow functions:</p>

<ul>
<li>Traditional functions have a <em>dynamic <code>this</code></em>, its value is determined by how they are called.</li>
  <li>Arrow functions have a <em>lexical <code>this</code></em>, its value is determined by the surrounding scope.</li>
</ul>
<p>The <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-arrow-function-definitions-runtime-semantics-evaluation">complete list</a> of variables whose values are determined lexically is:</p>

<ul>
<li><code>arguments</code></li>
  <li><code>super</code></li>
  <li><code>this</code></li>
  <li><code>new.target</code></li>
</ul>
<h3 id="leanpub-auto-syntax-pitfalls">
<span class="section-number">13.5 </span>Syntax pitfalls</h3>

<p>There are a few syntax-related details that can sometimes trip you up.</p>

<h4 id="leanpub-auto-arrow-functions-bind-very-loosely">
<span class="section-number">13.5.1 </span>Arrow functions bind very loosely</h4>

<p>Arrow functions bind very loosely. The reason is that you want every expression that can appear in an expression body to “stick together”, it should bind more tightly than the arrow function.</p>

<p>As a consequence, you often have to wrap arrow functions in parentheses if they appear somewhere else. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="k">typeof</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{});</code> <code class="c1">// SyntaxError</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="k">typeof</code> <code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{}));</code> <code class="c1">// OK</code>
</pre></div>

</div>

<p>On the flip side, you can use <code>typeof</code> as an expression body without putting it in parens:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">f</code> <code class="o">=</code> <code class="nx">x</code> <code class="o">=&gt;</code> <code class="k">typeof</code> <code class="nx">x</code><code class="p">;</code>
</pre></div>

</div>

<h4 id="iiaf">
<span class="section-number">13.5.2 </span>Immediately-invoked arrow functions</h4>

<p>Remember <a href="http://speakingjs.com/es5/ch16.html#iife">Immediately Invoked Function Expressions (IIFEs)</a>? They look as follows and are used to simulate block-scoping and value-returning blocks in ECMAScript 5:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="c1">// open IIFE</code>
    <code class="c1">// inside IIFE</code>
<code class="p">}());</code> <code class="c1">// close IIFE</code>
</pre></div>

</div>

<p>You can save a few characters if you use an Immediately Invoked Arrow Function (IIAF):</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">return</code> <code class="mi">123</code>
<code class="p">})();</code>
</pre></div>

</div>

<p>Similarly to IIFEs, you should terminate IIAFs with semicolons (or use <a href="http://speakingjs.com/es5/ch16.html#iife_prefix">an equivalent measure</a>), to avoid two consecutive IIAFs being interpreted as a function call (the first one as the function, the second one as the parameter).</p>

<p>Even if the IIAF has a block body, you must wrap it in parentheses, because it can’t be (directly) function-called, due to how loosely it binds. Note that the parentheses must be around the arrow function. With IIFEs you have a choice: you can either put the parentheses around the whole statement or just around the function expression.</p>

<p>As mentioned in the previous section, arrow functions binding loosely is useful for expression bodies, where you want this expression:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">value</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">foo</code><code class="p">()</code>
</pre></div>

</div>

<p>to be interpreted as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">value</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">(</code><code class="nx">foo</code><code class="p">())</code>
</pre></div>

</div>

<p>and not as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">value</code> <code class="o">=</code> <code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">foo</code><code class="p">)()</code>
</pre></div>

</div>

<p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_iifes-in-es6">A section in the chapter on callable entities</a> has more information on using IIFEs and IIAFs in ES6.</p>

<h4 id="sec_single-param-arrow-funcs">
<span class="section-number">13.5.3 </span>Omitting parentheses around single parameters</h4>

<p>Omitting the parentheses around the parameters is only possible if they consist of a single identifier:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">].</code><code class="n">map</code><code class="p">(</code><code class="n">x</code> <code class="o">=&gt;</code> <code class="mi">2</code> <code class="o">*</code> <code class="n">x</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">6</code> <code class="p">]</code>
</pre></div>

</div>

<p>As soon as there is anything else, you have to type the parentheses, even if there is only a single parameter. For example, you need parens if you destructure a single parameter:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[[</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">],</code> <code class="p">[</code><code class="mi">3</code><code class="p">,</code><code class="mi">4</code><code class="p">]].</code><code class="n">map</code><code class="p">(([</code><code class="n">a</code><code class="p">,</code><code class="n">b</code><code class="p">])</code> <code class="o">=&gt;</code> <code class="n">a</code> <code class="o">+</code> <code class="n">b</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">7</code> <code class="p">]</code>
</pre></div>

</div>

<p>And you need parens if a single parameter has a default value (<code>undefined</code> triggers the default value!):</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="n">undefined</code><code class="p">,</code> <code class="mi">3</code><code class="p">].</code><code class="n">map</code><code class="p">((</code><code class="n">x</code><code class="o">=</code><code class="err">'</code><code class="n">yes</code><code class="err">'</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="n">x</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="err">'</code><code class="n">yes</code><code class="err">'</code><code class="p">,</code> <code class="mi">3</code> <code class="p">]</code>
</pre></div>

</div>

<h4 id="leanpub-auto-you-cant-use-statements-as-expression-bodies">
<span class="section-number">13.5.4 </span>You can’t use statements as expression bodies</h4>

<h5 id="leanpub-auto-expressions-versus-statements">
<span class="section-number">13.5.4.1 </span>Expressions versus statements</h5>

<p>Quick review (<a href="http://speakingjs.com/es5/ch07.html#expr_vs_stmt">consult “Speaking JavaScript” for more information</a>):</p>

<p>Expressions produce (are evaluated to) values. Examples:</p>

<div class="code-block">
<div class="highlight"><pre><code class="mi">3</code> <code class="o">+</code> <code class="mi">4</code>
<code class="nx">foo</code><code class="p">(</code><code class="mi">7</code><code class="p">)</code>
<code class="s1">'abc'</code><code class="p">.</code><code class="nx">length</code>
</pre></div>

</div>

<p>Statements do things. Examples:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
<code class="k">return</code> <code class="mi">123</code><code class="p">;</code>
</pre></div>

</div>

<p>Most expressions<sup id="fnref-arrow_functions_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-arrow_functions_1" rel="footnote">1</a></sup> can be used as statements, simply by mentioning them in statement positions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">bar</code><code class="p">()</code> <code class="p">{</code>
    <code class="mi">3</code> <code class="o">+</code> <code class="mi">4</code><code class="p">;</code>
    <code class="nx">foo</code><code class="p">(</code><code class="mi">7</code><code class="p">);</code>
    <code class="s1">'abc'</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-the-bodies-of-arrow-functions">
<span class="section-number">13.5.4.2 </span>The bodies of arrow functions</h5>

<p>If an expression is the body an arrow function, you don’t need braces:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">asyncFunc</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">));</code>
</pre></div>

</div>

<p>However, statements have to be put in braces:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">asyncFunc</code><code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="k">throw</code> <code class="nx">x</code> <code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-returning-an-object-literal">
<span class="section-number">13.5.5 </span>Returning an object literal</h4>

<p>Having a block body in addition to an expression body means that if you want the expression body to be an object literal, you have to put it in parentheses.</p>

<p>The body of this arrow function is a block with the label <code>bar</code> and the expression statement <code>123</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">f</code> <code class="o">=</code> <code class="nx">x</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="nx">bar</code><code class="o">:</code> <code class="mi">123</code> <code class="p">}</code>
</pre></div>

</div>

<p>The body of this arrow function is an expression, an object literal:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">f</code> <code class="o">=</code> <code class="nx">x</code> <code class="o">=&gt;</code> <code class="p">({</code> <code class="nx">bar</code><code class="o">:</code> <code class="mi">123</code> <code class="p">})</code>
</pre></div>

</div>


<h3 id="leanpub-auto-arrow-functions-versus-normal-functions">
<span class="section-number">13.6 </span>Arrow functions versus normal functions</h3>

<p>An arrow function is different from a normal function in only two ways:</p>

<ul>
<li>The following constructs are lexical: <code>arguments</code>, <code>super</code>, <code>this</code>, <code>new.target</code>
</li>
  <li>It can’t be used as a constructor: There is no internal method <code>[[Construct]]</code> that allows a normal function to be invoked via <code>new</code> and no property <code>prototype</code>. Therefore, <code>new (() =&gt; {})</code> throws an error.</li>
</ul>
<p>Apart from that, there are no observable differences between an arrow function and a normal function. For example, <code>typeof</code> and <code>instanceof</code> produce the same results:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="k">typeof</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{}</code>
<code class="s1">'function'</code>
<code class="o">&gt;</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{}</code> <code class="k">instanceof</code> <code class="nb">Function</code>
<code class="kc">true</code>

<code class="o">&gt;</code> <code class="k">typeof</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{}</code>
<code class="s1">'function'</code>
<code class="o">&gt;</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{}</code> <code class="k">instanceof</code> <code class="nb">Function</code>
<code class="kc">true</code>
</pre></div>

</div>

<p>Consult <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_callables-style">the chapter on callable entities</a> for more information on when to use arrow functions and when to use traditional functions.</p>

<div class="footnotes">
  <ol>
<li id="fn-arrow_functions_1">The exceptions are function expressions and object literals, which you have to put in parentheses, because they look like function declarations and code blocks.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-arrow_functions_1" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h2 id="leanpub-auto-new-oop-features-besides-classes">
<span class="section-number">14. </span>New OOP features besides classes</h2>

<p>Classes (which are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_classes">the next chapter</a>) are <em>the</em> major new OOP feature in ECMAScript 6. However, it also includes new features for object literals and new utility methods in <code>Object</code>. This chapter describes them.</p>

<h3 id="leanpub-auto-overview-8">
<span class="section-number">14.1 </span>Overview</h3>

<h4 id="leanpub-auto-new-object-literal-features">
<span class="section-number">14.1.1 </span>New object literal features</h4>

<p>Method definitions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">myMethod</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>Property value shorthands:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">first</code> <code class="o">=</code> <code class="s1">'Jane'</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">last</code> <code class="o">=</code> <code class="s1">'Doe'</code><code class="p">;</code>

<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">first</code><code class="p">,</code> <code class="nx">last</code> <code class="p">};</code>
<code class="c1">// Same as:</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="nx">first</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="nx">last</code> <code class="p">};</code>
</pre></div>

</div>

<p>Computed property keys:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">propKey</code> <code class="o">=</code> <code class="s1">'foo'</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">propKey</code><code class="p">]</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="p">[</code><code class="s1">'b'</code><code class="o">+</code><code class="s1">'ar'</code><code class="p">]</code><code class="o">:</code> <code class="mi">123</code>
<code class="p">};</code>
</pre></div>

</div>

<p>This new syntax can also be used for method definitions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="s1">'h'</code><code class="o">+</code><code class="s1">'ello'</code><code class="p">]()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'hi'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">hello</code><code class="p">());</code> <code class="c1">// hi</code>
</pre></div>

</div>

<p>The main use case for computed property keys is to make it easy to use symbols as property keys.</p>

<h4 id="leanpub-auto-new-methods-in-object">
<span class="section-number">14.1.2 </span>New methods in <code>Object</code>
</h4>

<p>The most important new method of <code>Object</code> is <code>assign()</code>. Traditionally, this functionality was called <code>extend()</code> in the JavaScript world. In contrast to how this classic operation works, <code>Object.assign()</code> only considers <em>own</em> (non-inherited) properties.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">foo</code><code class="o">:</code> <code class="mi">123</code> <code class="p">};</code>
<code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="p">{</code> <code class="nx">bar</code><code class="o">:</code> <code class="kc">true</code> <code class="p">});</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">obj</code><code class="p">));</code>
    <code class="c1">// {"foo":123,"bar":true}</code>
</pre></div>

</div>

<h3 id="leanpub-auto-new-features-of-object-literals">
<span class="section-number">14.2 </span>New features of object literals</h3>

<h4 id="object-literal-method-definitions">
<span class="section-number">14.2.1 </span>Method definitions</h4>

<p>In ECMAScript 5, methods are properties whose values are functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">myMethod</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>In ECMAScript 6, methods are still function-valued properties, but there is now a more compact way of defining them:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">myMethod</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>Getters and setters continue to work as they did in ECMAScript 5 (note how syntactically similar they are to method definitions):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">get</code> <code class="nx">foo</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'GET foo'</code><code class="p">);</code>
        <code class="k">return</code> <code class="mi">123</code><code class="p">;</code>
    <code class="p">},</code>
    <code class="nx">set</code> <code class="nx">bar</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'SET bar to '</code><code class="o">+</code><code class="nx">value</code><code class="p">);</code>
        <code class="c1">// return value is ignored</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>Let’s use <code>obj</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">obj</code><code class="p">.</code><code class="n">foo</code>
<code class="n">GET</code> <code class="n">foo</code>
<code class="mi">123</code>
<code class="o">&gt;</code> <code class="n">obj</code><code class="p">.</code><code class="n">bar</code> <code class="o">=</code> <code class="nb">true</code>
<code class="n">SET</code> <code class="n">bar</code> <code class="n">to</code> <code class="nb">true</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>There is also a way to concisely define properties whose values are generator functions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">let</code> <code class="n">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="o">*</code> <code class="n">myGeneratorMethod</code><code class="p">()</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>This code is equivalent to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">myGeneratorMethod</code><code class="o">:</code> <code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<h4 id="leanpub-auto-property-value-shorthands-1">
<span class="section-number">14.2.2 </span>Property value shorthands</h4>

<p>Property value shorthands let you abbreviate the definition of a property in an object literal: If the name of the variable that specifies the property value is also the property key then you can omit the key. This looks as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">x</code> <code class="o">=</code> <code class="mi">4</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">y</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="p">,</code> <code class="nx">y</code> <code class="p">};</code>
</pre></div>

</div>

<p>The last line is equivalent to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="nx">y</code> <code class="p">};</code>
</pre></div>

</div>

<p>Property value shorthands work well together with destructuring:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">1</code> <code class="p">};</code>
<code class="kd">let</code> <code class="p">{</code><code class="nx">x</code><code class="p">,</code><code class="nx">y</code><code class="p">}</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code> <code class="c1">// 4</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">y</code><code class="p">);</code> <code class="c1">// 1</code>
</pre></div>

</div>

<p>One use case for property value shorthands are multiple return values (which are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_multiple-return-values">the chapter on destructuring</a>).</p>

<h4 id="leanpub-auto-computed-property-keys-1">
<span class="section-number">14.2.3 </span>Computed property keys</h4>

<p>Remember that there are two ways of specifying a key when you set a property.</p>

<ol class="numeric numeric">
<li>Via a fixed name: <code>obj.foo = true;</code>
</li>
  <li>Via an expression: <code>obj['b'+'ar'] = 123;</code>
</li>
</ol>
<p>In object literals, you only have option #1 in ECMAScript 5. ECMAScript 6 additionally provides option #2:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">propKey</code> <code class="o">=</code> <code class="s1">'foo'</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">propKey</code><code class="p">]</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="p">[</code><code class="s1">'b'</code><code class="o">+</code><code class="s1">'ar'</code><code class="p">]</code><code class="o">:</code> <code class="mi">123</code>
<code class="p">};</code>
</pre></div>

</div>

<p>This new syntax can also be used for method definitions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="s1">'h'</code><code class="o">+</code><code class="s1">'ello'</code><code class="p">]()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'hi'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">hello</code><code class="p">());</code> <code class="c1">// hi</code>
</pre></div>

</div>

<p>The main use case for computed property keys are symbols: you can define a public symbol and use it as a special property key that is always unique. One prominent example is the symbol stored in <code>Symbol.iterator</code>. If on object has a method with that key, it becomes <em>iterable</em>: The method must return an iterator, which is used by constructs such as the <code>for-of</code> loop to iterate over the object. The following code demonstrates how that works.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="o">*</code> <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code> <code class="c1">// (A)</code>
        <code class="k">yield</code> <code class="s1">'hello'</code><code class="p">;</code>
        <code class="k">yield</code> <code class="s1">'world'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// hello</code>
<code class="c1">// world</code>
</pre></div>

</div>

<p>Line A starts a generator method definition with a computed key (the symbol stored in <code>Symbol.iterator</code>).</p>

<h3 id="leanpub-auto-new-methods-of-object">
<span class="section-number">14.3 </span>New methods of <code>Object</code>
</h3>

<h4 id="Object_assign">
<span class="section-number">14.3.1 </span><code>Object.assign(target, source_1, source_2, ···)</code>
</h4>

<p>This method merges the sources into the target: It modifies <code>target</code>, first copies all enumerable own properties of <code>source_1</code> into it, then all own properties of <code>source_2</code>, etc. At the end, it returns the target.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">foo</code><code class="o">:</code> <code class="mi">123</code> <code class="p">};</code>
<code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="p">{</code> <code class="nx">bar</code><code class="o">:</code> <code class="kc">true</code> <code class="p">});</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">obj</code><code class="p">));</code>
    <code class="c1">// {"foo":123,"bar":true}</code>
</pre></div>

</div>

<p>Let’s look more close at how <code>Object.assign()</code> works:</p>

<ul>
<li>Both kinds of property keys: <code>Object.assign()</code> supports both strings and symbols as property keys.</li>
  <li>Only enumerable own properties: <code>Object.assign()</code> ignores inherited properties and properties that are not enumerable.</li>
  <li>Copying via assignment: Properties in the target object are created via assignment (internal operation [[Put]]). That means that if <code>target</code> has (own or inherited) setters, those will be invoked during copying. An alternative would have been to <em>define</em> new properties, an operation which always creates new own properties and never invokes setters. There originally was a proposal for a variant of <code>Object.assign()</code> that uses definition instead of assignment. That proposal has been rejected for ECMAScript 6, but may be reconsidered for later editions.</li>
  <li>You can’t move a method that uses <code>super</code>: Such a method has an internal property <code>[[HomeObject]]</code> that ties it to the object it was created in. If you move it via <code>Object.assign()</code>, it will continue to refer to the super-properties of the original object. Details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_cant-move-methods-with-super">a section in the chapter on classes</a>.</li>
</ul>
<h5 id="leanpub-auto-use-cases-for-objectassign">
<span class="section-number">14.3.1.1 </span>Use cases for <code>Object.assign()</code>
</h5>

<p>Let’s look at a few use cases.</p>

<h6 id="leanpub-auto-adding-properties-to-this">
<span class="section-number">14.3.1.1.1 </span>Adding properties to <code>this</code>
</h6>

<p>You can use <code>Object.assign()</code> to add properties to <code>this</code> in a constructor:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="p">{</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">});</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<h6 id="leanpub-auto-providing-default-values-for-object-properties">
<span class="section-number">14.3.1.1.2 </span>Providing default values for object properties</h6>

<p><code>Object.assign()</code> is also useful for filling in defaults for missing properties. In the following example, we have an object <code>DEFAULTS</code> with default values for properties and an object <code>options</code> with data.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">DEFAULTS</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">logLevel</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">outputFormat</code><code class="o">:</code> <code class="s1">'html'</code>
<code class="p">};</code>
<code class="kd">function</code> <code class="nx">processContent</code><code class="p">(</code><code class="nx">options</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">options</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">({},</code> <code class="nx">DEFAULTS</code><code class="p">,</code> <code class="nx">options</code><code class="p">);</code> <code class="c1">// (A)</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In line A, we created a fresh object, copied the defaults into it and then copied <code>options</code> into it, overriding the defaults. <code>Object.assign()</code> returns the result of these operations, which we assign to <code>options</code>.</p>

<h6 id="leanpub-auto-adding-methods-to-objects">
<span class="section-number">14.3.1.1.3 </span>Adding methods to objects</h6>

<p>Another use case is adding methods to objects:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">(</code><code class="nx">SomeClass</code><code class="p">.</code><code class="nx">prototype</code><code class="p">,</code> <code class="p">{</code>
    <code class="nx">someMethod</code><code class="p">(</code><code class="nx">arg1</code><code class="p">,</code> <code class="nx">arg2</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">},</code>
    <code class="nx">anotherMethod</code><code class="p">()</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>You could also manually assign functions, but then you don’t have the nice method definition syntax and need to mention <code>SomeClass.prototype</code> each time:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">SomeClass</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">someMethod</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">arg1</code><code class="p">,</code> <code class="nx">arg2</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">};</code>
<code class="nx">SomeClass</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">anotherMethod</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">};</code>
</pre></div>

</div>

<h6 id="leanpub-auto-cloning-objects">
<span class="section-number">14.3.1.1.4 </span>Cloning objects</h6>

<p>One last use case for <code>Object.assign()</code> is a quick way of cloning objects:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">orig</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">({},</code> <code class="nx">orig</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This way of cloning is also somewhat dirty, because it doesn’t preserve the property attributes of <code>orig</code>. If that is what you need, you have to use <a href="http://speakingjs.com/es5/ch17.html#property_attributes">property descriptors</a>.</p>

<p>If you want the clone to have the same prototype as the original, you can use <code>Object.getPrototypeOf()</code> and <code>Object.create()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">orig</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">origProto</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">getPrototypeOf</code><code class="p">(</code><code class="nx">orig</code><code class="p">);</code>
    <code class="k">return</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">(</code><code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">origProto</code><code class="p">),</code> <code class="nx">orig</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-objectgetownpropertysymbolsobj">
<span class="section-number">14.3.2 </span><code>Object.getOwnPropertySymbols(obj)</code>
</h4>

<p><code>Object.getOwnPropertySymbols(obj)</code> retrieves all own<sup id="fnref-oop_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-oop_1" rel="footnote">1</a></sup> symbol-valued property keys of <code>obj</code>. It complements <code>Object.getOwnPropertyNames()</code>, which retrieves all string-valued own property keys. Consult <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_iterating-property-keys">a later section</a> for more details on iterating over property keys.</p>

<h4 id="Object_is">
<span class="section-number">14.3.3 </span>Object.is(value1, value2)</h4>

<p>The strict equals operator (<code>===</code>) treats two values differently than one might expect.</p>

<p>First, <code>NaN</code> is not equal to itself.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">NaN</code> <code class="o">===</code> <code class="n">NaN</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>That is unfortunate, because it often prevents us from detecting <code>NaN</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="n">NaN</code><code class="p">,</code><code class="mi">2</code><code class="p">].</code><code class="n">indexOf</code><code class="p">(</code><code class="n">NaN</code><code class="p">)</code>
<code class="o">-</code><code class="mi">1</code>
</pre></div>

</div>

<p>Second, JavaScript has <a href="http://speakingjs.com/es5/ch11.html#two_zeros">two zeros</a>, but strict equals treats them as if they were the same value:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="o">-</code><code class="mi">0</code> <code class="o">===</code> <code class="o">+</code><code class="mi">0</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>Doing this is normally a good thing.</p>

<p><code>Object.is()</code> provides a way of comparing values that is a bit more precise than <code>===</code>. It works as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">is</code><code class="p">(</code><code class="n">NaN</code><code class="p">,</code> <code class="n">NaN</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">is</code><code class="p">(</code><code class="o">-</code><code class="mi">0</code><code class="p">,</code> <code class="o">+</code><code class="mi">0</code><code class="p">)</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>Everything else is compared as with <code>===</code>.</p>

<h5 id="leanpub-auto-using-objectis-to-find-array-elements">
<span class="section-number">14.3.3.1 </span>Using <code>Object.is()</code> to find Array elements</h5>

<p>If we combine <code>Object.is()</code> with the new ES6 Array method <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#Array_prototype_findIndex"><code>findIndex()</code></a>, we can find <code>NaN</code> in Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">myIndexOf</code><code class="p">(</code><code class="nx">arr</code><code class="p">,</code> <code class="nx">elem</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">findIndex</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">is</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">elem</code><code class="p">));</code>
<code class="p">}</code>

<code class="nx">myIndexOf</code><code class="p">([</code><code class="mi">0</code><code class="p">,</code><code class="kc">NaN</code><code class="p">,</code><code class="mi">2</code><code class="p">],</code> <code class="kc">NaN</code><code class="p">);</code> <code class="c1">// 1</code>
</pre></div>

</div>

<p>In contrast, <code>indexOf()</code> does not handle <code>NaN</code> well:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code><code class="n">NaN</code><code class="p">,</code><code class="mi">2</code><code class="p">].</code><code class="n">indexOf</code><code class="p">(</code><code class="n">NaN</code><code class="p">)</code>
<code class="o">-</code><code class="mi">1</code>
</pre></div>

</div>

<h4 id="leanpub-auto-objectsetprototypeofobj-proto">
<span class="section-number">14.3.4 </span><code>Object.setPrototypeOf(obj, proto)</code>
</h4>

<p>This method sets the prototype of <code>obj</code> to <code>proto</code>. The non-standard way of doing so in ECMAScript 5, that is supported by many engines, is via assigning to the special property <code>__proto__</code>. The recommended way of setting the prototype remains the same as in ECMAScript 5: during the creation of an object, via <code>Object.create()</code>. That will always be faster than first creating an object and then setting its prototype. Obviously, it doesn’t work if you want to change the prototype of an existing object.</p>

<h3 id="sec_iterating-property-keys">
<span class="section-number">14.4 </span>Iterating over property keys in ES6</h3>

<p>In ECMAScript 6, the key of a property can be either a string or a symbol. There are now five tool methods that retrieve the property keys of an object <code>obj</code>:</p>

<ul>
<li>
<code>Object.keys(obj) : Array&lt;string&gt;</code><br>
retrieves all string-valued keys of all enumerable own (non-inherited) properties.</li>
  <li>
<code>Object.getOwnPropertyNames(obj) : Array&lt;string&gt;</code><br>
retrieves all string-valued keys of all own properties.</li>
  <li>
<code>Object.getOwnPropertySymbols(obj) : Array&lt;symbol&gt;</code><br>
retrieves all symbol-valued keys of all own properties.</li>
  <li>
<code>Reflect.ownKeys(obj) : Array&lt;string|symbol&gt;</code><br>
retrieves all keys of all own properties.</li>
  <li>
<code>Reflect.enumerate(obj) : Iterator</code><br>
retrieves all string-valued keys of all enumerable properties.</li>
</ul>
<h4 id="sec_property-iteration-order">
<span class="section-number">14.4.1 </span>Iteration order of property keys</h4>

<p>All methods that iterate over property keys do so in the same order:</p>

<ul>
<li>First all Array indices, sorted numerically.</li>
  <li>Then all string keys (that are not indices), in the order in which they were created.</li>
  <li>Then all symbols, in the order in which they were created.</li>
</ul>
<p>Note that the language specification defines an index as a string key that, when converted to an unsigned integer and back, is still the same string (it must also be smaller than 2<sup>32</sup>−1, so that there is room for the length of an Array). That means that the spec views Array indices as string keys and that even normal objects can have Array indices:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Reflect</code><code class="p">.</code><code class="n">ownKeys</code><code class="p">({</code> <code class="p">[</code><code class="n">Symbol</code><code class="p">()]</code><code class="o">:</code><code class="mi">0</code><code class="p">,</code> <code class="n">b</code><code class="o">:</code><code class="mi">0</code><code class="p">,</code> <code class="mi">10</code><code class="o">:</code><code class="mi">0</code><code class="p">,</code> <code class="mi">2</code><code class="o">:</code><code class="mi">0</code><code class="p">,</code> <code class="n">a</code><code class="o">:</code><code class="mi">0</code> <code class="p">})</code>
<code class="p">[</code><code class="sc">'2'</code><code class="p">,</code> <code class="err">'</code><code class="mi">10</code><code class="err">'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">,</code> <code class="sc">'a'</code><code class="p">,</code> <code class="n">Symbol</code><code class="p">()]</code>
</pre></div>

</div>

<table class="question sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_question-circle.png" alt="question" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-why-does-the-spec-standardize-in-which-order-property-keys-are-returned">Why does the spec standardize in which order property keys are returned?</h3>

  <p>Answer by <a href="https://esdiscuss.org/topic/nailing-object-property-order">Tab Atkins Jr.</a>:</p>

  <p>Because, for objects at least, all implementations used approximately the same order (matching the current spec), and lots of code was inadvertently written that depended on that ordering, and would break if you enumerated it in a different order.  Since browsers have to implement this particular ordering to be web-compatible, it was specced as a requirement.</p>

  <p>There was some discussion about breaking from this in Maps/Sets, but doing so would require us to specify an order that is <em>impossible</em> for code to depend on; in other words, we’d have to mandate that the ordering be <em>random</em>, not just unspecified.  This was deemed too much effort, and creation-order is reasonable valuable (see OrderedDict in Python, for example), so it was decided to have Maps and Sets match Objects.</p>

    </td>
  </tr></tbody></table>
<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>Two parts of the spec are relevant for this section:</p>

  <ul>
<li>The section on <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-array-exotic-objects">Array exotic objects</a> has a note on what Array indices are.</li>
    <li>The section on <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-ordinary-object-internal-methods-and-internal-slots-ownpropertykeys">the internal method <code>[[OwnPropertyKeys]]</code></a> defines the order in which properties are returned.</li>
  </ul>
</td>
  </tr></tbody></table>
<h3 id="leanpub-auto-faq-object-literals">
<span class="section-number">14.5 </span>FAQ: object literals</h3>

<h4 id="leanpub-auto-can-i-use-super-in-object-literals">
<span class="section-number">14.5.1 </span>Can I use <code>super</code> in object literals?</h4>

<p>Yes you can! Details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#super-properties">the chapter on classes</a>.</p>

<div class="footnotes">
  <ol>
<li id="fn-oop_1">The <em>own</em> properties of an object are those that aren’t inherited via its prototype chain.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-oop_1" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h2 id="ch_classes">
<span class="section-number">15. </span>Classes</h2>

<p>This chapter explains how ES6 classes work.</p>


<h3 id="leanpub-auto-overview-9">
<span class="section-number">15.1 </span>Overview</h3>

<p>A class and a subclass:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="err">`</code><code class="p">(</code><code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">x</code><code class="p">},</code> <code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">y</code><code class="p">})</code><code class="err">`</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kr">class</code> <code class="nx">ColorPoint</code> <code class="kr">extends</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">);</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="kr">super</code><code class="p">.</code><code class="nx">toString</code><code class="p">()</code> <code class="o">+</code> <code class="s1">' in '</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="nx">color</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Under the hood, ES6 classes are not something that is radically new: They mainly provide more convenient syntax to create old-school constructor functions. You can see that if you use <code>typeof</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="k">typeof</code> <code class="nx">Point</code>
<code class="s1">'function'</code>
</pre></div>

</div>

<p>Using the classes:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">cp</code> <code class="o">=</code> <code class="n">new</code> <code class="n">ColorPoint</code><code class="p">(</code><code class="mi">25</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="err">'</code><code class="n">green</code><code class="err">'</code><code class="p">);</code>

<code class="o">&gt;</code> <code class="n">cp</code><code class="p">.</code><code class="n">toString</code><code class="p">();</code>
<code class="err">'</code><code class="p">(</code><code class="mi">25</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code> <code class="n">in</code> <code class="n">green</code><code class="err">'</code>

<code class="o">&gt;</code> <code class="n">cp</code> <code class="n">instanceof</code> <code class="n">ColorPoint</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">cp</code> <code class="n">instanceof</code> <code class="n">Point</code>
<code class="nb">true</code>
</pre></div>

</div>


<h3 id="leanpub-auto-the-essentials">
<span class="section-number">15.2 </span>The essentials</h3>

<h4 id="leanpub-auto-base-classes">
<span class="section-number">15.2.1 </span>Base classes</h4>

<p>A class is defined like this in ECMAScript 6 (ES6):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="err">`</code><code class="p">(</code><code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">x</code><code class="p">},</code> <code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">y</code><code class="p">})</code><code class="err">`</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>You use this class just like an ES5 constructor function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">p</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Point</code><code class="p">(</code><code class="mi">25</code><code class="p">,</code> <code class="mi">8</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">p</code><code class="p">.</code><code class="n">toString</code><code class="p">()</code>
<code class="err">'</code><code class="p">(</code><code class="mi">25</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code><code class="err">'</code>
</pre></div>

</div>

<p>In fact, the result of a class definition is a function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="k">typeof</code> <code class="nx">Point</code>
<code class="s1">'function'</code>
</pre></div>

</div>

<p>However, you can only invoke a class via <code>new</code>, not via a function call (the rationale behind this <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#cannot-function-call-classes">is explained later</a>):</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="nx">Point</code><code class="p">()</code>
<code class="nx">TypeError</code><code class="o">:</code> <code class="nx">Classes</code> <code class="nx">can</code><code class="err">’</code><code class="nx">t</code> <code class="nx">be</code> <code class="kd">function</code><code class="o">-</code><code class="nx">called</code>
</pre></div>

</div>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>In the spec, function-calling classes is prevented in <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-ecmascript-function-objects-call-thisargument-argumentslist">the internal method <code>[[Call]]</code></a> of function objects.</p>

    </td>
  </tr></tbody></table>
<h5 id="leanpub-auto-class-declarations-are-not-hoisted">
<span class="section-number">15.2.1.1 </span>Class declarations are not hoisted</h5>

<p>Function declarations are <em>hoisted</em>: When entering a scope, the functions that are declared in it are immediately available – independently of where the declarations happen. That means that you can call a function that is declared later:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">foo</code><code class="p">();</code> <code class="c1">// works, because `foo` is hoisted</code>

<code class="kd">function</code> <code class="nx">foo</code><code class="p">()</code> <code class="p">{}</code>
</pre></div>

</div>

<p>In contrast, class declarations are not hoisted. Therefore, a class only exists after execution reached its definition and it was evaluated. Accessing it beforehand leads to a <code>ReferenceError</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">new</code> <code class="nx">Foo</code><code class="p">();</code> <code class="c1">// ReferenceError</code>

<code class="kr">class</code> <code class="nx">Foo</code> <code class="p">{}</code>
</pre></div>

</div>

<p>The reason for this limitation is that classes can have an <code>extends</code> clause whose value is an arbitrary expression. That expression must be evaluated in the proper “location”, its evaluation can’t be hoisted.</p>

<p>Not having hoisting is less limiting than you may think. For example, a function that comes before a class declaration can still refer to that class, but you have to wait until the class declaration has been evaluated before you can call the function.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">functionThatUsesBar</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">new</code> <code class="nx">Bar</code><code class="p">();</code>
<code class="p">}</code>

<code class="nx">functionThatUsesBar</code><code class="p">();</code> <code class="c1">// ReferenceError</code>
<code class="kr">class</code> <code class="nx">Bar</code> <code class="p">{}</code>
<code class="nx">functionThatUsesBar</code><code class="p">();</code> <code class="c1">// OK</code>
</pre></div>

</div>

<h5 id="leanpub-auto-class-expressions">
<span class="section-number">15.2.1.2 </span>Class expressions</h5>

<p>Similarly to functions, there are two kinds of <em>class definitions</em>, two ways to define a class: <em>class declarations</em> and <em>class expressions</em>.</p>

<p>Also similarly to functions, the identifier of a class expression is only visible within the expression:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">MyClass</code> <code class="o">=</code> <code class="kr">class</code> <code class="nx">Me</code> <code class="p">{</code>
    <code class="nx">getClassName</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">Me</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
<code class="kd">let</code> <code class="nx">inst</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyClass</code><code class="p">();</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">inst</code><code class="p">.</code><code class="nx">getClassName</code><code class="p">());</code> <code class="c1">// Me</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">Me</code><code class="p">.</code><code class="nx">name</code><code class="p">);</code> <code class="c1">// ReferenceError: Me is not defined</code>
</pre></div>

</div>

<h4 id="leanpub-auto-inside-the-body-of-a-class-definition">
<span class="section-number">15.2.2 </span>Inside the body of a class definition</h4>

<p>A class body can only contain methods, but not data properties. Prototypes having data properties is generally considered an anti-pattern, so this just enforces a best practice.</p>

<h5 id="leanpub-auto-constructor-static-methods-prototype-methods">
<span class="section-number">15.2.2.1 </span><code>constructor</code>, static methods, prototype methods</h5>

<p>Let’s examine three kinds of methods that you often find in class definitions.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Foo</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">prop</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">prop</code> <code class="o">=</code> <code class="nx">prop</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="kr">static</code> <code class="nx">staticMethod</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'classy'</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">prototypeMethod</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'prototypical'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="kd">let</code> <code class="nx">foo</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Foo</code><code class="p">(</code><code class="mi">123</code><code class="p">);</code>
</pre></div>

</div>

<p>The object diagram for this class declaration looks as follows. Tip for understanding it: <code>[[Prototype]]</code> is an inheritance relationship between objects, while <code>prototype</code> is a normal property whose value is an object. The property <code>prototype</code> is only special because the <code>new</code> operator uses its value as the prototype for instances it creates.</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/classes----methods.jpg" alt=""><p class="caption"></p>
</div>

<p><strong>First, the pseudo-method <code>constructor</code>.</strong> This method is special, as it defines the function that represents the class:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="nx">Foo</code> <code class="o">===</code> <code class="nx">Foo</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">constructor</code>
<code class="kc">true</code>
<code class="o">&gt;</code> <code class="k">typeof</code> <code class="nx">Foo</code>
<code class="s1">'function'</code>
</pre></div>

</div>

<p>It is sometimes called a <code>class constructor</code>. It has features that normal constructor functions don’t have (mainly the ability to constructor-call its super-constructor via <code>super()</code>, which is explained later).</p>

<p><strong>Second, static methods.</strong> <em>Static properties</em> (or <em>class properties</em>) are properties of <code>Foo</code> itself. If you prefix a method definition with <code>static</code>, you create a class method:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="k">typeof</code> <code class="nx">Foo</code><code class="p">.</code><code class="nx">staticMethod</code>
<code class="s1">'function'</code>
<code class="o">&gt;</code> <code class="nx">Foo</code><code class="p">.</code><code class="nx">staticMethod</code><code class="p">()</code>
<code class="s1">'classy'</code>
</pre></div>

</div>

<p><strong>Third, prototype methods.</strong> The <em>prototype properties</em> of <code>Foo</code> are the properties of <code>Foo.prototype</code>. They are usually methods and inherited by instances of <code>Foo</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="k">typeof</code> <code class="nx">Foo</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">prototypeMethod</code>
<code class="s1">'function'</code>
<code class="o">&gt;</code> <code class="nx">foo</code><code class="p">.</code><code class="nx">prototypeMethod</code><code class="p">()</code>
<code class="s1">'prototypical'</code>
</pre></div>

</div>

<h5 id="leanpub-auto-static-data-properties">
<span class="section-number">15.2.2.2 </span>Static data properties</h5>

<p>For now, classes only let you create static methods, but not static data properties. There are two work-arounds for that.</p>

<p>First, you can manually add a static property:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="nx">Point</code><code class="p">.</code><code class="nx">ZERO</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Point</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
</pre></div>

</div>

<p>Second, you can create a static getter:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="kr">static</code> <code class="nx">get</code> <code class="nx">ZERO</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nx">Point</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In both cases, you get a property <code>Point.ZERO</code> that you can read. In the former case, you could use <code>Object.defineProperty()</code> to create a read-only property, but I like the simplicity of an assignment.</p>

<h5 id="leanpub-auto-getters-and-setters">
<span class="section-number">15.2.2.3 </span>Getters and setters</h5>

<p>The syntax for getters and setters is just like <a href="http://speakingjs.com/es5/ch17.html#getters_setters">in ECMAScript 5 object literals</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">MyClass</code> <code class="p">{</code>
    <code class="nx">get</code> <code class="nx">prop</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'getter'</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">set</code> <code class="nx">prop</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'setter: '</code><code class="o">+</code><code class="nx">value</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>You use <code>MyClass</code> as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">inst</code> <code class="o">=</code> <code class="n">new</code> <code class="n">MyClass</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">inst</code><code class="p">.</code><code class="n">prop</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
<code class="nl">setter:</code> <code class="mi">123</code>
<code class="o">&gt;</code> <code class="n">inst</code><code class="p">.</code><code class="n">prop</code>
<code class="err">'</code><code class="n">getter</code><code class="err">'</code>
</pre></div>

</div>

<h5 id="leanpub-auto-computed-method-names">
<span class="section-number">15.2.2.4 </span>Computed method names</h5>

<p>You can define the name of a method via an expression, if you put it in square brackets. For example, the following ways of defining <code>Foo</code> are all equivalent.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Foo</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">myMethod</code><code class="p">()</code> <code class="p">{}</code>
<code class="p">}</code>

<code class="kr">class</code> <code class="nx">Foo</code><code class="p">()</code> <code class="p">{</code>
    <code class="p">[</code><code class="s1">'my'</code><code class="o">+</code><code class="s1">'Method'</code><code class="p">]()</code> <code class="p">{}</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">m</code> <code class="o">=</code> <code class="s1">'myMethod'</code><code class="p">;</code>
<code class="kr">class</code> <code class="nx">Foo</code><code class="p">()</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">m</code><code class="p">]()</code> <code class="p">{}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Several special methods in ECMAScript 6 have keys that are symbols. Computed method names allow you to define such methods. For example, if an object has a method whose key is <code>Symbol.iterator</code>, it is <em>iterable</em>. That means that its contents can be iterated over by the <code>for-of</code> loop and other language mechanisms.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">IterableClass</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-generator-methods">
<span class="section-number">15.2.2.5 </span>Generator methods</h5>

<p>If you prefix a method definition with an asterisk (<code>*</code>), it becomes a <em>generator method</em>. Among other things, a generator is useful for defining the method whose key is <code>Symbol.iterator</code>. The following code demonstrates how that works.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">IterableArguments</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">args</code> <code class="o">=</code> <code class="nx">args</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="o">*</code> <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
        <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">arg</code> <code class="nx">of</code> <code class="k">this</code><code class="p">.</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">yield</code> <code class="nx">arg</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="k">new</code> <code class="nx">IterableArguments</code><code class="p">(</code><code class="s1">'hello'</code><code class="p">,</code> <code class="s1">'world'</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>

<code class="c1">// Output:</code>
<code class="c1">// hello</code>
<code class="c1">// world</code>
</pre></div>

</div>

<h4 id="leanpub-auto-subclassing">
<span class="section-number">15.2.3 </span>Subclassing</h4>

<p>The <code>extends</code> clause lets you create a subclass of an existing constructor (which may or may not have been defined via a class):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="err">`</code><code class="p">(</code><code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">x</code><code class="p">},</code> <code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">y</code><code class="p">})</code><code class="err">`</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kr">class</code> <code class="nx">ColorPoint</code> <code class="kr">extends</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">);</code> <code class="c1">// (A)</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="kr">super</code><code class="p">.</code><code class="nx">toString</code><code class="p">()</code> <code class="o">+</code> <code class="s1">' in '</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="nx">color</code><code class="p">;</code> <code class="c1">// (B)</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Again, this class is used like you’d expect:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">cp</code> <code class="o">=</code> <code class="n">new</code> <code class="n">ColorPoint</code><code class="p">(</code><code class="mi">25</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="err">'</code><code class="n">green</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">cp</code><code class="p">.</code><code class="n">toString</code><code class="p">()</code>
<code class="err">'</code><code class="p">(</code><code class="mi">25</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code> <code class="n">in</code> <code class="n">green</code><code class="err">'</code>

<code class="o">&gt;</code> <code class="n">cp</code> <code class="n">instanceof</code> <code class="n">ColorPoint</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">cp</code> <code class="n">instanceof</code> <code class="n">Point</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>There are two kinds of classes:</p>

<ul>
<li>
<code>Point</code> is a <em>base class</em>, because it doesn’t have an <code>extends</code> clause.</li>
  <li>
<code>ColorPoint</code> is a <em>derived class</em>.</li>
</ul>
<p>There are two ways of using <code>super</code>:</p>

<ul>
<li>A <em>class constructor</em> (the pseudo-method <code>constructor</code> in a class definition) uses it like a function call (<code>super(···)</code>), in order to make a super-constructor call (line A).</li>
  <li>Method definitions (in object literals or classes, with or without <code>static</code>) use it like property references (<code>super.prop</code>) or method calls (<code>super.method(···)</code>), in order to refer to super-properties (line B).</li>
</ul>
<h5 id="leanpub-auto-the-prototype-of-a-subclass-is-the-superclass">
<span class="section-number">15.2.3.1 </span>The prototype of a subclass is the superclass</h5>

<p>The prototype of a subclass is the superclass in ECMAScript 6:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">getPrototypeOf</code><code class="p">(</code><code class="n">ColorPoint</code><code class="p">)</code> <code class="o">===</code> <code class="n">Point</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>That means that static properties are inherited:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Foo</code> <code class="p">{</code>
    <code class="kr">static</code> <code class="nx">classMethod</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'hello'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kr">class</code> <code class="nx">Bar</code> <code class="kr">extends</code> <code class="nx">Foo</code> <code class="p">{</code>
<code class="p">}</code>
<code class="nx">Bar</code><code class="p">.</code><code class="nx">classMethod</code><code class="p">();</code> <code class="c1">// 'hello'</code>
</pre></div>

</div>

<p>You can even super-call static methods:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Foo</code> <code class="p">{</code>
    <code class="kr">static</code> <code class="nx">classMethod</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'hello'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kr">class</code> <code class="nx">Bar</code> <code class="kr">extends</code> <code class="nx">Foo</code> <code class="p">{</code>
    <code class="kr">static</code> <code class="nx">classMethod</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="kr">super</code><code class="p">.</code><code class="nx">classMethod</code><code class="p">()</code> <code class="o">+</code> <code class="s1">', too'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="nx">Bar</code><code class="p">.</code><code class="nx">classMethod</code><code class="p">();</code> <code class="c1">// 'hello, too'</code>
</pre></div>

</div>

<h5 id="leanpub-auto-super-constructor-calls">
<span class="section-number">15.2.3.2 </span>Super-constructor calls</h5>

<p>In a derived class, you must call <code>super()</code> before you can use <code>this</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Foo</code> <code class="p">{}</code>

<code class="kr">class</code> <code class="nx">Bar</code> <code class="kr">extends</code> <code class="nx">Foo</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">num</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="nx">num</code> <code class="o">*</code> <code class="mi">2</code><code class="p">;</code> <code class="c1">// OK</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">num</code> <code class="o">=</code> <code class="nx">num</code><code class="p">;</code> <code class="c1">// ReferenceError</code>
        <code class="kr">super</code><code class="p">();</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">num</code> <code class="o">=</code> <code class="nx">num</code><code class="p">;</code> <code class="c1">// OK</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Implicitly leaving a derived constructor without calling <code>super()</code> also causes an error:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Foo</code> <code class="p">{}</code>

<code class="kr">class</code> <code class="nx">Bar</code> <code class="kr">extends</code> <code class="nx">Foo</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kd">let</code> <code class="nx">bar</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Bar</code><code class="p">();</code> <code class="c1">// ReferenceError</code>
</pre></div>

</div>

<h5 id="leanpub-auto-overriding-the-result-of-a-constructor">
<span class="section-number">15.2.3.3 </span>Overriding the result of a constructor</h5>

<p>Just like in ES5, you can override the result of a constructor by explicitly returning an object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Foo</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="k">new</code> <code class="nx">Foo</code><code class="p">()</code> <code class="k">instanceof</code> <code class="nx">Foo</code><code class="p">);</code> <code class="c1">// false</code>
</pre></div>

</div>

<p>If you do so, it doesn’t matter whether <code>this</code> has been initialized or not. In other words: you don’t have to call <code>super()</code> in a derived constructor if you override the result in this manner.</p>

<h5 id="leanpub-auto-default-constructors-for-classes">
<span class="section-number">15.2.3.4 </span>Default constructors for classes</h5>

<p>If you don’t specify a <code>constructor</code> for a base class, the following definition is used:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">constructor</code><code class="p">()</code> <code class="p">{}</code>
</pre></div>

</div>

<p>For derived classes, the following default constructor is used:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">constructor</code><code class="p">(...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">super</code><code class="p">(...</code><code class="nx">args</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-subclassing-built-in-constructors">
<span class="section-number">15.2.3.5 </span>Subclassing built-in constructors</h5>

<p>In ECMAScript 6, you can finally subclass all built-in constructors (there are <a href="http://speakingjs.com/es5/ch28.html">work-arounds for ES5</a>, but these have significant limitations).</p>

<p>For example, you can now create your own exception classes (that will inherit the feature of having a stack trace in most engines):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">MyError</code> <code class="kr">extends</code> <code class="nb">Error</code> <code class="p">{</code>
<code class="p">}</code>
<code class="k">throw</code> <code class="k">new</code> <code class="nx">MyError</code><code class="p">(</code><code class="s1">'Something happened!'</code><code class="p">);</code>
</pre></div>

</div>

<p>You can also create subclasses of <code>Array</code> whose instances properly handle <code>length</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">MyArray</code> <code class="kr">extends</code> <code class="nb">Array</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">len</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">(</code><code class="nx">len</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Instances of of `MyArray` work like real Arrays:</code>
<code class="kd">let</code> <code class="nx">myArr</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyArray</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">myArr</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code> <code class="c1">// 0</code>
<code class="nx">myArr</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'foo'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">myArr</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code> <code class="c1">// 1</code>
</pre></div>

</div>

<p>Note that subclassing built-in constructors is something that engines have to support natively, you won’t get this feature via transpilers.</p>


<h3 id="leanpub-auto-the-details-of-classes">
<span class="section-number">15.3 </span>The details of classes</h3>

<p>What we have seen so far are the essentials of classes. You only need to read on if you are interested how things happen under the hood. Let’s start with the syntax of classes. The following is a slightly modified version of the syntax shown in <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-functions-and-classes">Sect. A.4 of the ECMAScript 6 specification</a>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">ClassDeclaration</code><code class="o">:</code>
    <code class="s2">"class"</code> <code class="nx">BindingIdentifier</code> <code class="nx">ClassTail</code>
<code class="nx">ClassExpression</code><code class="o">:</code>
    <code class="s2">"class"</code> <code class="nx">BindingIdentifier</code><code class="o">?</code> <code class="nx">ClassTail</code>

<code class="nx">ClassTail</code><code class="o">:</code>
    <code class="nx">ClassHeritage</code><code class="o">?</code> <code class="s2">"{"</code> <code class="nx">ClassBody</code><code class="o">?</code> <code class="s2">"}"</code>
<code class="nx">ClassHeritage</code><code class="o">:</code>
    <code class="s2">"extends"</code> <code class="nx">AssignmentExpression</code>
<code class="nx">ClassBody</code><code class="o">:</code>
    <code class="nx">ClassElement</code><code class="o">+</code>
<code class="nx">ClassElement</code><code class="o">:</code>
    <code class="nx">MethodDefinition</code>
    <code class="s2">"static"</code> <code class="nx">MethodDefinition</code>
    <code class="s2">";"</code>

<code class="nx">MethodDefinition</code><code class="o">:</code>
    <code class="nx">PropName</code> <code class="s2">"("</code> <code class="nx">FormalParams</code> <code class="s2">")"</code> <code class="s2">"{"</code> <code class="nx">FuncBody</code> <code class="s2">"}"</code>
    <code class="s2">"*"</code> <code class="nx">PropName</code> <code class="s2">"("</code> <code class="nx">FormalParams</code> <code class="s2">")"</code> <code class="s2">"{"</code> <code class="nx">GeneratorBody</code> <code class="s2">"}"</code>
    <code class="s2">"get"</code> <code class="nx">PropName</code> <code class="s2">"("</code> <code class="s2">")"</code> <code class="s2">"{"</code> <code class="nx">FuncBody</code> <code class="s2">"}"</code>
    <code class="s2">"set"</code> <code class="nx">PropName</code> <code class="s2">"("</code> <code class="nx">PropSetParams</code> <code class="s2">")"</code> <code class="s2">"{"</code> <code class="nx">FuncBody</code> <code class="s2">"}"</code>

<code class="nx">PropertyName</code><code class="o">:</code>
    <code class="nx">LiteralPropertyName</code>
    <code class="nx">ComputedPropertyName</code>
<code class="nx">LiteralPropertyName</code><code class="o">:</code>
    <code class="nx">IdentifierName</code>  <code class="cm">/* foo */</code>
    <code class="nx">StringLiteral</code>   <code class="cm">/* "foo" */</code>
    <code class="nx">NumericLiteral</code>  <code class="cm">/* 123.45, 0xFF */</code>
<code class="nx">ComputedPropertyName</code><code class="o">:</code>
    <code class="s2">"["</code> <code class="nx">Expression</code> <code class="s2">"]"</code>
</pre></div>

</div>

<p>Two observations:</p>

<ul>
<li>The value to be extended can be produced by an arbitrary expression. Which means that you’ll be able to write code such as the following:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">class</code> <code class="nx">Foo</code> <code class="kr">extends</code> <code class="nx">combine</code><code class="p">(</code><code class="nx">MyMixin</code><code class="p">,</code> <code class="nx">MySuperClass</code><code class="p">)</code> <code class="p">{}</code>
</pre></div>
    
</div>
  </li>
  <li>Semicolons are allowed between methods.</li>
</ul>
<h4 id="leanpub-auto-various-checks">
<span class="section-number">15.3.1 </span>Various checks</h4>

<ul>
<li>Error checks: the class name cannot be <code>eval</code> or <code>arguments</code>; duplicate class element names are not allowed; the name <code>constructor</code> can only be used for a normal method, not for a getter, a setter or a generator method.</li>
  <li>Classes can’t be function-called. They throw a <code>TypeException</code> if they are.</li>
  <li>Prototype methods cannot be used as constructors:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">class</code> <code class="nx">C</code> <code class="p">{</code>
      <code class="nx">m</code><code class="p">()</code> <code class="p">{}</code>
  <code class="p">}</code>
  <code class="k">new</code> <code class="nx">C</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">m</code><code class="p">();</code> <code class="c1">// TypeError</code>
</pre></div>
    
</div>
  </li>
</ul>
<h4 id="leanpub-auto-attributes-of-properties">
<span class="section-number">15.3.2 </span>Attributes of properties</h4>

<p>Class declarations create (mutable) let bindings. For a given class <code>Foo</code>:</p>

<ul>
<li>Static methods <code>Foo.*</code> are writable and configurable, but not enumerable. Making them writable allows for dynamic patching.</li>
  <li>A constructor and the object in its property <code>prototype</code> have an immutable link:
    <ul>
<li>
<code>Foo.prototype</code> is non-writeable, non-enumerable, non-configurable.</li>
      <li>
<code>Foo.prototype.constructor</code> is non-writeable, non-enumerable, non-configurable.</li>
    </ul>
</li>
  <li>Prototype methods <code>Foo.prototype.*</code> are writable and configurable, but not enumerable.</li>
</ul>
<p>Note that method definitions in object literals produce enumerable properties.</p>


<h3 id="leanpub-auto-the-details-of-subclassing">
<span class="section-number">15.4 </span>The details of subclassing</h3>

<p>In ECMAScript 6, subclassing looks as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="err">···</code>
<code class="p">}</code>

<code class="kr">class</code> <code class="nx">ColorPoint</code> <code class="kr">extends</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">);</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="err">···</code>
<code class="p">}</code>

<code class="kd">let</code> <code class="nx">cp</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ColorPoint</code><code class="p">(</code><code class="mi">25</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="s1">'green'</code><code class="p">);</code>
</pre></div>

</div>

<p>This code produces the following objects.</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/classes----subclassing_es6.jpg" alt=""><p class="caption"></p>
</div>

<p>The next subsection examines the prototype chains (in the two columns), the subsection after that examines how <code>cp</code> is allocated and initialized.</p>

<h4 id="leanpub-auto-prototype-chains">
<span class="section-number">15.4.1 </span>Prototype chains</h4>

<p>In the diagram, you can see that there are two <em>prototype chains</em> (objects linked via the <code>[[Prototype]]</code> relationship, which is an inheritance relationship):</p>

<ul>
<li>Left column: classes (functions). The prototype of a derived class is the class it extends. The prototype of a base class is <code>Function.prototype</code>, which is also the prototype of functions:
    <div class="code-block">
<div class="highlight"><pre>  <code class="o">&gt;</code> <code class="kr">const</code> <code class="nx">getProto</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">getPrototypeOf</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nb">Object</code><code class="p">);</code>

  <code class="o">&gt;</code> <code class="nx">getProto</code><code class="p">(</code><code class="nx">Point</code><code class="p">)</code> <code class="o">===</code> <code class="nb">Function</code><code class="p">.</code><code class="nx">prototype</code>
  <code class="kc">true</code>
  <code class="o">&gt;</code> <code class="nx">getProto</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{})</code> <code class="o">===</code> <code class="nb">Function</code><code class="p">.</code><code class="nx">prototype</code>
  <code class="kc">true</code>
</pre></div>
    
</div>
  </li>
  <li>Right column: the prototype chain of the instance. The whole purpose of a class is to set up this prototype chain. The prototype chain ends with <code>Object.prototype</code> (whose prototype is <code>null</code>), which is also the prototype of objects created via object literals:
    <div class="code-block">
<div class="highlight"><pre>  <code class="o">&gt;</code> <code class="k">const</code> <code class="n">getProto</code> <code class="o">=</code> <code class="n">Object</code><code class="p">.</code><code class="n">getPrototypeOf</code><code class="p">.</code><code class="n">bind</code><code class="p">(</code><code class="n">Object</code><code class="p">);</code>

  <code class="o">&gt;</code> <code class="n">getProto</code><code class="p">(</code><code class="n">Point</code><code class="p">.</code><code class="n">prototype</code><code class="p">)</code> <code class="o">===</code> <code class="n">Object</code><code class="p">.</code><code class="n">prototype</code>
  <code class="nb">true</code>
  <code class="o">&gt;</code> <code class="n">getProto</code><code class="p">({})</code> <code class="o">===</code> <code class="n">Object</code><code class="p">.</code><code class="n">prototype</code>
  <code class="nb">true</code>
</pre></div>
    
</div>
  </li>
</ul>
<p>The prototype chain in the left column leads to static properties being inherited.</p>

<h4 id="sec_allocating-and-initializing-instances">
<span class="section-number">15.4.2 </span>Allocating and initializing instances</h4>

<p>The data flow between class constructors is different from the canonical way of subclassing in ES5. Under the hood, it roughly looks as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Instance is allocated here</code>
<code class="kd">function</code> <code class="nx">Point</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Performed before entering this constructor:</code>
    <code class="k">this</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="k">new</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">prototype</code><code class="p">);</code>

    <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
<code class="p">}</code>
<code class="err">···</code>

<code class="kd">function</code> <code class="nx">ColorPoint</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Performed before entering this constructor:</code>
    <code class="k">this</code> <code class="o">=</code> <code class="nx">uninitialized</code><code class="p">;</code>

    <code class="k">this</code> <code class="o">=</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">construct</code><code class="p">(</code><code class="nx">Point</code><code class="p">,</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">],</code> <code class="k">new</code><code class="p">.</code><code class="nx">target</code><code class="p">);</code> <code class="c1">// (A)</code>
        <code class="c1">// super(x, y);</code>

    <code class="k">this</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">;</code>
<code class="p">}</code>
<code class="nb">Object</code><code class="p">.</code><code class="nx">setPrototypeOf</code><code class="p">(</code><code class="nx">ColorPoint</code><code class="p">,</code> <code class="nx">Point</code><code class="p">);</code>
<code class="err">···</code>

<code class="kd">let</code> <code class="nx">cp</code> <code class="o">=</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">construct</code><code class="p">(</code> <code class="c1">// (B)</code>
             <code class="nx">ColorPoint</code><code class="p">,</code> <code class="p">[</code><code class="mi">25</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="s1">'green'</code><code class="p">],</code>
             <code class="nx">ColorPoint</code><code class="p">);</code>
    <code class="c1">// let cp = new ColorPoint(25, 8, 'green');</code>
</pre></div>

</div>

<p>The instance object is created in different locations in ES6 and ES5:</p>

<ul>
<li>In ES6, it is created in the base constructor, the last in a chain of constructor calls.</li>
  <li>In ES5, it is created in the operand of <code>new</code>, the first in a chain of constructor calls.</li>
</ul>
<p>The previous code uses two new ES6 features:</p>

<ul>
<li>
<code>new.target</code> is an implicit parameter that all functions have. It is to constructor calls what <code>this</code> is to method calls.
    <ul>
<li>If a constructor has been directly invoked via <code>new</code>, its value is that constructor (line B).</li>
      <li>If a constructor was called via <code>super()</code>, its value is the <code>new.target</code> of the constructor that made the call (line A).</li>
      <li>During a normal function call, it is <code>undefined</code>. That means that you can use <code>new.target</code> to determine whether a function was function-called or constructor-called (via <code>new</code>).</li>
      <li>Inside an arrow function, <code>new.target</code> refers to the <code>new.target</code> of the surrounding non-arrow function.</li>
    </ul>
</li>
  <li>
<code>Reflect.construct()</code> lets you do a constructor call while specifying <code>new.target</code> via the last parameter.</li>
</ul>
<p>The advantage of this way of subclassing is that it enables normal code to subclass built-in constructors (such as <code>Error</code> and <code>Array</code>). A later section explains why a different approach was necessary.</p>

<h5 id="leanpub-auto-safety-checks">
<span class="section-number">15.4.2.1 </span>Safety checks</h5>

<ul>
<li>
<code>this</code> originally being uninitialized in derived constructors means that an error is thrown if they access <code>this</code> in any way before they have called <code>super()</code>.</li>
  <li>Once <code>this</code> is initialized, calling <code>super()</code> produces a <code>ReferenceError</code>. This protects you against calling <code>super()</code> twice.</li>
  <li>If a constructor returns implicitly (without a <code>return</code> statement), the result is <code>this</code>. If <code>this</code> is uninitialized, a <code>ReferenceError</code> is thrown. This protects you against forgetting to call <code>super()</code>.</li>
  <li>If a constructor explicitly returns a non-object (including <code>undefined</code> and <code>null</code>), the result is <code>this</code> (this behavior is required to remain compatible with ES5 and earlier). If <code>this</code> is uninitialized, a <code>TypeError</code> is thrown.</li>
  <li>If a constructor explicitly returns an object, it is used as its result. Then it doesn’t matter whether <code>this</code> is initialized or not.</li>
</ul>
<h5 id="leanpub-auto-the-extends-clause">
<span class="section-number">15.4.2.2 </span>The <code>extends</code> clause</h5>

<p>Let’s examine how the <code>extends</code> clause influences how a class is set up (<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-runtime-semantics-classdefinitionevaluation">Sect. 14.5.14 of the spec</a>).</p>

<p>The value of an <code>extends</code> clause must be “constructible” (invocable via <code>new</code>). <code>null</code> is allowed, though.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">C</code> <code class="p">{</code>
<code class="p">}</code>
</pre></div>

</div>

<ul>
<li>Constructor kind: base</li>
  <li>Prototype of <code>C</code>: <code>Function.prototype</code> (like a normal function)</li>
  <li>Prototype of <code>C.prototype</code>: <code>Object.prototype</code> (which is also the prototype of objects created via object literals)</li>
</ul>
<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">C</code> <code class="kr">extends</code> <code class="nx">B</code> <code class="p">{</code>
<code class="p">}</code>
</pre></div>

</div>

<ul>
<li>Constructor kind: derived</li>
  <li>Prototype of <code>C</code>: <code>B</code>
</li>
  <li>Prototype of <code>C.prototype</code>: <code>B.prototype</code>
</li>
</ul>
<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">C</code> <code class="kr">extends</code> <code class="nb">Object</code> <code class="p">{</code>
<code class="p">}</code>
</pre></div>

</div>

<ul>
<li>Constructor kind: derived</li>
  <li>Prototype of <code>C</code>: <code>Object</code>
</li>
  <li>Prototype of <code>C.prototype</code>: <code>Object.prototype</code>
</li>
</ul>
<p>Note the following subtle difference with the first case: If there is no <code>extends</code> clause, the class is a base class and allocates instances. If a class extends <code>Object</code>, it is a derived class and <code>Object</code> allocates the instances. The resulting instances (including their prototype chains) are the same, but you get there differently.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">C</code> <code class="kr">extends</code> <code class="kc">null</code> <code class="p">{</code>
<code class="p">}</code>
</pre></div>

</div>

<ul>
<li>Constructor kind: derived</li>
  <li>Prototype of <code>C</code>: <code>Function.prototype</code>
</li>
  <li>Prototype of <code>C.prototype</code>: <code>null</code>
</li>
</ul>
<p>Such a class lets you avoid <code>Object.prototype</code> in the prototype chain. But that is rarely useful. Furthermore, you have to be careful: <code>new</code>-calling such a class leads to an error, because the default constructor makes a super-constructor call and <code>Function.prototype</code> (the super-constructor) can’t be constructor-called. The only way to make the error go away is by adding a <code>constructor</code> that returns an object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">C</code> <code class="kr">extends</code> <code class="kc">null</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">_this</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="k">new</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">prototype</code><code class="p">);</code>
        <code class="k">return</code> <code class="nx">_this</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>new.target</code> ensures that <code>C</code> can be subclassed properly – the prototype of <code>_this</code> will always be the operand of <code>new</code>.</p>

<h4 id="leanpub-auto-why-cant-you-subclass-built-in-constructors-in-es5">
<span class="section-number">15.4.3 </span>Why can’t you subclass built-in constructors in ES5?</h4>

<p>In ECMAScript 5, most built-in constructors can’t be subclassed (<a href="http://speakingjs.com/es5/ch28.html">several work-arounds exist</a>).</p>

<p>To understand why, let’s use the canonical ES5 pattern to subclass <code>Array</code>. As we shall soon find out, this doesn’t work.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">MyArray</code><code class="p">(</code><code class="nx">len</code><code class="p">)</code> <code class="p">{</code>
    <code class="nb">Array</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">len</code><code class="p">);</code> <code class="c1">// (A)</code>
<code class="p">}</code>
<code class="nx">MyArray</code><code class="p">.</code><code class="nx">prototype</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nb">Array</code><code class="p">.</code><code class="nx">prototype</code><code class="p">);</code>
</pre></div>

</div>

<p>Unfortunately, if we instantiate <code>MyArray</code>, we find out that it doesn’t work properly: The instance property <code>length</code> does not change in reaction to us adding Array elements:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">myArr</code> <code class="o">=</code> <code class="n">new</code> <code class="n">MyArray</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">myArr</code><code class="p">.</code><code class="n">length</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="n">myArr</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">=</code> <code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">;</code>
<code class="o">&gt;</code> <code class="n">myArr</code><code class="p">.</code><code class="n">length</code>
<code class="mi">0</code>
</pre></div>

</div>

<p>There are two obstracles that prevent <code>myArr</code> from being a proper Array.</p>

<p><strong>First obstacle: initialization.</strong> The <code>this</code> you hand to the constructor <code>Array</code> (in line A) is completely ignored. That means you can’t use <code>Array</code> to set up the instance that was created for <code>MyArray</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">var</code> <code class="n">a</code> <code class="o">=</code> <code class="p">[];</code>
<code class="o">&gt;</code> <code class="n">var</code> <code class="n">b</code> <code class="o">=</code> <code class="n">Array</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a</code><code class="p">,</code> <code class="mi">3</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">a</code> <code class="o">!==</code> <code class="n">b</code>  <code class="c1">// a is ignored, b is a new object</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">b</code><code class="p">.</code><code class="n">length</code> <code class="c1">// set up correctly</code>
<code class="mi">3</code>
<code class="o">&gt;</code> <code class="n">a</code><code class="p">.</code><code class="n">length</code> <code class="c1">// unchanged</code>
<code class="mi">0</code>
</pre></div>

</div>

<p><strong>Second obstacle: allocation.</strong> The instance objects created by <code>Array</code> are <em>exotic</em> (a term used by the ECMAScript specification for objects that have features that normal objects don’t have): Their property <code>length</code> tracks and influences the management of Array elements. In general, exotic objects can be created from scratch, but you can’t convert an existing normal object into an exotic one. Unfortunately, that is what <code>Array</code> would have to do, when called in line A: It would have to turn the normal object created for <code>MyArray</code> into an exotic Array object.</p>

<h5 id="leanpub-auto-the-solution-es6-subclassing">
<span class="section-number">15.4.3.1 </span>The solution: ES6 subclassing</h5>

<p>In ECMAScript 6, subclassing <code>Array</code> looks as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">MyArray</code> <code class="kr">extends</code> <code class="nb">Array</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">len</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">(</code><code class="nx">len</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This works (but it’s not something that ES6 transpilers can support, it depends on whether a JavaScript engine supports it natively):</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">myArr</code> <code class="o">=</code> <code class="n">new</code> <code class="n">MyArray</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">myArr</code><code class="p">.</code><code class="n">length</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="n">myArr</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">=</code> <code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">;</code>
<code class="o">&gt;</code> <code class="n">myArr</code><code class="p">.</code><code class="n">length</code>
<code class="mi">1</code>
</pre></div>

</div>

<p>We can now see how the ES6 approach to subclassing circumvents the obstacles:</p>

<ul>
<li>Allocation happens in the base constructor, which means that <code>Array</code> can allocate an exotic object. While most of the new approach is due to how derived constructors behave, this step requires that a base constructor is aware of <code>new.target</code> and makes <code>new.target.prototype</code> the protoype of the allocated instance.</li>
  <li>Initialization also happens in the base constructor, a derived constructor receives an initialized object and works with that one instead of passing its own instance to the super-constructor and requiring it to set it up.</li>
</ul>
<h4 id="super-properties">
<span class="section-number">15.4.4 </span>Referring to super-properties in methods</h4>

<p>The following ES6 code makes a super-method call in line B.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code> <code class="c1">// (A)</code>
        <code class="k">return</code> <code class="err">`</code><code class="p">(</code><code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">x</code><code class="p">},</code> <code class="nx">$</code><code class="p">{</code><code class="k">this</code><code class="p">.</code><code class="nx">y</code><code class="p">})</code><code class="err">`</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kr">class</code> <code class="nx">ColorPoint</code> <code class="kr">extends</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">);</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="kr">super</code><code class="p">.</code><code class="nx">toString</code><code class="p">()</code> <code class="c1">// (B)</code>
               <code class="o">+</code> <code class="s1">' in '</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="nx">color</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kd">let</code> <code class="nx">cp</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ColorPoint</code><code class="p">(</code><code class="mi">25</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="s1">'green'</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">cp</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code> <code class="c1">// (25, 8) in green</code>
</pre></div>

</div>

<p>To understand how super-calls work, let’s look at the object diagram of <code>cp</code>:</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/classes----supercalls.jpg" alt=""><p class="caption"></p>
</div>

<p><code>ColorPoint.prototype.toString</code> makes a super-call (line B) to the method (starting in line A) that it has overridden. Let’s call the object, in which a method is stored, the <em>home object</em> of that method. For example, <code>ColorPoint.prototype</code> is the home object of <code>ColorPoint.prototype.toString()</code>.</p>

<p>The super-call in line B involves three steps:</p>

<ol class="numeric numeric">
<li>Start your search in the prototype of the home object of the current method.</li>
  <li>Look for a method whose name is <code>toString</code>. That method may be found in the object where the search started or later in the prototype chain.</li>
  <li>Call that method with the current <code>this</code>. The reason for doing so is: the super-called method must be able to access the same instance properties (in our example, the properties of <code>cp</code>).</li>
</ol>
<p>Note that even if you are only getting or setting a property (not calling a method), you still have to consider <code>this</code> in step #3, because the property may be implemented via a getter or a setter.</p>

<p>Let’s express these steps in three different, but equivalent, ways:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Variation 1: super-method calls in ES5</code>
<code class="kd">var</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">Point</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">toString</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="k">this</code><code class="p">)</code> <code class="c1">// steps 1,2,3</code>

<code class="c1">// Variation 2: ES5, refactored</code>
<code class="kd">var</code> <code class="nx">superObject</code> <code class="o">=</code> <code class="nx">Point</code><code class="p">.</code><code class="nx">prototype</code><code class="p">;</code> <code class="c1">// step 1</code>
<code class="kd">var</code> <code class="nx">superMethod</code> <code class="o">=</code> <code class="nx">superObject</code><code class="p">.</code><code class="nx">toString</code><code class="p">;</code> <code class="c1">// step 2</code>
<code class="kd">var</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">superMethod</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="k">this</code><code class="p">)</code> <code class="c1">// step 3</code>

<code class="c1">// Variation 3: ES6</code>
<code class="kd">var</code> <code class="nx">homeObject</code> <code class="o">=</code> <code class="nx">ColorPoint</code><code class="p">.</code><code class="nx">prototype</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">superObject</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">getPrototypeOf</code><code class="p">(</code><code class="nx">homeObject</code><code class="p">);</code> <code class="c1">// step 1</code>
<code class="kd">var</code> <code class="nx">superMethod</code> <code class="o">=</code> <code class="nx">superObject</code><code class="p">.</code><code class="nx">toString</code><code class="p">;</code> <code class="c1">// step 2</code>
<code class="kd">var</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">superMethod</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="k">this</code><code class="p">)</code> <code class="c1">// step 3</code>
</pre></div>

</div>

<p>Variation 3 is how ECMAScript 6 handles super-calls. This approach is supported by <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-function-environment-records">two internal <em>bindings</em></a> that the <em>environments</em> of functions have (<em>environments</em> provide storage space, so-called <em>bindings</em>, for the variables in a scope):</p>

<ul>
<li>
<code>[[thisValue]]</code>: This internal binding also exists in ECMAScript 5 and stores the value of <code>this</code>.</li>
  <li>
<code>[[HomeObject]]</code>: Refers to the home object of the environment’s function. Filled in via an internal property <code>[[HomeObject]]</code> that all methods have that use <code>super</code>. Both the binding and the property are new in ECMAScript 6.</li>
</ul>
<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-methods-are-a-special-kind-of-function-now">Methods are a special kind of function now</h3>

  <p>In a class, a method definition that uses <code>super</code> creates a special kind of function: It is still a function, but it has the internal property <code>[[HomeObject]]</code>. That property is set up by the method definition and can’t be changed in JavaScript. Therefore, you can’t meaningfully move such a method to a different object. (But maybe it’ll be possible in a future version of ECMAScript.)</p>

    </td>
  </tr></tbody></table>
<h5 id="leanpub-auto-where-can-you-use-super">
<span class="section-number">15.4.4.1 </span>Where can you use <code>super</code>?</h5>

<p>Referring to super-properties is handy whenever prototype chains are involved, which is why you can use it in method definitions inside object literals and class definitions (the class can be derived or not, the method can be static or not).</p>

<p>Using <code>super</code> to refer to a property is not allowed in function declarations, function expressions and generator functions.</p>

<h5 id="sec_cant-move-methods-with-super">
<span class="section-number">15.4.4.2 </span>A method that uses <code>super</code> can’t be moved</h5>

<p>You can’t move a method that uses <code>super</code>: Such a method has an internal property <code>[[HomeObject]]</code> that ties it to the object it was created in. If you move it via via an assignment, it will continue to refer to the super-properties of the original object. In future ECMAScript versions, there may be a way to transfer such a method, too.</p>


<h3 id="sec_species-pattern">
<span class="section-number">15.5 </span>The species pattern</h3>

<p>One more mechanism of built-in constructors has been made extensible in ECMAScript 6: If a method such as <code>Array.prototype.map()</code> returns a fresh instance, what constructor should it use to create that instance?</p>

<p>Helper functions used in the following three sections:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">isObject</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">(</code><code class="nx">value</code> <code class="o">!==</code> <code class="kc">null</code>
       <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">value</code> <code class="o">===</code> <code class="s1">'object'</code>
           <code class="o">||</code> <code class="k">typeof</code> <code class="nx">value</code> <code class="o">===</code> <code class="s1">'function'</code><code class="p">));</code>
<code class="p">}</code>

<code class="cm">/**</code>
<code class="cm"> * Spec-internal operation that determines whether `x` can be used as a construc\</code>
<code class="cm">tor.</code>
<code class="cm"> */</code>
<code class="kd">function</code> <code class="nx">isConstructor</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-the-standard-species-pattern">
<span class="section-number">15.5.1 </span>The standard species pattern</h4>

<p>The pattern for customizing instances created by methods such as <code>Array.prototype.map()</code> is called the <em>species pattern</em>:</p>

<ul>
<li>If <code>this.constructor[Symbol.species]</code> exists, use use it as a constructor for the new instance.</li>
  <li>Otherwise, use a default constructor (e.g. <code>Array</code> for Arrays.</li>
</ul>
<p>Implemented in JavaScript, this pattern would look like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">SpeciesConstructor</code><code class="p">(</code><code class="nx">O</code><code class="p">,</code> <code class="nx">defaultConstructor</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">C</code> <code class="o">=</code> <code class="nx">O</code><code class="p">.</code><code class="nx">constructor</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">C</code> <code class="o">===</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">defaultConstructor</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code> <code class="nx">isObject</code><code class="p">(</code><code class="nx">C</code><code class="p">))</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">();</code>
    <code class="p">}</code>
    <code class="kd">let</code> <code class="nx">S</code> <code class="o">=</code> <code class="nx">C</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">species</code><code class="p">];</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">S</code> <code class="o">===</code> <code class="kc">undefined</code> <code class="o">||</code> <code class="nx">S</code> <code class="o">===</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">defaultConstructor</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code> <code class="nx">isConstructor</code><code class="p">(</code><code class="nx">S</code><code class="p">))</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">();</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">S</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>The standard species pattern for Arrays is implemented in the spec via the operation <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-speciesconstructor"><code>SpeciesConstructor()</code></a>.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-the-species-pattern-for-arrays">
<span class="section-number">15.5.2 </span>The species pattern for Arrays</h4>

<p>This is an approximation of how the species pattern is used for Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">ArraySpeciesCreate</code><code class="p">(</code><code class="nx">originalArray</code><code class="p">,</code> <code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">C</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="nb">Array</code><code class="p">.</code><code class="nx">isArray</code><code class="p">(</code><code class="nx">originalArray</code><code class="p">))</code> <code class="p">{</code>
        <code class="nx">C</code> <code class="o">=</code> <code class="nx">originalArray</code><code class="p">.</code><code class="nx">constructor</code><code class="p">;</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">isObject</code><code class="p">(</code><code class="nx">C</code><code class="p">))</code> <code class="p">{</code>
            <code class="nx">C</code> <code class="o">=</code> <code class="nx">C</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">species</code><code class="p">];</code>
        <code class="p">}</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">C</code> <code class="o">===</code> <code class="kc">undefined</code> <code class="o">||</code> <code class="nx">C</code> <code class="o">===</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nb">Array</code><code class="p">(</code><code class="nx">length</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code> <code class="nx">IsConstructor</code><code class="p">(</code><code class="nx">C</code><code class="p">))</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">();</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">C</code><code class="p">(</code><code class="nx">length</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>Array.prototype.map()</code> creates the Array it returns via <code>ArraySpeciesCreate(this, this.length)</code>.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>The species pattern for Arrays is implemented in the spec via the operation <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-arrayspeciescreate"><code>ArraySpeciesCreate()</code></a>.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-the-species-pattern-in-static-methods">
<span class="section-number">15.5.3 </span>The species pattern in static methods</h4>

<p>Promises use a variant of the species pattern for static methods such as <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-promise.all"><code>Promise.all()</code></a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">C</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code> <code class="c1">// default</code>
<code class="k">if</code> <code class="p">(</code><code class="o">!</code> <code class="nx">isObject</code><code class="p">(</code><code class="nx">C</code><code class="p">))</code> <code class="p">{</code>
    <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">();</code>
<code class="p">}</code>
<code class="c1">// The default can be overridden via the property `C[Symbol.species]`</code>
<code class="kd">let</code> <code class="nx">S</code> <code class="o">=</code> <code class="nx">C</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">species</code><code class="p">];</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">S</code> <code class="o">!==</code> <code class="kc">undefined</code> <code class="o">&amp;&amp;</code> <code class="nx">S</code> <code class="o">!==</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">C</code> <code class="o">=</code> <code class="nx">S</code><code class="p">;</code>
<code class="p">}</code>
<code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">IsConstructor</code><code class="p">(</code><code class="nx">C</code><code class="p">))</code> <code class="p">{</code>
    <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">();</code>
<code class="p">}</code>
<code class="kd">let</code> <code class="nx">instance</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">C</code><code class="p">(</code><code class="err">···</code><code class="p">);</code>
</pre></div>

</div>

<h4 id="leanpub-auto-overriding-the-default-species-in-subclasses">
<span class="section-number">15.5.4 </span>Overriding the default species in subclasses</h4>

<p>This is the default getter for the property <code>[Symbol.species]</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">get</code> <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">species</code><code class="p">]()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This default getter is implemented by the built-in classes <code>Array</code>, <code>ArrayBuffer</code>, <code>Map</code>, <code>Promise</code>, <code>RegExp</code>, <code>Set</code> and <code>%TypedArray%</code>. It is automatically inherited by subclasses of these built-in classes.</p>

<p>There are two ways in which you can override the default species: with a constructor of your choosing or with <code>null</code>.</p>

<h5 id="leanpub-auto-setting-the-species-to-a-constructor-of-your-choosing">
<span class="section-number">15.5.4.1 </span>Setting the species to a constructor of your choosing</h5>

<p>You can override the default species via a static getter (line A):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">MyArray1</code> <code class="kr">extends</code> <code class="nb">Array</code> <code class="p">{</code>
    <code class="kr">static</code> <code class="nx">get</code> <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">species</code><code class="p">]()</code> <code class="p">{</code> <code class="c1">// (A)</code>
        <code class="k">return</code> <code class="nb">Array</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>As a result, <code>map()</code> returns an instance of <code>Array</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">result1</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyArray1</code><code class="p">().</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result1</code> <code class="k">instanceof</code> <code class="nb">Array</code><code class="p">);</code> <code class="c1">// true</code>
</pre></div>

</div>

<p>If you don’t override the default species, <code>map()</code> returns an instance of the subclass:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">MyArray2</code> <code class="kr">extends</code> <code class="nb">Array</code> <code class="p">{</code> <code class="p">}</code>

<code class="kd">let</code> <code class="nx">result2</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyArray2</code><code class="p">().</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result2</code> <code class="k">instanceof</code> <code class="nx">MyArray2</code><code class="p">);</code> <code class="c1">// true</code>
</pre></div>

</div>

<h5 id="leanpub-auto-specifying-the-species-via-a-data-property">
<span class="section-number">15.5.4.2 </span>Specifying the species via a data property</h5>

<p>If you don’t want to use a static getter, you need to use <code>Object.defineProperty()</code>. You can’t use assignment, as that would trigger a setter, which doesn’t exist (there is only a getter).</p>

<p>For example, here we set the species of <code>MyArray1</code> to <code>Array</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nb">Object</code><code class="p">.</code><code class="nx">defineProperty</code><code class="p">(</code>
    <code class="nx">MyArray1</code><code class="p">,</code> <code class="nx">Symbol</code><code class="p">.</code><code class="nx">species</code><code class="p">,</code> <code class="p">{</code>
        <code class="nx">value</code><code class="o">:</code> <code class="nb">Array</code>
    <code class="p">});</code>
</pre></div>

</div>

<h5 id="leanpub-auto-setting-the-species-to-null">
<span class="section-number">15.5.4.3 </span>Setting the species to <code>null</code>
</h5>

<p>If you set the species to <code>null</code> then the default constructor is used (which one that is depends on which variant of the species pattern is used, consult the previous sections for more information).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">MyArray3</code> <code class="kr">extends</code> <code class="nb">Array</code> <code class="p">{</code>
    <code class="kr">static</code> <code class="nx">get</code> <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">species</code><code class="p">]()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="kc">null</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kd">let</code> <code class="nx">result3</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyArray3</code><code class="p">().</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result3</code> <code class="k">instanceof</code> <code class="nb">Array</code><code class="p">);</code> <code class="c1">// true</code>
</pre></div>

</div>


<h3 id="leanpub-auto-faq-classes">
<span class="section-number">15.6 </span>FAQ: classes</h3>

<h4 id="cannot-function-call-classes">
<span class="section-number">15.6.1 </span>Why can’t classes be function-called?</h4>

<p>Function-calling classes is currently forbidden. That was done to keep options open for the future, to eventually add a way to handle function calls via classes. One possibility is to do so via a special method (e.g. <code>[Symbol.functionCall]</code>).</p>

<h4 id="leanpub-auto-how-do-instantiate-a-class-given-an-array-of-arguments">
<span class="section-number">15.6.2 </span>How do instantiate a class, given an Array of arguments?</h4>

<p>What is the analog of <code>Function.prototype.apply()</code> for classes? That is, if I have a class <code>TheClass</code> and an Array <code>args</code> of arguments, how do I instantiate <code>TheClass</code>?</p>

<p>One way of doing so is via the spread operator (<code>...</code>):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">instantiate</code><code class="p">(</code><code class="nx">TheClass</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">TheClass</code><code class="p">(...</code><code class="nx">args</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Another option is to use <code>Reflect.construct()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">instantiate</code><code class="p">(</code><code class="nx">TheClass</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">construct</code><code class="p">(</code><code class="nx">TheClass</code><code class="p">,</code> <code class="nx">args</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="sec_private-data-for-classes">
<span class="section-number">15.6.3 </span>How do I manage private data for classes?</h4>

<p>Two ES5 ways<sup id="fnref-classes_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-classes_1" rel="footnote">1</a></sup> of keeping data private work for classes, too:</p>

<ol class="numeric numeric">
<li>You can keep private data in the environment of a class <code>constructor</code>. I have always disliked how this forces you to add privileged methods to instances.</li>
  <li>You can use a naming convention (e.g. a prefixed underscore) to mark private properties. I like this approach. It doesn’t give you complete protection and slightly clutters up the property namespace, but it leads to simple code.</li>
</ol>
<p>In ECMAScript 6, you can additionally use WeakMaps for private data, which gives you the complete protection of approach #1, but with more elegant code. This is an example of how to do that, details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_weakmaps-private-data">the chapter on WeakMaps</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">_counter</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kd">let</code> <code class="nx">_action</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kr">class</code> <code class="nx">Countdown</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">counter</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">counter</code><code class="p">);</code>
        <code class="nx">_action</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">action</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="nx">dec</code><code class="p">()</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">counter</code> <code class="o">=</code> <code class="nx">_counter</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">counter</code> <code class="o">&lt;</code> <code class="mi">1</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>
        <code class="nx">counter</code><code class="o">--</code><code class="p">;</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">counter</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">counter</code> <code class="o">===</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">_action</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">)();</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-what-is-next-for-classes">
<span class="section-number">15.6.4 </span>What is next for classes?</h4>

<p>The design motto for classes was “maximally minimal”. Several advanced features were discussed, but ultimately discarded in order to get a design that would be unanimously accepted by TC39.</p>

<p>Upcoming versions of ECMAScript can now extend this minimal design – classes will provide a foundation for features such as traits (or mixins), value objects (where different objects are equal if they have the same content) and const classes (that produce immutable instances).</p>


<h3 id="sec_class-benefits">
<span class="section-number">15.7 </span>The pros and cons of classes</h3>

<p>Classes are controversial within the JavaScript community: On one hand, people coming from class-based languages are happy that they don’t have to deal with JavaScript’s unconventional inheritance mechanisms, anymore. On the other hand, there are many JavaScript programmers who argue that what’s complicated about JavaScript is not prototypal inheritance, but constructors.</p>

<p>ES6 classes provide a few clear benefits:</p>

<ul>
<li>They are backwards compatible with much of the current code.</li>
  <li>Compared to constructors and constructor inheritance, classes make it easier for beginners to get started.</li>
  <li>Subclassing is supported within the language.</li>
  <li>Built-in constructors are subclassable.</li>
  <li>No library for inheritance is needed, anymore; code will become more portable between frameworks.</li>
  <li>They provide a foundation for advanced features in the future: traits (or mixins), immutable instances, etc.</li>
  <li>They help tools that statically analyze code (IDEs, type checkers, style checkers, etc.).</li>
</ul>
<p>Let’s look at a few common complaints about ES6 classes. You will see me agree with most of them, but I also think that they benefits of classes much outweigh their disadvantages. I’m glad that they are in ES6 and I recommend to use them.</p>

<h4 id="leanpub-auto-complaint-es6-classes-obscure-the-true-nature-of-javascript-inheritance">
<span class="section-number">15.7.1 </span>Complaint: ES6 classes obscure the true nature of JavaScript inheritance</h4>

<p>Yes, ES6 classes do obscure the true nature of JavaScript inheritance. There is an unfortunate disconnect between what a class looks like (its syntax) and how it behaves (its semantics): It looks like an object, but it is a function. My preference would have been for classes to be <em>constructor objects</em>, not constructor functions. I explore that approach in <a href="https://github.com/rauschma/proto-js">the <code>Proto.js</code> project</a>, via a tiny library (which proves how good a fit this approach is).</p>

<p>However, backwards-compatibility matters, which is why classes being constructor functions also makes sense. That way, ES6 code and ES5 are more interoperable.</p>

<p>The disconnect between syntax and semantics will cause some friction in ES6 and later. But you can lead a comfortable life by simply taking ES6 classes at face value. I don’t think the illusion will ever bite you. Newcomers can get started more quickly and later read up on what goes on behind the scenes (after they are more comfortable with the language).</p>

<h4 id="leanpub-auto-complaint-classes-provide-only-single-inheritance">
<span class="section-number">15.7.2 </span>Complaint: Classes provide only single inheritance</h4>

<p>Classes only give you single inheritance, which severely limits your freedom of expression w.r.t. object-oriented design. However, the plan has always been for them to be the foundation of a multiple-inheritance mechanism such as traits.</p>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-traitsjs-traits-library-for-javascript">traits.js: traits library for JavaScript</h3>

  <p>Check out <a href="http://soft.vub.ac.be/~tvcutsem/traitsjs/">traits.js</a> if you are interested in how traits work (they are similar to mixins, which you may be familiar with).</p>

    </td>
  </tr></tbody></table>
<p>Then a class becomes an instantiable entity and a location where you assemble traits. Until that happens, you will need to resort to libraries if you want multiple inheritance.</p>

<h4 id="leanpub-auto-complaint-classes-lock-you-in-due-to-mandatory-new">
<span class="section-number">15.7.3 </span>Complaint: Classes lock you in, due to mandatory <code>new</code>
</h4>

<p>If you want to instantiate a class, you are force to use <code>new</code> in ES6. That means that you can’t switch from a class to a factory function without changing the call sites. That is indeed a limitation, but there are two mitigating factors:</p>

<ul>
<li>You can override the default result returned by the <code>new</code> operator, by returning an object from the <code>constructor</code> method of a class.</li>
  <li>Due to its built-in modules and classes, ES6 makes it easier for IDEs to refactor code. Therefore, going from <code>new</code> to a function call will be simple. Obviously that doesn’t help you if you don’t control the code that calls your code, as is the case for libraries.</li>
</ul>
<p>Therefore, classes do <em>somewhat</em> limit you syntactically, but, once JavaScript has traits, they won’t limit you <em>conceptually</em> (w.r.t. object-oriented design).</p>


<h3 id="leanpub-auto-further-reading-1">
<span class="section-number">15.8 </span>Further reading</h3>

<p>The following document is an important source of this chapter:</p>

<ul>
<li>“<a href="https://github.com/rwaldron/tc39-notes/blob/master/es6/2015-01/jan2015-allen-slides.pdf">Instantiation Reform: One last time</a>”, slides by Allen Wirfs-Brock.</li>
</ul>
<div class="footnotes">
  <ol>
<li id="fn-classes_1">[Speaking JS] “<a href="http://speakingjs.com/es5/ch17.html#private_data_for_objects">Keeping Data Private</a>”<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-classes_1" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h2 id="ch_modules">
<span class="section-number">16. </span>Modules</h2>

<p>This chapter explains how the built-in modules work in ECMAScript 6.</p>


<h3 id="leanpub-auto-overview-10">
<span class="section-number">16.1 </span>Overview</h3>

<p>In ECMAScript 6, modules are stored in files. There is exactly one module per file and one file per module. You have two ways of exporting things from a module. These two ways can be mixed, but it is usually better to use them separately.</p>

<h4 id="leanpub-auto-named-exports">
<span class="section-number">16.1.1 </span>Named exports</h4>

<p>There can be multiple <em>named exports</em>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ lib.js ------</code>
<code class="kr">export</code> <code class="kr">const</code> <code class="nx">sqrt</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">;</code>
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">square</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code><code class="p">;</code>
<code class="p">}</code>
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">diag</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">sqrt</code><code class="p">(</code><code class="nx">square</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="o">+</code> <code class="nx">square</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>
<code class="p">}</code>

<code class="c1">//------ main.js ------</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">square</code><code class="p">,</code> <code class="nx">diag</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'lib'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">square</code><code class="p">(</code><code class="mi">11</code><code class="p">));</code> <code class="c1">// 121</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">diag</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="mi">3</code><code class="p">));</code> <code class="c1">// 5</code>
</pre></div>

</div>

<p>You can also import the complete module:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ main.js ------</code>
<code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">lib</code> <code class="nx">from</code> <code class="s1">'lib'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">lib</code><code class="p">.</code><code class="nx">square</code><code class="p">(</code><code class="mi">11</code><code class="p">));</code> <code class="c1">// 121</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">lib</code><code class="p">.</code><code class="nx">diag</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="mi">3</code><code class="p">));</code> <code class="c1">// 5</code>
</pre></div>

</div>

<h4 id="leanpub-auto-default-export">
<span class="section-number">16.1.2 </span>Default export</h4>

<p>There can be a single <em>default export</em>. For example, a function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ myFunc.js ------</code>
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code> <code class="c1">// no semicolon!</code>

<code class="c1">//------ main1.js ------</code>
<code class="kr">import</code> <code class="nx">myFunc</code> <code class="nx">from</code> <code class="s1">'myFunc'</code><code class="p">;</code>
<code class="nx">myFunc</code><code class="p">();</code>
</pre></div>

</div>

<p>Or a class:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ MyClass.js ------</code>
<code class="kr">export</code> <code class="k">default</code> <code class="kr">class</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code> <code class="c1">// no semicolon!</code>

<code class="c1">//------ main2.js ------</code>
<code class="kr">import</code> <code class="nx">MyClass</code> <code class="nx">from</code> <code class="s1">'MyClass'</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">inst</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyClass</code><code class="p">();</code>
</pre></div>

</div>

<p>Note that there is no semicolon at the end if you default-export a function or a class (which, syntactically, are anonymous declarations).</p>

<h4 id="leanpub-auto-browsers-scripts-versus-modules">
<span class="section-number">16.1.3 </span>Browsers: scripts versus modules</h4>

<table>
<thead><tr>
<th>&nbsp;</th>
      <th>Scripts</th>
      <th>Modules</th>
    </tr></thead>
<tbody>
<tr>
<td>HTML element</td>
      <td><code>&lt;script&gt;</code></td>
      <td><code>&lt;script type="module"&gt;</code></td>
    </tr>
<tr>
<td>Top-level variables are</td>
      <td>global</td>
      <td>local to module</td>
    </tr>
<tr>
<td>Value of <code>this</code> at top level</td>
      <td><code>window</code></td>
      <td><code>undefined</code></td>
    </tr>
<tr>
<td>Executed</td>
      <td>synchronously</td>
      <td>asynchronously</td>
    </tr>
<tr>
<td>Import declaratively (<code>import</code> statement)</td>
      <td>no</td>
      <td>yes</td>
    </tr>
<tr>
<td>Import programmatically (Promise-based API)</td>
      <td>yes</td>
      <td>yes</td>
    </tr>
<tr>
<td>File extension</td>
      <td><code>.js</code></td>
      <td><code>.js</code></td>
    </tr>
</tbody>
</table>
<h3 id="leanpub-auto-modules-in-javascript">
<span class="section-number">16.2 </span>Modules in JavaScript</h3>

<p>Even though JavaScript never had built-in modules, the community has converged on a simple style of modules, which is supported by libraries in ES5 and earlier. This style has also been adopted by ES6:</p>

<ul>
<li>Each module is a piece of code that is executed once it is loaded.</li>
  <li>In that code, there may be declarations (variable declarations, function declarations, etc.).
    <ul>
<li>By default, these declarations stay local to the module.</li>
      <li>You can mark some of them as exports, then other modules can import them.</li>
    </ul>
</li>
  <li>A module can not only export things, it can also import things from other modules. It refers to those modules via <em>module specifiers</em>, strings that are either:
    <ul>
<li>Relative paths (<code>'../model/user'</code>): these paths are interpreted relatively to the location of the importing module. The file extension <code>.js</code> can usually be omitted.</li>
      <li>Absolute paths (<code>'/lib/js/helpers'</code>): point directly to the file of the module to be imported.</li>
      <li>Names (<code>'util'</code>): What modules names refer to has to be configured.</li>
    </ul>
</li>
  <li>Modules are singletons. Even if a module is imported multiple times, only a single “instance” of it exists.</li>
  <li>Execution of a client or server app starts with an initial module. In some modules systems (including ES6), the initial module can be embedded in an HTML file (think <code>&lt;script&gt;</code> element).</li>
</ul>
<p>This approach to modules avoids global variables, the only things that are global are module specifiers.</p>


<h4 id="leanpub-auto-es5-module-systems">
<span class="section-number">16.2.1 </span>ES5 module systems</h4>

<p>It is impressive how well ES5 module systems work without explicit support from the language. The two most important (and unfortunately incompatible) standards are:</p>

<ul>
<li>
<strong>CommonJS Modules:</strong> The dominant implementation of this standard is <a href="http://nodejs.org/api/modules.html">in Node.js</a> (Node.js modules have a few features that go beyond CommonJS). Characteristics:
    <ul>
<li>Compact syntax</li>
      <li>Designed for synchronous loading</li>
      <li>Main use: server</li>
    </ul>
</li>
  <li>
<strong>Asynchronous Module Definition (AMD):</strong> The most popular implementation of this standard is <a href="http://requirejs.org/">RequireJS</a>. Characteristics:
    <ul>
<li>Slightly more complicated syntax, enabling AMD to work without eval() (or a compilation step).</li>
      <li>Designed for asynchronous loading</li>
      <li>Main use: browsers</li>
    </ul>
</li>
</ul>
<p>The above is but a simplified explanation of the current state of affairs. If you want more in-depth material, take a look at “<a href="http://addyosmani.com/writing-modular-js/">Writing Modular JavaScript With AMD, CommonJS &amp; ES Harmony</a>” by Addy Osmani.</p>


<h4 id="leanpub-auto-ecmascript-6-modules">
<span class="section-number">16.2.2 </span>ECMAScript 6 modules</h4>

<p>The goal for ECMAScript 6 modules was to create a format that both users of CommonJS and of AMD are happy with:</p>

<ul>
<li>Similar to CommonJS, they have a compact syntax, a preference for single exports and support for cyclic dependencies.</li>
  <li>Similar to AMD, they have direct support for asynchronous loading and configurable module loading.</li>
</ul>
<p>Being built into the language allows ES6 modules to go beyond CommonJS and AMD (details are explained later):</p>

<ul>
<li>Their syntax is even more compact than CommonJS’s.</li>
  <li>Their structure can be statically analyzed (for static checking, optimization, etc.).</li>
  <li>Their support for cyclic dependencies is better than CommonJS’s.</li>
</ul>
<p>The ES6 module standard has two parts:</p>

<ul>
<li>Declarative syntax (for importing and exporting)</li>
  <li>Programmatic loader API: to configure how modules are loaded and to conditionally load modules</li>
</ul>
<h3 id="leanpub-auto-a-first-look-at-es6-modules">
<span class="section-number">16.3 </span>A first look at ES6 modules</h3>

<p>There are two kinds of exports: named exports (several per module) and default exports (one per module).</p>


<h4 id="leanpub-auto-named-exports-several-per-module">
<span class="section-number">16.3.1 </span>Named exports (several per module)</h4>

<p>A module can export multiple things by prefixing their declarations with the keyword <code>export</code>. These exports are distinguished by their names and are called <em>named exports</em>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ lib.js ------</code>
<code class="kr">export</code> <code class="kr">const</code> <code class="nx">sqrt</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">;</code>
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">square</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code><code class="p">;</code>
<code class="p">}</code>
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">diag</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">sqrt</code><code class="p">(</code><code class="nx">square</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="o">+</code> <code class="nx">square</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>
<code class="p">}</code>

<code class="c1">//------ main.js ------</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">square</code><code class="p">,</code> <code class="nx">diag</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'lib'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">square</code><code class="p">(</code><code class="mi">11</code><code class="p">));</code> <code class="c1">// 121</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">diag</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="mi">3</code><code class="p">));</code> <code class="c1">// 5</code>
</pre></div>

</div>

<p>There are other ways to specify named exports (which are explained later), but I find this one quite convenient: simply write your code as if there were no outside world, then label everything that you want to export with a keyword.</p>

<p>If you want to, you can also import the whole module and refer to its named exports via property notation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ main.js ------</code>
<code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">lib</code> <code class="nx">from</code> <code class="s1">'lib'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">lib</code><code class="p">.</code><code class="nx">square</code><code class="p">(</code><code class="mi">11</code><code class="p">));</code> <code class="c1">// 121</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">lib</code><code class="p">.</code><code class="nx">diag</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="mi">3</code><code class="p">));</code> <code class="c1">// 5</code>
</pre></div>

</div>

<p><strong>The same code in CommonJS syntax:</strong> For a while, I tried several clever strategies to be less redundant with my module exports in Node.js. Now I prefer the following simple but slightly verbose style that is reminiscent of the <a href="http://christianheilmann.com/2007/08/22/again-with-the-module-pattern-reveal-something-to-the-world/">revealing module pattern</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ lib.js ------</code>
<code class="kd">var</code> <code class="nx">sqrt</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">;</code>
<code class="kd">function</code> <code class="nx">square</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code><code class="p">;</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">diag</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">sqrt</code><code class="p">(</code><code class="nx">square</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="o">+</code> <code class="nx">square</code><code class="p">(</code><code class="nx">y</code><code class="p">));</code>
<code class="p">}</code>
<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">sqrt</code><code class="o">:</code> <code class="nx">sqrt</code><code class="p">,</code>
    <code class="nx">square</code><code class="o">:</code> <code class="nx">square</code><code class="p">,</code>
    <code class="nx">diag</code><code class="o">:</code> <code class="nx">diag</code><code class="p">,</code>
<code class="p">};</code>

<code class="c1">//------ main.js ------</code>
<code class="kd">var</code> <code class="nx">square</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'lib'</code><code class="p">).</code><code class="nx">square</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">diag</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'lib'</code><code class="p">).</code><code class="nx">diag</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">square</code><code class="p">(</code><code class="mi">11</code><code class="p">));</code> <code class="c1">// 121</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">diag</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="mi">3</code><code class="p">));</code> <code class="c1">// 5</code>
</pre></div>

</div>


<h4 id="leanpub-auto-default-exports-one-per-module">
<span class="section-number">16.3.2 </span>Default exports (one per module)</h4>

<p>Modules that only export single values are very popular in the Node.js community. But they are also common in frontend development where you often have constructors/classes for models, with one model per module. An ECMAScript 6 module can pick a <em>default export</em>, the main exported value. Default exports are especially easy to import.</p>

<p>The following ECMAScript 6 module “is” a single function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ myFunc.js ------</code>
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code> <code class="c1">// no semicolon!</code>

<code class="c1">//------ main1.js ------</code>
<code class="kr">import</code> <code class="nx">myFunc</code> <code class="nx">from</code> <code class="s1">'myFunc'</code><code class="p">;</code>
<code class="nx">myFunc</code><code class="p">();</code>
</pre></div>

</div>

<p>An ECMAScript 6 module whose default export is a class looks as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ MyClass.js ------</code>
<code class="kr">export</code> <code class="k">default</code> <code class="kr">class</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code> <code class="c1">// no semicolon!</code>

<code class="c1">//------ main2.js ------</code>
<code class="kr">import</code> <code class="nx">MyClass</code> <code class="nx">from</code> <code class="s1">'MyClass'</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">inst</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyClass</code><code class="p">();</code>
</pre></div>

</div>

<h5 id="leanpub-auto-operand-of-export-default-declaration-or-expression">
<span class="section-number">16.3.2.1 </span>Operand of <code>export default</code>: declaration or expression</h5>

<p>Syntactically, the operand of <code>export default</code> is:</p>

<ul>
<li>A declaration: if it starts with <code>function</code> or <code>class</code>. That means that what you have seen in the previous code examples were anonymous declarations (which can only be used in this particular location).</li>
  <li>An expression: in all other cases.</li>
</ul>
<p>Therefore, there are two ways in which you can default-export an anonymous function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{}</code> <code class="c1">// function declaration</code>
<code class="kr">export</code> <code class="k">default</code> <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{});</code> <code class="c1">// function expression</code>
</pre></div>

</div>

<p>You can also give the function declaration a name. That is useful if you want to refer to the default export from somewhere else in the module:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">bar</code><code class="p">();</code>

<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">bar</code><code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
</pre></div>

</div>

<p>This code is equivalent to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">bar</code><code class="p">();</code>

<code class="kd">function</code> <code class="nx">bar</code><code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">bar</code><code class="p">;</code>
</pre></div>

</div>


<h4 id="leanpub-auto-modules-export-immutable-bindings-not-values">
<span class="section-number">16.3.3 </span>Modules export immutable bindings, not values</h4>

<p>In contrast to AMD modules and CommonJS modules, modules do not export <em>values</em> (snapshots of values), but <em>bindings</em><sup id="fnref-modules_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-modules_1" rel="footnote">1</a></sup> (live references to where the values are stored). These bindings are immutable: You can only read the value via the binding, but not change it. It can, however, be changed from insider the module. The following code demonstrates how that works.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ lib.js ------</code>
<code class="kr">export</code> <code class="kd">let</code> <code class="nx">mutableValue</code> <code class="o">=</code> <code class="mi">3</code><code class="p">;</code>
<code class="kr">export</code> <code class="kd">let</code> <code class="nx">incMutableValue</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">mutableValue</code><code class="o">++</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">//------ main1.js ------</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">mutableValue</code><code class="p">,</code> <code class="nx">incMutableValue</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'./lib'</code><code class="p">;</code>

<code class="c1">// The imported value is live</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">mutableValue</code><code class="p">);</code> <code class="c1">// 3</code>
<code class="nx">incMutableValue</code><code class="p">();</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">mutableValue</code><code class="p">);</code> <code class="c1">// 4</code>

<code class="c1">// The imported value can’t be changed</code>
<code class="nx">mutableValue</code><code class="o">++</code><code class="p">;</code> <code class="c1">// TypeError</code>
</pre></div>

</div>

<p>If you import via the asterisk (<code>*</code>), you get similar results:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ main2.js ------</code>
<code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">lib</code> <code class="nx">from</code> <code class="s1">'./lib'</code><code class="p">;</code>

<code class="c1">// The imported value is live</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">lib</code><code class="p">.</code><code class="nx">mutableValue</code><code class="p">);</code> <code class="c1">// 3</code>
<code class="nx">lib</code><code class="p">.</code><code class="nx">incMutableValue</code><code class="p">();</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">lib</code><code class="p">.</code><code class="nx">mutableValue</code><code class="p">);</code> <code class="c1">// 4</code>

<code class="c1">// The imported value can’t be changed</code>
<code class="nx">lib</code><code class="p">.</code><code class="nx">mutableValue</code><code class="o">++</code><code class="p">;</code> <code class="c1">// TypeError</code>
</pre></div>

</div>


<h4 id="leanpub-auto-imports-are-hoisted">
<span class="section-number">16.3.4 </span>Imports are hoisted</h4>

<p>Module imports are hoisted (internally moved to the beginning of the current scope). Therefore, it doesn’t matter where you mention them in a module and the following code works without any problems:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">foo</code><code class="p">();</code>

<code class="kr">import</code> <code class="p">{</code> <code class="nx">foo</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'my_module'</code><code class="p">;</code>
</pre></div>

</div>


<h4 id="leanpub-auto-module-files-are-normal-javascript-files">
<span class="section-number">16.3.5 </span>Module files are normal JavaScript files</h4>

<p>The following kinds of files all have the extension <code>.js</code>:</p>

<ol class="numeric numeric">
<li>ECMAScript 6 modules</li>
  <li>CommonJS modules (e.g. delivered via npm)</li>
  <li>AMD modules</li>
  <li>Script files (loaded from HTML files via <code>&lt;script src="file.js"&gt;</code>)</li>
</ol>
<p>That is, all of these files are just “JavaScript files”. How they are interpreted depends on the context in which they are used.</p>


<h3 id="leanpub-auto-design-goals">
<span class="section-number">16.4 </span>Design goals</h3>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_eye.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-you-can-skip-this-section">You can skip this section</h3>

  <p>Depending on whether the topics enumerated below matter to you, you won’t miss any essential information if you don’t read this section.</p>

    </td>
  </tr></tbody></table>
<p>If you want to make sense of ECMAScript 6 modules, it helps to understand what goals influenced their design. The major ones are:</p>

<ul>
<li>Default exports are favored</li>
  <li>Static module structure</li>
  <li>Support for both synchronous and asynchronous loading</li>
  <li>Support for cyclic dependencies between modules</li>
</ul>
<p>The following subsections explain these goals.</p>


<h4 id="leanpub-auto-default-exports-are-favored">
<span class="section-number">16.4.1 </span>Default exports are favored</h4>

<p>The module syntax suggesting that the default export “is” the module may seem a bit strange, but it makes sense if you consider that one major design goal was to make default exports as convenient as possible. Quoting <a href="http://esdiscuss.org/topic/moduleimport#content-0">David Herman</a>:</p>

<blockquote>
  <p>ECMAScript 6 favors the single/default export style, and gives the sweetest syntax to importing the default. Importing named exports can and even should be slightly less concise.</p>
</blockquote>


<h4 id="static-module-structure">
<span class="section-number">16.4.2 </span>Static module structure</h4>

<p>In current JavaScript module systems, you have to execute the code in order to find out what the imports and exports are. That is the main reason why ECMAScript 6 breaks with those systems: by building the module system into the language, you can syntactically enforce a static module structure. Let’s first examine what that means and then what benefits it brings.</p>

<p>A module’s structure being static means that you can determine imports and exports at compile time (statically) – you only have to look at the source code, you don’t have to execute it. The following are two examples of how CommonJS modules can make that impossible. In the first example, you have to run the code to find out what it imports:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">my_lib</code><code class="p">;</code>
<code class="k">if</code> <code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">my_lib</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'foo'</code><code class="p">);</code>
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="nx">my_lib</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'bar'</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In the second example, you have to run the code to find out what it exports:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">exports</code><code class="p">.</code><code class="nx">baz</code> <code class="o">=</code> <code class="err">···</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>ECMAScript 6 gives you less flexibility, it forces you to be static. As a result, you get several benefits, which are described next.</p>

<h5 id="leanpub-auto-benefit-1-faster-lookup">
<span class="section-number">16.4.2.1 </span>Benefit 1: faster lookup</h5>

<p>If you require a library in CommonJS, you get back an object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">lib</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'lib'</code><code class="p">);</code>
<code class="nx">lib</code><code class="p">.</code><code class="nx">someFunc</code><code class="p">();</code> <code class="c1">// property lookup</code>
</pre></div>

</div>

<p>Thus, accessing a named export via <code>lib.someFunc</code> means you have to do a property lookup, which is slow, because it is dynamic.</p>

<p>In contrast, if you import a library in ES6, you statically know its contents and can optimize accesses:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">lib</code> <code class="nx">from</code> <code class="s1">'lib'</code><code class="p">;</code>
<code class="nx">lib</code><code class="p">.</code><code class="nx">someFunc</code><code class="p">();</code> <code class="c1">// statically resolved</code>
</pre></div>

</div>

<h5 id="leanpub-auto-benefit-2-variable-checking">
<span class="section-number">16.4.2.2 </span>Benefit 2: variable checking</h5>

<p>With a static module structure, you always statically know which variables are visible at any location inside the module:</p>

<ul>
<li>Global variables: increasingly, the only completely global variables will come from the language proper. Everything else will come from modules (including functionality from the standard library and the browser). That is, you statically know all global variables.</li>
  <li>Module imports: You statically know those, too.</li>
  <li>Module-local variables: can be determined by statically examining the module.</li>
</ul>
<p>This helps tremendously with checking whether a given identifier has been spelled properly. This kind of check is a popular feature of linters such as JSLint and JSHint; in ECMAScript 6, most of it can be performed by JavaScript engines.</p>

<p>Additionally, any access of named imports (such as <code>lib.foo</code>) can also be checked statically.</p>

<h5 id="leanpub-auto-benefit-3-ready-for-macros">
<span class="section-number">16.4.2.3 </span>Benefit 3: ready for macros</h5>

<p>Macros are still on the roadmap for JavaScript’s future. If a JavaScript engine supports macros, you can add new syntax to it via a library. <a href="http://sweetjs.org/">Sweet.js</a> is an experimental macro system for JavaScript. The following is an example from the Sweet.js website: a macro for classes.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Define the macro</code>
<code class="nx">macro</code> <code class="kr">class</code> <code class="p">{</code>
    <code class="nx">rule</code> <code class="p">{</code>
        <code class="nx">$className</code> <code class="p">{</code>
                <code class="nx">constructor</code> <code class="nx">$cparams</code> <code class="nx">$cbody</code>
                <code class="nx">$</code><code class="p">(</code><code class="nx">$mname</code> <code class="nx">$mparams</code> <code class="nx">$mbody</code><code class="p">)</code> <code class="p">...</code>
        <code class="p">}</code>
    <code class="p">}</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="kd">function</code> <code class="nx">$className</code> <code class="nx">$cparams</code> <code class="nx">$cbody</code>
        <code class="nx">$</code><code class="p">(</code><code class="nx">$className</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">$mname</code>
            <code class="o">=</code> <code class="kd">function</code> <code class="nx">$mname</code> <code class="nx">$mparams</code> <code class="nx">$mbody</code><code class="p">;</code> <code class="p">)</code> <code class="p">...</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Use the macro</code>
<code class="kr">class</code> <code class="nx">Person</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">name</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">name</code> <code class="o">=</code> <code class="nx">name</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">say</code><code class="p">(</code><code class="nx">msg</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code> <code class="s2">" says: "</code> <code class="o">+</code> <code class="nx">msg</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="kd">var</code> <code class="nx">bob</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Person</code><code class="p">(</code><code class="s2">"Bob"</code><code class="p">);</code>
<code class="nx">bob</code><code class="p">.</code><code class="nx">say</code><code class="p">(</code><code class="s2">"Macros are sweet!"</code><code class="p">);</code>
</pre></div>

</div>

<p>For macros, a JavaScript engine performs a preprocessing step before compilation: If a sequence of tokens in the token stream produced by the parser matches the pattern part of the macro, it is replaced by tokens generated via the body of macro. The preprocessing step only works if you are able to statically find macro definitions. Therefore, if you want to import macros via modules then they must have a static structure.</p>

<h5 id="leanpub-auto-benefit-4-ready-for-types">
<span class="section-number">16.4.2.4 </span>Benefit 4: ready for types</h5>

<p>Static type checking imposes constraints similar to macros: it can only be done if type definitions can be found statically. Again, types can only be imported from modules if they have a static structure.</p>

<p>Types are appealing because they enable statically typed fast dialects of JavaScript in which performance-critical code can be written. One such dialect is <a href="http://lljs.org/">Low-Level JavaScript</a> (LLJS). It currently compiles to <a href="http://www.2ality.com/2013/02/asm-js.html">asm.js</a>.</p>

<h5 id="leanpub-auto-benefit-5-supporting-other-languages">
<span class="section-number">16.4.2.5 </span>Benefit 5: supporting other languages</h5>

<p>If you want to support compiling languages with macros and static types to JavaScript then JavaScript’s modules should have a static structure, for the reasons mentioned in the previous two sections.</p>

<h5 id="leanpub-auto-source-of-this-section-1">
<span class="section-number">16.4.2.6 </span>Source of this section</h5>

<ul>
<li>“<a href="http://calculist.org/blog/2012/06/29/static-module-resolution/">Static module resolution</a>” by David Herman</li>
</ul>
<h4 id="leanpub-auto-support-for-both-synchronous-and-asynchronous-loading">
<span class="section-number">16.4.3 </span>Support for both synchronous and asynchronous loading</h4>

<p>ECMAScript 6 modules must work independently of whether the engine loads modules synchronously (e.g. on servers) or asynchronously (e.g. in browsers). Its syntax is well suited for synchronous loading, asynchronous loading is enabled by its static structure: Because you can statically determine all imports, you can load them before evaluating the body of the module (in a manner reminiscent of AMD modules).</p>


<h4 id="leanpub-auto-support-for-cyclic-dependencies-between-modules">
<span class="section-number">16.4.4 </span>Support for cyclic dependencies between modules</h4>

<p>Two modules A and B are <a href="http://en.wikipedia.org/wiki/Circular_dependency">cyclically dependent</a> on each other if both A (possibly indirectly/transitively) imports B and B imports A. If possible, cyclic dependencies should be avoided, they lead to A and B being <em>tightly coupled</em> – they can only be used and evolved together.</p>

<h5 id="leanpub-auto-why-support-cyclic-dependencies">
<span class="section-number">16.4.4.1 </span>Why support cyclic dependencies?</h5>

<p>Cyclic dependencies are not inherently evil. Especially for objects, you sometimes even want this kind of dependency. For example, in some trees (such as DOM documents), parents refer to children and children refer back to parents. In libraries, you can usually avoid cyclic dependencies via careful design. In a large system, though, they can happen, especially during refactoring. Then it is very useful if a module system supports them, because then the system doesn’t break while you are refactoring.</p>

<p>The Node.js documentation <a href="http://nodejs.org/api/modules.html#modules_cycles">acknowledges</a> the importance of cyclic dependencies and Rob Sayre provides additional <a href="https://mail.mozilla.org/pipermail/es-discuss/2014-July/038250.html">evidence</a>:</p>

<blockquote>
  <p>Data point: I once implemented a system like [ECMAScript 6 modules] for Firefox. I got <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=384168#c7">asked</a> for cyclic dependency support 3 weeks after shipping.</p>

  <p>That system that Alex Fritze invented and I worked on is not perfect, and the syntax isn’t very pretty. But <a href="https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/Using">it’s still getting used</a> 7 years later, so it must have gotten something right.</p>
</blockquote>

<p>Let’s see how CommonJS and ECMAScript 6 handle cyclic dependencies.</p>

<h5 id="leanpub-auto-cyclic-dependencies-in-commonjs">
<span class="section-number">16.4.4.2 </span>Cyclic dependencies in CommonJS</h5>

<p>In CommonJS, if a module B requires a module A whose body is currently being evaluated, it gets back A’s exports object in its current state (line #1 in the following example). That enables B to refer to properties of that object inside its exports (line #2). The properties are filled in after B’s evaluation is finished, at which point B’s exports work properly.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ a.js ------</code>
<code class="kd">var</code> <code class="nx">b</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'b'</code><code class="p">);</code>
<code class="nx">exports</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">};</code>

<code class="c1">//------ b.js ------</code>
<code class="kd">var</code> <code class="nx">a</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'a'</code><code class="p">);</code> <code class="c1">// (1)</code>
<code class="c1">// Can’t use a.foo in module body,</code>
<code class="c1">// but it will be filled in later</code>
<code class="nx">exports</code><code class="p">.</code><code class="nx">bar</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">a</code><code class="p">.</code><code class="nx">foo</code><code class="p">();</code> <code class="c1">// OK (2)</code>
<code class="p">};</code>

<code class="c1">//------ main.js ------</code>
<code class="kd">var</code> <code class="nx">a</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'a'</code><code class="p">);</code>
</pre></div>

</div>

<p>As a general rule, keep in mind that with cyclic dependencies, you can’t access imports in the body of the module. That is inherent to the phenomenon and doesn’t change with ECMAScript 6 modules.</p>

<p>The limitations of the CommonJS approach are:</p>

<ul>
<li>Node.js-style single-value exports don’t work. In Node.js, you can export single values instead of objects, like this:<br><code>module.exports = function () { ··· }</code><br>
If you did that in module A, you wouldn’t be able to use the exported function in module B, because B’s variable <code>a</code> would still refer to A’s original exports object.</li>
  <li>You can’t use named exports directly. That is, module B can’t import <code>a.foo</code> like this:<br><code>var foo = require('a').foo;</code><br><code>foo</code> would simply be <code>undefined</code>. In other words, you have no choice but to refer to <code>foo</code> via the exports object <code>a</code>.</li>
</ul>
<p>CommonJS has one unique feature: you can export before importing. Such exports are guaranteed to be accessible in the bodies of importing modules. That is, if A did that, they could be accessed in B’s body. However, exporting before importing is rarely useful.</p>

<h5 id="leanpub-auto-cyclic-dependencies-in-ecmascript-6">
<span class="section-number">16.4.4.3 </span>Cyclic dependencies in ECMAScript 6</h5>

<p>In order to eliminate the aforementioned two limitations, ECMAScript 6 modules export bindings, not values. That is, the connection to variables declared inside the module body remains live. This is demonstrated by the following code.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ lib.js ------</code>
<code class="kr">export</code> <code class="kd">let</code> <code class="nx">counter</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">inc</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">counter</code><code class="o">++</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">//------ main.js ------</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">inc</code><code class="p">,</code> <code class="nx">counter</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'lib'</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">counter</code><code class="p">);</code> <code class="c1">// 0</code>
<code class="nx">inc</code><code class="p">();</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">counter</code><code class="p">);</code> <code class="c1">// 1</code>
</pre></div>

</div>

<p>Thus, in the face of cyclic dependencies, it doesn’t matter whether you access a named export directly or via its module: There is an indirection involved in either case and it always works.</p>


<h3 id="leanpub-auto-more-on-importing-and-exporting">
<span class="section-number">16.5 </span>More on importing and exporting</h3>


<h4 id="leanpub-auto-importing-styles">
<span class="section-number">16.5.1 </span>Importing styles</h4>

<p>ECMAScript 6 provides several styles of importing<sup id="fnref-modules_2"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-modules_2" rel="footnote">2</a></sup>:</p>

<ul>
<li>Default import:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">import</code> <code class="nx">localName</code> <code class="nx">from</code> <code class="s1">'src/my_lib'</code><code class="p">;</code>
</pre></div>
    
</div>
  </li>
  <li>Namespace import: imports the module as an object (with one property per named export).
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">my_lib</code> <code class="nx">from</code> <code class="s1">'src/my_lib'</code><code class="p">;</code>
</pre></div>
    
</div>
  </li>
  <li>Named imports:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">import</code> <code class="p">{</code> <code class="nx">name1</code><code class="p">,</code> <code class="nx">name2</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'src/my_lib'</code><code class="p">;</code>
</pre></div>
    
</div>

    <p>You can rename named imports:</p>

    <div class="code-block">
<div class="highlight"><pre>  <code class="c1">// Renaming: import `name1` as `localName1`</code>
  <code class="kr">import</code> <code class="p">{</code> <code class="nx">name1</code> <code class="nx">as</code> <code class="nx">localName1</code><code class="p">,</code> <code class="nx">name2</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'src/my_lib'</code><code class="p">;</code>
</pre></div>
    
</div>
  </li>
  <li>Empty import: only loads the module, doesn’t import anything. The first such import in a program executes the body of the module.
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">import</code> <code class="s1">'src/my_lib'</code><code class="p">;</code>
</pre></div>
    
</div>
  </li>
</ul>
<p>There are only two ways to combine these styles and the order in which they appear is fixed; the default export always comes first.</p>

<ul>
<li>Combining a default import with a namespace import:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">import</code> <code class="nx">theDefault</code><code class="p">,</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">my_lib</code> <code class="nx">from</code> <code class="s1">'src/my_lib'</code><code class="p">;</code>
</pre></div>
    
</div>
  </li>
  <li>Combining a default import with named imports
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">import</code> <code class="nx">theDefault</code><code class="p">,</code> <code class="p">{</code> <code class="nx">name1</code><code class="p">,</code> <code class="nx">name2</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'src/my_lib'</code><code class="p">;</code>
</pre></div>
    
</div>
  </li>
</ul>
<h4 id="leanpub-auto-exporting-styles-inline-versus-clause">
<span class="section-number">16.5.2 </span>Exporting styles: inline versus clause</h4>

<p>There are <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-exports">two ways</a> in which you can export things that are inside the current module. On one hand, you can mark declarations with the keyword <code>export</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">export</code> <code class="kd">var</code> <code class="nx">myVar1</code> <code class="o">=</code> <code class="err">···</code><code class="p">;</code>
<code class="kr">export</code> <code class="kd">let</code> <code class="nx">myVar2</code> <code class="o">=</code> <code class="err">···</code><code class="p">;</code>
<code class="kr">export</code> <code class="kr">const</code> <code class="nx">MY_CONST</code> <code class="o">=</code> <code class="err">···</code><code class="p">;</code>

<code class="kr">export</code> <code class="kd">function</code> <code class="nx">myFunc</code><code class="p">()</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
<code class="kr">export</code> <code class="kd">function</code><code class="o">*</code> <code class="nx">myGeneratorFunc</code><code class="p">()</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
<code class="kr">export</code> <code class="kr">class</code> <code class="nx">MyClass</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The “operand” of a default export is an expression (including function expressions and class expressions). Examples:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">export</code> <code class="k">default</code> <code class="mi">123</code><code class="p">;</code>
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">x</code>
<code class="p">}</code>
<code class="kr">export</code> <code class="k">default</code> <code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code><code class="p">;</code>
<code class="kr">export</code> <code class="k">default</code> <code class="kr">class</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>On the other hand, you can list everything you want to export at the end of the module (which is once again similar in style to the revealing module pattern).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">MY_CONST</code> <code class="o">=</code> <code class="err">···</code><code class="p">;</code>
<code class="kd">function</code> <code class="nx">myFunc</code><code class="p">()</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>

<code class="kr">export</code> <code class="p">{</code> <code class="nx">MY_CONST</code><code class="p">,</code> <code class="nx">myFunc</code> <code class="p">};</code>
</pre></div>

</div>

<p>You can also export things under different names:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">export</code> <code class="p">{</code> <code class="nx">MY_CONST</code> <code class="nx">as</code> <code class="nx">FOO</code><code class="p">,</code> <code class="nx">myFunc</code> <code class="p">};</code>
</pre></div>

</div>


<h4 id="leanpub-auto-re-exporting">
<span class="section-number">16.5.3 </span>Re-exporting</h4>

<p>Re-exporting means adding another module’s exports to those of the current module. You can either add all of the other module’s exports:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">export</code> <code class="o">*</code> <code class="nx">from</code> <code class="s1">'src/other_module'</code><code class="p">;</code>
</pre></div>

</div>

<p>Default exports are ignored<sup id="fnref-modules_3"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-modules_3" rel="footnote">3</a></sup> by <code>export *</code>.</p>

<p>Or you can be more selective (optionally while renaming):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">export</code> <code class="p">{</code> <code class="nx">foo</code><code class="p">,</code> <code class="nx">bar</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'src/other_module'</code><code class="p">;</code>

<code class="c1">// Renaming: export other_module’s foo as myFoo</code>
<code class="kr">export</code> <code class="p">{</code> <code class="nx">foo</code> <code class="nx">as</code> <code class="nx">myFoo</code><code class="p">,</code> <code class="nx">bar</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'src/other_module'</code><code class="p">;</code>
</pre></div>

</div>

<h5 id="leanpub-auto-making-a-re-export-the-default-export">
<span class="section-number">16.5.3.1 </span>Making a re-export the default export</h5>

<p>The following statement makes the default export of another module <code>foo</code> the default export of the current module:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">export</code> <code class="p">{</code> <code class="k">default</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'foo'</code><code class="p">;</code>
</pre></div>

</div>

<p>The following statement makes the named export <code>myFunc</code> of module <code>foo</code> the default export of the current module:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">export</code> <code class="p">{</code> <code class="nx">myFunc</code> <code class="nx">as</code> <code class="k">default</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'foo'</code><code class="p">;</code>
</pre></div>

</div>


<h4 id="leanpub-auto-all-exporting-styles">
<span class="section-number">16.5.4 </span>All exporting styles</h4>

<p>ECMAScript 6 provides several styles of exporting<sup id="fnref-modules_4"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-modules_4" rel="footnote">4</a></sup>:</p>

<ul>
<li>Re-exporting:
    <ul>
<li>Re-export everything (except for the default export):
        <div class="code-block">
<div class="highlight"><pre>  <code class="kr">export</code> <code class="o">*</code> <code class="nx">from</code> <code class="s1">'src/other_module'</code><code class="p">;</code>
</pre></div>
        
</div>
      </li>
      <li>Re-export via a clause:
        <div class="code-block">
<div class="highlight"><pre>  <code class="kr">export</code> <code class="p">{</code> <code class="nx">foo</code> <code class="nx">as</code> <code class="nx">myFoo</code><code class="p">,</code> <code class="nx">bar</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'src/other_module'</code><code class="p">;</code>
</pre></div>
        
</div>
      </li>
    </ul>
</li>
  <li>Exporting via a clause:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kr">export</code> <code class="p">{</code> <code class="nx">MY_CONST</code> <code class="nx">as</code> <code class="nx">FOO</code><code class="p">,</code> <code class="nx">myFunc</code> <code class="p">};</code>
</pre></div>
    
</div>
  </li>
  <li>Inline exports:
    <ul>
<li>Variable declarations:
        <div class="code-block">
<div class="highlight"><pre>  <code class="kr">export</code> <code class="kd">var</code> <code class="nx">foo</code><code class="p">;</code>
  <code class="kr">export</code> <code class="kd">let</code> <code class="nx">foo</code><code class="p">;</code>
  <code class="kr">export</code> <code class="kr">const</code> <code class="nx">foo</code><code class="p">;</code>
</pre></div>
        
</div>
      </li>
      <li>Function declarations:
        <div class="code-block">
<div class="highlight"><pre>  <code class="kr">export</code> <code class="kd">function</code> <code class="nx">myFunc</code><code class="p">()</code> <code class="p">{}</code>
  <code class="kr">export</code> <code class="kd">function</code><code class="o">*</code> <code class="nx">myGenFunc</code><code class="p">()</code> <code class="p">{}</code>
</pre></div>
        
</div>
      </li>
      <li>Class declarations:
        <div class="code-block">
<div class="highlight"><pre>  <code class="kr">export</code> <code class="kr">class</code> <code class="nx">MyClass</code><code class="p">()</code> <code class="p">{}</code>
</pre></div>
        
</div>
      </li>
    </ul>
</li>
  <li>Default export:
    <ul>
<li>Function declarations (can be anonymous, but only here):
        <div class="code-block">
<div class="highlight"><pre>  <code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">myFunc</code><code class="p">()</code> <code class="p">{}</code>
  <code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{}</code>

  <code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code><code class="o">*</code> <code class="nx">myGenFunc</code><code class="p">()</code> <code class="p">{}</code>
  <code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{}</code>
</pre></div>
        
</div>
      </li>
      <li>Class declarations (can be anonymous, but only here):
        <div class="code-block">
<div class="highlight"><pre>  <code class="kr">export</code> <code class="k">default</code> <code class="kr">class</code> <code class="nx">MyClass</code><code class="p">()</code> <code class="p">{}</code>
  <code class="kr">export</code> <code class="k">default</code> <code class="kr">class</code> <code class="p">()</code> <code class="p">{}</code>
</pre></div>
        
</div>
      </li>
      <li>Expressions: export values, not bindings. Note the semicolons at the end.
        <div class="code-block">
<div class="highlight"><pre>  <code class="kr">export</code> <code class="k">default</code> <code class="nx">foo</code><code class="p">;</code>
  <code class="kr">export</code> <code class="k">default</code> <code class="s1">'Hello world!'</code><code class="p">;</code>
  <code class="kr">export</code> <code class="k">default</code> <code class="mi">3</code> <code class="o">*</code> <code class="mi">7</code><code class="p">;</code>
  <code class="kr">export</code> <code class="k">default</code> <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{});</code>
</pre></div>
        
</div>
      </li>
    </ul>
</li>
</ul>
<h4 id="sec_mixing-named-and-default-exports">
<span class="section-number">16.5.5 </span>Having both named exports and a default export in a module</h4>

<p>The following pattern is surprisingly common in JavaScript: A library is a single function, but additional services are provided via properties of that function. Examples include jQuery and Underscore.js. The following is a sketch of Underscore as a CommonJS module:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ underscore.js ------</code>
<code class="kd">var</code> <code class="nx">_</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">};</code>
<code class="kd">var</code> <code class="nx">each</code> <code class="o">=</code> <code class="nx">_</code><code class="p">.</code><code class="nx">each</code> <code class="o">=</code> <code class="nx">_</code><code class="p">.</code><code class="nx">forEach</code> <code class="o">=</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">iterator</code><code class="p">,</code> <code class="nx">context</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">};</code>
<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">_</code><code class="p">;</code>

<code class="c1">//------ main.js ------</code>
<code class="kd">var</code> <code class="nx">_</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'underscore'</code><code class="p">);</code>
<code class="kd">var</code> <code class="nx">each</code> <code class="o">=</code> <code class="nx">_</code><code class="p">.</code><code class="nx">each</code><code class="p">;</code>
<code class="err">···</code>
</pre></div>

</div>

<p>With ES6 glasses, the function <code>_</code> is the default export, while <code>each</code> and <code>forEach</code> are named exports. As it turns out, you can actually have named exports and a default export at the same time. As an example, the previous CommonJS module, rewritten as an ES6 module, looks like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ underscore.js ------</code>
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">each</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">iterator</code><code class="p">,</code> <code class="nx">context</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
<code class="kr">export</code> <code class="p">{</code> <code class="nx">each</code> <code class="nx">as</code> <code class="nx">forEach</code> <code class="p">};</code>

<code class="c1">//------ main.js ------</code>
<code class="kr">import</code> <code class="nx">_</code><code class="p">,</code> <code class="p">{</code> <code class="nx">each</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'underscore'</code><code class="p">;</code>
<code class="err">···</code>
</pre></div>

</div>

<p>Note that the CommonJS version and the ECMAScript 6 version are only roughly similar. The latter has a flat structure, whereas the former is nested.</p>

<p>For ES6 modules, I generally recommend to either only have a default export or only named exports in a single module. That is, you should not mix those different styles of exporting.</p>

<h5 id="leanpub-auto-the-default-export-is-just-another-named-export">
<span class="section-number">16.5.5.1 </span>The default export is just another named export</h5>

<p>The default export is actually just a named export with the special name <code>default</code>. That is, the following two statements are equivalent:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="p">{</code> <code class="k">default</code> <code class="nx">as</code> <code class="nx">foo</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'lib'</code><code class="p">;</code>
<code class="kr">import</code> <code class="nx">foo</code> <code class="nx">from</code> <code class="s1">'lib'</code><code class="p">;</code>
</pre></div>

</div>

<p>Similarly, the following two modules have the same default export:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//------ module1.js ------</code>
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">foo</code><code class="p">()</code> <code class="p">{}</code> <code class="c1">// function declaration!</code>

<code class="c1">//------ module2.js ------</code>
<code class="kd">function</code> <code class="nx">foo</code><code class="p">()</code> <code class="p">{}</code>
<code class="kr">export</code> <code class="p">{</code> <code class="nx">foo</code> <code class="nx">as</code> <code class="k">default</code> <code class="p">};</code>
</pre></div>

</div>

<h5 id="leanpub-auto-default-ok-as-export-name-but-not-as-variable-name">
<span class="section-number">16.5.5.2 </span><code>default</code>: OK as export name, but not as variable name</h5>

<p>You can’t use reserved words (such as <code>default</code> and <code>new</code>) as variable names, but you can use them as names for exports (you can also use them as property names in ECMAScript 5). If you want to directly import such named exports, you have to rename them to proper variables names.</p>

<p>That means that <code>default</code> can only appear on the left-hand side of a renaming import:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="p">{</code> <code class="k">default</code> <code class="nx">as</code> <code class="nx">foo</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'some_module'</code><code class="p">;</code>
</pre></div>

</div>

<p>And it can only appear on the right-hand side of a renaming export:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">export</code> <code class="p">{</code> <code class="nx">foo</code> <code class="nx">as</code> <code class="k">default</code> <code class="p">};</code>
</pre></div>

</div>

<p>In re-exporting, both sides of the <code>as</code> are export names:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// The following two statements are equivalent:</code>
<code class="kr">export</code> <code class="p">{</code> <code class="k">default</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'foo'</code><code class="p">;</code>
<code class="kr">export</code> <code class="p">{</code> <code class="k">default</code> <code class="nx">as</code> <code class="k">default</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'foo'</code><code class="p">;</code>

<code class="kr">export</code> <code class="p">{</code> <code class="nx">myFunc</code> <code class="nx">as</code> <code class="k">default</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'foo'</code><code class="p">;</code>
<code class="kr">export</code> <code class="p">{</code> <code class="k">default</code> <code class="nx">as</code> <code class="nx">otherFunc</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'foo'</code><code class="p">;</code>
</pre></div>

</div>


<h3 id="sec_module-loader-api">
<span class="section-number">16.6 </span>The ECMAScript 6 module loader API</h3>

<p>In addition to the declarative syntax for working with modules, there is also a programmatic API. It allows you to:</p>

<ul>
<li>Programmatically work with modules</li>
  <li>Configure module loading</li>
</ul>
<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-the-module-loader-api-is-not-part-of-the-es6-standard">The module loader API is not part of the ES6 standard</h3>

  <p>It will be specified in a separate document, the “JavaScript Loader Standard”, that will be evolved more dynamically than the language specification. <a href="https://github.com/whatwg/loader/">The repository for that document</a> states:</p>

  <blockquote>
    <p>[The JavaScript Loader Standard] consolidates work on the ECMAScript module loading semantics with the integration points of Web browsers, as well as Node.js.</p>
  </blockquote>

    </td>
  </tr></tbody></table>
<table class="warning sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_warning.png" alt="warning" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-the-module-loader-api-is-work-in-progress">The module loader API is work in progress</h3>

  <p>As you can see in <a href="https://github.com/whatwg/loader/">the repository of the JavaScript Loader Standard</a>, the module loader API is still work in progress. Everything you read about it in this book is tentative. To get an impression of what the API may look like, you can take a look at <a href="https://github.com/ModuleLoader/es6-module-loader">the ES6 Module Loader Polyfill</a> on GitHub.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-loaders">
<span class="section-number">16.6.1 </span>Loaders</h4>

<p>Loaders handle resolving <em>module specifiers</em> (the string IDs at the end of <code>import-from</code>), loading modules, etc. Their constructor is <code>Reflect.Loader</code>. Each platform keeps a default instance in the global variable <code>System</code> (the <em>system loader</em>), which implements its specific style of module loading.</p>

<h4 id="leanpub-auto-loader-method-importing-modules">
<span class="section-number">16.6.2 </span>Loader method: importing modules</h4>

<p>You can programmatically import a module, via an API based on <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_promises">Promises</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">System</code><code class="p">.</code><code class="kr">import</code><code class="p">(</code><code class="s1">'some_module'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">some_module</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// Use some_module</code>
<code class="p">})</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">error</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">});</code>
</pre></div>

</div>

<p><code>System.import()</code> enables you to:</p>

<ul>
<li>Use modules inside <code>&lt;script&gt;</code> elements (where module syntax is not supported, consult <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_modules-vs-scripts">the section on modules vs. scripts</a> for details).</li>
  <li>Load modules conditionally.</li>
</ul>
<p><code>System.import()</code> retrieves a single module, you can use <code>Promise.all()</code> to import several modules:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code>
    <code class="p">[</code><code class="s1">'module1'</code><code class="p">,</code> <code class="s1">'module2'</code><code class="p">,</code> <code class="s1">'module3'</code><code class="p">]</code>
    <code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">System</code><code class="p">.</code><code class="kr">import</code><code class="p">(</code><code class="nx">x</code><code class="p">)))</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(([</code><code class="nx">module1</code><code class="p">,</code> <code class="nx">module2</code><code class="p">,</code> <code class="nx">module3</code><code class="p">])</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// Use module1, module2, module3</code>
<code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-more-loader-methods">
<span class="section-number">16.6.3 </span>More loader methods</h4>

<p>Loaders have more methods. Three important ones are:</p>

<ul>
<li>
<code>System.module(source, options?)</code><br>
evaluates the JavaScript code in <code>source</code> to a module (which is delivered asynchronously via a Promise).</li>
  <li>
<code>System.set(name, module)</code><br>
is for registering a module (e.g. one you have created via <code>System.module()</code>).</li>
  <li>
<code>System.define(name, source, options?)</code><br>
both evaluates the module code in <code>source</code> and registers the result.</li>
</ul>
<h4 id="leanpub-auto-configuring-module-loading">
<span class="section-number">16.6.4 </span>Configuring module loading</h4>

<p>The module loader API will have various hooks for configuring the loading process. Use cases include:</p>

<ol class="numeric numeric">
<li>Lint modules on import (e.g. via JSLint or JSHint).</li>
  <li>Automatically translate modules on import (they could contain CoffeeScript or TypeScript code).</li>
  <li>Use legacy modules (AMD, Node.js).</li>
</ol>
<p>Configurable module loading is an area where Node.js and CommonJS are limited.</p>


<h3 id="sec_modules-in-browsers">
<span class="section-number">16.7 </span>Using ES6 modules in browsers</h3>

<p>Let’s look at how ES6 modules are supported in browsers.</p>

<table class="warning sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_warning.png" alt="warning" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-support-for-es6-modules-in-browsers-is-work-in-progress">Support for ES6 modules in browsers is work in progress</h3>

  <p>Similarly to module loading, other aspects of support for modules in browsers are still being worked on. Everything you read here may change.</p>

    </td>
  </tr></tbody></table>
<h4 id="sec_modules-vs-scripts">
<span class="section-number">16.7.1 </span>Browsers: asynchronous modules versus synchronous scripts</h4>

<p>In browsers, there are two different kinds of entities: scripts and modules. They have slightly different syntax and work differently.</p>

<p>This is an overview of the differences, details are explained later:</p>

<table>
<thead><tr>
<th>&nbsp;</th>
      <th>Scripts</th>
      <th>Modules</th>
    </tr></thead>
<tbody>
<tr>
<td>HTML element</td>
      <td><code>&lt;script&gt;</code></td>
      <td><code>&lt;script type="module"&gt;</code></td>
    </tr>
<tr>
<td>Top-level variables are</td>
      <td>global</td>
      <td>local to module</td>
    </tr>
<tr>
<td>Value of <code>this</code> at top level</td>
      <td><code>window</code></td>
      <td><code>undefined</code></td>
    </tr>
<tr>
<td>Executed</td>
      <td>synchronously</td>
      <td>asynchronously</td>
    </tr>
<tr>
<td>Import modules declaratively (<code>import</code> syntax)</td>
      <td>no</td>
      <td>yes</td>
    </tr>
<tr>
<td>Import modules via Promise-based loader API</td>
      <td>yes</td>
      <td>yes</td>
    </tr>
<tr>
<td>File extension</td>
      <td><code>.js</code></td>
      <td><code>.js</code></td>
    </tr>
</tbody>
</table>
<h5 id="leanpub-auto-scripts">
<span class="section-number">16.7.1.1 </span>Scripts</h5>

<p>Scripts are the traditional browser way to embed JavaScript and to refer to external JavaScript files. Scripts have an <a href="http://en.wikipedia.org/wiki/Internet_media_type">internet media type</a> that is used as:</p>

<ul>
<li>The content type of JavaScript files delivered via a web server.</li>
  <li>The value of the attribute <code>type</code> of <code>&lt;script&gt;</code> elements. Note that for HTML5, the recommendation is to omit the <code>type</code> attribute in <code>&lt;script&gt;</code> elements if they contain or refer to JavaScript.</li>
</ul>
<p>The following are the most important values:</p>

<ul>
<li>
<code>text/javascript</code>: is a legacy value and used as the default if you omit the <code>type</code> attribute in a script tag. It is <a href="http://stackoverflow.com/questions/359895/what-are-the-most-likely-causes-of-javascript-errors-in-ie8/703590#703590">the safest choice</a> for Internet Explorer 8 and earlier.</li>
  <li>
<code>application/javascript</code>: is <a href="http://tools.ietf.org/html/rfc4329#section-7">recommended</a> for current browsers.</li>
</ul>
<p>Scripts are normally loaded or executed synchronously. The JavaScript thread stops until the code has been loaded or executed.</p>

<h5 id="leanpub-auto-modules">
<span class="section-number">16.7.1.2 </span>Modules</h5>

<p>To be in line with JavaScript’s usual run-to-completion semantics, the body of a module must be executed without interruption. That leaves two options for importing modules:</p>

<ol class="numeric numeric">
<li>Load modules synchronously, while the body is executed. That is what Node.js does.</li>
  <li>Load all modules asynchronously, before the body is executed. That is how AMD modules are handled. It is the best option for browsers, because modules are loaded over the internet and execution doesn’t have to pause while they are. As an added benefit, this approach allows one to load multiple modules in parallel.</li>
</ol>
<p>ECMAScript 6 gives you the best of both worlds: The synchronous syntax of Node.js plus the asynchronous loading of AMD. To make both possible, ES6 modules are syntactically less flexible than Node.js modules: Imports and exports must happen at the top level. That means that they can’t be conditional, either. This restriction allows an ES6 module loader to analyze statically what modules are imported by a module and load them before executing its body.</p>

<p>The synchronous nature of scripts prevents them from becoming modules. Scripts cannot even import modules declaratively (you have to use the programmatic module loader API if you want to do so).</p>

<p>Modules can be used from browsers via a new variant of the <code>&lt;script&gt;</code> element that is completely asynchronous:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"module"</code><code class="nt">&gt;</code>
    <code class="kr">import</code> <code class="nx">$</code> <code class="nx">from</code> <code class="s1">'lib/jquery'</code><code class="p">;</code>
    <code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>

    <code class="c1">// The current scope is not global</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'$'</code> <code class="k">in</code> <code class="nb">window</code><code class="p">);</code> <code class="c1">// false</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'x'</code> <code class="k">in</code> <code class="nb">window</code><code class="p">);</code> <code class="c1">// false</code>

    <code class="c1">// `this` still refers to the global object</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="k">this</code> <code class="o">===</code> <code class="nb">window</code><code class="p">);</code> <code class="c1">// true</code>
<code class="nt">&lt;/script&gt;</code>
</pre></div>

</div>

<p>As you can see, the element has its own scope and variables “inside” it are local to that scope. Note that module code is implicitly in strict mode. This is great news – no more <code>'use strict'</code>.</p>

<p>Similar to normal <code>&lt;script&gt;</code> elements, <code>&lt;script type="module"&gt;</code> can also be used to load external modules. For example, the following tag starts a web application via a <code>main</code> module (the attribute name <code>import</code> is my invention, it isn’t yet clear what name will be used).</p>

<div class="code-block">
<div class="highlight"><pre><code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"module"</code> <code class="na">import=</code><code class="s">"impl/main"</code><code class="nt">&gt;&lt;/script&gt;</code>
</pre></div>

</div>

<p>The advantage of supporting modules in HTML via a custom <code>&lt;script&gt;</code> type is that it is easy to bring that support to older engines via a polyfill (a library). There may or may not eventually be a dedicated element for modules (e.g. <code>&lt;module&gt;</code>).</p>


<h4 id="leanpub-auto-bundling">
<span class="section-number">16.7.2 </span>Bundling</h4>

<p>Modern web applications consist of many, often small, modules. Loading those modules over HTTP impacts performance negatively, because a separate request is needed for each. Therefore, bundling multiple modules as a single file has a long tradition in the web development world. Current approaches are complex and error-prone and only work for JavaScript. There are two solutions:</p>

<ul>
<li>HTTP/2: will allow multiple requests per TCP connection, which makes bundling unnecessary. You can then incrementally update your application, because if a single module changes, browsers don’t have to download the complete bundle, again.</li>
  <li>Packages: Additionally, the W3C Technical Architecture Group is working on a standard for “<a href="https://w3ctag.github.io/packaging-on-the-web/">Packaging on the Web</a>”. The idea is to put a whole directory into a package (think ZIP file, but a different format). Then this package URL:
    <div class="code-block">
<div class="highlight"><pre>  http://example.org/downloads/editor.pack#url=/root.html;fragment=colophon
</pre></div>
    
</div>

    <p>… is equivalent to the following normal URL, if the package were unpacked into the root of the web server:</p>

    <div class="code-block">
<div class="highlight"><pre>  http://example.org/root.html#colophon
</pre></div>
    
</div>

    <p>Browsers have to make sure that once you are inside a package, relative URLs work as expected.</p>
  </li>
</ul>
<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_external-link.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h4 id="leanpub-auto-sources-of-this-section-1">Sources of this section</h4>

  <ul>
<li>“<a href="https://github.com/rwaldron/tc39-notes/blob/master/es6/2013-09/modules.pdf">Modules: Status Update</a>”, slides by David Herman.</li>
    <li>“<a href="https://mail.mozilla.org/pipermail/es-discuss/2013-November/034869.html">Modules vs Scripts</a>”, an email by David Herman.</li>
  </ul>
</td>
  </tr></tbody></table>
<h3 id="leanpub-auto-faq-modules">
<span class="section-number">16.8 </span>FAQ: modules</h3>

<h4 id="leanpub-auto-are-named-exports-necessary-why-not-simply-export-objects">
<span class="section-number">16.8.1 </span>Are named exports necessary? Why not simply export objects?</h4>

<p>You may be wondering – why do we need named exports if we could simply default-export objects (like one does in CommonJS)? The answer is that you can’t enforce a static structure via objects and lose all of the associated advantages (which are explained <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#static-module-structure">in this chapter</a>).</p>

<h4 id="leanpub-auto-can-i-eval-modules">
<span class="section-number">16.8.2 </span>Can I <code>eval()</code> modules?</h4>

<p>No, you can’t. Modules are too high-level a construct for <code>eval()</code>. The <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_module-loader-api">module loader API</a> provides the means for creating modules from strings. Syntactically, <code>eval()</code> accepts scripts, not modules.</p>


<h3 id="leanpub-auto-benefits-of-ecmascript-6-modules">
<span class="section-number">16.9 </span>Benefits of ECMAScript 6 modules</h3>

<p>At first glance, having modules built into ECMAScript 6 may seem like a boring feature – after all, we already have several good module systems. But ECMAScript 6 modules have features that you can’t add via a library, such as a more compact syntax and a static module structure (which helps with optimizations, static checking and more). They will also – hopefully – end the fragmentation between the currently dominant standards CommonJS and AMD.</p>

<p>Having a single, native standard for modules means:</p>

<ul>
<li>No more UMD (<a href="https://github.com/umdjs/umd">Universal Module Definition</a>): UMD is a name for patterns that enable the same file to be used by several module systems (e.g. both CommonJS and AMD). Once ES6 is the only module standard, UMD becomes obsolete.</li>
  <li>New browser APIs become modules instead of global variables or properties of <code>navigator</code>.</li>
  <li>No more objects-as-namespaces: Objects such as <code>Math</code> and <code>JSON</code> serve as namespaces for functions in ECMAScript 5. In the future, such functionality can be provided via modules.</li>
</ul>
<h3 id="leanpub-auto-further-reading-2">
<span class="section-number">16.10 </span>Further reading</h3>

<ul>
<li>
<strong>CommonJS vs. ES6:</strong> “<a href="http://jsmodules.io/">JavaScript Modules</a>” (by <a href="https://github.com/wycats/jsmodules">Yehuda Katz</a>) is a quick intro to ECMAScript 6 modules. Especially interesting is a <a href="http://jsmodules.io/cjs.html">second page</a> where CommonJS modules are shown side by side with their ECMAScript 6 versions.</li>
</ul>
<div class="footnotes">
  <ol>
<li id="fn-modules_1">[Spec] Function that creates the binding: <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-createimportbinding">CreateImportBinding()</a><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-modules_1" rel="rev-footnote">↩</a>
</li>
    <li id="fn-modules_2">[Spec] Sect. “<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-imports">Imports</a>” starts with grammar rules and continues with semantics.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-modules_2" rel="rev-footnote">↩</a>
</li>
    <li id="fn-modules_3">[Spec] The specification method <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-getexportednames"><code>GetExportedNames()</code></a> collects the exports of a module. In step (7.d.i), a check prevents other modules’ default exports from being re-exported.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-modules_3" rel="rev-footnote">↩</a>
</li>
    <li id="fn-modules_4">[Spec] Sect. “<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-exports">Exports</a>” starts with grammar rules and continues with semantics.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-modules_4" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h1 id="leanpub-auto-collections">
<span class="section-number">IV </span>Collections</h1>

<h2 id="ch_arrays">
<span class="section-number">17. </span>New Array features</h2>

<p>This chapter explains new Array features in ES6.</p>

<h3 id="leanpub-auto-new-static-array-methods">
<span class="section-number">17.1 </span>New static <code>Array</code> methods</h3>

<p>The object <code>Array</code> has gained methods of its own.</p>

<h4 id="leanpub-auto-arrayfromarraylike-mapfunc-thisarg">
<span class="section-number">17.1.1 </span><code>Array.from(arrayLike, mapFunc?, thisArg?)</code>
</h4>

<p><code>Array.from()</code>’s basic functionality is to convert two kinds of objects to Arrays:</p>

<ul>
<li>
<a href="http://speakingjs.com/es5/ch18.html#_pitfall_array_like_objects">Array-like objects</a>, which have a property <code>length</code> and indexed elements. Examples include the results of DOM operations such as <code>document.getElementsByClassName()</code>.</li>
  <li>
<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_iteration">Iterable objects</a>, whose contents can be retrieved one element at a time. Arrays are iterable, as are ECMAScript’s new data structures <code>Map</code> and <code>Set</code>.</li>
</ul>
<p>The following code is an example of converting an Array-like object to an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">lis</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelectorAll</code><code class="p">(</code><code class="s1">'ul.fancy li'</code><code class="p">);</code>
<code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">lis</code><code class="p">).</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">li</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">node</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<p>The result of <code>querySelectorAll()</code> is not an Array and does not have a <code>forEach()</code> method, which is why we need to convert it to an Array before we can use that method.</p>

<h5 id="leanpub-auto-mapping-via-arrayfrom">
<span class="section-number">17.1.1.1 </span>Mapping via <code>Array.from()</code>
</h5>

<p><code>Array.from()</code> is also a convenient alternative to using <code>map()</code> <a href="http://speakingjs.com/es5/ch17.html#generic_method">generically</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">spans</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelectorAll</code><code class="p">(</code><code class="s1">'span.name'</code><code class="p">);</code>

<code class="c1">// map(), generically:</code>
<code class="kd">let</code> <code class="nx">names1</code> <code class="o">=</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">map</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">spans</code><code class="p">,</code> <code class="nx">s</code> <code class="o">=&gt;</code> <code class="nx">s</code><code class="p">.</code><code class="nx">textContent</code><code class="p">);</code>

<code class="c1">// Array.from():</code>
<code class="kd">let</code> <code class="nx">names2</code> <code class="o">=</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">spans</code><code class="p">,</code> <code class="nx">s</code> <code class="o">=&gt;</code> <code class="nx">s</code><code class="p">.</code><code class="nx">textContent</code><code class="p">);</code>
</pre></div>

</div>

<p>In this example, the result of <code>document.querySelectorAll()</code> is again an Array-like object, not an Array, which is why we couldn’t invoke <code>map()</code> on it. Previously, we converted the Array-like object to an Array in order to call <code>forEach()</code>. Here, we skipped that intermediate step via a generic method call and via the two-parameter version of <code>Array.from()</code>.</p>

<h5 id="leanpub-auto-holes">
<span class="section-number">17.1.1.2 </span>Holes</h5>

<p><code>Array.from()</code> ignores holes in Arrays, it treats them as if they were <code>undefined</code> elements:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">([</code><code class="mi">0</code><code class="p">,,</code><code class="mi">2</code><code class="p">])</code>
<code class="p">[</code> <code class="mi">0</code><code class="p">,</code> <code class="n">undefined</code><code class="p">,</code> <code class="mi">2</code> <code class="p">]</code>
</pre></div>

</div>

<p>That means that you can use <code>Array.from()</code> to create and fill an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">(</code><code class="n">new</code> <code class="n">Array</code><code class="p">(</code><code class="mi">5</code><code class="p">),</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="sc">'a'</code><code class="p">)</code>
<code class="p">[</code> <code class="sc">'a'</code><code class="p">,</code> <code class="sc">'a'</code><code class="p">,</code> <code class="sc">'a'</code><code class="p">,</code> <code class="sc">'a'</code><code class="p">,</code> <code class="sc">'a'</code> <code class="p">]</code>
<code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">(</code><code class="n">new</code> <code class="n">Array</code><code class="p">(</code><code class="mi">5</code><code class="p">),</code> <code class="p">(</code><code class="n">x</code><code class="p">,</code><code class="n">i</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="n">i</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code> <code class="p">]</code>
</pre></div>

</div>

<p>If you want to fill an Array with a fixed value (first one of the previous two examples) then <code>Array.prototype.fill()</code> (see below) is a better choice.</p>

<h5 id="leanpub-auto-from-in-subclasses-of-array">
<span class="section-number">17.1.1.3 </span><code>from()</code> in subclasses of Array</h5>

<p>Another use case for <code>Array.from()</code> is to convert an Array-like or iterable object to an instance of a subclass of <code>Array</code>. For example, if you create a subclass <code>MyArray</code> of <code>Array</code> and want to convert such an object to an instance of <code>MyArray</code>, you simply use <code>MyArray.from()</code>. The reason that that works is because constructors inherit from each other in ECMAScript 6 (a super-constructor is the prototype of its sub-constructors).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">MyArray</code> <code class="kr">extends</code> <code class="nb">Array</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
<code class="kd">let</code> <code class="nx">instanceOfMyArray</code> <code class="o">=</code> <code class="nx">MyArray</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">anIterable</code><code class="p">);</code>
</pre></div>

</div>

<p>You can also combine this functionality with mapping, to get a map operation where you control the result’s constructor:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// from() – determine the result’s constructor via the receiver</code>
<code class="c1">// (in this case, MyArray)</code>
<code class="kd">let</code> <code class="nx">instanceOfMyArray</code> <code class="o">=</code> <code class="nx">MyArray</code><code class="p">.</code><code class="nx">from</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">],</code> <code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code><code class="p">);</code>

<code class="c1">// map(): the result is always an instance of Array</code>
<code class="kd">let</code> <code class="nx">instanceOfArray</code>   <code class="o">=</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">].</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">x</code><code class="p">);</code>
</pre></div>

</div>

<h4 id="leanpub-auto-arrayofitems">
<span class="section-number">17.1.2 </span><code>Array.of(...items)</code>
</h4>

<p><code>Array.of(item_0, item_1, ···)</code> creates an Array whose elements are <code>item_0</code>, <code>item_1</code>, etc.</p>

<h5 id="leanpub-auto-arrayof-as-an-array-literal-for-subclasses-of-array">
<span class="section-number">17.1.2.1 </span><code>Array.of()</code> as an Array literal for subclasses of <code>Array</code>
</h5>

<p>If you want to turn several values into an Array, you should always use an Array literal, especially since the Array constructor doesn’t work properly if there is a single value that is a number (<a href="http://speakingjs.com/es5/ch18.html#array_constructor">more information</a> on this quirk):</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">new</code> <code class="n">Array</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">8</code> <code class="p">]</code>
<code class="o">&gt;</code> <code class="n">new</code> <code class="n">Array</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>
<code class="p">[</code> <code class="p">,</code> <code class="p">,</code>  <code class="p">,]</code>
<code class="o">&gt;</code> <code class="n">new</code> <code class="n">Array</code><code class="p">(</code><code class="mf">3.1</code><code class="p">)</code>
<code class="nl">RangeError:</code> <code class="n">Invalid</code> <code class="n">array</code> <code class="n">length</code>
</pre></div>

</div>

<p>But how are you supposed to turn values into an instance of a sub-constructor of <code>Array</code> then? This is where <code>Array.of()</code> helps (remember that sub-constructors of <code>Array</code> inherit all of <code>Array</code>’s methods, including <code>of()</code>).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">MyArray</code> <code class="kr">extends</code> <code class="nb">Array</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">MyArray</code><code class="p">.</code><code class="nx">of</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="mi">11</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code> <code class="k">instanceof</code> <code class="nx">MyArray</code><code class="p">);</code> <code class="c1">// true</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">MyArray</code><code class="p">.</code><code class="nx">of</code><code class="p">(</code><code class="mi">3</code><code class="p">).</code><code class="nx">length</code> <code class="o">===</code> <code class="mi">1</code><code class="p">);</code> <code class="c1">// true</code>
</pre></div>

</div>

<h3 id="leanpub-auto-new-arrayprototype-methods">
<span class="section-number">17.2 </span>New <code>Array.prototype</code> methods</h3>

<p>Several new methods are available for Array instances.</p>

<h4 id="leanpub-auto-iterating-over-arrays">
<span class="section-number">17.2.1 </span>Iterating over Arrays</h4>

<p>The following methods help with iterating over Arrays:</p>

<ul>
<li><code>Array.prototype.entries()</code></li>
  <li><code>Array.prototype.keys()</code></li>
  <li><code>Array.prototype.values()</code></li>
</ul>
<p>The result of each of the aforementioned methods is a sequence of values, but they are not returned as an Array; they are revealed one by one, via an iterator. Let’s look at an example. I’m using <code>Array.from()</code> to put the iterators’ contents into Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">([</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">].</code><code class="n">keys</code><code class="p">())</code>
<code class="p">[</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code> <code class="p">]</code>
<code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">([</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">].</code><code class="n">values</code><code class="p">())</code>
<code class="p">[</code> <code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code> <code class="p">]</code>
<code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">([</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">].</code><code class="n">entries</code><code class="p">())</code>
<code class="p">[</code> <code class="p">[</code> <code class="mi">0</code><code class="p">,</code> <code class="sc">'a'</code> <code class="p">],</code>
  <code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="sc">'b'</code> <code class="p">]</code> <code class="p">]</code>
</pre></div>

</div>

<p>I could have also used <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_spread-operator">the spread operator (<code>...</code>)</a> to convert iterators to Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[...[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">].</code><code class="n">keys</code><code class="p">()]</code>
<code class="p">[</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code> <code class="p">]</code>
</pre></div>

</div>

<h5 id="leanpub-auto-iterating-over-index-element-pairs">
<span class="section-number">17.2.1.1 </span>Iterating over [index, element] pairs</h5>

<p>You can combine <code>entries()</code> with ECMAScript 6’s <code>for-of</code> loop and destructuring to conveniently iterate over [index, element] pairs:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">index</code><code class="p">,</code> <code class="nx">elem</code><code class="p">]</code> <code class="nx">of</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">].</code><code class="nx">entries</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">index</code><code class="p">,</code> <code class="nx">elem</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-searching-for-array-elements">
<span class="section-number">17.2.2 </span>Searching for Array elements</h4>

<p><code>Array.prototype.find(predicate, thisArg?)</code><br>
Returns the first Array element for which the callback <code>predicate</code> returns <code>true</code>. If there is no such element, it returns <code>undefined</code>. Example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="mi">6</code><code class="p">,</code> <code class="o">-</code><code class="mi">5</code><code class="p">,</code> <code class="mi">8</code><code class="p">].</code><code class="n">find</code><code class="p">(</code><code class="n">x</code> <code class="o">=&gt;</code> <code class="n">x</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code>
<code class="o">-</code><code class="mi">5</code>
<code class="o">&gt;</code> <code class="p">[</code><code class="mi">6</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">8</code><code class="p">].</code><code class="n">find</code><code class="p">(</code><code class="n">x</code> <code class="o">=&gt;</code> <code class="n">x</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code>
<code class="n">undefined</code>
</pre></div>

</div>

<p id="Array_prototype_findIndex"><code>Array.prototype.findIndex(predicate, thisArg?)</code><br>
Returns the index of the first element for which the callback <code>predicate</code> returns <code>true</code>. If there is no such element, it returns <code>-1</code>. Example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="mi">6</code><code class="p">,</code> <code class="o">-</code><code class="mi">5</code><code class="p">,</code> <code class="mi">8</code><code class="p">].</code><code class="n">findIndex</code><code class="p">(</code><code class="n">x</code> <code class="o">=&gt;</code> <code class="n">x</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code>
<code class="mi">1</code>
<code class="o">&gt;</code> <code class="p">[</code><code class="mi">6</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">8</code><code class="p">].</code><code class="n">findIndex</code><code class="p">(</code><code class="n">x</code> <code class="o">=&gt;</code> <code class="n">x</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code>
<code class="o">-</code><code class="mi">1</code>
</pre></div>

</div>

<p>The full signature of the callback <code>predicate</code> is:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">predicate</code><code class="p">(</code><code class="nx">element</code><code class="p">,</code> <code class="nx">index</code><code class="p">,</code> <code class="nx">array</code><code class="p">)</code>
</pre></div>

</div>

<h5 id="leanpub-auto-findindex-treats-holes-as-undefined-elements">
<span class="section-number">17.2.2.1 </span><code>findIndex()</code> treats holes as <code>undefined</code> elements</h5>

<p><code>findIndex()</code> treats holes as <code>undefined</code> elements (with <code>find()</code>, you wouldn’t be able to tell whether or not it does, because it returns <code>undefined</code> if it can’t find anything):</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,,</code><code class="sc">'c'</code><code class="p">].</code><code class="n">findIndex</code><code class="p">(</code><code class="n">x</code> <code class="o">=&gt;</code> <code class="n">x</code> <code class="o">===</code> <code class="n">undefined</code><code class="p">)</code>
<code class="mi">1</code>
</pre></div>

</div>

<h5 id="leanpub-auto-finding-nan-via-findindex">
<span class="section-number">17.2.2.2 </span>Finding <code>NaN</code> via <code>findIndex()</code>
</h5>

<p>A well-known <a href="http://speakingjs.com/es5/ch18.html#_searching_for_values_nondestructive">limitation</a> of <code>Array.prototype.indexOf()</code> is that it can’t find <code>NaN</code>, because it searches for elements via <code>===</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="n">NaN</code><code class="p">].</code><code class="n">indexOf</code><code class="p">(</code><code class="n">NaN</code><code class="p">)</code>
<code class="o">-</code><code class="mi">1</code>
</pre></div>

</div>

<p>With <code>findIndex()</code>, you can use <code>Object.is()</code> (explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#Object_is">the chapter on OOP</a>) and will have no such problem:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="n">NaN</code><code class="p">].</code><code class="n">findIndex</code><code class="p">(</code><code class="n">y</code> <code class="o">=&gt;</code> <code class="n">Object</code><code class="p">.</code><code class="n">is</code><code class="p">(</code><code class="n">NaN</code><code class="p">,</code> <code class="n">y</code><code class="p">))</code>
<code class="mi">0</code>
</pre></div>

</div>

<p>You can also adopt a more general approach, by creating a helper function <code>elemIs()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">function</code> <code class="nx">elemIs</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">is</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nb">Object</code><code class="p">,</code> <code class="nx">x</code><code class="p">)</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="cp">[</code><code class="m">NaN</code><code class="cp">]</code><code class="p">.</code><code class="nx">findIndex</code><code class="p">(</code><code class="nx">elemIs</code><code class="p">(</code><code class="kc">NaN</code><code class="p">))</code>
<code class="mi">0</code>
</pre></div>

</div>

<h4 id="leanpub-auto-arrayprototypefillvalue-start-end">
<span class="section-number">17.2.3 </span><code>Array.prototype.fill(value, start?, end?)</code>
</h4>

<p>Fills an Array with the given <code>value</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">,</code> <code class="sc">'c'</code><code class="p">].</code><code class="n">fill</code><code class="p">(</code><code class="mi">7</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code> <code class="p">]</code>
</pre></div>

</div>

<p>Holes get no special treatment:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">new</code> <code class="n">Array</code><code class="p">(</code><code class="mi">3</code><code class="p">).</code><code class="n">fill</code><code class="p">(</code><code class="mi">7</code><code class="p">)</code>
<code class="p">[</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code> <code class="p">]</code>
</pre></div>

</div>

<p>Optionally, you can restrict where the filling starts and ends:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">,</code> <code class="sc">'c'</code><code class="p">].</code><code class="n">fill</code><code class="p">(</code><code class="mi">7</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>
<code class="p">[</code> <code class="sc">'a'</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="sc">'c'</code> <code class="p">]</code>
</pre></div>

</div>

<h2 id="ch_maps-sets">
<span class="section-number">18. </span>Maps and Sets</h2>

<p>Among others, the following four data structures are new in ECMAScript 6: <code>Map</code>, <code>WeakMap</code>, <code>Set</code> and <code>WeakSet</code>. This chapter explains how they work.</p>


<h3 id="leanpub-auto-overview-11">
<span class="section-number">18.1 </span>Overview</h3>

<h4 id="leanpub-auto-maps">
<span class="section-number">18.1.1 </span>Maps</h4>

<p>The keys of a Map can be arbitrary values:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">map</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Map</code><code class="p">();</code> <code class="c1">// create an empty Map</code>
<code class="o">&gt;</code> <code class="k">const</code> <code class="n">KEY</code> <code class="o">=</code> <code class="p">{};</code>

<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="n">KEY</code><code class="p">,</code> <code class="mi">123</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="n">KEY</code><code class="p">)</code>
<code class="mi">123</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">has</code><code class="p">(</code><code class="n">KEY</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">delete</code><code class="p">(</code><code class="n">KEY</code><code class="p">);</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">has</code><code class="p">(</code><code class="n">KEY</code><code class="p">)</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>You can use an Array (or any iterable) with [key, value] pairs to set up the initial data in the Map:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">([</code>
    <code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'one'</code> <code class="p">],</code>
    <code class="p">[</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'two'</code> <code class="p">],</code>
    <code class="p">[</code> <code class="mi">3</code><code class="p">,</code> <code class="s1">'three'</code> <code class="p">],</code> <code class="c1">// trailing comma is ignored</code>
<code class="p">]);</code>
</pre></div>

</div>

<h4 id="leanpub-auto-sets">
<span class="section-number">18.1.2 </span>Sets</h4>

<p>A Set is a collection of unique elements:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">let</code> <code class="n">arr</code> <code class="o">=</code> <code class="p">[</code><code class="mi">5</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">7</code><code class="p">,</code> <code class="mi">5</code><code class="p">];</code>
<code class="n">let</code> <code class="n">unique</code> <code class="o">=</code> <code class="p">[...</code><code class="n">new</code> <code class="n">Set</code><code class="p">(</code><code class="n">arr</code><code class="p">)];</code> <code class="c1">// [ 5, 1, 7 ]</code>
</pre></div>

</div>

<p>As you can see, you can initialize a Set with elements if you hand the constructor an iterable (<code>arr</code> in the example) over those elements.</p>

<h4 id="leanpub-auto-weakmaps">
<span class="section-number">18.1.3 </span>WeakMaps</h4>

<p>A WeakMap is a Map that doesn’t prevent its keys from being garbage-collected. That means that you can associate private data with objects without having to worry about memory leaks:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">_counter</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kd">let</code> <code class="nx">_action</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kr">class</code> <code class="nx">Countdown</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">counter</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">counter</code><code class="p">);</code>
        <code class="nx">_action</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">action</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="nx">dec</code><code class="p">()</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">counter</code> <code class="o">=</code> <code class="nx">_counter</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">counter</code> <code class="o">&lt;</code> <code class="mi">1</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>
        <code class="nx">counter</code><code class="o">--</code><code class="p">;</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">counter</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">counter</code> <code class="o">===</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">_action</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">)();</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>


<h3 id="leanpub-auto-map">
<span class="section-number">18.2 </span>Map</h3>

<p>JavaScript has always had a very spartan standard library. Sorely missing was a data structure for mapping values to values. The best you can get in ECMAScript 5 is a Map from strings to arbitrary values, by abusing objects. Even then there are <a href="http://speakingjs.com/es5/ch17.html#_pitfalls_using_an_object_as_a_map">several pitfalls</a> that can trip you up.</p>

<p>The <code>Map</code> data structure in ECMAScript 6 lets you use arbitrary values as keys and is highly welcome.</p>

<h4 id="leanpub-auto-basic-operations">
<span class="section-number">18.2.1 </span>Basic operations</h4>

<p>Working with single entries:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">map</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Map</code><code class="p">();</code>

<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">,</code> <code class="mi">123</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">)</code>
<code class="mi">123</code>

<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">has</code><code class="p">(</code><code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">delete</code><code class="p">(</code><code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">has</code><code class="p">(</code><code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">)</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>Determining the size of a Map and clearing it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">map</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Map</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">,</code> <code class="nb">true</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="err">'</code><code class="n">bar</code><code class="err">'</code><code class="p">,</code> <code class="nb">false</code><code class="p">);</code>

<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">size</code>
<code class="mi">2</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">clear</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">size</code>
<code class="mi">0</code>
</pre></div>

</div>

<h4 id="leanpub-auto-setting-up-a-map">
<span class="section-number">18.2.2 </span>Setting up a Map</h4>

<p>You can set up a Map via an iterable over key-value “pairs” (Arrays with 2 elements). One possibility is to use an Array (which is iterable):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">([</code>
    <code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'one'</code> <code class="p">],</code>
    <code class="p">[</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'two'</code> <code class="p">],</code>
    <code class="p">[</code> <code class="mi">3</code><code class="p">,</code> <code class="s1">'three'</code> <code class="p">],</code> <code class="c1">// trailing comma is ignored</code>
<code class="p">]);</code>
</pre></div>

</div>

<p>Alternatively, the <code>set()</code> method is chainable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">()</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="s1">'one'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="s1">'two'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="s1">'three'</code><code class="p">);</code>
</pre></div>

</div>

<h4 id="leanpub-auto-keys">
<span class="section-number">18.2.3 </span>Keys</h4>

<p>Any value can be a key, even an object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">();</code>

<code class="kr">const</code> <code class="nx">KEY1</code> <code class="o">=</code> <code class="p">{};</code>
<code class="nx">map</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="nx">KEY1</code><code class="p">,</code> <code class="s1">'hello'</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">map</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">KEY1</code><code class="p">));</code> <code class="c1">// hello</code>

<code class="kr">const</code> <code class="nx">KEY2</code> <code class="o">=</code> <code class="p">{};</code>
<code class="nx">map</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="nx">KEY2</code><code class="p">,</code> <code class="s1">'world'</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">map</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">KEY2</code><code class="p">));</code> <code class="c1">// world</code>
</pre></div>

</div>

<h5 id="leanpub-auto-what-keys-are-considered-equal">
<span class="section-number">18.2.3.1 </span>What keys are considered equal?</h5>

<p>Most Map operations need to check whether a value is equal to one of the keys. They do so via the internal operation <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-samevaluezero">SameValueZero</a>, which works like <code>===</code>, but considers <code>NaN</code> to be equal to itself.</p>

<p>Let’s first see how <code>===</code> handles <code>NaN</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">NaN</code> <code class="o">===</code> <code class="n">NaN</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>Conversely, you can use <code>NaN</code> as a key in Maps, just like any other value:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">map</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Map</code><code class="p">();</code>

<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="n">NaN</code><code class="p">,</code> <code class="mi">123</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="n">NaN</code><code class="p">)</code>
<code class="mi">123</code>
</pre></div>

</div>

<p>Like <code>===</code>, <code>-0</code> and <code>+0</code> are considered the same value. That is normally the best way to handle the two zeros (<a href="http://speakingjs.com/es5/ch11.html#two_zeros">details are explained in “Speaking JavaScript”</a>).</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">set</code><code class="p">(</code><code class="o">-</code><code class="mi">0</code><code class="p">,</code> <code class="mi">123</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="o">+</code><code class="mi">0</code><code class="p">)</code>
<code class="mi">123</code>
</pre></div>

</div>

<p>Different objects are always considered different. That is something that can’t be configured (yet), <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_configuring-comparison-maps-sets">as explained later, in the FAQ</a>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">new</code> <code class="n">Map</code><code class="p">().</code><code class="n">set</code><code class="p">({},</code> <code class="mi">1</code><code class="p">).</code><code class="n">set</code><code class="p">({},</code> <code class="mi">2</code><code class="p">).</code><code class="n">size</code>
<code class="mi">2</code>
</pre></div>

</div>

<p>Getting an unknown key produces <code>undefined</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">new</code> <code class="n">Map</code><code class="p">().</code><code class="n">get</code><code class="p">(</code><code class="err">'</code><code class="n">asfddfsasadf</code><code class="err">'</code><code class="p">)</code>
<code class="n">undefined</code>
</pre></div>

</div>

<h4 id="leanpub-auto-iterating">
<span class="section-number">18.2.4 </span>Iterating</h4>

<p>Let’s set up a Map to demonstrate how one can iterate over it.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">([</code>
    <code class="p">[</code><code class="kc">false</code><code class="p">,</code> <code class="s1">'no'</code><code class="p">],</code>
    <code class="p">[</code><code class="kc">true</code><code class="p">,</code>  <code class="s1">'yes'</code><code class="p">],</code>
<code class="p">]);</code>
</pre></div>

</div>

<p>Maps record the order in which elements are inserted and honor that order when iterating over keys, values or entries.</p>

<h5 id="leanpub-auto-iterables-for-keys-and-values">
<span class="section-number">18.2.4.1 </span>Iterables for keys and values</h5>

<p><code>keys()</code> returns an <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_iteration">iterable</a> over the keys in the Map:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">key</code> <code class="nx">of</code> <code class="nx">map</code><code class="p">.</code><code class="nx">keys</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">key</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// false</code>
<code class="c1">// true</code>
</pre></div>

</div>

<p><code>values()</code> returns an iterable over the values in the Map:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">value</code> <code class="nx">of</code> <code class="nx">map</code><code class="p">.</code><code class="nx">values</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// no</code>
<code class="c1">// yes</code>
</pre></div>

</div>

<h5 id="leanpub-auto-iterables-for-entries">
<span class="section-number">18.2.4.2 </span>Iterables for entries</h5>

<p><code>entries()</code> returns the entries of the Map as an iterable over [key,value] pairs (Arrays).</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">entry</code> <code class="nx">of</code> <code class="nx">map</code><code class="p">.</code><code class="nx">entries</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">entry</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code> <code class="nx">entry</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// false no</code>
<code class="c1">// true yes</code>
</pre></div>

</div>

<p>Destructuring enables you to access the keys and values directly:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">map</code><code class="p">.</code><code class="nx">entries</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The default way of iterating over a Map is <code>entries()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">map</code><code class="p">[</code><code class="n">Symbol</code><code class="p">.</code><code class="n">iterator</code><code class="p">]</code> <code class="o">===</code> <code class="n">map</code><code class="p">.</code><code class="n">entries</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>Thus, you can make the previous code snippet even shorter:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">map</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="sec_spreading-maps">
<span class="section-number">18.2.4.3 </span>Turning iterables into Arrays</h5>

<p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_spread-operator">The spread operator (<code>...</code>)</a> can turn an iterable into the elements of an Array. That lets us convert the result of <code>Map.prototype.keys()</code> (an iterable) into an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">map</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Map</code><code class="p">().</code><code class="n">set</code><code class="p">(</code><code class="nb">false</code><code class="p">,</code> <code class="err">'</code><code class="n">no</code><code class="err">'</code><code class="p">).</code><code class="n">set</code><code class="p">(</code><code class="nb">true</code><code class="p">,</code> <code class="err">'</code><code class="n">yes</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="p">[...</code><code class="n">map</code><code class="p">.</code><code class="n">keys</code><code class="p">()]</code>
<code class="p">[</code> <code class="nb">false</code><code class="p">,</code> <code class="nb">true</code> <code class="p">]</code>
</pre></div>

</div>

<p>Maps are also iterable, which means that the spread operator can turn Maps into Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">map</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Map</code><code class="p">().</code><code class="n">set</code><code class="p">(</code><code class="nb">false</code><code class="p">,</code> <code class="err">'</code><code class="n">no</code><code class="err">'</code><code class="p">).</code><code class="n">set</code><code class="p">(</code><code class="nb">true</code><code class="p">,</code> <code class="err">'</code><code class="n">yes</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="p">[...</code><code class="n">map</code><code class="p">]</code>
<code class="p">[</code> <code class="p">[</code> <code class="nb">false</code><code class="p">,</code> <code class="err">'</code><code class="n">no</code><code class="err">'</code> <code class="p">],</code>
  <code class="p">[</code> <code class="nb">true</code><code class="p">,</code> <code class="err">'</code><code class="n">yes</code><code class="err">'</code> <code class="p">]</code> <code class="p">]</code>
</pre></div>

</div>

<h4 id="leanpub-auto-looping-over-entries">
<span class="section-number">18.2.5 </span>Looping over entries</h4>

<p>The <code>Map</code> method <code>forEach</code> has the following signature:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Map</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">forEach</code><code class="p">((</code><code class="nx">value</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">map</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="k">void</code><code class="p">,</code> <code class="nx">thisArg</code><code class="o">?</code><code class="p">)</code> <code class="o">:</code> <code class="k">void</code>
</pre></div>

</div>

<p>The signature of the first parameter mirrors the signature of the callback of <code>Array.prototype.forEach</code>, which is why the value comes first.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">([</code>
    <code class="p">[</code><code class="kc">false</code><code class="p">,</code> <code class="s1">'no'</code><code class="p">],</code>
    <code class="p">[</code><code class="kc">true</code><code class="p">,</code>  <code class="s1">'yes'</code><code class="p">],</code>
<code class="p">]);</code>
<code class="nx">map</code><code class="p">.</code><code class="nx">forEach</code><code class="p">((</code><code class="nx">value</code><code class="p">,</code> <code class="nx">key</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">);</code>
<code class="p">});</code>
<code class="c1">// Output:</code>
<code class="c1">// false no</code>
<code class="c1">// true yes</code>
</pre></div>

</div>

<h4 id="leanpub-auto-mapping-and-filtering-maps">
<span class="section-number">18.2.6 </span>Mapping and filtering Maps</h4>

<p>You can <code>map()</code> and <code>filter()</code> Arrays, but there are no such operations for Maps. The solution:</p>

<ol class="numeric numeric">
<li>Convert the Map into an Array of [key,value] pairs.</li>
  <li>Map or filter the Array.</li>
  <li>Convert the result back to a Map.</li>
</ol>
<p>I’ll use the following Map to demonstrate how that works.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">originalMap</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">()</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="s1">'a'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">);</code>
</pre></div>

</div>

<p>Mapping <code>originalMap</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">mappedMap</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">(</code> <code class="c1">// step 3</code>
    <code class="p">[...</code><code class="nx">originalMap</code><code class="p">]</code> <code class="c1">// step 1</code>
    <code class="p">.</code><code class="nx">map</code><code class="p">(([</code><code class="nx">k</code><code class="p">,</code> <code class="nx">v</code><code class="p">])</code> <code class="o">=&gt;</code> <code class="p">[</code><code class="nx">k</code> <code class="o">*</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'_'</code> <code class="o">+</code> <code class="nx">v</code><code class="p">])</code> <code class="c1">// step 2</code>
<code class="p">);</code>
<code class="c1">// Resulting Map: {2 =&gt; '_a', 4 =&gt; '_b', 6 =&gt; '_c'}</code>
</pre></div>

</div>

<p>Filtering <code>originalMap</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">filteredMap</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">(</code> <code class="c1">// step 3</code>
    <code class="p">[...</code><code class="nx">originalMap</code><code class="p">]</code> <code class="c1">// step 1</code>
    <code class="p">.</code><code class="nx">filter</code><code class="p">(([</code><code class="nx">k</code><code class="p">,</code> <code class="nx">v</code><code class="p">])</code> <code class="o">=&gt;</code> <code class="nx">k</code> <code class="o">&lt;</code> <code class="mi">3</code><code class="p">)</code> <code class="c1">// step 2</code>
<code class="p">);</code>
<code class="c1">// Resulting Map: {1 =&gt; 'a', 2 =&gt; 'b'}</code>
</pre></div>

</div>

<p>Step 1 is performed by the spread operator (<code>...</code>) which <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_spreading-maps">I have explained previously</a>.</p>

<h4 id="leanpub-auto-combining-maps">
<span class="section-number">18.2.7 </span>Combining Maps</h4>

<p>There are no methods for combining Maps, which is why the approach from the previous section must be used to do so.</p>

<p>Let’s combine the following two Maps:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map1</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">()</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="s1">'a1'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="s1">'b1'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="s1">'c1'</code><code class="p">);</code>

<code class="kd">let</code> <code class="nx">map2</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">()</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="s1">'b2'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="s1">'c2'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="s1">'d2'</code><code class="p">);</code>
</pre></div>

</div>

<p>To combine <code>map1</code> and <code>map2</code>, I turn them into Arrays via the spread operator (<code>...</code>) and concatenate those Arrays. Afterwards, I convert the result back to a Map. All of that is done in the first line.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">combinedMap</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Map</code><code class="p">([...</code><code class="n">map1</code><code class="p">,</code> <code class="p">...</code><code class="n">map2</code><code class="p">])</code>
<code class="o">&gt;</code> <code class="p">[...</code><code class="n">combinedMap</code><code class="p">]</code> <code class="c1">// convert to Array to display</code>
<code class="p">[</code> <code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="err">'</code><code class="n">a1</code><code class="err">'</code> <code class="p">],</code>
  <code class="p">[</code> <code class="mi">2</code><code class="p">,</code> <code class="err">'</code><code class="n">b2</code><code class="err">'</code> <code class="p">],</code>
  <code class="p">[</code> <code class="mi">3</code><code class="p">,</code> <code class="err">'</code><code class="n">c2</code><code class="err">'</code> <code class="p">],</code>
  <code class="p">[</code> <code class="mi">4</code><code class="p">,</code> <code class="err">'</code><code class="n">d2</code><code class="err">'</code> <code class="p">]</code> <code class="p">]</code>
</pre></div>

</div>

<h4 id="leanpub-auto-map-api">
<span class="section-number">18.2.8 </span>Map API</h4>

<p><strong>Constructor:</strong></p>

<ul>
<li>
<code>new Map(entries? : Iterable&lt;[any,any]&gt;)</code><br>
  If you don’t provide the parameter <code>iterable</code> then an empty Map is created. If you do provide an iterable over [key, value] pairs then those pairs are used to add entries to the Map. For example:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">([</code>
      <code class="p">[</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'one'</code> <code class="p">],</code>
      <code class="p">[</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'two'</code> <code class="p">],</code>
      <code class="p">[</code> <code class="mi">3</code><code class="p">,</code> <code class="s1">'three'</code> <code class="p">],</code> <code class="c1">// trailing comma is ignored</code>
  <code class="p">]);</code>
</pre></div>
    
</div>
  </li>
</ul>
<p><strong>Handling single entries:</strong></p>

<ul>
<li>
<code>Map.prototype.get(key) : any</code><br>
Returns the <code>value</code> that <code>key</code> is mapped to in this Map. If there is no key <code>key</code> in this Map, <code>undefined</code> is returned.</li>
  <li>
<code>Map.prototype.set(key, value) : this</code><br>
Maps the given key to the given value. If there is already an entry whose key is <code>key</code>, it is updated. Otherwise, a new entry is created. This method returns <code>this</code>, which means that you can chain it.</li>
  <li>
<code>Map.prototype.has(key) : boolean</code><br>
Returns whether the given key exists in this Map.</li>
  <li>
<code>Map.prototype.delete(key) : boolean</code><br>
If there is an entry whose key is <code>key</code>, it is removed and <code>true</code> is returned. Otherwise, nothing happens and <code>false</code> is returned.</li>
</ul>
<p><strong>Handling all entries:</strong></p>

<ul>
<li>
<code>get Map.prototype.size : number</code><br>
Returns how many entries there are in this Map.</li>
  <li>
<code>Map.prototype.clear() : void</code><br>
Removes all entries from this Map.</li>
</ul>
<p><strong>Iterating and looping:</strong> happens in the order in which entries were added to a Map.</p>

<ul>
<li>
<code>Map.prototype.entries() : Iterable&lt;[any,any]&gt;</code><br>
Returns an iterable with one [key,value] pair for each entry in this Map. The pairs are Arrays of length 2.</li>
  <li>
<code>Map.prototype.forEach((value, key, collection) =&gt; void, thisArg?) : void</code><br>
The first parameter is a callback that is invoked once for each entry in this Map. If <code>thisArg</code> is provided, <code>this</code> is set to it for each invocation. Otherwise, <code>this</code> is set to <code>undefined</code>.</li>
  <li>
<code>Map.prototype.keys() : Iterable&lt;any&gt;</code><br>
Returns an iterable over all keys in this Map.</li>
  <li>
<code>Map.prototype.values() : Iterable&lt;any&gt;</code><br>
Returns an iterable over all values in this Map.</li>
  <li>
<code>Map.prototype[Symbol.iterator]() : Iterable&lt;[any,any]&gt;</code><br>
The default way of iterating over Maps. Refers to <code>Map.prototype.entries</code>.</li>
</ul>
<h3 id="sec_weakmap">
<span class="section-number">18.3 </span>WeakMap</h3>

<p>A <code>WeakMap</code> is a Map that doesn’t prevent its keys from being garbage-collected. That means that you can associate data with objects without having to worry about memory leaks.</p>

<p>A WeakMap is a data structure whose keys must be objects and whose values can be arbitrary values. It has the same API as <code>Map</code>, with one significant difference: you can’t iterate over the contents – neither the keys, nor the values, nor the entries. You can’t clear a WeakMap, either.</p>

<p>The rationales for these restrictions are:</p>

<ul>
<li>The volatility of WeakMaps makes iteration difficult.</li>
  <li>Not having <code>clear()</code> provides a security property. Quoting <a href="https://github.com/rwaldron/tc39-notes/blob/master/es6/2014-11/nov-19.md#412-should-weakmapweakset-have-a-clear-method-markm">Mark Miller</a>: “The mapping from weakmap/key pair value can only be observed or affected by someone who has both the weakmap and the key. With <code>clear()</code>, someone with only the WeakMap would’ve been able to affect the WeakMap-and-key-to-value mapping.”</li>
</ul>
<h4 id="sec_weakmaps-private-data">
<span class="section-number">18.3.1 </span>Using WeakMaps for private data</h4>

<p>Until now, there were two common ways to store private data and methods for objects<sup id="fnref-maps-sets_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-maps-sets_1" rel="footnote">1</a></sup>:</p>

<ol class="numeric numeric">
<li>Via a naming convention for property keys</li>
  <li>In the environment of a constructor</li>
</ol>
<p>There is a neat technique involving WeakMaps that combines the advantage of the first apporach (simpler code) with the advantage of the second apporach (complete safety). That technique is demonstrated in the following code: it uses the WeakMaps <code>_counter</code> and <code>_action</code> to store private data.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">_counter</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kd">let</code> <code class="nx">_action</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kr">class</code> <code class="nx">Countdown</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">counter</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">counter</code><code class="p">);</code>
        <code class="nx">_action</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">action</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="nx">dec</code><code class="p">()</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">counter</code> <code class="o">=</code> <code class="nx">_counter</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">counter</code> <code class="o">&lt;</code> <code class="mi">1</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>
        <code class="nx">counter</code><code class="o">--</code><code class="p">;</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">counter</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">counter</code> <code class="o">===</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">_action</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">)();</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Each of the two WeakMaps <code>_counter</code> and <code>_action</code> maps objects to private data. Due to how WeakMaps work that won’t prevent objects from being garbage-collected. As long as you keep the WeakMaps hidden from the outside world, the private data is safe.</p>

<p>Let’s use <code>Countdown</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">c</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Countdown</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="n">console</code><code class="p">.</code><code class="n">log</code><code class="p">(</code><code class="err">'</code><code class="n">DONE</code><code class="err">'</code><code class="p">));</code>
<code class="o">&gt;</code> <code class="n">c</code><code class="p">.</code><code class="n">dec</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">c</code><code class="p">.</code><code class="n">dec</code><code class="p">();</code>
<code class="n">DONE</code>
</pre></div>

</div>

<p>Because <code>Countdown</code> keeps instance-specific data elsewhere, its instance <code>c</code> has no own property keys:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Reflect</code><code class="p">.</code><code class="n">ownKeys</code><code class="p">(</code><code class="n">c</code><code class="p">)</code>
<code class="p">[]</code>
</pre></div>

</div>

<h4 id="leanpub-auto-weakmap-api">
<span class="section-number">18.3.2 </span>WeakMap API</h4>

<p>The constructor and the four methods of <code>WeakMap</code> work the same as their <code>Map</code> equivalents:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">new</code> <code class="nx">WeakMap</code><code class="p">(</code><code class="nx">entries</code><code class="o">?</code> <code class="o">:</code> <code class="nx">Iterable</code><code class="o">&lt;</code><code class="p">[</code><code class="nx">any</code><code class="p">,</code><code class="nx">any</code><code class="p">]</code><code class="o">&gt;</code><code class="p">)</code>

<code class="nx">WeakMap</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="o">:</code> <code class="nx">any</code>
<code class="nx">WeakMap</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">)</code> <code class="o">:</code> <code class="k">this</code>
<code class="nx">WeakMap</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="o">:</code> <code class="kr">boolean</code>
<code class="nx">WeakMap</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="k">delete</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="o">:</code> <code class="kr">boolean</code>
</pre></div>

</div>


<h3 id="leanpub-auto-set">
<span class="section-number">18.4 </span>Set</h3>

<p>ECMAScript 5 doesn’t have a Set data structure, either. There are two possible work-arounds:</p>

<ul>
<li>Use the keys of an object to store the elements of a set of strings.</li>
  <li>Store (arbitrary) set elements in an Array: Check whether it contains an element via <code>indexOf()</code>, remove elements via <code>filter()</code>, etc. This is not a very fast solution, but it’s easy to implement. One issue to be aware of is that <code>indexOf()</code> can’t find the value <code>NaN</code>.</li>
</ul>
<p>ECMAScript 6 has the data structure <code>Set</code> which works for arbitrary values, is fast and handles <code>NaN</code> correctly.</p>

<h4 id="leanpub-auto-basic-operations-1">
<span class="section-number">18.4.1 </span>Basic operations</h4>

<p>Managing single elements:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">set</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Set</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="err">'</code><code class="n">red</code><code class="err">'</code><code class="p">)</code>

<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">has</code><code class="p">(</code><code class="err">'</code><code class="n">red</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">delete</code><code class="p">(</code><code class="err">'</code><code class="n">red</code><code class="err">'</code><code class="p">)</code>
<code class="nb">true</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">has</code><code class="p">(</code><code class="err">'</code><code class="n">red</code><code class="err">'</code><code class="p">)</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>Determining the size of a Set and clearing it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">set</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Set</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="err">'</code><code class="n">red</code><code class="err">'</code><code class="p">)</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="err">'</code><code class="n">green</code><code class="err">'</code><code class="p">)</code>

<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">size</code>
<code class="mi">2</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">clear</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">size</code>
<code class="mi">0</code>
</pre></div>

</div>

<h4 id="leanpub-auto-setting-up-a-set">
<span class="section-number">18.4.2 </span>Setting up a Set</h4>

<p>You can set up a Set via an iterable over the elements that make up the Set. For example, via an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="s1">'red'</code><code class="p">,</code> <code class="s1">'green'</code><code class="p">,</code> <code class="s1">'blue'</code><code class="p">]);</code>
</pre></div>

</div>

<p>Alternatively, the <code>add</code> method is chainable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">().</code><code class="nx">add</code><code class="p">(</code><code class="s1">'red'</code><code class="p">).</code><code class="nx">add</code><code class="p">(</code><code class="s1">'green'</code><code class="p">).</code><code class="nx">add</code><code class="p">(</code><code class="s1">'blue'</code><code class="p">);</code>
</pre></div>

</div>

<h5 id="leanpub-auto-pitfall-new-set-has-at-most-one-argument">
<span class="section-number">18.4.2.1 </span>Pitfall: <code>new Set()</code> has at most one argument</h5>

<p>The <code>Set</code> constructor has zero or one arguments:</p>

<ul>
<li>Zero arguments: an empty Set is created.</li>
  <li>One argument: the argument needs to be iterable; the iterated items define the elements of the Set.</li>
</ul>
<p>Further arguments are ignored, which may lead to unexpected results:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">(</code><code class="n">new</code> <code class="n">Set</code><code class="p">([</code><code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">bar</code><code class="err">'</code><code class="p">]))</code>
<code class="p">[</code> <code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">bar</code><code class="err">'</code> <code class="p">]</code>
<code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">(</code><code class="n">new</code> <code class="n">Set</code><code class="p">(</code><code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">bar</code><code class="err">'</code><code class="p">))</code>
<code class="p">[</code> <code class="sc">'f'</code><code class="p">,</code> <code class="sc">'o'</code> <code class="p">]</code>
</pre></div>

</div>

<p>For the second Set, only <code>'foo'</code> is used (which is iterable) to define the Set.</p>

<h4 id="leanpub-auto-comparing-set-elements">
<span class="section-number">18.4.3 </span>Comparing Set elements</h4>

<p>As with Maps, elements are compared similarly to <code>===</code>, with the exception of <code>NaN</code> being like any other value.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">set</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Set</code><code class="p">([</code><code class="n">NaN</code><code class="p">]);</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">size</code>
<code class="mi">1</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">has</code><code class="p">(</code><code class="n">NaN</code><code class="p">)</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>Adding an element a second time has no effect:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">set</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Set</code><code class="p">();</code>

<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">size</code>
<code class="mi">1</code>

<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="err">'</code><code class="n">foo</code><code class="err">'</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">size</code>
<code class="mi">1</code>
</pre></div>

</div>

<p>Similarly to <code>===</code>, two different objects are never considered equal (which can’t currently be customized, <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_configuring-comparison-maps-sets">as explained later, in the FAQ</a>, later):</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">set</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Set</code><code class="p">();</code>

<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">add</code><code class="p">({});</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">size</code>
<code class="mi">1</code>

<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">add</code><code class="p">({});</code>
<code class="o">&gt;</code> <code class="n">set</code><code class="p">.</code><code class="n">size</code>
<code class="mi">2</code>
</pre></div>

</div>

<h4 id="leanpub-auto-iterating-1">
<span class="section-number">18.4.4 </span>Iterating</h4>

<p>Sets are iterable and the <code>for-of</code> loop works as you’d expect:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="s1">'red'</code><code class="p">,</code> <code class="s1">'green'</code><code class="p">,</code> <code class="s1">'blue'</code><code class="p">]);</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">set</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// red</code>
<code class="c1">// green</code>
<code class="c1">// blue</code>
</pre></div>

</div>

<p>As you can see, Sets preserve iteration order. That is, elements are always iterated over in the order in which they were inserted.</p>

<p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_spreading-maps">The previously explained spread operator (<code>...</code>)</a> works with iterables and thus lets you convert a Set to an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="s1">'red'</code><code class="p">,</code> <code class="s1">'green'</code><code class="p">,</code> <code class="s1">'blue'</code><code class="p">]);</code>
<code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">set</code><code class="p">];</code> <code class="c1">// ['red', 'green', 'blue']</code>
</pre></div>

</div>

<p>We now have a concise way to convert an Array to a Set and back, which has the effect of eliminating duplicates from the Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[</code><code class="mi">3</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">5</code><code class="p">];</code>
<code class="kd">let</code> <code class="nx">unique</code> <code class="o">=</code> <code class="p">[...</code><code class="k">new</code> <code class="nx">Set</code><code class="p">(</code><code class="nx">arr</code><code class="p">)];</code> <code class="c1">// [3, 5, 2]</code>
</pre></div>

</div>

<h4 id="leanpub-auto-mapping-and-filtering">
<span class="section-number">18.4.5 </span>Mapping and filtering</h4>

<p>In contrast to Arrays, Sets don’t have the methods <code>map()</code> and <code>filter()</code>. A work-around is to convert them to Arrays and back.</p>

<p>Mapping:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">]);</code>
<code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([...</code><code class="nx">set</code><code class="p">].</code><code class="nx">map</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">x</code> <code class="o">*</code> <code class="mi">2</code><code class="p">));</code>
<code class="c1">// Resulting Set: {2, 4, 6}</code>
</pre></div>

</div>

<p>Filtering:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">]);</code>
<code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([...</code><code class="nx">set</code><code class="p">].</code><code class="nx">filter</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="p">(</code><code class="nx">x</code> <code class="o">%</code> <code class="mi">2</code><code class="p">)</code> <code class="o">==</code> <code class="mi">0</code><code class="p">));</code>
<code class="c1">// Resulting Set: {2, 4}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-union-intersection-difference">
<span class="section-number">18.4.6 </span>Union, intersection, difference</h4>

<p>ECMAScript 6 Sets have no methods for computing the union (e.g. <code>addAll</code>), intersection (e.g. <code>retainAll</code>) or difference (e.g. <code>removeAll</code>). This section explains how to work around that limitation.</p>

<h5 id="leanpub-auto-union">
<span class="section-number">18.4.6.1 </span>Union</h5>

<p>Union (<code>a</code> ∪ <code>b</code>): create a Set that contains the elements of both Set <code>a</code> and Set <code>b</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">a</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">]);</code>
<code class="kd">let</code> <code class="nx">b</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="mi">4</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">2</code><code class="p">]);</code>
<code class="kd">let</code> <code class="nx">union</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([...</code><code class="nx">a</code><code class="p">,</code> <code class="p">...</code><code class="nx">b</code><code class="p">]);</code>
    <code class="c1">// {1,2,3,4}</code>
</pre></div>

</div>

<p>The pattern is always the same:</p>

<ul>
<li>Convert one or both Sets to Arrays.</li>
  <li>Perform the operation.</li>
  <li>Convert the result back to a Set.</li>
</ul>
<p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_spread-operator">The spread operator (<code>...</code>)</a> inserts the elements of something iterable (such as a Set) into an Array. Therefore, <code>[...a, ...b]</code> means that <code>a</code> and <code>b</code> are converted to Arrays and concatenated. It is equivalent to <code>[...a].concat([...b])</code>.</p>

<h5 id="leanpub-auto-intersection">
<span class="section-number">18.4.6.2 </span>Intersection</h5>

<p>Intersection (<code>a</code> ∩ <code>b</code>): create a Set that contains those elements of Set <code>a</code> that are also in Set <code>b</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">a</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">]);</code>
<code class="kd">let</code> <code class="nx">b</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="mi">4</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">2</code><code class="p">]);</code>
<code class="kd">let</code> <code class="nx">intersection</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">(</code>
    <code class="p">[...</code><code class="nx">a</code><code class="p">].</code><code class="nx">filter</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="nx">b</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="nx">x</code><code class="p">)));</code>
    <code class="c1">// {2,3}</code>
</pre></div>

</div>

<p>Steps: Convert <code>a</code> to an Array, filter the elements, convert the result to a Set.</p>

<h5 id="leanpub-auto-difference">
<span class="section-number">18.4.6.3 </span>Difference</h5>

<p>Difference (<code>a</code> \ <code>b</code>): create a Set that contains those elements of Set <code>a</code> that are not in Set <code>b</code>. This operation is also sometimes called <em>minus</em> (<code>-</code>).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">a</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">3</code><code class="p">]);</code>
<code class="kd">let</code> <code class="nx">b</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="mi">4</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">2</code><code class="p">]);</code>
<code class="kd">let</code> <code class="nx">difference</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">(</code>
    <code class="p">[...</code><code class="nx">a</code><code class="p">].</code><code class="nx">filter</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="o">!</code><code class="nx">b</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="nx">x</code><code class="p">)));</code>
    <code class="c1">// {1}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-set-api">
<span class="section-number">18.4.7 </span>Set API</h4>

<p><strong>Constructor:</strong></p>

<ul>
<li>
<code>new Set(elements? : Iterable&lt;any&gt;)</code><br>
  If you don’t provide the parameter <code>iterable</code> then an empty Set is created. If you do then the iterated values are added as elements to the Set. For example:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="s1">'red'</code><code class="p">,</code> <code class="s1">'green'</code><code class="p">,</code> <code class="s1">'blue'</code><code class="p">]);</code>
</pre></div>
    
</div>
  </li>
</ul>
<p><strong>Single Set elements:</strong></p>

<ul>
<li>
<code>Set.prototype.add(value) : this</code><br>
Adds <code>value</code> to this Set. This method returns <code>this</code>, which means that it can be chained.</li>
  <li>
<code>Set.prototype.has(value) : boolean</code><br>
Checks whether <code>value</code> is in this Set.</li>
  <li>
<code>Set.prototype.delete(value) : boolean</code><br>
Removes <code>value</code> from this Set.</li>
</ul>
<p><strong>All Set elements:</strong></p>

<ul>
<li>
<code>get Set.prototype.size : number</code><br>
Returns how many elements there are in this Set.</li>
  <li>
<code>Set.prototype.clear() : void</code><br>
Removes all elements from this Set.</li>
</ul>
<p><strong>Iterating and looping:</strong></p>

<ul>
<li>
<code>Set.prototype.values() : Iterable&lt;any&gt;</code><br>
Returns an iterable over all elements of this Set.</li>
  <li>
<code>Set.prototype[Symbol.iterator]() : Iterable&lt;any&gt;</code><br>
The default way of iterating over Sets. Points to <code>Set.prototype.values</code>.</li>
  <li>
<code>Set.prototype.forEach((value, key, collection) =&gt; void, thisArg?)</code><br>
Loops over the elements of this Set and invokes the callback (first parameter) for each one. <code>value</code> and <code>key</code> are both set to the element, so that this method works similarly to <code>Map.prototype.forEach</code>. If <code>thisArg</code> is provided, <code>this</code> is set to it for each call. Otherwise, <code>this</code> is set to <code>undefined</code>.</li>
</ul>
<p><strong>Symmetry with <code>Map</code>:</strong> The following two methods only exist so that the interface of Sets is similar to the interface of Maps. Each Set element is handled as if it were a Map entry whose key and value are the element.</p>

<ul>
<li><code>Set.prototype.entries() : Iterable&lt;[any,any]&gt;</code></li>
  <li><code>Set.prototype.keys() : Iterable&lt;any&gt;</code></li>
</ul>
<h3 id="leanpub-auto-weakset">
<span class="section-number">18.5 </span>WeakSet</h3>

<p>A <code>WeakSet</code> is a Set that doesn’t prevent its elements from being garbage-collected. Consult the section on <code>WeakMap</code> for an explanation of why WeakSets don’t allow iteration, looping and clearing.</p>

<p>Given that you can’t iterate over their elements, there are not that many use cases for WeakSets. They do enable you to mark objects.</p>

<p>For example, if you have a factory function for proxies, you can use a WeakSet to record which objects were created by that factory:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">proxies</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakSet</code><code class="p">();</code>

<code class="kd">function</code> <code class="nx">createProxy</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">proxy</code> <code class="o">=</code> <code class="err">···</code><code class="p">;</code>
    <code class="nx">proxies</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="nx">proxy</code><code class="p">);</code>
    <code class="k">return</code> <code class="nx">proxy</code><code class="p">;</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">isProxy</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">proxies</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The complete example is shown in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_detect-proxies">the chapter on proxies</a>.</p>

<h4 id="leanpub-auto-weakset-api">
<span class="section-number">18.5.1 </span>WeakSet API</h4>

<p>The constructor and the three methods of <code>WeakSet</code> work the same as their <code>Set</code> equivalents:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">new</code> <code class="nx">WeakSet</code><code class="p">(</code><code class="nx">elements</code><code class="o">?</code> <code class="o">:</code> <code class="nx">Iterable</code><code class="o">&lt;</code><code class="nx">any</code><code class="o">&gt;</code><code class="p">)</code>

<code class="nx">WeakSet</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code>
<code class="nx">WeakSet</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code>
<code class="nx">WeakSet</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="k">delete</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code>
</pre></div>

</div>


<h3 id="leanpub-auto-faq-maps-and-sets">
<span class="section-number">18.6 </span>FAQ: Maps and Sets</h3>

<h4 id="leanpub-auto-why-do-maps-and-sets-have-the-property-size-and-not-length">
<span class="section-number">18.6.1 </span>Why do Maps and Sets have the property <code>size</code> and not <code>length</code>?</h4>

<p>Arrays have the property <code>length</code> to count the number of entries. Maps and Sets have a different property, <code>size</code>.</p>

<p>The reason for this difference is that <code>length</code> is for sequences, data structures that are indexable – like Arrays. <code>size</code> is for collections that are primarily unordered – like Maps and Sets.</p>

<h4 id="sec_configuring-comparison-maps-sets">
<span class="section-number">18.6.2 </span>Why can’t I configure how Maps and Sets compare keys and values?</h4>

<p>It would be nice if there were a way to configure what Map keys and what Set elements are considered equal. But that feature has been postponed, as it is difficult to implement properly and efficiently.</p>

<h4 id="leanpub-auto-is-there-a-way-to-specify-a-default-value-when-getting-something-out-of-a-map">
<span class="section-number">18.6.3 </span>Is there a way to specify a default value when getting something out of a Map?</h4>

<p>If you use a key to get something out of a Map, you’d occasionally like to specify a default value that is returned if the key is not in the Map. ES6 Maps don’t let you do this directly. But you can use the <code>Or</code> operator (<code>||</code>), as demonstrated in the following code. <code>countChars</code> returns a Map that maps characters to numbers of occurrences.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">countChars</code><code class="p">(</code><code class="nx">chars</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">charCounts</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">();</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">ch</code> <code class="nx">of</code> <code class="nx">chars</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">ch</code> <code class="o">=</code> <code class="nx">ch</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">();</code>
        <code class="kr">const</code> <code class="nx">prevCount</code> <code class="o">=</code> <code class="nx">charCounts</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">ch</code><code class="p">)</code> <code class="o">||</code> <code class="mi">0</code><code class="p">;</code> <code class="c1">// (A)</code>
        <code class="nx">charCounts</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="nx">ch</code><code class="p">,</code> <code class="nx">prevCount</code><code class="o">+</code><code class="mi">1</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">charCounts</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In line A, the default <code>0</code> is used if <code>ch</code> is not in the <code>charCounts</code> and <code>get()</code> returns <code>undefined</code>.</p>

<h4 id="leanpub-auto-when-should-i-use-a-map-when-an-object">
<span class="section-number">18.6.4 </span>When should I use a Map, when an object?</h4>

<p>If you map anything other than strings to any kind of data, you have no choice: you must use a Map.</p>

<p>If, however, you are mapping strings to arbitrary data, you must decide whether or not to use an object. A rough general guideline is:</p>

<ul>
<li>Are the keys fixed? Use an object: <code>obj.key</code>
</li>
  <li>Are the keys variable (e.g. specified via variables)? Use a Map: <code>map.get(someKey)</code>
</li>
</ul>
<div class="footnotes">
  <ol>
<li id="fn-maps-sets_1">[Speaking JS] “<a href="http://speakingjs.com/es5/ch17.html#private_data_for_objects">Keeping Data Private</a>”<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-maps-sets_1" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h2 id="leanpub-auto-typed-arrays">
<span class="section-number">19. </span>Typed Arrays</h2>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_road.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>This chapter isn’t finished, yet.</p>

    </td>
  </tr></tbody></table>
<p>Until this chapter is ready, I recommend the following article: “<a href="http://www.html5rocks.com/en/tutorials/webgl/typed_arrays/">Typed Arrays: Binary Data in the Browser</a>” by Ilmari Heikkinen</p>


<h2 id="ch_iteration">
<span class="section-number">20. </span>Iterables and iterators</h2>

<p>ECMAScript 6 introduces a new interface for iteration, <code>Iterable</code>. This chapter explains how it works, which language constructs consume data via it (e.g., the new <code>for-of</code> loop) and which sources provide data via it (e.g., Arrays).</p>


<h3 id="leanpub-auto-overview-12">
<span class="section-number">20.1 </span>Overview</h3>

<p>The following two entities play important roles in iteration:</p>

<ul>
<li>
<strong>Iterable:</strong> An iterable is a data structure that wants to make its elements accessible to the public. It does so by implementing a method whose key is <code>Symbol.iterator</code>. That method is a factory for <em>iterators</em>.</li>
  <li>
<strong>Iterator:</strong> a pointer for traversing the elements of a data structure (think cursors in databases).</li>
</ul>
<p>The following values are iterable:</p>

<ul>
<li>Arrays</li>
  <li>Strings</li>
  <li>Maps</li>
  <li>Sets</li>
  <li>DOM data structures (work in progress)</li>
  <li>Not iterable: plain objects (which are not a data structure, strictly speaking; a more in-depth explanation is given later)</li>
</ul>
<p>Language constructs that access data via the iteration protocol:</p>

<ul>
<li>Destructuring via an Array pattern:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code> <code class="p">[</code><code class="nx">a</code><code class="p">,</code><code class="nx">b</code><code class="p">]</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">]);</code>
</pre></div>
    
</div>
  </li>
  <li>
<code>for-of</code> loop:
    <div class="code-block">
<div class="highlight"><pre>  <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">])</code> <code class="p">{</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
  <code class="p">}</code>
</pre></div>
    
</div>
  </li>
  <li>
<code>Array.from()</code>:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">]));</code>
</pre></div>
    
</div>
  </li>
  <li>Spread operator (<code>...</code>):
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">])];</code>
</pre></div>
    
</div>
  </li>
  <li>Constructors of Maps and Sets:
    <div class="code-block">
<div class="highlight"><pre>  <code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">([[</code><code class="kc">false</code><code class="p">,</code> <code class="s1">'no'</code><code class="p">],</code> <code class="p">[</code><code class="kc">true</code><code class="p">,</code> <code class="s1">'yes'</code><code class="p">]]);</code>
  <code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">]);</code>
</pre></div>
    
</div>
  </li>
  <li>
<code>Promise.all()</code>, <code>Promise.race()</code>:
    <div class="code-block">
<div class="highlight"><pre>  <code class="nx">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="nx">iterableOverPromises</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="err">···</code><code class="p">);</code>
  <code class="nx">Promise</code><code class="p">.</code><code class="nx">race</code><code class="p">(</code><code class="nx">iterableOverPromises</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="err">···</code><code class="p">);</code>
</pre></div>
    
</div>
  </li>
  <li>
<code>yield*</code>:
    <div class="code-block">
<div class="highlight"><pre>  <code class="k">yield</code><code class="o">*</code> <code class="nx">anIterable</code><code class="p">;</code>
</pre></div>
    
</div>
  </li>
</ul>
<h3 id="leanpub-auto-iterability">
<span class="section-number">20.2 </span>Iterability</h3>

<p>The idea of iterability is as follows.</p>

<ul>
<li>
<strong>Data consumers:</strong> JavaScript has language constructs that consume data. For example, <code>for-of</code> loops over values and the spread operator (<code>...</code>) inserts values into Arrays or function calls.</li>
  <li>
<strong>Data sources:</strong> The data consumers could get their values from a variety of sources. For example, you may want to iterate over the elements of an Array, the key-value entries in a Map or the characters of a string.</li>
</ul>
<p>It’s not practical for every consumer to support all sources, especially because it should be possible to create new sources (e.g. via libraries). Therefore, ES6 introduces the interface <code>Iterable</code>. Data consumers use it, data sources implement it:</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/iteration----consumers_sources.jpg" alt=""><p class="caption"></p>
</div>

<p>Given that JavaScript does not have interfaces, <code>Iterable</code> is more of a convention:</p>

<ul>
<li>
<strong>Source:</strong> A value is considered <em>iterable</em> if it has a method whose key is the symbol <code>Symbol.iterator</code> that returns a so-called <em>iterator</em>. The iterator is an object that returns values via its method <code>next()</code>. We say: it <em>enumerates items</em>, one per method call.</li>
  <li>
<strong>Consumption:</strong> Data consumers use the iterator to retrieve the values they are consuming.</li>
</ul>
<p>Let’s see what consumption looks like for an Array <code>arr</code>. First, you create an iterator via the method whose key is <code>Symbol.iterator</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">arr</code> <code class="o">=</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">,</code> <code class="sc">'c'</code><code class="p">];</code>
<code class="o">&gt;</code> <code class="n">let</code> <code class="n">iter</code> <code class="o">=</code> <code class="n">arr</code><code class="p">[</code><code class="n">Symbol</code><code class="p">.</code><code class="n">iterator</code><code class="p">]();</code>
</pre></div>

</div>

<p>Then you call the iterator’s method <code>next()</code> repeatedly to retrieve the items “inside” the Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">iter</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="sc">'a'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">iter</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="sc">'b'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">iter</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="sc">'c'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">iter</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">true</code> <code class="p">}</code>
</pre></div>

</div>

<p>As you can see, <code>next()</code> returns each item wrapped in an object, as the value of the property <code>value</code>. The boolean property <code>done</code> indicates when the end of the sequence of items has been reached.</p>

<p><code>Iterable</code> and iterators are part of a so-called <em>protocol</em> (methods plus rules for using them) for iteration. A key characteristic of this protocol is that it is sequential: the iterator returns values one at a time. That means that if an iterable data structure is non-linear (such as a tree), iteration will linearize it.</p>


<h3 id="leanpub-auto-iterable-data-sources">
<span class="section-number">20.3 </span>Iterable data sources</h3>

<p>I’ll use the <code>for-of</code> loop (<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_for-of-loop">which is explained in more detail later</a>) to iterate over various kinds of iterable data.</p>

<h4 id="leanpub-auto-arrays">
<span class="section-number">20.3.1 </span>Arrays</h4>

<p>Arrays (and Typed Arrays) are iterables over their elements:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">])</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// 'a'</code>
<code class="c1">// 'b'</code>
</pre></div>

</div>

<h4 id="leanpub-auto-strings">
<span class="section-number">20.3.2 </span>Strings</h4>

<p>Strings are iterable, but they enumerate Unicode code points, each of which may comprise one or two JavaScript characters:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="s1">'a\uD83D\uDC0A'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// 'a'</code>
<code class="c1">// '\uD83D\uDC0A' (crocodile emoji)</code>
</pre></div>

</div>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <p>You have just seen that primitive values can be iterable, too. A value doesn’t have to be an object in order to be iterable.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-maps-1">
<span class="section-number">20.3.3 </span>Maps</h4>

<p>Maps are iterables over their entries. Each entry is encoded as a [key, value] pair, an Array with two elements. The entries are always enumerated deterministically, in the same order in which they were added to the map.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">().</code><code class="nx">set</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="mi">1</code><code class="p">).</code><code class="nx">set</code><code class="p">(</code><code class="s1">'b'</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">pair</code> <code class="nx">of</code> <code class="nx">map</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">pair</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// ['a', 1]</code>
<code class="c1">// ['b', 2]</code>
</pre></div>

</div>

<p>Note that WeakMaps are not iterable.</p>

<h4 id="leanpub-auto-sets-1">
<span class="section-number">20.3.4 </span>Sets</h4>

<p>Sets are iterables over their elements (which are enumerated in the same order in which they were added to the Set).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">().</code><code class="nx">add</code><code class="p">(</code><code class="s1">'a'</code><code class="p">).</code><code class="nx">add</code><code class="p">(</code><code class="s1">'b'</code><code class="p">);</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">set</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// 'a'</code>
<code class="c1">// 'b'</code>
</pre></div>

</div>

<p>Note that WeakSets are not iterable.</p>

<h4 id="leanpub-auto-arguments">
<span class="section-number">20.3.5 </span><code>arguments</code>
</h4>

<p>Even though the special variable <code>arguments</code> is more or less obsolete in ECMAScript 6 (due to rest parameters), it is iterable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">printArgs</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">arguments</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="nx">printArgs</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">);</code>

<code class="c1">// Output:</code>
<code class="c1">// 'a'</code>
<code class="c1">// 'b'</code>
</pre></div>

</div>

<h4 id="leanpub-auto-dom-data-structures">
<span class="section-number">20.3.6 </span>DOM data structures</h4>

<p>Most DOM data structures will eventually be iterable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">node</code> <code class="nx">of</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelectorAll</code><code class="p">(</code><code class="s1">'div'</code><code class="p">))</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Note that implementing this functionality is work in progress. But it is relatively easy to do so, because the symbol <code>Symbol.iterator</code> can’t clash with existing property keys.</p>

<h4 id="leanpub-auto-iterable-computed-data">
<span class="section-number">20.3.7 </span>Iterable computed data</h4>

<p>Not all iterable content does have to come from data structures, it could also be computed on the fly. For example, all major ES6 data structures (Arrays, Typed Arrays, Maps, Sets) have three methods that return iterable objects:</p>

<ul>
<li>
<code>entries()</code> returns an iterable over entries encoded as [key, value] Arrays. For Arrays, the values are the Array elements and the keys are their indices. For Sets, each key and value are the same – the Set element.</li>
  <li>
<code>keys()</code> returns an iterable over the keys of the entries.</li>
  <li>
<code>values()</code> returns an iterable over the values of the entries.</li>
</ul>
<p>Let’s see what that looks like. <code>entries()</code> gives you a nice way to get both Array elements and their indices:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">];</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">pair</code> <code class="nx">of</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">entries</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">pair</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// [0, 'a']</code>
<code class="c1">// [1, 'b']</code>
<code class="c1">// [2, 'c']</code>
</pre></div>

</div>

<h4 id="leanpub-auto-plain-objects-are-not-iterable">
<span class="section-number">20.3.8 </span>Plain objects are not iterable</h4>

<p>Plain objects (as created by object literals) are not iterable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="p">{})</code> <code class="p">{</code> <code class="c1">// TypeError</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Why aren’t objects iterable over properties, by default? The reasoning is as follows. There are two levels at which you can iterate in JavaScript:</p>

<ol class="numeric numeric">
<li>The program level: iterating over properties means examining the structure of the program.</li>
  <li>The data level: iterating over a data structure means examining the data managed by the program.</li>
</ol>
<p>Making iteration over properties the default would mean mixing those levels, which would have two disadvantages:</p>

<ul>
<li>You can’t iterate over the properties of data structures.</li>
  <li>Once you iterate over the properties of an object, turning that object into a data structure would break your code.</li>
</ul>
<p>Therefore, the safest way to iterate over properties is via a tool function. For example, via <code>objectEntries()</code>, <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#objectEntries">whose implementation is shown later</a> (future ECMAScript versions may have something similar built in):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="s1">'Jane'</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="s1">'Doe'</code> <code class="p">};</code>

<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">key</code><code class="p">,</code><code class="nx">value</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">objectEntries</code><code class="p">(</code><code class="nx">obj</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">$</code><code class="p">{</code><code class="nx">key</code><code class="p">}</code><code class="o">:</code> <code class="nx">$</code><code class="p">{</code><code class="nx">value</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
<code class="p">}</code>

<code class="c1">// Output:</code>
<code class="c1">// first: Jane</code>
<code class="c1">// last: Doe</code>
</pre></div>

</div>

<p>It is also important to remember that iterating over the properties of an object is mainly interesting if you use objects as Maps<sup id="fnref-iteration_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-iteration_1" rel="footnote">1</a></sup>. But we only do that in ES5 because we have no better alternative. In ECMAScript 6, we have the built-in data structure <code>Map</code>.</p>


<h3 id="leanpub-auto-iterating-language-constructs">
<span class="section-number">20.4 </span>Iterating language constructs</h3>

<p>The following ES6 language constructs make use of the iteration protocol:</p>

<ul>
<li>Destructuring via an Array pattern</li>
  <li>
<code>for-of</code> loop</li>
  <li><code>Array.from()</code></li>
  <li>Spread operator (<code>...</code>)</li>
  <li>Constructors of Maps and Sets</li>
  <li>
<code>Promise.all()</code>, <code>Promise.race()</code>
</li>
  <li><code>yield*</code></li>
</ul>
<p>The next sections describe each one of them in detail.</p>

<h4 id="leanpub-auto-destructuring-via-an-array-pattern">
<span class="section-number">20.4.1 </span>Destructuring via an Array pattern</h4>

<p>Destructuring via Array patterns works for any iterable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">().</code><code class="nx">add</code><code class="p">(</code><code class="s1">'a'</code><code class="p">).</code><code class="nx">add</code><code class="p">(</code><code class="s1">'b'</code><code class="p">).</code><code class="nx">add</code><code class="p">(</code><code class="s1">'c'</code><code class="p">);</code>

<code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code><code class="nx">y</code><code class="p">]</code> <code class="o">=</code> <code class="nx">set</code><code class="p">;</code>
    <code class="c1">// x='a'; y='b'</code>

<code class="kd">let</code> <code class="p">[</code><code class="nx">first</code><code class="p">,</code> <code class="p">...</code><code class="nx">rest</code><code class="p">]</code> <code class="o">=</code> <code class="nx">set</code><code class="p">;</code>
    <code class="c1">// first='a'; rest=['b','c'];</code>
</pre></div>

</div>

<h4 id="sec_for-of-loop">
<span class="section-number">20.4.2 </span>The <code>for-of</code> loop</h4>

<p><code>for-of</code> is a new loop in ECMAScript 6. One form of it looks like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This loop iterates over <code>iterable</code>, assigns each of the enumerated items to the iteration variable <code>x</code> and lets you process it in the body. The scope of <code>x</code> is the loop, it doesn’t exist outside it.</p>

<p>Note that the iterability of <code>iterable</code> is required, otherwise <code>for-of</code> can’t loop over a value. That means that non-iterable values must be converted to something iterable. For example, via <code>Array.from()</code>, which turns Array-like values and iterables into Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arrayLike</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">length</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">0</code><code class="o">:</code> <code class="s1">'a'</code><code class="p">,</code> <code class="mi">1</code><code class="o">:</code> <code class="s1">'b'</code> <code class="p">};</code>

<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">arrayLike</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// TypeError</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>

<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">arrayLike</code><code class="p">))</code> <code class="p">{</code> <code class="c1">// OK</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>I expect <code>for-of</code> to mostly replace <code>Array.prototype.forEach()</code>, because it is more versatile (<code>forEach()</code> only works for Array-like values) and will be faster long term (<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_isnt_iteration_slow">see FAQ at the end</a>).</p>

<h5 id="leanpub-auto-iteration-variables-let-declarations-vs-var-declarations">
<span class="section-number">20.4.2.1 </span>Iteration variables: <code>let</code> declarations vs. <code>var</code> declarations</h5>

<p>If you <code>let</code>-declare the iteration variable, a fresh binding (slot) will be created for each iteration. That can be seen in the following code snippet where we save the current binding of <code>elem</code> for later, via an arrow function. Afterwards, you can see that the arrow functions don’t share the same binding for <code>elem</code>, they each have a different one.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[];</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">elem</code> <code class="nx">of</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">])</code> <code class="p">{</code>
    <code class="nx">arr</code><code class="p">.</code><code class="nx">push</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">elem</code><code class="p">);</code> <code class="c1">// save `elem` for later</code>
<code class="p">}</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">f</code> <code class="o">=&gt;</code> <code class="nx">f</code><code class="p">()));</code> <code class="c1">// [0, 1, 2]</code>

<code class="c1">// `elem` only exists inside the loop:</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">elem</code><code class="p">);</code> <code class="c1">// ReferenceError: elem is not defined</code>
</pre></div>

</div>

<p>A <code>const</code> declaration works the same way as a <code>let</code> declaration (but the bindings are immutable).</p>

<p>It is instructive to see how things are different if you <code>var</code>-declare the iteration variable. Now all arrow functions refer to the same binding of <code>elem</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[];</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">elem</code> <code class="nx">of</code> <code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">])</code> <code class="p">{</code>
    <code class="nx">arr</code><code class="p">.</code><code class="nx">push</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">elem</code><code class="p">);</code>
<code class="p">}</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">arr</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">f</code> <code class="o">=&gt;</code> <code class="nx">f</code><code class="p">()));</code> <code class="c1">// [2, 2, 2]</code>

<code class="c1">// `elem` exists in the surrounding function:</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">elem</code><code class="p">);</code> <code class="c1">// 2</code>
</pre></div>

</div>

<p>Having one binding per iteration is very helpful whenever you create functions via a loop (e.g. to add event listeners).</p>

<p>You also get per-iteration bindings in <code>for</code> loops and <code>for-in</code> loops if you use <code>let</code>. Details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_let-const-loop-heads">the chapter on variables</a>.</p>

<h5 id="leanpub-auto-iterating-with-existing-variables-object-properties-and-array-elements">
<span class="section-number">20.4.2.2 </span>Iterating with existing variables, object properties and Array elements</h5>

<p>So far, we have only seen <code>for-of</code> with a declared iteration variable. But there are several other forms.</p>

<p>You can iterate with an existing variable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">x</code><code class="p">;</code>
<code class="k">for</code> <code class="p">(</code><code class="nx">x</code> <code class="nx">of</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">])</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>You can also iterate with an object property:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{};</code>
<code class="k">for</code> <code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">prop</code> <code class="nx">of</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">])</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">prop</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>And you can iterate with an Array element:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[];</code>
<code class="k">for</code> <code class="p">(</code><code class="nx">arr</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="nx">of</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">])</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">arr</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-iterating-with-a-destructuring-pattern">
<span class="section-number">20.4.2.3 </span>Iterating with a destructuring pattern</h5>

<p>Combining <code>for-of</code> with destructuring is especially useful for iterables over [key, value] pairs (encoded as Arrays). That’s what Maps are:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Map</code><code class="p">().</code><code class="nx">set</code><code class="p">(</code><code class="kc">false</code><code class="p">,</code> <code class="s1">'no'</code><code class="p">).</code><code class="nx">set</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code> <code class="s1">'yes'</code><code class="p">);</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">k</code><code class="p">,</code><code class="nx">v</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">map</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">key</code> <code class="o">=</code> <code class="nx">$</code><code class="p">{</code><code class="nx">k</code><code class="p">},</code> <code class="nx">value</code> <code class="o">=</code> <code class="nx">$</code><code class="p">{</code><code class="nx">v</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// key = false, value = no</code>
<code class="c1">// key = true, value = yes</code>
</pre></div>

</div>

<p><code>Array.prototype.entries()</code> also returns an iterable over [key, value] pairs:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">];</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">k</code><code class="p">,</code><code class="nx">v</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">entries</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">key</code> <code class="o">=</code> <code class="nx">$</code><code class="p">{</code><code class="nx">k</code><code class="p">},</code> <code class="nx">value</code> <code class="o">=</code> <code class="nx">$</code><code class="p">{</code><code class="nx">v</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// key = 0, value = a</code>
<code class="c1">// key = 1, value = b</code>
<code class="c1">// key = 2, value = c</code>
</pre></div>

</div>

<p>Therefore, <code>entries()</code> gives you a way to treat enumerated items differently, depending on their position:</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/** Same as arr.join(', ') */</code>
<code class="kd">function</code> <code class="nx">toString</code><code class="p">(</code><code class="nx">arr</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">i</code><code class="p">,</code><code class="nx">elem</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">arr</code><code class="p">.</code><code class="nx">entries</code><code class="p">())</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">i</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">result</code> <code class="o">+=</code> <code class="s1">', '</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="nx">result</code> <code class="o">+=</code> <code class="nb">String</code><code class="p">(</code><code class="nx">elem</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">result</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This function is used as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">toString</code><code class="p">([</code><code class="err">'</code><code class="n">eeny</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">meeny</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">miny</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">moe</code><code class="err">'</code><code class="p">])</code>
<code class="err">'</code><code class="n">eeny</code><code class="p">,</code> <code class="n">meeny</code><code class="p">,</code> <code class="n">miny</code><code class="p">,</code> <code class="n">moe</code><code class="err">'</code>
</pre></div>

</div>

<h4 id="leanpub-auto-arrayfrom">
<span class="section-number">20.4.3 </span><code>Array.from()</code>
</h4>

<p><code>Array.from()</code> converts iterable and Array-like values to Arrays. It is also available for typed Arrays.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">(</code><code class="n">new</code> <code class="n">Map</code><code class="p">().</code><code class="n">set</code><code class="p">(</code><code class="nb">false</code><code class="p">,</code> <code class="err">'</code><code class="n">no</code><code class="err">'</code><code class="p">).</code><code class="n">set</code><code class="p">(</code><code class="nb">true</code><code class="p">,</code> <code class="err">'</code><code class="n">yes</code><code class="err">'</code><code class="p">))</code>
<code class="p">[[</code><code class="nb">false</code><code class="p">,</code><code class="err">'</code><code class="n">no</code><code class="err">'</code><code class="p">],</code> <code class="p">[</code><code class="nb">true</code><code class="p">,</code><code class="err">'</code><code class="n">yes</code><code class="err">'</code><code class="p">]]</code>
<code class="o">&gt;</code> <code class="n">Array</code><code class="p">.</code><code class="n">from</code><code class="p">({</code> <code class="n">length</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">0</code><code class="o">:</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">,</code> <code class="mi">1</code><code class="o">:</code> <code class="err">'</code><code class="n">world</code><code class="err">'</code> <code class="p">})</code>
<code class="p">[</code><code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">world</code><code class="err">'</code><code class="p">]</code>
</pre></div>

</div>

<p><code>Array.from()</code> works as expected for a subclass of <code>Array</code> (which inherits this class method) – it converts iterables to instances of the subclass.</p>

<h4 id="leanpub-auto-the-spread-operator-">
<span class="section-number">20.4.4 </span>The spread operator (<code>...</code>)</h4>

<p>The spread operator inserts the values of an iterable into an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">];</code>
<code class="o">&gt;</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="p">...</code><code class="nx">arr</code><code class="p">,</code> <code class="s1">'d'</code><code class="p">]</code>
<code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">,</code> <code class="s1">'d'</code><code class="p">]</code>
</pre></div>

</div>

<p>That means that it provides you with a compact way to convert any iterable to an Array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">iterable</code><code class="p">];</code>
</pre></div>

</div>

<p>The spread operator also turns an iterable into the arguments of a function, method or constructor call:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(...[</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">8</code><code class="p">,</code> <code class="mi">3</code><code class="p">])</code>
<code class="mi">8</code>
</pre></div>

</div>

<h4 id="leanpub-auto-maps-and-sets">
<span class="section-number">20.4.5 </span>Maps and Sets</h4>

<p>The constructor of a Map turns an iterable over [key, value] pairs into a Map:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">map</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Map</code><code class="p">([[</code><code class="err">'</code><code class="n">uno</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">one</code><code class="err">'</code><code class="p">],</code> <code class="p">[</code><code class="err">'</code><code class="n">dos</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">two</code><code class="err">'</code><code class="p">]]);</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="err">'</code><code class="n">uno</code><code class="err">'</code><code class="p">)</code>
<code class="err">'</code><code class="n">one</code><code class="err">'</code>
<code class="o">&gt;</code> <code class="n">map</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="err">'</code><code class="n">dos</code><code class="err">'</code><code class="p">)</code>
<code class="err">'</code><code class="n">two</code><code class="err">'</code>
</pre></div>

</div>

<p>The constructor of a Set turns an iterable over elements into a Set:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">let</code> <code class="nx">set</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">([</code><code class="s1">'red'</code><code class="p">,</code> <code class="s1">'green'</code><code class="p">,</code> <code class="s1">'blue'</code><code class="p">]);</code>
<code class="o">&gt;</code> <code class="nx">set</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="s1">'red'</code><code class="p">)</code>
<code class="kc">true</code>
<code class="o">&gt;</code> <code class="nx">set</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="s1">'yellow'</code><code class="p">)</code>
<code class="kc">false</code>
</pre></div>

</div>

<p>The constructors of <code>WeakMap</code> and <code>WeakSet</code> work similarly. Furthermore, Maps and Sets are iterable themselves (WeakMaps and WeakSets aren’t), which means that you can use their constructors to clone them.</p>

<h4 id="leanpub-auto-promises">
<span class="section-number">20.4.6 </span>Promises</h4>

<p><code>Promise.all()</code> and <code>Promise.race()</code> accept iterables over Promises:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="nx">iterableOverPromises</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="err">···</code><code class="p">);</code>
<code class="nx">Promise</code><code class="p">.</code><code class="nx">race</code><code class="p">(</code><code class="nx">iterableOverPromises</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="err">···</code><code class="p">);</code>
</pre></div>

</div>

<h4 id="leanpub-auto-yield">
<span class="section-number">20.4.7 </span><code>yield*</code>
</h4>

<p><code>yield*</code> yields all items enumerated by an iterable.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">yieldAllValuesOf</code><code class="p">(</code><code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">yield</code><code class="o">*</code> <code class="nx">iterable</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The most important use case for <code>yield*</code> is to recursively call a generator (which produces something iterable).</p>


<h3 id="leanpub-auto-implementing-iterables">
<span class="section-number">20.5 </span>Implementing iterables</h3>

<p>The iteration protocol looks as follows.</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/iteration----iteration_protocol.jpg" alt=""><p class="caption"></p>
</div>

<p>An object becomes <em>iterable</em> (“implements” the interface <code>Iterable</code>) if it has a method (own or inherited) whose key is <code>Symbol.iterator</code>. That method must return an <em>iterator</em>, an object that <em>enumerates</em> the <em>items</em> “inside” the iterable via its method <code>next()</code>.</p>

<p>In TypeScript notation, the interfaces for iterables and iterators look as follows<sup id="fnref-iteration_2"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-iteration_2" rel="footnote">2</a></sup>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">interface</code> <code class="nx">Iterable</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">System</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="o">:</code> <code class="nx">Iterator</code><code class="p">;</code>
<code class="p">}</code>
<code class="kr">interface</code> <code class="nx">IteratorResult</code> <code class="p">{</code>
    <code class="nx">value</code><code class="o">:</code> <code class="nx">any</code><code class="p">;</code>
    <code class="nx">done</code><code class="o">:</code> <code class="kr">boolean</code><code class="p">;</code>
<code class="p">}</code>
<code class="kr">interface</code> <code class="nx">Iterator</code> <code class="p">{</code>
    <code class="nx">next</code><code class="p">()</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
    <code class="k">return</code><code class="o">?</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>return</code> is an optional method that we’ll get to later (so is <code>throw()</code>, but it is practically never used for iterators and therefore explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators">the chapter on generators</a>). Let’s first implement a dummy iterable to get a feeling for how iteration works.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">iterable</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">step</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        <code class="kd">let</code> <code class="nx">iterator</code> <code class="o">=</code> <code class="p">{</code>
            <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="nx">step</code> <code class="o">&lt;=</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
                    <code class="nx">step</code><code class="o">++</code><code class="p">;</code>
                <code class="p">}</code>
                <code class="k">switch</code> <code class="p">(</code><code class="nx">step</code><code class="p">)</code> <code class="p">{</code>
                    <code class="k">case</code> <code class="mi">1</code><code class="o">:</code>
                        <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="s1">'hello'</code><code class="p">,</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">false</code> <code class="p">};</code>
                    <code class="k">case</code> <code class="mi">2</code><code class="o">:</code>
                        <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="s1">'world'</code><code class="p">,</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">false</code> <code class="p">};</code>
                    <code class="k">default</code><code class="o">:</code>
                        <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="kc">undefined</code><code class="p">,</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">};</code>
        <code class="k">return</code> <code class="nx">iterator</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>Let’s check that <code>iterable</code> is, in fact, iterable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// hello</code>
<code class="c1">// world</code>
</pre></div>

</div>

<p>The code executes three steps, with the counter <code>step</code> ensuring that everything happens in the right order. First we, return the value <code>'hello'</code>, then the value <code>'world'</code> and then we indicate that the end of the enumerated items has been reached. Each item is wrapped in an object with the properties:</p>

<ul>
<li>
<code>value</code> which holds the actual item and</li>
  <li>
<code>done</code> which is a boolean flag that indicates whether the end has been reached, yet.</li>
</ul>
<p>You can omit <code>done</code> if it is <code>false</code> and <code>value</code> if it is <code>undefined</code>. That is, the <code>switch</code> statement could be written as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">switch</code> <code class="p">(</code><code class="nx">step</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">case</code> <code class="mi">1</code><code class="o">:</code>
        <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="s1">'hello'</code> <code class="p">};</code>
    <code class="k">case</code> <code class="mi">2</code><code class="o">:</code>
        <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="s1">'world'</code> <code class="p">};</code>
    <code class="k">default</code><code class="o">:</code>
        <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</div>

<p>As is explained in the <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators">the chapter on generators</a>, there are cases where you want even the last item with <code>done: true</code> to have a <code>value</code>. Otherwise, <code>next()</code> could be simpler and return items directly (without wrapping them in objects). The end of iteration would then be indicated via a special value (e.g., a symbol).</p>

<p>Let’s look at one more implementation of an iterable. The function <code>iterateOver()</code> returns an iterable over the arguments that are passed to it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">iterateOver</code><code class="p">(...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">index</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
    <code class="kd">let</code> <code class="nx">iterable</code> <code class="o">=</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">iterator</code> <code class="o">=</code> <code class="p">{</code>
                <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
                    <code class="k">if</code> <code class="p">(</code><code class="nx">index</code> <code class="o">&lt;</code> <code class="nx">args</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
                        <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">args</code><code class="p">[</code><code class="nx">index</code><code class="o">++</code><code class="p">]</code> <code class="p">};</code>
                    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                        <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">};</code>
            <code class="k">return</code> <code class="nx">iterator</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">iterable</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">// Using `iterateOver()`:</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterateOver</code><code class="p">(</code><code class="s1">'fee'</code><code class="p">,</code> <code class="s1">'fi'</code><code class="p">,</code> <code class="s1">'fo'</code><code class="p">,</code> <code class="s1">'fum'</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>

<code class="c1">// Output:</code>
<code class="c1">// fee</code>
<code class="c1">// fi</code>
<code class="c1">// fo</code>
<code class="c1">// fum</code>
</pre></div>

</div>

<h4 id="leanpub-auto-iterators-that-are-iterable">
<span class="section-number">20.5.1 </span>Iterators that are iterable</h4>

<p>The previous function can be simplified if the iterable and the iterator are the same object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">iterateOver</code><code class="p">(...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">index</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
    <code class="kd">let</code> <code class="nx">iterable</code> <code class="o">=</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">index</code> <code class="o">&lt;</code> <code class="nx">args</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">args</code><code class="p">[</code><code class="nx">index</code><code class="o">++</code><code class="p">]</code> <code class="p">};</code>
            <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
            <code class="p">}</code>
        <code class="p">},</code>
    <code class="p">};</code>
    <code class="k">return</code> <code class="nx">iterable</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Even if the original iterable and the iterator are not the same object, it is still occasionally useful if an iterator has the following method (which also makes it an iterable):</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>All built-in ES6 iterators follow this pattern (via a common prototype, see <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators">the chapter on generators</a>). For example, the default iterator for Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">arr</code> <code class="o">=</code> <code class="p">[];</code>
<code class="o">&gt;</code> <code class="n">let</code> <code class="n">iterator</code> <code class="o">=</code> <code class="n">arr</code><code class="p">[</code><code class="n">Symbol</code><code class="p">.</code><code class="n">iterator</code><code class="p">]();</code>
<code class="o">&gt;</code> <code class="n">iterator</code><code class="p">[</code><code class="n">Symbol</code><code class="p">.</code><code class="n">iterator</code><code class="p">]()</code> <code class="o">===</code> <code class="n">iterator</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>Why is it useful if an iterator is also an iterable? <code>for-of</code> only works for iterables, not for iterators. Because Array iterators are iterable, you can continue an iteration in another loop:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">];</code>
<code class="kd">let</code> <code class="nx">iterator</code> <code class="o">=</code> <code class="nx">arr</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]();</code>

<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code> <code class="c1">// a</code>
    <code class="k">break</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">// Continue with same iterator:</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code> <code class="c1">// b</code>
<code class="p">}</code>
</pre></div>

</div>

<p>One use case for continuing an iteration is that you can remove initial items (e.g. a header) before processing the actual content via <code>for-of</code>.</p>

<h4 id="leanpub-auto-optional-iterator-methods-return-and-throw">
<span class="section-number">20.5.2 </span>Optional iterator methods: <code>return()</code> and <code>throw()</code>
</h4>

<p>Two iterator methods are optional:</p>

<ul>
<li>
<code>return()</code> gives an iterator the opportunity to clean up if an iteration ends prematurely.</li>
  <li>
<code>throw()</code> is about forwarding a method call to a generator that is iterated over via <code>yield*</code>. It is explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators">the chapter on generators</a>.</li>
</ul>
<h5 id="leanpub-auto-closing-iterators-via-return">
<span class="section-number">20.5.2.1 </span>Closing iterators via <code>return()</code>
</h5>


<p>As mentioned before, the optional iterator method <code>return()</code> is about letting an iterator clean up if it wasn’t iterated over until the end. It <em>closes</em> an iterator. In <code>for-of</code> loops, premature (or <em>abrupt</em>, in spec language) termination can be caused by:</p>

<ul>
<li><code>break</code></li>
  <li>
<code>continue</code> (if you continue an outer loop, <code>continue</code> acts like a <code>break</code>)</li>
  <li><code>throw</code></li>
  <li><code>return</code></li>
</ul>
<p>In each of these cases, <code>for-of</code> lets the iterator know that the loop won’t finish. Let’s look at an example, a function <code>readLinesSync</code> that returns an iterable of text lines in a file and would like to close that file no matter what happens:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">readLinesSync</code><code class="p">(</code><code class="nx">fileName</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">file</code> <code class="o">=</code> <code class="err">···</code><code class="p">;</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="err">···</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">file</code><code class="p">.</code><code class="nx">isAtEndOfFile</code><code class="p">())</code> <code class="p">{</code>
                <code class="nx">file</code><code class="p">.</code><code class="nx">close</code><code class="p">();</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
            <code class="p">}</code>
            <code class="err">···</code>
        <code class="p">},</code>
        <code class="k">return</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">file</code><code class="p">.</code><code class="nx">close</code><code class="p">();</code>
            <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
        <code class="p">},</code>
    <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Due to <code>return()</code>, the file will be properly closed in the following loop:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Only print first line</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">line</code> <code class="nx">of</code> <code class="nx">readLinesSync</code><code class="p">(</code><code class="nx">fileName</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="k">break</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The <code>return()</code> method must return an object. That is due to how generators handle the <code>return</code> statement and will be explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators">the chapter on generators</a>.</p>

<p>The following constructs close iterators that aren’t completely “drained”:</p>

<ul>
<li><code>for-of</code></li>
  <li><code>yield*</code></li>
  <li>Destructuring</li>
  <li><code>Array.from()</code></li>
  <li>
<code>Map()</code>, <code>Set()</code>, <code>WeakMap()</code>, <code>WeakSet()</code>
</li>
  <li>
<code>Promise.all()</code>, <code>Promise.race()</code>
</li>
</ul>
<p>A <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_closing-iterators">later section</a> has more information on closing iterators.</p>


<h3 id="leanpub-auto-more-examples-of-iterables">
<span class="section-number">20.6 </span>More examples of iterables</h3>

<p>In this section, we look at a few more examples of iterables. Most of these iterables are easier to implement via generators. <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators">The chapter on generators</a> shows how.</p>

<h4 id="objectEntries">
<span class="section-number">20.6.1 </span>Tool functions that return iterables</h4>

<p>Tool functions and methods that return iterables are just as important as iterable data structures. The following is a tool function for iterating over the own properties of an object.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">objectEntries</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">index</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

    <code class="c1">// In ES6, you can use strings or symbols as property keys,</code>
    <code class="c1">// Reflect.ownKeys() retrieves both</code>
    <code class="kd">let</code> <code class="nx">propKeys</code> <code class="o">=</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">ownKeys</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>

    <code class="k">return</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">index</code> <code class="o">&lt;</code> <code class="nx">propKeys</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
                <code class="kd">let</code> <code class="nx">key</code> <code class="o">=</code> <code class="nx">propKeys</code><code class="p">[</code><code class="nx">index</code><code class="p">];</code>
                <code class="nx">index</code><code class="o">++</code><code class="p">;</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="p">[</code><code class="nx">key</code><code class="p">,</code> <code class="nx">obj</code><code class="p">[</code><code class="nx">key</code><code class="p">]]</code> <code class="p">};</code>
            <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">};</code>
<code class="p">}</code>

<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="s1">'Jane'</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="s1">'Doe'</code> <code class="p">};</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">key</code><code class="p">,</code><code class="nx">value</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">objectEntries</code><code class="p">(</code><code class="nx">obj</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">$</code><code class="p">{</code><code class="nx">key</code><code class="p">}</code><code class="o">:</code> <code class="nx">$</code><code class="p">{</code><code class="nx">value</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
<code class="p">}</code>

<code class="c1">// Output:</code>
<code class="c1">// first: Jane</code>
<code class="c1">// last: Doe</code>
</pre></div>

</div>

<h4 id="leanpub-auto-combinators-for-iterables">
<span class="section-number">20.6.2 </span>Combinators for iterables</h4>

<p><em>Combinators</em><sup id="fnref-iteration_3"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-iteration_3" rel="footnote">3</a></sup> are functions that combine existing iterables to create new ones.</p>

<h5 id="sec_take">
<span class="section-number">20.6.2.1 </span><code>take(n, iterable)</code>
</h5>

<p>Let’s start with the combinator function <code>take(n, iterable)</code>, which returns an iterable over the first <code>n</code> items of <code>iterable</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">take</code><code class="p">(</code><code class="nx">n</code><code class="p">,</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">iter</code> <code class="o">=</code> <code class="nx">iterable</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]();</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">n</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">n</code><code class="o">--</code><code class="p">;</code>
                <code class="k">return</code> <code class="nx">iter</code><code class="p">.</code><code class="nx">next</code><code class="p">();</code>
            <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">};</code>
<code class="p">}</code>
<code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">,</code> <code class="s1">'d'</code><code class="p">];</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">take</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="nx">arr</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
</pre></div>

</div>

<table class="warning sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_warning.png" alt="warning" width="50">
</td>
    <td>
      <p>This version of <code>take()</code> doesn’t close the iterator <code>iter</code>. How to do that is <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_take_closing">shown later</a>, after <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_closing-iterators">I explain what closing an iterator actually means</a>.</p>

    </td>
  </tr></tbody></table>
<h5 id="sec_zip">
<span class="section-number">20.6.2.2 </span><code>zip(...iterables)</code>
</h5>

<p><code>zip</code> turns <em>n</em> iterables into an iterable of <em>n</em>-tuples (encoded as Arrays of length <em>n</em>).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">zip</code><code class="p">(...</code><code class="nx">iterables</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">iterators</code> <code class="o">=</code> <code class="nx">iterables</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">i</code> <code class="o">=&gt;</code> <code class="nx">i</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]());</code>
    <code class="kd">let</code> <code class="nx">done</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
                <code class="kd">let</code> <code class="nx">items</code> <code class="o">=</code> <code class="nx">iterators</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">i</code> <code class="o">=&gt;</code> <code class="nx">i</code><code class="p">.</code><code class="nx">next</code><code class="p">());</code>
                <code class="nx">done</code> <code class="o">=</code> <code class="nx">items</code><code class="p">.</code><code class="nx">some</code><code class="p">(</code><code class="nx">item</code> <code class="o">=&gt;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">done</code><code class="p">);</code>
                <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
                    <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">items</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">i</code> <code class="o">=&gt;</code> <code class="nx">i</code><code class="p">.</code><code class="nx">value</code><code class="p">)</code> <code class="p">};</code>
                <code class="p">}</code>
                <code class="c1">// Done for the first time: close all iterators</code>
                <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">iterator</code> <code class="nx">of</code> <code class="nx">iterators</code><code class="p">)</code> <code class="p">{</code>
                    <code class="nx">iterator</code><code class="p">.</code><code class="k">return</code><code class="p">();</code>
                <code class="p">}</code>
            <code class="p">}</code>
            <code class="c1">// We are done</code>
            <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>As you can see, the shortest iterable determines the length of the result:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">zipped</code> <code class="o">=</code> <code class="nx">zip</code><code class="p">([</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">],</code> <code class="p">[</code><code class="s1">'d'</code><code class="p">,</code> <code class="s1">'e'</code><code class="p">,</code> <code class="s1">'f'</code><code class="p">,</code> <code class="s1">'g'</code><code class="p">]);</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">zipped</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// ['a', 'd']</code>
<code class="c1">// ['b', 'e']</code>
<code class="c1">// ['c', 'f']</code>
</pre></div>

</div>

<h4 id="leanpub-auto-infinite-iterables">
<span class="section-number">20.6.3 </span>Infinite iterables</h4>

<p>Some iterable may never be <code>done</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">naturalNumbers</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">n</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">n</code><code class="o">++</code> <code class="p">};</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>With an infinite iterable, you must not iterate over “all” of it. For example, by breaking from a <code>for-of</code> loop:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">naturalNumbers</code><code class="p">())</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">x</code> <code class="o">&gt;</code> <code class="mi">2</code><code class="p">)</code> <code class="k">break</code><code class="p">;</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Or by only accessing the beginning of an infinite iterable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">,</code> <code class="nx">c</code><code class="p">]</code> <code class="o">=</code> <code class="nx">naturalNumbers</code><code class="p">();</code>
    <code class="c1">// a=0; b=1; c=2;</code>
</pre></div>

</div>

<p>Or by using a combinator. <code>take()</code> is one possibility:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">take</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="nx">naturalNumbers</code><code class="p">()))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// 0</code>
<code class="c1">// 1</code>
<code class="c1">// 2</code>
</pre></div>

</div>

<p>The “length” of the iterable returned by <code>zip()</code> is determined by its shortest input iterable. That means that <code>zip()</code> and <code>naturalNumbers()</code> provide you with the means to number iterables of arbitrary (finite) length:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">zipped</code> <code class="o">=</code> <code class="nx">zip</code><code class="p">([</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">],</code> <code class="nx">naturalNumbers</code><code class="p">());</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">zipped</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// ['a', 0]</code>
<code class="c1">// ['b', 1]</code>
<code class="c1">// ['c', 2]</code>
</pre></div>

</div>


<h3 id="leanpub-auto-faq-iterables-and-iterators">
<span class="section-number">20.7 </span>FAQ: iterables and iterators</h3>

<h4 id="sec_isnt_iteration_slow">
<span class="section-number">20.7.1 </span>Isn’t the iteration protocol slow?</h4>

<p>You may be worried about the iteration protocol being slow, because a new object is created for each invocation of <code>next()</code>. However, memory management for small objects is fast in modern engines and in the long run, engines can optimize iteration so that no intermediate objects need to be allocated. A <a href="https://esdiscuss.org/topic/performance-of-iterator-next-as-specified">thread on es-discuss</a> has more information.</p>

<h4 id="leanpub-auto-can-i-reuse-the-same-object-several-times">
<span class="section-number">20.7.2 </span>Can I reuse the same object several times?</h4>

<p>In principle, nothing prevents an iterator from reusing the same iteration result object several times – I’d expect most things to work well. However, there will be problems if a client caches iteration results:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">iterationResults</code> <code class="o">=</code> <code class="p">[];</code>
<code class="kd">let</code> <code class="nx">iterator</code> <code class="o">=</code> <code class="nx">iterable</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]();</code>
<code class="kd">let</code> <code class="nx">iterationResult</code><code class="p">;</code>
<code class="k">while</code> <code class="p">(</code><code class="o">!</code><code class="p">(</code><code class="nx">iterationResult</code> <code class="o">=</code> <code class="nx">iterator</code><code class="p">.</code><code class="nx">next</code><code class="p">()).</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">iterationResults</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">iterationResult</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>If an iterator reuses its iteration result object, <code>iterationResults</code> will, in general, contain the same object multiple times.</p>

<h4 id="leanpub-auto-why-doesnt-ecmascript-6-have-iterable-combinators">
<span class="section-number">20.7.3 </span>Why doesn’t ECMAScript 6 have iterable combinators?</h4>

<p>You may be wondering why ECMAScript 6 does not have <em>iterable combinators</em>, tools for working with iterables or for creating iterables. That is because the plans are to proceed in two steps:</p>

<ul>
<li>Step 1: standardize an iteration protocol.</li>
  <li>Step 2: wait for libraries based on that protocol.</li>
</ul>
<p>Eventually, one such library or pieces from several libraries will be added to the JavaScript standard library.</p>

<p>If you want to get an impression of what such a library could look like, take a look at the standard Python module <a href="https://docs.python.org/3/library/itertools.html"><code>itertools</code></a>.</p>

<h4 id="leanpub-auto-arent-iterables-difficult-to-implement">
<span class="section-number">20.7.4 </span>Aren’t iterables difficult to implement?</h4>

<p>Yes, iterables are difficult to implement – if you implement them manually. <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators">The next chapter</a> will introduce <em>generators</em> that help with this task (among other things).</p>


<h3 id="leanpub-auto-the-ecmascript-6-iteration-protocol-in-depth">
<span class="section-number">20.8 </span>The ECMAScript 6 iteration protocol in depth</h3>

<p>The iteration protocol comprises the following iterfaces (I have omitted <code>throw()</code> from <code>Iterator</code>, which is only supported by <code>yield*</code> and optional there):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">interface</code> <code class="nx">Iterable</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">System</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="o">:</code> <code class="nx">Iterator</code><code class="p">;</code>
<code class="p">}</code>
<code class="kr">interface</code> <code class="nx">Iterator</code> <code class="p">{</code>
    <code class="nx">next</code><code class="p">()</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
    <code class="k">return</code><code class="o">?</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
<code class="p">}</code>
<code class="kr">interface</code> <code class="nx">IteratorResult</code> <code class="p">{</code>
    <code class="nx">value</code> <code class="o">:</code> <code class="nx">any</code><code class="p">;</code>
    <code class="nx">done</code> <code class="o">:</code> <code class="kr">boolean</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>The spec has <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-iteration">a section on the iteration protocol</a>.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-iteration">
<span class="section-number">20.8.1 </span>Iteration</h4>

<p>Rules for <code>next()</code>:</p>

<ul>
<li>As long as the iterator still has values <code>x</code> to produce, <code>next()</code> returns objects <code>{ value: x, done: false }</code>.</li>
  <li>After the last value was iterated over, <code>next()</code> should always return an object whose property <code>done</code> is <code>true</code>.</li>
</ul>
<h5 id="leanpub-auto-the-iteratorresult">
<span class="section-number">20.8.1.1 </span>The <code>IteratorResult</code>
</h5>

<p>The property <code>done</code> of an iterator result doesn’t have to be <code>true</code> or <code>false</code>, truthy or falsy is enough. All built-in language mechanisms let you omit <code>done: false</code>.</p>

<h5 id="leanpub-auto-iterables-that-return-fresh-iterators-vs-those-that-always-return-the-same-iterator">
<span class="section-number">20.8.1.2 </span>Iterables that return fresh iterators vs. those that always return the same iterator</h5>

<p>Some iterables produce a new iterator each time they are asked for one. For example, Arrays:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">getIterator</code><code class="p">(</code><code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">iterable</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]();</code>
<code class="p">}</code>

<code class="kd">let</code> <code class="nx">iterable</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">];</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">getIterator</code><code class="p">(</code><code class="nx">iterable</code><code class="p">)</code> <code class="o">===</code> <code class="nx">getIterator</code><code class="p">(</code><code class="nx">iterable</code><code class="p">));</code> <code class="c1">// false</code>
</pre></div>

</div>

<p>Other iterables return the same iterator each time. For example, generator objects:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">elements</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
    <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>
<code class="p">}</code>
<code class="kd">let</code> <code class="nx">iterable</code> <code class="o">=</code> <code class="nx">elements</code><code class="p">();</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">getIterator</code><code class="p">(</code><code class="nx">iterable</code><code class="p">)</code> <code class="o">===</code> <code class="nx">getIterator</code><code class="p">(</code><code class="nx">iterable</code><code class="p">));</code> <code class="c1">// true</code>
</pre></div>

</div>

<p>Whether an iterable produces a fresh iterators or not matter when you iterate over the same iterable multiple times. For example, via the following function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">iterateTwice</code><code class="p">(</code><code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>With fresh iterators, you can iterate over the same iterable multiple times:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">iterateTwice</code><code class="p">([</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">]);</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
</pre></div>

</div>

<p>If the same iterator is returned each time, you can’t:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">iterateTwice</code><code class="p">(</code><code class="nx">elements</code><code class="p">());</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
</pre></div>

</div>

<p>Note that each iterator in the standard library is also an iterable. Its method <code>[Symbol.iterator]()</code> return <code>this</code>, meaning that it always returns the same iterator (itself).</p>

<h4 id="sec_closing-iterators">
<span class="section-number">20.8.2 </span>Closing iterators</h4>

<p>The iteration protocol distinguishes two ways of finishing an iterator:</p>

<ul>
<li>Exhaustion: the regular way of finishing an iterator is by retrieving all of its values. That is, one calls <code>next()</code> until it returns an object whose property <code>done</code> is <code>true</code>.</li>
  <li>Closing: by calling <code>return()</code>, you tell the iterator that you don’t intend to call <code>next()</code>, anymore.</li>
</ul>
<p>Rules for calling <code>return()</code>:</p>

<ul>
<li>
<code>return()</code> is an optional method, not all iterators have it. Iterators that do have it are called <em>closable</em>.</li>
  <li>
<code>return()</code> should only be called if an iterator hasn’t be exhausted. For example, <code>for-of</code> calls <code>return()</code> whenever it is left “abruptly” (before it is finished). The following operations cause abrupt exits: <code>break</code>, <code>continue</code> (with a label of an outer block), <code>return</code>, <code>throw</code>.</li>
</ul>
<p>Rules for implementing <code>return()</code>:</p>

<ul>
<li>The method call <code>return(x)</code> should normally produce the object <code>{ done: true, value: x }</code>, but language mechanisms only throw an error (<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-iteratorclose">source in spec</a>) if the result isn’t an object.</li>
  <li>After <code>return()</code> was called, the objects returned by <code>next()</code> should be <code>done</code>, too.</li>
</ul>
<p>The following code illustrates that the <code>for-of</code> loop calls <code>return()</code> if it is aborted before it receives a <code>done</code> iterator result. That is, <code>return()</code> is even called if you abort after receiving the last value. This is subtle and you have to be careful to get it right when you iterate manually or implement iterators.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">createIterable</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">done</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
    <code class="kd">let</code> <code class="nx">iterable</code> <code class="o">=</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">done</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="s1">'a'</code> <code class="p">};</code>
            <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="kc">undefined</code> <code class="p">};</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="k">return</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'return() was called!'</code><code class="p">);</code>
        <code class="p">},</code>
    <code class="p">};</code>
    <code class="k">return</code> <code class="nx">iterable</code><code class="p">;</code>
<code class="p">}</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">createIterable</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="c1">// There is only one value in the iterable and</code>
    <code class="c1">// we abort the loop after receiving it</code>
    <code class="k">break</code><code class="p">;</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// return() was called!</code>
</pre></div>

</div>

<h5 id="leanpub-auto-closable-iterators">
<span class="section-number">20.8.2.1 </span>Closable iterators</h5>

<p>An iterator is <em>closable</em> if it has a method <code>return()</code>. Not all iterators are closable. For example, Array iterators are not:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">iterable</code> <code class="o">=</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">,</code> <code class="sc">'c'</code><code class="p">];</code>
<code class="o">&gt;</code> <code class="n">let</code> <code class="n">iterator</code> <code class="o">=</code> <code class="n">iterable</code><code class="p">[</code><code class="n">Symbol</code><code class="p">.</code><code class="n">iterator</code><code class="p">]();</code>
<code class="o">&gt;</code> <code class="err">'</code><code class="k">return</code><code class="err">'</code> <code class="n">in</code> <code class="n">iterator</code>
<code class="nb">false</code>
</pre></div>

</div>

<p>Generator objects are closable by default. For example, the ones returned by the following generator function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">elements</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
    <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>
    <code class="k">yield</code> <code class="s1">'c'</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>If you invoke <code>return()</code> on the result of <code>elements()</code>, iteration is finished:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">iterator</code> <code class="o">=</code> <code class="n">elements</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">iterator</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="sc">'a'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">iterator</code><code class="p">.</code><code class="k">return</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">true</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">iterator</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">true</code> <code class="p">}</code>
</pre></div>

</div>

<p>If an iterator is not closable, you can continue iterating over it after an abrupt exit (such as the one in line A) from a <code>for-of</code> loop:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">twoLoops</code><code class="p">(</code><code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
        <code class="k">break</code><code class="p">;</code> <code class="c1">// (A)</code>
    <code class="p">}</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">getIterator</code><code class="p">(</code><code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">iterable</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]();</code>
<code class="p">}</code>

<code class="nx">twoLoops</code><code class="p">(</code><code class="nx">getIterator</code><code class="p">([</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">]));</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
<code class="c1">// c</code>
</pre></div>

</div>

<p>Conversely, <code>elements()</code> returns a closable iterator and the second loop inside <code>twoLoops()</code> doesn’t have anything to iterate over:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">twoLoops</code><code class="p">(</code><code class="nx">elements</code><code class="p">());</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
</pre></div>

</div>

<h5 id="leanpub-auto-preventing-iterators-from-being-closed">
<span class="section-number">20.8.2.2 </span>Preventing iterators from being closed</h5>

<p>The following class is a generic solution for preventing iterators from being closed. It does so by wrapping the iterator and forwarding all method calls except <code>return()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">PreventReturn</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">iterator</code> <code class="o">=</code> <code class="nx">iterator</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="cm">/** Must also be iterable, so that for-of works */</code>
    <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">iterator</code><code class="p">.</code><code class="nx">next</code><code class="p">();</code>
    <code class="p">}</code>
    <code class="k">return</code><code class="p">(</code><code class="nx">value</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code> <code class="nx">value</code> <code class="p">};</code>
    <code class="p">}</code>
    <code class="c1">// Not relevant for iterators: `throw()`</code>
<code class="p">}</code>
</pre></div>

</div>

<p>If we use <code>PreventReturn</code>, the result of the generator <code>elements()</code> won’t be closed after the abrupt exit in the first loop of <code>twoLoops()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">elements</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
    <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>
    <code class="k">yield</code> <code class="s1">'c'</code><code class="p">;</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">twoLoops</code><code class="p">(</code><code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
        <code class="k">break</code><code class="p">;</code> <code class="c1">// abrupt exit</code>
    <code class="p">}</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="nx">twoLoops</code><code class="p">(</code><code class="nx">elements</code><code class="p">());</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>

<code class="nx">twoLoops</code><code class="p">(</code><code class="k">new</code> <code class="nx">PreventReturn</code><code class="p">(</code><code class="nx">elements</code><code class="p">()));</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
<code class="c1">// c</code>
</pre></div>

</div>

<p>There is an another way of making generators unclosable: All generator objects produced by the generator function <code>elements()</code> have the prototype object <code>elements.prototype</code>. Via <code>elements.prototype</code>, you can hide the default implementation of <code>return()</code> (which resides in a prototype of <code>elements.prototype</code>) as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Make generator object unclosable</code>
<code class="c1">// Warning: may not work in transpilers</code>
<code class="nx">elements</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="k">return</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">;</code>

<code class="nx">twoLoops</code><code class="p">(</code><code class="nx">elements</code><code class="p">());</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
<code class="c1">// c</code>
</pre></div>

</div>

<h5 id="leanpub-auto-handling-clean-up-in-generators-via-try-finally">
<span class="section-number">20.8.2.3 </span>Handling clean-up in generators via <code>try-finally</code>
</h5>

<p>Some generators need to clean up (release allocated resources, close open files, etc.) after iteration over them is finished. Naively, this is how we’d implement it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
    <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>

    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Performing cleanup'</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In a normal <code>for-of</code> loop, everything is fine:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">genFunc</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
<code class="c1">// Performing cleanup</code>
</pre></div>

</div>

<p>However, if you exit the loop after the first <code>yield</code>, execution seemingly pauses there forever and never reaches the cleanup step:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">genFunc</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="k">break</code><code class="p">;</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
</pre></div>

</div>

<p>What actually happens is that, whenever one leaves a <code>for-of</code> loop early, <code>for-of</code> sends a <code>return()</code> to the current iterator. That means that the cleanup step isn’t reached because the generator function returns beforehand.</p>

<p>Thankfully, this is easily fixed, by performing the cleanup in a <code>finally</code> clause:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
        <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Performing cleanup'</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Now everything works as desired:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">genFunc</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="k">break</code><code class="p">;</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// Performing cleanup</code>
</pre></div>

</div>

<p>The general pattern for using resources that need to be closed or cleaned up in some manner is therefore:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">funcThatUsesResource</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">resource</code> <code class="o">=</code> <code class="nx">allocateResource</code><code class="p">();</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="nx">resource</code><code class="p">.</code><code class="nx">deallocate</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-handling-clean-up-in-manually-implemented-iterators">
<span class="section-number">20.8.2.4 </span>Handling clean-up in manually implemented iterators</h5>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">iterable</code> <code class="o">=</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
        <code class="kd">function</code> <code class="nx">hasNextValue</code><code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
        <code class="kd">function</code> <code class="nx">getNextValue</code><code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
        <code class="kd">function</code> <code class="nx">cleanUp</code><code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
        <code class="kd">let</code> <code class="nx">returnedDoneResult</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
        <code class="k">return</code> <code class="p">{</code>
            <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="nx">hasNextValue</code><code class="p">())</code> <code class="p">{</code>
                    <code class="kd">let</code> <code class="nx">value</code> <code class="o">=</code> <code class="nx">getNextValue</code><code class="p">();</code>
                    <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">value</code> <code class="p">};</code>
                <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">returnedDoneResult</code><code class="p">)</code> <code class="p">{</code>
                        <code class="c1">// Client receives first `done` iterator result</code>
                        <code class="c1">// =&gt; won’t call `return()`</code>
                        <code class="nx">cleanUp</code><code class="p">();</code>
                        <code class="nx">returnedDoneResult</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
                    <code class="p">}</code>
                    <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="nx">value</code><code class="o">:</code> <code class="kc">undefined</code> <code class="p">};</code>
                <code class="p">}</code>
            <code class="p">},</code>
            <code class="k">return</code><code class="p">()</code> <code class="p">{</code>
                <code class="nx">cleanUp</code><code class="p">();</code>
            <code class="p">}</code>
        <code class="p">};</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Note that you must call <code>cleanUp()</code> when you are going to return a <code>done</code> iterator result for the first time. You must not do it earlier, because then <code>return()</code> may still be called. This can be tricky to get right.</p>

<h5 id="sec_take_closing">
<span class="section-number">20.8.2.5 </span>Closing iterators you use</h5>

<p>If you use iterators, you should close them properly. In generators, you can let <code>for-of</code> do all the work for you:</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Converts a (potentially infinite) sequence of</code>
<code class="cm"> * iterated values into a sequence of length `n`</code>
<code class="cm"> */</code>
<code class="kd">function</code><code class="o">*</code> <code class="nx">take</code><code class="p">(</code><code class="nx">n</code><code class="p">,</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">n</code> <code class="o">&lt;=</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">break</code><code class="p">;</code> <code class="c1">// closes iterable</code>
        <code class="p">}</code>
        <code class="nx">n</code><code class="o">--</code><code class="p">;</code>
        <code class="k">yield</code> <code class="nx">x</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>If you manage things manually, more work is required:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">take</code><code class="p">(</code><code class="nx">n</code><code class="p">,</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">iterator</code> <code class="o">=</code> <code class="nx">iterable</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]();</code>
    <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="p">{</code><code class="nx">value</code><code class="p">,</code> <code class="nx">done</code><code class="p">}</code> <code class="o">=</code> <code class="nx">iterator</code><code class="p">.</code><code class="nx">next</code><code class="p">();</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="k">break</code><code class="p">;</code> <code class="c1">// exhausted</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">n</code> <code class="o">&lt;=</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="c1">// Abrupt exit</code>
            <code class="nx">maybeCloseIterator</code><code class="p">(</code><code class="nx">iterator</code><code class="p">);</code>
            <code class="k">break</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="k">yield</code> <code class="nx">value</code><code class="p">;</code>
        <code class="nx">n</code><code class="o">--</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">maybeCloseIterator</code><code class="p">(</code><code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">iterator</code><code class="p">.</code><code class="k">return</code> <code class="o">===</code> <code class="s1">'function'</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">iterator</code><code class="p">.</code><code class="k">return</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Even more work is necessary if you don’t use generators:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">take</code><code class="p">(</code><code class="nx">n</code><code class="p">,</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">iter</code> <code class="o">=</code> <code class="nx">iterable</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]();</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">n</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">n</code><code class="o">--</code><code class="p">;</code>
                <code class="k">return</code> <code class="nx">iter</code><code class="p">.</code><code class="nx">next</code><code class="p">();</code>
            <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="nx">maybeCloseIterator</code><code class="p">(</code><code class="nx">iter</code><code class="p">);</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="k">return</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">n</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
            <code class="nx">maybeCloseIterator</code><code class="p">(</code><code class="nx">iter</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-checklist">
<span class="section-number">20.8.3 </span>Checklist</h4>

<ul>
<li>Documenting an iterable: provide the following information.
    <ul>
<li>Does it return fresh iterators or the same iterator each time?</li>
      <li>Are its iterators closable?</li>
    </ul>
</li>
  <li>Implementing an iterator:
    <ul>
<li>Clean-up activity must happen if either an iterator is exhausted or if <code>return()</code> is called.
        <ul>
<li>In generators, <code>try-finally</code> lets you handle both in a single location.</li>
        </ul>
</li>
      <li>After an iterator was closed via <code>return()</code>, it should not produce any more iterator results via <code>next()</code>.</li>
    </ul>
</li>
  <li>Using an iterator manually (vs. via <code>for-of</code> etc.):
    <ul>
<li>Don’t forget to close the iterator via <code>return</code>, if – and only if – you don’t exhaust it. Getting this right can be tricky.</li>
    </ul>
</li>
  <li>Continuing to iterate over an iterator after an abrupt exit: The iterator must either be unclosable or made unclosable (e.g. via a tool class).</li>
</ul>
<div class="footnotes">
  <ol>
<li id="fn-iteration_1">[Speaking JS] “<a href="http://speakingjs.com/es5/ch17.html#_pitfalls_using_an_object_as_a_map">Pitfalls: Using an Object as a Map</a>”<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-iteration_1" rel="rev-footnote">↩</a>
</li>
    <li id="fn-iteration_2">Based on “<a href="https://github.com/rwaldron/tc39-notes/blob/master/es6/2014-06/closing-iterators.pdf">Closing iterators</a>”, slides by David Herman.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-iteration_2" rel="rev-footnote">↩</a>
</li>
    <li id="fn-iteration_3">“<a href="https://wiki.haskell.org/Combinator">Combinator</a>” (in HaskellWiki) describes what combinators are.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-iteration_3" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h2 id="ch_generators">
<span class="section-number">21. </span>Generators</h2>

<p>Generators, a new feature of ECMAScript 6, are functions that can be paused and resumed (think cooperative multitasking or coroutines). This helps with many applications: iterators, asynchronous programming, etc. This chapter explains how generators work and gives an overview of their applications.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>The following GitHub repository contains the example code: <a href="https://github.com/rauschma/generator-examples"><code>generator-examples</code></a></p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-overview-13">
<span class="section-number">21.1 </span>Overview</h3>

<p>Two important applications of generators are:</p>

<ol class="numeric numeric">
<li>Implementing iterables</li>
  <li>Blocking on asynchronous function calls</li>
</ol>
<p>The following subsections give brief overviews of these applications, more thorough explanations are provided later (plus discussions of other applications).</p>

<h4 id="leanpub-auto-implementing-iterables-via-generators">
<span class="section-number">21.1.1 </span>Implementing iterables via generators</h4>

<p>The following function returns an iterable over the properties of an object, one [key, value] pair per property:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// The asterisk after `function` means that</code>
<code class="c1">// `objectEntries` is a generator</code>
<code class="kd">function</code><code class="o">*</code> <code class="nx">objectEntries</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">propKeys</code> <code class="o">=</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">ownKeys</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>

    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">propKey</code> <code class="nx">of</code> <code class="nx">propKeys</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// `yield` returns a value and then pauses</code>
        <code class="c1">// the generator. Later, execution continues</code>
        <code class="c1">// where it was previously paused.</code>
        <code class="k">yield</code> <code class="p">[</code><code class="nx">propKey</code><code class="p">,</code> <code class="nx">obj</code><code class="p">[</code><code class="nx">propKey</code><code class="p">]];</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>How exactly <code>objectEntries()</code> works is explained later. It is used like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">jane</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="s1">'Jane'</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="s1">'Doe'</code> <code class="p">};</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">key</code><code class="p">,</code><code class="nx">value</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">objectEntries</code><code class="p">(</code><code class="nx">jane</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">$</code><code class="p">{</code><code class="nx">key</code><code class="p">}</code><code class="o">:</code> <code class="nx">$</code><code class="p">{</code><code class="nx">value</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// first: Jane</code>
<code class="c1">// last: Doe</code>
</pre></div>

</div>

<h4 id="leanpub-auto-blocking-on-asynchronous-function-calls">
<span class="section-number">21.1.2 </span>Blocking on asynchronous function calls</h4>

<p>In the following code, I use <a href="https://github.com/tj/co">the control flow library co</a> to asynchronously retrieve two JSON files. Note how, in line A, execution blocks (waits) until the result of <code>Promise.all()</code> is ready. That means that the code looks synchronous while performing asynchronous operations.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">co</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="p">[</code><code class="nx">croftStr</code><code class="p">,</code> <code class="nx">bondStr</code><code class="p">]</code> <code class="o">=</code> <code class="k">yield</code> <code class="nx">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">([</code>  <code class="c1">// (A)</code>
            <code class="nx">getFile</code><code class="p">(</code><code class="s1">'http://localhost:8000/croft.json'</code><code class="p">),</code>
            <code class="nx">getFile</code><code class="p">(</code><code class="s1">'http://localhost:8000/bond.json'</code><code class="p">),</code>
        <code class="p">]);</code>
        <code class="kd">let</code> <code class="nx">croftJson</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">croftStr</code><code class="p">);</code>
        <code class="kd">let</code> <code class="nx">bondJson</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">bondStr</code><code class="p">);</code>

        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">croftJson</code><code class="p">);</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">bondJson</code><code class="p">);</code>
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Failure to read: '</code> <code class="o">+</code> <code class="nx">e</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p><code>getFile(url)</code> retrieves the file pointed to by <code>url</code>. Its implementation is shown later. I’ll also explain how <code>co</code> works.</p>


<h3 id="leanpub-auto-what-are-generators">
<span class="section-number">21.2 </span>What are generators?</h3>

<p><em>Generators</em> are functions that can be paused and resumed (think cooperative multitasking or coroutines), which enables a variety of applications.</p>

<p>As a first example, consider the following generator function whose name is <code>genFunc</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'First'</code><code class="p">);</code>
    <code class="k">yield</code><code class="p">;</code> <code class="c1">// (A)</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Second'</code><code class="p">);</code> <code class="c1">// (B)</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Two things distinguish <code>genFunc</code> from a normal function declaration:</p>

<ul>
<li>It starts with the “keyword” <code>function*</code>.</li>
  <li>It is paused in the middle via <code>yield</code>.</li>
</ul>
<p>Calling <code>genFunc</code> does not execute it. Instead, it returns a so-called <em>generator object</em> that lets us control <code>genFunc</code>’s execution:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">genObj</code> <code class="o">=</code> <code class="n">genFunc</code><code class="p">();</code>
</pre></div>

</div>

<p><code>genFunc()</code> is initially suspended at the beginning of its body. The method <code>genObj.next()</code> continues the execution of <code>genFunc</code>, until the next <code>yield</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">genObj</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="n">First</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
</pre></div>

</div>

<p>As you can see in the last line, <code>genObj.next()</code> also returns an object. Let’s ignore that for now. It will matter once we look at generators as iterators.</p>

<p><code>genFunc</code> is now paused in line A. If we call <code>next()</code> again, execution resumes and line B is executed:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">genObj</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="n">Second</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">true</code> <code class="p">}</code>
</pre></div>

</div>

<p>Afterwards, the function is finished, execution has left the body and further calls of <code>genObj.next()</code> have no effect.</p>

<h4 id="leanpub-auto-ways-of-creating-generators">
<span class="section-number">21.2.1 </span>Ways of creating generators</h4>

<p>There are four ways in which you can create generators:</p>

<ol class="numeric numeric">
<li>Via a generator function declaration:
    <div class="code-block">
<div class="highlight"><pre> <code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc</code><code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>
 <code class="kd">let</code> <code class="nx">genObj</code> <code class="o">=</code> <code class="nx">genFunc</code><code class="p">();</code>
</pre></div>
    
</div>
  </li>
  <li>Via a generator function expression:
    <div class="code-block">
<div class="highlight"><pre> <code class="kr">const</code> <code class="nx">genFunc</code> <code class="o">=</code> <code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">};</code>
 <code class="kd">let</code> <code class="nx">genObj</code> <code class="o">=</code> <code class="nx">genFunc</code><code class="p">();</code>
</pre></div>
    
</div>
  </li>
  <li>Via a generator method definition in an object literal:
    <div class="code-block">
<div class="highlight"><pre> <code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
     <code class="o">*</code> <code class="nx">generatorMethod</code><code class="p">()</code> <code class="p">{</code>
         <code class="err">···</code>
     <code class="p">}</code>
 <code class="p">};</code>
 <code class="kd">let</code> <code class="nx">genObj</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">generatorMethod</code><code class="p">();</code>
</pre></div>
    
</div>
  </li>
  <li>Via a generator method definition in a class definition (which can be a class declaration or a class expression):
    <div class="code-block">
<div class="highlight"><pre> <code class="kr">class</code> <code class="nx">MyClass</code> <code class="p">{</code>
     <code class="o">*</code> <code class="nx">generatorMethod</code><code class="p">()</code> <code class="p">{</code>
         <code class="err">···</code>
     <code class="p">}</code>
 <code class="p">}</code>
 <code class="kd">let</code> <code class="nx">myInst</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyClass</code><code class="p">();</code>
 <code class="kd">let</code> <code class="nx">genObj</code> <code class="o">=</code> <code class="nx">myInst</code><code class="p">.</code><code class="nx">generatorMethod</code><code class="p">();</code>
</pre></div>
    
</div>
  </li>
</ol>
<h4 id="leanpub-auto-roles-played-by-generators">
<span class="section-number">21.2.2 </span>Roles played by generators</h4>

<p>Generators can play three roles:</p>

<ol class="numeric numeric">
<li>Iterators (data producers): Each <code>yield</code> can return a value via <code>next()</code>, which means that generators can produce sequences of values via loops and recursion. Due to generator objects implementing the interface <code>Iterable</code> (which is explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_iteration">the chapter on iteration</a>), these sequences can be processed by any ECMAScript 6 construct that supports iterables. Two examples are: <code>for-of</code> loops and the spread operator (<code>...</code>).</li>
  <li>Observers (data consumers): <code>yield</code> can also receive a value from <code>next()</code> (via a parameter). That means that generators become data consumers that pause until a new value is pushed into them via <code>next()</code>.</li>
  <li>Coroutines (data producers and consumers): Given that generators are pausable and can be both data producers and data consumers, not much work is needed to turn them into coroutines (cooperatively multitasked tasks).</li>
</ol>
<p>The next sections provide deeper explanations of these roles.</p>


<h3 id="leanpub-auto-generators-as-iterators-data-production">
<span class="section-number">21.3 </span>Generators as iterators (data production)</h3>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_eye.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>For this section, you should be familiar with ES6 iteration. <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_iteration">The previous chapter</a> has more information.</p>

    </td>
  </tr></tbody></table>
<p>As explained before, generator objects can be data producers, data consumers or both. This section looks at them as data producers, where they implement both the interfaces <code>Iterable</code> and <code>Iterator</code> (shown below). That means that the result of a generator function is both an iterable and an iterator. The full interface of generator objects will be shown later.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">interface</code> <code class="nx">Iterable</code> <code class="p">{</code>
    <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="o">:</code> <code class="nx">Iterator</code><code class="p">;</code>
<code class="p">}</code>
<code class="kr">interface</code> <code class="nx">Iterator</code> <code class="p">{</code>
    <code class="nx">next</code><code class="p">()</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
    <code class="k">return</code><code class="o">?</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
<code class="p">}</code>
<code class="kr">interface</code> <code class="nx">IteratorResult</code> <code class="p">{</code>
    <code class="nx">value</code> <code class="o">:</code> <code class="nx">any</code><code class="p">;</code>
    <code class="nx">done</code> <code class="o">:</code> <code class="kr">boolean</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>A generator function produces a sequence of values via <code>yield</code>, a data consumer consumes thoses values via the iterator method <code>next()</code>. For example, the following generator function produces the values <code>'a'</code> and <code>'b'</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
    <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This interaction shows how to retrieve the yielded values via the generator object <code>genObj</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">genObj</code> <code class="o">=</code> <code class="n">genFunc</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">genObj</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="sc">'a'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">genObj</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="sc">'b'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">genObj</code><code class="p">.</code><code class="n">next</code><code class="p">()</code> <code class="c1">// done: true =&gt; end of sequence</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">true</code> <code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-ways-of-iterating-over-a-generator">
<span class="section-number">21.3.1 </span>Ways of iterating over a generator</h4>

<p>As generator objects are iterable, ES6 language constructs that support iterables can be applied to them. The following three ones are especially important.</p>

<p>First, the <code>for-of</code> loop:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">genFunc</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
</pre></div>

</div>

<p>Second, the spread operator (<code>...</code>), which turns iterated sequences into elements of an array (consult <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_spread-operator">the chapter on parameter handling</a> for more information on this operator):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">genFunc</code><code class="p">()];</code> <code class="c1">// ['a', 'b']</code>
</pre></div>

</div>

<p>Third, destructuring:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="p">[</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">]</code> <code class="o">=</code> <code class="n">genFunc</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">x</code>
<code class="sc">'a'</code>
<code class="o">&gt;</code> <code class="n">y</code>
<code class="sc">'b'</code>
</pre></div>

</div>

<h4 id="leanpub-auto-returning-from-a-generator">
<span class="section-number">21.3.2 </span>Returning from a generator</h4>

<p>The previous generator function did not contain an explicit <code>return</code>. An implicit <code>return</code> is equivalent to returning <code>undefined</code>. Let’s examine a generator with an explicit <code>return</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFuncWithReturn</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
    <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>
    <code class="k">return</code> <code class="s1">'result'</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The returned value shows up in the last object returned by <code>next()</code>, whose property <code>done</code> is <code>true</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">genObjWithReturn</code> <code class="o">=</code> <code class="n">genFuncWithReturn</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">genObjWithReturn</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="sc">'a'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">genObjWithReturn</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="sc">'b'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">genObjWithReturn</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="err">'</code><code class="n">result</code><code class="err">'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">true</code> <code class="p">}</code>
</pre></div>

</div>

<p>However, most constructs that work with iterables ignore the value inside the <code>done</code> object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">genFuncWithReturn</code><code class="p">())</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>

<code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">genFuncWithReturn</code><code class="p">()];</code> <code class="c1">// ['a', 'b']</code>
</pre></div>

</div>

<p><code>yield*</code>, an operator for making recursive generator calls, does consider values inside <code>done</code> objects. It is explained later.</p>

<h4 id="leanpub-auto-example-iterating-over-properties">
<span class="section-number">21.3.3 </span>Example: iterating over properties</h4>

<p>Let’s look at an example that demonstrates how convenient generators are for implementing iterables. The following function, <code>objectEntries()</code>, returns an iterable over the properties of an object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">objectEntries</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// In ES6, you can use strings or symbols as property keys,</code>
    <code class="c1">// Reflect.ownKeys() retrieves both</code>
    <code class="kd">let</code> <code class="nx">propKeys</code> <code class="o">=</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">ownKeys</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>

    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">propKey</code> <code class="nx">of</code> <code class="nx">propKeys</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="p">[</code><code class="nx">propKey</code><code class="p">,</code> <code class="nx">obj</code><code class="p">[</code><code class="nx">propKey</code><code class="p">]];</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This function enables you to iterate over the properties of an object <code>jane</code> via the <code>for-of</code> loop:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">jane</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">first</code><code class="o">:</code> <code class="s1">'Jane'</code><code class="p">,</code> <code class="nx">last</code><code class="o">:</code> <code class="s1">'Doe'</code> <code class="p">};</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="p">[</code><code class="nx">key</code><code class="p">,</code><code class="nx">value</code><code class="p">]</code> <code class="nx">of</code> <code class="nx">objectEntries</code><code class="p">(</code><code class="nx">jane</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">$</code><code class="p">{</code><code class="nx">key</code><code class="p">}</code><code class="o">:</code> <code class="nx">$</code><code class="p">{</code><code class="nx">value</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// first: Jane</code>
<code class="c1">// last: Doe</code>
</pre></div>

</div>

<p>For comparison – an implementation of <code>objectEntries()</code> that doesn’t use generators is much more complicated:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">objectEntries</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">index</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
    <code class="kd">let</code> <code class="nx">propKeys</code> <code class="o">=</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">ownKeys</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>

    <code class="k">return</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">index</code> <code class="o">&lt;</code> <code class="nx">propKeys</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
                <code class="kd">let</code> <code class="nx">key</code> <code class="o">=</code> <code class="nx">propKeys</code><code class="p">[</code><code class="nx">index</code><code class="p">];</code>
                <code class="nx">index</code><code class="o">++</code><code class="p">;</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="p">[</code><code class="nx">key</code><code class="p">,</code> <code class="nx">obj</code><code class="p">[</code><code class="nx">key</code><code class="p">]]</code> <code class="p">};</code>
            <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-you-can-only-yield-in-generators">
<span class="section-number">21.3.4 </span>You can only <code>yield</code> in generators</h4>

<p>A significant limitation of generators is that you can only yield while you are (statically) inside a generator function. That is, yielding in callbacks doesn’t work:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc</code><code class="p">()</code> <code class="p">{</code>
    <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">].</code><code class="nx">forEach</code><code class="p">(</code><code class="nx">x</code> <code class="o">=&gt;</code> <code class="k">yield</code> <code class="nx">x</code><code class="p">);</code> <code class="c1">// SyntaxError</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>yield</code> is not allowed inside non-generator functions, which is why the previous code causes a syntax error. In this case, it is easy to rewrite the code so that it doesn’t use callbacks (as shown below). But unfortunately that isn’t always possibe.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">])</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="nx">x</code><code class="p">;</code> <code class="c1">// OK</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The upsides of this limitation are explained later: they make generators easier to implement and compatible with event loops.</p>

<h4 id="leanpub-auto-recursion-via-yield-for-output">
<span class="section-number">21.3.5 </span>Recursion via <code>yield*</code> (for output)</h4>

<p>You can only use <code>yield</code> within a generator function. Therefore, if you want to implement a recursive algorithm with generator, you need a way to call one generator from another one. This section shows that that is more complicated than it sounds, which is why ES6 has a special operator, <code>yield*</code>, for this. For now, I only explain how <code>yield*</code> works if both generators produce output, I’ll later explain how things work if input is involved.</p>

<p>How can one generator recursively call another generator? Let’s assume you have written a generator function <code>foo</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">foo</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
    <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>How would you call <code>foo</code> from another generator function <code>bar</code>? The following approach does not work!</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">bar</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'x'</code><code class="p">;</code>
    <code class="nx">foo</code><code class="p">();</code> <code class="c1">// does nothing!</code>
    <code class="k">yield</code> <code class="s1">'y'</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Calling <code>foo()</code> returns an object, but does not actually execute <code>foo()</code>. That’s why ECMAScript 6 has the operator <code>yield*</code> for making recursive generator calls:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">bar</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'x'</code><code class="p">;</code>
    <code class="k">yield</code><code class="o">*</code> <code class="nx">foo</code><code class="p">();</code>
    <code class="k">yield</code> <code class="s1">'y'</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">// Collect all values yielded by bar() in an array</code>
<code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">bar</code><code class="p">()];</code>
    <code class="c1">// ['x', 'a', 'b', 'y']</code>
</pre></div>

</div>

<p>Internally, <code>yield*</code> works roughly as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">bar</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'x'</code><code class="p">;</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">value</code> <code class="nx">of</code> <code class="nx">foo</code><code class="p">())</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="nx">value</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">yield</code> <code class="s1">'y'</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The operand of <code>yield*</code> does not have to be a generator object, it can be any iterable:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">bla</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'sequence'</code><code class="p">;</code>
    <code class="k">yield</code><code class="o">*</code> <code class="p">[</code><code class="s1">'of'</code><code class="p">,</code> <code class="s1">'yielded'</code><code class="p">];</code>
    <code class="k">yield</code> <code class="s1">'values'</code><code class="p">;</code>
<code class="p">}</code>

<code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[...</code><code class="nx">bla</code><code class="p">()];</code>
    <code class="c1">// ['sequence', 'of', 'yielded', 'values']</code>
</pre></div>

</div>

<h5 id="leanpub-auto-yield-considers-end-of-iteration-values">
<span class="section-number">21.3.5.1 </span><code>yield*</code> considers end-of-iteration values</h5>

<p>Most constructs that support iterables ignore the value included in the end-of-iteration object (whose property <code>done</code> is <code>true</code>). Generators provide that value via <code>return</code>. The result of <code>yield*</code> is the end-of-iteration value:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFuncWithReturn</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
    <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>
    <code class="k">return</code> <code class="s1">'The result'</code><code class="p">;</code>
<code class="p">}</code>
<code class="kd">function</code><code class="o">*</code> <code class="nx">logReturned</code><code class="p">(</code><code class="nx">genObj</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="k">yield</code><code class="o">*</code> <code class="nx">genObj</code><code class="p">;</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result</code><code class="p">);</code> <code class="c1">// (A)</code>
<code class="p">}</code>
</pre></div>

</div>

<p>If we want to get to line A, we first must iterate over all values yielded by <code>logReturned()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[...</code><code class="n">logReturned</code><code class="p">(</code><code class="n">genFuncWithReturn</code><code class="p">())]</code>
<code class="n">The</code> <code class="n">result</code>
<code class="p">[</code> <code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code> <code class="p">]</code>
</pre></div>

</div>

<h5 id="leanpub-auto-iterating-over-trees">
<span class="section-number">21.3.5.2 </span>Iterating over trees</h5>

<p>Iterating over a tree with recursion is simple, writing an iterator for a tree with traditional means is complicated. That’s why generators shine here: they let you implement an iterator via recursion. As an example, consider the following data structure for binary trees. It is iterable, because it has a method whose key is <code>Symbol.iterator</code>. That method is a generator method and returns an iterator when called.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">BinaryTree</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">value</code><code class="p">,</code> <code class="nx">left</code><code class="o">=</code><code class="kc">null</code><code class="p">,</code> <code class="nx">right</code><code class="o">=</code><code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="nx">value</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">left</code> <code class="o">=</code> <code class="nx">left</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">right</code> <code class="o">=</code> <code class="nx">right</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="cm">/** Prefix iteration */</code>
    <code class="o">*</code> <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
        <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">left</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">yield</code><code class="o">*</code> <code class="k">this</code><code class="p">.</code><code class="nx">left</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">right</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">yield</code><code class="o">*</code> <code class="k">this</code><code class="p">.</code><code class="nx">right</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The following code creates a binary tree and iterates over it via <code>for-of</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">tree</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">BinaryTree</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code>
    <code class="k">new</code> <code class="nx">BinaryTree</code><code class="p">(</code><code class="s1">'b'</code><code class="p">,</code>
        <code class="k">new</code> <code class="nx">BinaryTree</code><code class="p">(</code><code class="s1">'c'</code><code class="p">),</code>
        <code class="k">new</code> <code class="nx">BinaryTree</code><code class="p">(</code><code class="s1">'d'</code><code class="p">)),</code>
    <code class="k">new</code> <code class="nx">BinaryTree</code><code class="p">(</code><code class="s1">'e'</code><code class="p">));</code>

<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">tree</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
<code class="c1">// c</code>
<code class="c1">// d</code>
<code class="c1">// e</code>
</pre></div>

</div>


<h3 id="leanpub-auto-generators-as-observers-data-consumption">
<span class="section-number">21.4 </span>Generators as observers (data consumption)</h3>

<p>As consumers of data, generator objects conform to the second half of the generator interface, <code>Observer</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">interface</code> <code class="nx">Observer</code> <code class="p">{</code>
    <code class="nx">next</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="k">void</code><code class="p">;</code>
    <code class="k">return</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="k">void</code><code class="p">;</code>
    <code class="k">throw</code><code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="o">:</code> <code class="k">void</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>As an observer, a generator pauses until it receives input. There are three kinds of input, transmitted via the methods specified by the interface:</p>

<ul>
<li>
<code>next()</code> sends normal input.</li>
  <li>
<code>return()</code> terminates the generator.</li>
  <li>
<code>throw()</code> signals an error.</li>
</ul>
<h4 id="leanpub-auto-sending-values-via-next">
<span class="section-number">21.4.1 </span>Sending values via <code>next()</code>
</h4>

<p>If you use a generator as an observer, you send values to it via <code>next()</code> and it receives those values via <code>yield</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">dataConsumer</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Started'</code><code class="p">);</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="mi">1</code><code class="p">.</code> <code class="nx">$</code><code class="p">{</code><code class="k">yield</code><code class="p">}</code><code class="err">`</code><code class="p">);</code> <code class="c1">// (A)</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="mi">2</code><code class="p">.</code> <code class="nx">$</code><code class="p">{</code><code class="k">yield</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
    <code class="k">return</code> <code class="s1">'result'</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Let’s use this generator interactively. First, we create a generator object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">genObj</code> <code class="o">=</code> <code class="n">dataConsumer</code><code class="p">();</code>
</pre></div>

</div>

<p>We now call <code>genObj.next()</code>, which starts the generator. Execution continues until the first <code>yield</code>, which is where the generator pauses. The result of <code>next()</code> is the value yielded in line A (<code>undefined</code>, because <code>yield</code> doesn’t have an operand). In this section, we are not interested in what <code>next()</code> returns, because we only use it to send values, not to retrieve values.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="nx">genObj</code><code class="p">.</code><code class="nx">next</code><code class="p">()</code>
<code class="nx">Started</code>
<code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="kc">undefined</code><code class="p">,</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">false</code> <code class="p">}</code>
</pre></div>

</div>

<p>We call <code>next()</code> two more times, in order to send the value <code>'a'</code> to the first <code>yield</code> and the value <code>'b'</code> to the second <code>yield</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="nx">genObj</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="s1">'a'</code><code class="p">)</code>
<code class="mi">1</code><code class="p">.</code> <code class="nx">a</code>
<code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="kc">undefined</code><code class="p">,</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">false</code> <code class="p">}</code>

<code class="o">&gt;</code> <code class="nx">genObj</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="s1">'b'</code><code class="p">)</code>
<code class="mi">2</code><code class="p">.</code> <code class="nx">b</code>
<code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="s1">'result'</code><code class="p">,</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}</code>
</pre></div>

</div>

<p>The result of the last <code>next()</code> is the value returned from <code>dataConsumer()</code>. <code>done</code> being <code>true</code> indicates that the generator is finished.</p>

<p>Unfortunately, <code>next()</code> is asymmetric, but that can’t be helped: It always sends a value to the currently suspended <code>yield</code>, but returns the operand of the following <code>yield</code>.</p>

<h5 id="function_coroutine">
<span class="section-number">21.4.1.1 </span>The first <code>next()</code>
</h5>

<p>When using a generator as an observer, it is important to note that the only purpose of the first invocation of <code>next()</code> is to start the observer. It is only ready for input afterwards, because this first invocation has advanced execution to the first <code>yield</code>. Therefore, you can’t send input via the first <code>next()</code> – you even get an error if you do:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">function</code><code class="o">*</code> <code class="nx">g</code><code class="p">()</code> <code class="p">{</code> <code class="k">yield</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">g</code><code class="p">().</code><code class="nx">next</code><code class="p">(</code><code class="s1">'hello'</code><code class="p">)</code>
<code class="nx">TypeError</code><code class="o">:</code> <code class="nx">attempt</code> <code class="nx">to</code> <code class="nx">send</code> <code class="s1">'hello'</code> <code class="nx">to</code> <code class="nx">newborn</code> <code class="nx">generator</code>
</pre></div>

</div>

<p>The following utility function fixes this issue:</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Returns a function that, when called,</code>
<code class="cm"> * returns a generator object that is immediately</code>
<code class="cm"> * ready for input via `next()`</code>
<code class="cm"> */</code>
<code class="kd">function</code> <code class="nx">coroutine</code><code class="p">(</code><code class="nx">generatorFunction</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="kd">function</code> <code class="p">(...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">generatorObject</code> <code class="o">=</code> <code class="nx">generatorFunction</code><code class="p">(...</code><code class="nx">args</code><code class="p">);</code>
        <code class="nx">generatorObject</code><code class="p">.</code><code class="nx">next</code><code class="p">();</code>
        <code class="k">return</code> <code class="nx">generatorObject</code><code class="p">;</code>
    <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</div>

<p>To see how <code>coroutine()</code> works, let’s compare a wrapped generator with a normal one:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">wrapped</code> <code class="o">=</code> <code class="nx">coroutine</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">First</code> <code class="nx">input</code><code class="o">:</code> <code class="nx">$</code><code class="p">{</code><code class="k">yield</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
    <code class="k">return</code> <code class="s1">'DONE'</code><code class="p">;</code>
<code class="p">});</code>
<code class="kr">const</code> <code class="nx">normal</code> <code class="o">=</code> <code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">First</code> <code class="nx">input</code><code class="o">:</code> <code class="nx">$</code><code class="p">{</code><code class="k">yield</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
    <code class="k">return</code> <code class="s1">'DONE'</code><code class="p">;</code>
<code class="p">};</code>
</pre></div>

</div>

<p>The wrapped generator is immediately ready for input:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">wrapped</code><code class="p">().</code><code class="n">next</code><code class="p">(</code><code class="err">'</code><code class="n">hello</code><code class="o">!</code><code class="err">'</code><code class="p">)</code>
<code class="n">First</code> <code class="n">input</code><code class="o">:</code> <code class="n">hello</code><code class="o">!</code>
</pre></div>

</div>

<p>The normal generator needs an extra <code>next()</code> until it is ready for input:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">genObj</code> <code class="o">=</code> <code class="n">normal</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">genObj</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">genObj</code><code class="p">.</code><code class="n">next</code><code class="p">(</code><code class="err">'</code><code class="n">hello</code><code class="o">!</code><code class="err">'</code><code class="p">)</code>
<code class="n">First</code> <code class="n">input</code><code class="o">:</code> <code class="n">hello</code><code class="o">!</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="err">'</code><code class="n">DONE</code><code class="err">'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">true</code> <code class="p">}</code>
</pre></div>

</div>


<h4 id="leanpub-auto-yield-binds-loosely">
<span class="section-number">21.4.2 </span><code>yield</code> binds loosely</h4>

<p><code>yield</code> binds very loosely, so that we don’t have to put its operand in parentheses:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">yield</code> <code class="nx">a</code> <code class="o">+</code> <code class="nx">b</code> <code class="o">+</code> <code class="nx">c</code><code class="p">;</code>
</pre></div>

</div>

<p>This is treated as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">yield</code> <code class="p">(</code><code class="nx">a</code> <code class="o">+</code> <code class="nx">b</code> <code class="o">+</code> <code class="nx">c</code><code class="p">);</code>
</pre></div>

</div>

<p>Not as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code><code class="k">yield</code> <code class="nx">a</code><code class="p">)</code> <code class="o">+</code> <code class="nx">b</code> <code class="o">+</code> <code class="nx">c</code><code class="p">;</code>
</pre></div>

</div>

<p>As a consequence, many operators bind more tightly than <code>yield</code> and you have to put <code>yield</code> in parentheses if you want to use it as an operand. For example, you get a SyntaxError if you make an unparenthesized <code>yield</code> an operand of plus:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Hello'</code> <code class="o">+</code> <code class="k">yield</code><code class="p">);</code> <code class="c1">// SyntaxError</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Hello'</code> <code class="o">+</code> <code class="k">yield</code> <code class="mi">123</code><code class="p">);</code> <code class="c1">// SyntaxError</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Hello'</code> <code class="o">+</code> <code class="p">(</code><code class="k">yield</code><code class="p">));</code> <code class="c1">// OK</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Hello'</code> <code class="o">+</code> <code class="p">(</code><code class="k">yield</code> <code class="mi">123</code><code class="p">));</code> <code class="c1">// OK</code>
</pre></div>

</div>

<p>You do not need parens if <code>yield</code> is a direct argument in a function or method call:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">foo</code><code class="p">(</code><code class="k">yield</code> <code class="s1">'a'</code><code class="p">,</code> <code class="k">yield</code> <code class="s1">'b'</code><code class="p">);</code>
</pre></div>

</div>

<p>You also don’t need parens if you use <code>yield</code> on the right-hand side of an assignment:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">input</code> <code class="o">=</code> <code class="k">yield</code><code class="p">;</code>
</pre></div>

</div>

<h5 id="leanpub-auto-yield-in-the-es6-grammar">
<span class="section-number">21.4.2.1 </span><code>yield</code> in the ES6 grammar</h5>

<p>The need for parens around <code>yield</code> can be seen in the following grammar rules in the <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-expressions">ECMAScript 6 specification</a>. These rules describe how expressions are parsed. I list them here from general (loose binding, lower precedence) to specific (tight binding, higher precedence). Wherever a certain kind of expression is demanded, you can also use more specific ones. The opposite is not true. The hierarchy ends with <code>ParenthesizedExpression</code>, which means that you can mention any expression anywhere, if you put it in parentheses.</p>

<div class="code-block">
<div class="highlight"><pre>Expression :
    AssignmentExpression
    Expression , AssignmentExpression
AssignmentExpression :
    ConditionalExpression
    YieldExpression
    ArrowFunction
    LeftHandSideExpression = AssignmentExpression
    LeftHandSideExpression AssignmentOperator AssignmentExpression

···

AdditiveExpression :
    MultiplicativeExpression
    AdditiveExpression + MultiplicativeExpression
    AdditiveExpression - MultiplicativeExpression
MultiplicativeExpression :
    UnaryExpression
    MultiplicativeExpression MultiplicativeOperator UnaryExpression

···

PrimaryExpression :
    this
    IdentifierReference
    Literal
    ArrayLiteral
    ObjectLiteral
    FunctionExpression
    ClassExpression
    GeneratorExpression
    RegularExpressionLiteral
    TemplateLiteral
    ParenthesizedExpression
ParenthesizedExpression :
    ( Expression )
</pre></div>

</div>

<p>The operands of an <code>AdditiveExpression</code> are an <code>AdditiveExpression</code> and a <code>MultiplicativeExpression</code>. Therefore, using a (more specific) <code>ParenthesizedExpression</code> as an operand is OK, but using a (more general) <code>YieldExpression</code> isn’t.</p>


<h4 id="leanpub-auto-return-and-throw">
<span class="section-number">21.4.3 </span><code>return()</code> and <code>throw()</code>
</h4>

<p>Let’s recap how <code>next(x)</code> works (after the first invocation):</p>

<ol class="numeric numeric">
<li>The generator is currently suspended at a <code>yield</code> operator.</li>
  <li>Send the value <code>x</code> to that <code>yield</code>, which means that it evaluates to <code>x</code>.</li>
  <li>Proceed to the next <code>yield</code> or <code>return</code>:
    <ul>
<li>
<code>yield x</code> leads to <code>next()</code> returning with <code>{ value: x, done: false }</code>
</li>
      <li>
<code>return x</code> leads to <code>next()</code> returning with <code>{ value: x, done: true }</code>
</li>
    </ul>
</li>
</ol>
<p><code>return()</code> and <code>throw()</code> work similarly to <code>next()</code>, but they do something different in step 2:</p>

<ul>
<li>
<code>return(x)</code> executes <code>return x</code> at the location of <code>yield</code>.</li>
  <li>
<code>throw(x)</code> executes <code>throw x</code> at the location of <code>yield</code>.</li>
</ul>
<h4 id="leanpub-auto-return-terminates-the-generator">
<span class="section-number">21.4.4 </span><code>return()</code> terminates the generator</h4>

<p><code>return()</code> performs a <code>return</code> at the location of the <code>yield</code> that led to the last suspension of the generator. Let’s use the following generator function to see how that works.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc1</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Started'</code><code class="p">);</code>
        <code class="k">yield</code><code class="p">;</code> <code class="c1">// (A)</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Exiting'</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In the following interaction, we first use <code>next()</code> to start the generator and to proceed until the <code>yield</code> in line A. Then we return from that location via <code>return()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">genObj1</code> <code class="o">=</code> <code class="n">genFunc1</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">genObj1</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="n">Started</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">genObj1</code><code class="p">.</code><code class="k">return</code><code class="p">(</code><code class="err">'</code><code class="n">Result</code><code class="err">'</code><code class="p">)</code>
<code class="n">Exiting</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="err">'</code><code class="n">Result</code><code class="err">'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">true</code> <code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-preventing-termination">
<span class="section-number">21.4.4.1 </span>Preventing termination</h5>

<p>You can prevent <code>return()</code> from terminating the generator if you yield inside the <code>finally</code> clause (using a <code>return</code> statement in that clause is also possible):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc2</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Started'</code><code class="p">);</code>
        <code class="k">yield</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="s1">'Not done, yet!'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This time, <code>return()</code> does not exit the generator function. Accordingly, the property <code>done</code> of the object it returns is <code>false</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">genObj2</code> <code class="o">=</code> <code class="n">genFunc2</code><code class="p">();</code>

<code class="o">&gt;</code> <code class="n">genObj2</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="n">Started</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>

<code class="o">&gt;</code> <code class="n">genObj2</code><code class="p">.</code><code class="k">return</code><code class="p">(</code><code class="err">'</code><code class="n">Result</code><code class="err">'</code><code class="p">)</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="err">'</code><code class="n">Not</code> <code class="n">done</code><code class="p">,</code> <code class="n">yet</code><code class="o">!</code><code class="err">'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
</pre></div>

</div>

<p>You can invoke <code>next()</code> one more time. Similarly to non-generator functions, the return value of the generator function is the value that was queued prior to entering the <code>finally</code> clause.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">genObj2</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="err">'</code><code class="n">Result</code><code class="err">'</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">true</code> <code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-returning-from-a-newborn-generator">
<span class="section-number">21.4.4.2 </span>Returning from a newborn generator</h5>

<p>Returning a value from a <em>newborn</em> generator (that hasn’t started yet) is allowed:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc</code><code class="p">()</code> <code class="p">{}</code>
<code class="o">&gt;</code> <code class="nx">genFunc</code><code class="p">().</code><code class="k">return</code><code class="p">(</code><code class="s1">'yes'</code><code class="p">)</code>
<code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="s1">'yes'</code><code class="p">,</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}</code>
</pre></div>

</div>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_eye.png" alt="generic_inbar" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-further-reading-3">Further reading</h3>

  <p>The chapter on iteration has <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_closing-iterators">a detailed section on closing iterators and generators</a>.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-throw-signals-an-error">
<span class="section-number">21.4.5 </span><code>throw()</code> signals an error</h4>

<p><code>throw()</code> throws an exception at the location of the <code>yield</code> that led to the last suspension of the generator. Let’s examine how that works via the following generator function.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc1</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Started'</code><code class="p">);</code>
        <code class="k">yield</code><code class="p">;</code> <code class="c1">// (A)</code>
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Caught: '</code> <code class="o">+</code> <code class="nx">error</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In the following interaction, we first use <code>next()</code> to start the generator and proceed until the <code>yield</code> in line A. Then we throw an exception from that location.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">let</code> <code class="nx">genObj1</code> <code class="o">=</code> <code class="nx">genFunc1</code><code class="p">();</code>

<code class="o">&gt;</code> <code class="nx">genObj1</code><code class="p">.</code><code class="nx">next</code><code class="p">()</code>
<code class="nx">Started</code>
<code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="kc">undefined</code><code class="p">,</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">false</code> <code class="p">}</code>

<code class="o">&gt;</code> <code class="nx">genObj1</code><code class="p">.</code><code class="k">throw</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Problem!'</code><code class="p">))</code>
<code class="nx">Caught</code><code class="o">:</code> <code class="nb">Error</code><code class="o">:</code> <code class="nx">Problem</code><code class="o">!</code>
<code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="kc">undefined</code><code class="p">,</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}</code>
</pre></div>

</div>

<p>The result of <code>throw()</code> (shown in the last line) stems from us leaving the function with an implicit <code>return</code>.</p>

<h5 id="leanpub-auto-uncaught-exceptions">
<span class="section-number">21.4.5.1 </span>Uncaught exceptions</h5>

<p>If you don’t catch the exception inside the generator, it is thrown by <code>throw()</code>. For example, the following generator function does not catch exceptions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc2</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Started'</code><code class="p">);</code>
    <code class="k">yield</code><code class="p">;</code> <code class="c1">// (A)</code>
<code class="p">}</code>
</pre></div>

</div>

<p>If we use <code>throw()</code> to throw an instance of <code>Error</code> at line A, the method itself throws that error:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">genObj2</code> <code class="o">=</code> <code class="n">genFunc2</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="n">genObj2</code><code class="p">.</code><code class="n">next</code><code class="p">()</code>
<code class="n">Started</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="n">genObj2</code><code class="p">.</code><code class="n">throw</code><code class="p">(</code><code class="n">new</code> <code class="n">Error</code><code class="p">(</code><code class="err">'</code><code class="n">Problem</code><code class="o">!</code><code class="err">'</code><code class="p">))</code>
<code class="nl">Error:</code> <code class="n">Problem</code><code class="o">!</code>
</pre></div>

</div>

<h5 id="leanpub-auto-throwing-from-a-newborn-generator">
<span class="section-number">21.4.5.2 </span>Throwing from a newborn generator</h5>

<p>Throwing an exception in a <em>newborn</em> generator (that hasn’t started yet) is allowed:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc</code><code class="p">()</code> <code class="p">{}</code>
<code class="o">&gt;</code> <code class="nx">genFunc</code><code class="p">().</code><code class="k">throw</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Problem!'</code><code class="p">))</code>
<code class="nb">Error</code><code class="o">:</code> <code class="nx">Problem</code><code class="o">!</code>
</pre></div>

</div>


<h4 id="leanpub-auto-example-processing-asynchronously-pushed-data">
<span class="section-number">21.4.6 </span>Example: processing asynchronously pushed data</h4>

<p>The fact that generators-as-observers pause while they wait for input makes them perfect for on-demand processing of data that is received asynchronously. The pattern for setting up a chain of generators for processing is as follows:</p>

<ul>
<li>Each member of the chain of generators (except the last one) has a parameter <code>target</code>. It receives data via <code>yield</code> and sends data via <code>target.next()</code>.</li>
  <li>The last member of the chain of generators has no parameter <code>target</code> and only receives data.</li>
</ul>
<p>The whole chain is prefixed by a non-generator function that makes an asynchronous request and pushes the results into the chain of generators via <code>next()</code>.</p>

<p>As an example, let’s chain generators to process a file that is read asynchronously.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>The code of this example is in the file <a href="https://github.com/rauschma/generator-examples/blob/gh-pages/node/readlines.js"><code>generator-examples/node/readlines.js</code></a>. It must be executed via <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_babel-node"><code>babel-node</code></a>.</p>

    </td>
  </tr></tbody></table>
<p>The following code sets up the chain: it contains the generators <code>splitLines</code>, <code>numberLines</code> and <code>printLines</code>. Data is pushed into the chain via the non-generator function <code>readFile</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">readFile</code><code class="p">(</code><code class="nx">fileName</code><code class="p">,</code> <code class="nx">splitLines</code><code class="p">(</code><code class="nx">numberLines</code><code class="p">(</code><code class="nx">printLines</code><code class="p">())));</code>
</pre></div>

</div>

<p>I’ll explain what these functions do when I show their code.</p>

<p>As previously explained, if generators receive input via <code>yield</code>, the first invocation of <code>next()</code> on the generator object doesn’t do anything. That’s why I use <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#function_coroutine">the previously shown helper function <code>coroutine()</code></a> to create coroutines here. It executes the first <code>next()</code> for us.</p>

<p><code>readFile()</code> is the non-generator function that starts everything:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="p">{</code><code class="nx">createReadStream</code><code class="p">}</code> <code class="nx">from</code> <code class="s1">'fs'</code><code class="p">;</code>

<code class="cm">/**</code>
<code class="cm"> * Create an asynchronous ReadStream for the file whose name</code>
<code class="cm"> * is `fileName` and feed it to the generator object `target`.</code>
<code class="cm"> *</code>
<code class="cm"> * @see ReadStream https://nodejs.org/api/fs.html#fs_class_fs_readstream</code>
<code class="cm"> */</code>
<code class="kd">function</code> <code class="nx">readFile</code><code class="p">(</code><code class="nx">fileName</code><code class="p">,</code> <code class="nx">target</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">readStream</code> <code class="o">=</code> <code class="nx">createReadStream</code><code class="p">(</code><code class="nx">fileName</code><code class="p">,</code>
        <code class="p">{</code> <code class="nx">encoding</code><code class="o">:</code> <code class="s1">'utf8'</code><code class="p">,</code> <code class="nx">bufferSize</code><code class="o">:</code> <code class="mi">1024</code> <code class="p">});</code>
    <code class="nx">readStream</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">buffer</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">str</code> <code class="o">=</code> <code class="nx">buffer</code><code class="p">.</code><code class="nx">toString</code><code class="p">(</code><code class="s1">'utf8'</code><code class="p">);</code>
        <code class="nx">target</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nx">str</code><code class="p">);</code>
    <code class="p">});</code>
    <code class="nx">readStream</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'end'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="c1">// Signal end of output sequence</code>
        <code class="nx">target</code><code class="p">.</code><code class="k">return</code><code class="p">();</code>
    <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The chain of generators starts with <code>splitLines</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Turns a sequence of text chunks into a sequence of lines</code>
<code class="cm"> * (where lines are separated by newlines)</code>
<code class="cm"> */</code>
<code class="kr">const</code> <code class="nx">splitLines</code> <code class="o">=</code> <code class="nx">coroutine</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">(</code><code class="nx">target</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">previous</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">previous</code> <code class="o">+=</code> <code class="k">yield</code><code class="p">;</code>
            <code class="kd">let</code> <code class="nx">eolIndex</code><code class="p">;</code>
            <code class="k">while</code> <code class="p">((</code><code class="nx">eolIndex</code> <code class="o">=</code> <code class="nx">previous</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="s1">'\n'</code><code class="p">))</code> <code class="o">&gt;=</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
                <code class="kd">let</code> <code class="nx">line</code> <code class="o">=</code> <code class="nx">previous</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nx">eolIndex</code><code class="p">);</code>
                <code class="nx">target</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nx">line</code><code class="p">);</code>
                <code class="nx">previous</code> <code class="o">=</code> <code class="nx">previous</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="nx">eolIndex</code><code class="o">+</code><code class="mi">1</code><code class="p">);</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="c1">// Handle the end of the input sequence</code>
        <code class="c1">// (signaled via `return()`)</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">previous</code><code class="p">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">target</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nx">previous</code><code class="p">);</code>
        <code class="p">}</code>
        <code class="c1">// Signal end of output sequence</code>
        <code class="nx">target</code><code class="p">.</code><code class="k">return</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>Note an important pattern:</p>

<ul>
<li>
<code>readFile</code> uses the generator object method <code>return()</code> to signal the end of the sequence of chunks that it sends.</li>
  <li>
<code>readFile</code> sends that signal while <code>splitLines</code> is waiting for input via <code>yield</code>, inside an infinite loop. <code>return()</code> breaks from that loop.</li>
  <li>
<code>splitLines</code> uses a <code>finally</code> clause to handle the end-of-sequence.</li>
</ul>
<p>The next generator is <code>numberLines</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">//**</code>
 <code class="o">*</code> <code class="nx">Prefixes</code> <code class="nx">numbers</code> <code class="nx">to</code> <code class="nx">a</code> <code class="nx">sequence</code> <code class="nx">of</code> <code class="nx">lines</code>
 <code class="o">*</code><code class="err">/</code>
<code class="kr">const</code> <code class="nx">numberLines</code> <code class="o">=</code> <code class="nx">coroutine</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">(</code><code class="nx">target</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">lineNo</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="p">;</code> <code class="nx">lineNo</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">line</code> <code class="o">=</code> <code class="k">yield</code><code class="p">;</code>
            <code class="nx">target</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="err">`</code><code class="nx">$</code><code class="p">{</code><code class="nx">lineNo</code><code class="p">}</code><code class="o">:</code> <code class="nx">$</code><code class="p">{</code><code class="nx">line</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="c1">// Signal end of output sequence</code>
        <code class="nx">target</code><code class="p">.</code><code class="k">return</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>The last generator is <code>printLines</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Receives a sequence of lines (without newlines)</code>
<code class="cm"> * and logs them (adding newlines).</code>
<code class="cm"> */</code>
<code class="kr">const</code> <code class="nx">printLines</code> <code class="o">=</code> <code class="nx">coroutine</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code>
    <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">line</code> <code class="o">=</code> <code class="k">yield</code><code class="p">;</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">line</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>The neat thing about this code is that everything happens lazily (on demand): lines are split, numbered and printed as they arrive; we don’t have to wait for all of the text before we can start printing.</p>


<h4 id="leanpub-auto-yield-the-full-story">
<span class="section-number">21.4.7 </span><code>yield*</code>: the full story</h4>

<p>As a rough rule of thumb, <code>yield*</code> performs (the equivalent of) a function call from one generator (the <em>caller</em>) to another generator (the <em>callee</em>).</p>

<p>So far, we have only seen one aspect of <code>yield</code>: it propagates yielded values from the callee to the caller. Now that we are interested in generators receiving input, another aspect becomes relevant: <code>yield*</code> also forwards input received by the caller to the callee.</p>

<p>I’ll first explain the complete semantics of <code>yield*</code> by showing how you’d implemented it in JavaScript. Then I give simple examples where input received by the caller via <code>next()</code>, <code>return()</code> and <code>throw()</code> is forwarded to the callee.</p>

<p>The following statement:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">yieldStarResult</code> <code class="o">=</code> <code class="k">yield</code><code class="o">*</code> <code class="nx">calleeFunc</code><code class="p">();</code>
</pre></div>

</div>

<p>is roughly equivalent to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">yieldStarResult</code><code class="p">;</code>

<code class="kd">let</code> <code class="nx">calleeObj</code> <code class="o">=</code> <code class="nx">calleeFunc</code><code class="p">();</code>
<code class="kd">let</code> <code class="nx">prevReceived</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">;</code>
<code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="c1">// Forward input previously received</code>
        <code class="kd">let</code> <code class="p">{</code><code class="nx">value</code><code class="p">,</code><code class="nx">done</code><code class="p">}</code> <code class="o">=</code> <code class="nx">calleeObj</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nx">prevReceived</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">yieldStarResult</code> <code class="o">=</code> <code class="nx">value</code><code class="p">;</code>
            <code class="k">break</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="nx">prevReceived</code> <code class="o">=</code> <code class="k">yield</code> <code class="nx">value</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// Pretend `return` can be caught like an exception</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">e</code> <code class="k">instanceof</code> <code class="nx">Return</code><code class="p">)</code> <code class="p">{</code>
            <code class="c1">// Forward input received via return()</code>
            <code class="nx">calleeObj</code><code class="p">.</code><code class="k">return</code><code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">returnedValue</code><code class="p">);</code>
            <code class="k">return</code> <code class="nx">e</code><code class="p">.</code><code class="nx">returnedValue</code><code class="p">;</code> <code class="c1">// “re-throw”</code>
        <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
            <code class="c1">// Forward input received via throw()</code>
            <code class="nx">calleeObj</code><code class="p">.</code><code class="k">throw</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code> <code class="c1">// may throw</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>To keep things simple, several things are missing in this code:</p>

<ul>
<li>The operand of <code>yield*</code> can be any iterable value.</li>
  <li>
<code>return()</code> and <code>throw()</code> are optional iterator methods. We should only call them if they exist.</li>
  <li>If an exception is received and <code>throw()</code> does not exist, but <code>return()</code> does then <code>return()</code> is called (before throwing an exception) to give <code>calleeObject</code> the opportunity to clean up.</li>
  <li>
<code>calleeObj</code> can refuse to close, by returning an object whose property <code>done</code> is <code>false</code>. Then the caller also has to refuse to close and <code>yield*</code> must continue to iterate.</li>
</ul>
<h5 id="leanpub-auto-example-yield-forwards-next">
<span class="section-number">21.4.7.1 </span>Example: <code>yield*</code> forwards <code>next()</code>
</h5>

<p>The following generator function <code>caller()</code> invokes the generator function <code>callee()</code> via <code>yield*</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">callee</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'callee: '</code> <code class="o">+</code> <code class="p">(</code><code class="k">yield</code><code class="p">));</code>
<code class="p">}</code>
<code class="kd">function</code><code class="o">*</code> <code class="nx">caller</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">yield</code><code class="o">*</code> <code class="nx">callee</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>callee</code> logs values received via <code>next()</code>, which allows us to check whether it receives the value <code>'a'</code> and <code>'b'</code> that we send to <code>caller</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">callerObj</code> <code class="o">=</code> <code class="n">caller</code><code class="p">();</code>

<code class="o">&gt;</code> <code class="n">callerObj</code><code class="p">.</code><code class="n">next</code><code class="p">()</code> <code class="c1">// start</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>

<code class="o">&gt;</code> <code class="n">callerObj</code><code class="p">.</code><code class="n">next</code><code class="p">(</code><code class="sc">'a'</code><code class="p">)</code>
<code class="nl">callee:</code> <code class="n">a</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>

<code class="o">&gt;</code> <code class="n">callerObj</code><code class="p">.</code><code class="n">next</code><code class="p">(</code><code class="sc">'b'</code><code class="p">)</code>
<code class="nl">callee:</code> <code class="n">b</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">false</code> <code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-example-yield-forwards-throw">
<span class="section-number">21.4.7.2 </span>Example: <code>yield*</code> forwards <code>throw()</code>
</h5>

<p>Let’s use the following code to demonstrate how <code>throw()</code> works while <code>yield*</code> is delegating to another generator.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">callee</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code> <code class="c1">// (A)</code>
        <code class="k">yield</code> <code class="s1">'c'</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'finally callee'</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="kd">function</code><code class="o">*</code> <code class="nx">caller</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
        <code class="k">yield</code><code class="o">*</code> <code class="nx">callee</code><code class="p">();</code>
        <code class="k">yield</code> <code class="s1">'d'</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'[caller] '</code> <code class="o">+</code> <code class="nx">e</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>We first create a generator object and advance until line A.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">genObj</code> <code class="o">=</code> <code class="n">caller</code><code class="p">();</code>

<code class="o">&gt;</code> <code class="n">genObj</code><code class="p">.</code><code class="n">next</code><code class="p">().</code><code class="n">value</code>
<code class="sc">'a'</code>
<code class="o">&gt;</code> <code class="n">genObj</code><code class="p">.</code><code class="n">next</code><code class="p">().</code><code class="n">value</code>
<code class="sc">'b'</code>
</pre></div>

</div>

<p>In that line, we throw an exception:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">genObj</code><code class="p">.</code><code class="n">throw</code><code class="p">(</code><code class="n">new</code> <code class="n">Error</code><code class="p">(</code><code class="err">'</code><code class="n">Problem</code><code class="o">!</code><code class="err">'</code><code class="p">))</code>
<code class="n">finally</code> <code class="n">callee</code>
<code class="p">[</code><code class="n">caller</code><code class="p">]</code> <code class="n">Error</code><code class="o">:</code> <code class="n">Problem</code><code class="o">!</code>
<code class="p">{</code> <code class="n">value</code><code class="o">:</code> <code class="n">undefined</code><code class="p">,</code> <code class="n">done</code><code class="o">:</code> <code class="nb">true</code> <code class="p">}</code>
</pre></div>

</div>

<p><code>callee</code> doesn’t catch the exception, which is why it is propagated into <code>caller</code>, where it is logged before <code>caller</code> finishes.</p>

<h5 id="leanpub-auto-example-yield-forwards-return">
<span class="section-number">21.4.7.3 </span>Example: <code>yield*</code> forwards <code>return()</code>
</h5>

<p>Let’s use the following code to demonstrate how <code>return()</code> works while <code>yield*</code> is delegating to another generator.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">callee</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="s1">'b'</code><code class="p">;</code>
        <code class="k">yield</code> <code class="s1">'c'</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'finally callee'</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="kd">function</code><code class="o">*</code> <code class="nx">caller</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="s1">'a'</code><code class="p">;</code>
        <code class="k">yield</code><code class="o">*</code> <code class="nx">callee</code><code class="p">();</code>
        <code class="k">yield</code> <code class="s1">'d'</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'finally caller'</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Destructuring closes an iterator via <code>return()</code> if one doesn’t iterate until the end:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">[</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">]</code> <code class="o">=</code> <code class="nx">caller</code><code class="p">();</code> <code class="c1">// ['a', 'b']</code>

<code class="c1">// Output:</code>
<code class="c1">// finally callee</code>
<code class="c1">// finally caller</code>
</pre></div>

</div>

<p>Interestingly, the <code>return()</code> is sent to <code>caller</code> and forwarded to <code>callee</code> (which it terminates early), but then also terminates <code>caller</code> (which is what someone invoking <code>return()</code> would expect). That is, <code>return</code> is propagated much like an exception.</p>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <h3 id="leanpub-auto-tip-for-understanding-return">Tip for understanding <code>return()</code>
</h3>

  <p>In order to understand <code>return()</code>, it helps to ask yourself: what should happen if I copy-pasted the code of the callee function into the code of the caller function.</p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-generators-as-coroutines-cooperative-multitasking">
<span class="section-number">21.5 </span>Generators as coroutines (cooperative multitasking)</h3>

<p>We have seen generators being used as either sources or sinks of data. For many applications, it’s good practice to strictly separate these two roles, because it keeps things simpler. This section describes the full generator interface (which combines both roles) and one use case where both roles are needed: cooperative multitasking, where tasks must be able to both send and receive information.</p>


<h4 id="leanpub-auto-the-full-generator-interface">
<span class="section-number">21.5.1 </span>The full generator interface</h4>

<p>The full interface of generator objects, <code>Generator</code>, handles both output and input:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">interface</code> <code class="nx">Generator</code> <code class="p">{</code>
    <code class="nx">next</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
    <code class="k">throw</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
    <code class="k">return</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
<code class="p">}</code>
<code class="kr">interface</code> <code class="nx">IteratorResult</code> <code class="p">{</code>
    <code class="nx">value</code> <code class="o">:</code> <code class="nx">any</code><code class="p">;</code>
    <code class="nx">done</code> <code class="o">:</code> <code class="kr">boolean</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>
<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>This interface is described in the spec in the section “<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-properties-of-generator-prototype">Properties of Generator Prototype</a>”.</p>

    </td>
  </tr></tbody></table>
<p>The interface <code>Generator</code> combines two interfaces that we have seen previously: <code>Iterator</code> for output and <code>Observer</code> for input.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">interface</code> <code class="nx">Iterator</code> <code class="p">{</code> <code class="c1">// data producer</code>
    <code class="nx">next</code><code class="p">()</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
    <code class="k">return</code><code class="o">?</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="nx">IteratorResult</code><code class="p">;</code>
<code class="p">}</code>

<code class="kr">interface</code> <code class="nx">Observer</code> <code class="p">{</code> <code class="c1">// data consumer</code>
    <code class="nx">next</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="k">void</code><code class="p">;</code>
    <code class="k">return</code><code class="p">(</code><code class="nx">value</code><code class="o">?</code> <code class="o">:</code> <code class="nx">any</code><code class="p">)</code> <code class="o">:</code> <code class="k">void</code><code class="p">;</code>
    <code class="k">throw</code><code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="o">:</code> <code class="k">void</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>


<h4 id="leanpub-auto-cooperative-multitasking">
<span class="section-number">21.5.2 </span>Cooperative multitasking</h4>

<p>Cooperative multitasking is an application of generators where we need them to handle both output and input. Before we get into how that works, let’s first review the current state of parallelism in JavaScript.</p>

<p>JavaScript runs in a single process. There are two ways in which this limitation is being abolished:</p>

<ul>
<li>Multiprocessing: <em>Web Workers</em> let you run JavaScript in multiple processes. Shared access to data is one of the biggest pitfalls of multiprocessing. Web Workers avoid it by not sharing any data. That is, if you want a Web Worker to have a piece of data, you must send it a copy or transfer your data to it (after which you can’t access it anymore).</li>
  <li>Cooperative multitasking: There are various patterns and libraries that experiment with cooperative multitasking. Multiple tasks are run, but only one at a time. Each task must explicitly suspend itself, giving it full control over when a task switch happens. In these experiments, data is often shared between tasks. But due to explicit suspension, there are few risks.</li>
</ul>
<p>Two use cases benefit from cooperative multitasking, because they involve control flows that are mostly sequential, anyway, with occasional pauses:</p>

<ul>
<li>
<strong>Streams:</strong> A task sequentially processes a stream of data and pauses if there is no data available.
    <ul>
<li>For binary streams, WHATWG is currently working on a <a href="https://streams.spec.whatwg.org/">standard proposal</a> that is based on callbacks and Promises.</li>
      <li>For streams of data, Communicating Sequential Processes (CSP) are an interesting solution. A generator-based CSP library is covered <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_csp">later in this chapter</a>.</li>
    </ul>
</li>
  <li>
<strong>Asynchronous computations:</strong> A task blocks (pauses) until it receives the result of a long- running computation.
    <ul>
<li>In JavaScript, <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_promises">Promises</a> have become a popular way of handling asynchronous computations. Support for them is included in ES6. The next section explains how generators can make using Promises simpler.</li>
    </ul>
</li>
</ul>
<h5 id="sec_co-library">
<span class="section-number">21.5.2.1 </span>Simplifying asynchronous computations via generators</h5>

<p>Several Promise-based libraries simplify asynchronous code via generators. Generators are ideal as clients of Promises, because they can be suspended until a result arrives.</p>

<p>The following example demonstrates what that looks like if one uses <a href="https://github.com/tj/co">the library <em>co</em></a> by T.J. Holowaychuk. We need two libraries (if we run Node.js code via <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_babel-node"><code>babel-node</code></a>):</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">require</code><code class="p">(</code><code class="s1">'isomorphic-fetch'</code><code class="p">);</code> <code class="c1">// polyfill</code>
<code class="kd">let</code> <code class="nx">co</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'co'</code><code class="p">);</code>
</pre></div>

</div>

<p><code>co</code> is the actual library for cooperative multitasking, <code>isomorphic-fetch</code> is a polyfill for the new Promise-based <code>fetch</code> API (a replacement of <code>XMLHttpRequest</code>; read “<a href="http://jakearchibald.com/2015/thats-so-fetch/">That’s so fetch!</a>” by Jake Archibald for more information). <code>fetch</code> makes it easy to write a function <code>getFile</code> that returns the text of a file at a <code>url</code> via a Promise:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">getFile</code><code class="p">(</code><code class="nx">url</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">fetch</code><code class="p">(</code><code class="nx">url</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">request</code> <code class="o">=&gt;</code> <code class="nx">request</code><code class="p">.</code><code class="nx">text</code><code class="p">());</code>
<code class="p">}</code>
</pre></div>

</div>

<p>We now have all the ingredients to use <code>co</code>. The following task reads the texts of two files, parses the JSON inside them and logs the result.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">co</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="p">[</code><code class="nx">croftStr</code><code class="p">,</code> <code class="nx">bondStr</code><code class="p">]</code> <code class="o">=</code> <code class="k">yield</code> <code class="nx">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">([</code>  <code class="c1">// (A)</code>
            <code class="nx">getFile</code><code class="p">(</code><code class="s1">'http://localhost:8000/croft.json'</code><code class="p">),</code>
            <code class="nx">getFile</code><code class="p">(</code><code class="s1">'http://localhost:8000/bond.json'</code><code class="p">),</code>
        <code class="p">]);</code>
        <code class="kd">let</code> <code class="nx">croftJson</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">croftStr</code><code class="p">);</code>
        <code class="kd">let</code> <code class="nx">bondJson</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">bondStr</code><code class="p">);</code>

        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">croftJson</code><code class="p">);</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">bondJson</code><code class="p">);</code>
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Failure to read: '</code> <code class="o">+</code> <code class="nx">e</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>Note how nicely synchronous this code looks, even though it makes an asynchronous call in line A. A generator-as-task makes an async call by yielding a Promise to the scheduler function <code>co</code>. The yielding pauses the generator. Once the Promise returns a result, the scheduler resumes the generator by passing it the result via <code>next()</code>. A simple version of <code>co</code> looks as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">co</code><code class="p">(</code><code class="nx">genFunc</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">genObj</code> <code class="o">=</code> <code class="nx">genFunc</code><code class="p">();</code>
    <code class="nx">run</code><code class="p">();</code>

    <code class="kd">function</code> <code class="nx">run</code><code class="p">(</code><code class="nx">promiseResult</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="p">{</code><code class="nx">value</code><code class="p">,</code><code class="nx">done</code><code class="p">}</code> <code class="o">=</code> <code class="nx">genObj</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nx">promiseResult</code><code class="p">);</code>
        <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
            <code class="c1">// A Promise was yielded</code>
            <code class="nx">value</code>
            <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">result</code> <code class="o">=&gt;</code> <code class="nx">run</code><code class="p">(</code><code class="nx">result</code><code class="p">))</code>
            <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">error</code> <code class="o">=&gt;</code> <code class="p">{</code>
                <code class="nx">genObj</code><code class="p">.</code><code class="k">throw</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
            <code class="p">});</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>


<h4 id="leanpub-auto-the-limitations-of-cooperative-multitasking-via-generators">
<span class="section-number">21.5.3 </span>The limitations of cooperative multitasking via generators</h4>

<p><em>Coroutines</em> are cooperatively multitasked tasks that have no limitations: Inside a coroutine, any function can suspend the whole coroutine (the function activation itself, the activation of the function’s caller, the caller’s caller, etc.).</p>

<p>In contrast, you can only suspend a generator from directly within a generator and only the current function activation is suspended. Due to these limitations, generators are occasionally called <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_generators_ref_3"><em>shallow coroutines</em> [3]</a>.</p>

<h5 id="leanpub-auto-the-benefits-of-the-limitations-of-generators">
<span class="section-number">21.5.3.1 </span>The benefits of the limitations of generators</h5>

<p>The limitations of generators have two main benefits:</p>

<ul>
<li>Generators are compatible with <em>event loops</em>, which provide simple cooperative multitasking in browsers. I’ll explain the details momentarily.</li>
  <li>Generators are relatively easy to implement, because only a single function activation needs to be suspended and because browsers can continue to use event loops.</li>
</ul>
<p>JavaScript already has a very simple style of cooperative multitasking: the event loop, which schedules the execution of tasks in a queue. Each task is started by calling a function and finished once that function is finished. Events, <code>setTimeout()</code> and other mechanisms add tasks to the queue.</p>

<table class="information sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_info-circle.png" alt="information" width="50">
</td>
    <td>
      <p>This explanation of the event loop is a simplification that is good enough for now. If you are interested in details, consult <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_async">the chapter on asynchronous programming</a>.</p>

    </td>
  </tr></tbody></table>
<p>This style of multitasking makes one important guarantee: <em>run to completion</em>; every function can rely on not being interrupted by another task until it is finished. Functions become transactions and can perform complete algorithms without anyone seeing the data they operate on in an itermediate state. Concurrent access to shared data makes multitasking complicated and is not allowed by JavaScript’s concurrency model. That’s why run to completion is a good thing.</p>

<p>Alas, coroutines prevent run to completion, because any function could suspend its caller. For example, the following algorithm consists of multiple steps:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">step1</code><code class="p">(</code><code class="nx">sharedData</code><code class="p">);</code>
<code class="nx">step2</code><code class="p">(</code><code class="nx">sharedData</code><code class="p">);</code>
<code class="nx">lastStep</code><code class="p">(</code><code class="nx">sharedData</code><code class="p">);</code>
</pre></div>

</div>

<p>If <code>step2</code> was to suspend the algorithm, other tasks could run before the last step of the algorithm is performed. Those tasks could contain other parts of the application which would see <code>sharedData</code> in an unfinished state. Generators preserve run to completion, they only suspend themselves and return to their caller.</p>

<p><code>co</code> and similar libraries give you most of the power of coroutines, without their disadvantages:</p>

<ul>
<li>They provide schedulers for tasks defined via generators.</li>
  <li>Tasks “are” generators and can thus be fully suspended.</li>
  <li>A recursive (generator) function call is only suspendable if it is done via <code>yield*</code>. That gives callers control over suspension.</li>
</ul>
<h3 id="leanpub-auto-examples-of-generators">
<span class="section-number">21.6 </span>Examples of generators</h3>

<p>This section gives several examples of what generators can be used for.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>The following GitHub repository contains the example code: <a href="https://github.com/rauschma/generator-examples"><code>generator-examples</code></a></p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-implementing-iterables-via-generators-1">
<span class="section-number">21.6.1 </span>Implementing iterables via generators</h4>

<p>In <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_iteration">the chapter on iteration</a>, I implemented several iterables “by hand”. In this section, I use generators, instead.</p>

<h5 id="leanpub-auto-the-iterable-combinator-take">
<span class="section-number">21.6.1.1 </span>The iterable combinator <code>take()</code>
</h5>

<p><code>take()</code> converts a (potentially infinite) sequence of iterated values into a sequence of length <code>n</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">take</code><code class="p">(</code><code class="nx">n</code><code class="p">,</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">n</code> <code class="o">&lt;=</code> <code class="mi">0</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>
        <code class="nx">n</code><code class="o">--</code><code class="p">;</code>
        <code class="k">yield</code> <code class="nx">x</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The following is an example of using it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">,</code> <code class="s1">'d'</code><code class="p">];</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">take</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="nx">arr</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output:</code>
<code class="c1">// a</code>
<code class="c1">// b</code>
</pre></div>

</div>

<p>An implementation of <code>take()</code> without generators is more complicated:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">take</code><code class="p">(</code><code class="nx">n</code><code class="p">,</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">iter</code> <code class="o">=</code> <code class="nx">iterable</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]();</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">n</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">n</code><code class="o">--</code><code class="p">;</code>
                <code class="k">return</code> <code class="nx">iter</code><code class="p">.</code><code class="nx">next</code><code class="p">();</code>
            <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="nx">maybeCloseIterator</code><code class="p">(</code><code class="nx">iter</code><code class="p">);</code>
                <code class="k">return</code> <code class="p">{</code> <code class="nx">done</code><code class="o">:</code> <code class="kc">true</code> <code class="p">};</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="k">return</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">n</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
            <code class="nx">maybeCloseIterator</code><code class="p">(</code><code class="nx">iter</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">};</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">maybeCloseIterator</code><code class="p">(</code><code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">iterator</code><code class="p">.</code><code class="k">return</code> <code class="o">===</code> <code class="s1">'function'</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">iterator</code><code class="p">.</code><code class="k">return</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Note that <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_zip">the iterable combinator <code>zip()</code></a> does not profit much from being implemented via a generator, because multiple iterables are involved and <code>for-of</code> can’t be used.</p>

<h5 id="leanpub-auto-infinite-iterables-1">
<span class="section-number">21.6.1.2 </span>Infinite iterables</h5>

<p><code>naturalNumbers()</code> returns an iterable over all natural numbers:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">naturalNumbers</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">n</code><code class="o">=</code><code class="mi">0</code><code class="p">;;</code> <code class="nx">n</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="nx">n</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This function is often used in conjunction with a combinator:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">take</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="nx">naturalNumbers</code><code class="p">()))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// Output</code>
<code class="c1">// 0</code>
<code class="c1">// 1</code>
<code class="c1">// 2</code>
</pre></div>

</div>

<p>Here is the non-generator implementation, so you can compare:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">naturalNumbers</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">n</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">next</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="p">{</code> <code class="nx">value</code><code class="o">:</code> <code class="nx">n</code><code class="o">++</code> <code class="p">};</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-array-inspired-iterable-combinators-map-filter">
<span class="section-number">21.6.1.3 </span>Array-inspired iterable combinators: <code>map</code>, <code>filter</code>
</h5>

<p>Arrays can be transformed via the methods <code>map</code> and <code>filter</code>. Those methods can be generalized to have iterables as input and iterables as output.</p>

<h6 id="leanpub-auto-a-generalized-map">
<span class="section-number">21.6.1.3.1 </span>A generalized <code>map()</code>
</h6>

<p>This is the generalized version of <code>map</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">map</code><code class="p">(</code><code class="nx">iterable</code><code class="p">,</code> <code class="nx">mapFunc</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="nx">mapFunc</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>map()</code> works with infinite iterables:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[...</code><code class="n">take</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="n">map</code><code class="p">(</code><code class="n">naturalNumbers</code><code class="p">(),</code> <code class="n">x</code> <code class="o">=&gt;</code> <code class="n">x</code> <code class="o">*</code> <code class="n">x</code><code class="p">))]</code>
<code class="p">[</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">9</code> <code class="p">]</code>
</pre></div>

</div>

<h6 id="leanpub-auto-a-generalized-filter">
<span class="section-number">21.6.1.3.2 </span>A generalized <code>filter()</code>
</h6>

<p>This is the generalized version of <code>filter</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">filter</code><code class="p">(</code><code class="nx">iterable</code><code class="p">,</code> <code class="nx">filterFunc</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">filterFunc</code><code class="p">(</code><code class="nx">x</code><code class="p">))</code> <code class="p">{</code>
            <code class="k">yield</code> <code class="nx">x</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>filter()</code> works with infinite iterables:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[...</code><code class="n">take</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="n">filter</code><code class="p">(</code><code class="n">naturalNumbers</code><code class="p">(),</code> <code class="n">x</code> <code class="o">=&gt;</code> <code class="p">(</code><code class="n">x</code> <code class="o">%</code> <code class="mi">2</code><code class="p">)</code> <code class="o">===</code> <code class="mi">0</code><code class="p">))]</code>
<code class="p">[</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">6</code> <code class="p">]</code>
</pre></div>

</div>


<h4 id="leanpub-auto-generators-for-lazy-evaluation">
<span class="section-number">21.6.2 </span>Generators for lazy evaluation</h4>

<p>The next two examples show how generators can be used to process a stream of characters.</p>

<ul>
<li>The input is a stream of characters.</li>
  <li>Step 1 – tokenizing (characters → words): The characters are grouped into <em>words</em>, strings that match the regular expression <code>/^[A-Za-z0-9]$/</code>. Non-word characters are ignored, but they separate words. The input of this step is a stream of characters, the output a stream of words.</li>
  <li>Step 2 – extracting numbers (words → numbers): only keep words that match the regular expression <code>/^[0-9]+$/</code> and convert them to numbers.</li>
  <li>Step 3 – adding numbers (numbers → numbers): for every number received, return the total received so far.</li>
</ul>
<p>The neat thing is that everything is computed <em>lazily</em> (incrementally and on demand): computation starts as soon as the first character arrives. For example, we don’t have to wait until we have all characters to get the first word.</p>

<h5 id="leanpub-auto-lazy-pull-generators-as-iterators">
<span class="section-number">21.6.2.1 </span>Lazy pull (generators as iterators)</h5>

<p>Lazy pull with generators works as follows. The three generators implementing steps 1–3 are chained as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">addNumbers</code><code class="p">(</code><code class="nx">extractNumbers</code><code class="p">(</code><code class="nx">tokenize</code><code class="p">(</code><code class="nx">CHARS</code><code class="p">)))</code>
</pre></div>

</div>

<p>Each of the chain members pulls data from a source and yields a sequence of items. Processing starts with <code>tokenize</code> whose source is the string <code>CHARS</code>.</p>

<h6 id="leanpub-auto-step-1--tokenizing">
<span class="section-number">21.6.2.1.1 </span>Step 1 – tokenizing</h6>

<p>The following trick makes the code a bit simpler: the end-of-sequence iterator result (whose property <code>done</code> is <code>false</code>) is converted into the sentinel value <code>END_OF_SEQUENCE</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Returns an iterable that transforms the input sequence</code>
<code class="cm"> * of characters into an output sequence of words.</code>
<code class="cm"> */</code>
<code class="kd">function</code><code class="o">*</code> <code class="nx">tokenize</code><code class="p">(</code><code class="nx">chars</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">iterator</code> <code class="o">=</code> <code class="nx">chars</code><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]();</code>
    <code class="kd">let</code> <code class="nx">ch</code><code class="p">;</code>
    <code class="k">do</code> <code class="p">{</code>
        <code class="nx">ch</code> <code class="o">=</code> <code class="nx">getNextItem</code><code class="p">(</code><code class="nx">iterator</code><code class="p">);</code> <code class="c1">// (A)</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">isWordChar</code><code class="p">(</code><code class="nx">ch</code><code class="p">))</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">word</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>
            <code class="k">do</code> <code class="p">{</code>
                <code class="nx">word</code> <code class="o">+=</code> <code class="nx">ch</code><code class="p">;</code>
                <code class="nx">ch</code> <code class="o">=</code> <code class="nx">getNextItem</code><code class="p">(</code><code class="nx">iterator</code><code class="p">);</code> <code class="c1">// (B)</code>
            <code class="p">}</code> <code class="k">while</code> <code class="p">(</code><code class="nx">isWordChar</code><code class="p">(</code><code class="nx">ch</code><code class="p">));</code>
            <code class="k">yield</code> <code class="nx">word</code><code class="p">;</code> <code class="c1">// (C)</code>
        <code class="p">}</code>
        <code class="c1">// Ignore all other characters</code>
    <code class="p">}</code> <code class="k">while</code> <code class="p">(</code><code class="nx">ch</code> <code class="o">!==</code> <code class="nx">END_OF_SEQUENCE</code><code class="p">);</code>
<code class="p">}</code>
<code class="kr">const</code> <code class="nx">END_OF_SEQUENCE</code> <code class="o">=</code> <code class="nx">Symbol</code><code class="p">();</code>
<code class="kd">function</code> <code class="nx">getNextItem</code><code class="p">(</code><code class="nx">iterator</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="p">{</code><code class="nx">value</code><code class="p">,</code><code class="nx">done</code><code class="p">}</code> <code class="o">=</code> <code class="nx">iterator</code><code class="p">.</code><code class="nx">next</code><code class="p">();</code>
    <code class="k">return</code> <code class="nx">done</code> <code class="o">?</code> <code class="nx">END_OF_SEQUENCE</code> <code class="o">:</code> <code class="nx">value</code><code class="p">;</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">isWordChar</code><code class="p">(</code><code class="nx">ch</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">typeof</code> <code class="nx">ch</code> <code class="o">===</code> <code class="s1">'string'</code> <code class="o">&amp;&amp;</code> <code class="sr">/^[A-Za-z0-9]$/</code><code class="p">.</code><code class="nx">test</code><code class="p">(</code><code class="nx">ch</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>How is this generator lazy? When you ask it for a token via <code>next()</code>, it pulls its <code>iterator</code> (lines A and B) as often as needed to produce as token and then yields that token (line C). Then it pauses until it is again asked for a token. That means that tokenization starts as soon as the first characters are available, which is convenient for streams.</p>

<p>Let’s try out tokenization. Note that the spaces and the dot are non-words. They are ignored, but they separate words. We use the fact that strings are iterables over characters (Unicode code points). The result of <code>tokenize()</code> is an iterable over words, which we turn into an array via the spread operator (<code>...</code>).</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[...</code><code class="n">tokenize</code><code class="p">(</code><code class="err">'</code><code class="mi">2</code> <code class="n">apples</code> <code class="n">and</code> <code class="mi">5</code> <code class="n">oranges</code><code class="p">.</code><code class="err">'</code><code class="p">)]</code>
<code class="p">[</code> <code class="sc">'2'</code><code class="p">,</code> <code class="err">'</code><code class="n">apples</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">and</code><code class="err">'</code><code class="p">,</code> <code class="sc">'5'</code><code class="p">,</code> <code class="err">'</code><code class="n">oranges</code><code class="err">'</code> <code class="p">]</code>
</pre></div>

</div>

<h6 id="leanpub-auto-step-2--extracting-numbers">
<span class="section-number">21.6.2.1.2 </span>Step 2 – extracting numbers</h6>

<p>This step is relatively simple, we only <code>yield</code> words that contain nothing but digits, after converting them to numbers via <code>Number()</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Returns an iterable that filters the input sequence</code>
<code class="cm"> * of words and only yields those that are numbers.</code>
<code class="cm"> */</code>
<code class="kd">function</code><code class="o">*</code> <code class="nx">extractNumbers</code><code class="p">(</code><code class="nx">words</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">word</code> <code class="nx">of</code> <code class="nx">words</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="sr">/^[0-9]+$/</code><code class="p">.</code><code class="nx">test</code><code class="p">(</code><code class="nx">word</code><code class="p">))</code> <code class="p">{</code>
            <code class="k">yield</code> <code class="nb">Number</code><code class="p">(</code><code class="nx">word</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>You can again see the laziness: If you ask for a number via <code>next()</code>, you get one (via <code>yield</code>) as soon as one is encountered in <code>words</code>.</p>

<p>Let’s extract the numbers from an Array of words:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[...</code><code class="n">extractNumbers</code><code class="p">([</code><code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="mi">123</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">world</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="mi">45</code><code class="err">'</code><code class="p">])]</code>
<code class="p">[</code> <code class="mi">123</code><code class="p">,</code> <code class="mi">45</code> <code class="p">]</code>
</pre></div>

</div>

<p>Note that strings are converted to numbers.</p>

<h6 id="leanpub-auto-step-3--adding-numbers">
<span class="section-number">21.6.2.1.3 </span>Step 3 – adding numbers</h6>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Returns an iterable that contains, for each number in</code>
<code class="cm"> * `numbers`, the total sum of numbers encountered so far.</code>
<code class="cm"> * For example: 7, 4, -1 --&gt; 7, 11, 10</code>
<code class="cm"> */</code>
<code class="kd">function</code><code class="o">*</code> <code class="nx">addNumbers</code><code class="p">(</code><code class="nx">numbers</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">n</code> <code class="nx">of</code> <code class="nx">numbers</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">result</code> <code class="o">+=</code> <code class="nx">n</code><code class="p">;</code>
        <code class="k">yield</code> <code class="nx">result</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Let’s try a simple example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[...</code><code class="nx">addNumbers</code><code class="p">([</code><code class="mi">5</code><code class="p">,</code> <code class="o">-</code><code class="mi">2</code><code class="p">,</code> <code class="mi">12</code><code class="p">])]</code>
<code class="p">[</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">15</code> <code class="p">]</code>
</pre></div>

</div>

<h6 id="leanpub-auto-pulling-the-output">
<span class="section-number">21.6.2.1.4 </span>Pulling the output</h6>

<p>On its own, the chain of generator doesn’t produce output. We need to actively pull the output via the spread operator:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">CHARS</code> <code class="o">=</code> <code class="s1">'2 apples and 5 oranges.'</code><code class="p">;</code>
<code class="kr">const</code> <code class="nx">CHAIN</code> <code class="o">=</code> <code class="nx">addNumbers</code><code class="p">(</code><code class="nx">extractNumbers</code><code class="p">(</code><code class="nx">tokenize</code><code class="p">(</code><code class="nx">CHARS</code><code class="p">)));</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">([...</code><code class="nx">CHAIN</code><code class="p">]);</code>
    <code class="c1">// [ 2, 7 ]</code>
</pre></div>

</div>

<p>The helper function <code>logAndYield</code> allows us to examine whether things are indeed computed lazily:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">logAndYield</code><code class="p">(</code><code class="nx">iterable</code><code class="p">,</code> <code class="nx">prefix</code><code class="o">=</code><code class="s1">''</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">item</code> <code class="nx">of</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">prefix</code> <code class="o">+</code> <code class="nx">item</code><code class="p">);</code>
        <code class="k">yield</code> <code class="nx">item</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">CHAIN2</code> <code class="o">=</code> <code class="nx">logAndYield</code><code class="p">(</code><code class="nx">addNumbers</code><code class="p">(</code><code class="nx">extractNumbers</code><code class="p">(</code><code class="nx">tokenize</code><code class="p">(</code><code class="nx">logAndYield</code><code class="p">(</code><code class="nx">CHARS</code><code class="p">)</code><code class="o">\</code>
<code class="p">))),</code> <code class="s1">'-&gt; '</code><code class="p">);</code>
<code class="p">[...</code><code class="nx">CHAIN2</code><code class="p">];</code>

<code class="c1">// Output:</code>
<code class="c1">// 2</code>
<code class="c1">//  </code>
<code class="c1">// -&gt; 2</code>
<code class="c1">// a</code>
<code class="c1">// p</code>
<code class="c1">// p</code>
<code class="c1">// l</code>
<code class="c1">// e</code>
<code class="c1">// s</code>
<code class="c1">//  </code>
<code class="c1">// a</code>
<code class="c1">// n</code>
<code class="c1">// d</code>
<code class="c1">//  </code>
<code class="c1">// 5</code>
<code class="c1">//  </code>
<code class="c1">// -&gt; 7</code>
<code class="c1">// o</code>
<code class="c1">// r</code>
<code class="c1">// a</code>
<code class="c1">// n</code>
<code class="c1">// g</code>
<code class="c1">// e</code>
<code class="c1">// s</code>
<code class="c1">// .</code>
</pre></div>

</div>

<p>The output shows that <code>addNumbers</code> produces a result as soon as the characters <code>'2'</code> and <code>' '</code> are received.</p>

<h5 id="leanpub-auto-lazy-push-generators-as-observables">
<span class="section-number">21.6.2.2 </span>Lazy push (generators as observables)</h5>

<p>Not much work is needed to convert the previous pull-based algorithm into a push-based one. The steps are the same. But instead of finishing via pulling, we start via pushing.</p>

<p>As previously explained, if generators receive input via <code>yield</code>, the first invocation of <code>next()</code> on the generator object doesn’t do anything. That’s why I use <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#function_coroutine">the previously shown helper function <code>coroutine()</code></a> to create coroutines here. It executes the first <code>next()</code> for us.</p>

<p>The following function <code>send()</code> does the pushing.</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Pushes the items of `iterable` into `sink`, a generator.</code>
<code class="cm"> * It uses the generator method `next()` to do so.</code>
<code class="cm"> */</code>
<code class="kd">function</code> <code class="nx">send</code><code class="p">(</code><code class="nx">iterable</code><code class="p">,</code> <code class="nx">sink</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">x</code> <code class="nx">of</code> <code class="nx">iterable</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">sink</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="nx">sink</code><code class="p">.</code><code class="k">return</code><code class="p">();</code> <code class="c1">// signal end of stream</code>
<code class="p">}</code>
</pre></div>

</div>

<p>When a generator processes a stream, it needs to be aware of the end of the stream, so that it can clean up properly. For pull, we did this via a special end-of-stream sentinel. For push, the end-of-stream is signaled via <code>return()</code>.</p>

<p>Let’s test <code>send()</code> via a generator that simply outputs everything it receives:</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * This generator logs everything that it receives via `next()`.</code>
<code class="cm"> */</code>
<code class="kr">const</code> <code class="nx">logItems</code> <code class="o">=</code> <code class="nx">coroutine</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">item</code> <code class="o">=</code> <code class="k">yield</code><code class="p">;</code> <code class="c1">// receive item via `next()`</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">item</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'DONE'</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>Let’s send <code>logItems()</code> three characters via a string (which is an iterable over Unicode code points).</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">send</code><code class="p">(</code><code class="err">'</code><code class="n">abc</code><code class="err">'</code><code class="p">,</code> <code class="n">logItems</code><code class="p">());</code>
<code class="n">a</code>
<code class="n">b</code>
<code class="n">c</code>
<code class="n">DONE</code>
</pre></div>

</div>

<h6 id="leanpub-auto-step-1--tokenize">
<span class="section-number">21.6.2.2.1 </span>Step 1 – tokenize</h6>

<p>Note how this generator reacts to the end of the stream (as signaled via <code>return()</code>) in two <code>finally</code> clauses. We depend on <code>return()</code> being sent to either one of the two <code>yield</code>s. Otherwise, the generator would never terminate, because the infinite loop starting in line A would never terminate.</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Receives a sequence of characters (via the generator object</code>
<code class="cm"> * method `next()`), groups them into words and pushes them</code>
<code class="cm"> * into the generator `sink`.</code>
<code class="cm"> */</code>
<code class="kr">const</code> <code class="nx">tokenize</code> <code class="o">=</code> <code class="nx">coroutine</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">(</code><code class="nx">sink</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// (A)</code>
            <code class="kd">let</code> <code class="nx">ch</code> <code class="o">=</code> <code class="k">yield</code><code class="p">;</code> <code class="c1">// (B)</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">isWordChar</code><code class="p">(</code><code class="nx">ch</code><code class="p">))</code> <code class="p">{</code>
                <code class="c1">// A word has started</code>
                <code class="kd">let</code> <code class="nx">word</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>
                <code class="k">try</code> <code class="p">{</code>
                    <code class="k">do</code> <code class="p">{</code>
                        <code class="nx">word</code> <code class="o">+=</code> <code class="nx">ch</code><code class="p">;</code>
                        <code class="nx">ch</code> <code class="o">=</code> <code class="k">yield</code><code class="p">;</code> <code class="c1">// (C)</code>
                    <code class="p">}</code> <code class="k">while</code> <code class="p">(</code><code class="nx">isWordChar</code><code class="p">(</code><code class="nx">ch</code><code class="p">));</code>
                <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
                    <code class="c1">// The word is finished.</code>
                    <code class="c1">// We get here if</code>
                    <code class="c1">// - the loop terminates normally</code>
                    <code class="c1">// - the loop is terminated via `return()` in line C</code>
                    <code class="nx">sink</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nx">word</code><code class="p">);</code> <code class="c1">// (D)</code>
                <code class="p">}</code>
            <code class="p">}</code>
            <code class="c1">// Ignore all other characters</code>
        <code class="p">}</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="c1">// We only get here if the infinite loop is terminated</code>
        <code class="c1">// via `return()` (in line B or C).</code>
        <code class="c1">// Forward `return()` to `sink` so that it is also</code>
        <code class="c1">// aware of the end of stream.</code>
        <code class="nx">sink</code><code class="p">.</code><code class="k">return</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">});</code>

<code class="kd">function</code> <code class="nx">isWordChar</code><code class="p">(</code><code class="nx">ch</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="sr">/^[A-Za-z0-9]$/</code><code class="p">.</code><code class="nx">test</code><code class="p">(</code><code class="nx">ch</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This time, the laziness is driven by push: as soon as the generator has received enough characters for a word (in line C), it pushes the word into <code>sink</code> (line D). That is, the generator does not wait until it has received all characters.</p>

<p><code>tokenize()</code> demonstrates that generators work well as implementations of linear state machines. In this case, the machine has two states: “inside a word” and “not inside a word”.</p>

<p>Let’s tokenize a string:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">send</code><code class="p">(</code><code class="err">'</code><code class="mi">2</code> <code class="n">apples</code> <code class="n">and</code> <code class="mi">5</code> <code class="n">oranges</code><code class="p">.</code><code class="err">'</code><code class="p">,</code> <code class="n">tokenize</code><code class="p">(</code><code class="n">logItems</code><code class="p">()));</code>
<code class="mi">2</code>
<code class="n">apples</code>
<code class="n">and</code>
<code class="mi">5</code>
<code class="n">oranges</code>
</pre></div>

</div>

<h6 id="leanpub-auto-step-2--extract-numbers">
<span class="section-number">21.6.2.2.2 </span>Step 2 – extract numbers</h6>

<p>This step is straightforward.</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Receives a sequence of strings (via the generator object</code>
<code class="cm"> * method `next()`) and pushes only those strings to the generator</code>
<code class="cm"> * `sink` that are “numbers” (consist only of decimal digits).</code>
<code class="cm"> */</code>
<code class="kr">const</code> <code class="nx">extractNumbers</code> <code class="o">=</code> <code class="nx">coroutine</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">(</code><code class="nx">sink</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">word</code> <code class="o">=</code> <code class="k">yield</code><code class="p">;</code>
            <code class="k">if</code> <code class="p">(</code><code class="sr">/^[0-9]+$/</code><code class="p">.</code><code class="nx">test</code><code class="p">(</code><code class="nx">word</code><code class="p">))</code> <code class="p">{</code>
                <code class="nx">sink</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nb">Number</code><code class="p">(</code><code class="nx">word</code><code class="p">));</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="c1">// Only reached via `return()`, forward.</code>
        <code class="nx">sink</code><code class="p">.</code><code class="k">return</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>Things are again lazy: as soon as as number is encountered, it is pushed to <code>sink</code>.</p>

<p>Let’s extract the numbers from an Array of words:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">send</code><code class="p">([</code><code class="err">'</code><code class="n">hello</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="mi">123</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="n">world</code><code class="err">'</code><code class="p">,</code> <code class="err">'</code><code class="mi">45</code><code class="err">'</code><code class="p">],</code> <code class="n">extractNumbers</code><code class="p">(</code><code class="n">logItems</code><code class="p">()));</code>
<code class="mi">123</code>
<code class="mi">45</code>
<code class="n">DONE</code>
</pre></div>

</div>

<p>Note that the input is a sequence of strings, while the output is a sequence of numbers.</p>

<h6 id="leanpub-auto-step-3--add-numbers">
<span class="section-number">21.6.2.2.3 </span>Step 3 – add numbers</h6>

<p>This time, we react to the end of the stream by pushing a single value and then closing the sink.</p>

<div class="code-block">
<div class="highlight"><pre><code class="cm">/**</code>
<code class="cm"> * Receives a sequence of numbers (via the generator object</code>
<code class="cm"> * method `next()`). For each number, it pushes the total sum</code>
<code class="cm"> * so far to the generator `sink`.</code>
<code class="cm"> */</code>
<code class="kr">const</code> <code class="nx">addNumbers</code> <code class="o">=</code> <code class="nx">coroutine</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">(</code><code class="nx">sink</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">sum</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">sum</code> <code class="o">+=</code> <code class="k">yield</code><code class="p">;</code>
            <code class="nx">sink</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nx">sum</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
        <code class="c1">// We received an end-of-stream</code>
        <code class="nx">sink</code><code class="p">.</code><code class="k">return</code><code class="p">();</code> <code class="c1">// signal end of stream</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>Let’s try out this generator:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">send</code><code class="p">([</code><code class="mi">5</code><code class="p">,</code> <code class="o">-</code><code class="mi">2</code><code class="p">,</code> <code class="mi">12</code><code class="p">],</code> <code class="n">addNumbers</code><code class="p">(</code><code class="n">logItems</code><code class="p">()));</code>
<code class="mi">5</code>
<code class="mi">3</code>
<code class="mi">15</code>
<code class="n">DONE</code>
</pre></div>

</div>

<h6 id="leanpub-auto-pushing-the-input">
<span class="section-number">21.6.2.2.4 </span>Pushing the input</h6>

<p>The chain of generators starts with <code>tokenize</code> and ends with <code>logItems</code>, which logs everything it receives. We push a sequence of characters into the chain via <code>send</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">INPUT</code> <code class="o">=</code> <code class="s1">'2 apples and 5 oranges.'</code><code class="p">;</code>
<code class="kr">const</code> <code class="nx">CHAIN</code> <code class="o">=</code> <code class="nx">tokenize</code><code class="p">(</code><code class="nx">extractNumbers</code><code class="p">(</code><code class="nx">addNumbers</code><code class="p">(</code><code class="nx">logItems</code><code class="p">())));</code>
<code class="nx">send</code><code class="p">(</code><code class="nx">INPUT</code><code class="p">,</code> <code class="nx">CHAIN</code><code class="p">);</code>

<code class="c1">// Output</code>
<code class="c1">// 2</code>
<code class="c1">// 7</code>
<code class="c1">// DONE</code>
</pre></div>

</div>

<p>The following code proves that processing really happens lazily:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">CHAIN2</code> <code class="o">=</code> <code class="nx">tokenize</code><code class="p">(</code><code class="nx">extractNumbers</code><code class="p">(</code><code class="nx">addNumbers</code><code class="p">(</code><code class="nx">logItems</code><code class="p">({</code> <code class="nx">prefix</code><code class="o">:</code> <code class="s1">'-&gt; '</code> <code class="p">}))));</code>
<code class="nx">send</code><code class="p">(</code><code class="nx">INPUT</code><code class="p">,</code> <code class="nx">CHAIN2</code><code class="p">,</code> <code class="p">{</code> <code class="nx">log</code><code class="o">:</code> <code class="kc">true</code> <code class="p">});</code>

<code class="c1">// Output</code>
<code class="c1">// 2</code>
<code class="c1">//  </code>
<code class="c1">// -&gt; 2</code>
<code class="c1">// a</code>
<code class="c1">// p</code>
<code class="c1">// p</code>
<code class="c1">// l</code>
<code class="c1">// e</code>
<code class="c1">// s</code>
<code class="c1">//  </code>
<code class="c1">// a</code>
<code class="c1">// n</code>
<code class="c1">// d</code>
<code class="c1">//  </code>
<code class="c1">// 5</code>
<code class="c1">//  </code>
<code class="c1">// -&gt; 7</code>
<code class="c1">// o</code>
<code class="c1">// r</code>
<code class="c1">// a</code>
<code class="c1">// n</code>
<code class="c1">// g</code>
<code class="c1">// e</code>
<code class="c1">// s</code>
<code class="c1">// .</code>
<code class="c1">// DONE</code>
</pre></div>

</div>

<p>The output shows that <code>addNumbers</code> produces a result as soon as the characters <code>'2'</code> and <code>' '</code> are pushed.</p>


<h4 id="leanpub-auto-cooperative-multi-tasking-via-generators">
<span class="section-number">21.6.3 </span>Cooperative multi-tasking via generators</h4>

<h5 id="leanpub-auto-pausing-long-running-tasks">
<span class="section-number">21.6.3.1 </span>Pausing long-running tasks</h5>

<p>In this example, we create a counter that is displayed on a web page. We improve an initial version until we have a cooperatively multitasked version that doesn’t block the main thread and the user interface.</p>

<p>This is the part of the web page in which the counter should be displayed:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nt">&lt;body&gt;</code>
    Counter: <code class="nt">&lt;span</code> <code class="na">id=</code><code class="s">"counter"</code><code class="nt">&gt;&lt;/span&gt;</code>
<code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>This function displays a counter that counts up forever<sup id="fnref-generators_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-generators_1" rel="footnote">1</a></sup>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">countUp</code><code class="p">(</code><code class="nx">start</code> <code class="o">=</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">counterSpan</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#counter'</code><code class="p">);</code>
    <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">counterSpan</code><code class="p">.</code><code class="nx">textContent</code> <code class="o">=</code> <code class="nb">String</code><code class="p">(</code><code class="nx">start</code><code class="p">);</code>
        <code class="nx">start</code><code class="o">++</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>If you ran this function, it would completely block the user interface thread in which it runs and its tab would become unresponsive.</p>

<p>Let’s implement the same functionality via a generator that periodically pauses via <code>yield</code> (a scheduling function for running this generator is shown later):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">countUp</code><code class="p">(</code><code class="nx">start</code> <code class="o">=</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">counterSpan</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#counter'</code><code class="p">);</code>
    <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">counterSpan</code><code class="p">.</code><code class="nx">textContent</code> <code class="o">=</code> <code class="nb">String</code><code class="p">(</code><code class="nx">start</code><code class="p">);</code>
        <code class="nx">start</code><code class="o">++</code><code class="p">;</code>
        <code class="k">yield</code><code class="p">;</code> <code class="c1">// pause</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Let’s add one small improvement. We move the update of the user interface to another generator, <code>displayCounter</code>, which we call via <code>yield*</code>. As it is a generator, it can also take care of pausing.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">countUp</code><code class="p">(</code><code class="nx">start</code> <code class="o">=</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">start</code><code class="o">++</code><code class="p">;</code>
        <code class="k">yield</code><code class="o">*</code> <code class="nx">displayCounter</code><code class="p">(</code><code class="nx">start</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="kd">function</code><code class="o">*</code> <code class="nx">displayCounter</code><code class="p">(</code><code class="nx">counter</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">counterSpan</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#counter'</code><code class="p">);</code>
    <code class="nx">counterSpan</code><code class="p">.</code><code class="nx">textContent</code> <code class="o">=</code> <code class="nb">String</code><code class="p">(</code><code class="nx">counter</code><code class="p">);</code>
    <code class="k">yield</code><code class="p">;</code> <code class="c1">// pause</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Lastly, this is a scheduling function that we can use to run <code>countUp()</code>. Each execution step of the generator is handled by a separate task, which is created via <code>setTimeout()</code>. That means that the user interface can schedule other tasks in between and will remain responsive.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">run</code><code class="p">(</code><code class="nx">generatorObject</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">generatorObject</code><code class="p">.</code><code class="nx">next</code><code class="p">().</code><code class="nx">done</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// Add a new task to the event queue</code>
        <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
            <code class="nx">run</code><code class="p">(</code><code class="nx">generatorObject</code><code class="p">);</code>
        <code class="p">},</code> <code class="mi">1000</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>With the help of <code>run</code>, we get a (nearly) infinite count-up that doesn’t block the user interface:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">run</code><code class="p">(</code><code class="nx">countUp</code><code class="p">());</code>
</pre></div>

</div>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>You can <a href="https://rauschma.github.io/generator-examples/nonblocking-counter/">run this example online</a>.</p>

    </td>
  </tr></tbody></table>
<h5 id="leanpub-auto-cooperative-multitasking-with-generators-and-nodejs-style-callbacks">
<span class="section-number">21.6.3.2 </span>Cooperative multitasking with generators and Node.js-style callbacks</h5>

<p>If you call a generator function (or method), it does not have access to its generator object; its <code>this</code> is the <code>this</code> it would have if it were a non-generator function. A work-around is to pass the generator object into the generator function via <code>yield</code>.</p>

<p>The following Node.js script uses this technique, but wraps the generator object in a callback (<code>next</code>, line A). It must be run via <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_babel-node"><code>babel-node</code></a>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="p">{</code><code class="nx">readFile</code><code class="p">}</code> <code class="nx">from</code> <code class="s1">'fs'</code><code class="p">;</code>

<code class="kd">let</code> <code class="nx">fileNames</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">argv</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code>

<code class="nx">run</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">next</code> <code class="o">=</code> <code class="k">yield</code><code class="p">;</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">f</code> <code class="nx">of</code> <code class="nx">fileNames</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">contents</code> <code class="o">=</code> <code class="k">yield</code> <code class="nx">readFile</code><code class="p">(</code><code class="nx">f</code><code class="p">,</code> <code class="p">{</code> <code class="nx">encoding</code><code class="o">:</code> <code class="s1">'utf8'</code> <code class="p">},</code> <code class="nx">next</code><code class="p">);</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'##### '</code> <code class="o">+</code> <code class="nx">f</code><code class="p">);</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">contents</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>In line A, we get a callback that we can use with functions that follow Node.js callback conventions. The callback uses the generator object to wake up the generator, as you can see in the implementation of <code>run()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">run</code><code class="p">(</code><code class="nx">generatorFunction</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">generatorObject</code> <code class="o">=</code> <code class="nx">generatorFunction</code><code class="p">();</code>

    <code class="c1">// Step 1: Proceed to first `yield`</code>
    <code class="nx">generatorObject</code><code class="p">.</code><code class="nx">next</code><code class="p">();</code>

    <code class="c1">// Step 2: Pass in a function that the generator can use as a callback</code>
    <code class="kd">function</code> <code class="nx">nextFunction</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">result</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">generatorObject</code><code class="p">.</code><code class="k">throw</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
        <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
            <code class="nx">generatorObject</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nx">result</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code>
    <code class="nx">generatorObject</code><code class="p">.</code><code class="nx">next</code><code class="p">(</code><code class="nx">nextFunction</code><code class="p">);</code>

    <code class="c1">// Subsequent invocations of `next()` are triggered by `nextFunction`</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="sec_csp">
<span class="section-number">21.6.3.3 </span>Communicating Sequential Processes (CSP)</h5>

<p>The library <a href="https://github.com/ubolonton/js-csp"><code>js-csp</code></a> brings Communicating Sequential Processes (CSP) to JavaScript, a style of cooperative multitasking that is similar to ClojureScript’s core.async and Go’s <em>goroutines</em>. <code>js-csp</code> has two abstractions:</p>

<ul>
<li>Processes: are cooperatively multitasked tasks and implemented by handing a generator function to the scheduling function <code>go()</code>.</li>
  <li>Channels: are queues for communication between processes. Channels are created by calling <code>chan()</code>.</li>
</ul>
<p>As an example, let’s use CSP to handle DOM events, in a manner reminiscent of Functional Reactive Programming. The following code uses the function <code>listen()</code> (which is shown later) to create a channel that outputs <code>mousemove</code> events. It then continuously retrieves the output via <code>take</code>, inside an infinite loop. Thanks to <code>yield</code>, the process blocks until the channel has output.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="nx">csp</code> <code class="nx">from</code> <code class="s1">'js-csp'</code><code class="p">;</code>

<code class="nx">csp</code><code class="p">.</code><code class="nx">go</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">element</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#uiElement1'</code><code class="p">);</code>
    <code class="kd">let</code> <code class="nx">channel</code> <code class="o">=</code> <code class="nx">listen</code><code class="p">(</code><code class="nx">element</code><code class="p">,</code> <code class="s1">'mousemove'</code><code class="p">);</code>
    <code class="k">while</code> <code class="p">(</code><code class="kc">true</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">event</code> <code class="o">=</code> <code class="k">yield</code> <code class="nx">csp</code><code class="p">.</code><code class="nx">take</code><code class="p">(</code><code class="nx">channel</code><code class="p">);</code>
        <code class="kd">let</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">layerX</code> <code class="o">||</code> <code class="nx">event</code><code class="p">.</code><code class="nx">clientX</code><code class="p">;</code>
        <code class="kd">let</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">layerY</code> <code class="o">||</code> <code class="nx">event</code><code class="p">.</code><code class="nx">clientY</code><code class="p">;</code>
        <code class="nx">element</code><code class="p">.</code><code class="nx">textContent</code> <code class="o">=</code> <code class="err">`</code><code class="nx">$</code><code class="p">{</code><code class="nx">x</code><code class="p">},</code> <code class="nx">$</code><code class="p">{</code><code class="nx">y</code><code class="p">}</code><code class="err">`</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p><code>listen()</code> is implemented as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">listen</code><code class="p">(</code><code class="nx">element</code><code class="p">,</code> <code class="nx">type</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">channel</code> <code class="o">=</code> <code class="nx">csp</code><code class="p">.</code><code class="nx">chan</code><code class="p">();</code>
    <code class="nx">element</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="nx">type</code><code class="p">,</code>
        <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">csp</code><code class="p">.</code><code class="nx">putAsync</code><code class="p">(</code><code class="nx">channel</code><code class="p">,</code> <code class="nx">event</code><code class="p">);</code>
        <code class="p">});</code>
    <code class="k">return</code> <code class="nx">channel</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_external-link.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>This example is taken from the blog post “<a href="http://jlongster.com/Taming-the-Asynchronous-Beast-with-CSP-in-JavaScript">Taming the Asynchronous Beast with CSP Channels in JavaScript</a>” by James Long. Consult this blog post for more information on CSP.</p>

    </td>
  </tr></tbody></table>
<h3 id="leanpub-auto-inheritance-within-the-iteration-api-including-generators">
<span class="section-number">21.7 </span>Inheritance within the iteration API (including generators)</h3>

<p>This is a diagram of how various objects are connected in ECMAScript 6 (it is based on <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-generatorfunction-objects">Allen Wirf-Brock’s diagram</a> in the ECMAScript specification):</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/generators----generator_inheritance.jpg" alt=""><p class="caption"></p>
</div>

<p>Legend:</p>

<ul>
<li>The white (hollow) arrows express the has-prototype relationship (inheritance) between objects. In other words: a white arrow from <code>x</code> to <code>y</code> means that <code>Object.getPrototypeOf(x) === y</code>.</li>
  <li>Parentheses indicate that an object exists, but is not accessible via a global variable.</li>
  <li>An <code>instanceof</code> arrow from <code>x</code> to <code>y</code> means that <code>x instanceof y</code>.
    <ul>
<li>Remember that <code>o instanceof C</code> is equivalent to <code>C.prototype.isPrototypeOf(o)</code>.</li>
    </ul>
</li>
  <li>A <code>prototype</code> arrow from <code>x</code> to <code>y</code> means that <code>x.prototype === y</code>.</li>
</ul>
<p>The diagram reveals two interesting facts:</p>

<p>First, a generator function <code>g</code> works very much like a constructor (you can even invoke it via <code>new</code>, which has basically the same effect as calling it): The generator objects it creates are instances of it, methods added to <code>g.prototype</code> become prototype methods, etc.:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">function</code><code class="o">*</code> <code class="nx">g</code><code class="p">()</code> <code class="p">{}</code>
<code class="o">&gt;</code> <code class="nx">g</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">hello</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="k">return</code> <code class="s1">'hi!'</code><code class="p">};</code>
<code class="o">&gt;</code> <code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="nx">g</code><code class="p">();</code>
<code class="o">&gt;</code> <code class="nx">obj</code> <code class="k">instanceof</code> <code class="nx">g</code>
<code class="kc">true</code>
<code class="o">&gt;</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">hello</code><code class="p">()</code>
<code class="s1">'hi!'</code>
</pre></div>

</div>

<p>Second, if you want to make methods available for all generator objects, it’s best to add them to <code>(Generator.object)</code>. One way of accessing that object is as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">let</code> <code class="nx">Generator_prototype</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">getPrototypeOf</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{}).</code><code class="nx">prototype</code><code class="p">;</code>
<code class="o">&gt;</code> <code class="nx">Generator_prototype</code><code class="p">.</code><code class="nx">hello</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="k">return</code> <code class="s1">'hi!'</code><code class="p">};</code>
<code class="o">&gt;</code> <code class="kd">let</code> <code class="nx">generatorObject</code> <code class="o">=</code> <code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{})();</code>
<code class="o">&gt;</code> <code class="nx">generatorObject</code><code class="p">.</code><code class="nx">hello</code><code class="p">()</code>
<code class="s1">'hi!'</code>
</pre></div>

</div>

<h4 id="leanpub-auto-iteratorprototype">
<span class="section-number">21.7.1 </span><code>IteratorPrototype</code>
</h4>

<p>There is no <code>(Iterator)</code> in the diagram, because no such object exists. But, given how <code>instanceof</code> works and because <code>(IteratorPrototype)</code> is a prototype of <code>g1()</code>, you could still say that <code>g1()</code> is an instance of <code>Iterator</code>.</p>

<p>All iterators in ES6 have <code>(IteratorPrototype)</code> in their prototype chain. That object is iterable, because it has the following method. Therefore, all ES6 iterators are iterable (as a consequence, you can apply <code>for-of</code> etc. to them).</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The specification recommends to use the following code to access <code>(IteratorPrototype)</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">proto</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">getPrototypeOf</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nb">Object</code><code class="p">);</code>
<code class="kd">let</code> <code class="nx">IteratorPrototype</code> <code class="o">=</code> <code class="nx">proto</code><code class="p">(</code><code class="nx">proto</code><code class="p">([][</code><code class="nx">Symbol</code><code class="p">.</code><code class="nx">iterator</code><code class="p">]()));</code>
</pre></div>

</div>

<p>You could also use:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">IteratorPrototype</code> <code class="o">=</code> <code class="nx">proto</code><code class="p">(</code><code class="nx">proto</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{}.</code><code class="nx">prototype</code><code class="p">));</code>
</pre></div>

</div>

<p>Quoting the ECMAScript 6 specification:</p>

<blockquote>
  <p>ECMAScript code may also define objects that inherit from <code>IteratorPrototype</code>. The <code>IteratorPrototype</code> object provides a place where additional methods that are applicable to all iterator objects may be added.</p>
</blockquote>

<p><code>IteratorPrototype</code> will probably become directly accessible in an upcoming version of ECMAScript and contain tool methods such as <code>map()</code> and <code>filter()</code> (<a href="https://github.com/rwaldron/tc39-notes/blob/master/es6/2014-07/jul-30.md#47-revisit-comprehension-decision-from-last-meeting">source</a>).</p>

<h4 id="leanpub-auto-the-value-of-this-in-generators">
<span class="section-number">21.7.2 </span>The value of <code>this</code> in generators</h4>

<p>A generator function combines two concerns:</p>

<ol class="numeric numeric">
<li>It is a function that sets up and returns a generator object.</li>
  <li>It contains the code that the generator object steps through.</li>
</ol>
<p>That’s why it’s not immediately obvious what the value of <code>this</code> should be inside a generator.</p>

<p>In function calls and method calls, <code>this</code> is what it would be if <code>gen()</code> wasn’t a generator function, but a normal function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">gen</code><code class="p">()</code> <code class="p">{</code>
    <code class="s1">'use strict'</code><code class="p">;</code> <code class="c1">// just in case</code>
    <code class="k">yield</code> <code class="k">this</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">// Retrieve the yielded value via destructuring</code>
<code class="kd">let</code> <code class="p">[</code><code class="nx">functionThis</code><code class="p">]</code> <code class="o">=</code> <code class="nx">gen</code><code class="p">();</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">functionThis</code><code class="p">);</code> <code class="c1">// undefined</code>

<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="nx">gen</code> <code class="p">};</code>
<code class="kd">let</code> <code class="p">[</code><code class="nx">methodThis</code><code class="p">]</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">method</code><code class="p">();</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">methodThis</code> <code class="o">===</code> <code class="nx">obj</code><code class="p">);</code> <code class="c1">// true</code>
</pre></div>

</div>

<p>If you access <code>this</code> in a generator that was invoked via <code>new</code>, you get a <code>ReferenceError</code> (<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-generator-function-definitions-runtime-semantics-evaluatebody">source: ES6 spec</a>):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">gen</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="k">this</code><code class="p">);</code> <code class="c1">// ReferenceError</code>
<code class="p">}</code>
<code class="k">new</code> <code class="nx">gen</code><code class="p">();</code>
</pre></div>

</div>

<p>A work-around is to wrap the generator in a normal function that hands the generator its generator object via <code>next()</code>. That means that the generator must use its first <code>yield</code> to retrieve its generator object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">generatorObject</code> <code class="o">=</code> <code class="k">yield</code><code class="p">;</code>
</pre></div>

</div>


<h3 id="sec_formating-generators">
<span class="section-number">21.8 </span>Style consideration: whitespace before and after the asterisk</h3>

<p>Reasonable – and legal – variations of formatting the asterisk are:</p>

<ul>
<li>A space before and after it:<br><code>function * foo(x, y) { ··· }</code>
</li>
  <li>A space before it:<br><code>function *foo(x, y) { ··· }</code>
</li>
  <li>A space after it:<br><code>function* foo(x, y) { ··· }</code>
</li>
  <li>No whitespace before and after it:<br><code>function*foo(x, y) { ··· }</code>
</li>
</ul>
<p>Let’s figure out which of these variations make sense for which constructs and why.</p>

<h4 id="leanpub-auto-generator-function-declarations-and-expressions">
<span class="section-number">21.8.1 </span>Generator function declarations and expressions</h4>

<p>Here, the star is only used because <code>generator</code> (or something similar) isn’t available as a keyword. If it were, then a generator function declaration would look like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">generator</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Instead of <code>generator</code>, ECMAScript 6 marks the <code>function</code> keyword with an asterisk. Thus, <code>function*</code> can be seen as a synonym for <code>generator</code>, which suggests writing generator function declarations as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Anonymous generator function expressions would be formatted like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">const</code> <code class="nx">foo</code> <code class="o">=</code> <code class="kd">function</code><code class="o">*</code> <code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-generator-method-definitions-1">
<span class="section-number">21.8.2 </span>Generator method definitions</h4>

<p>When writing generator method definitions, I recommend to format the asterisk as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="o">*</code> <code class="nx">generatorMethod</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>There are three arguments in favor of writing a space after the asterisk.</p>

<p>First, the asterisk shouldn’t be part of the method name. On one hand, it isn’t part of the name of a generator function. On the other hand, the asterisk is only mentioned when defining a generator, not when using it.</p>

<p>Second, a generator method definition is an abbreviation for the following syntax. (To make my point, I’m redundantly giving the function expression a name, too.)</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">generatorMethod</code><code class="o">:</code> <code class="kd">function</code><code class="o">*</code> <code class="nx">generatorMethod</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>If method definitions are about omitting the <code>function</code> keyword then the asterisk should be followed by a space.</p>

<p>Third, generator method definitions are syntactically similar to getters and setters (which are already available in ECMAScript 5):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">get</code> <code class="nx">foo</code><code class="p">()</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
    <code class="nx">set</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>The keywords <code>get</code> and <code>set</code> can be seen as modifiers of a normal method definition. Arguably, an asterisk is also such a modifier.</p>

<h4 id="leanpub-auto-formatting-recursive-yield">
<span class="section-number">21.8.3 </span>Formatting recursive <code>yield</code>
</h4>

<p>The following is an example of a generator function yielding its own yielded values recursively:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code><code class="o">*</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
    <code class="k">yield</code><code class="o">*</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">x</code> <code class="o">-</code> <code class="mi">1</code><code class="p">);</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The asterisk marks a different kind of <code>yield</code> operator, which is why the above way of writing it makes sense.</p>

<h4 id="leanpub-auto-documenting-generator-functions-and-methods">
<span class="section-number">21.8.4 </span>Documenting generator functions and methods</h4>

<p>Kyle Simpson (@getify) proposed something interesting: Given that we often append parentheses when we write about functions and methods such as <code>Math.max()</code>, wouldn’t it make sense to prepend an asterisk when writing about generator functions and methods? For example: should we write <code>*foo()</code> to refer to the generator function in the previous subsection? Let me argue against that.</p>

<p>When it comes to writing a function that returns an iterable, a generator is only one of the several options. I think it is better to not give away this implementation detail via marked function names.</p>

<p>Furthermore, you don’t use the asterisk when calling a generator function, but you do use parentheses.</p>

<p>Lastly, the asterisk doesn’t provide useful information – <code>yield*</code> can also be used with functions that return an iterable. But it may make sense to mark the names of functions and methods (including generators) that return iterables. For example, via the suffix <code>Iter</code>.</p>


<h3 id="leanpub-auto-conclusion-2">
<span class="section-number">21.9 </span>Conclusion</h3>

<p>I hope that this chapter convinced you that generators are a useful and versatile tool.</p>

<p>I like that generators let you implement cooperatively multitasked tasks that block while making asynchronous function calls. In my opinion that’s the right mental model for async calls. Hopefully, JavaScript goes further in this direction in the future.</p>


<h3 id="leanpub-auto-further-reading-4">
<span class="section-number">21.10 </span>Further reading</h3>

<p>Sources of this chapter:</p>

<p id="ch_generators_ref_1">[1] “<a href="https://github.com/jhusain/asyncgenerator">Async Generator Proposal</a>” by Jafar Husain</p>

<p id="ch_generators_ref_2">[2] “<a href="http://www.dabeaz.com/coroutines/">A Curious Course on Coroutines and Concurrency</a>” by David Beazley</p>

<p id="ch_generators_ref_3">[3] “<a href="http://calculist.org/blog/2011/12/14/why-coroutines-wont-work-on-the-web/">Why coroutines won’t work on the web</a>” by David Herman</p>

<div class="footnotes">
  <ol>
<li id="fn-generators_1">Or rather, the function counts up until the number <code>start</code> overflows and becomes <code>Infinity</code>, at which point it doesn’t change, anymore.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-generators_1" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h1 id="leanpub-auto-standard-library">
<span class="section-number">V </span>Standard library</h1>

<h2 id="leanpub-auto-regular-expressions">
<span class="section-number">22. </span>Regular expressions</h2>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_road.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>This chapter isn’t finished, yet.</p>

    </td>
  </tr></tbody></table>
<p>Until this chapter is ready, I recommend the following blog post:
“<a href="https://mathiasbynens.be/notes/es6-unicode-regex">Unicode-aware regular expressions in ECMAScript 6</a>” by Mathias Bynens</p>

<h2 id="ch_async">
<span class="section-number">23. </span>Asynchronous programming (background)</h2>

<p>This chapter explains foundations of asynchronous programming in JavaScript. It provides background knowledge for <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_promises">the next chapter on ES6 Promises</a>.</p>

<h3 id="leanpub-auto-the-javascript-call-stack">
<span class="section-number">23.1 </span>The JavaScript call stack</h3>

<p>When a function <code>f</code> calls a function <code>g</code>, <code>g</code> needs to know where to return to (inside <code>f</code>) after it is done. This information is usually managed with a stack, the <em>call stack</em>. Let’s look at an example.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">h</code><code class="p">(</code><code class="nx">z</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Print stack trace</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">().</code><code class="nx">stack</code><code class="p">);</code> <code class="c1">// (A)</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">g</code><code class="p">(</code><code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">h</code><code class="p">(</code><code class="nx">y</code> <code class="o">+</code> <code class="mi">1</code><code class="p">);</code> <code class="c1">// (B)</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">f</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">g</code><code class="p">(</code><code class="nx">x</code> <code class="o">+</code> <code class="mi">1</code><code class="p">);</code> <code class="c1">// (C)</code>
<code class="p">}</code>
<code class="nx">f</code><code class="p">(</code><code class="mi">3</code><code class="p">);</code> <code class="c1">// (D)</code>
<code class="k">return</code><code class="p">;</code> <code class="c1">// (E)</code>
</pre></div>

</div>

<p>Initially, when the program above is started, the call stack is empty. After the function call <code>f(3)</code> in line D, the stack has one entry:</p>

<ul>
<li>Location in global scope</li>
</ul>
<p>After the function call <code>g(x + 1)</code> in line C, the stack has two entries:</p>

<ul>
<li>Location in <code>f</code>
</li>
  <li>Location in global scope</li>
</ul>
<p>After the function call <code>h(y + 1)</code> in line B, the stack has three entries:</p>

<ul>
<li>Location in <code>g</code>
</li>
  <li>Location in <code>f</code>
</li>
  <li>Location in global scope</li>
</ul>
<p>The stack trace printed in line A shows you what the call stack looks like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nb">Error</code>
    <code class="nx">at</code> <code class="nx">h</code> <code class="p">(</code><code class="nx">stack_trace</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">2</code><code class="o">:</code><code class="mi">17</code><code class="p">)</code>
    <code class="nx">at</code> <code class="nx">g</code> <code class="p">(</code><code class="nx">stack_trace</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">6</code><code class="o">:</code><code class="mi">5</code><code class="p">)</code>
    <code class="nx">at</code> <code class="nx">f</code> <code class="p">(</code><code class="nx">stack_trace</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">9</code><code class="o">:</code><code class="mi">5</code><code class="p">)</code>
    <code class="nx">at</code> <code class="o">&lt;</code><code class="nx">global</code><code class="o">&gt;</code> <code class="p">(</code><code class="nx">stack_trace</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">11</code><code class="o">:</code><code class="mi">1</code><code class="p">)</code>
</pre></div>

</div>

<p>Next, each of the functions terminates and each time the top entry is removed from the stack. After function <code>f</code> is done, we are back in global scope and the call stack is empty. In line E we return and the stack is empty, which means that the program terminates.</p>

<h3 id="leanpub-auto-the-browser-event-loop">
<span class="section-number">23.2 </span>The browser event loop</h3>

<p>Simplifyingly, each browser tab runs (in) a single process: the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop"><em>event loop</em></a>. This loop executes browser-related things (so-called <em>tasks</em>) that it is fed via a <em>task queue</em>. Examples of tasks are:</p>

<ol class="numeric numeric">
<li>Parsing HTML</li>
  <li>Executing JavaScript code in script elements</li>
  <li>Reacting to user input (mouse clicks, key presses, etc.)</li>
  <li>Processing the result of an asynchronous network request</li>
</ol>
<p>Items 2–4 are tasks that run JavaScript code, via the engine built into the browser. They terminate when the code terminates. Then the next task from the queue can be executed. The following diagram (inspired by <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_async_ref_1">a slide by Philip Roberts [1]</a>) gives an overview of how all these mechanisms are connected.</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/async----event_loop.jpg" alt=""><p class="caption"></p>
</div>

<p>The event loop is surrounded by other processes running in parallel to it (timers, input handling, etc.). These processes communicate with it by adding tasks to its queue.</p>

<h4 id="leanpub-auto-timers">
<span class="section-number">23.2.1 </span>Timers</h4>

<p>Browsers have <a href="https://html.spec.whatwg.org/multipage/webappapis.html#timers">timers</a>. <code>setTimeout()</code> creates a timer, waits until it fires and then adds a task to the queue. It has the signature:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">setTimeout</code><code class="p">(</code><code class="nx">callback</code><code class="p">,</code> <code class="nx">ms</code><code class="p">)</code>
</pre></div>

</div>

<p>After <code>ms</code> milliseconds, <code>callback</code> is added to the task queue. It is important to note that <code>ms</code> only specifies when the callback is <em>added</em>, not when it actually executed. That may happen much later, especially if the event loop is blocked (as demonstrated later in this chapter).</p>

<p><code>setTimeout()</code> with <code>ms</code> set to zero is a commonly used work-around to add something to the task queue right away. However, some browsers do not allow <code>ms</code> to be below a minimum (4 ms in Firefox); they set it <em>to</em> that minimum if it is.</p>

<h4 id="leanpub-auto-displaying-dom-changes">
<span class="section-number">23.2.2 </span>Displaying DOM changes</h4>

<p>For most DOM changes (especially those involving a re-layout), the display isn’t updated right away. “Layout happens off a refresh tick every 16ms” (<a href="https://twitter.com/bz_moz/status/513777809287028736">@bz_moz</a>) and must be given a chance to run via the event loop.</p>

<p>There are ways to coordinate frequent DOM updates with the browser, to avoid clashing with its layout rhythm. Consult the <a href="https://developer.mozilla.org/en/docs/Web/API/window.requestAnimationFrame">documentation</a> on <code>requestAnimationFrame()</code> for details.</p>

<h4 id="leanpub-auto-run-to-completion-semantics">
<span class="section-number">23.2.3 </span>Run-to-completion semantics</h4>

<p>JavaScript has so-called run-to-completion semantics: The current task is always finished before the next task is executed. That means that each task has complete control over all current state and doesn’t have to worry about concurrent modification.</p>

<p>Let’s look at an example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="c1">// (A)</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Second'</code><code class="p">);</code>
<code class="p">},</code> <code class="mi">0</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'First'</code><code class="p">);</code> <code class="c1">// (B)</code>
</pre></div>

</div>

<p>The function starting in line A is added to the task queue immediately, but only executed after the current piece of code is done (in particular line B!). That means that this code’s output will always be:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">First</code>
<code class="nx">Second</code>
</pre></div>

</div>

<h4 id="leanpub-auto-blocking-the-event-loop">
<span class="section-number">23.2.4 </span>Blocking the event loop</h4>

<p>As we have seen, each tab (in some browers, the complete browser) is managed by a single process – both the user interface and all other computations. That means that you can freeze the user interface by performing a long-running computation in that process. The following code demonstrates that.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nt">&lt;a</code> <code class="na">id=</code><code class="s">"block"</code> <code class="na">href=</code><code class="s">""</code><code class="nt">&gt;</code>Block for 5 seconds<code class="nt">&lt;/a&gt;</code>
<code class="nt">&lt;p&gt;</code>
<code class="nt">&lt;button&gt;</code>This is a button<code class="nt">&lt;/button&gt;</code>
<code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"statusMessage"</code><code class="nt">&gt;&lt;/div&gt;</code>
<code class="nt">&lt;script&gt;</code>
    <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'block'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="nx">onClick</code><code class="p">);</code>

    <code class="kd">function</code> <code class="nx">onClick</code><code class="p">(</code><code class="nx">event</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">event</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>

        <code class="nx">setStatusMessage</code><code class="p">(</code><code class="s1">'Blocking...'</code><code class="p">);</code>

        <code class="c1">// Give browser the opportunity to display status message</code>
        <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
            <code class="nx">blockMainThread</code><code class="p">(</code><code class="mi">5000</code><code class="p">);</code>
            <code class="nx">setStatusMessage</code><code class="p">(</code><code class="s1">'Done'</code><code class="p">);</code>
        <code class="p">},</code> <code class="mi">0</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="kd">function</code> <code class="nx">setStatusMessage</code><code class="p">(</code><code class="nx">msg</code><code class="p">)</code> <code class="p">{</code>
        <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'statusMessage'</code><code class="p">).</code><code class="nx">textContent</code> <code class="o">=</code> <code class="nx">msg</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="kd">function</code> <code class="nx">blockMainThread</code><code class="p">(</code><code class="nx">milliseconds</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">start</code> <code class="o">=</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">();</code>
        <code class="k">while</code> <code class="p">((</code><code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">()</code> <code class="o">-</code> <code class="nx">start</code><code class="p">)</code> <code class="o">&lt;</code> <code class="nx">milliseconds</code><code class="p">);</code>
    <code class="p">}</code>
<code class="nt">&lt;/script&gt;</code>
</pre></div>

</div>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>You can try out the code <a href="http://rauschma.github.io/async-examples/blocking.html">online</a>.</p>

    </td>
  </tr></tbody></table>
<p>Whenever the link at the beginning is clicked, the function <code>onClick()</code> is triggered. It uses the – synchronous – <code>sleep()</code> function to block the event loop for five seconds. During those seconds, the user interface doesn’t work. For example, you can’t click the “Simple button”.</p>

<h4 id="leanpub-auto-avoiding-blocking">
<span class="section-number">23.2.5 </span>Avoiding blocking</h4>

<p>You avoid blocking the event loop in two ways:</p>

<p>First, you don’t perform long-running computations in the main process, you move them to a different process. This can be achieved via the <a href="https://developer.mozilla.org/en/docs/Web/API/Worker">Worker API</a>.</p>

<p>Second, you don’t (synchronously) wait for the results of a long-running computation (your own algorithm in a Worker process, a network request, etc.), you carry on with the event loop and let the computation notify you when it is finished. In fact, you usually don’t even have a choice in browsers and have to do things this way. For example, there is no built-in way to sleep synchronously (like the previously implemented <code>sleep()</code>). Instead, <code>setTimeout()</code> lets you sleep asynchronously.</p>

<p>The next section explains techniques for waiting asynchronously for results.</p>

<h3 id="leanpub-auto-receiving-results-asynchronously">
<span class="section-number">23.3 </span>Receiving results asynchronously</h3>

<p>Two common patterns for receiving results asynchronously are: events and callbacks.</p>

<h4 id="leanpub-auto-asynchronous-results-via-events">
<span class="section-number">23.3.1 </span>Asynchronous results via events</h4>

<p>In this pattern for asynchronously receiving results, you create an object for each request and register event handlers with it: one for a successful computation, another one for handling errors. The following code shows how that works with the <code>XMLHttpRequest</code> API:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">req</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">XMLHttpRequest</code><code class="p">();</code>
<code class="nx">req</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'GET'</code><code class="p">,</code> <code class="nx">url</code><code class="p">);</code>

<code class="nx">req</code><code class="p">.</code><code class="nx">onload</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">status</code> <code class="o">==</code> <code class="mi">200</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">processData</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">response</code><code class="p">);</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'ERROR'</code><code class="p">,</code> <code class="nx">req</code><code class="p">.</code><code class="nx">statusText</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">};</code>

<code class="nx">req</code><code class="p">.</code><code class="nx">onerror</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Network Error'</code><code class="p">);</code>
<code class="p">};</code>

<code class="nx">req</code><code class="p">.</code><code class="nx">send</code><code class="p">();</code> <code class="c1">// Add request to task queue</code>
</pre></div>

</div>

<p>Note that the last line doesn’t actually perform the request, it adds it to the task queue. Therefore, you could also call that method right after <code>open()</code>, before setting up <code>onload</code> and <code>onerror</code>. Things would work the same, due to JavaScript’s run-to-completion semantics.</p>

<h5 id="leanpub-auto-implicit-requests">
<span class="section-number">23.3.1.1 </span>Implicit requests</h5>

<p>The browser API IndexedDB has a slightly peculiar style of event handling:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">openRequest</code> <code class="o">=</code> <code class="nx">indexedDB</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'test'</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

<code class="nx">openRequest</code><code class="p">.</code><code class="nx">onsuccess</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">event</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Success!'</code><code class="p">);</code>
    <code class="kd">var</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>
<code class="p">};</code>

<code class="nx">openRequest</code><code class="p">.</code><code class="nx">onerror</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="p">};</code>
</pre></div>

</div>

<p>You first create a request object, to which you add event listeners that are notified of results. However, you don’t need to explicitly queue the request, that is done by <code>open()</code>. It is executed after the current task is finished. That is why you can (and in fact must) register event handlers <em>after</em> calling <code>open()</code>.</p>

<p>If you are used to multi-threaded programming languages, this style of handling requests probably looks strange, as if it may be prone to race conditions. But, due to run to completion, things are always safe.</p>

<h5 id="leanpub-auto-events-dont-work-well-for-single-results">
<span class="section-number">23.3.1.2 </span>Events don’t work well for single results</h5>

<p>This style of handling asynchronously computed results is OK if you receive results multiple times. If, however, there is only a single result then the verbosity becomes a problem. For that use case, callbacks have become popular.</p>

<h4 id="leanpub-auto-asynchronous-results-via-callbacks">
<span class="section-number">23.3.2 </span>Asynchronous results via callbacks</h4>

<p>If you handle asynchronous results via callbacks, you pass callback functions as trailing parameters to asynchronous function or method calls.</p>

<p>The following is an example in Node.js. We read the contents of a text file via an asynchronous call to <code>fs.readFile()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Node.js</code>
<code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="s1">'myfile.txt'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">encoding</code><code class="o">:</code> <code class="s1">'utf8'</code> <code class="p">},</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">text</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// (A)</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
            <code class="c1">// ...</code>
        <code class="p">}</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">text</code><code class="p">);</code>
    <code class="p">});</code>
</pre></div>

</div>

<p>If <code>readFile()</code> is successful, the callback in line A receives a result via the parameter <code>text</code>. If it isn’t, the callback gets an error (often an instance of <code>Error</code> or a sub-constructor) via its first parameter.</p>

<p>The same code in classic functional programming style would look like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Functional</code>
<code class="nx">readFileFunctional</code><code class="p">(</code><code class="s1">'myfile.txt'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">encoding</code><code class="o">:</code> <code class="s1">'utf8'</code> <code class="p">},</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">text</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// success</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">text</code><code class="p">);</code>
    <code class="p">},</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// failure</code>
        <code class="c1">// ...</code>
    <code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-continuation-passing-style">
<span class="section-number">23.3.3 </span>Continuation-passing style</h4>

<p>The programming style of using callbacks (especially in the functional manner shown previously) is also called <em>continuation-passing style</em> (CPS), because the next step (the <em>continuation</em>) is explicitly passed as a parameter. This gives an invoked function more control over what happens next and when.</p>

<p>The following code illustrates CPS:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'A'</code><code class="p">);</code>
<code class="nx">identity</code><code class="p">(</code><code class="s1">'B'</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">step2</code><code class="p">(</code><code class="nx">result2</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result2</code><code class="p">);</code>
    <code class="nx">identity</code><code class="p">(</code><code class="s1">'C'</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">step3</code><code class="p">(</code><code class="nx">result3</code><code class="p">)</code> <code class="p">{</code>
       <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result3</code><code class="p">);</code>
    <code class="p">});</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'D'</code><code class="p">);</code>
<code class="p">});</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'E'</code><code class="p">);</code>

<code class="c1">// Output: A E B D C</code>

<code class="kd">function</code> <code class="nx">identity</code><code class="p">(</code><code class="nx">input</code><code class="p">,</code> <code class="nx">callback</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
        <code class="nx">callback</code><code class="p">(</code><code class="nx">input</code><code class="p">);</code>
    <code class="p">},</code> <code class="mi">0</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>For each step, the control flow of the program continues inside the callback. This leads to nested functions, which are sometimes referred to as <em>callback hell</em>. However, you can often avoid nesting, because JavaScript’s function declarations are <em>hoisted</em> (their definitions are evaluated at the beginning of their scope). That means that you can call ahead and invoke functions defined later in the program. The following code uses hoisting to flatten the previous example.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'A'</code><code class="p">);</code>
<code class="nx">identity</code><code class="p">(</code><code class="s1">'B'</code><code class="p">,</code> <code class="nx">step2</code><code class="p">);</code>
<code class="kd">function</code> <code class="nx">step2</code><code class="p">(</code><code class="nx">result2</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// The program continues here</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result2</code><code class="p">);</code>
    <code class="nx">identity</code><code class="p">(</code><code class="s1">'C'</code><code class="p">,</code> <code class="nx">step3</code><code class="p">);</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'D'</code><code class="p">);</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">step3</code><code class="p">(</code><code class="nx">result3</code><code class="p">)</code> <code class="p">{</code>
   <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">result3</code><code class="p">);</code>
<code class="p">}</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'E'</code><code class="p">);</code>
</pre></div>

</div>

<p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_async_ref_3">More information on CPS is given in [3]</a>.</p>

<h4 id="leanpub-auto-composing-code-in-cps">
<span class="section-number">23.3.4 </span>Composing code in CPS</h4>

<p>In normal JavaScript style, you compose pieces of code via:</p>

<ol class="numeric numeric">
<li>Putting them one after another. This is blindingly obvious, but it’s good to remind ourselves that concatenating code in normal style is sequential composition.</li>
  <li>Array methods such as <code>map()</code>, <code>filter()</code> and <code>forEach()</code>
</li>
  <li>Loops such as <code>for</code> and <code>while</code>
</li>
</ol>
<p>The library <a href="https://github.com/caolan/async">Async.js</a> provides combinators to let you do similar things in CPS, with Node.js-style callbacks. It is used in the following example to load the contents of three files, whose names are stored in an Array.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">var</code> <code class="nx">async</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'async'</code><code class="p">);</code>

<code class="kd">var</code> <code class="nx">fileNames</code> <code class="o">=</code> <code class="p">[</code> <code class="s1">'foo.txt'</code><code class="p">,</code> <code class="s1">'bar.txt'</code><code class="p">,</code> <code class="s1">'baz.txt'</code> <code class="p">];</code>
<code class="nx">async</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">fileNames</code><code class="p">,</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">fileName</code><code class="p">,</code> <code class="nx">callback</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="nx">fileName</code><code class="p">,</code> <code class="p">{</code> <code class="nx">encoding</code><code class="o">:</code> <code class="s1">'utf8'</code> <code class="p">},</code> <code class="nx">callback</code><code class="p">);</code>
    <code class="p">},</code>
    <code class="c1">// Process the result</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">textArray</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
            <code class="k">return</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'TEXTS:\n'</code> <code class="o">+</code> <code class="nx">textArray</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s1">'\n----\n'</code><code class="p">));</code>
    <code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-pros-and-cons-of-callbacks">
<span class="section-number">23.3.5 </span>Pros and cons of callbacks</h4>

<p>Using callbacks results in a radically different programming style, CPS. The main advantage of CPS is that its basic mechanisms are easy to understand. But there are also disadvantages:</p>

<ul>
<li>Error handling becomes more complicated: There are now two ways in which errors are reported – via callbacks and via exceptions. You have to be careful to combine both properly.</li>
  <li>Less elegant signatures: In synchronous functions, there is a clear separation of concerns between input (parameters) and output (function result). In asynchronous functions that use callbacks, these concerns are mixed: the function result doesn’t matter and some parameters are used for input, others for output.</li>
  <li>Composition is more complicated: Because the concern “output” shows up in the parameters, it is more complicated to compose code via combinators.</li>
</ul>
<p>Callbacks in Node.js style have three disadvantages (compared to those in a functional style):</p>

<ul>
<li>The <code>if</code> statement for error handling adds verbosity.</li>
  <li>Reusing error handlers is harder.</li>
  <li>Providing a default error handler is also harder. A default error handler is useful if you make a function call and don’t want to write your own handler. It could also be used by a function if a caller doesn’t specify a handler.</li>
</ul>
<h3 id="leanpub-auto-looking-ahead">
<span class="section-number">23.4 </span>Looking ahead</h3>

<p>The next chapter covers Promises and the ES6 Promise API. Promises are more complicated under the hood than callbacks. In exchange, they bring several significant advantages and eliminate most of the aforementioned cons of callbacks.</p>

<h3 id="leanpub-auto-further-reading-5">
<span class="section-number">23.5 </span>Further reading</h3>

<p id="ch_async_ref_1">[1] “<a href="http://vimeo.com/96425312">Help, I’m stuck in an event-loop</a>” by Philip Roberts (video).</p>

<p id="ch_async_ref_2">[2] “<a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loops">Event loops</a>” in the HTML Specification.</p>

<p id="ch_async_ref_3">[3] “<a href="http://www.2ality.com/2012/06/continuation-passing-style.html">Asynchronous programming and continuation-passing style in JavaScript</a>” by Axel Rauschmayer.</p>

<h2 id="ch_promises">
<span class="section-number">24. </span>Promises for asynchronous programming</h2>

<p>This chapter is an introduction to asynchronous programming via Promises in general and the ECMAScript 6 Promise API in particular. <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_async">The previous chapter</a> explains the foundations of asynchronous programming in JavaScript. You can consult it whenever there is something that you don’t understand in this chapter.</p>

<h3 id="leanpub-auto-overview-14">
<span class="section-number">24.1 </span>Overview</h3>

<p>The following function returns a result asynchronously, via a Promise:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">asyncFunc</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Promise</code><code class="p">(</code>
        <code class="kd">function</code> <code class="p">(</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">resolve</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code> <code class="c1">// success</code>
            <code class="err">···</code>
            <code class="nx">reject</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code> <code class="c1">// failure</code>
        <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</div>

<p>You call <code>asyncFunc()</code> as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">asyncFunc</code><code class="p">()</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">value</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="cm">/* success */</code> <code class="p">})</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">error</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="cm">/* failure */</code> <code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-handling-arrays-of-promises">
<span class="section-number">24.1.1 </span>Handling Arrays of Promises</h4>

<p><code>Promise.all()</code> lets you react to an Array of Promises.</p>

<p>For example, you can create an Array of Promises via the Array method <code>map()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">fileUrls</code> <code class="o">=</code> <code class="p">[</code>
    <code class="s1">'http://example.com/file1.txt'</code><code class="p">,</code>
    <code class="s1">'http://example.com/file2.txt'</code>
<code class="p">];</code>
<code class="kd">let</code> <code class="nx">promisedTexts</code> <code class="o">=</code> <code class="nx">fileUrls</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">httpGet</code><code class="p">);</code> <code class="c1">// Array of Promises</code>
</pre></div>

</div>

<p>If you apply <code>Promise.all()</code> to that Array, you receive an Array of values once all Promises are fulfilled:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="nx">promisedTexts</code><code class="p">)</code>
<code class="c1">// Success</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">texts</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">text</code> <code class="nx">of</code> <code class="nx">texts</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">text</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">})</code>
<code class="c1">// Failure</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">reason</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// Receives first rejection among `promisedTexts`</code>
<code class="p">});</code>
</pre></div>

</div>

<h3 id="leanpub-auto-promises-1">
<span class="section-number">24.2 </span>Promises</h3>

<p>Promises are a pattern that helps with one particular kind of asynchronous programming: a function (or method) that returns its result asynchronously. To implement such a function, you return a <em>Promise</em>, an object that is a placeholder for the result. The caller of the function registers callbacks with the Promise to be notified once the result has been computed. The function sends the result via the Promise.</p>

<p>The de-facto standard for JavaScript Promises is called <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_promises_ref_1">Promises/A+</a> [1]. The ECMAScript 6 Promise API follows that standard.</p>

<h3 id="leanpub-auto-a-first-example">
<span class="section-number">24.3 </span>A first example</h3>

<p>Let’s look at a first example, to give you a taste of what working with Promises is like.</p>

<p>With Node.js-style callbacks, reading a file asynchronously looks like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="s1">'config.json'</code><code class="p">,</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">text</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error while reading config file'</code><code class="p">);</code>
        <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
            <code class="k">try</code> <code class="p">{</code>
                <code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">text</code><code class="p">);</code>
                <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">4</code><code class="p">));</code>
            <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Invalid JSON in file'</code><code class="p">);</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">});</code>
</pre></div>

</div>

<p>With Promises, the same functionality is implemented like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">readFilePromisified</code><code class="p">(</code><code class="s1">'config.json'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">text</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// (A)</code>
    <code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">text</code><code class="p">);</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">4</code><code class="p">));</code>
<code class="p">})</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// (B)</code>
    <code class="c1">// File read error or JSON SyntaxError</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'An error occurred'</code><code class="p">,</code> <code class="nx">reason</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<p>There are still callbacks, but they are provided via methods that are invoked on the result (<code>then()</code> and <code>catch()</code>). The error callback in line B is convenient in two ways: First, it’s a single style of handling errors (versus <code>if (error)</code> and <code>try-catch</code> in the previous example). Second, you can handle the errors of both <code>readFilePromisified()</code> and the callback in line A from a single location.</p>

<p>The code of <code>readFilePromisified()</code> is <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#readFilePromisified">shown later</a>.</p>

<h3 id="leanpub-auto-creating-and-using-promises">
<span class="section-number">24.4 </span>Creating and using Promises</h3>

<p>Let’s look at how Promises are operated from the producer and the consumer side.</p>

<h4 id="leanpub-auto-producing-a-promise">
<span class="section-number">24.4.1 </span>Producing a Promise</h4>

<p>As a producer, you create a Promise and send a result via it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">promise</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Promise</code><code class="p">(</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// (A)</code>
        <code class="err">···</code>
        <code class="k">if</code> <code class="p">(</code><code class="err">···</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">resolve</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code> <code class="c1">// success</code>
        <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
            <code class="nx">reject</code><code class="p">(</code><code class="nx">reason</code><code class="p">);</code> <code class="c1">// failure</code>
        <code class="p">}</code>
    <code class="p">});</code>
</pre></div>

</div>

<p>A Promise is always in either one of three (mutually exclusive) states:</p>

<ul>
<li>Pending: the result hasn’t been computed, yet</li>
  <li>Fulfilled: the result was computed successfully</li>
  <li>Rejected: a failure occurred during computation</li>
</ul>
<p>A Promise is <em>settled</em> (the computation it represents has finished) if it is either fulfilled or rejected. A Promise can only be settled once and then stays settled. Subsequent attempts to settle it have no effect.</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----promise_states_simple.jpg" alt=""><p class="caption"></p>
</div>

<p>The parameter of <code>new Promise()</code> (starting in line A) is called an <em>executor</em>:</p>

<ul>
<li>If the computation went well, the executor sends the result via <code>resolve()</code>. That usually fulfills the Promise (it may not, if you resolve with a Promise, as explained later).</li>
  <li>If an error happened, the executor notifies the Promise consumer via <code>reject()</code>. That always rejects the Promise.</li>
</ul>
<h4 id="leanpub-auto-consuming-a-promise">
<span class="section-number">24.4.2 </span>Consuming a Promise</h4>

<p>As a consumer of <code>promise</code>, you are notified of a fulfillment or a rejection via <em>reactions</em> – callbacks that you register with the method <code>then()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">promise</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code> <code class="cm">/* fulfillment */</code> <code class="p">},</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code> <code class="cm">/* rejection */</code> <code class="p">}</code>
<code class="p">);</code>
</pre></div>

</div>

<p>What makes Promises so useful for asynchronous functions (with one-off results) is that once a Promise is settled, it doesn’t change anymore. Furthermore, there are never any race conditions, because it doesn’t matter whether you invoke <code>then()</code> before or after a Promise is settled:</p>

<ul>
<li>Reactions that are registered with a Promise before it is settled, are notified of the settlement once it happens.</li>
  <li>Reactions that are registered with a Promise after it is settled, receive the cached settled value “immediately” (their invocations are queued as tasks).</li>
</ul>
<h4 id="leanpub-auto-only-handling-fulfillments-or-rejections">
<span class="section-number">24.4.3 </span>Only handling fulfillments or rejections</h4>

<p>If you are only interested in fulfillments, you can omit the second parameter of <code>then()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">promise</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code> <code class="cm">/* fulfillment */</code> <code class="p">}</code>
<code class="p">);</code>
</pre></div>

</div>

<p>If you are only interested in rejections, you can omit the first parameter. The method <code>catch()</code> is a more compact way of doing the same thing.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">promise</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code>
    <code class="kc">null</code><code class="p">,</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code> <code class="cm">/* rejection */</code> <code class="p">}</code>
<code class="p">);</code>

<code class="c1">// Equivalent:</code>
<code class="nx">promise</code><code class="p">.</code><code class="k">catch</code><code class="p">(</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code> <code class="cm">/* rejection */</code> <code class="p">}</code>
<code class="p">);</code>
</pre></div>

</div>

<p>It is recommended to use <code>then()</code> exclusively for fulfillments and <code>catch()</code> for errors, because it nicely labels callbacks and because you can handle the rejections of multiple Promises at the same time (details are explained later).</p>

<h3 id="leanpub-auto-examples">
<span class="section-number">24.5 </span>Examples</h3>

<p>Before we dig deeper into Promises, let’s use what we have learned so far in a few examples.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>Some of the examples in this section are available in the GitHub repository <a href="https://github.com/rauschma/promise-examples"><code>promise-examples</code></a>.</p>

    </td>
  </tr></tbody></table>
<h4 id="readFilePromisified">
<span class="section-number">24.5.1 </span>Example: promisifying <code>fs.readFile()</code>
</h4>

<p>The following code is a Promise-based version of the built-in Node.js function <a href="https://nodejs.org/api/fs.html#fs_fs_readfile_filename_options_callback"><code>fs.readFile()</code></a>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">import</code> <code class="p">{</code><code class="nx">readFile</code><code class="p">}</code> <code class="nx">from</code> <code class="s1">'fs'</code><code class="p">;</code>

<code class="kd">function</code> <code class="nx">readFilePromisified</code><code class="p">(</code><code class="nx">filename</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Promise</code><code class="p">(</code>
        <code class="kd">function</code> <code class="p">(</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">readFile</code><code class="p">(</code><code class="nx">filename</code><code class="p">,</code> <code class="p">{</code> <code class="nx">encoding</code><code class="o">:</code> <code class="s1">'utf8'</code> <code class="p">},</code>
                <code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
                    <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
                        <code class="nx">reject</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
                    <code class="p">}</code>
                    <code class="nx">resolve</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
                <code class="p">});</code>
        <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>readFilePromisified()</code> is used like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">readFilePromisified</code><code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">argv</code><code class="p">[</code><code class="mi">2</code><code class="p">])</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">text</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">text</code><code class="p">);</code>
<code class="p">})</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">error</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-example-promisifying-xmlhttprequest">
<span class="section-number">24.5.2 </span>Example: promisifying XMLHttpRequest</h4>

<p>The following is a Promise-based function that performs an HTTP GET via the event-based <a href="https://xhr.spec.whatwg.org/">XMLHttpRequest</a> API:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">httpGet</code><code class="p">(</code><code class="nx">url</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Promise</code><code class="p">(</code>
        <code class="kd">function</code> <code class="p">(</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">request</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">XMLHttpRequest</code><code class="p">();</code>
            <code class="nx">request</code><code class="p">.</code><code class="nx">onreadystatechange</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">status</code> <code class="o">===</code> <code class="mi">200</code><code class="p">)</code> <code class="p">{</code>
                    <code class="c1">// Success</code>
                    <code class="nx">resolve</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">response</code><code class="p">);</code>
                <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                    <code class="c1">// Something went wrong (404 etc.)</code>
                    <code class="nx">reject</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">statusText</code><code class="p">));</code>
                <code class="p">}</code>
            <code class="p">}</code>
            <code class="nx">request</code><code class="p">.</code><code class="nx">onerror</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
                <code class="nx">reject</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code>
                    <code class="s1">'XMLHttpRequest Error: '</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">statusText</code><code class="p">));</code>
            <code class="p">};</code>
            <code class="nx">request</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'GET'</code><code class="p">,</code> <code class="nx">url</code><code class="p">);</code>
            <code class="nx">request</code><code class="p">.</code><code class="nx">send</code><code class="p">();</code>
        <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This is how you use <code>httpGet()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">httpGet</code><code class="p">(</code><code class="s1">'http://example.com/file.txt'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Contents: '</code> <code class="o">+</code> <code class="nx">value</code><code class="p">);</code>
    <code class="p">},</code>
    <code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Something went wrong'</code><code class="p">,</code> <code class="nx">reason</code><code class="p">);</code>
    <code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-example-delaying-an-activity">
<span class="section-number">24.5.3 </span>Example: delaying an activity</h4>

<p>Let’s implement <code>setTimeout()</code> as the Promise-based function <code>delay()</code> (similar to <a href="https://github.com/kriskowal/q/wiki/API-Reference#qdelayms"><code>Q.delay()</code></a>).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">delay</code><code class="p">(</code><code class="nx">ms</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Promise</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">setTimeout</code><code class="p">(</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">ms</code><code class="p">);</code> <code class="c1">// (A)</code>
    <code class="p">});</code>
<code class="p">}</code>

<code class="c1">// Using delay():</code>
<code class="nx">delay</code><code class="p">(</code><code class="mi">5000</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="c1">// (B)</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'5 seconds have passed!'</code><code class="p">)</code>
<code class="p">});</code>
</pre></div>

</div>

<p>Note that in line A, we are calling <code>resolve</code> with zero parameters, which is the same as calling <code>resolve(undefined)</code>. We don’t need the fulfillment value in line B, either and simply ignore it. Just being notified is enough here.</p>

<h4 id="leanpub-auto-example-timing-out-a-promise">
<span class="section-number">24.5.4 </span>Example: timing out a Promise</h4>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">timeout</code><code class="p">(</code><code class="nx">ms</code><code class="p">,</code> <code class="nx">promise</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Promise</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">promise</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">resolve</code><code class="p">);</code>
        <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
            <code class="nx">reject</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Timeout after '</code><code class="o">+</code><code class="nx">ms</code><code class="o">+</code><code class="s1">' ms'</code><code class="p">));</code> <code class="c1">// (A)</code>
        <code class="p">},</code> <code class="nx">ms</code><code class="p">);</code>
    <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Note that the rejection after the timeout (in line A) does not cancel the request, but it does prevent the Promise being fulfilled with its result.</p>

<p>Using <code>timeout()</code> looks like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">timeout</code><code class="p">(</code><code class="mi">5000</code><code class="p">,</code> <code class="nx">httpGet</code><code class="p">(</code><code class="s1">'http://example.com/file.txt'</code><code class="p">))</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Contents: '</code> <code class="o">+</code> <code class="nx">value</code><code class="p">);</code>
<code class="p">})</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error or timeout'</code><code class="p">,</code> <code class="nx">reason</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<h3 id="leanpub-auto-chaining-promises">
<span class="section-number">24.6 </span>Chaining Promises</h3>

<p>Now we are ready to dig deeper into the features of Promises. Let’s first explore how you can chain Promises.</p>

<p>The result of the method call:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">P</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">onFulfilled</code><code class="p">,</code> <code class="nx">onRejected</code><code class="p">)</code>
</pre></div>

</div>

<p>is a new Promise Q. That means that you can keep the Promise-based control flow going by invoking <code>then()</code> on Q:</p>

<ul>
<li>Q is resolved with what is returned by either <code>onFulfilled</code> or <code>onRejected</code>.</li>
  <li>Q is rejected if either <code>onFulfilled</code> or <code>onRejected</code> throw an exception.</li>
</ul>
<h4 id="leanpub-auto-resolving-q-with-normal-values">
<span class="section-number">24.6.1 </span>Resolving Q with normal values</h4>

<p>If you resolve the Promise Q returned by <code>then()</code> with a normal value, you can pick up that value via a subsequent <code>then()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">asyncFunc</code><code class="p">()</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value1</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="mi">123</code><code class="p">;</code>
<code class="p">})</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value2</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">value2</code><code class="p">);</code> <code class="c1">// 123</code>
<code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-resolving-q-with-thenables">
<span class="section-number">24.6.2 </span>Resolving Q with thenables</h4>

<p>You can also resolve the Promise Q returned by <code>then()</code> with a <em>thenable</em> R. A thenable is any object that has a Promise-style method <code>then()</code>. Thus, Promises are thenable. Resolving with R (e.g. by returning it from <code>onFulfilled</code>) means that it is inserted “after” Q: R’s settlement is forwarded to Q’s <code>onFulfilled</code> and <code>onRejected</code> callbacks. In a way, Q becomes R.</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----resolve_with_thenable.jpg" alt=""><p class="caption"></p>
</div>

<p>The main use for this mechanism is to flatten nested <code>then()</code> calls, like in the following example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">asyncFunc1</code><code class="p">()</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value1</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">asyncFunc2</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value2</code><code class="p">)</code> <code class="p">{</code>
        <code class="err">···</code>
    <code class="p">});</code>
<code class="p">})</code>
</pre></div>

</div>

<p>The flat version looks like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">asyncFunc1</code><code class="p">()</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value1</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">asyncFunc2</code><code class="p">();</code>
<code class="p">})</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value2</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">})</code>
</pre></div>

</div>

<h4 id="leanpub-auto-resolving-q-from-onrejected">
<span class="section-number">24.6.3 </span>Resolving Q from <code>onRejected</code>
</h4>

<p>Whatever you return in an error handler becomes a fulfillment value (not rejection value!). That allows you to specify default values that are used in case of failure:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">retrieveFileName</code><code class="p">()</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="c1">// Something went wrong, use a default value</code>
    <code class="k">return</code> <code class="s1">'Untitled.txt'</code><code class="p">;</code>
<code class="p">})</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">fileName</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-rejecting-q-by-throwing-exceptions">
<span class="section-number">24.6.4 </span>Rejecting Q by throwing exceptions</h4>

<p>Exceptions that are thrown in either one of <code>then</code>’s parameters are passed on to the next error handler:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">asyncFunc</code><code class="p">()</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
<code class="p">})</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Handle error here</code>
<code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-exceptions-in-executors">
<span class="section-number">24.6.5 </span>Exceptions in executors</h4>

<p>An exception thrown inside an executor (the callback of <code>new Promise()</code>) is passed to the error handler of the Promise managed by that executor:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">new</code> <code class="nx">Promise</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
<code class="p">})</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Handle error here</code>
<code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-chaining-errors">
<span class="section-number">24.6.6 </span>Chaining errors</h4>

<p>There can be one or more <code>then()</code> method calls that don’t have an error handler. Then the error is passed on until there is an error handler.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">asyncFunc1</code><code class="p">()</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">asyncFunc2</code><code class="p">)</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">asyncFunc3</code><code class="p">)</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Something went wrong above</code>
<code class="p">});</code>
</pre></div>

</div>

<h3 id="leanpub-auto-composition">
<span class="section-number">24.7 </span>Composition</h3>

<p>This section describes how you can compose existing Promises to create new ones. We have already encountered one way of composing Promises: sequential chaining via <code>then()</code>. <code>Promise.all()</code> and <code>Promise.race()</code> provide additional ways of composing.</p>

<h4 id="leanpub-auto-map-via-promiseall">
<span class="section-number">24.7.1 </span><code>map()</code> via <code>Promise.all()</code>
</h4>

<p>One nice thing about Promises is that many synchronous tools still work, because Promise-based functions return results. For example, you can use the Array method <code>map()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">fileUrls</code> <code class="o">=</code> <code class="p">[</code>
    <code class="s1">'http://example.com/file1.txt'</code><code class="p">,</code>
    <code class="s1">'http://example.com/file2.txt'</code>
<code class="p">];</code>
<code class="kd">let</code> <code class="nx">promisedTexts</code> <code class="o">=</code> <code class="nx">fileUrls</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">httpGet</code><code class="p">);</code>
</pre></div>

</div>

<p><code>promisedTexts</code> is an Array of Promises. <code>Promise.all()</code> takes an Array of Promises (thenables and other values are converted to Promises via <code>Promise.resolve()</code>) and, once all of them are fulfilled, it fulfills with an Array of their values:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="nx">promisedTexts</code><code class="p">)</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">texts</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">text</code> <code class="nx">of</code> <code class="nx">texts</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">text</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">})</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">reason</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// Receives first rejection among the Promises</code>
<code class="p">});</code>
</pre></div>

</div>

<h4 id="leanpub-auto-timing-out-via-promiserace">
<span class="section-number">24.7.2 </span>Timing out via <code>Promise.race()</code>
</h4>

<p><code>Promise.race()</code> takes an Array of Promises (thenables and other values are converted to Promises via <code>Promise.resolve()</code>) and returns a Promise P. The first of the input Promises that is settled passes its settlement on to the output Promise.</p>

<p>As an example, let’s use <code>Promise.race()</code> to implement a timeout:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Promise</code><code class="p">.</code><code class="nx">race</code><code class="p">([</code>
    <code class="nx">httpGet</code><code class="p">(</code><code class="s1">'http://example.com/file.txt'</code><code class="p">),</code>
    <code class="nx">delay</code><code class="p">(</code><code class="mi">5000</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Timed out'</code><code class="p">)</code>
    <code class="p">});</code>
<code class="p">])</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">text</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">})</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">});</code>
</pre></div>

</div>

<h3 id="leanpub-auto-promises-are-always-async">
<span class="section-number">24.8 </span>Promises are always async</h3>

<p>A Promise library has complete control over whether results are delivered to Promise reactions synchronously (right away) or asynchronously (after the current continuation, the current piece of code, is finished). However, the Promises/A+ specification demands that the latter mode of execution be always used. It states so via the following <a href="http://promisesaplus.com/#point-34">requirement</a> (2.2.4) for the <code>then()</code> method:</p>

<blockquote>
  <p><code>onFulfilled</code> or <code>onRejected</code> must not be called until the execution context stack contains only platform code.</p>
</blockquote>

<p>That means that you code can rely on run-to-completion semantics (as explained in part 1) and that chaining Promises won’t starve other tasks of processing time.</p>

<h3 id="leanpub-auto-cheat-sheet-the-ecmascript-6-promise-api">
<span class="section-number">24.9 </span>Cheat sheet: the ECMAScript 6 Promise API</h3>

<p>This section gives an overview of the ECMAScript 6 Promise API, as described in the <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-promise-objects">specification</a>.</p>

<h4 id="leanpub-auto-glossary-promises">
<span class="section-number">24.9.1 </span>Glossary: Promises</h4>

<p>The Promise API is about delivering results asynchronously. A <em>Promise object</em> (short: Promise) is a stand-in for the result, which is delivered via that object.</p>

<p>States:</p>

<ul>
<li>A Promise is always in either one of three mutually exclusive states:
    <ul>
<li>Before the result is ready, the Promise is <em>pending</em>.</li>
      <li>If a result is available, the Promise is <em>fulfilled</em>.</li>
      <li>If an error happened, the Promise is <em>rejected</em>.</li>
    </ul>
</li>
  <li>A Promise is <em>settled</em> if “things are done” (if it is either fulfilled or rejected).</li>
  <li>A Promise is settled exactly once and then remains unchanged.</li>
</ul>
<p>Reacting to state changes:</p>

<ul>
<li>
<em>Promise reactions</em> are callbacks that you register with the Promise method <code>then()</code>, to be notified of a fulfillment or a rejection.</li>
  <li>A <em>thenable</em> is an object that has a Promise-style <code>then()</code> method. Whenever the API is only interested in being notified of settlements, it only demands thenables.</li>
</ul>
<p>Changing states: There are two operations for changing the state of a Promise. After you have invoked either one of them once, further invocations have no effect.</p>

<ul>
<li>
<em>Rejecting</em> a Promise means that the Promise becomes rejected.</li>
  <li>
<em>Resolving</em> a Promise has different effects, depending on what value you are resolving with:
    <ul>
<li>Resolving with a normal (non-thenable) value fulfills the Promise.</li>
      <li>Resolving a Promise P with a thenable T means that P can’t be resolved anymore and will now follow T’s state, including its fulfillment or rejection value. The appropriate P reactions will get called once T settles (or are called immediately if T is already settled).</li>
    </ul>
</li>
</ul>
<h4 id="leanpub-auto-promise-constructor">
<span class="section-number">24.9.2 </span><code>Promise</code> constructor</h4>

<p>The constructor for Promises is invoked as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">p</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Promise</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">});</code>
</pre></div>

</div>

<p>The callback of this constructor is called an <em>executor</em>. The executor can use its parameters to resolve or reject the new Promise <code>p</code>:</p>

<ul>
<li>
<code>resolve(x)</code> resolves <code>p</code> with <code>x</code>:
    <ul>
<li>If <code>x</code> is thenable, its settlement is forwarded to <code>p</code> (which includes triggering reactions registered via <code>then()</code>).</li>
      <li>Otherwise, <code>p</code> is fulfilled with <code>x</code>.</li>
    </ul>
</li>
  <li>
<code>reject(e)</code> rejects <code>p</code> with the value <code>e</code> (often an instance of <a href="http://speakingjs.com/es5/ch14.html#error_constructors"><code>Error</code></a>).</li>
</ul>
<h4 id="leanpub-auto-static-promise-methods">
<span class="section-number">24.9.3 </span>Static <code>Promise</code> methods</h4>

<p>All static methods of <code>Promise</code> support subclassing:</p>

<ul>
<li>They create new Promise instances via the so-called <em>species pattern</em> (which is explained in detail in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_species-pattern">the chapter on classes</a>):
    <ul>
<li>The default is to use the receiver (<code>this</code>) as the constructor.</li>
      <li>That default can be overridden via the property <code>[Symbol.species]</code> in subclasses.</li>
    </ul>
</li>
  <li>Other static methods are also accessed via the species pattern (not via <code>Promise</code> or via <code>this</code>).</li>
</ul>
<h5 id="leanpub-auto-creating-promises">
<span class="section-number">24.9.3.1 </span>Creating Promises</h5>

<p>The following two static methods create new instances of their receivers:</p>

<ul>
<li>
<code>Promise.resolve(x)</code>: converts arbitrary values to Promises, with an awareness of thenables and Promises.
    <ul>
<li>If <code>x</code> is thenable, it is converted to a Promise – an instance of the receiver (<code>this</code>; the species pattern is not used here).</li>
      <li>If <code>x</code> is already an instance of the receiver, it is returned unchanged.</li>
      <li>Otherwise, return a new instance of the receiver that is fulfilled with <code>x</code>.</li>
    </ul>
</li>
  <li>
<code>Promise.reject(reason)</code>: creates a new instance of the receiver (as configured via the species pattern) that is rejected with the value <code>reason</code>.</li>
</ul>
<h5 id="leanpub-auto-composing-promises">
<span class="section-number">24.9.3.2 </span>Composing Promises</h5>

<p>Intuitively, the static methods <code>Promise.all()</code> and <code>Promise.race()</code> compose iterables of Promises to a single Promise. That is:</p>

<ul>
<li>They take an iterable. The elements of the iterable are converted to Promises via <code>this.resolve()</code><sup id="fnref-promises_1"><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fn-promises_1" rel="footnote">1</a></sup>.</li>
  <li>They return a new Promise. That Promise is a new instance of the receiver (as configured via the species pattern).</li>
</ul>
<p>The methods are:</p>

<ul>
<li>
<code>Promise.all(iterable)</code>: returns a Promise that…
    <ul>
<li>is fulfilled if all elements in <code>iterable</code> are fulfilled.<br>
  Fulfillment value: Array with fulfillment values.</li>
      <li>is rejected if any of the elements are rejected.<br>
  Rejection value: first rejection value.</li>
    </ul>
</li>
  <li>
<code>Promise.race(iterable)</code>: the first element of <code>iterable</code> that is settled is used to settle the returned Promise.</li>
</ul>
<h4 id="leanpub-auto-promiseprototype-methods">
<span class="section-number">24.9.4 </span><code>Promise.prototype</code> methods</h4>

<h5 id="leanpub-auto-promiseprototypethenonfulfilled-onrejected">
<span class="section-number">24.9.4.1 </span><code>Promise.prototype.then(onFulfilled, onRejected)</code>
</h5>

<ul>
<li>The callbacks <code>onFulfilled</code> and <code>onRejected</code> are called <em>reactions</em>.</li>
  <li>
<code>onFulfilled</code> is called immediately if the Promise is already fulfilled or as soon as it becomes fulfilled. Similarly, <code>onRejected</code> is informed of rejections.</li>
  <li>
<code>then()</code> returns a new Promise Q (created via the the species of the constructor of the receiver):
    <ul>
<li>If either of the reactions returns a value, Q is resolved with it.</li>
      <li>If either of the reactions throws an exception, Q is rejected with it.</li>
    </ul>
</li>
  <li>Omitted reactions:
    <ul>
<li>If <code>onFulfilled</code> has been omitted, a fulfillment of the receiver is forwarded to the result of <code>then()</code>.</li>
      <li>If <code>onRejected</code> has been omitted, a rejection of the receiver is forwarded to the result of <code>then()</code>.</li>
    </ul>
</li>
</ul>
<p>Default values for omitted reactions could be implemented like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">defaultOnFulfilled</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">x</code><code class="p">;</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">defaultOnRejected</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">throw</code> <code class="nx">e</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-promiseprototypecatchonrejected">
<span class="section-number">24.9.4.2 </span><code>Promise.prototype.catch(onRejected)</code>
</h5>

<ul>
<li>
<code>p.catch(onRejected)</code> is the same as <code>p.then(null, onRejected)</code>.</li>
</ul>
<h3 id="leanpub-auto-pros-and-cons-of-promises">
<span class="section-number">24.10 </span>Pros and cons of Promises</h3>

<h4 id="leanpub-auto-the-pros">
<span class="section-number">24.10.1 </span>The pros</h4>

<h5 id="leanpub-auto-unifying-asynchronous-apis">
<span class="section-number">24.10.1.1 </span>Unifying asynchronous APIs</h5>

<p>One important advantage of Promises is that they will increasingly be used by asnychronous browser APIs and unify currently diverse and incompatible patterns and conventions. Let’s look at two upcoming Promise-based APIs.</p>

<p>The fetch API is a Promise-based alternative to XMLHttpRequest:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">fetch</code><code class="p">(</code><code class="nx">url</code><code class="p">)</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">request</code> <code class="o">=&gt;</code> <code class="nx">request</code><code class="p">.</code><code class="nx">text</code><code class="p">())</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">str</code> <code class="o">=&gt;</code> <code class="err">···</code><code class="p">)</code>
</pre></div>

</div>

<p><code>fetch()</code> returns a Promise for the actual request, <code>text()</code> returns a Promise for the content as a string.</p>

<p>The <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_module-loader-api">ECMAScript 6 API for programmatically importing modules</a> is based on Promises, too:</p>

<div class="code-block">
<div class="highlight"><pre> <code class="nx">System</code><code class="p">.</code><code class="kr">import</code><code class="p">(</code><code class="s1">'some_module.js'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">some_module</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">})</code>
</pre></div>

</div>

<h5 id="leanpub-auto-promises-versus-events">
<span class="section-number">24.10.1.2 </span>Promises versus events</h5>

<p>Compared to events, Promises are better for handling one-off results. It doesn’t matter whether you register for a result before or after it has been computed, you will get it. This advantage of Promises is fundamental in nature. On the flip side, you can’t use them for handling recurring events. Chaining is another advantage of Promises, but one that could be added to event handling.</p>

<h5 id="leanpub-auto-promises-versus-callbacks">
<span class="section-number">24.10.1.3 </span>Promises versus callbacks</h5>

<p>Compared to callbacks, Promises have cleaner function (or method) signatures. With callbacks, parameters are used for input and output:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="nx">name</code><code class="p">,</code> <code class="nx">opts</code><code class="o">?</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">string</code> <code class="o">|</code> <code class="nx">Buffer</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="k">void</code><code class="p">)</code>
</pre></div>

</div>

<p>With Promises, all parameters are used for input:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">readFilePromisified</code><code class="p">(</code><code class="nx">name</code><code class="p">,</code> <code class="nx">opts</code><code class="o">?</code><code class="p">)</code> <code class="o">:</code> <code class="nx">Promise</code><code class="o">&lt;</code><code class="nx">string</code> <code class="o">|</code> <code class="nx">Buffer</code><code class="o">&gt;</code>
</pre></div>

</div>

<p>Additional Promise advantages include better error handling (which integrates exceptions) and easier composition (because you can reuse some synchronous tools such as <code>Array.prototype.map()</code>).</p>

<h4 id="leanpub-auto-the-cons">
<span class="section-number">24.10.2 </span>The cons</h4>

<p>Promises work well for for single asynchronous results. They are not suited for:</p>

<ul>
<li>Recurring events: If you are interested in those, take a look at <a href="http://reactive-extensions.github.io/RxJS/">reactive programming</a>, which add a clever way of chaining to normal event handling.</li>
  <li>Streams of data: A <a href="https://streams.spec.whatwg.org/">standard</a> for supporting those is currently in development.</li>
</ul>
<p>ECMAScript 6 Promises lack two features that are sometimes useful:</p>

<ul>
<li>You can’t cancel them.</li>
  <li>You can’t query them for how far along they are (e.g. to display a progress bar in a client-side user interface).</li>
</ul>
<p>The Q Promise library has <a href="https://github.com/kriskowal/q#progress-notification">support</a> for the latter and there are <a href="https://github.com/promises-aplus">plans</a> to add both capabilities to Promises/A+.</p>

<h3 id="leanpub-auto-promises-and-generators">
<span class="section-number">24.11 </span>Promises and generators</h3>

<p>In the following code, I use <a href="https://github.com/tj/co">the control flow library co</a> to asynchronously retrieve two JSON files. Note how, in line A, execution blocks (waits) until the result of <code>Promise.all()</code> is ready. That means that the code looks synchronous while performing asynchronous operations.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">co</code><code class="p">(</code><code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="p">[</code><code class="nx">croftStr</code><code class="p">,</code> <code class="nx">bondStr</code><code class="p">]</code> <code class="o">=</code> <code class="k">yield</code> <code class="nx">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">([</code>  <code class="c1">// (A)</code>
            <code class="nx">getFile</code><code class="p">(</code><code class="s1">'http://localhost:8000/croft.json'</code><code class="p">),</code>
            <code class="nx">getFile</code><code class="p">(</code><code class="s1">'http://localhost:8000/bond.json'</code><code class="p">),</code>
        <code class="p">]);</code>
        <code class="kd">let</code> <code class="nx">croftJson</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">croftStr</code><code class="p">);</code>
        <code class="kd">let</code> <code class="nx">bondJson</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">bondStr</code><code class="p">);</code>

        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">croftJson</code><code class="p">);</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">bondJson</code><code class="p">);</code>
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Failure to read: '</code> <code class="o">+</code> <code class="nx">e</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>Details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_co-library">the chapter on generators</a>.</p>

<h3 id="sec_debugging-promises">
<span class="section-number">24.12 </span>Debugging Promises</h3>

<p>Tools for debugging Promises are slowly appearing in browsers. Let’s take a quick look at what the latest version of Google Chrome has to offer. The following is part of an HTML file that demonstrates two common problems with Promises:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nt">&lt;body&gt;</code>
    <code class="nt">&lt;script&gt;</code>
        <code class="c1">// Unhandled rejection</code>
        <code class="nx">Promise</code><code class="p">.</code><code class="nx">reject</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">())</code>
        <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s1">'a'</code><code class="p">})</code>
        <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">x</code><code class="p">)</code> <code class="p">{</code> <code class="k">return</code> <code class="s1">'b'</code><code class="p">})</code>

        <code class="c1">// Unsettled Promise</code>
        <code class="k">new</code> <code class="nx">Promise</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{});</code>
    <code class="nt">&lt;/script&gt;</code>
<code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>First, a rejection isn’t handled. Second, a Promise isn’t settled. Chrome’s dev tools help with both problems.</p>

<p>Unhandled rejections are logged in the console:</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----chrome_console.png" alt=""><p class="caption"></p>
</div>

<p>They are also highlighted in the “Sources” inspector:</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----chrome_sources.png" alt=""><p class="caption"></p>
</div>

<p>Lastly, there is a special inspector for Promises that logs all Promises that are created by a web page. Among other things, it records:</p>

<ul>
<li>Which Promises are fulfilled (green bullet in first column), rejected (red bullet) and pending (gray bullet)</li>
  <li>How Promises are chained</li>
</ul>
<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----chrome_promises.png" alt=""><p class="caption"></p>
</div>

<h3 id="leanpub-auto-the-internals-of-promises">
<span class="section-number">24.13 </span>The internals of Promises</h3>

<p>In this section, we will approach Promises from a different angle: Instead of learning how to use the API, we will look at a simple implementation of it. This different angle helped me greatly with making sense of Promises.</p>

<p>The Promise implementation is called <code>DemoPromise</code>. In order to be easier to understand, it doesn’t completely match the API. But it is close enough to still give you much insight into the challenges that actual implementations are facing.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_github-alt.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p><code>DemoPromise</code> is available on GitHub, in the repository <a href="https://github.com/rauschma/demo_promise"><code>demo_promise</code></a>.</p>

    </td>
  </tr></tbody></table>
<p><code>DemoPromise</code> is a class with three prototype methods:</p>

<ul>
<li><code>DemoPromise.prototype.resolve(value)</code></li>
  <li><code>DemoPromise.prototype.reject(reason)</code></li>
  <li><code>DemoPromise.prototype.then(onFulfilled, onRejected)</code></li>
</ul>
<p>That is, <code>resolve</code> and <code>reject</code> are methods (versus functions handed to a callback parameter of the constructor).</p>

<h4 id="leanpub-auto-a-stand-alone-promise">
<span class="section-number">24.13.1 </span>A stand-alone Promise</h4>

<p>Our first implementation is a stand-alone Promise with minimal functionality:</p>

<ul>
<li>You can create a Promise.</li>
  <li>You can resolve or reject a Promise and you can only do it once.</li>
  <li>You can register <em>reactions</em> (callbacks) via <code>then()</code>. It must work independently of whether the Promise has already been settled or not.
    <ul>
<li>This method does not support chaining, yet – it does not return anything.</li>
    </ul>
</li>
</ul>
<p>This is how this first implementation is used:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">dp</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">DemoPromise</code><code class="p">();</code>
<code class="nx">dp</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code><code class="s1">'abc'</code><code class="p">);</code>
<code class="nx">dp</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code> <code class="c1">// abc</code>
<code class="p">});</code>
</pre></div>

</div>

<p>The following diagram illustrates how our first <code>DemoPromise</code> works:</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----promise1_simple.jpg" alt=""><p class="caption"></p>
</div>

<h5 id="leanpub-auto-demopromiseprototypethen">
<span class="section-number">24.13.1.1 </span><code>DemoPromise.prototype.then()</code>
</h5>

<p>Let’s examine <code>then()</code> first. It has to handle two cases:</p>

<ul>
<li>If the Promise is still pending, it queues invocations of <code>onFulfilled</code> and <code>onRejected</code>, to be used when the Promise is settled.</li>
  <li>If the Promise is already fulfilled or rejected, <code>onFulfilled</code> or <code>onRejected</code> can be invoked right away.</li>
</ul>
<div class="code-block">
<div class="highlight"><pre><code class="nx">then</code><code class="p">(</code><code class="nx">onFulfilled</code><code class="p">,</code> <code class="nx">onRejected</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">self</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code>
    <code class="kd">let</code> <code class="nx">fulfilledTask</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
        <code class="nx">onFulfilled</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">promiseResult</code><code class="p">);</code>
    <code class="p">};</code>
    <code class="kd">let</code> <code class="nx">rejectedTask</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
        <code class="nx">onRejected</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">promiseResult</code><code class="p">);</code>
    <code class="p">};</code>
    <code class="k">switch</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">promiseState</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">case</code> <code class="s1">'pending'</code><code class="o">:</code>
            <code class="k">this</code><code class="p">.</code><code class="nx">fulfillReactions</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">fulfilledTask</code><code class="p">);</code>
            <code class="k">this</code><code class="p">.</code><code class="nx">rejectReactions</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">rejectedTask</code><code class="p">);</code>
            <code class="k">break</code><code class="p">;</code>
        <code class="k">case</code> <code class="s1">'fulfilled'</code><code class="o">:</code>
            <code class="nx">addToTaskQueue</code><code class="p">(</code><code class="nx">fulfilledTask</code><code class="p">);</code>
            <code class="k">break</code><code class="p">;</code>
        <code class="k">case</code> <code class="s1">'rejected'</code><code class="o">:</code>
            <code class="nx">addToTaskQueue</code><code class="p">(</code><code class="nx">rejectedTask</code><code class="p">);</code>
            <code class="k">break</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The previous code snippet uses the following helper function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">addToTaskQueue</code><code class="p">(</code><code class="nx">task</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">setTimeout</code><code class="p">(</code><code class="nx">task</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-demopromiseprototyperesolve">
<span class="section-number">24.13.1.2 </span><code>DemoPromise.prototype.resolve()</code>
</h5>

<p><code>resolve()</code> works as follows: If the Promise is already settled, it does nothing (ensuring that a Promise can only be settled once). Otherwise, the state of the Promise changes to <code>'fulfilled'</code> and the result is cached in <code>this.promiseResult</code>. Next, all fulfillment reactions, that have been enqueued so far, are be triggered.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">resolve</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">promiseState</code> <code class="o">!==</code> <code class="s1">'pending'</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">promiseState</code> <code class="o">=</code> <code class="s1">'fulfilled'</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">promiseResult</code> <code class="o">=</code> <code class="nx">value</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">_clearAndEnqueueReactions</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">fulfillReactions</code><code class="p">);</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">;</code> <code class="c1">// enable chaining</code>
<code class="p">}</code>
<code class="nx">_clearAndEnqueueReactions</code><code class="p">(</code><code class="nx">reactions</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">fulfillReactions</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">rejectReactions</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">;</code>
    <code class="nx">reactions</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">addToTaskQueue</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>reject()</code> is similar to <code>resolve()</code>.</p>

<h4 id="leanpub-auto-chaining">
<span class="section-number">24.13.2 </span>Chaining</h4>

<p>The next feature we implement is chaining:</p>

<ul>
<li>
<code>then()</code> returns a Promise that is resolved with what either <code>onFulfilled</code> or <code>onRejected</code> return.</li>
  <li>If <code>onFulfilled</code> or <code>onRejected</code> are missing, whatever they would have received is passed on to the Promise returned by <code>then()</code>.</li>
</ul>
<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----promise2_chaining.jpg" alt=""><p class="caption"></p>
</div>

<p>Obviously, only <code>then()</code> changes:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">then</code><code class="p">(</code><code class="nx">onFulfilled</code><code class="p">,</code> <code class="nx">onRejected</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">returnValue</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Promise</code><code class="p">();</code> <code class="c1">// (A)</code>
    <code class="kd">let</code> <code class="nx">self</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code>

    <code class="kd">let</code> <code class="nx">fulfilledTask</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">onFulfilled</code> <code class="o">===</code> <code class="s1">'function'</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">fulfilledTask</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">r</code> <code class="o">=</code> <code class="nx">onFulfilled</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">promiseResult</code><code class="p">);</code>
            <code class="nx">returnValue</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code><code class="nx">r</code><code class="p">);</code> <code class="c1">// (B)</code>
        <code class="p">};</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
        <code class="nx">fulfilledTask</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
            <code class="nx">returnValue</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">promiseResult</code><code class="p">);</code> <code class="c1">// (C)</code>
        <code class="p">};</code>
    <code class="p">}</code>

    <code class="kd">let</code> <code class="nx">rejectedTask</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">onRejected</code> <code class="o">===</code> <code class="s1">'function'</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">rejectedTask</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">r</code> <code class="o">=</code> <code class="nx">onRejected</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">promiseResult</code><code class="p">);</code>
            <code class="nx">returnValue</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code><code class="nx">r</code><code class="p">);</code> <code class="c1">// (D)</code>
        <code class="p">};</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
        <code class="nx">rejectedTask</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
            <code class="c1">// `onRejected` has not been provided</code>
            <code class="c1">// =&gt; we must pass on the rejection</code>
            <code class="nx">returnValue</code><code class="p">.</code><code class="nx">reject</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">promiseResult</code><code class="p">);</code> <code class="c1">// (E)</code>
        <code class="p">};</code>
    <code class="p">}</code>
    <code class="err">···</code>
    <code class="k">return</code> <code class="nx">returnValue</code><code class="p">;</code> <code class="c1">// (F)</code>
<code class="p">}</code>
</pre></div>

</div>

<p><code>then()</code> creates and returns a new Promise (lines A and F). Additionally, <code>fulfilledTask</code> and <code>rejectedTask</code> are set up differently: After a settlement…</p>

<ul>
<li>The result of <code>onFulfilled</code> is used to resolve <code>returnValue</code> (line B).
    <ul>
<li>If <code>onFulfilled</code> is missing, we use the fulfillment value to resolve <code>returnValue</code> (line C).</li>
    </ul>
</li>
  <li>The result of <code>onRejected</code> is used to resolve (not reject!) <code>returnValue</code> (line D).
    <ul>
<li>If <code>onRejected</code> is missing, we use pass on the rejection value to <code>returnValue</code> (line E).</li>
    </ul>
</li>
</ul>
<h4 id="leanpub-auto-flattening">
<span class="section-number">24.13.3 </span>Flattening</h4>

<p>Flattening is mostly about making chaining more convenient: Normally, returning a value from a reaction passes it on to the next <code>then()</code>. If we return a Promise, it would be nice if it could be “unwrapped” for us, like in the following example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">asyncFunc1</code><code class="p">()</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value1</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">asyncFunc2</code><code class="p">();</code> <code class="c1">// (A)</code>
<code class="p">})</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value2</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// value2 is fulfillment value of asyncFunc2() Promise</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">value2</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<p>We returned a Promise in line A and didn’t have to nest a call to <code>then()</code> inside the current method, we could invoke <code>then()</code> on the method’s result. Thus: no nested <code>then()</code>, everything remains flat.</p>

<p>We implement this by letting the <code>resolve()</code> method do the flattening:</p>

<ul>
<li>Resolving a Promise P with a Promise Q means that Q’s settlement is forwarded to P’s reactions.</li>
  <li>P becomes “locked in” on Q: it can’t be resolved (incl. rejected), anymore. And its state and result are always the same as Q’s.</li>
</ul>
<p>We can make flattening more generic if we allow Q to be a thenable (instead of only a Promise).</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----promise3_flattening.jpg" alt=""><p class="caption"></p>
</div>

<p>To implement locking-in, we introduce a new boolean flag <code>this.alreadyResolved</code>. Once it is true, <code>this</code> is locked and can’t be resolved anymore. Note that <code>this</code> may still be pending, because its state is now the same as the Promise it is locked in on.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">resolve</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">alreadyResolved</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">alreadyResolved</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">_doResolve</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">;</code> <code class="c1">// enable chaining</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The actual resolution now happens in the private method <code>_doResolve()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">_doResolve</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">self</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code>
    <code class="c1">// Is `value` a thenable?</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">value</code> <code class="o">===</code> <code class="s1">'object'</code> <code class="o">&amp;&amp;</code> <code class="nx">value</code> <code class="o">!==</code> <code class="kc">null</code> <code class="o">&amp;&amp;</code> <code class="s1">'then'</code> <code class="k">in</code> <code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// Forward fulfillments and rejections from `value` to `this`.</code>
        <code class="c1">// Added as a task (vs. done immediately) to preserve async semantics.</code>
        <code class="nx">addToTaskQueue</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code> <code class="c1">// (A)</code>
            <code class="nx">value</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code>
                <code class="kd">function</code> <code class="nx">onFulfilled</code><code class="p">(</code><code class="nx">result</code><code class="p">)</code> <code class="p">{</code>
                    <code class="nx">self</code><code class="p">.</code><code class="nx">_doResolve</code><code class="p">(</code><code class="nx">result</code><code class="p">);</code>
                <code class="p">},</code>
                <code class="kd">function</code> <code class="nx">onRejected</code><code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
                    <code class="nx">self</code><code class="p">.</code><code class="nx">_doReject</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
                <code class="p">});</code>
        <code class="p">});</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">promiseState</code> <code class="o">=</code> <code class="s1">'fulfilled'</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">promiseResult</code> <code class="o">=</code> <code class="nx">value</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">_clearAndEnqueueReactions</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">fulfillReactions</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The flattening is performed in line A: If <code>value</code> is fulfilled, we want <code>self</code> to be fulfilled and if <code>value</code> is rejected, we want <code>self</code> to be rejected. The forwarding happens via the private methods <code>_doResolve</code> and <code>_doReject</code>, to get around the protection via <code>alreadyResolved</code>.</p>

<h4 id="leanpub-auto-promise-states-in-more-detail">
<span class="section-number">24.13.4 </span>Promise states in more detail</h4>

<p>With chaining, the states of Promises become more complex (as covered by <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-promise-objects">Sect. 25.4</a> of the ECMAScript 6 specification):</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----promise_states_all.jpg" alt=""><p class="caption"></p>
</div>

<p>If you are only <em>using</em> Promises, you can normally adopt a simplified worldview and ignore locking-in. The most important state-related concept remains “settledness”: a Promise is settled if it is either fulfilled or rejected. After a Promise is settled, it doesn’t change, anymore (state and fulfillment or rejection value).</p>

<p>If you want to <em>implement</em> Promises then “resolving” matters, too and is now harder to understand:</p>

<ul>
<li>Intuitively, “resolved” means “can’t be (directly) resolved anymore”. A Promise is resolved if it is either settled or locked in. Quoting the spec: “An unresolved Promise is always in the pending state. A resolved Promise may be pending, fulfilled or rejected.”</li>
  <li>Resolving does not necessarily lead to settling: you can resolve a Promise with another one that is always pending.</li>
  <li>Resolving now includes rejecting (i.e., it is more general): you can reject a Promise by resolving it with a rejected Promise.</li>
</ul>
<h4 id="leanpub-auto-exceptions">
<span class="section-number">24.13.5 </span>Exceptions</h4>

<p>As our final feature, we’d like our Promises to handle exceptions in user code as rejections. For now, “user code” means the two callback parameters of <code>then()</code>.</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----promise4_exceptions.jpg" alt=""><p class="caption"></p>
</div>

<p>The following excerpt shows how we turn exceptions inside <code>onFulfilled</code> into rejections – by wrapping a <code>try-catch</code> around its invocation in line A.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">then</code><code class="p">(</code><code class="nx">onFulfilled</code><code class="p">,</code> <code class="nx">onRejected</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
    <code class="kd">let</code> <code class="nx">fulfilledTask</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">onFulfilled</code> <code class="o">===</code> <code class="s1">'function'</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">fulfilledTask</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
            <code class="k">try</code> <code class="p">{</code>
                <code class="kd">let</code> <code class="nx">r</code> <code class="o">=</code> <code class="nx">onFulfilled</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">promiseResult</code><code class="p">);</code> <code class="c1">// (A)</code>
                <code class="nx">returnValue</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code><code class="nx">r</code><code class="p">);</code>
            <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">returnValue</code><code class="p">.</code><code class="nx">reject</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>
            <code class="p">}</code>
        <code class="p">};</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
        <code class="nx">fulfilledTask</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
            <code class="nx">returnValue</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">promiseResult</code><code class="p">);</code>
        <code class="p">};</code>
    <code class="p">}</code>
    <code class="err">···</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-revealing-constructor-pattern">
<span class="section-number">24.13.6 </span>Revealing constructor pattern</h4>

<p>If we wanted to turn <code>DemoPromise</code> into an actual Promise implementation, we’d still need to implement <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_promises_ref_5">the revealing constructor pattern [5]</a>: ES6 Promises are not resolved and rejected via methods, but via functions that are handed to the <em>executor</em>, the callback parameter of the constructor.</p>

<div class="image-with-caption center image-with-caption center">
  <img src="./Read Exploring ES6 _ Leanpub_files/promises----promise5_everything.jpg" alt=""><p class="caption"></p>
</div>

<p>If the executor throws an exception then “its” Promise must be rejected.</p>

<h3 id="leanpub-auto-two-useful-additional-promise-methods">
<span class="section-number">24.14 </span>Two useful additional Promise methods</h3>

<p>This section describes two useful methods that are easy to add to ES6 Promises. Many of the more comprehensive Promise libraries have them.</p>

<h4 id="leanpub-auto-done">
<span class="section-number">24.14.1 </span><code>done()</code>
</h4>

<p>When you chain several Promise method calls, you risk silently discarding errors. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">doSomething</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">asyncFunc</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">f1</code><code class="p">)</code>
    <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">r1</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">f2</code><code class="p">);</code> <code class="c1">// (A)</code>
<code class="p">}</code>
</pre></div>

</div>

<p>If <code>then()</code> in line A produces a rejection, it will never be handled anywhere. The Promise library Q provides a method <code>done()</code>, to be used as the last element in a chain of method calls. It either replaces the last <code>then()</code> (and has one to two arguments):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">doSomething</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">asyncFunc</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">f1</code><code class="p">)</code>
    <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">r1</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="nx">f2</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Or it is inserted after the last <code>then()</code> (and has zero arguments):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">doSomething</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">asyncFunc</code><code class="p">()</code>
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">f1</code><code class="p">)</code>
    <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">r1</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">f2</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">done</code><code class="p">();</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Quoting the <a href="https://github.com/kriskowal/q/wiki/API-Reference#promisedoneonfulfilled-onrejected-onprogress">Q documentation</a>:</p>

<blockquote>
  <p>The Golden Rule of <code>done</code> vs. <code>then</code> usage is: either return your promise to someone else, or if the chain ends with you, call <code>done</code> to terminate it. Terminating with <code>catch</code> is not sufficient because the catch handler may itself throw an error.</p>
</blockquote>

<p>This is how you would implement <code>done()</code> in ECMAScript 6:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Promise</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">done</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">onFulfilled</code><code class="p">,</code> <code class="nx">onRejected</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">onFulfilled</code><code class="p">,</code> <code class="nx">onRejected</code><code class="p">)</code>
    <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// Throw an exception globally</code>
        <code class="nx">setTimeout</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="k">throw</code> <code class="nx">reason</code> <code class="p">},</code> <code class="mi">0</code><code class="p">);</code>
    <code class="p">});</code>
<code class="p">};</code>
</pre></div>

</div>

<p>While <code>done</code>’s functionality is clearly useful, it has not been added to ECMAScript 6, because this kind of check can be performed automatically by engines (as we have seen in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_debugging-promises">the section on debugging Promises</a>).</p>

<h4 id="leanpub-auto-finally">
<span class="section-number">24.14.2 </span><code>finally()</code>
</h4>

<p>Sometimes you want to perform an action independently of whether an error happened or not. For example, to clean up after you are done with a resource. That’s what the Promise method <code>finally()</code> is for, which works much like the <code>finally</code> clause in exception handling. Its callback receives no arguments, but is notified of either a resolution or a rejection.</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">createResource</code><code class="p">(</code><code class="err">···</code><code class="p">)</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value1</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Use resource</code>
<code class="p">})</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">value2</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Use resource</code>
<code class="p">})</code>
<code class="p">.</code><code class="k">finally</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="c1">// Clean up</code>
<code class="p">});</code>
</pre></div>

</div>

<p>This is how <code>Domenic Denicola</code> <a href="https://github.com/domenic/promises-unwrapping/issues/18">proposes</a> to implement <code>finally()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Promise</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="k">finally</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">callback</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">P</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">constructor</code><code class="p">;</code>
    <code class="c1">// We don’t invoke the callback in here,</code>
    <code class="c1">// because we want then() to handle its exceptions</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code>
        <code class="c1">// Callback fulfills =&gt; continue with receiver’s fulfillment or rejection</code>
        <code class="c1">// Callback rejects =&gt; pass on that rejection (then() has no 2nd paramet\</code>
<code class="nx">er</code><code class="o">!</code><code class="p">)</code>
        <code class="nx">value</code>  <code class="o">=&gt;</code> <code class="nx">P</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code><code class="nx">callback</code><code class="p">()).</code><code class="nx">then</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">value</code><code class="p">),</code>
        <code class="nx">reason</code> <code class="o">=&gt;</code> <code class="nx">P</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code><code class="nx">callback</code><code class="p">()).</code><code class="nx">then</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="k">throw</code> <code class="nx">reason</code> <code class="p">})</code>
    <code class="p">);</code>
<code class="p">};</code>
</pre></div>

</div>

<p>The callback determines how the settlement of the receiver (<code>this</code>) is handled:</p>

<ul>
<li>If the callback throws an exception or returns a rejected Promise then that becomes/contributes the rejection value.</li>
  <li>Otherwise, the settlement (fulfillment or rejection) of the receiver becomes the settlement of the Promise returned by <code>finally()</code>. In a way, we take <code>finally()</code> out of the chain of methods.</li>
</ul>
<p><strong>Example 1</strong> (by <a href="https://gist.github.com/jakearchibald/785f79b0dea5bfe0c448">Jake Archibald</a>): using <code>finally()</code> to hide a spinner. Simplified version:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">showSpinner</code><code class="p">();</code>
<code class="nx">fetchGalleryData</code><code class="p">()</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">data</code> <code class="o">=&gt;</code> <code class="nx">updateGallery</code><code class="p">(</code><code class="nx">data</code><code class="p">))</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">showNoDataError</code><code class="p">)</code>
<code class="p">.</code><code class="k">finally</code><code class="p">(</code><code class="nx">hideSpinner</code><code class="p">);</code>
</pre></div>

</div>

<p><strong>Example 2</strong> (by <a href="https://github.com/domenic/promises-unwrapping/issues/18#issuecomment-27707922">Kris Kowal</a>): using <code>finally()</code> to tear down a test.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">HTTP</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s2">"q-io/http"</code><code class="p">);</code>
<code class="kd">let</code> <code class="nx">server</code> <code class="o">=</code> <code class="nx">HTTP</code><code class="p">.</code><code class="nx">Server</code><code class="p">(</code><code class="nx">app</code><code class="p">);</code>
<code class="k">return</code> <code class="nx">server</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="c1">// run test</code>
<code class="p">})</code>
<code class="p">.</code><code class="k">finally</code><code class="p">(</code><code class="nx">server</code><code class="p">.</code><code class="nx">stop</code><code class="p">);</code>
</pre></div>

</div>

<h3 id="leanpub-auto-es6-compatible-promise-libraries">
<span class="section-number">24.15 </span>ES6-compatible Promise libraries</h3>

<p>There are many Promise libraries out there. The following ones conform to the ECMAScript 6 API, which means that you can use them now and easily migrate to native ES6 later.</p>

<ul>
<li>“<a href="https://github.com/tildeio/rsvp.js/">RSVP.js</a>” by Stefan Penner is a superset of the ES6 Promise API.
    <ul>
<li>“<a href="https://github.com/jakearchibald/es6-promise">ES6-Promises</a>” by Jake Archibald extracts just the ES6 API out of RSVP.js.</li>
    </ul>
</li>
  <li>“<a href="https://github.com/getify/native-promise-only">Native Promise Only (NPO)</a>” by Kyle Simpson is “a polyfill for native ES6 promises, as close as possible (no extensions) to the strict spec definitions”.</li>
  <li>“<a href="https://github.com/calvinmetcalf/lie">Lie</a>” by Calvin Metcalf is “a small, performant, promise library implementing the Promises/A+ spec”.</li>
  <li>
<a href="https://github.com/kriskowal/q#using-qpromise"><code>Q.Promise</code></a> by Kris Kowal implements the ES6 API.</li>
  <li>Lastly, the “<a href="https://github.com/paulmillr/es6-shim">ES6 Shim</a>” by Paul Millr includes <code>Promise</code>.</li>
</ul>
<h3 id="leanpub-auto-interfacing-with-legacy-asynchronous-code">
<span class="section-number">24.16 </span>Interfacing with legacy asynchronous code</h3>

<p>When you are using a Promise library, you sometimes need to use non-Promise-based asynchronous code. This section explains how to do that for Node.js-style asynchronous functions and jQuery deferreds.</p>

<h4 id="leanpub-auto-interfacing-with-nodejs">
<span class="section-number">24.16.1 </span>Interfacing with Node.js</h4>

<p>The Promise library Q has <a href="https://github.com/kriskowal/q/wiki/API-Reference#interfacing-with-nodejs-callbacks">several tool functions</a> for converting functions that use Node.js-style <code>(err,result)</code> callbacks to ones that return a Promise (there are even functions that do the opposite – convert Promise-based functions to ones that accept callbacks). For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">readFile</code> <code class="o">=</code> <code class="nx">Q</code><code class="p">.</code><code class="nx">denodeify</code><code class="p">(</code><code class="nx">FS</code><code class="p">.</code><code class="nx">readFile</code><code class="p">);</code>

<code class="nx">readFile</code><code class="p">(</code><code class="s1">'foo.txt'</code><code class="p">,</code> <code class="s1">'utf-8'</code><code class="p">)</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">text</code><code class="p">)</code> <code class="p">{</code>
    <code class="err">···</code>
<code class="p">});</code>
</pre></div>

</div>

<p><a href="https://github.com/matthew-andrews/denodeify/">denodify</a> is a micro-library that only provides the “denodification” functionality and complies with the ECMAScript 6 Promise API.</p>

<h4 id="leanpub-auto-interfacing-with-jquery">
<span class="section-number">24.16.2 </span>Interfacing with jQuery</h4>

<p>jQuery has <a href="http://api.jquery.com/category/deferred-object/">deferreds</a> which are similar to Promises, but have <a href="https://github.com/kriskowal/q/wiki/Coming-from-jQuery">several differences</a> that prevent compatibility. Their method <code>then()</code> is almost like that of ES6 Promises (main difference: it doesn’t catch errors in reactions). Thus, we can convert a jQuery deferred to an ES6 Promise via <code>Promise.resolve()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Promise</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code>
    <code class="nx">jQuery</code><code class="p">.</code><code class="nx">ajax</code><code class="p">({</code>
        <code class="nx">url</code><code class="o">:</code> <code class="s1">'somefile.html'</code><code class="p">,</code>
        <code class="nx">type</code><code class="o">:</code> <code class="s1">'GET'</code>
    <code class="p">}))</code>
<code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
<code class="p">})</code>
<code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">reason</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">reason</code><code class="p">);</code>
<code class="p">});</code>
</pre></div>

</div>

<h3 id="leanpub-auto-further-reading-6">
<span class="section-number">24.17 </span>Further reading</h3>

<p id="ch_promises_ref_1">[1] “<a href="http://promisesaplus.com/">Promises/A+</a>”, edited by Brian Cavalier and Domenic Denicola (the de-facto standard for JavaScript Promises)</p>

<p id="ch_promises_ref_2">[2] “<a href="http://www.html5rocks.com/en/tutorials/es6/promises/">JavaScript Promises: There and back again</a>” by Jake Archibald (good general intro to Promises)</p>

<p id="ch_promises_ref_3">[3] “<a href="http://taoofcode.net/promise-anti-patterns/">Promise Anti-Patterns</a>” by Tao of Code (tips and techniques)</p>

<p id="ch_promises_ref_4">[4] “<a href="https://www.promisejs.org/patterns/">Promise Patterns</a>” by Forbes Lindesay</p>

<p id="ch_promises_ref_5">[5] “<a href="http://domenic.me/2014/02/13/the-revealing-constructor-pattern/">The Revealing Constructor Pattern</a>” by Domenic Denicola (this pattern is used by the <code>Promise</code> constructor)</p>

<div class="footnotes">
  <ol>
<li id="fn-promises_1">This is a slight simplification. Actually, the elements are converted via <code>C.resolve()</code>, where <code>C</code> is determined via the species pattern.<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#fnref-promises_1" rel="rev-footnote">↩</a>
</li>
  </ol>
</div>


<h1 id="leanpub-auto-miscellaneous">
<span class="section-number">VI </span>Miscellaneous</h1>

<h2 id="ch_unicode">
<span class="section-number">25. </span>Unicode</h2>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_road.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>This chapter isn’t finished, yet.</p>

    </td>
  </tr></tbody></table>
<p>Unicode is already mentioned in:</p>

<ul>
<li><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_strings">The chapter on strings</a></li>
</ul>
<p>Until this chapter is finished, you can consult the following material:</p>

<ul>
<li>“<a href="http://speakingjs.com/es5/ch24.html">Unicode and JavaScript</a>” (a chapter in “Speaking JavaScript”) is an introduction to Unicode.</li>
  <li>“<a href="https://mathiasbynens.be/notes/javascript-unicode">JavaScript has a Unicode problem</a>” (by Mathias Bynens) explains new Unicode features in ES6.</li>
</ul>
<h2 id="ch_tail-calls">
<span class="section-number">26. </span>Tail call optimization</h2>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_road.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>This chapter isn’t finished, yet.</p>

    </td>
  </tr></tbody></table>
<h2 id="ch_proxies">
<span class="section-number">27. </span>Meta programming with proxies</h2>

<p>This chapter explains the ECMAScript 6 (ES6) feature <em>proxies</em>. Proxies enable you to intercept and customize operations performed on objects (such as getting properties). They are a <em>meta programming</em> feature.</p>

<h3 id="leanpub-auto-overview-15">
<span class="section-number">27.1 </span>Overview</h3>

<p>In the following example, <code>proxy</code> is the object object whose operations we are intercepting and <code>handler</code> is the object that handles the interceptions. In this case, we are only intercepting a single operation, <code>get</code> (getting properties).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">target</code> <code class="o">=</code> <code class="p">{};</code>
<code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'get '</code> <code class="o">+</code> <code class="nx">propKey</code><code class="p">);</code>
        <code class="k">return</code> <code class="mi">123</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
<code class="kd">let</code> <code class="nx">proxy</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">handler</code><code class="p">);</code>
</pre></div>

</div>

<p>When we get the property <code>proxy.foo</code>, the handler intercepts that operation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">proxy</code><code class="p">.</code><code class="n">foo</code>
<code class="n">get</code> <code class="n">foo</code>
<code class="mi">123</code>
</pre></div>

</div>

<p><a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_reference-proxy-api">A section at the end of this chapter</a> serves as a reference to the complete API and lists what operations can be intercepted.</p>


<h3 id="leanpub-auto-programming-versus-meta-programming">
<span class="section-number">27.2 </span>Programming versus meta programming</h3>

<p>Before we can get into what proxies are and why they are useful, we first need to understand what <em>meta programming</em> is.</p>

<p>In programming, there are levels:</p>

<ul>
<li>At the <em>base level</em> (also called: <em>application level</em>), code processes user input.</li>
  <li>At the <em>meta level</em>, code processes base level code.</li>
</ul>
<p>Base and meta level can be diffent languages. In the following meta program, the meta programming language is JavaScript and the base programming language is Java.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">str</code> <code class="o">=</code> <code class="s1">'Hello'</code> <code class="o">+</code> <code class="s1">'!'</code><code class="p">.</code><code class="nx">repeat</code><code class="p">(</code><code class="mi">3</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'System.out.println("'</code><code class="o">+</code><code class="nx">str</code><code class="o">+</code><code class="s1">'")'</code><code class="p">);</code>
</pre></div>

</div>

<p>Meta programming can take different forms. In the previous example, we have printed Java code to the console. Let’s use JavaScript as both meta programming language and base programming language. The classic example for this is the <a href="http://speakingjs.com/es5/ch23.html#_dynamically_evaluating_javascript_code_via_eval_and_new_function"><code>eval()</code> function</a>, which lets you evaluate/compile JavaScript code on the fly. There are <a href="http://speakingjs.com/es5/ch23.html#_legitimate_use_cases">not that many actual use cases</a> for <code>eval()</code>. In the interaction below, we use it to evaluate the expression <code>5 + 2</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">eval</code><code class="p">(</code><code class="err">'</code><code class="mi">5</code> <code class="o">+</code> <code class="mi">2</code><code class="err">'</code><code class="p">)</code>
<code class="mi">7</code>
</pre></div>

</div>

<p>Other JavaScript operations may not look like meta programming, but actually are, if you look closer:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Base level</code>
<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">hello</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Hello!'</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">};</code>

<code class="c1">// Meta level</code>
<code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">key</code> <code class="nx">of</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">keys</code><code class="p">(</code><code class="nx">obj</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">key</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The program is examining its own structure while running. This doesn’t look like meta programming, because the separation between programming constructs and data structures is fuzzy in JavaScript. All of the <a href="http://speakingjs.com/es5/ch17.html#oop_cheat_sheet"><code>Object.*</code> methods</a> can be considered meta programming functionality.</p>

<h4 id="leanpub-auto-kinds-of-meta-programming">
<span class="section-number">27.2.1 </span>Kinds of meta programming</h4>

<p>Reflective meta programming means that a program processes itself.
<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_proxies_ref_2">Kiczales et al. [2]</a> distinguish three kinds of reflective meta programming:</p>

<ul>
<li>
<strong>Introspection:</strong> you have read-only access to the structure of a program.</li>
  <li>
<strong>Self-modification:</strong> you can change that structure.</li>
  <li>
<strong>Intercession:</strong> you can redefine the semantics of some language operations.</li>
</ul>
<p>Let’s look at examples.</p>

<p><strong>Example: introspection.</strong> <code>Object.keys()</code> performs introspection (see previous example).</p>

<p><strong>Example: self-modification.</strong> The following function <code>moveProperty</code> moves a property from a source to a target. It performs self-modification via the bracket operator for property access, the assignment operator and the <code>delete</code> operator. (In production code, you’d probably use <a href="http://speakingjs.com/es5/ch17.html#property_attributes">property descriptors</a> for this task.)</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">moveProperty</code><code class="p">(</code><code class="nx">source</code><code class="p">,</code> <code class="nx">propertyName</code><code class="p">,</code> <code class="nx">target</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">target</code><code class="p">[</code><code class="nx">propertyName</code><code class="p">]</code> <code class="o">=</code> <code class="nx">source</code><code class="p">[</code><code class="nx">propertyName</code><code class="p">];</code>
    <code class="k">delete</code> <code class="nx">source</code><code class="p">[</code><code class="nx">propertyName</code><code class="p">];</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Using <code>moveProperty()</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="kd">let</code> <code class="nx">obj1</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="s1">'abc'</code> <code class="p">};</code>
<code class="o">&gt;</code> <code class="kd">let</code> <code class="nx">obj2</code> <code class="o">=</code> <code class="p">{};</code>
<code class="o">&gt;</code> <code class="nx">moveProperty</code><code class="p">(</code><code class="nx">obj1</code><code class="p">,</code> <code class="s1">'prop'</code><code class="p">,</code> <code class="nx">obj2</code><code class="p">);</code>

<code class="o">&gt;</code> <code class="nx">obj1</code>
<code class="p">{}</code>
<code class="o">&gt;</code> <code class="nx">obj2</code>
<code class="p">{</code> <code class="nx">prop</code><code class="o">:</code> <code class="s1">'abc'</code> <code class="p">}</code>
</pre></div>

</div>

<p>ECMAScript 5 doesn’t support intercession, proxies were created to fill that gap.</p>


<h3 id="leanpub-auto-a-first-look-at-proxies">
<span class="section-number">27.3 </span>A first look at proxies</h3>

<p>ECMAScript 6 proxies bring intercession to JavaScript. They work as follows. There are many operations that you can perform on an object <code>obj</code>. For example:</p>

<ul>
<li>Getting the property <code>prop</code> of an object <code>obj</code> (<code>obj.prop</code>)</li>
  <li>Checking whether an object <code>obj</code> has a property <code>prop</code> (<code>'prop' in obj</code>)</li>
</ul>
<p>Proxies are special objects that allow you customize some of these operations. A proxy is created with two parameters:</p>

<ul>
<li>
<code>handler</code>: For each operation, there is a corresponding handler method that – if present – performs that operation. Such a method <em>intercepts</em> the operation (on its way to the target) and is called a <em>trap</em> (a term borrowed from the domain of operating systems).</li>
  <li>
<code>target</code>: If the handler doesn’t intercept an operation then it is performed on the target. That is, it acts as a fallback for the handler. In a way, the proxy wraps the target.</li>
</ul>
<p>In the following example, the handler intercepts the operations <code>get</code> and <code>has</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">target</code> <code class="o">=</code> <code class="p">{};</code>
<code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">{</code>
    <code class="cm">/** Intercepts: getting properties */</code>
    <code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">GET</code> <code class="nx">$</code><code class="p">{</code><code class="nx">propKey</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
        <code class="k">return</code> <code class="mi">123</code><code class="p">;</code>
    <code class="p">},</code>

    <code class="cm">/** Intercepts: checking whether properties exist */</code>
    <code class="nx">has</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="err">`</code><code class="nx">HAS</code> <code class="nx">$</code><code class="p">{</code><code class="nx">propKey</code><code class="p">}</code><code class="err">`</code><code class="p">);</code>
        <code class="k">return</code> <code class="kc">true</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
<code class="kd">let</code> <code class="nx">proxy</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">handler</code><code class="p">);</code>
</pre></div>

</div>

<p>When we get property <code>foo</code>, the handler intercepts that operation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">proxy</code><code class="p">.</code><code class="n">foo</code>
<code class="n">GET</code> <code class="n">foo</code>
<code class="mi">123</code>
</pre></div>

</div>

<p>Similarly, the <code>in</code> operator triggers <code>has</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="err">'</code><code class="n">hello</code><code class="err">'</code> <code class="n">in</code> <code class="n">proxy</code>
<code class="n">HAS</code> <code class="n">hello</code>
<code class="nb">true</code>
</pre></div>

</div>

<p>The handler doesn’t implement the trap <code>set</code> (setting properties). Therefore, setting <code>proxy.bar</code> is forwarded to <code>target</code> and leads to <code>target.bar</code> being set.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">proxy</code><code class="p">.</code><code class="n">bar</code> <code class="o">=</code> <code class="err">'</code><code class="n">abc</code><code class="err">'</code><code class="p">;</code>
<code class="o">&gt;</code> <code class="n">target</code><code class="p">.</code><code class="n">bar</code>
<code class="err">'</code><code class="n">abc</code><code class="err">'</code>
</pre></div>

</div>

<h4 id="leanpub-auto-function-specific-traps">
<span class="section-number">27.3.1 </span>Function-specific traps</h4>

<p>If the target is a function, two additional operations can be intercepted:</p>

<ul>
<li>
<code>apply</code>: Making a function call, triggered via
    <ul>
<li><code>proxy(···)</code></li>
      <li><code>proxy.call(···)</code></li>
      <li><code>proxy.apply(···)</code></li>
    </ul>
</li>
  <li>
<code>construct</code>: Making a constructor call, triggered via
    <ul>
<li><code>new proxy(···)</code></li>
    </ul>
</li>
</ul>
<p>The reason for only enabling these traps for function targets is simple: You wouldn’t be able to forward the operations <code>apply</code> and <code>construct</code>, otherwise.</p>

<h4 id="leanpub-auto-revocable-proxies">
<span class="section-number">27.3.2 </span>Revocable proxies</h4>

<p>ECMAScript 6 lets you create proxies that can be <em>revoked</em> (switched off):</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="p">{</code><code class="nx">proxy</code><code class="p">,</code> <code class="nx">revoke</code><code class="p">}</code> <code class="o">=</code> <code class="nx">Proxy</code><code class="p">.</code><code class="nx">revocable</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">handler</code><code class="p">);</code>
</pre></div>

</div>

<p>On the left hand side of the assignment operator (<code>=</code>), we are using destructuring to access the properties <code>proxy</code> and <code>revoke</code> of the object returned by <code>Proxy.revocable()</code>.</p>

<p>After you call the function <code>revoke</code> for the first time, any operation you apply to <code>proxy</code> causes a <code>TypeError</code>. Subsequent calls of <code>revoke</code> have no further effect.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">target</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// Start with an empty object</code>
<code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// Don’t intercept anything</code>
<code class="kd">let</code> <code class="p">{</code><code class="nx">proxy</code><code class="p">,</code> <code class="nx">revoke</code><code class="p">}</code> <code class="o">=</code> <code class="nx">Proxy</code><code class="p">.</code><code class="nx">revocable</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">handler</code><code class="p">);</code>

<code class="nx">proxy</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">proxy</code><code class="p">.</code><code class="nx">foo</code><code class="p">);</code> <code class="c1">// 123</code>

<code class="nx">revoke</code><code class="p">();</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">proxy</code><code class="p">.</code><code class="nx">foo</code><code class="p">);</code> <code class="c1">// TypeError: Revoked</code>
</pre></div>

</div>

<h4 id="leanpub-auto-proxies-as-prototypes">
<span class="section-number">27.3.3 </span>Proxies as prototypes</h4>

<p>A proxy <code>proto</code> can become the prototype of an object <code>obj</code>. Some operations that begin in <code>obj</code> may continue in <code>proto</code>. One such operation is <code>get</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">proto</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">({},</code> <code class="p">{</code>
    <code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propertyKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'GET '</code><code class="o">+</code><code class="nx">propertyKey</code><code class="p">);</code>
        <code class="k">return</code> <code class="nx">target</code><code class="p">[</code><code class="nx">propertyKey</code><code class="p">];</code>
    <code class="p">}</code>
<code class="p">});</code>

<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">proto</code><code class="p">);</code>
<code class="nx">obj</code><code class="p">.</code><code class="nx">bla</code><code class="p">;</code>

<code class="c1">// Output:</code>
<code class="c1">// GET bla</code>
</pre></div>

</div>

<p>The property <code>bla</code> can’t be found in <code>obj</code>, which is why the search continues in <code>proto</code> and the trap <code>get</code> is triggered there. There are more operations that affect prototypes, they are listed at the end of this chapter.</p>

<h4 id="sec_forwarding-intercepted-operations">
<span class="section-number">27.3.4 </span>Forwarding intercepted operations</h4>

<p>Operations whose traps the handler doesn’t implement are automatically forwarded to the target. Sometimes there is some task you want to perform in addition to forwarding the operation. For example, a handler that intercepts all operations and logs them, but doesn’t prevent them from reaching the target:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">deleteProperty</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'DELETE '</code> <code class="o">+</code> <code class="nx">propKey</code><code class="p">);</code>
        <code class="k">return</code> <code class="k">delete</code> <code class="nx">target</code><code class="p">[</code><code class="nx">propKey</code><code class="p">];</code>
    <code class="p">},</code>
    <code class="nx">has</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'HAS '</code> <code class="o">+</code> <code class="nx">propKey</code><code class="p">);</code>
        <code class="k">return</code> <code class="nx">propKey</code> <code class="k">in</code> <code class="nx">target</code><code class="p">;</code>
    <code class="p">},</code>
    <code class="c1">// Other traps: similar</code>
<code class="p">}</code>
</pre></div>

</div>

<p>For each trap, we first log the name of the operation and then forward it by performing it manually. ECMAScript 6 has the module-like object <code>Reflect</code> that helps with forwarding: for each trap</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">handler</code><code class="p">.</code><code class="nx">trap</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">arg_1</code><code class="p">,</code> <code class="err">···</code><code class="p">,</code> <code class="nx">arg_n</code><code class="p">)</code>
</pre></div>

</div>

<p><code>Reflect</code> has a method</p>

<div class="code-block">
<div class="highlight"><pre><code class="nx">Reflect</code><code class="p">.</code><code class="nx">trap</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">arg_1</code><code class="p">,</code> <code class="err">···</code><code class="p">,</code> <code class="nx">arg_n</code><code class="p">)</code>
</pre></div>

</div>

<p>If we use <code>Reflect</code>, the previous example looks as follows.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">deleteProperty</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'DELETE '</code> <code class="o">+</code> <code class="nx">propKey</code><code class="p">);</code>
        <code class="k">return</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">deleteProperty</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">);</code>
    <code class="p">},</code>
    <code class="nx">has</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'HAS '</code> <code class="o">+</code> <code class="nx">propKey</code><code class="p">);</code>
        <code class="k">return</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">);</code>
    <code class="p">},</code>
    <code class="c1">// Other traps: similar</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Now what each of the traps does is so similar that we can implement the handler via a proxy:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">({},</code> <code class="p">{</code>
    <code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">trapName</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// Return the handler method named trapName</code>
        <code class="k">return</code> <code class="kd">function</code> <code class="p">(...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
            <code class="c1">// Don’t log args[0]</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">trapName</code><code class="p">.</code><code class="nx">toUpperCase</code><code class="p">()</code><code class="o">+</code><code class="s1">' '</code><code class="o">+</code><code class="nx">args</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="mi">1</code><code class="p">));</code>
            <code class="c1">// Forward the operation</code>
            <code class="k">return</code> <code class="nx">Reflect</code><code class="p">[</code><code class="nx">trapName</code><code class="p">](...</code><code class="nx">args</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>For each trap, the proxy asks for a handler method via the <code>get</code> operation and we give it one. That is, all of the handler methods can be implemented via the single meta method <code>get</code>. It was one of the goals for the proxy API to make this kind of virtualization simple.</p>

<p>Let’s use this proxy-based handler:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">target</code> <code class="o">=</code> <code class="p">{};</code>
<code class="o">&gt;</code> <code class="n">let</code> <code class="n">proxy</code> <code class="o">=</code> <code class="n">new</code> <code class="n">Proxy</code><code class="p">(</code><code class="n">target</code><code class="p">,</code> <code class="n">handler</code><code class="p">);</code>
<code class="o">&gt;</code> <code class="n">proxy</code><code class="p">.</code><code class="n">foo</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code>
<code class="n">SET</code> <code class="n">foo</code><code class="p">,</code><code class="mi">123</code><code class="p">,[</code><code class="n">object</code> <code class="n">Object</code><code class="p">]</code>
<code class="o">&gt;</code> <code class="n">proxy</code><code class="p">.</code><code class="n">foo</code>
<code class="n">GET</code> <code class="n">foo</code><code class="p">,[</code><code class="n">object</code> <code class="n">Object</code><code class="p">]</code>
<code class="mi">123</code>
</pre></div>

</div>

<p>The following interaction confirms that the <code>set</code> operation was correctly forwarded to the target:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">target</code><code class="p">.</code><code class="n">foo</code>
<code class="mi">123</code>
</pre></div>

</div>


<h3 id="leanpub-auto-use-cases-for-proxies">
<span class="section-number">27.4 </span>Use cases for proxies</h3>

<p>This section demonstrates what proxies can be used for. That will also give you the opportunity to see the API in action.</p>

<h4 id="leanpub-auto-implementing-the-dom-in-javascript">
<span class="section-number">27.4.1 </span>Implementing the DOM in JavaScript</h4>

<p>The browser Document Object Model (DOM) is usually implemented as a mix of JavaScript and C++. Implementing it in pure JavaScript is useful for:</p>

<ul>
<li>Emulating a browser environment, e.g. to manipulate HTML in Node.js. <a href="https://github.com/tmpvar/jsdom">jsdom</a> is one library that does that.</li>
  <li>Speeding the DOM up (switching between JavaScript and C++ costs time).</li>
</ul>
<p>Alas, the standard DOM can do things that are not easy to replicate in JavaScript. For example, most DOM collections are live views on the current state of the DOM that change dynamically whenever the DOM changes. As a result, pure JavaScript implementations of the DOM are not very efficient. One of the reasons for adding proxies to JavaScript was to help write more efficient DOM implementations.</p>

<h4 id="leanpub-auto-accessing-a-restful-web-service">
<span class="section-number">27.4.2 </span>Accessing a restful web service</h4>

<p>A proxy can be used to create an object on which arbitrary methods can be invoked. In the following example, the function <code>createWebService</code> creates one such object, <code>service</code>. Invoking a method on <code>service</code> retrieves the contents of the web service resource with the same name. Retrieval is handled via an ECMAScript 6 Promise.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">service</code> <code class="o">=</code> <code class="nx">createWebService</code><code class="p">(</code><code class="s1">'http://example.com/data'</code><code class="p">);</code>
<code class="c1">// Read JSON data in http://example.com/data/employees</code>
<code class="nx">service</code><code class="p">.</code><code class="nx">employees</code><code class="p">().</code><code class="nx">then</code><code class="p">(</code><code class="nx">json</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">employees</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">json</code><code class="p">);</code>
    <code class="err">···</code>
<code class="p">});</code>
</pre></div>

</div>

<p>The following code is a quick and dirty implementation of <code>createWebService</code> in ECMAScript 5. Because we don’t have proxies, we need to know beforehand what methods will be invoked on <code>service</code>. The parameter <code>propKeys</code> provides us with that information, it holds an Array with method names.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">createWebService</code><code class="p">(</code><code class="nx">baseUrl</code><code class="p">,</code> <code class="nx">propKeys</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">service</code> <code class="o">=</code> <code class="p">{};</code>
    <code class="nx">propKeys</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">propKey</code><code class="p">)</code> <code class="p">{</code>
        <code class="nb">Object</code><code class="p">.</code><code class="nx">defineProperty</code><code class="p">(</code><code class="nx">service</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="p">{</code>
            <code class="nx">get</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">httpGet</code><code class="p">(</code><code class="nx">baseUrl</code><code class="o">+</code><code class="s1">'/'</code><code class="o">+</code><code class="nx">propKey</code><code class="p">);</code>
            <code class="p">}</code>
        <code class="p">});</code>
    <code class="p">});</code>
    <code class="k">return</code> <code class="nx">service</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The ECMAScript 6 implementation of <code>createWebService</code> can use proxies and is simpler:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">createWebService</code><code class="p">(</code><code class="nx">baseUrl</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">({},</code> <code class="p">{</code>
        <code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">httpGet</code><code class="p">(</code><code class="nx">baseUrl</code><code class="o">+</code><code class="s1">'/'</code><code class="o">+</code><code class="nx">propKey</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</div>

<p>Both implementations use the following function to make HTTP GET requests (how it works is explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_promises">the chapter on Promises</a>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">httpGet</code><code class="p">(</code><code class="nx">url</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Promise</code><code class="p">(</code>
        <code class="p">(</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">request</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">XMLHttpRequest</code><code class="p">();</code>
            <code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">(</code><code class="nx">request</code><code class="p">,</code> <code class="p">{</code>
                <code class="nx">onreadystatechange</code><code class="p">()</code> <code class="p">{</code>
                    <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">status</code> <code class="o">===</code> <code class="mi">200</code><code class="p">)</code> <code class="p">{</code>
                        <code class="c1">// Success</code>
                        <code class="nx">resolve</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">response</code><code class="p">);</code>
                    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                        <code class="c1">// Something went wrong (404 etc.)</code>
                        <code class="nx">reject</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">statusText</code><code class="p">));</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="nx">onerror</code><code class="p">()</code> <code class="p">{</code>
                    <code class="nx">reject</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code>
                        <code class="s1">'XMLHttpRequest Error: '</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">statusText</code><code class="p">));</code>
                <code class="p">}</code>
            <code class="p">});</code>
            <code class="nx">request</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'GET'</code><code class="p">,</code> <code class="nx">url</code><code class="p">);</code>
            <code class="nx">request</code><code class="p">.</code><code class="nx">send</code><code class="p">();</code>
        <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-tracing-property-accesses">
<span class="section-number">27.4.3 </span>Tracing property accesses</h4>

<p>The example in this section is inspired by Brendan Eich’s talk “<a href="http://jsconf.eu/2010/speaker/be_proxy_objects.html">Proxies are Awesome</a>”: We want to trace when a given set of properties is read or changed. To demonstrate how that works, let’s create a class for points and trace accesses to the properties of an instance.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kr">class</code> <code class="nx">Point</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'Point('</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">x</code><code class="o">+</code><code class="s1">','</code><code class="o">+</code><code class="k">this</code><code class="p">.</code><code class="nx">y</code><code class="o">+</code><code class="s1">')'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="c1">// Trace accesses to properties `x` and `y`</code>
<code class="kd">let</code> <code class="nx">p</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Point</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code> <code class="mi">7</code><code class="p">);</code>
<code class="nx">p</code> <code class="o">=</code> <code class="nx">tracePropAccess</code><code class="p">(</code><code class="nx">p</code><code class="p">,</code> <code class="p">[</code><code class="s1">'x'</code><code class="p">,</code> <code class="s1">'y'</code><code class="p">]);</code>
</pre></div>

</div>

<p>Getting and setting properties of <code>p</code> now has the following effects:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">p</code><code class="p">.</code><code class="n">x</code>
<code class="n">GET</code> <code class="n">x</code>
<code class="mi">5</code>
<code class="o">&gt;</code> <code class="n">p</code><code class="p">.</code><code class="n">x</code> <code class="o">=</code> <code class="mi">21</code>
<code class="n">SET</code> <code class="n">x</code><code class="o">=</code><code class="mi">21</code>
<code class="mi">21</code>
</pre></div>

</div>

<p>Intriguingly, tracing also works whenever <code>Point</code> accesses the properties, because <code>this</code> now refers to the proxy, not to an instance of <code>Point</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">p</code><code class="p">.</code><code class="n">toString</code><code class="p">()</code>
<code class="n">GET</code> <code class="n">x</code>
<code class="n">GET</code> <code class="n">y</code>
<code class="err">'</code><code class="n">Point</code><code class="p">(</code><code class="mi">21</code><code class="p">,</code><code class="mi">7</code><code class="p">)</code><code class="err">'</code>
</pre></div>

</div>

<p>In ECMAScript 5, you’d implement <code>tracePropAccess()</code> as follows. We replace each property with a getter and a setter that traces accesses. The setters and getters use an extra object, <code>propData</code>, to store the data of the properties. Note that we are destructively changing the original implementation, which means that we are meta programming.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">tracePropAccess</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">propKeys</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Store the property data here</code>
    <code class="kd">let</code> <code class="nx">propData</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
    <code class="c1">// Replace each property with a getter and a setter</code>
    <code class="nx">propKeys</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">propKey</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">propData</code><code class="p">[</code><code class="nx">propKey</code><code class="p">]</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">[</code><code class="nx">propKey</code><code class="p">];</code>
        <code class="nb">Object</code><code class="p">.</code><code class="nx">defineProperty</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="p">{</code>
            <code class="nx">get</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
                <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'GET '</code><code class="o">+</code><code class="nx">propKey</code><code class="p">);</code>
                <code class="k">return</code> <code class="nx">propData</code><code class="p">[</code><code class="nx">propKey</code><code class="p">];</code>
            <code class="p">},</code>
            <code class="nx">set</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'SET '</code><code class="o">+</code><code class="nx">propKey</code><code class="o">+</code><code class="s1">'='</code><code class="o">+</code><code class="nx">value</code><code class="p">);</code>
                <code class="nx">propData</code><code class="p">[</code><code class="nx">propKey</code><code class="p">]</code> <code class="o">=</code> <code class="nx">value</code><code class="p">;</code>
            <code class="p">},</code>
        <code class="p">});</code>
    <code class="p">});</code>
    <code class="k">return</code> <code class="nx">obj</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>

</div>

<p>In ECMAScript 6, we can use a simpler, proxy-based solution. We intercept property getting and setting and don’t have to change the implementation.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">tracePropAccess</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">propKeys</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">propKeySet</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Set</code><code class="p">(</code><code class="nx">propKeys</code><code class="p">);</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="p">{</code>
        <code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">propKeySet</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="nx">propKey</code><code class="p">))</code> <code class="p">{</code>
                <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'GET '</code><code class="o">+</code><code class="nx">propKey</code><code class="p">);</code>
            <code class="p">}</code>
            <code class="k">return</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">);</code>
        <code class="p">},</code>
        <code class="nx">set</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">value</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">propKeySet</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="nx">propKey</code><code class="p">))</code> <code class="p">{</code>
                <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'SET '</code><code class="o">+</code><code class="nx">propKey</code><code class="o">+</code><code class="s1">'='</code><code class="o">+</code><code class="nx">value</code><code class="p">);</code>
            <code class="p">}</code>
            <code class="k">return</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">value</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">);</code>
        <code class="p">},</code>
    <code class="p">});</code>
<code class="p">}</code>
</pre></div>

</div>

<h4 id="leanpub-auto-warning-about-unknown-properties">
<span class="section-number">27.4.4 </span>Warning about unknown properties</h4>

<p>When it comes to accessing properties, JavaScript is very forgiving. For example, if you try to read a property and misspell its name, you don’t get an exception, you get the result <code>undefined</code>. You can use proxies to get an exception in such a case. This works as follows. We make the proxy a prototype of an object.</p>

<p>If a property isn’t found in the object, the <code>get</code> trap of the proxy is triggered. If the property doesn’t even exist in the prototype chain after the proxy, it really is missing and we throw an exception. Otherwise, we return the value of the inherited property. We do so by forwarding the <code>get</code> operation to the target (the prototype of the target is also the prototype of the proxy).</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">PropertyChecker</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">({},</code> <code class="p">{</code>
    <code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="p">(</code><code class="nx">propKey</code> <code class="k">in</code> <code class="nx">target</code><code class="p">))</code> <code class="p">{</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nx">ReferenceError</code><code class="p">(</code><code class="s1">'Unknown property: '</code><code class="o">+</code><code class="nx">propKey</code><code class="p">);</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">});</code>
</pre></div>

</div>

<p>Let’s use <code>PropertyChecker</code> for an object that we create:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">let</code> <code class="n">obj</code> <code class="o">=</code> <code class="p">{</code> <code class="n">__proto__</code><code class="o">:</code> <code class="n">PropertyChecker</code><code class="p">,</code> <code class="n">foo</code><code class="o">:</code> <code class="mi">123</code> <code class="p">};</code>
<code class="o">&gt;</code> <code class="n">obj</code><code class="p">.</code><code class="n">foo</code>  <code class="c1">// own</code>
<code class="mi">123</code>
<code class="o">&gt;</code> <code class="n">obj</code><code class="p">.</code><code class="n">fo</code>
<code class="nl">ReferenceError:</code> <code class="n">Unknown</code> <code class="n">property</code><code class="o">:</code> <code class="n">fo</code>
<code class="o">&gt;</code> <code class="n">obj</code><code class="p">.</code><code class="n">toString</code><code class="p">()</code>  <code class="c1">// inherited</code>
<code class="err">'</code><code class="p">[</code><code class="n">object</code> <code class="n">Object</code><code class="p">]</code><code class="err">'</code>
</pre></div>

</div>

<p>If we turn <code>PropertyChecker</code> into a constructor, we can use it for ECMAScript 6 classes via <code>extends</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">PropertyChecker</code><code class="p">()</code> <code class="p">{</code> <code class="p">}</code>
<code class="nx">PropertyChecker</code><code class="p">.</code><code class="nx">prototype</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="err">···</code><code class="p">);</code>

<code class="kr">class</code> <code class="nx">Point</code> <code class="kr">extends</code> <code class="nx">PropertyChecker</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">x</code> <code class="o">=</code> <code class="nx">x</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">y</code> <code class="o">=</code> <code class="nx">y</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kd">let</code> <code class="nx">p</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Point</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code> <code class="mi">7</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">p</code><code class="p">.</code><code class="nx">x</code><code class="p">);</code> <code class="c1">// 5</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">p</code><code class="p">.</code><code class="nx">z</code><code class="p">);</code> <code class="c1">// ReferenceError</code>
</pre></div>

</div>

<p>If you are worried about accidentally <em>creating</em> properties, you have two options: You can either wrap a proxy around objects that traps <code>set</code>. Or you can make an object <code>obj</code> non-extensible via <a href="http://speakingjs.com/es5/ch17.html#_preventing_extensions"><code>Object.preventExtensions(obj)</code></a>, which means that JavaScript doesn’t let you add new (own) properties to <code>obj</code>.</p>

<h4 id="leanpub-auto-negative-array-indices">
<span class="section-number">27.4.5 </span>Negative Array indices</h4>

<p>Some Array methods let you refer to the last element via <code>-1</code>, to the second-to-last element via <code>-2</code>, etc. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="p">[</code><code class="sc">'a'</code><code class="p">,</code> <code class="sc">'b'</code><code class="p">,</code> <code class="sc">'c'</code><code class="p">].</code><code class="n">slice</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">)</code>
<code class="p">[</code> <code class="sc">'c'</code> <code class="p">]</code>
</pre></div>

</div>

<p>Alas, that doesn’t work when accessing elements via the bracket operator (<code>[]</code>). We can, however, use proxies to add that capability. The following function <code>createArray()</code> creates Arrays that support negative indices. It does so by wrapping proxies around Array instances. The proxies intercept the <code>get</code> operation that is triggered by the bracket operator.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">createArray</code><code class="p">(...</code><code class="nx">elements</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">{</code>
        <code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
            <code class="kd">let</code> <code class="nx">index</code> <code class="o">=</code> <code class="nb">Number</code><code class="p">(</code><code class="nx">propKey</code><code class="p">);</code>
            <code class="c1">// Sloppy way of checking for negative indices</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">index</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">propKey</code> <code class="o">=</code> <code class="nb">String</code><code class="p">(</code><code class="nx">target</code><code class="p">.</code><code class="nx">length</code> <code class="o">+</code> <code class="nx">index</code><code class="p">);</code>
            <code class="p">}</code>
            <code class="k">return</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">};</code>
    <code class="c1">// Wrap a proxy around an Array</code>
    <code class="kd">let</code> <code class="nx">target</code> <code class="o">=</code> <code class="p">[];</code>
    <code class="nx">target</code><code class="p">.</code><code class="nx">push</code><code class="p">(...</code><code class="nx">elements</code><code class="p">);</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">handler</code><code class="p">);</code>
<code class="p">}</code>
<code class="kd">let</code> <code class="nx">arr</code> <code class="o">=</code> <code class="nx">createArray</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">arr</code><code class="p">[</code><code class="o">-</code><code class="mi">1</code><code class="p">]);</code> <code class="c1">// c</code>
</pre></div>

</div>

<p>Acknowledgement: The idea for this example comes from a <a href="http://h3manth.com/new/blog/2013/negative-array-index-in-javascript/">blog post</a> by hemanth.hm.</p>

<h4 id="leanpub-auto-data-binding">
<span class="section-number">27.4.6 </span>Data binding</h4>

<p>Data binding is about syncing data between objects. One popular use case are widgets based on the MVC (Model View Controler) pattern: With data binding, the <em>view</em> (the widget) stays up-to-date if you change the <em>model</em> (the data visualized by the widget).</p>

<p>To implement data binding, you have to observe and react to changes made to an object. In the following code snippet, I sketch how observing changes could work for an Array.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">array</code> <code class="o">=</code> <code class="p">[];</code>
<code class="kd">let</code> <code class="nx">observedArray</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">array</code><code class="p">,</code> <code class="p">{</code>
    <code class="nx">set</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propertyKey</code><code class="p">,</code> <code class="nx">value</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">propertyKey</code><code class="o">+</code><code class="s1">'='</code><code class="o">+</code><code class="nx">value</code><code class="p">);</code>
        <code class="nx">Reflect</code><code class="p">.</code><code class="nx">set</code><code class="p">((</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propertyKey</code><code class="p">,</code> <code class="nx">value</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">});</code>
<code class="nx">observedArray</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="s1">'a'</code><code class="p">);</code>
</pre></div>

</div>

<p>Output:</p>

<div class="code-block">
<div class="highlight"><pre><code class="mi">0</code><code class="o">=</code><code class="nx">a</code>
<code class="nx">length</code><code class="o">=</code><code class="mi">1</code>
</pre></div>

</div>

<p>Data binding is a complex topic. Given its popularity and concerns over proxies not being performant enough, a dedicated mechanism has been created for data binding: <code>Object.observe()</code>. It will probably be part of ECMAScript 7 and is already <a href="http://kangax.github.io/compat-table/es7/#Object.observe">supported</a> by Chrome.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_external-link.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>Consult Addy Osmani’s article “<a href="http://www.html5rocks.com/en/tutorials/es7/observe/">Data-binding Revolutions with Object.observe()</a>” for more information on <code>Object.observe()</code>.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-revocable-references">
<span class="section-number">27.4.7 </span>Revocable references</h4>

<p><em>Revocable references</em> work as follows: A client is not allowed to access an important resource (an object) directly, only via a reference (an intermediate object, a wrapper around the resource). Normally, every operation applied to the reference is forwarded to the resource. After the client is done, the resource is protected by <em>revoking</em> the reference, by switching it off. Henceforth, applying operations to the reference throws exceptions and nothing is forwarded, anymore.</p>

<p>In the following example, we create a revocable reference for a resource. We then read one of the resource’s properties via the reference. That works, because the reference grants us access. Next, we revoke the reference. Now the reference doesn’t let us read the property, anymore.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">resource</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">x</code><code class="o">:</code> <code class="mi">11</code><code class="p">,</code> <code class="nx">y</code><code class="o">:</code> <code class="mi">8</code> <code class="p">};</code>
<code class="kd">let</code> <code class="p">{</code><code class="nx">reference</code><code class="p">,</code> <code class="nx">revoke</code><code class="p">}</code> <code class="o">=</code> <code class="nx">createRevocableReference</code><code class="p">(</code><code class="nx">resource</code><code class="p">);</code>

<code class="c1">// Access granted</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">reference</code><code class="p">.</code><code class="nx">x</code><code class="p">);</code> <code class="c1">// 11</code>

<code class="nx">revoke</code><code class="p">();</code>

<code class="c1">// Access denied</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">reference</code><code class="p">.</code><code class="nx">x</code><code class="p">);</code> <code class="c1">// TypeError: Revoked</code>
</pre></div>

</div>

<p>Proxies are ideally suited for implementing revocable references, because they can intercept and forward operations. This is a simple proxy-based implementation of <code>createRevocableReference</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">createRevocableReference</code><code class="p">(</code><code class="nx">target</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">enabled</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="nx">reference</code><code class="o">:</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="p">{</code>
            <code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">enabled</code><code class="p">)</code> <code class="p">{</code>
                    <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">(</code><code class="s1">'Revoked'</code><code class="p">);</code>
                <code class="p">}</code>
                <code class="k">return</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">);</code>
            <code class="p">},</code>
            <code class="nx">has</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">enabled</code><code class="p">)</code> <code class="p">{</code>
                    <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">(</code><code class="s1">'Revoked'</code><code class="p">);</code>
                <code class="p">}</code>
                <code class="k">return</code> <code class="nx">Reflect</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">);</code>
            <code class="p">},</code>
            <code class="err">···</code>
        <code class="p">}),</code>
        <code class="nx">revoke</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">enabled</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
        <code class="p">},</code>
    <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The code can be simplified via the proxy-as-handler technique from the previous section. This time, the handler basically is the <code>Reflect</code> object. Thus, the <code>get</code> trap normally returns the appropriate <code>Reflect</code> method. If the reference has been revoked, a <code>TypeError</code> is thrown, instead.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">createRevocableReference</code><code class="p">(</code><code class="nx">target</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">enabled</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
    <code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">({},</code> <code class="p">{</code>
        <code class="nx">get</code><code class="p">(</code><code class="nx">dummyTarget</code><code class="p">,</code> <code class="nx">trapName</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">enabled</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">throw</code> <code class="k">new</code> <code class="nx">TypeError</code><code class="p">(</code><code class="s1">'Revoked'</code><code class="p">);</code>
            <code class="p">}</code>
            <code class="k">return</code> <code class="nx">Reflect</code><code class="p">[</code><code class="nx">trapName</code><code class="p">];</code>
        <code class="p">}</code>
    <code class="p">});</code>
    <code class="k">return</code> <code class="p">{</code>
        <code class="nx">reference</code><code class="o">:</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">handler</code><code class="p">),</code>
        <code class="nx">revoke</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">enabled</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
        <code class="p">},</code>
    <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</div>

<p>However, you don’t have to implement revocable references yourself, because ECMAScript 6 lets you create proxies that can be revoked. This time, the revoking happens in the proxy, not in the handler. All the handler has to do is forward every operation to the target. As we have seen that happens automatically if the handler doesn’t implement any traps.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">function</code> <code class="nx">createRevocableReference</code><code class="p">(</code><code class="nx">target</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">{};</code> <code class="c1">// forward everything</code>
    <code class="kd">let</code> <code class="p">{</code> <code class="nx">proxy</code><code class="p">,</code> <code class="nx">revoke</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">Proxy</code><code class="p">.</code><code class="nx">revocable</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">handler</code><code class="p">);</code>
    <code class="k">return</code> <code class="p">{</code> <code class="nx">reference</code><code class="o">:</code> <code class="nx">proxy</code><code class="p">,</code> <code class="nx">revoke</code> <code class="p">};</code>
<code class="p">}</code>
</pre></div>

</div>

<h5 id="leanpub-auto-membranes">
<span class="section-number">27.4.7.1 </span>Membranes</h5>

<p><em>Membranes</em> build on the idea of revocable references: Environments that are designed to run untrusted code, wrap a membrane around that code to isolate it and keep the rest of the system safe. Objects pass the membrane in two directions:</p>

<ul>
<li>The code may receive objects from the outside.</li>
  <li>Or it may hand objects to the outside.</li>
</ul>
<p>In both cases, revocable references are wrapped around the objects. Objects returned by wrapped functions or methods are also wrapped.</p>

<p>Once the untrusted code is done, all of those references are revoked. As a result, none of its code on the outside can be executed anymore and outside objects that it has cease to work, as well. The <a href="https://developers.google.com/caja/">Caja Compiler</a> is “a tool for making third party HTML, CSS and JavaScript safe to embed in your website”. It uses membranes to achieve this task.</p>

<h4 id="leanpub-auto-other-use-cases">
<span class="section-number">27.4.8 </span>Other use cases</h4>

<p>There are more use cases for proxies. For example:</p>

<ul>
<li>Remoting: Local placeholder objects forward method invocations to remote objects. This use case is similar to the web service example.</li>
  <li>Data access objects for databases: Reading and writing to the object reads and writes to the database. This use case is similar to the web service example.</li>
  <li>Profiling: Intercept method invocations to track how much time is spent in each method. This use case is similar to the tracing example.</li>
  <li>Type checking: Nicholas Zakas has used proxies to <a href="http://www.nczonline.net/blog/2014/04/29/creating-type-safe-properties-with-ecmascript-6-proxies/">type-check objects</a>.</li>
</ul>
<h3 id="leanpub-auto-the-design-of-the-proxy-api">
<span class="section-number">27.5 </span>The design of the proxy API</h3>

<p>In this section, we go deeper into how proxies work and why they work that way.</p>

<h4 id="leanpub-auto-stratification-keeping-base-level-and-meta-level-separate">
<span class="section-number">27.5.1 </span>Stratification: keeping base level and meta level separate</h4>

<p>Firefox has allowed you to do some interceptive meta programming for a while: If you define a method whose name is <code>__noSuchMethod__</code>, it is notified whenever a method is called that doesn’t exist. The following is an example of using <code>__noSuchMethod__</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">__noSuchMethod__</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">name</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">name</code><code class="o">+</code><code class="s1">': '</code><code class="o">+</code><code class="nx">args</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">};</code>
<code class="c1">// Neither of the following two methods exist,</code>
<code class="c1">// but we can make it look like they do</code>
<code class="nx">obj</code><code class="p">.</code><code class="nx">foo</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>    <code class="c1">// Output: foo: 1</code>
<code class="nx">obj</code><code class="p">.</code><code class="nx">bar</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code> <code class="c1">// Output: bar: 1,2</code>
</pre></div>

</div>

<p>Thus, <code>__noSuchMethod__</code> works similarly to a proxy trap. In contrast to proxies, the trap is an own or inherited method of the object whose operations we want to intercept. The problem with that approach is that base level (normal methods) and meta level (<code>__noSuchMethod__</code>) are mixed. Base-level code may accidentally invoke or see a meta level method and there is the possibility of accidentally defining a meta level method.</p>

<p>Even in standard ECMAScript 5, base level and meta level are sometimes mixed. For example, the following meta programming mechanisms can fail, because they exist at the base level:</p>

<ul>
<li>
<code>obj.hasOwnProperty(propKey)</code>: This call can fail if a property in the prototype chain overrides the built-in implementation. For example, it fails if <code>obj</code> is:
    <div class="code-block">
<div class="highlight"><pre>  <code class="p">{</code> <code class="nx">hasOwnProperty</code><code class="o">:</code> <code class="kc">null</code> <code class="p">}</code>
</pre></div>
    
</div>

    <p>A safe way to call this method is:</p>

    <div class="code-block">
<div class="highlight"><pre>  <code class="nb">Object</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">hasOwnProperty</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">)</code>

  <code class="c1">// Abbreviated version:</code>
  <code class="p">{}.</code><code class="nx">hasOwnProperty</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">)</code>
</pre></div>
    
</div>
  </li>
  <li>
<code>func.call(···)</code>, <code>func.apply(···)</code>: For each of these two methods, problem and solution are the same as with <code>hasOwnProperty</code>.</li>
  <li>
<code>obj.__proto__</code>: In most JavaScript engines, <code>__proto__</code> is a special property that lets you get and set the prototype of <code>obj</code>. Hence, when you use objects as dictionaries, you must be careful to <a href="http://speakingjs.com/es5/ch17.html#_pitfall_3_the_special_property___proto">avoid <code>__proto__</code> as a property key</a>.</li>
</ul>
<p>By now, it should be obvious that making (base level) property keys special is problematic. Therefore, proxies are <em>stratified</em> – base level (the proxy object) and meta level (the handler object) are separate.</p>

<h4 id="leanpub-auto-virtual-objects-versus-wrappers">
<span class="section-number">27.5.2 </span>Virtual objects versus wrappers</h4>

<p>Proxies are used in two roles:</p>

<ul>
<li>As <em>wrappers</em>, they <em>wrap</em> their targets, they control access to them. Examples of wrappers are: revocable resources and tracing proxies.</li>
  <li>As <em>virtual objects</em>, they are simply objects with special behavior and their targets don’t matter. An example is a proxy that forwards method calls to a remote object.</li>
</ul>
<p>An earlier design of the proxy API conceived proxies as purely virtual objects. However, it turned out that even in that role, a target was useful, to enforce invariants (which is explained later) and as a fallback for traps that the handler doesn’t implement.</p>

<h4 id="sec_detect-proxies">
<span class="section-number">27.5.3 </span>Transparent virtualization and handler encapsulation</h4>

<p>Proxies are shielded in two ways:</p>

<ul>
<li>It is impossible to determine whether an object is a proxy or not (<em>transparent virtualization</em>).</li>
  <li>You can’t access a handler via its proxy (<em>handler encapsulation</em>).</li>
</ul>
<p>Both principles give proxies considerable power for impersonating other objects. One reason for enforcing <em>invariants</em> (as explained later) is to keep that power in check.</p>

<p>If you do need a way to tell proxies apart from non-proxies, you have to implement it yourself. The following code is a module <code>lib.js</code> that exports two functions: one of them creates proxies, the other one determines whether an object is one of those proxies.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// lib.js</code>
<code class="kd">let</code> <code class="nx">proxies</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakSet</code><code class="p">();</code>

<code class="kr">export</code> <code class="kd">function</code> <code class="nx">createProxy</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">{};</code>
    <code class="kd">let</code> <code class="nx">proxy</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">handler</code><code class="p">);</code>
    <code class="nx">proxies</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="nx">proxy</code><code class="p">);</code>
    <code class="k">return</code> <code class="nx">proxy</code><code class="p">;</code>
<code class="p">}</code>

<code class="kr">export</code> <code class="kd">function</code> <code class="nx">isProxy</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">proxies</code><code class="p">.</code><code class="nx">has</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>This module uses the ECMAScript 6 data structure <code>WeakSet</code> for keeping track of proxies. <code>WeakSet</code> is ideally suited for this purpose, because it doesn’t prevent its elements from being garbage-collected.</p>

<p>The next example shows how <code>lib.js</code> can be used.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// main.js</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">createProxy</code><code class="p">,</code> <code class="nx">isProxy</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'./lib.js'</code><code class="p">;</code>

<code class="kd">let</code> <code class="nx">p</code> <code class="o">=</code> <code class="nx">createProxy</code><code class="p">({});</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">isProxy</code><code class="p">(</code><code class="nx">p</code><code class="p">));</code> <code class="c1">// true</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">isProxy</code><code class="p">({}));</code> <code class="c1">// false</code>
</pre></div>

</div>

<h4 id="leanpub-auto-the-meta-object-protocol-and-proxy-traps">
<span class="section-number">27.5.4 </span>The meta object protocol and proxy traps</h4>

<p>This section examines how JavaScript is structured internally and how the set of proxy traps was chosen.</p>

<p>The term <em>protocol</em> is highly overloaded in computer science. One definition is:</p>

<blockquote>
  <p>A prototcol is about achieving tasks via an object, it comprises a set of methods plus a set of rules for using them.</p>
</blockquote>

<p>Note that this definition is different from viewing protocols as interfaces (as, for example, Objective C does), because it includes rules.</p>

<p>The ECMAScript specification describes how to execute JavaScript code. It includes a <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-ordinary-and-exotic-objects-behaviours">protocol for handling objects</a>. This protocol operates at a meta level and is sometimes called the meta object protocol (MOP). The JavaScript MOP consists of own internal methods that all objects have. “Internal” means that they exist only in the specification (JavaScript engines may or may not have them) and are not accessible from JavaScript. The names of internal methods are written in double square brackets.</p>

<p>The internal method for getting properties is called <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-proxy-object-internal-methods-and-internal-slots-get-p-receiver"><code>[[Get]]</code></a>. If we pretend that property names with square brackets are legal, this method would roughly be implemented as follows in JavaScript.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Method definition</code>
<code class="p">[[</code><code class="nx">Get</code><code class="p">]](</code><code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">desc</code> <code class="o">=</code> <code class="k">this</code><code class="p">.[[</code><code class="nx">GetOwnProperty</code><code class="p">]](</code><code class="nx">propKey</code><code class="p">);</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">desc</code> <code class="o">===</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">parent</code> <code class="o">=</code> <code class="k">this</code><code class="p">.[[</code><code class="nx">GetPrototypeOf</code><code class="p">]]();</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">parent</code> <code class="o">===</code> <code class="kc">null</code><code class="p">)</code> <code class="k">return</code> <code class="kc">undefined</code><code class="p">;</code>
        <code class="k">return</code> <code class="nx">parent</code><code class="p">.[[</code><code class="nx">Get</code><code class="p">]](</code><code class="nx">propKey</code><code class="p">,</code> <code class="nx">receiver</code><code class="p">);</code> <code class="c1">// (A)</code>
    <code class="p">}</code>
    <code class="k">if</code> <code class="p">(</code><code class="s1">'value'</code> <code class="k">in</code> <code class="nx">desc</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">desc</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="kd">let</code> <code class="nx">getter</code> <code class="o">=</code> <code class="nx">desc</code><code class="p">.</code><code class="nx">get</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">getter</code> <code class="o">===</code> <code class="kc">undefined</code><code class="p">)</code> <code class="k">return</code> <code class="kc">undefined</code><code class="p">;</code>
    <code class="k">return</code> <code class="nx">getter</code><code class="p">.[[</code><code class="nx">Call</code><code class="p">]](</code><code class="nx">receiver</code><code class="p">,</code> <code class="p">[]);</code>
<code class="p">}</code>
</pre></div>

</div>

<p>The MOP methods called in this code are:</p>

<ul>
<li>
<code>[[GetOwnProperty]]</code> (trap <code>getOwnPropertyDescriptor</code>)</li>
  <li>
<code>[[GetPrototypeOf]]</code> (trap <code>getPrototypeOf</code>)</li>
  <li>
<code>[[Get]]</code> (trap <code>get</code>)</li>
  <li>
<code>[[Call]]</code> (trap <code>apply</code>)</li>
</ul>
<p>In line (A) you can see why proxies in a prototype chain find out about <code>get</code> if a property isn’t found in an “earlier” object: If there is no own property whose key is <code>propKey</code>, the search continues in the prototype <code>parent</code> of <code>this</code>.</p>

<p><strong>Fundamental versus derived operations.</strong> You can see that <code>[[Get]]</code> calls other MOP operations. Operations that do that are called <em>derived</em>. Operations that don’t depend on other operations are called <em>fundamental</em>.</p>

<h5 id="leanpub-auto-the-mop-of-proxies">
<span class="section-number">27.5.4.1 </span>The MOP of proxies</h5>

<p>The <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-proxy-object-internal-methods-and-internal-slots">meta object protocol of proxies</a> is different from that of normal objects. For normal objects, derived operations call other operations. For proxies, each operation (regardless of whether it is fundamental or derived) is either intercepted by a handler method or forwarded to the target.</p>

<p>What operations should be interceptable via proxies? One possibility is to only provide traps for fundamental operations. The alternative is to include some derived operations. The advantage of doing so is that it increases performance and is more convenient. For example, if there weren’t a trap for <code>get</code>, you’d have to implement its functionality via <code>getOwnPropertyDescriptor</code>. One problem with derived traps is that they can lead to proxies behaving inconsistently. For example, <code>get</code> may return a value that is different from the value in the descriptor returned by <code>getOwnPropertyDescriptor</code>.</p>

<h5 id="leanpub-auto-selective-intercession-what-operations-should-be-interceptable">
<span class="section-number">27.5.4.2 </span>Selective intercession: what operations should be interceptable?</h5>

<p>Intercession by proxies is <em>selective</em>: you can’t intercept every language operation. Why were some operations excluded? Let’s look at two reasons.</p>

<p>First, stable operations are not well suited for intercession. An operation is <em>stable</em> if it always produces the same results for the same arguments. If a proxy can trap a stable operation, it can become unstable and thus unreliable. <a href="http://speakingjs.com/es5/ch09.html#_strict_equality">Strict equality</a> (<code>===</code>) is one such stable operation. It can’t be trapped and its result is computed by treating the proxy itself as just another object. Another way of maintaining stability is by applying an operation to the target instead of the proxy. As explained later, when we look at how invariants are enfored for proxies, this happens when <code>Object.getPrototypeOf()</code> is applied to a proxy whose target is non-extensible.</p>

<p>A second reason for not making more operations interceptable is that intercession means executing custom code in situations where that normally isn’t possible. The more this interleaving of code happens, the harder it is to understand and debug a program. It also affects performance negatively.</p>

<h5 id="leanpub-auto-traps-get-versus-invoke">
<span class="section-number">27.5.4.3 </span>Traps: <code>get</code> versus <code>invoke</code>
</h5>

<p>If you want to create virtual methods via ECMAScript 6 proxies, you have to return functions from a <code>get</code> trap. That raises the question: why not introduce an extra trap for method invocations (e.g. <code>invoke</code>)? That would enable us to distinguish between:</p>

<ul>
<li>Getting properties via <code>obj.prop</code> (trap <code>get</code>)</li>
  <li>Invoking methods via <code>obj.prop()</code> (trap <code>invoke</code>)</li>
</ul>
<p>There are two reasons for not doing so.</p>

<p>First, not all implementations distinguish between <code>get</code> and <code>invoke</code>. For example, <a href="https://mail.mozilla.org/pipermail/es-discuss/2010-May/011062.html">Apple’s JavaScriptCore doesn’t</a>.</p>

<p>Second, extracting a method and invoking it later via <code>call()</code> or <code>apply()</code> should have the same effect as invoking the method via dispatch. In other words, the following two variants should work equivalently. If there was an extra trap <code>invoke</code> then that equivalence would be harder to maintain.</p>

<div class="code-block">
<div class="highlight"><pre><code class="c1">// Variant 1: call via dynamic dispatch</code>
<code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">m</code><code class="p">();</code>

<code class="c1">// Variant 2: extract and call directly</code>
<code class="kd">let</code> <code class="nx">m</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">m</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">m</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>
</pre></div>

</div>

<h6 id="leanpub-auto-use-cases-for-invoke">
<span class="section-number">27.5.4.3.1 </span>Use cases for <code>invoke</code>
</h6>

<p>Some things can only be done if you are able to distinguish between <code>get</code> and <code>invoke</code>. Those things are therefore impossible with the current proxy API. Two examples are: auto-binding and intercepting missing methods. Let’s examine how one would implement them if proxies supported <code>invoke</code>.</p>

<p><strong>Auto-binding.</strong> By making a proxy the prototype of an object <code>obj</code>, you can automatically bind methods:</p>

<ul>
<li>Retrieving the value of a method <code>m</code> via <code>obj.m</code> returns a function whose <code>this</code> is bound to <code>obj</code>.</li>
  <li>
<code>obj.m()</code> performs a method call.</li>
</ul>
<p>Auto-binding helps with using methods as callbacks. For example, variant 2 from the previous example becomes simpler:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">boundMethod</code> <code class="o">=</code> <code class="nx">obj</code><code class="p">.</code><code class="nx">m</code><code class="p">;</code>
<code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">boundMethod</code><code class="p">();</code>
</pre></div>

</div>

<p><strong>Intercepting missing methods.</strong> <code>invoke</code> lets a proxy emulate the previously mentioned <code>__noSuchMethod__</code> mechanism that Firefox supports. The proxy would again become the prototype of an object <code>obj</code>. It would react differently depending on how an unknown property <code>foo</code> is accessed:</p>

<ul>
<li>If you read that property via <code>obj.foo</code>, no intercession happens and <code>undefined</code> is returned.</li>
  <li>If you make the method call <code>obj.foo()</code> then the proxy intercepts and, e.g., notifies a callback.</li>
</ul>
<h4 id="leanpub-auto-enforcing-invariants-for-proxies">
<span class="section-number">27.5.5 </span>Enforcing invariants for proxies</h4>

<p>Before we look at what invariants are and how they are enforced for proxies, let’s review how objects can be protected via non-extensibility and non-configurability.</p>

<h5 id="leanpub-auto-protecting-objects">
<span class="section-number">27.5.5.1 </span>Protecting objects</h5>

<p>There are two ways of protecting objects:</p>

<ul>
<li>Non-extensibility protects objects</li>
  <li>Non-configurability protects properties (or rather, their attributes)</li>
</ul>
<p><strong>Non-extensibility.</strong> If an object is non-extensible, you can’t add properties and you can’t change its prototype:</p>

<div class="code-block">
<div class="highlight"><pre><code class="s1">'use strict'</code><code class="p">;</code> <code class="c1">// switch on strict mode to get TypeErrors</code>

<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">preventExtensions</code><code class="p">({});</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">Object</code><code class="p">.</code><code class="nx">isExtensible</code><code class="p">(</code><code class="nx">obj</code><code class="p">));</code> <code class="c1">// false</code>
<code class="nx">obj</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="mi">123</code><code class="p">;</code> <code class="c1">// TypeError: object is not extensible</code>
<code class="nb">Object</code><code class="p">.</code><code class="nx">setPrototypeOf</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="kc">null</code><code class="p">);</code> <code class="c1">// TypeError: object is not extensible</code>
</pre></div>

</div>

<p><strong>Non-configurability.</strong> All the data of a property is stored in <em>attributes</em>. A property is like a record and attributes are like the fields of that record. Examples of attributes:</p>

<ul>
<li>The attribute <code>value</code> holds the value of a property.</li>
  <li>The boolean attribute <code>writable</code> controls whether a property’s value can be changed.</li>
  <li>The boolean attribute <code>configurable</code> controls whether a property’s attributes can be changed.</li>
</ul>
<p>Thus, if a property is both non-writable and non-configurable, it is read-only and remains that way:</p>

<div class="code-block">
<div class="highlight"><pre><code class="s1">'use strict'</code><code class="p">;</code> <code class="c1">// switch on strict mode to get TypeErrors</code>

<code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{};</code>
<code class="nb">Object</code><code class="p">.</code><code class="nx">defineProperty</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="s1">'foo'</code><code class="p">,</code> <code class="p">{</code>
    <code class="nx">value</code><code class="o">:</code> <code class="mi">123</code><code class="p">,</code>
    <code class="nx">writable</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="nx">configurable</code><code class="o">:</code> <code class="kc">false</code>
<code class="p">});</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">foo</code><code class="p">);</code> <code class="c1">// 123</code>
<code class="nx">obj</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="s1">'a'</code><code class="p">;</code> <code class="c1">// TypeError: Cannot assign to read only property</code>

<code class="nb">Object</code><code class="p">.</code><code class="nx">defineProperty</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="s1">'foo'</code><code class="p">,</code> <code class="p">{</code>
    <code class="nx">configurable</code><code class="o">:</code> <code class="kc">true</code>
<code class="p">});</code> <code class="c1">// TypeError: Cannot redefine property</code>
</pre></div>

</div>

<p>For more details on these topics (including how <code>Object.defineProperty()</code> works) consult the following sections in “Speaking JavaScript”:</p>

<ul>
<li><a href="http://speakingjs.com/es5/ch17.html#property_attributes">Property Attributes and Property Descriptors</a></li>
  <li><a href="http://speakingjs.com/es5/ch17.html#protecting_objects">Protecting Objects</a></li>
</ul>
<h5 id="leanpub-auto-enforcing-invariants">
<span class="section-number">27.5.5.2 </span>Enforcing invariants</h5>

<p>Traditionally, non-extensibility and non-configurability are:</p>

<ul>
<li>Universal: they work for all objects.</li>
  <li>Monotonic: once switched on, they can’t be switched off again.</li>
</ul>
<p>These and other characteristics that remain unchanged in the face of language operations are called <em>invariants</em>. With proxies, it is easy to violate invariants, as they are not intrinsically bound by non-extensibility etc.</p>

<p>The proxy API prevents proxies from violating invariants by checking the parameters and results of handler methods. The following are four examples of invariants (for an arbitrary object <code>obj</code>) and how they are enforced for proxies (an exhaustive list is given at the end of this chapter).</p>

<p>The first two invariants involve non-extensibility and non-configurability. These are enforced by using the target object for bookkeeping: results returned by handler methods have to be mostly in sync with the target object.</p>

<ul>
<li>Invariant: If <code>Object.preventExtensions(obj)</code> returns <code>true</code> then all future calls must return <code>false</code> and <code>obj</code> must now be non-extensible.
    <ul>
<li>Enforced for proxies by throwing a <code>TypeError</code> if the handler returns <code>true</code>, but the target object is not extensible.</li>
    </ul>
</li>
  <li>Invariant: Once an object has been made non-extensible, <code>Object.isExtensible(obj)</code> must always return <code>false</code>.
    <ul>
<li>Enforced for proxies by throwing a <code>TypeError</code> if the result returned by the handler is not the same (after coercion) as <code>Object.isExtensible(target)</code>.</li>
    </ul>
</li>
</ul>
<p>The remaining two invariants are enforced by checking return values:</p>

<ul>
<li>Invariant: <code>Object.isExtensible(obj)</code> must return a boolean.
    <ul>
<li>Enforced for proxies by coercing the value returned by the handler to a boolean.</li>
    </ul>
</li>
  <li>Invariant: <code>Object.getOwnPropertyDescriptor(obj, ···)</code> must return an object or <code>undefined</code>.
    <ul>
<li>Enforced for proxies by throwing a <code>TypeError</code> if the handler doesn’t return an appropriate value.</li>
    </ul>
</li>
</ul>
<p>Enforcing invariants has the following benefits:</p>

<ul>
<li>Proxies work like all other objects with regard to extensibility and configurability. Therefore, universality is maintained. This is achieved without preventing proxies from virtualizing (impersonating) protected objects.</li>
  <li>A protected object can’t be misrepresented by wrapping a proxy around it. Misrepresentation can be caused by bugs or by malicious code.</li>
</ul>
<p>The next two sections give examples of invariants being enforced.</p>

<h5 id="leanpub-auto-example-the-prototype-of-a-non-extensible-target-must-be-represented-faithfully">
<span class="section-number">27.5.5.3 </span>Example: the prototype of a non-extensible target must be represented faithfully</h5>

<p>In response to the <code>getPrototypeOf</code> trap, the proxy must return the target’s prototype if the target is non-extensible.</p>

<p>To demonstrate this invariant, let’s create a handler that returns a prototype that is different from the target’s prototype:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">fakeProto</code> <code class="o">=</code> <code class="p">{};</code>
<code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">getPrototypeOf</code><code class="p">(</code><code class="nx">t</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">fakeProto</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
</pre></div>

</div>

<p>Faking the prototype works if the target is extensible:</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">extensibleTarget</code> <code class="o">=</code> <code class="p">{};</code>
<code class="kd">let</code> <code class="nx">ext</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">extensibleTarget</code><code class="p">,</code> <code class="nx">handler</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">Object</code><code class="p">.</code><code class="nx">getPrototypeOf</code><code class="p">(</code><code class="nx">ext</code><code class="p">)</code> <code class="o">===</code> <code class="nx">fakeProto</code><code class="p">);</code> <code class="c1">// true</code>
</pre></div>

</div>

<p>We do, however, get an error if we fake the prototype for a non-extensible object.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">nonExtensibleTarget</code> <code class="o">=</code> <code class="p">{};</code>
<code class="nb">Object</code><code class="p">.</code><code class="nx">preventExtensions</code><code class="p">(</code><code class="nx">nonExtensibleTarget</code><code class="p">);</code>
<code class="kd">let</code> <code class="nx">nonExt</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">nonExtensibleTarget</code><code class="p">,</code> <code class="nx">handler</code><code class="p">);</code>
<code class="nb">Object</code><code class="p">.</code><code class="nx">getPrototypeOf</code><code class="p">(</code><code class="nx">nonExt</code><code class="p">);</code> <code class="c1">// TypeError</code>
</pre></div>

</div>

<h5 id="leanpub-auto-example-non-writable-non-configurable-target-properties-must-be-represented-faithfully">
<span class="section-number">27.5.5.4 </span>Example: non-writable non-configurable target properties must be represented faithfully</h5>

<p>If the target has a non-writable non-configurable property then the handler must return that property’s value in response to a <code>get</code> trap. To demonstrate this invariant, let’s create a handler that always returns the same value for properties.</p>

<div class="code-block">
<div class="highlight"><pre><code class="kd">let</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">get</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">propKey</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="s1">'abc'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>
<code class="kd">let</code> <code class="nx">target</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">defineProperties</code><code class="p">(</code>
    <code class="p">{},</code> <code class="p">{</code>
        <code class="nx">foo</code><code class="o">:</code> <code class="p">{</code>
            <code class="nx">value</code><code class="o">:</code> <code class="mi">123</code><code class="p">,</code>
            <code class="nx">writable</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
            <code class="nx">configurable</code><code class="o">:</code> <code class="kc">true</code>
        <code class="p">},</code>
        <code class="nx">bar</code><code class="o">:</code> <code class="p">{</code>
            <code class="nx">value</code><code class="o">:</code> <code class="mi">456</code><code class="p">,</code>
            <code class="nx">writable</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="nx">configurable</code><code class="o">:</code> <code class="kc">false</code>
        <code class="p">},</code>
    <code class="p">});</code>
<code class="kd">let</code> <code class="nx">proxy</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Proxy</code><code class="p">(</code><code class="nx">target</code><code class="p">,</code> <code class="nx">handler</code><code class="p">);</code>
</pre></div>

</div>

<p>Property <code>target.foo</code> is not both non-writable and non-configurable, which means that the handler is allowed to pretend that it has a different value:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">proxy</code><code class="p">.</code><code class="n">foo</code>
<code class="err">'</code><code class="n">abc</code><code class="err">'</code>
</pre></div>

</div>

<p>However, property <code>target.bar</code> is both non-writable and non-configurable. Therefore, we can’t fake its value:</p>

<div class="code-block">
<div class="highlight"><pre><code class="o">&gt;</code> <code class="n">proxy</code><code class="p">.</code><code class="n">bar</code>
<code class="nl">TypeError:</code> <code class="n">Invariant</code> <code class="n">check</code> <code class="n">failed</code>
</pre></div>

</div>


<h3 id="sec_reference-proxy-api">
<span class="section-number">27.6 </span>Reference: the proxy API</h3>

<p>This section serves as a quick reference for the proxy API: the global objects <code>Proxy</code> and <code>Reflect</code>.</p>

<h4 id="leanpub-auto-creating-proxies">
<span class="section-number">27.6.1 </span>Creating proxies</h4>

<p>There are two ways to create proxies:</p>

<ul>
<li>
<code>let proxy = new Proxy(target, handler)</code><br>
Creates a new proxy object with the given target and the given handler.</li>
  <li>
<code>let {proxy, revoke} = Proxy.revocable(target, handler)</code><br>
Creates a proxy that can be revoked via the function <code>revoke</code>. <code>revoke</code> can be called multiple times, but only the first call has an effect and switches <code>proxy</code> off. Afterwards, any operation performed on <code>proxy</code> leads to a <code>TypeError</code> being thrown.</li>
</ul>
<h4 id="leanpub-auto-handler-methods">
<span class="section-number">27.6.2 </span>Handler methods</h4>

<p>This subsection explains what traps can be implemented by handlers and what operations trigger them. Several traps return boolean values. For the traps <code>has</code> and <code>isExtensible</code>, the boolean is the result of the operation. For all other traps, the boolean indicates whether the operation succeeded or not.</p>

<p>Traps for all objects:</p>

<ul>
<li>
<code>defineProperty(target, propKey, propDesc) : boolean</code>
    <ul>
<li><code>Object.defineProperty(proxy, propKey, propDesc)</code></li>
    </ul>
</li>
  <li>
<code>deleteProperty(target, propKey) : boolean</code>
    <ul>
<li><code>delete proxy[propKey]</code></li>
      <li><code>delete proxy.foo // propKey = 'foo'</code></li>
    </ul>
</li>
  <li>
<code>enumerate(target) : Iterator</code>
    <ul>
<li><code>for (x in proxy) ···</code></li>
    </ul>
</li>
  <li>
<code>get(target, propKey, receiver) : any</code>
    <ul>
<li><code>receiver[propKey]</code></li>
      <li><code>receiver.foo // propKey = 'foo'</code></li>
    </ul>
</li>
  <li>
<code>getOwnPropertyDescriptor(target, propKey) : PropDesc|Undefined</code>
    <ul>
<li><code>Object.getOwnPropertyDescriptor(proxy, propKey)</code></li>
    </ul>
</li>
  <li>
<code>getPrototypeOf(target) : Object|Null</code>
    <ul>
<li><code>Object.getPrototypeOf(proxy)</code></li>
    </ul>
</li>
  <li>
<code>has(target, propKey) : boolean</code>
    <ul>
<li><code>propKey in proxy</code></li>
    </ul>
</li>
  <li>
<code>isExtensible(target) : boolean</code>
    <ul>
<li><code>Object.isExtensible(proxy)</code></li>
    </ul>
</li>
  <li>
<code>ownKeys(target) : Array&lt;PropertyKey&gt;</code>
    <ul>
<li>
<code>Object.getOwnPropertyPropertyNames(proxy)</code> (only uses string-valued keys)</li>
      <li>
<code>Object.getOwnPropertyPropertySymbols(proxy)</code> (only uses symbol-valued keys)</li>
      <li>
<code>Object.keys(proxy)</code> (only uses enumerable string-valued keys; enumerability is checked via <code>Object.getOwnPropertyDescriptor</code>)</li>
    </ul>
</li>
  <li>
<code>preventExtensions(target) : boolean</code>
    <ul>
<li><code>Object.preventExtensions(proxy)</code></li>
    </ul>
</li>
  <li>
<code>set(target, propKey, value, receiver) : boolean</code>
    <ul>
<li><code>receiver[propKey] = value</code></li>
      <li><code>receiver.foo = value // propKey = 'foo'</code></li>
    </ul>
</li>
  <li>
<code>setPrototypeOf(target, proto) : boolean</code>
    <ul>
<li><code>Object.setPrototypeOf(proxy, proto)</code></li>
    </ul>
</li>
</ul>
<p>Traps for functions (available if target is a function):</p>

<ul>
<li>
<code>apply(target, thisArgument, argumentsList) : any</code>
    <ul>
<li><code>proxy.apply(thisArgument, argumentsList)</code></li>
      <li><code>proxy.call(thisArgument, ...argumentsList)</code></li>
      <li><code>proxy(...argumentsList)</code></li>
    </ul>
</li>
  <li>
<code>construct(target, argumentsList) : Object</code>
    <ul>
<li><code>new proxy(..argumentsList)</code></li>
    </ul>
</li>
</ul>
<h5 id="leanpub-auto-fundamental-operations-versus-derived-operations">
<span class="section-number">27.6.2.1 </span>Fundamental operations versus derived operations</h5>

<p>The following operations are <em>fundamental</em>, they don’t use other operations to do their work: <code>apply</code>, <code>defineProperty</code>, <code>deleteProperty</code>, <code>getOwnPropertyDescriptor</code>, <code>getPrototypeOf</code>, <code>isExtensible</code>, <code>ownKeys</code>, <code>preventExtensions</code>, <code>setPrototypeOf</code></p>

<p>All other operations are <em>derived</em>, they can be implemented via fundamental operations. For example, for data properties, <code>get</code> can be implemented by iterating over the prototype chain via <code>getPrototypeOf</code> and calling <code>getOwnPropertyDescriptor</code> for each chain member until either an own property is found or the chain ends.</p>

<h4 id="leanpub-auto-invariants-of-handler-methods">
<span class="section-number">27.6.3 </span>Invariants of handler methods</h4>

<p>Invariants are safety constraints for handlers. This subsection documents what invariants are enforced by the proxy API and how. Whenever you read “the handler must do X” below, it means that a <code>TypeError</code> is thrown if it doesn’t. Some invariants restrict return values, others restrict parameters. The correctness of a trap’s return value is ensured in two ways: Normally, an illegal value means that a <code>TypeError</code> is thrown. But whenever a boolean is expected, coercion is used to convert non-booleans to legal values.</p>

<p>This is the complete list of invariants that are enforced:</p>

<ul>
<li>
<code>apply(target, thisArgument, argumentsList)</code>
    <ul>
<li>No invariants are enforced.</li>
    </ul>
</li>
  <li>
<code>construct(target, argumentsList)</code>
    <ul>
<li>The result returned by the handler must be an object (not <code>null</code> or a primitive value).</li>
    </ul>
</li>
  <li>
<code>defineProperty(target, propKey, propDesc)</code>
    <ul>
<li>If the target is not extensible then you can’t add properties and <code>propKey</code> must be one of the own keys of the target.</li>
      <li>If <code>propDesc</code> sets the attribute <code>configurable</code> to <code>false</code> then the target must have a non-configurable own property whose key is <code>propKey</code>.</li>
      <li>If <code>propDesc</code> were to be used to (re)define an own property for the target then that must not cause an exception. An exception is thrown if a change is forbidden by the attributes <code>writable</code> and <code>configurable</code> (non-extensibility is handled by the first rule).</li>
    </ul>
</li>
  <li>
<code>deleteProperty(target, propKey)</code>
    <ul>
<li>Non-configurable own properties of the target can’t be deleted.</li>
    </ul>
</li>
  <li>
<code>enumerate(target)</code>
    <ul>
<li>The handler must return an object.</li>
    </ul>
</li>
  <li>
<code>get(target, propKey, receiver)</code>
    <ul>
<li>If the target has an own, non-writable, non-configurable data property whose key is <code>propKey</code> then the handler must return that property’s value.</li>
      <li>If the target has an own, non-configurable, getter-less accessor property then the handler must return <code>undefined</code>.</li>
    </ul>
</li>
  <li>
<code>getOwnPropertyDescriptor(target, propKey)</code>
    <ul>
<li>The handler must return either an object or <code>undefined</code>.</li>
      <li>Non-configurable own properties of the target can’t be reported as non-existent by the handler.</li>
      <li>If the target is non-extensible then exactly the target’s own properties must be reported by the handler as existing.</li>
      <li>If the handler reports a property as non-configurable then that property must be a non-configurable own property of the target.</li>
      <li>If the result returned by the handler were used to (re)define an own property for the target then that must not cause an exception. An exception is thrown if the change is not allowed by the attributes <code>writable</code> and <code>configurable</code> (non-extensibility is handled by the third rule). Therefore, the handler can’t report a non-configurable property as configurable and it can’t report a different value for a non-configurable non-writable property.</li>
    </ul>
</li>
  <li>
<code>getPrototypeOf(target)</code>
    <ul>
<li>The result must be either an object or <code>null</code>.</li>
      <li>If the target object is not extensible then the handler must return the prototype of the target object.</li>
    </ul>
</li>
  <li>
<code>has(target, propKey)</code>
    <ul>
<li>A handler must not hide (report as non-existent) a non-configurable own property of the target.</li>
      <li>If the target is non-extensible then no own property of the target may be hidden.</li>
    </ul>
</li>
  <li>
<code>isExtensible(target)</code>
    <ul>
<li>The result returned by the handler is coerced to boolean.</li>
      <li>After coercion to boolean, the value returned by the handler must be the same as <code>target.isExtensible()</code>.</li>
    </ul>
</li>
  <li>
<code>ownKeys(target)</code>
    <ul>
<li>The handler must return an object, which treated as Array-like and converted into an Array.</li>
      <li>Each element of the result must be either a string or a symbol.</li>
      <li>The result must contain the keys of all non-configurable own properties of the target.</li>
      <li>If the target is not extensible then the result must contain exactly the keys of the own properties of the target (and no other values).</li>
    </ul>
</li>
  <li>
<code>preventExtensions(target)</code>
    <ul>
<li>The result returned by the handler is coerced to boolean.</li>
      <li>If the handler returns a truthy value (indicating a successful change) then <code>target.isExtensible()</code> must be <code>false</code> afterwards.</li>
    </ul>
</li>
  <li>
<code>set(target, propKey, value, receiver)</code>
    <ul>
<li>If the target has an own, non-writable, non-configurable data property whose key is <code>propKey</code> then <code>value</code> must be the same as the value of that property (i.e., the property can’t be changed).</li>
      <li>If the target has an own, non-configurable, setter-less accessor property then a <code>TypeError</code> is thrown (i.e., such a property can’t be set).</li>
    </ul>
</li>
  <li>
<code>setPrototypeOf(target, proto)</code>
    <ul>
<li>The result returned by the handler is coerced to boolean.</li>
      <li>If the target is not extensible, the prototype can’t be changed. This is enforced as follows: If the target is not extensible and the handler returns a truthy value (indicating a successful change) then <code>proto</code> must be the same as the prototype of the target. Otherwise, a <code>TypeError</code> is thrown.</li>
    </ul>
</li>
</ul>
<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>In the spec, the invariants are listed in the section “<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-proxy-object-internal-methods-and-internal-slots">Proxy Object Internal Methods and Internal Slots</a>”.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-operations-that-affect-the-prototype-chain">
<span class="section-number">27.6.4 </span>Operations that affect the prototype chain</h4>

<p>The following operations of normal objects perform operations on objects in the prototype chain. Therefore, if one of the objects in that chain is a proxy, its traps are triggered. The specification implements the operations as internal own methods (that are not visible to JavaScript code). But in this section, we pretend that they are normal methods that have the same names as the traps. The parameter <code>target</code> becomes the receiver of the method call.</p>

<ul>
<li>
<code>target.enumerate()</code><br>
  Traverses the prototype chain of <code>target</code> via <code>getPrototypeOf</code>. Per object, it retrieves the keys via <code>ownKeys</code> and examines whether a property is enumerable via <code>getOwnPropertyDescriptor</code>.</li>
  <li>
<code>target.get(propertyKey, receiver)</code><br>
  If <code>target</code> has no own property with the given key, <code>get</code> is invoked on the prototype of <code>target</code>.</li>
  <li>
<code>target.has(propertyKey)</code><br>
  Similarly to <code>get</code>, <code>has</code> is invoked on the prototype of <code>target</code> if <code>target</code> has no own property with the given key.</li>
  <li>
<code>target.set(propertyKey, value, receiver)</code><br>
  Similarly to <code>get</code>, <code>set</code> is invoked on the prototype of <code>target</code> if <code>target</code> has no own property with the given key.</li>
</ul>
<p>All other operations only affect own properties, they have no effect on the prototype chain.</p>

<table class="generic_inbar sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="./Read Exploring ES6 _ Leanpub_files/leanpub_gears.png" alt="generic_inbar" width="50">
</td>
    <td>
      <p>In the spec, these (and other) operations are described in the section “<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-ordinary-object-internal-methods-and-internal-slots">Ordinary Object Internal Methods and Internal Slots</a>”.</p>

    </td>
  </tr></tbody></table>
<h4 id="leanpub-auto-reflect">
<span class="section-number">27.6.5 </span>Reflect</h4>

<p>The global object <code>Reflect</code> implements all interceptable operations of the JavaScript meta object protocol as methods. The names of those methods are the same as those of the handler methods, which, <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_forwarding-intercepted-operations">as we have seen</a>, helps with forwarding operations from the handler to the target.</p>

<ul>
<li>
<code>Reflect.apply(target, thisArgument, argumentsList) : any</code><br>
  Same as <code>Function.prototype.apply()</code>.</li>
  <li>
<code>Reflect.construct(target, argumentsList, newTarget=target) : Object</code><br>
  The <code>new</code> operator as a function. <code>target</code> is the constructor to invoke, the optional parameter <code>newTarget</code> points to the constructor that started the current chain of constructor calls. More information on how constructor calls are chained in ES6 is given in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_allocating-and-initializing-instances">the chapter on classes</a>.</li>
  <li>
<code>Reflect.defineProperty(target, propertyKey, propDesc) : boolean</code><br>
  Similar to <code>Object.defineProperty()</code>.</li>
  <li>
<code>Reflect.deleteProperty(target, propertyKey) : boolean</code><br>
  The <code>delete</code> operator as a function.</li>
  <li>
<code>Reflect.enumerate(target) : Iterator</code><br>
  Returns an iterater over all (own and inherited) enumerable string property keys of <code>target</code>. In other words, the iterator returns all values that the <code>for-in</code> loop would iterate over.</li>
  <li>
<code>Reflect.get(target, propertyKey, receiver=target) : any</code><br>
  A function that gets properties. The optional parameter <code>receiver</code> is needed when <code>get</code> reaches a getter later in the prototype chain. Then it provides the value for <code>this</code>.</li>
  <li>
<code>Reflect.getOwnPropertyDescriptor(target, propertyKey) : PropDesc|Undefined</code><br>
  Same as <code>Object.getOwnPropertyDescriptor()</code>.</li>
  <li>
<code>Reflect.getPrototypeOf(target) : Object|Null</code><br>
  Same as <code>Object.getPrototypeOf()</code>.</li>
  <li>
<code>Reflect.has(target, propertyKey) : boolean</code><br>
  The <code>in</code> operator as a function.</li>
  <li>
<code>Reflect.isExtensible(target) : boolean</code><br>
  Same as <code>Object.isExtensible()</code>.</li>
  <li>
<code>Reflect.ownKeys(target) : Array&lt;PropertyKey&gt;</code><br>
  Returns all own property keys (strings and symbols!) in an Array.</li>
  <li>
<code>Reflect.preventExtensions(target) : boolean</code><br>
  Similar to <code>Object.preventExtensions()</code>.</li>
  <li>
<code>Reflect.set(target, propertyKey, value, receiver?) : boolean</code><br>
  A function that sets properties.</li>
  <li>
<code>Reflect.setPrototypeOf(target, proto) : boolean</code><br>
  The new standard way of setting the prototype of an object. The current non-standard way, that works in most engines, is to set the special property <code>__proto__</code>.</li>
</ul>
<p>Several methods have boolean results. For <code>has</code> and <code>isExtensible</code>, they are the results of the operation. For the remaining methods, they indicate whether the operation succeeded.</p>

<p>Apart from forwarding operations, <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_proxies_ref_4">why is <code>Reflect</code> useful [4]</a>?</p>

<ul>
<li>Different return values: <code>Reflect</code> duplicates the following methods of <code>Object</code>, but its methods return booleans indicating whether the operation succeeded (where the <code>Object</code> methods return the object that was modified).
    <ul>
<li><code>Object.defineProperty(obj, propKey, propDesc) : Object</code></li>
      <li><code>Object.preventExtensions(obj) : Object</code></li>
      <li><code>Object.setPrototypeOf(obj, proto) : Object</code></li>
    </ul>
</li>
  <li>Operators as functions: The following <code>Reflect</code> methods implement functionality that is otherwise only available via operators:
    <ul>
<li><code>Reflect.construct(target, argumentsList, newTarget?) : Object</code></li>
      <li><code>Reflect.deleteProperty(target, propertyKey) : boolean</code></li>
      <li><code>Reflect.get(target, propertyKey, receiver?) : any</code></li>
      <li><code>Reflect.has(target, propertyKey) : boolean</code></li>
      <li><code>Reflect.set(target, propertyKey, value, receiver?) : boolean</code></li>
    </ul>
</li>
  <li>The <code>for-in</code> loop as an iterator: This is rarely useful, but if you need it, you can get an iterator over all enumerable (own and inherited) string property keys of an object.
    <ul>
<li><code>Reflect.enumerate(target) : Iterator</code></li>
    </ul>
</li>
  <li>Shorter version of <code>apply</code>: The only safe way to invoke the built-in function method <code>apply</code> is via:
    <div class="code-block">
<div class="highlight"><pre>  <code class="nb">Function</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">apply</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">func</code><code class="p">,</code> <code class="nx">thisArg</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code>
</pre></div>
    
</div>

    <p>Using <code>Reflect.apply()</code> is cleaner and shorter:</p>

    <div class="code-block">
<div class="highlight"><pre>  <code class="nx">Reflect</code><code class="p">.</code><code class="nx">apply</code><code class="p">(</code><code class="nx">func</code><code class="p">,</code> <code class="nx">thisArg</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code>
</pre></div>
    
</div>
  </li>
</ul>
<h3 id="leanpub-auto-conclusion-3">
<span class="section-number">27.7 </span>Conclusion</h3>

<p>This concludes our in-depth look at the proxy API. For each application, you have to take performance into consideration and – if necessary – measure. Proxies may not always be fast enough. On the other hand, performance is often not crucial and it is nice to have the meta programming power that proxies give us. As we have seen, there are numerous use cases they can help with.</p>


<h3 id="leanpub-auto-further-reading-7">
<span class="section-number">27.8 </span>Further reading</h3>

<p id="ch_proxies_ref_1">[1] “<a href="http://soft.vub.ac.be/Publications/2012/vub-soft-tr-12-03.pdf">On the design of the ECMAScript Reflection API</a>” by Tom Van Cutsem and Mark Miller. Technical report, 2012. [Important source of this chapter.]</p>

<p id="ch_proxies_ref_2">[2] “<a href="http://mitpress.mit.edu/books/art-metaobject-protocol">The Art of the Metaobject Protocol</a>” by Gregor Kiczales, Jim des Rivieres and Daniel G. Bobrow. Book, 1991.</p>

<p id="ch_proxies_ref_3">[3] “<a href="http://www.pearsonhighered.com/educator/product/Putting-Metaclasses-to-Work-A-New-Dimension-in-ObjectOriented-Programming/9780201433050.page">Putting Metaclasses to Work: A New Dimension in Object-Oriented Programming</a>” by Ira R. Forman and Scott H. Danforth. Book, 1999.</p>

<p id="ch_proxies_ref_4">[4] “<a href="https://github.com/tvcutsem/harmony-reflect/wiki">Harmony-reflect: Why should I use this library?</a>” by Tom Van Cutsem. [Explains why <code>Reflect</code> is useful.]</p>

<h2 id="leanpub-auto-coding-style-tips-for-ecmascript-6">
<span class="section-number">28. </span>Coding style tips for ECMAScript 6</h2>

<p>This chapter lists a few ideas related to ES6 coding style:</p>

<ul>
<li>
<code>var</code> versus <code>let</code> versus <code>const</code> (details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#var-vs-let-vs-const">the chapter on variables</a>)
    <ul>
<li>Use <code>const</code> only for things that are completely immutable: mutable objects aren’t, but primitives and (completely) frozen objects are.</li>
      <li>Use <code>let</code> for all other things.</li>
      <li>Avoid <code>var</code>.</li>
    </ul>
</li>
  <li>Arrow functions work best if they fit into a single line:
    <div class="code-block">
<div class="highlight"><pre>  <code class="nx">readFilePromisified</code><code class="p">(</code><code class="nx">filename</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">text</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">text</code><code class="p">))</code>
</pre></div>
    
</div>

    <p>For multi-line functions, I often prefer traditional functions:</p>

    <div class="code-block">
<div class="highlight"><pre>  <code class="nx">readFilePromisified</code><code class="p">(</code><code class="nx">filename</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">text</code><code class="p">)</code> <code class="p">{</code>
      <code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">text</code><code class="p">);</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">4</code><code class="p">));</code>
  <code class="p">});</code>
</pre></div>
    
</div>

    <p>Single-line functions tend to be throw-away. If a function isn’t then a traditional function has the advantage that you can name it, which is useful for documentation and debugging.</p>
  </li>
  <li>Modules: don’t mix default exports and named exports. Your module should either specialize on a single thing or export multiple, named, things. Details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_mixing-named-and-default-exports">the chapter on modules</a>.</li>
  <li>Format generators as follows:
    <div class="code-block">
<div class="highlight"><pre>  <code class="c1">// Generator function declaration</code>
  <code class="kd">function</code><code class="o">*</code> <code class="nx">genFunc</code><code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>

  <code class="c1">// Generator function expression</code>
  <code class="kr">const</code> <code class="nx">genFunc</code> <code class="o">=</code> <code class="kd">function</code><code class="o">*</code> <code class="p">()</code> <code class="p">{</code> <code class="err">···</code> <code class="p">};</code>

  <code class="c1">// Generator method definition in an object literal</code>
  <code class="kd">let</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
      <code class="o">*</code> <code class="nx">generatorMethod</code><code class="p">()</code> <code class="p">{</code>
          <code class="err">···</code>
      <code class="p">}</code>
  <code class="p">};</code>

  <code class="c1">// Generator method definition in a class definition</code>
  <code class="kr">class</code> <code class="nx">MyClass</code> <code class="p">{</code>
      <code class="o">*</code> <code class="nx">generatorMethod</code><code class="p">()</code> <code class="p">{</code>
          <code class="err">···</code>
      <code class="p">}</code>
  <code class="p">}</code>
</pre></div>
    
</div>

    <p>Details are explained in <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_formating-generators">the chapter on generators</a>.</p>
  </li>
  <li>The chapter on parameter handling has <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_parameter-handling-style-tips">style tips for function signatures</a>:
    <div class="code-block">
<div class="highlight"><pre>  <code class="c1">// Mark optional parameters via the parameter default value `undefined`</code>
  <code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">optional</code> <code class="o">=</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>

  <code class="c1">// Mark required parameters via a function that throws an exception</code>
  <code class="kd">function</code> <code class="nx">foo</code><code class="p">(</code><code class="nx">required</code> <code class="o">=</code> <code class="nx">throwException</code><code class="p">())</code> <code class="p">{</code> <code class="err">···</code> <code class="p">}</code>

  <code class="c1">// Enforcing a maximum arity (variant 1 of 2)</code>
  <code class="kd">function</code> <code class="nx">f</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">,</code> <code class="p">...</code><code class="nx">empty</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// max arity: 2</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">empty</code><code class="p">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
      <code class="p">}</code>
  <code class="p">}</code>
  <code class="c1">// Enforcing a maximum arity (variant 2 of 2)</code>
  <code class="kd">function</code> <code class="nx">f</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// max arity: 2</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">arguments</code><code class="p">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
          <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">();</code>
      <code class="p">}</code>
  <code class="p">}</code>
</pre></div>
    
</div>
  </li>
  <li>
<a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#ch_callables">The whole chapter on callable entities</a> (traditional functions, arrow functions, classes, etc.) is about style tips: when to use which one, etc.</li>
  <li>Use classes: They are not perfect, but I still recommend to use them (where appropriate!), because they have several objective benefits. Details are explained <a href="https://leanpub.com/exploring-es6/read?utm_medium=email&utm_source=jsfiddle#sec_class-benefits">in the chapter on classes</a>.</li>
</ul>
<p>Additionally, the <a href="http://speakingjs.com/es5/ch26.html">ES5 coding style tips</a> in “Speaking JavaScript” are still relevant for ES6.</p>

<!-- begin backmatter -->
</div>


</div>
</div>
</div>

</div>

<footer id="footer">
<div class="large-container">
<h1 class="footer-logo">
<a href="https://leanpub.com/">Leanpub</a>
</h1>
<div class="footer-links">
<ul>
<li><a href="https://leanpub.com/causes">Causes</a></li>
<li><a href="https://leanpub.com/manifesto">Manifesto</a></li>
<li><a href="https://leanpub.com/terms">Terms of Service</a></li>
<li><a href="https://leanpub.com/privacy">Privacy Policy</a></li>
<li><a href="https://leanpub.com/takedown">Copyright Take Down Policy</a></li>
</ul>
<ul>
<li><a href="https://leanpub.com/buzz">Buzz</a></li>
<li><a href="http://blog.leanpub.com/">Blog</a></li>
<li><a href="https://leanpub.com/team">About</a></li>
<li><a href="https://leanpub.com/help">Help</a></li>
<li><a href="https://leanpub.com/contact">Contact Us</a></li>
</ul>
</div>
</div>
<p class="copyright">
Leanpub is copyright © 2010-2015 <a href="http://ruboss.com/">Ruboss</a>. <a href="mailto:hello@leanpub.com">Get in touch</a>!
</p>
</footer>


<script src="./Read Exploring ES6 _ Leanpub_files/application-40865eb805bba6e314e1631637270980.js" type="text/javascript"></script>
<script charset="utf-8" type="text/javascript">
<!-- /<!--[CDATA[ -->
var  royaltySliderShown = true;
<!-- /]]--> -->
</script>
<script>
  (function() {
    $(function() {
      return Leanpub.ShoppingCartController.initializeAddToCartModalButtons();
    });
  
  }).call(this);
</script>


</body></html>