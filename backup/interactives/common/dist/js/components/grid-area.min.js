!function(){"use strict";MathInteractives.Common.Components.Models.RatioBar=MathInteractives.Common.Player.Models.BaseInteractive.extend({defaults:{defaultColorOfRatioBar:"#A9A9A9",leftSideRatioCount:0,rightSideRatioCount:0,leftSideColor:"#0086A7",rightSideColor:"#CB3E87",widthOfRatioBar:270,heightOfRatioBar:15,ratioSeparatorLineWidth:3,ratioSeperatorLineColor:"#222",colorQuantLineWidth:1,colorQuantLineColor:"#222",ratioValue:null,leftSideWidth:null},getDefaultColorOfRatioBar:function(){return this.get("defaultColorOfRatioBar")},setDefaultColorOfRatioBar:function(a){this.set("defaultColorOfRatioBar",a)},getLeftSideColor:function(){return this.get("leftSideColor")},setLeftSideColor:function(a){this.set("leftSideColor",a)},getRightSideColor:function(){return this.get("rightSideColor")},setRightSideColor:function(a){this.set("rightSideColor",a)},getRatioSeperatorLineColor:function(){return this.get("ratioSeperatorLineColor")},setRatioSeperatorLineColor:function(a){this.set("ratioSeperatorLineColor",a)},getColorQuantLineColor:function(){return this.get("colorQuantLineColor")},setColorQuantLineColor:function(a){this.set("colorQuantLineColor",a)},getLeftSideRatioCount:function(){return this.get("leftSideRatioCount")},setLeftSideRatioCount:function(a){this.set("leftSideRatioCount",Number(a))},getRightSideRatioCount:function(){return this.get("rightSideRatioCount")},setRightSideRatioCount:function(a){this.set("rightSideRatioCount",Number(a))},getWidthOfRatioBar:function(){return this.get("widthOfRatioBar")},setWidthOfRatioBar:function(a){this.set("WidthOfRatioBar",Number(a))},getHeightOfRatioBar:function(){return this.get("heightOfRatioBar")},setHeightOfRatioBar:function(a){this.set("heightOfRatioBar",Number(a))},getRatioSeparatorLineWidth:function(){return this.get("ratioSeparatorLineWidth")},setRatioSeparatorLineWidth:function(a){this.set("ratioSeparatorLineWidth",Number(a))},getColorQuantLineWidth:function(){return this.get("colorQuantLineWidth")},setColorQuantLineWidth:function(a){this.set("colorQuantLineWidth",Number(a))},getRatioValue:function(){return this.get("ratioValue")},setRatioValue:function(a){this.set("ratioValue",Number(a))},getLeftSideWidth:function(){return this.get("leftSideWidth")},setLeftSideWidth:function(a){this.set("leftSideWidth",Number(a))},getBarType:function(){var a,b,c;return a=this.getLeftSideRatioCount(),b=this.getRightSideRatioCount(),c=MathInteractives.Common.Components.Models.RatioBar,a&&b?c.ratioBarTypes.twoRatioBar:a?c.ratioBarTypes.onlyLeftRatioBar:b?c.ratioBarTypes.onlyRightRatioBar:c.ratioBarTypes.defaultBar}},{ratioBarTypes:{defaultBar:"00",twoRatioBar:"11",onlyLeftRatioBar:"10",onlyRightRatioBar:"01"}})}(),function(){"use strict";MathInteractives.Common.Components.Views.RatioBar=MathInteractives.Common.Player.Views.Base.extend({colorSeparatorPosition:0,initialize:function(){this._attachEvents(),this._render()},_attachEvents:function(){var a=this.model;this.listenTo(a,"change",this._render)},_render:function(){if(this.$el){this.$(".ratio-bar-antecedent-divs").remove(),this.$(".ratio-bar-consequent-divs").remove(),this.$(".ratio-bar-separator").remove();var a=this.model,b=a.getWidthOfRatioBar(),c=a.getHeightOfRatioBar();this.$el.css({width:b,height:c}),this._createRatioBar(a.getBarType())}},_createRatioBar:function(a){var b,c,d,e,f,g,h,i=this.model,j=MathInteractives.Common.Components.Models.RatioBar,k=i.getDefaultColorOfRatioBar(),l=i.getLeftSideColor(),m=i.getRightSideColor(),n=i.getRatioSeperatorLineColor(),o=i.getColorQuantLineColor(),p=i.getLeftSideRatioCount(),q=i.getRightSideRatioCount(),r=i.getWidthOfRatioBar(),s=(i.getHeightOfRatioBar(),i.getRatioSeparatorLineWidth()),t=i.getColorQuantLineWidth();switch(a){case j.ratioBarTypes.defaultBar:this.$el.css({"background-color":k}),this.colorSeparatorPosition=0;break;case j.ratioBarTypes.onlyLeftRatioBar:for(b=r-t*(p-1),c=b%p,f=Math.floor(b/p),g=f+1,d=0;p>d;d++)h=d>p-c-1?g:f,e=$("<div></div>").addClass("ratio-bar-antecedent-divs").css({width:h,"border-right-width":t,"border-color":o,"background-color":l}).appendTo(this.$el),d===p-1&&e.css({"border-width":0});this.colorSeparatorPosition=r;break;case j.ratioBarTypes.onlyRightRatioBar:for(b=r-t*(q-1),c=b%q,f=Math.floor(b/q),g=f+1,d=0;q>d;d++)h=d>q-c-1?g:f,e=$("<div></div>").addClass("ratio-bar-consequent-divs").css({width:h,"border-right-width":t,"border-color":o,"background-color":m}).appendTo(this.$el),d===q-1&&e.css({"border-width":0});this.colorSeparatorPosition=0;break;case j.ratioBarTypes.twoRatioBar:var u,v=1,w=0,x=0,y=0,z=0,A=0,B=null,C=0,D=0,E=0,F=0;if(b=r-s,u=(p/q).toFixed(3),w=u*v,A=Math.floor(b/(w+v)*v),z=b-A,"undefined"!=typeof this.options.regulationModel){var G=this.options.regulationModel.getRatioValue(),H=this.options.regulationModel.getLeftSideWidth();H===z&&(u>G?A-=1:G>u&&(A+=1),z=b-A)}for(i.set("ratioValue",u,{silent:!0}),i.set("leftSideWidth",z,{silent:!0}),x=z%p,y=A%q,C=Math.floor(z/p),D=C+1,E=Math.floor(A/q),F=E+1,d=0;p>d;d++)h=d>p-x-1?D:C,B=0!==t&&d!==p-1?h-1:h,e=$("<div></div>").addClass("ratio-bar-antecedent-divs").css({width:B,"border-right-width":t,"border-color":o,"background-color":l}).appendTo(this.$el),d===p-1&&e.css({"border-width":0});for($("<div></div>").addClass("ratio-bar-separator").css({width:s,"background-color":n}).appendTo(this.$el),d=0;q>d;d++)h=d>q-y-1?F:E,B=0!==t&&d!==q-1?h-1:h,e=$("<div></div>").addClass("ratio-bar-consequent-divs").css({width:B,"border-right-width":t,"border-color":o,"background-color":m}).appendTo(this.$el),d===q-1&&e.css({"border-width":0});this.colorSeparatorPosition=z}},getPositionOfColorSeparator:function(){return this.colorSeparatorPosition}})}(),function(){MathInteractives.Common.Components.Models.GridArea=MathInteractives.Common.Player.Models.BaseInteractive.extend({defaults:{countArray:null,tileCollection:[],tileWidth:null,tileHeight:null,images:[],hoverImages:[],canvasType:null,selectedTilesArray:null,currentTilePosition:null},initialize:function(){this.set("tileCollection",new MathInteractives.Common.Components.Models.GridArea.TileCollection(this.get("tileCollection"))),this.get("countArray")||this.set("countArray",new Array),this.on("change:countArray",$.proxy(this._fireCountUpdateEvent,this))},_fireCountUpdateEvent:function(){this.trigger(MathInteractives.Common.Components.Models.GridArea.EVENTS.COUNT_UPDATE_EVENT)},setCountArray:function(a){this.set("countArray",a)},setCanvasType:function(a){this.set("canvasType",a)},populateImages:function(a,b){this.set("images",a),this.set("hoverImages",b);var c=[];if(0===this.get("countArray").length){for(var d=0;d<this.get("images").length;d++)c[d]=0;this.set("countArray",c)}}},{EVENTS:{COUNT_UPDATE_EVENT:"countUpdate"},getTileId:function(a,b){return a.toString()+"-"+b.toString()},Tile:Backbone.Model.extend({defaults:{id:null,tileRow:null,tileCol:null,imageIndex:null}}),TileCollection:Backbone.Collection.extend({initialize:function(a){model=this.Tile},add:function(a){for(a=_.isArray(a)?a.slice():[a],d=0,length=a.length;d<length;d++){var b=a[d]instanceof this.model?a[d]:new this.model(a[d]),c=this.where({id:b.get("id")});if(c.length>0){for(var d=0;d<c.length;d++)c[d].set("imageIndex",b.get("imageIndex"));return!1}Backbone.Collection.prototype.add.call(this,b)}},addTiles:function(a,b){for(var c=MathInteractives.Common.Components.Models.GridArea,d=0;d<a.length;d++){var e=new MathInteractives.Common.Components.Models.GridArea.Tile({id:c.getTileId(a[d].tileRow,a[d].tileCol),tileRow:a[d].tileRow,tileCol:a[d].tileCol,imageIndex:b});this.add(e)}},resetCollection:function(){for(var a=this.length,b=0;a>b;b++)this.remove(this.models[b]),a--,b--},removeTile:function(a,b){for(var c=MathInteractives.Common.Components.Models.GridArea,d=c.getTileId(a,b),e=0;e<this.models.length;e++)if(d===this.models[e].id){this.remove(this.models[e]);break}},getTileCount:function(a){var b=this.where({imageIndex:a});return b.length}})})}(),function(){"use strict";MathInteractives.Common.Components.Views.GridArea=MathInteractives.Common.Player.Views.Base.extend({manager:null,filePath:null,player:null,model:null,collection:null,tilesHorizontal:null,tilesVertical:null,images:null,prevIndex:null,hoverImages:null,drawingCanvasTool:null,startPoint:null,endPoint:null,drawingCanvasScope:null,currentArray:[],selectedTilesArray:[],drawnTilesArray:[],startArray:[],currentIndex:-1,canvasWidth:null,canvasHeight:null,numberOfImages:null,showCountInId:null,countArray:[],canvasBgColor:null,hoveredTile:{},interactivityName:null,indexOfDraggedImage:null,isDragging:!1,isDropped:!1,gridImagePath:null,containmentDivId:null,drawStarted:!1,tileWidth:null,tileHeight:null,navigatePoint:null,tileToReplace:null,isNotErasable:null,showHalfImage:null,canvasType:null,events:{"mousemove .canvas-grid":"onCanvasGridMove","mousedown .canvas-grid":"onCanvasGridClick","mouseleave .hoverImage":"mouseLeaveFromHoverImage","mouseenter .hoverImage":"onMouseEnterHoverImage"},initialize:function(a){var b=this;b.model=a.model,b.player=a.player,b.manager=a.manager,b.filePath=a.path,b.idPrefix=b.player.getIDPrefix(),b.tileWidth=b.model.get("tileWidth"),b.tileHeight=b.model.get("tileHeight"),b.collection=b.model.get("tileCollection"),b.images=b.model.get("images"),b.hoverImages=b.model.get("hoverImages"),b.numberOfImages=b.images.length,b.countArray=b.model.get("countArray"),b.canvasType=b.model.get("canvasType"),null===b.canvasType&&(b.canvasType=a.canvasType,b.model.setCanvasType(a.canvasType)),b.tilesHorizontal=a.tilesHorizontal,b.tilesVertical=a.tilesVertical,b.showCountInId=a.showCountInId,b.canvasBgColor=a.canvasColor,b.interactivityName=a.interactivityName,b.containmentDivId=a.containmentDivId,b.isNotErasable=a.isNotErasable||!1,b.showHalfImage=a.showHalfImage||!1,b.manager.loadScreen("grid-area"),b.render(),b.attachEvents()},render:function(){var a=this,b=$("<canvas>",{id:a.interactivityName+"gridCanvas","class":"gridCanvas"}),c=$("<canvas>",{id:a.interactivityName+"drawingCanvas","class":"drawingCanvas"}),d=$("<div>",{id:a.interactivityName+"canvas-grid","class":"canvas-grid"}),e=$("<div>",{id:a.interactivityName+"hover-image","class":"hoverImage"}),f=(a.collection,MathInteractives.Common.Utilities.Models.Utils);a.$el.append(b),a.$el.append(c),a.$el.append(d),a.$el.append(e),f.EnableTouch(this.$(".hoverImage")),a.setStylesToCanvasHolderElements(),a.drawingCanvasScope=new paper.PaperScope,a.drawingCanvasScope.setup(a.interactivityName+"drawingCanvas"),a.$(".drawingCanvas")[0].width=a.canvasWidth,a.$(".drawingCanvas")[0].height=a.canvasHeight,a.drawingCanvasTool=new a.drawingCanvasScope.Tool,a._canvasAcc=MathInteractives.global.CanvasAcc.intializeCanvasAcc({type:a.canvasType,canvasHolderID:a.el.id,manager:a.manager,player:a.player,paperScope:a.drawingCanvasScope,gridCell:{size:{width:a.tileWidth,height:a.tileHeight},origin:{x:a.tileWidth/2,y:a.tileHeight/2}},gridContainment:{minX:a.tileWidth/2,maxX:a.tileWidth*a.tilesHorizontal,minY:a.tileHeight/2,maxY:a.tileHeight*a.tilesVertical},focusRectSize:{width:a.tileWidth-4,height:a.tileHeight-4}}),a.$el.on(MathInteractives.Common.Player.Models.CanvasAcc.DRAW_AND_EXPAND_EVENTS.SPACE,$.proxy(a.accSpaceHandler,a)),a.$el.on(MathInteractives.Common.Player.Models.CanvasAcc.DRAW_AND_EXPAND_EVENTS.FOCUS_OUT,$.proxy(a.accFocusHandler,a)),a.$el.on(MathInteractives.Common.Player.Models.CanvasAcc.DRAW_AND_EXPAND_EVENTS.ARROW,$.proxy(a.accArrowHandler,a)),a.$el.on(MathInteractives.Common.Player.Models.CanvasAcc.DRAG_AND_DROP_EVENTS.FOCUS_OUT,$.proxy(a.accFocusOutInDragHandler,a)),a.$el.on(MathInteractives.Common.Player.Models.CanvasAcc.DRAG_AND_DROP_EVENTS.TAB,$.proxy(a.accTabInDragHandler,a)),a.$el.on(MathInteractives.Common.Player.Models.CanvasAcc.DRAG_AND_DROP_EVENTS.SPACE,$.proxy(a.accSpaceInDragHandler,a)),a.$el.on(MathInteractives.Common.Player.Models.CanvasAcc.DRAG_AND_DROP_EVENTS.ARROW,$.proxy(a.accArrowInDragHandler,a)),a.renderGrid(),a.showCount(a.countArray)},setStylesToCanvasHolderElements:function(){var a=this,b=a.$(".hoverImage"),c=a.$(".gridCanvas"),d=a.$(".drawingCanvas"),e=a.$(".canvas-grid"),f=MathInteractives.Common.Utilities.Models.Utils;b.css({position:"absolute",width:a.tileWidth+"px",height:a.tileHeight+"px",cursor:"move","z-index":"0"}).draggable({start:function(){a.isDragging=!0,a.isDropped=!1,a.removeTileFromCanvas()},stop:function(){a.isDragging=!1,a.isDropped||a.repaintDraggedTile()},containment:"#"+a.containmentDivId,revert:"invalid"}).hide(),a.canvasWidth=a.tileWidth*a.tilesHorizontal,a.canvasHeight=a.tileHeight*a.tilesVertical,c[0].width=a.canvasWidth,c[0].height=a.canvasHeight,c.css({position:"absolute","background-color":a.canvasBgColor}),d[0].width=a.canvasWidth,d[0].height=a.canvasHeight,d.css({position:"absolute"}),e.css({position:"absolute",width:a.canvasWidth+1+"px",height:a.canvasHeight+1+"px",top:"0px",left:"0px"}),f.EnableTouch(this.$(".canvas-grid"),{specificEvents:f.SpecificEvents.DRAGGABLE}),d.droppable({drop:function(b,c){a.replaceCurrentTileWithDraggedTile(b,c),a.copyTilesFromDrawingCanvasToGridCanvas(),a.dropEvent=b}})},removeTileFromCanvas:function(a,b){var c,d,e=this,f=document.getElementById(e.interactivityName+"gridCanvas"),g=f.getContext("2d"),h=document.getElementById(e.interactivityName+"drawingCanvas"),i=h.getContext("2d");"undefined"==typeof a&&(a=e.hoveredTile.col),"undefined"==typeof b&&(b=e.hoveredTile.row),c=(a-1)*e.tileHeight,d=(b-1)*e.tileWidth,i.clearRect(c,d,e.tileWidth,e.tileHeight),g.clearRect(c,d,e.tileWidth,e.tileHeight)},repaintDraggedTile:function(){var a=this,b={},c=[],d=a.drawingCanvasScope.project.activeLayer.children,e=d.length;b.tileRow=a.hoveredTile.row,b.tileCol=a.hoveredTile.col,c[0]=b,a.paintTemporaryTiles(c,a.images[a.indexOfDraggedImage]),a.$(".hoverImage").css("z-index","0").hide();for(var f=0;e>f;f++)(void 0===d[f]._custom_prop_id||-1!==d[f]._custom_prop_id.indexOf("null_")||null===d[f]._row_no||null===d[f]._col_no)&&(d.splice(f,1),e--,f--)},paintTemporaryTiles:function(a,b){for(var c=this,d=c.drawingCanvasScope.project.activeLayer.children,e=d.length,f=MathInteractives.Common.Utilities.Models.BrowserCheck.isMobile,g=0;g<a.length;g++){for(var h=a[g].tileCol*c.tileWidth-c.tileWidth/2,i=a[g].tileRow*c.tileHeight-c.tileHeight/2,j=0;e>j;j++)d[j]._row_no===a[g].tileRow&&d[j]._col_no===a[g].tileCol&&(d[j]._custom_prop_id="null_"+d[j]._custom_prop_id);c.drawingCanvasScope.activate();var k=new c.drawingCanvasScope.Raster(b);k._row_no=a[g].tileRow,k._col_no=a[g].tileCol,-1!==c.currentIndex?k._custom_prop_id=c.images[c.currentIndex]:f?k._custom_prop_id="null":k._custom_prop_id=c.images[c.indexOfDraggedImage],a[g].raster=k,k.position.x=h,k.position.y=i}c.getCount()},getCount:function(){for(var a,b=this,c=[],d=0;d<b.numberOfImages;d++)c[d]=0;if(-1!==b.currentIndex){var e=b.drawingCanvasScope.project.activeLayer.children;a=e.length;for(var f=0;a>f;f++)if(e[f].hasOwnProperty("_custom_prop_id"))for(var d=0;d<b.numberOfImages;d++)if(e[f]._custom_prop_id===b.images[d]){c[d]+=1;break}}else for(var g=b.collection,d=0;d<b.numberOfImages;d++){var h=g.where({imageIndex:d});c[d]=h.length}b.countArray=c,b.showCount(b.countArray),b.model.setCountArray(b.countArray)},showCount:function(a){var b=this;b.model.setCountArray(a)},replaceCurrentTileWithDraggedTile:function(a,b){var c=this,d={},e=[],f=c.drawingCanvasScope.project.activeLayer.children,g=f.length,h=MathInteractives.Common.Utilities.Models.BrowserCheck.isMobile;d.tileRow=Math.round(b.position.top/c.tileHeight)+1,d.tileCol=Math.round(b.position.left/c.tileWidth)+1,e[0]=d,c.$(".hoverImage").css("z-index","0").hide();for(var i=0;g>i;i++)f[i]._row_no===c.hoveredTile.row&&f[i]._col_no===c.hoveredTile.col&&(f.splice(i,1),g--,i--);if(h){var j,k=$(b.draggable).attr("row"),l=$(b.draggable).attr("col"),m=parseFloat($(b.draggable).attr("index"));j=parseInt(k)===d.tileRow&&parseInt(l)===d.tileCol?null:$(".tileDragImage.ui-draggable[row='"+d.tileRow.toString()+"'][col='"+d.tileCol.toString()+"']")[0],null!==j&&$(j).remove(),c.$(b.draggable).attr("row",d.tileRow),c.$(b.draggable).attr("col",d.tileCol),c.$(b.draggable).css("left",(d.tileCol-1)*c.tileWidth+1+"px"),c.$(b.draggable).css("top",(d.tileRow-1)*c.tileHeight+1+"px"),c.collection.removeTile(k,l),c.collection.addTiles(e,m),c.$(b.draggable).css("background-image",'url("'+c.images[m]+'")'),c.getCount()}else{c.collection.removeTile(c.hoveredTile.row,c.hoveredTile.col),c.collection.addTiles(e,c.indexOfDraggedImage),c.paintTemporaryTiles(e,c.images[c.indexOfDraggedImage]),g=c.drawingCanvasScope.project.activeLayer.children.length;for(var i=0;g>i;i++)(void 0===f[i]._custom_prop_id||-1!==f[i]._custom_prop_id.indexOf("null_")||null===f[i]._row_no||null===f[i]._col_no)&&(f.splice(i,1),g--,i--)}c.isDropped=!0},copyTilesFromDrawingCanvasToGridCanvas:function(){var a=this,b=document.getElementById(a.interactivityName+"drawingCanvas"),c=b.getContext("2d"),d=document.getElementById(a.interactivityName+"gridCanvas"),e=d.getContext("2d"),f=c.getImageData(0,0,a.canvasWidth,a.canvasHeight);e.putImageData(f,0,0),c.clearRect(0,0,a.canvasWidth,a.canvasHeight)},renderGrid:function(){var a=this;a.drawingCanvasScope.project.activeLayer.removeChildren();for(var b=0;b<a.collection.length;b++)a.renderTile(a.collection.models[b]);a.updatePaperItems()},renderTile:function(a){this.drawingCanvasScope.activate();var b=this,c=a.get("imageIndex"),d=new b.drawingCanvasScope.Raster(b.images[c]);b.raster=d,d._row_no=a.get("tileRow"),d._col_no=a.get("tileCol"),d._custom_prop_id=b.images[c],d.position.x=a.get("tileCol")*b.tileWidth-b.tileWidth/2,d.position.y=a.get("tileRow")*b.tileHeight-b.tileHeight/2},setCurrentCanvasPaperScope:function(){this.drawingCanvasScope.activate()},attachEvents:function(){var a=this;$("#"+a.containmentDivId).off("mousemove").on("mousemove",$.proxy(a.onGridAreaParentMouseMove,a)),a.drawingCanvasTool.onMouseDrag=function(b){a.startPoint=b.point,a.drawRasterOnMouseDrag()},a.$el.on("keyup",function(b){var c=b.which||b.keyCode;9===c&&a.setCurrentCanvasPaperScope()})},attachMouseupEvent:function(){var a=this;$(window).off("mouseup.grid-area-window").on("mouseup.grid-area-window",$.proxy(a.populateCollectionOnMouseUp,a))},detachMouseupEvent:function(){$(window).off("mouseup.grid-area-window")},populateCollectionOnMouseUp:function(a){if(this.detachMouseupEvent(),-1!==this.currentIndex&&this.drawStarted&&("undefined"==typeof a||1===a.which)){var b=this,c=document.getElementById(b.interactivityName+"drawingCanvas"),d=c.getContext("2d"),e=document.getElementById(b.interactivityName+"gridCanvas"),f=e.getContext("2d"),g=d.getImageData(0,0,b.canvasWidth,b.canvasHeight),h=b.drawingCanvasScope.project.activeLayer.children,i=h.length;f.putImageData(g,0,0);for(var j=0;i>j;j++)(void 0===h[j]._custom_prop_id||-1!==h[j]._custom_prop_id.indexOf("null_"))&&(h.splice(j,1),i--,j--);b.collection.addTiles(b.selectedTilesArray,b.currentIndex),b.updatePaperItems(),d.clearRect(0,0,b.canvasWidth,b.canvasHeight),b.drawStarted=!1}},countCollections:function(a){this.renderTile(a)},removeTiles:function(a){},onGridAreaParentMouseMove:function(a){var b=this;if(b.currentIndex&&!b.isDragging){var c=document.elementFromPoint(a.clientX,a.clientY),d=$(c).parent();d&&d[0]!==this.$el[0]&&b.mouseLeaveFromHoverImage()}},setGridImage:function(a){this.$(".canvas-grid").css("background-image",'url("'+a+'")')},onCanvasGridClick:function(a){var b=this,c=a.target||a.srcElement,d=c.getBoundingClientRect(),e=a.clientX-d.left,f=a.clientY-d.top;b.attachMouseupEvent(),1===a.which&&(-1===b.currentIndex||b.startRasterDraw(e,f))},onCanvasGridMove:function(a){var b=this,c=a.target||a.srcElement,d=c.getBoundingClientRect(),e=a.clientX-d.left,f=a.clientY-d.top,g=MathInteractives.Common.Utilities.Models.BrowserCheck.isMobile;b.startPoint={x:e,y:f},-1===b.currentIndex?g||b.showRasterHoverImage(e,f):b.drawRasterOnMouseDrag()},onCanvasGridMouseUp:function(){this.populateCollectionOnMouseUp()},repaintDraggedTile1:function(a){var b=this,c=[],d=$("#"+a.currentTarget.id).attr("row"),e=$("#"+a.currentTarget.id).attr("col"),f=MathInteractives.Common.Components.Models.GridArea.getTileId(d,e);tileModel=b.collection.get(f),tileModel&&(index=tileModel.get("imageIndex")),c[0]={tileRow:d,tileCol:e}},removeTileFromCanvas1:function(a,b){var c=this,d=document.getElementById(c.interactivityName+"gridCanvas"),e=d.getContext("2d"),f=document.getElementById(c.interactivityName+"drawingCanvas"),g=f.getContext("2d"),h=$("#"+a.currentTarget.id).attr("row"),i=$("#"+a.currentTarget.id).attr("col"),j=(i-1)*c.tileWidth,k=(h-1)*c.tileHeight;g.clearRect(j,k,c.tileWidth,c.tileHeight),e.clearRect(j,k,c.tileWidth,c.tileHeight)},showRasterHoverImage:function(a,b){var c,d,e=this;-1===e.currentIndex&&(e.isDragging||(c=Math.ceil(b/e.tileWidth),d=Math.ceil(a/e.tileWidth),e.showImageOnTile(c,d)))},showImageOnTile:function(a,b){var c,d=this,e=d.getIndexOfImageArray(a,b),f=MathInteractives.Common.Utilities.Models.Utils;if(d.indexOfDraggedImage=e,-1!==e){if(a===d.hoveredTile.row&&b===d.hoveredTile.col)return;d.hoveredTile.row=a,d.hoveredTile.col=b,c=d.hoverImages[e],d.$(".hoverImage").css("background-image",'url("'+c+'")'),d.$(".hoverImage").css("left",d.tileWidth*(b-1)+"px"),d.$(".hoverImage").css("top",d.tileHeight*(a-1)+"px"),d.$(".hoverImage").show().css("z-index","1"),f.EnableTouch(this.$(".hoverImage"))}else d.hoveredTile.row=null,d.hoveredTile.col=null,d.$(".hoverImage").css("background-image",""),d.$(".hoverImage").css("z-index","0").hide()},getIndexOfImageArray:function(a,b){var c=this,d=MathInteractives.Common.Components.Models.GridArea.getTileId(a,b),e=-1,f=c.collection.get(d);return f&&(e=f.get("imageIndex")),e},mouseLeaveFromHoverImage:function(){var a=this;a.isDragging||(a.hoveredTile.row=null,a.hoveredTile.col=null,a.$(".hoverImage").css("z-index","0").hide(),a.$(".hoverImage").css("background-image",""))},onMouseEnterHoverImage:function(){this.$(".hoverImage").css("cursor","move")},calculate:function(){var a=this,b=a.getTilePosition(a.startPoint).col,c=a.getTilePosition(a.startPoint).row,d=a.getTilePosition(a.endPoint).col,e=a.getTilePosition(a.endPoint).row;if(c>e){var f=e;e=c,c=f}if(b>d){var f=d;d=b,b=f}},startRasterDraw:function(a,b){if(-1!==this.currentIndex){var c=this,d=c.images[c.currentIndex],e={};c.currentArray=[],c.startArray=[],c.selectedTilesArray=[],c.drawnTilesArray=[];var f=Math.ceil(b/c.tileHeight),g=Math.ceil(a/c.tileWidth);c.showHalfImage||f>c.canvasHeight/c.tileHeight&&(f=c.canvasHeight/c.tileHeight),1>f&&(f=1),c.showHalfImage||g>c.canvasWidth/c.tileWidth&&(g=c.canvasWidth/c.tileWidth),1>g&&(g=1),e.tileRow=f,e.tileCol=g,c.currentArray[0]=e,c.startArray[0]=e,c.selectedTilesArray[0]=e,this.model.set("selectedTilesArray",c.selectedTilesArray),c.drawnTilesArray[0]=e,c.paintTemporaryTiles(c.startArray,d),c.collection.addTiles(c.selectedTilesArray,c.currentIndex),c.drawStarted=!0}},drawRasterOnMouseDrag:function(){if(-1!==this.currentIndex&&this.drawStarted){var a,b=this,c=MathInteractives.Common.Components.Views.GridArea,d=b.images[b.currentIndex],e={},f=(this.model,b.startArray[0].tileRow),g=b.startArray[0].tileCol,h=b.getTilePosition(b.startPoint).row,i=b.getTilePosition(b.startPoint).col;if(b.showHalfImage||h>b.canvasHeight/b.tileHeight&&(h=b.canvasHeight/b.tileHeight),1>h&&(h=1),b.showHalfImage||i>b.canvasWidth/b.tileWidth&&(i=b.canvasWidth/b.tileWidth),1>i&&(i=1),h===b.currentArray[0].tileRow&&i===b.currentArray[0].tileCol)return void(1===i?(a="left",this.setCanvasText("reach-extreme-text","left"),1===h?a="top left":h===b.canvasHeight/b.tileHeight&&(a="bottom left")):i===b.canvasWidth/b.tileWidth?(a="right",this.setCanvasText("reach-extreme-text","right"),1===h?a="top right":h===b.canvasHeight/b.tileHeight&&(a="bottom right")):1===h?a="top":h===b.canvasHeight/b.tileHeight&&(a="bottom"));if(e.tileRow=h,e.tileCol=i,b.currentArray=[],b.currentArray[0]=e,b.startArray[0].tileRow>h){var j=f;f=h,h=j}if(b.startArray[0].tileCol>i){var j=g;g=i,i=j}b.selectedTilesArray=[];for(var k=0,l=f;h>=l;l++)for(var m=g;i>=m;m++)e={},e.tileRow=l,e.tileCol=m,b.selectedTilesArray.push(e),b.isNotErasable&&b.collection.addTiles([e],b.currentIndex),this.model.set("selectedTilesArray",b.selectedTilesArray),k++;f=b.startArray[0].tileRow,g=b.startArray[0].tileCol;var n=c.getDiffArray(b.drawnTilesArray,b.selectedTilesArray);if(!b.isNotErasable)var o=c.getDiffArray(b.selectedTilesArray,b.drawnTilesArray);n.length>0&&(b.paintTemporaryTiles(n,d),b.drawnTilesArray=b.drawnTilesArray.concat(n)),b.isNotErasable||o.length>0&&(b.removeTemporaryTiles(o,d),b.drawnTilesArray=c.getDiffArray(o,b.drawnTilesArray)),b.drawingCanvasScope.view.draw()}},removeTemporaryTiles:function(a,b){for(var c=this.drawingCanvasScope.project.activeLayer.children,d=0;d<a.length;d++){a[d].raster.remove();for(var e in c)if(c[e]._row_no===a[d].tileRow&&c[e]._col_no===a[d].tileCol&&-1!==c[e]._custom_prop_id.indexOf("null_")){var f=c[e]._custom_prop_id;f=f.replace("null_",""),c[e]._custom_prop_id=f}}this.getCount()},setCurrentIndex:function(a){var b=this,c=(b.images[b.currentIndex],MathInteractives.Common.Utilities.Models.Utils),d=MathInteractives.Common.Utilities.Models.BrowserCheck.isMobile;if(b.prevIndex=b.currentIndex,b.currentIndex=a,-1===b.currentIndex){if(d){for(var e=0;e<b.collection.length;e++){var f=b.collection.models[e].get("tileRow"),g=b.collection.models[e].get("tileCol"),h=b.collection.models[e].get("imageIndex"),i=(g-1)*b.tileWidth,j=(f-1)*b.tileHeight,k=$("<div>",{id:"tileImage"+e,"class":"tileDragImage",row:f,col:g});this.$el.append(k),b.$("#tileImage"+e).attr("index",h),b.$("#tileImage"+e).css({position:"absolute",width:b.tileWidth-1+"px",height:b.tileHeight-1+"px",left:i+1+"px",top:j+1+"px","background-image":'url("'+b.images[h]+'")',"background-position":"-1px -1px"})}b.$(".tileDragImage").css("z-index","1"),c.EnableTouch(this.$(".tileDragImage"),{specificEvents:c.SpecificEvents.DRAGGABLE}),b.$(".tileDragImage").draggable({start:function(a,c){var d=b.$("#"+a.currentTarget.id).attr("index");b.isDragging=!0,b.isDropped=!1,b.$("#"+a.currentTarget.id).css("background-image",'url("'+b.hoverImages[d]+'")'),b.removeTileFromCanvas1(a,c)},stop:function(a,c){b.isDragging=!1;var d=b.$(c.helper).attr("index");b.$(c.helper).css("background-image",'url("'+b.images[d]+'")'),!b.isDropped},zIndex:2,containment:"#"+b.containmentDivId,revert:"invalid"})}}else if(d){b.$(".tileDragImage").remove();var l=document.getElementById(b.interactivityName+"drawingCanvas"),m=l.getContext("2d");m.clearRect(0,0,b.canvasWidth,b.canvasHeight),b.renderGrid()}},getCountArray:function(){return this.countArray},clearCanvasAndResetCounts:function(){for(var a=this,b=document.getElementById(a.interactivityName+"gridCanvas"),c=b.getContext("2d"),d=document.getElementById(a.interactivityName+"drawingCanvas"),e=d.getContext("2d"),f=1;f<=a.numberOfImages;f++)a.countArray[f-1]=0,$("."+a.showCountInId+f).text(a.countArray[f-1]);a.$(".tileDragImage").remove(),a.model.setCountArray(a.countArray),a.drawingCanvasScope.project.activeLayer.removeChildren(),a.collection.resetCollection(),a.hoverCanvasRaster=null,c.clearRect(0,0,a.canvasWidth,a.canvasHeight),e.clearRect(0,0,a.canvasWidth,a.canvasHeight)},deleteDraggedTile:function(a,b){for(var c=this,d=c.drawingCanvasScope.project.activeLayer.children,e=d.length,f=MathInteractives.Common.Utilities.Models.BrowserCheck.isMobile,g=0;e>g;g++)d[g]._row_no===c.hoveredTile.row&&d[g]._col_no===c.hoveredTile.col&&(d.splice(g,1),e--,g--);if(f){var h=$(b.draggable).attr("row"),i=$(b.draggable).attr("col"),j=parseFloat(c.$(b.draggable).attr("index"));c.collection.removeTile(h,i),c.$(b.draggable).remove(),c.countArray[j]--,$("."+c.showCountInId+(j+1)).text(c.countArray[j])}else c.$(".hoverImage").css("z-index","0").hide(),c.collection.removeTile(c.hoveredTile.row,c.hoveredTile.col),c.countArray[c.indexOfDraggedImage]--,$("."+c.showCountInId+(c.indexOfDraggedImage+1)).text(c.countArray[c.indexOfDraggedImage]);c.isDropped=!0},clearDrawingCanvas:function(){var a=this,b=document.getElementById(a.interactivityName+"drawingCanvas"),c=b.getContext("2d");c.clearRect(0,0,a.canvasWidth,a.canvasHeight)},getTilePosition:function(a){var b=Math.ceil(a.y/this.tileHeight),c=Math.ceil(a.x/this.tileWidth);return{row:b,col:c}},setCanvasText:function(a,b,c){var d=this.el.id;c=c||null,"undefined"!=typeof a&&(null!==c?(d=d.replace(this.idPrefix,""),this.setAccMessage(d,this.getAccMessage(a,c,b))):this.manager.setAccMessage(d,this.manager.getMessage(a,0,b)))},changeCanvasType:function(a){var b=this.drawingCanvasScope.project.activeLayer.children,c=b.length;"undefined"!=typeof a&&(this._canvasAcc.changeCanvasAccType(a),this.model.setCanvasType(a),this.canvasType=a),this.canvasType===MathInteractives.Common.Player.Models.CanvasAcc.TYPE.DRAG_AND_DROP&&0===c&&this.trigger(MathInteractives.Common.Components.Views.GridArea.ON_CANVAS_NO_ELEMENT_TO_DRAG)},accSpaceHandler:function(a,b){var c=this,d=b.point.x,e=b.point.y,f=MathInteractives.Common.Components.Views.GridArea;b.isExpand===!0?(c.startPoint={x:d,y:e},c.startRasterDraw(d,e),c.setCanvasText("selection-started"),c._canvasAcc.getFocusRect().bringToFront(),c.trigger(f.SELECTION_START_ON_SPACEBAR,c.selectedTilesArray)):(c.populateCollectionOnMouseUp(),c.setCanvasText("selection-ended"),c.trigger(f.SELECTION_END_ON_SPACEBAR,c.selectedTilesArray))},accFocusHandler:function(a,b){var c=MathInteractives.Common.Components.Views.GridArea;this.populateCollectionOnMouseUp(),this.setCanvasText(c.CANVAS_TO_DRAW_TEXT),this.trigger(c.FOCUS_OUT_OF_CANVAS)},accArrowHandler:function(a,b){var c=this,d=b.point,e=c.getTilePosition(d),f=d.x,g=d.y;this.model.set("currentTilePosition",e),b.isExpand===!0?(c.startPoint={x:f,y:g},c.setCanvasText("selection-extended-text",[e.col,e.row]),c.drawRasterOnMouseDrag(),c.trigger(MathInteractives.Common.Components.Views.GridArea.DRAW_IMAGE_ON_ARROW)):(c.setCanvasText("select-to-start-draw-text",[e.col,e.row]),c.trigger(MathInteractives.Common.Components.Views.GridArea.SPACEBAR_AND_ARROW_KEY_EVENT)),c._canvasAcc.getFocusRect().bringToFront()},accSpaceInDragHandler:function(a,b){if(!b.isDrag){var c,d,e,f=b.item._row_no,g=b.item._col_no,h=this.drawingCanvasScope.project.activeLayer.children,i=h.length,j=this.getTilePosition(this.navigatePoint).row,k=this.getTilePosition(this.navigatePoint).col;this.removeTileFromCanvas(g,f),this.$(".hoverImage").css("z-index","0").hide();for(var l=0;i>l;l++)h[l]._row_no===f&&h[l]._col_no===g&&(h.splice(l,1),i--,l--);e=this.getIndexOfImageArray(f,g),this.trigger(MathInteractives.Common.Components.Views.GridArea.ON_CANVAS_ELEMENT_DROP,e,this.tileToReplace),this.collection.removeTile(f,g),this.paintTemporaryTiles([{tileRow:j,tileCol:k}],this.images[this.indexOfDraggedImage]),this.collection.addTiles([{tileRow:j,tileCol:k}],this.indexOfDraggedImage),this.copyTilesFromDrawingCanvasToGridCanvas(),this.updatePaperItems(),this.getCount(),c=this._canvasAcc.getCurrentPaperItem()._row_no,d=this._canvasAcc.getCurrentPaperItem()._col_no,this.showImageOnTile(c,d),this.trigger(MathInteractives.Common.Components.Views.GridArea.ELEMENT_TO_START_DRAG,f,g,e)}},accFocusOutInDragHandler:function(a,b){this.$(".hoverImage").css("z-index","0").hide(),this.hoveredTile.row=null,this.hoveredTile.col=null,this.setCanvasText(MathInteractives.Common.Components.Views.GridArea.CANVAS_TO_DRAG_TEXT)},accArrowInDragHandler:function(a,b){var c,d=this.getTilePosition(b.point).row,e=this.getTilePosition(b.point).col;this.navigatePoint=b.point,c=this.getIndexOfImageArray(d,e),this.setCanvasText("navigate-to-drop-text",[d,e]),-1!==c?(this.trigger(MathInteractives.Common.Components.Views.GridArea.ELEMENT_PRESENT_ON_CANVAS_DRAG,d,e,c),this.tileToReplace=c):this.tileToReplace=null},accTabInDragHandler:function(a,b){var c=b.item._row_no,d=b.item._col_no,e=this.getIndexOfImageArray(c,d);this.showImageOnTile(c,d),this.trigger(MathInteractives.Common.Components.Views.GridArea.ELEMENT_TO_START_DRAG,c,d,e)},updatePaperItems:function(a,b){var c=this.drawingCanvasScope.project.activeLayer.children,d=c.length,e=[];if("undefined"!=typeof this._canvasAcc){
for(var f=0;d>f;f++)"undefined"!=typeof c[f]._custom_prop_id&&-1===c[f]._custom_prop_id.indexOf("null_")&&e.push(c[f]);this._canvasAcc.updatePaperItems(e)}}},{getDiffArray:function(a,b){for(var c,d=[],e=0;e<b.length;e++){c=0;for(var f=0;f<a.length;f++)(b[e].tileRow!==a[f].tileRow||b[e].tileCol!==a[f].tileCol)&&c++;c===a.length&&d.push(b[e])}return d},CANVAS_TO_DRAG_TEXT:"canvas-to-drag-text",CANVAS_TO_DRAW_TEXT:"canvas-to-draw-text",ON_CANVAS_ELEMENT_DROP:"canvas-element-dropped",ELEMENT_PRESENT_ON_CANVAS_DRAG:"canvas-element-present",TILE_ADDED_TEXT:"tile-added-text",TILE_REPLACED_TEXT:"tile-replaced-text",TILE_ALREADY_PRESENT_TEXT:"tile-present-text",TILE_TO_DRAG_TEXT:"tile-to-drag-text",ON_CANVAS_NO_ELEMENT_TO_DRAG:"no-element-to-drag-text",ELEMENT_TO_START_DRAG:"element-to-start-drag-text",SELECTION_START_ON_SPACEBAR:"selection-start-on-space-click",SELECTION_END_ON_SPACEBAR:"selection-end-on-space-click",DRAW_IMAGE_ON_ARROW:"image-is-draw-on-arrow",SPACEBAR_AND_ARROW_KEY_EVENT:"spacebar-on-parent-of-canvas",FOCUS_OUT_OF_CANVAS:"focus-out-from-canvas"})}(),function(){"use strict";MathInteractives.Common.Components.Views.ScoreMeter=Backbone.View.extend({initialize:function(a){var b='<div class="de-mathematics-interactive-score-meter"><div class="score-meter-base"></div><div class="score-meter-value"></div><div class="score-meter-grids-mask"></div></div>';this.$el.html(b);for(var c="",d=0;10>d;d++)c+='<div class="score-box"></div>';var e=this.$el.find(".score-meter-grids-mask");e.append(c);var f=this.$el.find(".score-box"),g=parseFloat(f.css("border-left-width"))+parseFloat(f.css("border-right-width"))+parseFloat(f.css("margin-right"))+parseFloat(f.css("margin-left"));f.width(e.width()/10-g)},loadScore:function(a){var b=this.$el.find(".score-box"),c=10*b.width()*a;this.$el.find(".score-meter-value").width(c+"px");var d=this.$el.find(".score-meter-value").width();if(d>b.width()){var e=d/b.width(),f=parseFloat(b.css("border-left-width"))+parseFloat(b.css("border-right-width"))+parseFloat(b.css("margin-right"))+parseFloat(b.css("margin-left"));d+=f*Math.floor(e),this.$el.find(".score-meter-value").width(d+"px"),this.$el.find(".score-meter-value").width()>=this.$el.width()&&this.$el.find(".score-meter-value").width(d-f+"px")}}},{}),MathInteractives.global.ScoreMeter=MathInteractives.Common.Components.Views.ScoreMeter}();