!function(){MathInteractives.Common.Components.Models.AudioManager=Backbone.Model.extend({defaults:function(){return{preloaderImgId:"sound-preloder",displayPreloader:!0,bufferValue:null,currentTime:null,duration:null,currentPlayingAudio:null,isMandatory:!1,workWithSound:!0,initialLoadTime:7e3,idPrefix:null,manager:null,player:null,filePath:null,audioFilePath:null,audioData:{},audioInfo:{},audioSpriteId:[]}},initialize:function(){this.setGlobalAudioData()},getIdPrefix:function(){return this.get("idPrefix")},getAudioData:function(){return this.get("audioData")},getAudioFilePath:function(){return this.get("audioFilePath")},getFilePath:function(){return this.get("filePath")},getManager:function(){return this.get("manager")},getGlobalAudioData:function(a){return this.get("audioInfo")[a]},getCurrentPlayingAudio:function(){return this.get("currentPlayingAudio")},getDuration:function(){return this.get("duration")},getCurrentTime:function(){return this.get("currentTime")},getBufferValue:function(){return this.get("bufferValue")},getPreloaderImgId:function(){return this.get("preloaderImgId")},getPreloaderImgPath:function(){var a=this.getFilePath(),b=this.getPreloaderImgId();return a.getImagePath(b)},setDuration:function(a){this.set("duration",a)},setBufferValue:function(a){this.set("bufferValue",a)},setGlobalAudioData:function(){this.parseData(this.getAudioData(),this.getAudioFilePath())},setCurrentPlayingAudio:function(a){this.set("currentPlayingAudio",a)},parseData:function(a,b){var c=this.get("audioInfo");if(this.get("audioSpriteId").length>0)for(var d=this.get("audioSpriteId"),e=0,f=d.length;f>e;e++)c[d[e]]={},c[d[e]].audioData=a,c[d[e]].pathToSrc=b;else{var g=this.get("idPrefix");c[g]={},c[g].audioData=a,c[g].pathToSrc=b}this.set("audioInfo",c)}},{})}(),function(){"use strict";MathInteractives.Common.Components.Views.AudioManager=MathInteractives.Common.Player.Views.Base.extend({$audio:null,isLoading:!1,isMuted:!1,loadingCount:0,maxLoadingTries:3,idPrefix:null,audioSpriteId:null,loadWithSound:!0,popupShown:!1,initialize:function(){var a=this;a.initializeDefaultProperties(),this.model.set("idPrefix",a.idPrefix),a.loadScreen("audio-manager-button"),0===a.model.get("audioSpriteId").length?a.audioSpriteId=a.idPrefix:a.audioSpriteId=a.model.get("audioSpriteId")[0],a.render(),a.model.on("change:bufferValue",function(){a._bufferMonitor()}),a._bindHeaderMuteEvents(),MathInteractives.Common.Utilities.Models.BrowserCheck.isMobile&&(a.maxLoadingTries=1)},_bufferMonitor:function(){var a=this.isSoundLoaded();a===!1?this._displayPreload(!0):(this._displayPreload(!1),this.model.off("change:bufferValue"))},_displayPreload:function(a){this.model.get("player"),this.model.get("displayPreloader");a===!0?this.isLoading||(this._showPreloader(),this.isLoading=!0,this.trigger(MathInteractives.Common.Components.Views.AudioManager.AUDIO_EVENT.LOAD_START)):(this._hidePreloader(),this.isLoading=!1,this.trigger(MathInteractives.Common.Components.Views.AudioManager.AUDIO_EVENT.LOAD_COMPLETE))},_showPreloader:function(){var a=this.model.get("player"),b=this.model.get("displayPreloader");if(b&&0===a.$el.find(".audio-mgr-modal").length){var c=$("<div/>",{"class":"audio-mgr-modal"}).css({position:"absolute",top:"0px",left:"0px",width:a.$el.width(),height:a.$el.height(),"z-index":980,opacity:.56,"background-color":"#000"}),d=$("<div/>",{"class":"audio-mgr-preloder"}).css({position:"absolute",top:"0",left:"0",width:"100%",height:"100%",background:'url("'+this.model.getPreloaderImgPath()+'") 50% 50% no-repeat'});c.append(d),a.$el.append(c),a.setModalPresent(!0)}},_hidePreloader:function(){var a=this.model.get("player");this.model.get("displayPreloader");0!==a.$el.find(".audio-mgr-modal").length&&(a.setModalPresent(!1),a.$el.find(".audio-mgr-modal").remove())},_bindReloadAudio:function(){var a=this.model.get("initialLoadTime"),b=this;this.audioLoadTimer=setTimeout($.proxy(b._reloadAudio,b),a)},_reloadAudio:function(){this.loadingCount++;var a=this.model.get("player");this.isSoundLoading()===!1&&(this.loadingCount<this.maxLoadingTries?(clearInterval(this.afterReadyStateTimer),this.render(),this.load(),this.$(".audio-mgr-modal").remove(),this.isLoading=!1,this._bindReloadAudio()):this.model.get("isMandatory")?(clearInterval(this.afterReadyStateTimer),this.$(".audio-mgr-modal").remove(),this.isLoading=!1,a.setModalPresent(!1),this._generateNoSoundPopup()):(clearInterval(this.afterReadyStateTimer),a.setModalPresent(!1),a.$el.find(".audio-mgr-modal").remove(),this.isLoading=!1,this.loadWithSound=!1,this.trigger(MathInteractives.Common.Components.Views.AudioManager.AUDIO_EVENT.LOAD_COMPLETE)))},_bindAudioEvents:function(){var a=this;this.$audio.off("progress").on("progress",function(){a.model.set("bufferValue",a.$audio[0].buffered.end(0))}),this.$audio.on("timeupdate",function(){a._timeUpdateCheck(),a.model.set("currentTime",a.$audio[0].currentTime)})},_bindHeaderMuteEvents:function(){var a=this.model.get("player");MathInteractives.Common.Utilities.Models.BrowserCheck.isIOS||(this.listenTo(a,MathInteractives.Common.Player.Views.Player.Events.MUTE_CLICKED,this.onMuteClick),this.listenTo(a,MathInteractives.Common.Player.Views.Player.Events.UNMUTE_CLICKED,this.onUnmuteClick))},onMuteClick:function(){this.isMuted=!0,this.$audio[0].muted=!0},onUnmuteClick:function(){this.isMuted=!1,this.$audio[0].muted=!1},render:function(){var a=this.idPrefix+"audio",b=this.model.getGlobalAudioData(this.audioSpriteId).pathToSrc;0!==$("#"+a).length&&$("#"+a).remove(),$("body").append("<audio id="+a+"></audio>"),$("#"+a).append("<source src="+b+'.mp3 type="audio/mpeg"></source>'),$("#"+a).attr("src",b+".mp3").attr("type","audio/mpeg").attr("codecs","mp3"),this.$audio=$("#"+a)},load:function(){if(this.loadWithSound){var a=$.Deferred(),b=this;return this._showPreloader(),this.$audio[0].muted=!0,this.$audio[0].play(),0===this.loadingCount&&this._bindReloadAudio(),this._afterReadyState(function(){MathInteractives.Common.Utilities.Models.BrowserCheck.isIE?b.$audio[0].muted=!0:b.$audio[0].pause(),b._timerMonitor(),b._bindAudioEvents(),a.resolve()}),a}this.trigger(MathInteractives.Common.Components.Views.AudioManager.AUDIO_EVENT.LOAD_COMPLETE)},isSoundLoaded:function(){return this.model.getBufferValue()/this.model.getDuration()*100>99},isSoundLoading:function(){return this.model.getBufferValue()>0},_timerMonitor:function(){this.model.setDuration(this.$audio[0].duration),this.model.setBufferValue(this.$audio[0].buffered.end(0))},_timeUpdateCheck:function(){var a=this.model.getCurrentPlayingAudio(),b=null;null!=a&&(b=parseFloat(this.model.getGlobalAudioData(this.audioSpriteId).audioData[a].end),this.$audio[0].currentTime>b&&MathInteractives.Common.Components.Views.AudioManager.CURRENT_PLAYED_AUDIO_VIEWS[0].complete())},_afterReadyState:function(a){var b=this;this.afterReadyStateTimer=setInterval(function(){b.$audio[0].readyState>1&&"undefined"!=typeof a&&(clearInterval(b.afterReadyStateTimer),a())})},stopSound:function(){this.$audio[0].pause()},play:function(a){var b=MathInteractives.Common.Components.Views.AudioManager,c=this;if(MathInteractives.global.SpeechStream.stopReading(),MathInteractives.Common.Components.Views.AudioManager.stopAllSounds(),this.loadWithSound){this.isSoundLoaded()===!1&&this.load();var d=function(){var d=c.$audio[0],e=parseFloat(c.model.getGlobalAudioData(c.audioSpriteId).audioData[a].start);d.currentTime=e,d.muted=c.isMuted,d.play(),c.model.setCurrentPlayingAudio(a),MathInteractives.Common.Components.Views.AudioManager.CURRENT_PLAYED_AUDIO_VIEWS.push(c),c.trigger(b.AUDIO_EVENT.PLAY)},e=function(){return c.isSoundLoaded()===!1?void setTimeout(e,10):(d(),void clearTimeout(e))};e()}else c.trigger(b.AUDIO_EVENT.PLAY),c.trigger(b.AUDIO_EVENT.COMPLETE)},pause:function(){var a=MathInteractives.Common.Components.Views.AudioManager;this.loadWithSound&&$audioObj[0].pause(),"undefined"!=typeof a.AUDIO_EVENT.PAUSE&&this.trigger(a.AUDIO_EVENT.PAUSE)},resume:function(){var a=MathInteractives.Common.Components.Views.AudioManager;this.loadWithSound&&($audioObj[0].currentTime=this.model.get("currentTime"),$audioObj[0].play()),"undefined"!=typeof a.AUDIO_EVENT.RESUME&&this.trigger(a.AUDIO_EVENT.RESUME)},complete:function(){var a=MathInteractives.Common.Components.Views.AudioManager;this.loadWithSound&&(this.$audio[0].pause(),this.model.setCurrentPlayingAudio(null),this.removeAudioViewFromArray()),"undefined"!=typeof a.AUDIO_EVENT.COMPLETE&&this.trigger(a.AUDIO_EVENT.COMPLETE)},stop:function(){var a=MathInteractives.Common.Components.Views.AudioManager;this.loadWithSound&&(this.$audio[0].pause(),this.model.setCurrentPlayingAudio(null),this.removeAudioViewFromArray()),"undefined"!=typeof a.AUDIO_EVENT.STOP&&this.trigger(a.AUDIO_EVENT.STOP)},removeAudioViewFromArray:function(){for(var a=0,b=MathInteractives.Common.Components.Views.AudioManager.CURRENT_PLAYED_AUDIO_VIEWS,c=b.length;c>a;a++)if(b[a].idPrefix===this.idPrefix){b.splice(a,1);break}},_generateNoSoundPopup:function(){if(!this.popupShown)if(this.popupShown=!0,this.unloadScreen("sound-manager-popup-screen"),this.loadScreen("sound-manager-popup-screen"),MathInteractives.global.PlayerPopup){var a={text:this.getMessage("sound-manager-popup-text",0),buttons:[{id:"pop-up-retry-button",text:this.getMessage("sound-manager-popup-text",2),response:{isPositive:!0,buttonClicked:"yes-button"}}],closeCallback:{fnc:this._popupCallback,scope:this},title:this.getMessage("sound-manager-popup-text",1),manager:this.manager,player:this.player,path:this.filePath};this.soundManagerPopup=MathInteractives.global.PlayerPopup.createPopup(a)}else this.soundManagerPopup=MathInteractives.global.Theme2.PopUpBox.createPopup({text:this.getMessage("sound-manager-popup-text",0),manager:this.manager,player:this.player,path:this.filePath,idPrefix:this.idPrefix,title:this.getMessage("sound-manager-popup-text",1),buttons:[{id:"pop-up-retry-button",text:this.getMessage("sound-manager-popup-text",2),clickCallBack:{fnc:this._popupCallback,scope:this}}]})},_popupCallback:function(){this.popupShown=!1,this.loadingCount=0,this.render(),this.load(),this._bindReloadAudio()}},{AudioButton:MathInteractives.Common.Player.Views.Base.extend({containerId:null,playBtnOption:{},pauseBtnOption:{},resumeBtnOption:{},audioManagerView:null,soundId:"",model:null,idPrefix:null,filePath:null,tooltipView:null,initialize:function(){var a=this;a._initData(this.options),a._generateButtons(),a.$el.off("click.audio-mgr").on("click.audio-mgr",function(){a._clickListener()});var b=this.$el.attr("id").split(this.idPrefix)[1];a._createHackScreenForAudioBtn(b),a.focusIn(b,function(){a.tooltipView.showTooltip()}),a.focusOut(b,function(){a.tooltipView.hideTooltip()}),a.$el.on("mouseover",function(){a.tooltipView.showTooltip()}),a.$el.on("mouseout",function(){a.tooltipView.hideTooltip()})},_initData:function(a){var b=$("<div/>",{id:a.containerId+"-holder",role:"button"}).css("position","absolute");$("#"+a.containerId).append(b),this.containerId=a.containerId,this.$el=b,this._setButtonOptions(a),this.audioManagerView=a.audioManagerView,this.soundId=a.soundId,this.tabIndex=a.tabIndex,this.model=this.audioManagerView.model,this.manager=this.model.getManager(),this.idPrefix=this.model.getIdPrefix(),this.filePath=this.model.getFilePath()},_setButtonOptions:function(a){var b=MathInteractives.Common.Components.Views.AudioManager.AudioButton;a.type!==b.TYPE.CUSTOM?(this.playBtnOption=b.DEFAULT_BUTTON_OPTIONS.PLAY_BUTTON_OPTIONS,this.pauseBtnOption=b.DEFAULT_BUTTON_OPTIONS.PAUSE_BUTTON_OPTIONS,this.resumeBtnOption=b.DEFAULT_BUTTON_OPTIONS.RESUME_BUTTON_OPTIONS):(this.playBtnOption=a.playBtnOption,this.pauseBtnOption=a.pauseBtnOption,this.resumeBtnOption=a.resumeBtnOption)},_createHackScreenForAudioBtn:function(a){this.audioBtnHack_Prop={elementId:a,tabIndex:this.tabIndex,acc:this.getAccMessage("audio-button","play")},this.createAccDiv(this.audioBtnHack_Prop)},_generateButtons:function(){var a=this.audioManagerView.model.get("player");MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE;this.$el.addClass("sound-btn-holder"),this.playBtnOption.id=this.containerId+"-play-btn",this.pauseBtnOption.id=this.containerId+"-pause-btn",this.resumeBtnOption.id=this.containerId+"-resume-btn",this.playBtnOption.player=a,this.pauseBtnOption.player=a,this.resumeBtnOption.player=a,this.playBtnOption.path=this.filePath,this.pauseBtnOption.path=this.filePath,this.resumeBtnOption.path=this.filePath,this.playBtnOption.baseClass=this.playBtnOption.baseClass||"",this.pauseBtnOption.baseClass=this.pauseBtnOption.baseClass||"",this.resumeBtnOption.baseClass=this.resumeBtnOption.baseClass||"",$("<div/>",{id:this.playBtnOption.id,"class":"sound-mgr-audio-btns "+this.playBtnOption.baseClass}).appendTo(this.$el),$("<div/>",{id:this.pauseBtnOption.id,"class":"sound-mgr-audio-btns "+this.pauseBtnOption.baseClass}).appendTo(this.$el),$("<div/>",{id:this.resumeBtnOption.id,"class":"sound-mgr-audio-btns "+this.resumeBtnOption.baseClass}).appendTo(this.$el),this.playBtnView=MathInteractives.global.Button.generateButton(this.playBtnOption),this.pauseBtnView=MathInteractives.global.Button.generateButton(this.pauseBtnOption),this.resumeBtnView=MathInteractives.global.Button.generateButton(this.resumeBtnOption),this._attachTooltip(),this.showButton(MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.PLAY)},_attachTooltip:function(){this.loadScreen("tts-button-component");var a=this.$el,b=this;this.tooltip=new MathInteractives.Common.Components.Models.Tooltip({id:b.$el.prop("id")+"-tooltip",text:b.getMessage("tts-tooltip-play",0),elementOffsetPosition:a.offset(),elementDimensions:{width:a.width(),height:a.height()},path:b.model.get("filePath"),player:b.model.get("player")}),this.tooltipView=new MathInteractives.Common.Components.Views.Tooltip({model:this.tooltip})},disable:function(a){a===!0?(this.$el.addClass(MathInteractives.Common.Components.Views.AudioManager.AudioButton.DISABLED),this.currentDisplayedBtn.setButtonState(MathInteractives.global.Button.BUTTON_STATE_DISABLED)):(this.$el.removeClass(MathInteractives.Common.Components.Views.AudioManager.AudioButton.DISABLED),this.currentDisplayedBtn.setButtonState(MathInteractives.global.Button.BUTTON_STATE_ACTIVE))},showButton:function(a){switch(this.$(".sound-mgr-audio-btns").hide(),a){case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.PLAY:this.playBtnView.$el.show(),this.currentDisplayedBtn=this.playBtnView;break;case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.PAUSE:this.pauseBtnView.$el.show(),this.currentDisplayedBtn=this.pauseBtnView;break;case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.RESUME:this.resumeBtnView.$el.show(),this.currentDisplayedBtn=this.resumeBtnView}this.$el.css({width:this.currentDisplayedBtn.$el.width(),height:this.currentDisplayedBtn.$el.height()}),this.$el.data("visible-btn-state",a),this.setAccMessage(a)},setAccMessage:function(a){switch(a){case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.PLAY:this.setAccMessage(this.el.id,this.getAccMessage("audio-button","play"));break;case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.PAUSE:this.setAccMessage(this.el.id,this.getAccMessage("audio-button","pause"));break;case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.RESUME:this.setAccMessage(this.el.id,this.getAccMessage("audio-button","resume"))}},_getToolTipMessage:function(a){switch(a){case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.PLAY:return this.getAccMessage("audio-button","play");case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.PAUSE:return this.getAccMessage("audio-button","pause");case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.RESUME:return this.getAccMessage("audio-button","play")}},_clickListener:function(){var a=this.$el;if(a.hasClass(MathInteractives.Common.Components.Views.AudioManager.AudioButton.DISABLED)===!1)switch(a.data("visible-btn-state")){case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.PLAY:this._play();break;case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.PAUSE:this._pause();break;case MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE.RESUME:this._resume()}},_pause:function(){var a=MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_STATE;this.audioManagerView.$audio[0].pause(),this.showButton(a.RESUME),this.tooltipView.changeTooltipText(this._getToolTipMessage(a.RESUME)),this.trigger(MathInteractives.Common.Components.Views.AudioManager.AudioButton.AUDIO_EVENT.PAUSE)},_resume:function(){var a=MathInteractives.Common.Components.Views.AudioManager.AudioButton;MathInteractives.global.SpeechStream.stopReading(),this.showButton(a.AUDIO_STATE.PAUSE),this.tooltipView.changeTooltipText(this._getToolTipMessage(a.AUDIO_STATE.PAUSE)),this.audioManagerView.resume(),this.trigger(a.AUDIO_EVENT.RESUME)},_play:function(){MathInteractives.global.SpeechStream.stopReading(),MathInteractives.Common.Components.Views.AudioManager.stopAllSounds();var a=MathInteractives.Common.Components.Views.AudioManager.AudioButton;self.showButton(a.AUDIO_STATE.PAUSE),self.tooltipView.changeTooltipText(self._getToolTipMessage(a.AUDIO_STATE.PAUSE)),this.audioManagerView.play(this.soundId),self.trigger(a.AUDIO_EVENT.PLAY)},stop:function(){var a=MathInteractives.Common.Components.Views.AudioManager.AudioButton;this.audioManagerView.pause(),this.showButton(a.AUDIO_STATE.PLAY),this.model.setCurrentPlayingAudio(null),this.removeAudioViewFromArray(),this.trigger(a.AUDIO_EVENT.STOP)},complete:function(){var a=MathInteractives.Common.Components.Views.AudioManager.AudioButton;this.audioManagerView.pause(),this.showButton(a.AUDIO_STATE.PLAY),this.tooltipView.changeTooltipText(this._getToolTipMessage(a.AUDIO_STATE.PLAY)),this.model.setCurrentPlayingAudio(null),this.removeAudioViewFromArray(),this.trigger(a.AUDIO_EVENT.COMPLETE)},removeAudioViewFromArray:function(){for(var a=0,b=MathInteractives.Common.Components.Views.AudioManager.CURRENT_PLAYED_AUDIO_VIEWS,c=b.length;c>a;a++)if(b[a].idPrefix===this.idPrefix){b.splice(a,1);break}}},{DISABLED:"disabled",AUDIO_STATE:{PLAY:"play",PAUSE:"pause",RESUME:"resume"},AUDIO_EVENT:{PLAY:"audio-manager-play",PAUSE:"audio-manager-pause",RESUME:"audio-manager-resume",STOP:"audio-manager-stop",COMPLETE:"audio-manager-complete"},DEFAULT_BUTTON_OPTIONS:{PLAY_BUTTON_OPTIONS:{containerId:null,type:MathInteractives.Common.Components.Views.Button?MathInteractives.Common.Components.Views.Button.TYPE.CUSTOM:MathInteractives.Common.Components.Theme2.Views.Button,imagePathIds:["sound-mgr-button"],baseClass:"sound-mgr-play-btn",width:29,height:32,path:null},PAUSE_BUTTON_OPTIONS:{containerId:null,type:MathInteractives.Common.Components.Views.Button?MathInteractives.Common.Components.Views.Button.TYPE.CUSTOM:MathInteractives.Common.Components.Theme2.Views.Button,imagePathIds:["sound-mgr-button"],baseClass:"sound-mgr-pause-btn",width:29,height:32,path:null},RESUME_BUTTON_OPTIONS:{containerId:null,type:MathInteractives.Common.Components.Views.Button?MathInteractives.Common.Components.Views.Button.TYPE.CUSTOM:MathInteractives.Common.Components.Theme2.Views.Button,imagePathIds:["sound-mgr-button"],baseClass:"sound-mgr-resume-btn",width:29,height:32,path:null}},TYPE:{DEFAULT:"default",CUSTOM:"custom"}}),CURRENT_PLAYED_AUDIO_VIEWS:[],AUDIO_EVENT:{LOAD_START:"audio-manager-load-start",LOAD_COMPLETE:"audio-manager-load-complete",PLAY:"audio-manager-play",PAUSE:"audio-manager-pause",RESUME:"audio-manager-resume",STOP:"audio-manager-stop",COMPLETE:"audio-manager-complete"},generateAudioButton:function(a){return new this.AudioButton(a)},stopAllSounds:function(){for(var a=MathInteractives.Common.Components.Views.AudioManager.CURRENT_PLAYED_AUDIO_VIEWS,b=a.length,c={},d=0;b>d;d++)c=a[d],c.stop();a=[]},initAudioManager:function(a){var b=new MathInteractives.Common.Components.Models.AudioManager(a),c=new MathInteractives.Common.Components.Views.AudioManager({model:b});return c}}),MathInteractives.global.AudioManager=MathInteractives.Common.Components.Views.AudioManager}();